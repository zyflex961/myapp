"use strict";(self.webpackChunkmytonwallet=self.webpackChunkmytonwallet||[]).push([[35,316],{35:(e,n,t)=>{t.d(n,{L:()=>g,d:()=>l,getLedgerDeviceInfo:()=>f});var r=t(13983),o=t(23174),i=t(31481),a=t(5370),s=t(48287).Buffer;const c=i.gmk?"hex":"base64",u=new Set(["DisconnectedDeviceDuringOperation","TransportRaceCondition"]);class d extends r.Ay{async exchange(e){const n=await(0,a.p)("exchangeWithLedger",e.toString(c));return s.from(n,c)}getDeviceModel(){return(0,a.p)("getLedgerDeviceModel")}}const l=new d;async function f(){const e=await l.getDeviceModel();return{driver:"HID",deviceId:null==e?void 0:e.id,deviceName:null==e?void 0:e.productName}}function g(e){if(function(e){return e instanceof Error&&u.has(e.name)}(e))return{error:o.jc.ConnectionBroken};throw e}},64316:(e,n,t)=>{t.r(n),t.d(n,{getLedgerTonWallet:()=>L,isLedgerTonAppOpen:()=>E,signTonProofWithLedger:()=>I,signTonTransactionsWithLedger:()=>M,verifyLedgerTonAddress:()=>j});var r=t(24450),o=t(35),i=t(3476),a=t(55029);const s="2.1",c="2.1",u={6:"2.2",9:"2.6.1",10:"2.8.0"},d={unsafe:"2.1",comment:"0","jetton-transfer":"0","nft-transfer":"2.1","jetton-burn":"2.1","add-whitelist":"2.1","single-nominator-withdraw":"2.1","single-nominator-change-validator":"2.1","tonstakers-deposit":"2.1","vote-for-proposal":"2.1","change-dns-record":"2.1","token-bridge-pay-swap":"2.1","tonwhales-pool-deposit":"2.7","tonwhales-pool-withdraw":"2.7","vesting-send-msg-comment":"2.7"},l=new Set(["nanoS","nanoSP"]),f=new Set(["nanoS"]);function g(e,n){return function(e,n){const t=e.split(".").map(Number),r=n.split(".").map(Number);for(let e=0;e<Math.max(t.length,r.length);e++){const n=t[e]||0,o=r[e]||0;if(n>o)return 1;if(n<o)return-1}return 0}(e,n)>=0}var p=t(34557),w=t(23174);const h=new p.vs(o.d);function y(e,n,t){return m(n.index,"mainnet"!==e,t)}function m(e,n){return[44,607,n?1:0,v(arguments.length>2&&void 0!==arguments[2]?arguments[2]:i.Zm),e,0]}function v(e){return e===i.li.MasterChain?255:0}function b(e){return i.iQ[e]}function T(e){if(e instanceof r.TransportStatusError)switch(e.statusCode){case 27013:return{error:w.jc.RejectedByUser};case 48384:return{error:w.jc.BlindSigningNotEnabled};case 45067:return{error:w.jc.ProofTooLarge}}return(0,o.L)(e)}async function S(e,n){const{publicKey:t}=await h.getAddress(...D(e,n.index,n.version));return t.toString("hex")===n.publicKey}function D(e,n,t){const r="mainnet"!==e,o=i.Zm;return[m(n,r,o),{testOnly:r,chain:v(o),bounceable:i.eL,walletVersion:b(t)}]}async function E(){try{if(!await h.isAppOpen())return!1;const e=await o.d.getDeviceModel();return e&&!l.has(e.id)||await h.getAddress(m(0,!1),{walletVersion:b(i.f1)}),!0}catch(e){return(!(e instanceof r.TransportStatusError)||e.statusCode!==r.StatusCodes.LOCKED_DEVICE&&21260!==e.statusCode)&&T(e)}}async function L(e,n){try{const t=i.f1,{address:r,publicKey:o}=await h.getAddress(...D(e,n,t));return{index:n,address:r,publicKey:o.toString("hex"),version:t}}catch(e){return T(e)}}async function j(e,n){try{const{address:t}=await h.validateAddress(...D(e,n.index,n.version));return t}catch(e){return T(e)}}var O=t(88823);const k=Object.fromEntries(p._t.map((e,n)=>{let{masterAddress:t}=e;return[(0,O.vn)(t,!0,"mainnet"),n]})),x=new Error("Unsupported"),A=new Error("Lacks blind signing");async function M(e,n,t,r){let c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:i.PY;const l=y(e,n);let m;try{if(!await S(e,n))return{error:w.jc.WrongDevice};const c=await o.d.getDeviceModel(),l=await h.getVersion(),y=await async function(e){if(!g(e,s))return!0;const{blindSigningEnabled:n}=await h.getSettings();return n}(l);m=await Promise.all(t.map(t=>async function(e,n,t,r,o,s,c){const{authType:l="external",sendMode:w=0,seqno:h,timeout:y,hints:m}=t,v=function(e){let{messages:n}=e;if(0===n.length)throw new Error("No messages");if(n.length>1)throw new Error("Ledger doesn't support signing more than 1 message");return n[0]}(t);if("external"!==l)throw new Error(`Unsupported transaction authType "${l}"`);if("internal"!==v.info.type)throw new Error(`Unsupported message type "${v.info.type}"`);const b=await async function(e,n,t,r,o,s){let{tokenAddress:c}=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{};const l=function(e,n){if(!e)return;let t;try{t=(0,p.vY)(e,{disallowUnsafe:!0})}catch(n){(0,a.MD)("Unsafe Ledger payload",n),t={type:"unsafe",message:e}}if(t&&!g(n,d[t.type])){if((0,a.MD)(`The ${t.type} payload type is not supported by Ledger TON v${n}`),!g(n,d.unsafe))throw x;(0,a.MD)("Falling back to an unsafe payload"),t={type:"unsafe",message:e}}return t}(t,o);if("jetton-transfer"===(null==l?void 0:l.type)&&function(e,n){return e&&!f.has(e)&&g(n,Object.values(u)[0])}(r,o)){if(!c){const t=(0,O.vn)(n,!0,e);c=await(0,O.uA)(e,t)}c&&(l.knownJetton=function(e,n){const t=k[n];return void 0!==t&&function(e,n){for(const[t,r]of Object.entries(u))if(n<=Number(t))return g(e,r);return(0,a.SJ)(`The minimum TON App version for jetton id ${n} is not set in VERSION_WITH_JETTON_ID`),!1}(e,t)?{jettonId:t,workchain:i.Zm}:null}(o,c))}if("unsafe"===(null==l?void 0:l.type)&&!s)throw A;return l}(e,v.info.dest,v.body,r,o,s,m);return{to:v.info.dest,sendMode:w,seqno:h,timeout:y??Math.floor(Date.now()/1e3+i.kF),bounce:v.info.bounce,amount:v.info.value.coins,stateInit:v.init??void 0,payload:b,walletSpecifiers:N(n,o,c)}}(e,n.version,t,null==c?void 0:c.id,l,y,r)))}catch(e){return e===x?{error:w.jc.HardwareOutdated}:e===A?{error:w.jc.BlindSigningNotEnabled}:T(e)}return async function(e,n,t){const r=[];let o=0,i=0;for(;i<n.length;)try{r.push(await h.signTransaction(e,n[i])),i++}catch(e){try{return T(e)}catch{if(o>=t)throw e;o++}(0,a.SJ)("signLedgerTransactionsWithRetry",e)}return r}(l,m,c)}function N(e,n,t){if("v3R2"===e){if(!g(n,c))throw x;return{includeWalletOp:!1}}if(void 0!==t){if(!g(n,c))throw x;return{subwalletId:t,includeWalletOp:!1}}}var C=t(48287).Buffer;async function I(e,n,t){const r=y(e,n),{timestamp:o,domain:i,payload:a}=t;try{return await S(e,n)?(await h.getAddressProof(r,{domain:i,timestamp:o,payload:C.from(a)})).signature:{error:w.jc.WrongDevice}}catch(e){return T(e)}}}}]);
//# sourceMappingURL=316.e7fb80cc2ba617d81496.js.map