{"version":3,"file":"949.16fb6c433947772cf2a3.js","mappings":"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","sources":["webpack://mytonwallet/./src/util/cycleRestrict.ts","webpack://mytonwallet/./src/lib/rlottie/RLottie.ts"],"sourcesContent":["export default function cycleRestrict(length: number, index: number) {\r\n  return index - Math.floor(index / length) * length;\r\n}\r\n","import { animate } from '../../util/animation';\r\nimport cycleRestrict from '../../util/cycleRestrict';\r\nimport Deferred from '../../util/Deferred';\r\nimport generateUniqueId from '../../util/generateUniqueId';\r\nimport launchMediaWorkers, { MAX_WORKERS } from '../../util/launchMediaWorkers';\r\nimport { IS_ANDROID, IS_IOS, IS_SAFARI } from '../../util/windowEnvironment';\r\nimport { requestMeasure, requestMutation } from '../fasterdom/fasterdom';\r\n\r\ninterface Params {\r\n  size: number;\r\n  shouldStretch?: boolean;\r\n  noLoop?: boolean;\r\n  quality?: number;\r\n  isLowPriority?: boolean;\r\n  coords?: { x: number; y: number };\r\n}\r\n\r\nconst WAITING = Symbol('WAITING');\r\ntype Frame =\r\n  undefined\r\n  | typeof WAITING\r\n  | ImageBitmap;\r\n\r\nconst HIGH_PRIORITY_QUALITY = (IS_ANDROID || IS_IOS) ? 0.75 : 1;\r\nconst LOW_PRIORITY_QUALITY = IS_ANDROID ? 0.5 : 0.75;\r\nconst LOW_PRIORITY_QUALITY_SIZE_THRESHOLD = 24;\r\nconst HIGH_PRIORITY_CACHE_MODULO = IS_SAFARI ? 2 : 4;\r\nconst LOW_PRIORITY_CACHE_MODULO = 0;\r\n\r\nconst workers = launchMediaWorkers().map(({ connector }) => connector);\r\nconst instancesByRenderId = new Map<string, RLottie>();\r\n\r\nconst PENDING_CANVAS_RESIZES = new WeakMap<HTMLCanvasElement, Promise<void>>();\r\n\r\nlet lastWorkerIndex = -1;\r\n\r\nclass RLottie {\r\n  // Config\r\n\r\n  private views = new Map<string, {\r\n    canvas: HTMLCanvasElement;\r\n    ctx: CanvasRenderingContext2D;\r\n    isLoaded?: boolean;\r\n    isPaused?: boolean;\r\n    isSharedCanvas?: boolean;\r\n    coords?: Params['coords'];\r\n    onLoad?: NoneToVoidFunction;\r\n  }>();\r\n\r\n  private imgSize!: number;\r\n\r\n  private imageData!: ImageData;\r\n\r\n  private msPerFrame = 1000 / 60;\r\n\r\n  private reduceFactor = 1;\r\n\r\n  private cacheModulo!: number;\r\n\r\n  private workerIndex!: number;\r\n\r\n  private frames: Frame[] = [];\r\n\r\n  private framesCount?: number;\r\n\r\n  // State\r\n\r\n  private isAnimating = false;\r\n\r\n  private isWaiting = true;\r\n\r\n  private isEnded = false;\r\n\r\n  private isDestroyed = false;\r\n\r\n  private isRendererInited = false;\r\n\r\n  private approxFrameIndex = 0;\r\n\r\n  private prevFrameIndex = -1;\r\n\r\n  private stopFrameIndex? = 0;\r\n\r\n  private speed = 1;\r\n\r\n  private direction: 1 | -1 = 1;\r\n\r\n  private lastRenderAt?: number;\r\n\r\n  static init(...args: ConstructorParameters<typeof RLottie>) {\r\n    const [\r\n      , canvas,\r\n      renderId,\r\n      params,\r\n      viewId = generateUniqueId(), ,\r\n      onLoad,\r\n    ] = args;\r\n    let instance = instancesByRenderId.get(renderId);\r\n\r\n    if (!instance) {\r\n      instance = new RLottie(...args);\r\n      instancesByRenderId.set(renderId, instance);\r\n    } else {\r\n      instance.addView(viewId, canvas, onLoad, params?.coords);\r\n    }\r\n\r\n    return instance;\r\n  }\r\n\r\n  constructor(\r\n    private tgsUrl: string,\r\n    private container: HTMLDivElement | HTMLCanvasElement,\r\n    private renderId: string,\r\n    private params: Params,\r\n    viewId: string = generateUniqueId(),\r\n    private customColor?: [number, number, number],\r\n    private onLoad?: NoneToVoidFunction | undefined,\r\n    private onEnded?: (isDestroyed?: boolean) => void,\r\n    private onLoop?: () => void,\r\n  ) {\r\n    this.addView(viewId, container, onLoad, params.coords);\r\n    this.initConfig();\r\n    this.initRenderer();\r\n  }\r\n\r\n  public removeView(viewId: string) {\r\n    const {\r\n      canvas, ctx, isSharedCanvas, coords,\r\n    } = this.views.get(viewId)!;\r\n\r\n    if (isSharedCanvas) {\r\n      ctx.clearRect(coords!.x, coords!.y, this.imgSize, this.imgSize);\r\n    } else {\r\n      canvas.remove();\r\n    }\r\n\r\n    this.views.delete(viewId);\r\n\r\n    if (!this.views.size) {\r\n      this.destroy();\r\n    }\r\n  }\r\n\r\n  isPlaying() {\r\n    return this.isAnimating || this.isWaiting;\r\n  }\r\n\r\n  play(forceRestart = false, viewId?: string) {\r\n    if (viewId) {\r\n      this.views.get(viewId)!.isPaused = false;\r\n    }\r\n\r\n    if (this.isEnded && forceRestart) {\r\n      this.approxFrameIndex = Math.floor(0);\r\n    }\r\n\r\n    this.stopFrameIndex = undefined;\r\n    this.direction = 1;\r\n    this.doPlay();\r\n  }\r\n\r\n  pause(viewId?: string) {\r\n    this.lastRenderAt = undefined;\r\n\r\n    if (viewId) {\r\n      this.views.get(viewId)!.isPaused = true;\r\n\r\n      const areAllContainersPaused = Array.from(this.views.values()).every(({ isPaused }) => isPaused);\r\n      if (!areAllContainersPaused) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (this.isWaiting) {\r\n      this.stopFrameIndex = this.approxFrameIndex;\r\n    } else {\r\n      this.isAnimating = false;\r\n    }\r\n\r\n    if (!this.params.isLowPriority) {\r\n      this.frames = this.frames.map((frame, i) => {\r\n        if (i === this.prevFrameIndex) {\r\n          return frame;\r\n        } else {\r\n          if (frame && frame !== WAITING) {\r\n            frame.close();\r\n          }\r\n\r\n          return undefined;\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  playSegment([startFrameIndex, stopFrameIndex]: [number, number], forceRestart = false, viewId?: string) {\r\n    if (viewId) {\r\n      this.views.get(viewId)!.isPaused = false;\r\n    }\r\n\r\n    const frameIndex = Math.round(this.approxFrameIndex);\r\n    this.stopFrameIndex = Math.floor(stopFrameIndex / this.reduceFactor);\r\n    if (frameIndex !== stopFrameIndex || forceRestart) {\r\n      this.approxFrameIndex = Math.floor(startFrameIndex / this.reduceFactor);\r\n    }\r\n    this.direction = startFrameIndex < stopFrameIndex ? 1 : -1;\r\n\r\n    this.doPlay();\r\n  }\r\n\r\n  setSpeed(speed: number) {\r\n    this.speed = speed;\r\n  }\r\n\r\n  setNoLoop(noLoop?: boolean) {\r\n    this.params.noLoop = noLoop;\r\n  }\r\n\r\n  async setSharedCanvasCoords(viewId: string, newCoords: Params['coords']) {\r\n    const containerInfo = this.views.get(viewId)!;\r\n    const {\r\n      canvas, ctx,\r\n    } = containerInfo;\r\n\r\n    const isCanvasDirty = !canvas.dataset.isJustCleaned || canvas.dataset.isJustCleaned === 'false';\r\n\r\n    if (!isCanvasDirty) {\r\n      await PENDING_CANVAS_RESIZES.get(canvas);\r\n    }\r\n\r\n    let [canvasWidth, canvasHeight] = [canvas.width, canvas.height];\r\n\r\n    if (isCanvasDirty) {\r\n      const sizeFactor = this.calcSizeFactor();\r\n      ([canvasWidth, canvasHeight] = ensureCanvasSize(canvas, sizeFactor));\r\n      ctx.clearRect(0, 0, canvasWidth, canvasHeight);\r\n      canvas.dataset.isJustCleaned = 'true';\r\n      requestMeasure(() => {\r\n        canvas.dataset.isJustCleaned = 'false';\r\n      });\r\n    }\r\n\r\n    containerInfo.coords = {\r\n      x: Math.round((newCoords?.x || 0) * canvasWidth),\r\n      y: Math.round((newCoords?.y || 0) * canvasHeight),\r\n    };\r\n\r\n    const frame = this.getFrame(this.prevFrameIndex) || this.getFrame(Math.round(this.approxFrameIndex));\r\n\r\n    if (frame && frame !== WAITING) {\r\n      ctx.drawImage(frame, containerInfo.coords.x, containerInfo.coords.y);\r\n    }\r\n  }\r\n\r\n  private addView(\r\n    viewId: string,\r\n    container: HTMLDivElement | HTMLCanvasElement,\r\n    onLoad?: NoneToVoidFunction,\r\n    coords?: Params['coords'],\r\n  ) {\r\n    const sizeFactor = this.calcSizeFactor();\r\n\r\n    let imgSize: number;\r\n\r\n    if (container instanceof HTMLDivElement) {\r\n      if (!(container.parentNode instanceof HTMLElement)) {\r\n        throw new Error('[RLottie] Container is not mounted');\r\n      }\r\n\r\n      const { size, shouldStretch } = this.params;\r\n\r\n      imgSize = Math.round(size * sizeFactor);\r\n\r\n      if (!this.imgSize) {\r\n        this.imgSize = imgSize;\r\n        this.imageData = new ImageData(imgSize, imgSize);\r\n      }\r\n\r\n      requestMutation(() => {\r\n        const canvas = document.createElement('canvas');\r\n        const ctx = canvas.getContext('2d')!;\r\n\r\n        if (shouldStretch) {\r\n          canvas.style.width = '100%';\r\n        } else {\r\n          canvas.style.width = `${size}px`;\r\n          canvas.style.height = `${size}px`;\r\n        }\r\n\r\n        canvas.style.display = 'block';\r\n\r\n        canvas.width = imgSize;\r\n        canvas.height = imgSize;\r\n\r\n        container.appendChild(canvas);\r\n\r\n        this.views.set(viewId, {\r\n          canvas, ctx, onLoad,\r\n        });\r\n      });\r\n    } else {\r\n      if (!container.isConnected) {\r\n        throw new Error('[RLottie] Shared canvas is not mounted');\r\n      }\r\n\r\n      const canvas = container;\r\n      const ctx = canvas.getContext('2d')!;\r\n\r\n      imgSize = Math.round(this.params.size * sizeFactor);\r\n\r\n      if (!this.imgSize) {\r\n        this.imgSize = imgSize;\r\n        this.imageData = new ImageData(imgSize, imgSize);\r\n      }\r\n\r\n      const [canvasWidth, canvasHeight] = ensureCanvasSize(canvas, sizeFactor);\r\n\r\n      this.views.set(viewId, {\r\n        canvas,\r\n        ctx,\r\n        isSharedCanvas: true,\r\n        coords: {\r\n          x: Math.round(coords!.x * canvasWidth),\r\n          y: Math.round(coords!.y * canvasHeight),\r\n        },\r\n        onLoad,\r\n      });\r\n    }\r\n\r\n    if (this.isRendererInited) {\r\n      this.doPlay();\r\n    }\r\n  }\r\n\r\n  private calcSizeFactor() {\r\n    const {\r\n      size,\r\n      isLowPriority,\r\n      // Reduced quality only looks acceptable on big enough images\r\n      quality = isLowPriority && (!size || size > LOW_PRIORITY_QUALITY_SIZE_THRESHOLD)\r\n        ? LOW_PRIORITY_QUALITY : HIGH_PRIORITY_QUALITY,\r\n    } = this.params;\r\n\r\n    // Reduced quality only looks acceptable on high DPR screens\r\n    return Math.max(window.devicePixelRatio * quality, 1);\r\n  }\r\n\r\n  private destroy() {\r\n    this.isDestroyed = true;\r\n    this.pause();\r\n    this.clearCache();\r\n    this.destroyRenderer();\r\n\r\n    instancesByRenderId.delete(this.renderId);\r\n  }\r\n\r\n  private clearCache() {\r\n    this.frames.forEach((frame) => {\r\n      if (frame && frame !== WAITING) {\r\n        frame.close();\r\n      }\r\n    });\r\n\r\n    // Help GC\r\n    this.imageData = undefined as any;\r\n    this.frames = [];\r\n  }\r\n\r\n  private initConfig() {\r\n    const { isLowPriority } = this.params;\r\n\r\n    this.cacheModulo = isLowPriority ? LOW_PRIORITY_CACHE_MODULO : HIGH_PRIORITY_CACHE_MODULO;\r\n  }\r\n\r\n  setColor(newColor: [number, number, number] | undefined) {\r\n    this.customColor = newColor;\r\n  }\r\n\r\n  private initRenderer() {\r\n    this.workerIndex = cycleRestrict(MAX_WORKERS, ++lastWorkerIndex);\r\n\r\n    void workers[this.workerIndex].request({\r\n      name: 'rlottie:init',\r\n      args: [\r\n        this.renderId,\r\n        this.tgsUrl,\r\n        this.imgSize,\r\n        this.params.isLowPriority || false,\r\n        this.customColor,\r\n        this.onRendererInit.bind(this),\r\n      ],\r\n    });\r\n  }\r\n\r\n  private destroyRenderer() {\r\n    void workers[this.workerIndex].request({\r\n      name: 'rlottie:destroy',\r\n      args: [this.renderId],\r\n    });\r\n  }\r\n\r\n  private onRendererInit(reduceFactor: number, msPerFrame: number, framesCount: number) {\r\n    this.isRendererInited = true;\r\n    this.reduceFactor = reduceFactor;\r\n    this.msPerFrame = msPerFrame;\r\n    this.framesCount = framesCount;\r\n\r\n    if (this.isWaiting) {\r\n      this.doPlay();\r\n    }\r\n  }\r\n\r\n  changeData(tgsUrl: string) {\r\n    this.pause();\r\n    this.tgsUrl = tgsUrl;\r\n    this.initConfig();\r\n\r\n    void workers[this.workerIndex].request({\r\n      name: 'rlottie:changeData',\r\n      args: [\r\n        this.renderId,\r\n        this.tgsUrl,\r\n        this.params.isLowPriority || false,\r\n        this.onChangeData.bind(this),\r\n      ],\r\n    });\r\n  }\r\n\r\n  private onChangeData(reduceFactor: number, msPerFrame: number, framesCount: number) {\r\n    this.reduceFactor = reduceFactor;\r\n    this.msPerFrame = msPerFrame;\r\n    this.framesCount = framesCount;\r\n    this.isWaiting = false;\r\n    this.isAnimating = false;\r\n\r\n    this.doPlay();\r\n  }\r\n\r\n  private doPlay() {\r\n    if (!this.framesCount) {\r\n      return;\r\n    }\r\n\r\n    if (this.isDestroyed) {\r\n      return;\r\n    }\r\n\r\n    if (this.isAnimating) {\r\n      return;\r\n    }\r\n\r\n    if (!this.isWaiting) {\r\n      this.lastRenderAt = undefined;\r\n    }\r\n\r\n    this.isEnded = false;\r\n    this.isAnimating = true;\r\n    this.isWaiting = false;\r\n\r\n    animate(() => {\r\n      if (this.isDestroyed) {\r\n        return false;\r\n      }\r\n\r\n      // Paused from outside\r\n      if (!this.isAnimating) {\r\n        const areAllLoaded = Array.from(this.views.values()).every(({ isLoaded }) => isLoaded);\r\n        if (areAllLoaded) {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      const frameIndex = Math.round(this.approxFrameIndex);\r\n      const frame = this.getFrame(frameIndex);\r\n      if (!frame || frame === WAITING) {\r\n        if (!frame) {\r\n          this.requestFrame(frameIndex);\r\n        }\r\n\r\n        this.isAnimating = false;\r\n        this.isWaiting = true;\r\n        return false;\r\n      }\r\n\r\n      if (this.cacheModulo && frameIndex % this.cacheModulo === 0) {\r\n        this.cleanupPrevFrame(frameIndex);\r\n      }\r\n\r\n      if (frameIndex !== this.prevFrameIndex) {\r\n        this.views.forEach((containerData) => {\r\n          const {\r\n            ctx, isLoaded, isPaused, coords: { x, y } = {}, onLoad,\r\n          } = containerData;\r\n\r\n          if (!isLoaded || !isPaused) {\r\n            ctx.clearRect(x || 0, y || 0, this.imgSize, this.imgSize);\r\n            ctx.drawImage(frame, x || 0, y || 0);\r\n          }\r\n\r\n          if (!isLoaded) {\r\n            containerData.isLoaded = true;\r\n            onLoad?.();\r\n          }\r\n        });\r\n\r\n        this.prevFrameIndex = frameIndex;\r\n      }\r\n\r\n      const now = Date.now();\r\n      const currentSpeed = this.lastRenderAt ? this.msPerFrame / (now - this.lastRenderAt) : 1;\r\n      const delta = (this.direction * this.speed) / currentSpeed;\r\n      const expectedNextFrameIndex = Math.round(this.approxFrameIndex + delta);\r\n\r\n      this.lastRenderAt = now;\r\n\r\n      // Forward animation finished\r\n      if (delta > 0 && (frameIndex === this.framesCount! - 1 || expectedNextFrameIndex > this.framesCount! - 1)) {\r\n        if (this.params.noLoop) {\r\n          this.isAnimating = false;\r\n          this.isEnded = true;\r\n          this.onEnded?.();\r\n          return false;\r\n        }\r\n        this.onLoop?.();\r\n\r\n        this.approxFrameIndex = 0;\r\n\r\n        // Backward animation finished\r\n      } else if (delta < 0 && (frameIndex === 0 || expectedNextFrameIndex < 0)) {\r\n        if (this.params.noLoop) {\r\n          this.isAnimating = false;\r\n          this.isEnded = true;\r\n          this.onEnded?.();\r\n          return false;\r\n        }\r\n        this.onLoop?.();\r\n\r\n        this.approxFrameIndex = this.framesCount! - 1;\r\n\r\n        // Stop frame reached\r\n      } else if (\r\n        this.stopFrameIndex !== undefined\r\n        && (frameIndex === this.stopFrameIndex\r\n          || (\r\n            (delta > 0 && expectedNextFrameIndex > this.stopFrameIndex)\r\n            || (delta < 0 && expectedNextFrameIndex < this.stopFrameIndex)\r\n          ))\r\n      ) {\r\n        this.stopFrameIndex = undefined;\r\n        this.isAnimating = false;\r\n        return false;\r\n\r\n        // Preparing next frame\r\n      } else {\r\n        this.approxFrameIndex += delta;\r\n      }\r\n\r\n      const nextFrameIndex = Math.round(this.approxFrameIndex);\r\n\r\n      if (!this.getFrame(nextFrameIndex)) {\r\n        this.requestFrame(nextFrameIndex);\r\n        this.isWaiting = true;\r\n        this.isAnimating = false;\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    }, requestMutation);\r\n  }\r\n\r\n  private getFrame(frameIndex: number) {\r\n    return this.frames[frameIndex];\r\n  }\r\n\r\n  private requestFrame(frameIndex: number) {\r\n    this.frames[frameIndex] = WAITING;\r\n\r\n    void workers[this.workerIndex].request({\r\n      name: 'rlottie:renderFrames',\r\n      args: [this.renderId, frameIndex, this.onFrameLoad.bind(this)],\r\n    });\r\n  }\r\n\r\n  private cleanupPrevFrame(frameIndex: number) {\r\n    if (this.framesCount! < 3) {\r\n      return;\r\n    }\r\n\r\n    const prevFrameIndex = cycleRestrict(this.framesCount!, frameIndex - 1);\r\n    this.frames[prevFrameIndex] = undefined;\r\n  }\r\n\r\n  private onFrameLoad(frameIndex: number, imageBitmap: ImageBitmap) {\r\n    if (this.frames[frameIndex] !== WAITING) {\r\n      return;\r\n    }\r\n\r\n    this.frames[frameIndex] = imageBitmap;\r\n\r\n    if (this.isWaiting) {\r\n      this.doPlay();\r\n    }\r\n  }\r\n}\r\n\r\nfunction ensureCanvasSize(canvas: HTMLCanvasElement, sizeFactor: number) {\r\n  const expectedWidth = Math.round(canvas.offsetWidth * sizeFactor);\r\n  const expectedHeight = Math.round(canvas.offsetHeight * sizeFactor);\r\n\r\n  if (canvas.width !== expectedWidth || canvas.height !== expectedHeight) {\r\n    const deferred = new Deferred<void>();\r\n    PENDING_CANVAS_RESIZES.set(canvas, deferred.promise);\r\n    requestMutation(() => {\r\n      canvas.width = expectedWidth;\r\n      canvas.height = expectedHeight;\r\n      deferred.resolve();\r\n    });\r\n  }\r\n\r\n  return [expectedWidth, expectedHeight];\r\n}\r\n\r\nexport default RLottie;\r\n"],"names":["cycleRestrict","length","index","Math","floor","WAITING","Symbol","HIGH_PRIORITY_QUALITY","IS_ANDROID","IS_IOS","LOW_PRIORITY_QUALITY","LOW_PRIORITY_QUALITY_SIZE_THRESHOLD","HIGH_PRIORITY_CACHE_MODULO","IS_SAFARI","workers","launchMediaWorkers","map","_ref","connector","instancesByRenderId","Map","PENDING_CANVAS_RESIZES","WeakMap","lastWorkerIndex","RLottie","views","imgSize","imageData","msPerFrame","reduceFactor","cacheModulo","workerIndex","frames","framesCount","isAnimating","isWaiting","isEnded","isDestroyed","isRendererInited","approxFrameIndex","prevFrameIndex","stopFrameIndex","speed","direction","lastRenderAt","init","_len","arguments","args","Array","_key","canvas","renderId","params","viewId","generateUniqueId","onLoad","instance","get","addView","coords","set","constructor","tgsUrl","container","undefined","customColor","onEnded","onLoop","this","initConfig","initRenderer","removeView","ctx","isSharedCanvas","clearRect","x","y","remove","delete","size","destroy","isPlaying","play","forceRestart","isPaused","doPlay","pause","from","values","every","_ref2","isLowPriority","frame","i","close","playSegment","_ref3","startFrameIndex","frameIndex","round","setSpeed","setNoLoop","noLoop","setSharedCanvasCoords","newCoords","containerInfo","isCanvasDirty","dataset","isJustCleaned","canvasWidth","canvasHeight","width","height","sizeFactor","calcSizeFactor","ensureCanvasSize","requestMeasure","getFrame","drawImage","HTMLDivElement","parentNode","HTMLElement","Error","shouldStretch","ImageData","requestMutation","document","createElement","getContext","style","display","appendChild","isConnected","quality","max","window","devicePixelRatio","clearCache","destroyRenderer","forEach","setColor","newColor","MAX_WORKERS","request","name","onRendererInit","bind","changeData","onChangeData","animate","_ref4","isLoaded","requestFrame","cleanupPrevFrame","containerData","now","Date","currentSpeed","delta","expectedNextFrameIndex","_this$onLoop","_this$onEnded","call","_this$onLoop2","_this$onEnded2","nextFrameIndex","onFrameLoad","imageBitmap","expectedWidth","offsetWidth","expectedHeight","offsetHeight","deferred","Deferred","promise","resolve"],"sourceRoot":""}