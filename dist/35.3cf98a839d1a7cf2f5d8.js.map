{"version":3,"file":"35.3cf98a839d1a7cf2f5d8.js","mappings":"0NAkBA,MAAMA,EAAsBC,EAAAA,IAAa,MAAQ,SAE3CC,EAA2B,IAAIC,IAAI,CAEvC,oCAQA,2BAOF,MAAMC,UAAwBC,EAAAA,GAK5B,cAAMC,CAASC,GACb,MAAMC,QAAiBC,EAAAA,EAAAA,GAAW,qBAAsBF,EAAKG,SAASV,IACtE,OAAOW,EAAOC,KAAKJ,EAAUR,EAC/B,CAEAa,cAAAA,GACE,OAAOJ,EAAAA,EAAAA,GAAW,uBACpB,EAIK,MAAMK,EAAkB,IAAIV,EAE5BW,eAAeC,IACpB,MAAMC,QAAoBH,EAAgBD,iBAG1C,MAAO,CACLK,OAH8B,MAI9BC,SAAUF,aAAW,EAAXA,EAAaG,GACvBC,WAAYJ,aAAW,EAAXA,EAAaK,YAE7B,CAOO,SAASC,EAAwBC,GACtC,GANF,SAAkCA,GAChC,OAAOA,aAAiBC,OAASvB,EAAyBwB,IAAIF,EAAMG,KACtE,CAIMC,CAAyBJ,GAC3B,MAAO,CAAEA,MAAOK,EAAAA,GAAiBC,kBAGnC,MAAMN,CACR,C","sources":["webpack://mytonwallet/./src/api/common/ledger.ts"],"sourcesContent":["/*\r\n * This file must be imported dynamically via import().\r\n * This is needed to reduce the app size when Ledger is not used.\r\n */\r\n\r\nimport Transport from '@ledgerhq/hw-transport';\r\n\r\nimport type { ApiLedgerDriver } from '../types';\r\nimport { ApiHardwareError } from '../types';\r\n\r\nimport { IS_AIR_APP } from '../../config';\r\nimport { callWindow } from '../../util/windowProvider/connector';\r\n\r\n/**\r\n * Serialization format differs between web/capacitor and native apps:\r\n *  - Native (AIR) apps: Use hex format (expected by native Ledger library implementations)\r\n *  - Web/Capacitor apps: Use base64 format (more efficient for browser message passing)\r\n */\r\nconst serializationFormat = IS_AIR_APP ? 'hex' : 'base64';\r\n\r\nconst BROKEN_CONNECTION_ERRORS = new Set([\r\n  // This error occurs sometimes if the chains' Ledger app is closed during a data transmission with Ledger\r\n  'DisconnectedDeviceDuringOperation',\r\n  // One way to reproduce this error is:\r\n  // 1. Run the app in Capacitor on iOS,\r\n  // 2. Connect Ledger and open TON App,\r\n  // 3. Start the connection in the UI, e.g. by sending a transaction,\r\n  // 4. As soon as the checklist screen appears, exit TON App immediately,\r\n  // 5. Start the connection in the UI again without entering TON App.\r\n  // It happens only sometimes. The error message suggests reconnecting Ledger.\r\n  'TransportRaceCondition',\r\n]);\r\n\r\n/**\r\n * A Ledger's Transport implementation that passes the data to the actual transfer object in the main browser thread\r\n * (src/util/ledger/index.ts) via postMessage (because actual Ledger transports don't work in worker threads).\r\n */\r\nclass WindowTransport extends Transport {\r\n  /** Use `getDeviceModel()` instead */\r\n  declare deviceModel: never;\r\n\r\n  /** The thrown errors may unexpectedly have the default `Error` class. For reliability, check the `name` instead. */\r\n  async exchange(apdu: Buffer) {\r\n    const response = await callWindow('exchangeWithLedger', apdu.toString(serializationFormat));\r\n    return Buffer.from(response, serializationFormat);\r\n  }\r\n\r\n  getDeviceModel() {\r\n    return callWindow('getLedgerDeviceModel');\r\n  }\r\n}\r\n\r\n/** Connection with Ledger (blockchain-agnostic) */\r\nexport const ledgerTransport = new WindowTransport();\r\n\r\nexport async function getLedgerDeviceInfo() {\r\n  const deviceModel = await ledgerTransport.getDeviceModel();\r\n  const driver: ApiLedgerDriver = 'HID';\r\n\r\n  return {\r\n    driver,\r\n    deviceId: deviceModel?.id,\r\n    deviceName: deviceModel?.productName,\r\n  };\r\n}\r\n\r\nfunction isLedgerConnectionBroken(error: unknown) {\r\n  return error instanceof Error && BROKEN_CONNECTION_ERRORS.has(error.name);\r\n}\r\n\r\n/** Throws unexpected errors (i.e. caused by mistakes in the app code), and returns expected */\r\nexport function handleLedgerCommonError(error: unknown) {\r\n  if (isLedgerConnectionBroken(error)) {\r\n    return { error: ApiHardwareError.ConnectionBroken };\r\n  }\r\n\r\n  throw error;\r\n}\r\n"],"names":["serializationFormat","IS_AIR_APP","BROKEN_CONNECTION_ERRORS","Set","WindowTransport","Transport","exchange","apdu","response","callWindow","toString","Buffer","from","getDeviceModel","ledgerTransport","async","getLedgerDeviceInfo","deviceModel","driver","deviceId","id","deviceName","productName","handleLedgerCommonError","error","Error","has","name","isLedgerConnectionBroken","ApiHardwareError","ConnectionBroken"],"sourceRoot":""}