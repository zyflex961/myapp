{"version":3,"file":"941.cea85c820b6e20872aa1.js","mappings":"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M,IAAM,GAAM,IAAM,IAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,EAAM,IAAM,IAAM,GAAM,GAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,GAAM,GAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,GAAM,EAAM,IAAM,GAAM,GAAM,GAAM,GAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,IAAM,GAAM,GAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,GAAM,IAAM,GAAM,IAAM,GAAM,GAAM,IAAM,GAAM,IAAM,IAC//CC,EAAI,CAAC,GAAM,EAAM,IAAM,IAAM,GAAM,GAAM,IAAM,GAAM,IAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,GAAM,IAAM,IAAM,GAAM,IAAM,GAAM,GAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,GAAM,IAAM,IAAM,GAAM,GAAM,IAAM,GAAM,IAAM,GAAM,GAAM,IAAM,IAAM,GAAM,EAAM,GAAM,IAAM,IAAM,GAAM,IAAM,GAAM,IAAM,IAAM,GAAM,IAAM,GAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,GAAM,IAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,GAAM,GAAM,IAAM,IAAM,IAAM,IAAM,GAAM,GAAM,GAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,EAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,GAAM,EAAM,IAAM,IAAM,GAAM,EAAM,IAAM,GAAM,GAAM,IAAM,IAAM,GAAM,GAAM,EAAM,IAAM,IAAM,IAAM,EAAM,EAAM,GAAM,IAAM,IAAM,GAAM,IAAM,GAAM,GAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,GAAM,IAAM,IAAM,IAAM,GAAM,IAAM,GAAM,IAAM,IAAM,IAAM,GAAM,IAAM,GAAM,IAAM,GAAM,GAAM,IAAM,IAAM,IAAM,IAAM,GAAM,GAAM,IAAM,GAAM,IAAM,GAAM,IAAM,GAAM,GAAM,GAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,GAAM,IAAM,IAAM,GAAM,IAAM,EAAM,IAAM,GAAM,IAAM,GAAM,GAAM,GAAM,GAAM,IAAM,IAAM,GAAM,GAAM,GAAM,IAAM,IAAM,GAAM,IAAM,GAAM,GAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,GAAM,GAAM,IAAM,GAAM,IAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,GAAM,IAAM,GAAM,GAAM,GAAM,EAAM,IAAM,IAAM,IAAM,IAAM,GAAM,IAAM,IAAM,GAAM,GAAM,GAAM,GAAM,GAAM,KAG//C9X,EAAK,CAAC,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,EAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAC1/FC,EAAK,CAAC,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,EAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,SAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAC1/FH,EAAK,CAAC,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,SAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,SAAY,WAAY,UAAY,WAAY,UAAY,WAAY,SAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,EAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAC1/FiY,EAAK,CAAC,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,SAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,SAAY,WAAY,UAAY,WAAY,UAAY,WAAY,SAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,EAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAG1/FC,EAAK,CAAC,WAAY,WAAY,UAAY,UAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,SAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,EAAY,UAAY,UAAY,UAAY,WAAY,WAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,YAC1/FC,EAAK,CAAC,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,EAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,UAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,SAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,SAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,YAC1/FC,EAAK,CAAC,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,SAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,EAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,YAC1/FC,EAAK,CAAC,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,SAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,SAAY,WAAY,SAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,SAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,EAAY,WAAY,UAAY,UAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,UAAY,WAAY,YAG1/FC,EAAK,CAAC,EAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,SAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,SAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,UAAY,WAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,SAAY,UAAY,UAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,SAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,UAAY,UAAY,SAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,YAC1/FC,EAAK,CAAC,EAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,UAAY,SAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,SAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,SAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,WAAY,UAAY,SAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,YAC1/FC,EAAK,CAAC,EAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,UAAY,UAAY,UAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,SAAY,UAAY,UAAY,WAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,SAAY,UAAY,UAAY,WAAY,UAAY,UAAY,UAAY,UAAY,SAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,YAC1/FC,EAAK,CAAC,EAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,UAAY,UAAY,UAAY,UAAY,UAAY,SAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,SAAY,UAAY,UAAY,UAAY,UAAY,SAAY,UAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,UAAY,WAAY,UAAY,UAAY,UAAY,UAAY,SAAY,UAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WAAY,WA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","sources":["webpack://mytonwallet/webpack/runtime/chunk loaded","webpack://mytonwallet/webpack/runtime/startup chunk dependencies","webpack://mytonwallet/./src/util/decimals.ts","webpack://mytonwallet/./src/util/bigint.ts","webpack://mytonwallet/./src/api/chains/ton/constants.ts","webpack://mytonwallet/./src/api/air/airAppCallWindow.ts","webpack://mytonwallet/./src/util/PostMessageConnector.ts","webpack://mytonwallet/./src/util/windowProvider/connector.ts","webpack://mytonwallet/./src/util/Deferred.ts","webpack://mytonwallet/./src/util/dateFormat.ts","webpack://mytonwallet/./src/api/types/misc.ts","webpack://mytonwallet/./src/util/generateUniqueId.ts","webpack://mytonwallet/./src/util/withCache.ts","webpack://mytonwallet/./src/util/extensionMessageSerializer.ts","webpack://mytonwallet/./src/api/chains/ton/util/dns.ts","webpack://mytonwallet/./src/api/chains/ton/util/other.ts","webpack://mytonwallet/./src/util/createPostMessageInterface.ts","webpack://mytonwallet/./src/util/bigintPatch.ts","webpack://mytonwallet/./src/util/account.ts","webpack://mytonwallet/./src/util/shortenAddress.ts","webpack://mytonwallet/./src/util/poisoningHash.ts","webpack://mytonwallet/./src/util/chain.ts","webpack://mytonwallet/./src/util/ton/formatTransferUrl.ts","webpack://mytonwallet/./src/util/tokens.ts","webpack://mytonwallet/./src/util/activities/index.ts","webpack://mytonwallet/./src/util/activities/order.ts","webpack://mytonwallet/./src/util/crcHash.ts","webpack://mytonwallet/./src/api/tonConnect/signing.ts","webpack://mytonwallet/./src/lib/ed25519-hd-key/index.ts","webpack://mytonwallet/./src/util/isMnemonicPrivateKey.ts","webpack://mytonwallet/./src/api/storages/types.ts","webpack://mytonwallet/./src/api/storages/capacitorStorage.ts","webpack://mytonwallet/./src/api/storages/extension.ts","webpack://mytonwallet/./src/api/storages/idb.ts","webpack://mytonwallet/./src/api/storages/localStorage.ts","webpack://mytonwallet/./src/api/storages/index.ts","webpack://mytonwallet/./src/api/common/accounts.ts","webpack://mytonwallet/./src/api/common/mnemonic.ts","webpack://mytonwallet/./src/lib/confusables/util.ts","webpack://mytonwallet/./src/lib/confusables/characters.ts","webpack://mytonwallet/./src/lib/confusables/index.ts","webpack://mytonwallet/./src/api/common/backend.ts","webpack://mytonwallet/./src/api/common/addresses.ts","webpack://mytonwallet/./src/util/datetime.ts","webpack://mytonwallet/./src/util/isEmptyObject.ts","webpack://mytonwallet/./src/api/db/repository.ts","webpack://mytonwallet/./src/api/db/index.ts","webpack://mytonwallet/./src/api/common/tokens.ts","webpack://mytonwallet/./src/api/chains/ton/toncenter/other.ts","webpack://mytonwallet/./src/api/chains/ton/util/tonapiio.ts","webpack://mytonwallet/./src/api/chains/ton/util/metadata.ts","webpack://mytonwallet/./src/util/areDeepEqual.ts","webpack://mytonwallet/./src/util/getDappConnectionUniqueId.ts","webpack://mytonwallet/./src/api/common/helpers.ts","webpack://mytonwallet/./src/api/chains/ton/toncenter/actions.ts","webpack://mytonwallet/./src/util/callbacks.ts","webpack://mytonwallet/./src/util/focusAwareDelay.ts","webpack://mytonwallet/./src/api/constants.ts","webpack://mytonwallet/./src/api/common/polling/utils.ts","webpack://mytonwallet/./src/api/common/polling/fallbackPollingScheduler.ts","webpack://mytonwallet/./src/util/reconnectingWebsocket.ts","webpack://mytonwallet/./src/api/chains/ton/toncenter/socket.ts","webpack://mytonwallet/./src/api/chains/ton/toncenter/throttleSocketActions.ts","webpack://mytonwallet/./src/api/chains/ton/toncenter/activityStream.ts","webpack://mytonwallet/./src/api/chains/ton/toncenter/transactions.ts","webpack://mytonwallet/./src/api/chains/ton/address.ts","webpack://mytonwallet/./src/api/chains/ton/wallet.ts","webpack://mytonwallet/./src/api/chains/ton/auth.ts","webpack://mytonwallet/./src/api/chains/ton/util/encryption.ts","webpack://mytonwallet/./src/api/chains/ton/util/signer.ts","webpack://mytonwallet/./src/api/chains/ton/traces.ts","webpack://mytonwallet/./src/api/chains/ton/toncenter/traces.ts","webpack://mytonwallet/./src/api/chains/ton/activities.ts","webpack://mytonwallet/./src/api/common/cache.ts","webpack://mytonwallet/./src/api/common/backendSocket.ts","webpack://mytonwallet/./src/api/common/polling/walletPolling.ts","webpack://mytonwallet/./src/api/common/polling/setupInactiveChainPolling.ts","webpack://mytonwallet/./src/api/common/swap.ts","webpack://mytonwallet/./src/api/common/txCallbacks.ts","webpack://mytonwallet/./src/api/chains/ton/priceless.ts","webpack://mytonwallet/./src/api/chains/ton/tokens.ts","webpack://mytonwallet/./src/api/chains/ton/balanceStream.ts","webpack://mytonwallet/./src/util/ton/transfer.ts","webpack://mytonwallet/./src/util/fee/transferFee.ts","webpack://mytonwallet/./src/api/chains/ton/util/diesel.ts","webpack://mytonwallet/./src/api/chains/ton/util/w5diesel.ts","webpack://mytonwallet/./src/api/chains/ton/util/sendExternal.ts","webpack://mytonwallet/./src/api/common/preventTransferConcurrency.ts","webpack://mytonwallet/./src/api/chains/ton/emulation.ts","webpack://mytonwallet/./src/api/chains/ton/toncenter/emulation.ts","webpack://mytonwallet/./src/api/chains/ton/transfer.ts","webpack://mytonwallet/./src/api/chains/ton/domains.ts","webpack://mytonwallet/./src/api/chains/ton/nfts.ts","webpack://mytonwallet/./src/util/orGate.ts","webpack://mytonwallet/./src/api/chains/ton/richActivityStream.ts","webpack://mytonwallet/./src/util/devSettings.ts","webpack://mytonwallet/./src/api/chains/ton/contracts/Ethena/TsUSDeWallet.ts","webpack://mytonwallet/./src/api/chains/ton/contracts/NominatorPool.ts","webpack://mytonwallet/./src/api/common/other.ts","webpack://mytonwallet/./src/api/chains/ton/staking.ts","webpack://mytonwallet/./src/util/staking/index.ts","webpack://mytonwallet/./src/util/ton/calcJettonStakingApr.ts","webpack://mytonwallet/./src/api/chains/ton/polling.ts","webpack://mytonwallet/./src/api/chains/ton/swap.ts","webpack://mytonwallet/./src/api/chains/ton/index.ts","webpack://mytonwallet/./src/api/chains/ton/vesting.ts","webpack://mytonwallet/./src/api/chains/ton/other.ts","webpack://mytonwallet/./src/api/hooks.ts","webpack://mytonwallet/./src/api/tonConnect/types/index.ts","webpack://mytonwallet/./src/util/tonConnectEnvironment.ts","webpack://mytonwallet/./src/api/common/dappPromises.ts","webpack://mytonwallet/./src/api/methods/dapps.ts","webpack://mytonwallet/./src/api/chains/tron/constants.ts","webpack://mytonwallet/./src/api/chains/tron/util/tokens.ts","webpack://mytonwallet/./src/api/chains/tron/activities.ts","webpack://mytonwallet/./src/api/chains/tron/util/tronweb.ts","webpack://mytonwallet/./src/api/chains/tron/wallet.ts","webpack://mytonwallet/./src/api/chains/tron/polling.ts","webpack://mytonwallet/./src/api/chains/tron/index.ts","webpack://mytonwallet/./src/api/chains/tron/auth.ts","webpack://mytonwallet/./src/api/chains/tron/transfer.ts","webpack://mytonwallet/./src/util/stringFormat.ts","webpack://mytonwallet/./src/api/chains/index.ts","webpack://mytonwallet/./src/api/methods/tokens.ts","webpack://mytonwallet/./src/api/methods/transfer.ts","webpack://mytonwallet/./src/api/tonConnect/errors.ts","webpack://mytonwallet/./src/api/tonConnect/utils.ts","webpack://mytonwallet/./src/api/tonConnect/index.ts","webpack://mytonwallet/./src/api/tonConnect/sse.ts","webpack://mytonwallet/./src/api/methods/preload.ts","webpack://mytonwallet/./src/api/methods/staking.ts","webpack://mytonwallet/./src/api/methods/other.ts","webpack://mytonwallet/./src/api/methods/swap.ts","webpack://mytonwallet/./src/api/methods/polling.ts","webpack://mytonwallet/./src/api/methods/init.ts","webpack://mytonwallet/./src/api/migrations/00016.ts","webpack://mytonwallet/./src/api/migrations/00017.ts","webpack://mytonwallet/./src/api/migrations/00018.ts","webpack://mytonwallet/./src/api/migrations/00019.ts","webpack://mytonwallet/./src/api/migrations/00020.ts","webpack://mytonwallet/./src/api/methods/activities.ts","webpack://mytonwallet/./src/api/methods/accounts.ts","webpack://mytonwallet/./src/api/methods/auth.ts","webpack://mytonwallet/./src/api/methods/wallet.ts","webpack://mytonwallet/./src/api/methods/nfts.ts","webpack://mytonwallet/./src/api/methods/domains.ts","webpack://mytonwallet/./src/api/methods/tonConnect.ts","webpack://mytonwallet/./src/api/methods/prices.ts","webpack://mytonwallet/./src/api/methods/notifications.ts","webpack://mytonwallet/./src/api/providers/worker/provider.ts","webpack://mytonwallet/./src/config.ts","webpack://mytonwallet/./src/util/schedulers.ts","webpack://mytonwallet/./src/api/errors.ts","webpack://mytonwallet/./src/api/chains/ton/util/index.ts","webpack://mytonwallet/./src/util/fetch.ts","webpack://mytonwallet/./src/util/environment.ts","webpack://mytonwallet/./src/util/handleError.ts","webpack://mytonwallet/./src/lib/big.js/index.js","webpack://mytonwallet/./src/util/safeExec.ts","webpack://mytonwallet/./src/lib/is-retry-allowed/index.js","webpack://mytonwallet/./src/lib/noble-ed25519/index.js","webpack://mytonwallet/./src/api/chains/ton/contracts/util.ts","webpack://mytonwallet/./src/util/logs.ts","webpack://mytonwallet/./src/api/types/errors.ts","webpack://mytonwallet/./src/util/random.ts","webpack://mytonwallet/./src/util/assert.ts","webpack://mytonwallet/./src/api/common/utils.ts","webpack://mytonwallet/./src/api/chains/ton/contracts/JettonStaking/imports/constants.ts","webpack://mytonwallet/./src/api/chains/ton/contracts/JettonWallet.ts","webpack://mytonwallet/./src/util/dns.ts","webpack://mytonwallet/./src/api/environment.ts","webpack://mytonwallet/./src/util/withCacheAsync.ts","webpack://mytonwallet/./src/api/chains/ton/contracts/JettonStaking/StakeWallet.ts","webpack://mytonwallet/./src/api/chains/ton/contracts/JettonStaking/StakingPool.ts","webpack://mytonwallet/./src/util/iteratees.ts","webpack://mytonwallet/./src/lib/aes-js/index.js","webpack://mytonwallet/./src/api/chains/ton/contracts/JettonConstants.ts","webpack://mytonwallet/./src/api/chains/ton/contracts/JettonMaster.ts","webpack://mytonwallet/./src/lib/axios-fetch-adapter/index.js","webpack://mytonwallet/./src/api/chains/ton/util/TonClient.ts","webpack://mytonwallet/./src/api/chains/ton/util/tonCore.ts","webpack://mytonwallet/./src/lib/axios-retry/index.js","webpack://mytonwallet/./src/api/chains/ton/contracts/DnsItem.ts","webpack://mytonwallet/webpack/bootstrap","webpack://mytonwallet/webpack/runtime/compat get default export","webpack://mytonwallet/webpack/runtime/define property getters","webpack://mytonwallet/webpack/runtime/ensure chunk","webpack://mytonwallet/webpack/runtime/get javascript chunk filename","webpack://mytonwallet/webpack/runtime/get mini-css chunk filename","webpack://mytonwallet/webpack/runtime/global","webpack://mytonwallet/webpack/runtime/hasOwnProperty shorthand","webpack://mytonwallet/webpack/runtime/make namespace object","webpack://mytonwallet/webpack/runtime/publicPath","webpack://mytonwallet/webpack/runtime/importScripts chunk loading","webpack://mytonwallet/webpack/startup"],"sourcesContent":["var deferred = [];\n__webpack_require__.O = (result, chunkIds, fn, priority) => {\n\tif(chunkIds) {\n\t\tpriority = priority || 0;\n\t\tfor(var i = deferred.length; i > 0 && deferred[i - 1][2] > priority; i--) deferred[i] = deferred[i - 1];\n\t\tdeferred[i] = [chunkIds, fn, priority];\n\t\treturn;\n\t}\n\tvar notFulfilled = Infinity;\n\tfor (var i = 0; i < deferred.length; i++) {\n\t\tvar [chunkIds, fn, priority] = deferred[i];\n\t\tvar fulfilled = true;\n\t\tfor (var j = 0; j < chunkIds.length; j++) {\n\t\t\tif ((priority & 1 === 0 || notFulfilled >= priority) && Object.keys(__webpack_require__.O).every((key) => (__webpack_require__.O[key](chunkIds[j])))) {\n\t\t\t\tchunkIds.splice(j--, 1);\n\t\t\t} else {\n\t\t\t\tfulfilled = false;\n\t\t\t\tif(priority < notFulfilled) notFulfilled = priority;\n\t\t\t}\n\t\t}\n\t\tif(fulfilled) {\n\t\t\tdeferred.splice(i--, 1)\n\t\t\tvar r = fn();\n\t\t\tif (r !== undefined) result = r;\n\t\t}\n\t}\n\treturn result;\n};","var next = __webpack_require__.x;\n__webpack_require__.x = () => {\n\treturn __webpack_require__.e(487).then(next);\n};","import { TONCOIN } from '../config';\r\nimport { Big } from '../lib/big.js';\r\n\r\nBig.RM = 0; // RoundDown\r\nBig.NE = -100000; // Disable exponential form\r\nBig.PE = 100000; // Disable exponential form\r\n\r\nconst ten = Big(10);\r\n\r\nexport function fromDecimal(value: string | number, decimals?: number) {\r\n  return BigInt(Big(value).mul(ten.pow(decimals ?? TONCOIN.decimals)).round().toString());\r\n}\r\n\r\nexport function toDecimal(value: bigint | number, decimals?: number, noFloor = false) {\r\n  return toBig(value, decimals ?? TONCOIN.decimals, noFloor).toString();\r\n}\r\n\r\nexport function toBig(value: bigint | number, decimals: number = TONCOIN.decimals, noFloor = false) {\r\n  return Big(value.toString()).div(ten.pow(decimals)).round(decimals, noFloor ? Big.roundHalfUp : undefined);\r\n}\r\n\r\nexport function roundDecimal(value: string, decimals: number) {\r\n  return Big(value).round(decimals).toString();\r\n}\r\n","import { ONE_TON } from '../config';\r\nimport { fromDecimal } from './decimals';\r\nimport { randomBytes } from './random';\r\n\r\nexport const BIGINT_PREFIX = 'bigint:';\r\n\r\nexport function bigintReviver(this: any, key: string, value: any) {\r\n  if (typeof value === 'string' && value.startsWith(BIGINT_PREFIX)) {\r\n    return BigInt(value.slice(7));\r\n  }\r\n  return value;\r\n}\r\n\r\nexport function bigintAbs(value: bigint) {\r\n  return value === -0n || value < 0n ? -value : value;\r\n}\r\n\r\nexport function bigintSum(values: bigint[]) {\r\n  let result = 0n;\r\n  for (const value of values) result += value;\r\n  return result;\r\n}\r\n\r\nexport function bigintDivideToNumber(value: bigint, num: number) {\r\n  return (value * ONE_TON) / fromDecimal(num);\r\n}\r\n\r\nexport function bigintMultiplyToNumber(value: bigint, num: number) {\r\n  return (value * fromDecimal(num)) / ONE_TON;\r\n}\r\n\r\nexport function bigintRandom(bytes: number) {\r\n  let value = BigInt(0);\r\n  for (const randomNumber of randomBytes(bytes)) {\r\n    const randomBigInt = BigInt(randomNumber);\r\n    value = (value << BigInt(8)) + randomBigInt;\r\n  }\r\n  return value;\r\n}\r\n\r\nexport function bigintCountBits(value: bigint) {\r\n  const binaryString = value.toString(2);\r\n  return binaryString.length;\r\n}\r\n\r\nexport function bigintMax(value0: bigint, value1: bigint) {\r\n  return value0 > value1 ? value0 : value1;\r\n}\r\n\r\nexport function bigintMin(value0: bigint, value1: bigint) {\r\n  return value0 < value1 ? value0 : value1;\r\n}\r\n\r\nexport function bigintMultiplePercent(value: bigint, percent: number) {\r\n  return (value * fromDecimal(percent / 100)) / ONE_TON;\r\n}\r\n","import type { TonTransport } from '@ton-community/ton-ledger';\r\n\r\nimport type { ApiTonWalletVersion, ContractInfo, ContractName } from './types';\r\n\r\nimport {\r\n  TONAPIIO_MAINNET_URL,\r\n  TONAPIIO_TESTNET_URL,\r\n  TONCENTER_MAINNET_URL,\r\n  TONCENTER_TESTNET_URL,\r\n} from '../../../config';\r\nimport { JettonStakingGas } from './contracts/JettonStaking/imports/constants';\r\n\r\nexport const TON_BIP39_PATH = 'm/44\\'/607\\'/0\\'';\r\n\r\nexport const NETWORK_CONFIG = {\r\n  mainnet: {\r\n    toncenterUrl: TONCENTER_MAINNET_URL,\r\n    tonApiIoUrl: TONAPIIO_MAINNET_URL,\r\n    // W5 wallet chain IDs for different subwallet variants\r\n    chainId: -239,\r\n  },\r\n  testnet: {\r\n    toncenterUrl: TONCENTER_TESTNET_URL,\r\n    tonApiIoUrl: TONAPIIO_TESTNET_URL,\r\n    // W5 wallet chain IDs for different subwallet variants\r\n    chainId: -3,\r\n  },\r\n};\r\n\r\nexport const ONE_TON = 1_000_000_000n;\r\nexport const TOKEN_TRANSFER_AMOUNT = 50000000n; // 0.05 TON\r\nexport const TINY_TOKEN_TRANSFER_AMOUNT = 18000000n; // 0.018 TON\r\nexport const TOKEN_TRANSFER_REAL_AMOUNT = 32100000n; // 0.0321 TON\r\nexport const TINY_TOKEN_TRANSFER_REAL_AMOUNT = 8000000n; // 0.008 TON\r\nexport const TINIEST_TOKEN_TRANSFER_REAL_AMOUNT = 3000000n; // 0.003 TON\r\nexport const TOKEN_TRANSFER_FORWARD_AMOUNT = 1n; // 0.000000001 TON\r\nexport const CLAIM_MINTLESS_AMOUNT = 20000000n; // 0.02 TON\r\n\r\n/** The amount that MyTonWallet attaches to NFT transfers */\r\nexport const NFT_TRANSFER_AMOUNT = 100000000n; // 0.1 TON\r\nexport const NFT_TRANSFER_REAL_AMOUNT = 5000000n; // 0.005 TON\r\nexport const NFT_TRANSFER_FORWARD_AMOUNT = 1n; // 0.000000001 TON\r\n/**\r\n * When the NFT contract handles the payload we send, it simply adds its data to the payload. If the resulting payload\r\n * size becomes greater than the cell capacity, the contract fails to send the NFT. To avoid that, we keep some free\r\n * space in the payload cell we send. This constant is the size of the free space in bits.\r\n */\r\nexport const NFT_PAYLOAD_SAFE_MARGIN = 14 * 8;\r\n\r\nexport const TON_GAS = {\r\n  stakeNominators: ONE_TON,\r\n  unstakeNominators: ONE_TON,\r\n  stakeLiquid: ONE_TON,\r\n  unstakeLiquid: ONE_TON,\r\n  stakeJettonsForward: JettonStakingGas.STAKE_JETTONS,\r\n  stakeJettons: JettonStakingGas.STAKE_JETTONS + TOKEN_TRANSFER_AMOUNT,\r\n  unstakeJettons: JettonStakingGas.UNSTAKE_JETTONS,\r\n  claimJettons: JettonStakingGas.JETTON_TRANSFER + JettonStakingGas.SIMPLE_UPDATE_REQUEST,\r\n  changeDns: 15_000_000n, // 0.015 TON\r\n  stakeEthena: TOKEN_TRANSFER_AMOUNT + 100_000_000n, // 0.15 TON\r\n  stakeEthenaForward: 100_000_000n, // 0.1 TON\r\n  unstakeEthena: TOKEN_TRANSFER_AMOUNT + 100_000_000n, // 0.15 TON\r\n  unstakeEthenaForward: 100_000_000n, // 0.1 TON\r\n  unstakeEthenaLocked: 150_000_000n, // 0.15 TON\r\n  unstakeEthenaLockedForward: 70_000_000n, // 0.07 TON\r\n} as const;\r\n\r\nexport const TON_GAS_REAL = {\r\n  stakeNominators: 1_000_052_853n,\r\n  unstakeNominators: 148_337_433n,\r\n  stakeLiquid: 20_251_387n,\r\n  unstakeLiquid: 18_625_604n,\r\n  stakeJettons: 74_879_996n,\r\n  unstakeJettons: 59_971_662n,\r\n  claimJettons: 57_053_859n,\r\n  stakeEthena: 116_690_790n,\r\n  unstakeEthena: 113_210_330n,\r\n  unstakeEthenaLocked: 37_612_000n,\r\n};\r\n\r\nexport const STAKE_COMMENT = 'd';\r\nexport const UNSTAKE_COMMENT = 'w';\r\n\r\nexport const ATTEMPTS = 5;\r\n\r\nexport const DEFAULT_DECIMALS = 9;\r\nexport const DEFAULT_IS_BOUNCEABLE = true;\r\nexport const WALLET_IS_BOUNCEABLE = false;\r\n\r\n// Fee may change, so we add 5% for more reliability. This is only safe for low-fee blockchains such as TON.\r\nexport const FEE_FACTOR = 1.05;\r\n\r\nexport const ALL_WALLET_VERSIONS: ApiTonWalletVersion[] = [\r\n  'simpleR1', 'simpleR2', 'simpleR3', 'v2R1', 'v2R2', 'v3R1', 'v3R2', 'v4R2', 'W5',\r\n];\r\n\r\nexport const OUR_FEE_PAYLOAD_BOC = 'te6cckEBAQEABgAACE0jhUPUcYAL';\r\n\r\nexport const RAW_ADDRESS_LENGTH = 66;\r\n\r\nexport enum Workchain {\r\n  MasterChain = -1,\r\n  BaseChain = 0,\r\n}\r\n\r\nexport const WORKCHAIN = Workchain.BaseChain;\r\nexport const TRANSFER_TIMEOUT_SEC = 600; // 10 min.\r\n\r\nexport const DEFAULT_MAX_MESSAGES = 4;\r\nexport const LEDGER_MAX_MESSAGES = 1;\r\nexport const W5_MAX_MESSAGES = 255;\r\n\r\nexport const LEDGER_WALLET_VERSIONS = {\r\n  v3R2: 'v3r2',\r\n  v4R2: 'v4',\r\n} as const satisfies Partial<Record<\r\n  ApiTonWalletVersion,\r\n  NonNullable<Parameters<TonTransport['getAddress']>[1]>['walletVersion']\r\n>>;\r\n\r\nexport const LEDGER_DEFAULT_WALLET_VERSION: keyof typeof LEDGER_WALLET_VERSIONS = 'v4R2';\r\nexport const LEDGER_VESTING_SUBWALLET_ID = 0x10C;\r\n\r\nexport enum OpCode {\r\n  Comment = 0,\r\n  Encrypted = 0x2167da4b,\r\n  OurFee = 0x4d238543,\r\n  Bounced = 0xffffffff,\r\n}\r\n\r\nexport enum JettonOpCode {\r\n  Transfer = 0xf8a7ea5,\r\n  TransferNotification = 0x7362d09c,\r\n  InternalTransfer = 0x178d4519,\r\n  Excesses = 0xd53276db,\r\n  Burn = 0x595f07bc,\r\n  BurnNotification = 0x7bdd97de,\r\n}\r\n\r\nexport enum NftOpCode {\r\n  TransferOwnership = 0x5fcc3d14,\r\n  OwnershipAssigned = 0x05138d91,\r\n  Excesses = 0xd53276db,\r\n}\r\n\r\nexport enum LiquidStakingOpCode {\r\n  // Pool\r\n  RequestLoan = 0xe642c965,\r\n  LoanRepayment = 0xdfdca27b,\r\n  Deposit = 0x47d54391,\r\n  Withdraw = 0x319B0CDC,\r\n  Withdrawal = 0x0a77535c,\r\n  DeployController = 0xb27edcad,\r\n  Touch = 0x4bc7c2df,\r\n  Donate = 0x73affe21,\r\n  // NFT\r\n  DistributedAsset = 0xdb3b8abd,\r\n  // Jetton\r\n  Vote = 0x69fb306c,\r\n}\r\n\r\nexport enum JettonStakingOpCode {\r\n  UnstakeRequest = 0x499a9262,\r\n  ClaimRewards = 0x78d9f109,\r\n}\r\n\r\nexport enum VestingV1OpCode {\r\n  AddWhitelist = 0x7258a69b,\r\n}\r\n\r\nexport enum SingleNominatorOpCode {\r\n  Withdraw = 0x1000,\r\n  ChangeValidator = 0x1001,\r\n}\r\n\r\nexport enum DnsOpCode {\r\n  ChangeRecord = 0x4eb1f0f9,\r\n}\r\n\r\nexport enum TeleitemOpCode {\r\n  Ok = 0xa37a0983,\r\n}\r\n\r\nexport enum OtherOpCode {\r\n  TokenBridgePaySwap = 0x8,\r\n}\r\n\r\nexport enum ContractType {\r\n  Wallet = 'wallet',\r\n  Staking = 'staking',\r\n}\r\n\r\nexport enum DnsCategory {\r\n  DnsNextResolver = 'dns_next_resolver',\r\n  Wallet = 'wallet',\r\n  Site = 'site',\r\n  BagId = 'storage',\r\n  Unknown = 'unknown',\r\n}\r\n\r\nexport const EXCESS_OP_CODES = [\r\n  JettonOpCode.Excesses,\r\n  TeleitemOpCode.Ok,\r\n  0x80f4c55b, // StormTrade excess\r\n];\r\n\r\nexport const DNS_CATEGORY_HASH_MAP = {\r\n  dns_next_resolver: '19f02441ee588fdb26ee24b2568dd035c3c9206e11ab979be62e55558a1d17ff',\r\n  wallet: 'e8d44050873dba865aa7c170ab4cce64d90839a34dcfd6cf71d14e0205443b1b',\r\n  site: 'fbae041b02c41ed0fd8a4efb039bc780dd6af4a1f0c420f42561ae705dda43fe',\r\n  storage: '49a25f9feefaffecad0fcd30c50dc9331cff8b55ece53def6285c09e17e6f5d7',\r\n} as const;\r\n\r\nexport const KnownContracts: Record<ContractName, ContractInfo> = {\r\n  simpleR1: {\r\n    name: 'simpleR1',\r\n    oldHash: '3232dc55b02b3d2a9485adc151cf29c50b94c374d3571cb59390d761b87af8bd',\r\n    type: ContractType.Wallet,\r\n  },\r\n  simpleR2: {\r\n    name: 'simpleR2',\r\n    oldHash: '672ce2b01d2fd487a5e0528611e7e4fc11867148cc13ff772bd773b72fb368df',\r\n    type: ContractType.Wallet,\r\n  },\r\n  simpleR3: {\r\n    name: 'simpleR3',\r\n    oldHash: 'd95417233f66ae218317f533630cbbddc677d6d893d5722be6947c8fad8e9d52',\r\n    type: ContractType.Wallet,\r\n  },\r\n  v2R1: {\r\n    name: 'v2R1',\r\n    oldHash: 'fb3bd539b7e50166f1cfdc0bbd298b1c88f6b261fe5ee61343ea47ab4b256029',\r\n    type: ContractType.Wallet,\r\n  },\r\n  v2R2: {\r\n    name: 'v2R2',\r\n    oldHash: 'b584b6106753b7f34709df505be603e463a44ff6a85adf7fec4e26453c325983',\r\n    type: ContractType.Wallet,\r\n  },\r\n  v3R1: {\r\n    name: 'v3R1',\r\n    oldHash: '11d123ed5c2055128e75a9ef4cf1e837e6d14a9c079c39939885c78dc13626e6',\r\n    type: ContractType.Wallet,\r\n  },\r\n  v3R2: {\r\n    name: 'v3R2',\r\n    oldHash: 'df7bf014ee7ac0c38da19ef1b7fa054e2cc7a4513df1f1aa295109cf3606ac14',\r\n    type: ContractType.Wallet,\r\n  },\r\n  v4R1: {\r\n    name: 'v4R1',\r\n    oldHash: '1bc0dfa40956c911616f8a5db09ecc217601bae48d7d3f9311562c5afcb66dcf',\r\n    type: ContractType.Wallet,\r\n  },\r\n  v4R2: {\r\n    name: 'v4R2',\r\n    oldHash: '5659ce2300f4a09a37b0bdee41246ded52474f032c1d6ffce0d7d31b18b7b2b1',\r\n    type: ContractType.Wallet,\r\n  },\r\n  W5: {\r\n    name: 'W5',\r\n    oldHash: '7e94eaaeaaa423b9396e79747038c42edc4fe98dce65094071f0e0ad2df22fd5',\r\n    type: ContractType.Wallet,\r\n  },\r\n  highloadV2: {\r\n    name: 'highloadV2',\r\n    oldHash: 'fcd7d1f3b3847f0b9bd44bc64a2256c03450979dd1646a24fbc874b075392d6e',\r\n    type: ContractType.Wallet,\r\n  },\r\n  nominatorPool: {\r\n    name: 'nominatorPool',\r\n    oldHash: '26faa2d0fd2a8197ea36ded8dc50ad081cce5244207e9b05c08c1bb655527bff',\r\n    type: ContractType.Staking,\r\n  },\r\n  multisig: {\r\n    name: 'multisig',\r\n    oldHash: '45d890485cdd6b152bcbbe3fb2e16d2df82f6da840440a5b9f34ea13cb0b92d2',\r\n    type: ContractType.Wallet,\r\n  },\r\n  multisigV2: {\r\n    name: 'multisigV2',\r\n    oldHash: 'eb1323c5544d5bf26248dc427d108d722d5c2922dd97dd0bdf903c4cea73ca97',\r\n    type: ContractType.Wallet,\r\n  },\r\n  vesting: {\r\n    name: 'vesting',\r\n    oldHash: '69dc931958f7aa203c4a7bfcf263d25d2d828d573184b542a65dd55c8398ad83',\r\n    type: ContractType.Wallet,\r\n  },\r\n  multisigNew: {\r\n    name: 'multisigNew',\r\n    oldHash: '7cb3678880388acff45d74b2e7e7544caa8039d20b49f57c75b53c051b6fa30f',\r\n    type: ContractType.Wallet,\r\n  },\r\n  dedustPool: {\r\n    name: 'dedustPool',\r\n    oldHash: 'f216ded2b43d32e2d487db6fa6e4d2387f0ef1d7b53ec1ad85f0b4feb8e4ed62',\r\n    isSwapAllowed: true,\r\n  },\r\n  dedustVaultNative: {\r\n    name: 'dedustVaultNative',\r\n    oldHash: '64a42ad66688097422901ae6188670f0d6292ad3bdb4139289666f24187e86cb',\r\n    isSwapAllowed: true,\r\n  },\r\n  // Example: https://tonscan.org/address/EQAYqo4u7VF0fa4DPAebk4g9lBytj2VFny7pzXR0trjtXQaO\r\n  dedustVaultJetton: {\r\n    name: 'dedustVaultJetton',\r\n    oldHash: '5bc82f0c5972ccc6732e98cbe31ea4795da818f9e06c991331568182a8362307',\r\n    isSwapAllowed: true,\r\n  },\r\n  stonPtonWallet: {\r\n    name: 'stonPtonWallet',\r\n    oldHash: '6ccbf71a3ed9c7355f84a698a44a7406574bfb8aa34d4bbd86ab75ee9c994880',\r\n    isSwapAllowed: true,\r\n  },\r\n  stonRouter: {\r\n    name: 'stonRouter',\r\n    oldHash: '14ce618a0e9a94adc99fa6e975219ddd675425b30dfa9728f98714c8dc55f9da',\r\n    isSwapAllowed: true,\r\n  },\r\n  stonRouterV2_1: {\r\n    name: 'stonRouterV2_1',\r\n    oldHash: 'd61cb7fb7bee0cc414286a482fccdec53c3f8717e4aae4fc362d98ab6254e6cd',\r\n    isSwapAllowed: true,\r\n  },\r\n  stonPoolV2_1: {\r\n    name: 'stonPoolV2_1',\r\n    oldHash: '16cc513c380e329f45d54f294787e2030e289799eca138961c1cd7e26e882c7c',\r\n    isSwapAllowed: true,\r\n  },\r\n  // Example: https://tonscan.org/address/EQCS4UEa5UaJLzOyyKieqQOQ2P9M-7kXpkO5HnP3Bv250cN3\r\n  stonRouterV2_2: {\r\n    name: 'stonRouterV2_2',\r\n    oldHash: '094b5084111addda1b6fac7007c8a8f85ff4ccc63475815ab3dfa3b5b4c6b102',\r\n    isSwapAllowed: true,\r\n  },\r\n  // Example: https://tonscan.org/address/EQBSNX_5mSikBVttWhIaIb0f8jJU7fL6kvyyFVppd7dWRO6M\r\n  stonRouterV2_2_alt: {\r\n    name: 'stonRouterV2_2_alt',\r\n    oldHash: 'd41e7563afa05ee008655e190920d3f53de9cab4c2d4e10ee1d0f158e95e52e5',\r\n    isSwapAllowed: true,\r\n  },\r\n  stonPoolV2_2: {\r\n    name: 'stonPoolV2_2',\r\n    oldHash: '11eaf6db706e63adf9327897aaa845c77a631856abfc14375837f19b617cacb4',\r\n    isSwapAllowed: true,\r\n  },\r\n  // Example: https://tonscan.org/address/EQBiLHuQjDj4fNyCD7Ch5HwpNGldlb5g-LMwQ1kStQ4NM5kv\r\n  stonPtonWalletV2: {\r\n    name: 'stonPtonWalletV2',\r\n    oldHash: '2761042202032258de9eb1b672e1ec2e4f13b2af00700195801ada33f7ced1b6',\r\n    isSwapAllowed: true,\r\n  },\r\n  // Example: https://tonscan.org/address/EQC_-t0nCnOFMdp7E7qPxAOCbCWGFz-e3pwxb6tTvFmshjt5\r\n  toncoRouter: {\r\n    name: 'toncoRouter',\r\n    hash: '9b9891eaa7db7becc6ccdda1bd9a8d25dc3df2817d57e4b27ec003daf81a4439',\r\n    isSwapAllowed: true,\r\n  },\r\n  // `oldHash` should no longer be used for new contracts; it is retained for backwards compatibility with\r\n  // contracts for which retrieving the new hash is difficult due to missing address tracking in past.\r\n  // The `hash` field has been added for new contracts. It is a hex hash of the code,\r\n  // and is available on both Tonviewer and Tonscan. Don't forget to add an example link when adding a new contract.\r\n};\r\n","import type { WindowMethodArgs, WindowMethodResponse, WindowMethods } from '../../util/windowProvider/types';\r\nimport type { AirWindow } from '../types/air';\r\nimport { ApiCommonError } from '../types';\r\n\r\nlet nativeCallNumber = 0;\r\n\r\nexport const airAppCallWindow = <T extends keyof WindowMethods>(methodName: T, ...args: WindowMethodArgs<T>) => {\r\n  const airWindow = window as AirWindow;\r\n  const bridge = airWindow.airBridge;\r\n  return new Promise<Awaited<WindowMethodResponse<T>>>((resolve, reject) => {\r\n    nativeCallNumber++;\r\n    const requestNumber = nativeCallNumber;\r\n    bridge.nativeCallCallbacks[requestNumber] = (response) => {\r\n      delete bridge.nativeCallCallbacks[requestNumber];\r\n      if (!response.ok) reject(new Error(ApiCommonError.Unexpected));\r\n      else resolve(response.result as Awaited<WindowMethodResponse<T>>);\r\n    };\r\n    if (airWindow.webkit) {\r\n      airWindow.webkit?.messageHandlers.nativeCall.postMessage({\r\n        requestNumber, methodName, arg0: args[0], arg1: args[1],\r\n      });\r\n    } else {\r\n      airWindow.androidApp.nativeCall(\r\n        requestNumber, methodName, args[0], args[1],\r\n      );\r\n    }\r\n  });\r\n};\r\n","import { decodeError, decodeExtensionMessage, encodeExtensionMessage } from './extensionMessageSerializer';\r\nimport generateUniqueId from './generateUniqueId';\r\nimport { logDebugError } from './logs';\r\n\r\nexport interface CancellableCallback {\r\n  (\r\n    ...args: any[]\r\n  ): void;\r\n\r\n  isCanceled?: boolean;\r\n  acceptsBuffer?: boolean;\r\n}\r\n\r\ntype InitData = {\r\n  channel?: string;\r\n  type: 'init';\r\n  args: any[];\r\n};\r\n\r\ntype CallMethodData = {\r\n  channel?: string;\r\n  type: 'callMethod';\r\n  messageId?: string;\r\n  name: string;\r\n  args: any;\r\n  withCallback?: boolean;\r\n};\r\n\r\nexport type OriginMessageData = InitData | CallMethodData | {\r\n  channel?: string;\r\n  type: 'cancelProgress';\r\n  messageId: string;\r\n};\r\n\r\nexport interface OriginMessageEvent extends MessageEvent {\r\n  data: OriginMessageData;\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-redundant-type-constituents\r\nexport type ApiUpdate = { type: string } & any;\r\n\r\nexport type WorkerMessageError = {\r\n  name: string;\r\n  message: string;\r\n  stack?: string;\r\n};\r\n\r\nexport type WorkerMessageData = {\r\n  channel?: string;\r\n  type: 'update';\r\n  update: ApiUpdate;\r\n} | {\r\n  channel?: string;\r\n  type: 'methodResponse';\r\n  messageId: string;\r\n  response?: any;\r\n  error?: WorkerMessageError;\r\n} | {\r\n  channel?: string;\r\n  type: 'methodCallback';\r\n  messageId: string;\r\n  callbackArgs: any[];\r\n} | {\r\n  channel?: string;\r\n  type: 'unhandledError';\r\n  error: WorkerMessageError;\r\n};\r\n\r\nexport interface WorkerMessageEvent {\r\n  data: WorkerMessageData;\r\n}\r\n\r\ninterface RequestStates {\r\n  messageId: string;\r\n  resolve: AnyToVoidFunction;\r\n  reject: AnyToVoidFunction;\r\n  callback: AnyToVoidFunction;\r\n}\r\n\r\ntype InputRequestTypes = Record<string, AnyFunction>;\r\n\r\ntype Values<T> = T[keyof T];\r\nexport type RequestTypes<T extends InputRequestTypes> = Values<{\r\n  [Name in keyof (T)]: {\r\n    name: Name & string;\r\n    args: Parameters<T[Name]>;\r\n  }\r\n}>;\r\n\r\nclass ConnectorClass<T extends InputRequestTypes> {\r\n  private requestStates = new Map<string, RequestStates>();\r\n\r\n  private requestStatesByCallback = new Map<AnyToVoidFunction, RequestStates>();\r\n\r\n  constructor(\r\n    public target: Worker | Window | chrome.runtime.Port | DedicatedWorkerGlobalScope,\r\n    private onUpdate?: (update: ApiUpdate) => void,\r\n    private channel?: string,\r\n    private shouldUseJson?: boolean,\r\n    private targetOrigin = '*',\r\n  ) {\r\n  }\r\n\r\n  public destroy() {\r\n  }\r\n\r\n  init(...args: any[]) {\r\n    this.postMessage({\r\n      type: 'init',\r\n      args,\r\n    });\r\n  }\r\n\r\n  request(messageData: RequestTypes<T>) {\r\n    const { requestStates, requestStatesByCallback } = this;\r\n\r\n    const messageId = generateUniqueId();\r\n    const payload: CallMethodData = {\r\n      type: 'callMethod',\r\n      messageId,\r\n      ...messageData,\r\n    };\r\n\r\n    const requestState = { messageId } as RequestStates;\r\n\r\n    // Re-wrap type because of `postMessage`\r\n    const promise = new Promise<any>((resolve, reject) => {\r\n      Object.assign(requestState, { resolve, reject });\r\n    });\r\n\r\n    if (typeof payload.args[payload.args.length - 1] === 'function') {\r\n      payload.withCallback = true;\r\n\r\n      const callback = payload.args.pop() as AnyToVoidFunction;\r\n      requestState.callback = callback;\r\n      requestStatesByCallback.set(callback, requestState);\r\n    }\r\n\r\n    requestStates.set(messageId, requestState);\r\n    promise\r\n      .catch(() => undefined)\r\n      .finally(() => {\r\n        requestStates.delete(messageId);\r\n\r\n        if (requestState.callback) {\r\n          requestStatesByCallback.delete(requestState.callback);\r\n        }\r\n      });\r\n\r\n    this.postMessage(payload);\r\n\r\n    return promise;\r\n  }\r\n\r\n  cancelCallback(progressCallback: CancellableCallback) {\r\n    progressCallback.isCanceled = true;\r\n\r\n    const { messageId } = this.requestStatesByCallback.get(progressCallback) || {};\r\n    if (!messageId) {\r\n      return;\r\n    }\r\n\r\n    this.postMessage({\r\n      type: 'cancelProgress',\r\n      messageId,\r\n    });\r\n  }\r\n\r\n  onMessage(data: WorkerMessageData | string) {\r\n    try {\r\n      data = decodeExtensionMessage(data);\r\n    } catch (err: any) {\r\n      logDebugError('PostMessageConnector: Failed to parse message', err);\r\n      return;\r\n    }\r\n\r\n    const { requestStates, channel } = this;\r\n    if (data.channel !== channel) {\r\n      return;\r\n    }\r\n\r\n    if (data.type === 'update' && this.onUpdate) {\r\n      this.onUpdate(data.update);\r\n    }\r\n    if (data.type === 'methodResponse') {\r\n      const requestState = requestStates.get(data.messageId);\r\n      if (requestState) {\r\n        if (data.error) {\r\n          requestState.reject(decodeError(data.error));\r\n        } else {\r\n          requestState.resolve(data.response);\r\n        }\r\n      }\r\n    } else if (data.type === 'methodCallback') {\r\n      const requestState = requestStates.get(data.messageId);\r\n      requestState?.callback?.(...data.callbackArgs);\r\n    } else if (data.type === 'unhandledError') {\r\n      throw decodeError(data.error);\r\n    }\r\n  }\r\n\r\n  private postMessage(data: OriginMessageData) {\r\n    data.channel = this.channel;\r\n\r\n    let rawData: OriginMessageData | string = data;\r\n    if (this.shouldUseJson) {\r\n      rawData = encodeExtensionMessage(data);\r\n    }\r\n\r\n    if ('open' in this.target) { // Is Window\r\n      this.target.postMessage(rawData, this.targetOrigin);\r\n    } else {\r\n      this.target.postMessage(rawData);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Allows to call functions, provided by another messenger (a window, a worker), in this messenger.\r\n * The other messenger must provide the functions using `createPostMessageInterface`.\r\n */\r\nexport function createConnector<T extends InputRequestTypes>(\r\n  worker: Worker | Window | DedicatedWorkerGlobalScope,\r\n  onUpdate?: (update: ApiUpdate) => void,\r\n  channel?: string,\r\n  targetOrigin?: string,\r\n) {\r\n  const connector = new ConnectorClass<T>(worker, onUpdate, channel, undefined, targetOrigin);\r\n\r\n  function handleMessage({ data }: WorkerMessageEvent | MessageEvent) {\r\n    connector.onMessage(data);\r\n  }\r\n\r\n  worker.addEventListener('message', handleMessage as any); // TS weirdly complains here\r\n\r\n  connector.destroy = () => {\r\n    worker.removeEventListener('message', handleMessage as any);\r\n  };\r\n\r\n  return connector;\r\n}\r\n\r\n/**\r\n * Allows to call functions, provided by the extension service worker, in this window.\r\n * The service worker must provide the functions using `createExtensionInterface`.\r\n */\r\nexport function createExtensionConnector(\r\n  name: string,\r\n  onUpdate?: (update: ApiUpdate) => void,\r\n  getInitArgs?: () => any,\r\n  channel?: string,\r\n) {\r\n  const connector = new ConnectorClass(connect(), onUpdate, channel, true);\r\n\r\n  function connect() {\r\n    const port = self.chrome.runtime.connect({ name });\r\n\r\n    port.onMessage.addListener((data: string | WorkerMessageData) => {\r\n      connector.onMessage(data);\r\n    });\r\n\r\n    // For some reason port can suddenly get disconnected\r\n    port.onDisconnect.addListener(() => {\r\n      connector.target = connect();\r\n      connector.init(getInitArgs?.());\r\n    });\r\n\r\n    return port;\r\n  }\r\n\r\n  connector.init(getInitArgs?.());\r\n\r\n  return connector;\r\n}\r\n\r\n/**\r\n * Allows to call functions, provided by a window, in this service worker.\r\n * The window must provide the functions using `createReverseExtensionInterface`.\r\n *\r\n * Warning: the connector is able to send messages only when the popup window is open.\r\n */\r\nexport function createReverseExtensionConnector(portName: string) {\r\n  const nullWorker = {\r\n    postMessage() {\r\n      throw new Error('The popup window is not connected');\r\n    },\r\n  } as Pick<Worker, 'postMessage'> as Worker;\r\n\r\n  const connector = new ConnectorClass(nullWorker, undefined, undefined, true);\r\n\r\n  chrome.runtime.onConnect.addListener((port) => {\r\n    if (port.name !== portName) {\r\n      return;\r\n    }\r\n\r\n    connector.target = port;\r\n\r\n    port.onMessage.addListener((data: string | WorkerMessageData) => {\r\n      connector.onMessage(data);\r\n    });\r\n\r\n    port.onDisconnect.addListener(() => {\r\n      connector.target = nullWorker;\r\n    });\r\n  });\r\n\r\n  return connector;\r\n}\r\n\r\nexport type Connector<T extends InputRequestTypes = InputRequestTypes> = ReturnType<typeof createConnector<T>>;\r\n","import type { Connector } from '../PostMessageConnector';\r\nimport type { WindowMethodArgs, WindowMethodResponse, WindowMethods } from './types';\r\n\r\nimport { IS_AIR_APP, WINDOW_PROVIDER_CHANNEL, WINDOW_PROVIDER_PORT } from '../../config';\r\nimport { airAppCallWindow } from '../../api/air/airAppCallWindow';\r\n\r\nimport { createReverseExtensionConnector } from '../PostMessageConnector';\r\nimport { createConnector } from '../PostMessageConnector';\r\n\r\nlet connector: Connector;\r\n\r\nexport function initWindowConnector() {\r\n  if (!connector) {\r\n    // We use process.env.IS_EXTENSION instead of IS_EXTENSION in order to remove the irrelevant code during bundling\r\n    if (process.env.IS_EXTENSION) {\r\n      connector = createReverseExtensionConnector(WINDOW_PROVIDER_PORT);\r\n      // connector.init() is not called here because the extension connector is available only when the popup is open\r\n    } else {\r\n      connector = createConnector(self as DedicatedWorkerGlobalScope, undefined, WINDOW_PROVIDER_CHANNEL);\r\n      connector.init();\r\n    }\r\n  }\r\n}\r\n\r\nexport function callWindow<T extends keyof WindowMethods>(methodName: T, ...args: WindowMethodArgs<T>) {\r\n  if (IS_AIR_APP) return airAppCallWindow(methodName, ...args) as EnsurePromise<WindowMethodResponse<T>>;\r\n\r\n  if (!connector) {\r\n    throw new Error('API is not initialized');\r\n  }\r\n\r\n  return connector.request({ name: methodName, args }) as EnsurePromise<WindowMethodResponse<T>>;\r\n}\r\n","export default class Deferred<T = void> {\r\n  promise: Promise<T>;\r\n\r\n  reject!: (reason?: any) => void;\r\n\r\n  resolve!: (value: T | PromiseLike<T>) => void;\r\n\r\n  constructor() {\r\n    this.promise = new Promise((resolve, reject) => {\r\n      this.reject = reject;\r\n      this.resolve = resolve;\r\n    });\r\n  }\r\n\r\n  static resolved(): Deferred<void>;\r\n  static resolved<T>(value: T): Deferred<T>;\r\n  static resolved<T>(value?: T): Deferred<T | void> {\r\n    const deferred = new Deferred<T | void>();\r\n    deferred.resolve(value);\r\n    return deferred;\r\n  }\r\n}\r\n","import type { LangCode } from '../global/types';\r\nimport type { LangFn } from './langProvider';\r\n\r\nimport withCache from './withCache';\r\n\r\nexport const SECOND = 1000;\r\nexport const MINUTE = SECOND * 60;\r\nexport const HOUR = MINUTE * 60;\r\nexport const DAY = HOUR * 24;\r\nexport const YEAR = 365 * DAY;\r\n\r\nconst formatDayToStringWithCache = withCache((\r\n  langCode: LangCode,\r\n  dayStartAt: number,\r\n  noYear?: boolean,\r\n  monthFormat: 'short' | 'long' | 'numeric' | false = 'short',\r\n  noDay?: boolean,\r\n  withTime = false,\r\n) => {\r\n  return new Date(dayStartAt).toLocaleString(\r\n    langCode,\r\n    {\r\n      year: noYear ? undefined : 'numeric',\r\n      month: monthFormat || undefined,\r\n      day: noDay ? undefined : 'numeric',\r\n      hour: withTime ? 'numeric' : undefined,\r\n      minute: withTime ? 'numeric' : undefined,\r\n      hourCycle: 'h23',\r\n    },\r\n  );\r\n});\r\n\r\nexport function formatRelativeHumanDateTime(\r\n  langCode: LangCode = 'en',\r\n  time: number,\r\n) {\r\n  const total = time - Date.now();\r\n  const minutes = Math.floor((total / 1000 / 60) % 60);\r\n  const hours = Math.floor((total / (1000 * 3600)) % 24);\r\n  const days = Math.floor(total / 1000 / 3600 / 24);\r\n\r\n  const rtf = new Intl.RelativeTimeFormat(langCode, {\r\n    localeMatcher: 'best fit',\r\n    numeric: 'always',\r\n    style: 'long',\r\n  });\r\n\r\n  const result: string[] = [];\r\n\r\n  if (days > 0) {\r\n    const [daysPlural, daysValue] = rtf.formatToParts(days, 'day').reverse();\r\n    result.push(`${daysValue.value}${daysPlural.value}`.replace(' ', '\\u00A0'));\r\n  }\r\n  if (hours > 0) {\r\n    const [hoursPlural, hoursValue] = rtf.formatToParts(hours, 'hour').reverse();\r\n    result.push(`${hoursValue.value}${hoursPlural.value}`.replace(' ', '\\u00A0'));\r\n  }\r\n  if (minutes > 0) {\r\n    const [minutesPlural, minutesValue] = rtf.formatToParts(minutes, 'minute').reverse();\r\n    result.push(`${minutesValue.value}${minutesPlural.value}`.replace(' ', '\\u00A0'));\r\n  }\r\n\r\n  return result.join(' ');\r\n}\r\n\r\nexport function formatHumanDay(lang: LangFn, datetime: string | number) {\r\n  if (isToday(datetime)) {\r\n    return lang('Today');\r\n  }\r\n\r\n  if (isYesterday(datetime)) {\r\n    return lang('Yesterday');\r\n  }\r\n\r\n  return formatFullDay(lang.code!, datetime);\r\n}\r\n\r\nexport function formatFullDay(langCode: LangCode, datetime: string | number | Date) {\r\n  const date = new Date(datetime);\r\n  const dayStartAt = getDayStartAt(date);\r\n  const today = getDayStart(new Date());\r\n  const noYear = date.getFullYear() === today.getFullYear();\r\n\r\n  return formatDayToStringWithCache(langCode, dayStartAt, noYear, 'long');\r\n}\r\n\r\nexport function formatShortDay(langCode: LangCode, datetime: string | number | Date, withTime = false, noYear = false) {\r\n  const date = new Date(datetime);\r\n  const dayStartAt = getDayStartAt(date);\r\n  const today = getDayStart(new Date());\r\n  const todayStartAt = getDayStartAt(today);\r\n  const noDate = withTime && dayStartAt === todayStartAt;\r\n  const targetAt = withTime ? getMinuteStart(date).getTime() : dayStartAt;\r\n\r\n  noYear ||= date.getFullYear() === today.getFullYear();\r\n\r\n  return formatDayToStringWithCache(langCode, targetAt, noYear, !noDate && 'short', noDate, withTime);\r\n}\r\n\r\nexport function formatTime(datetime: string | number) {\r\n  const date = new Date(datetime);\r\n\r\n  return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;\r\n}\r\n\r\nexport function getCountDaysToDate(datetime: string | number | Date) {\r\n  const today = new Date();\r\n  const date = datetime instanceof Date ? datetime\r\n    : new Date(datetime);\r\n\r\n  return Math.ceil((date.getTime() - today.getTime()) / DAY);\r\n}\r\n\r\nexport function getDayStart(datetime: number | Date) {\r\n  const date = new Date(datetime);\r\n  date.setHours(0, 0, 0, 0);\r\n  return date;\r\n}\r\n\r\nexport function getDayStartAt(datetime: number | Date) {\r\n  return getDayStart(datetime).getTime();\r\n}\r\n\r\nexport function getMinuteStart(datetime: number | Date) {\r\n  const date = new Date(datetime);\r\n  date.setSeconds(0, 0);\r\n  return date;\r\n}\r\n\r\nfunction isToday(datetime: string | number) {\r\n  return getDayStartAt(new Date()) === getDayStartAt(new Date(datetime));\r\n}\r\n\r\nfunction isYesterday(datetime: string | number) {\r\n  const yesterday = new Date();\r\n  yesterday.setDate(yesterday.getDate() - 1);\r\n\r\n  return getDayStartAt(yesterday) === getDayStartAt(new Date(datetime));\r\n}\r\n","import type { NftItem } from 'tonapi-sdk-js';\r\n\r\nimport type { ApiTonWalletVersion } from '../chains/ton/types';\r\nimport type { ApiTransactionActivity } from './activities';\r\nimport type { ApiParsedPayload } from './payload';\r\nimport type { ApiSseOptions } from './storage';\r\nimport type { ApiUpdatingStatus } from './updates';\r\n\r\nexport type ApiChain = 'ton' | 'tron';\r\nexport type ApiNetwork = 'mainnet' | 'testnet';\r\nexport type ApiLedgerDriver = 'HID' | 'USB';\r\nexport type ApiTokenType = 'lp_token';\r\nexport type ApiDappConnectionType = 'connect' | 'sendTransaction' | 'signData';\r\n\r\nexport interface AccountIdParsed {\r\n  id: number;\r\n  network: ApiNetwork;\r\n}\r\n\r\nexport interface ApiInitArgs {\r\n  isElectron?: boolean;\r\n  isNativeBottomSheet?: boolean;\r\n  isIosApp?: boolean;\r\n  isAndroidApp?: boolean;\r\n  referrer?: string;\r\n  accountIds?: string[];\r\n}\r\n\r\nexport interface ApiToken {\r\n  name: string;\r\n  symbol: string;\r\n  slug: string;\r\n  decimals: number;\r\n  chain: ApiChain;\r\n  type?: ApiTokenType;\r\n  tokenAddress?: string;\r\n  image?: string;\r\n  isPopular?: boolean;\r\n  keywords?: string[];\r\n  cmcSlug?: string;\r\n  color?: string;\r\n  isGaslessEnabled?: boolean;\r\n  isStarsEnabled?: boolean;\r\n  isTiny?: boolean;\r\n  customPayloadApiUrl?: string;\r\n  codeHash?: string;\r\n  /* Means the token is fetched from the backend by default and already includes price\r\n  and other details (`ApiTokenDetails`), so no separate requests are needed. */\r\n  isFromBackend?: boolean;\r\n}\r\n\r\nexport type ApiTokenWithPrice = ApiToken & {\r\n  priceUsd: number;\r\n  percentChange24h: number;\r\n};\r\n\r\nexport type ApiKnownAddresses = Record<string, ApiAddressInfo>;\r\n\r\nexport interface ApiAddressInfo {\r\n  name?: string;\r\n  isScam?: boolean;\r\n  isMemoRequired?: boolean;\r\n}\r\n\r\nexport interface ApiNftSuperCollection {\r\n  id: string;\r\n  name: string;\r\n  icon?: 'gift';\r\n}\r\n\r\nexport type ApiActivityTimestamps = Record<string, number | undefined>;\r\nexport type ApiTransactionType = 'stake' | 'unstake' | 'unstakeRequest'\r\n  | 'callContract' | 'excess' | 'contractDeploy' | 'bounced'\r\n  | 'mint' | 'burn' | 'auctionBid' | 'nftTrade'\r\n  | 'dnsChangeAddress' | 'dnsChangeSite' | 'dnsChangeSubdomains' | 'dnsChangeStorage' | 'dnsDelete' | 'dnsRenew'\r\n  | 'liquidityDeposit' | 'liquidityWithdraw'\r\n  | undefined;\r\n\r\nexport interface ApiTransaction {\r\n  timestamp: number;\r\n  /** The amount to show in the UI (may mismatch the actual attached TON amount) */\r\n  amount: bigint;\r\n  fromAddress: string;\r\n  toAddress: string;\r\n  comment?: string;\r\n  encryptedComment?: string;\r\n  /**\r\n   * The fee to show in the UI (not the same as the network fee). When not 0, should be shown even for incoming\r\n   * transactions. It means that there was a hidden outgoing transaction with the given fee.\r\n   */\r\n  fee: bigint;\r\n  slug: string;\r\n  isIncoming: boolean;\r\n  normalizedAddress: string; // Only for TON now\r\n  /** Trace external message hash normalized. Only for TON. */\r\n  externalMsgHashNorm?: string;\r\n  shouldHide?: boolean;\r\n  type?: ApiTransactionType;\r\n  metadata?: ApiTransactionMetadata;\r\n  nft?: ApiNft;\r\n  /**\r\n   * Transaction confirmation status\r\n   * Both 'pendingTrusted' and 'pending' mean the transaction is awaiting confirmation by the blockchain.\r\n   * - 'pendingTrusted'  awaiting confirmation and trusted (initiated by our app)\r\n   * - 'pending'  awaiting confirmation from an external/unauthenticated source, like TonConnect emulation\r\n   */\r\n  status: 'pending' | 'pendingTrusted' | 'completed' | 'failed';\r\n}\r\n\r\nexport type ApiTransactionMetadata = ApiAddressInfo;\r\n\r\nexport type ApiMtwCardType = 'black' | 'platinum' | 'gold' | 'silver' | 'standard';\r\nexport type ApiMtwCardTextType = 'light' | 'dark';\r\nexport type ApiMtwCardBorderShineType = 'up' | 'down' | 'left' | 'right' | 'radioactive';\r\n\r\nexport interface ApiNftAttribute {\r\n  trait_type: string;\r\n  value: string;\r\n}\r\n\r\nexport interface ApiNftMetadata {\r\n  attributes?: ApiNftAttribute[];\r\n  lottie?: string;\r\n  imageUrl?: string;\r\n  fragmentUrl?: string;\r\n  mtwCardId?: number;\r\n  mtwCardType?: ApiMtwCardType;\r\n  mtwCardTextType?: ApiMtwCardTextType;\r\n  mtwCardBorderShineType?: ApiMtwCardBorderShineType;\r\n}\r\n\r\nexport interface ApiNft {\r\n  index: number;\r\n  ownerAddress?: string;\r\n  name?: string;\r\n  address: string;\r\n  thumbnail: string;\r\n  image: string;\r\n  description?: string;\r\n  collectionName?: string;\r\n  collectionAddress?: string;\r\n  isOnSale: boolean;\r\n  isHidden?: boolean;\r\n  isOnFragment?: boolean;\r\n  isTelegramGift?: boolean;\r\n  isScam?: boolean;\r\n  metadata: ApiNftMetadata;\r\n}\r\n\r\nexport interface ApiDomainData {\r\n  domain: string;\r\n  linkedAddress?: string;\r\n  lastFillUpTime: string;\r\n  nft: NftItem;\r\n}\r\n\r\nexport type ApiHistoryList = Array<[number, number]>;\r\n\r\nexport type ApiStakingType = ApiStakingState['type'];\r\nexport type ApiBackendStakingType = 'nominators' | 'liquid';\r\n\r\ntype BaseStakingState = {\r\n  id: string;\r\n  tokenSlug: string;\r\n  annualYield: number;\r\n  yieldType: ApiYieldType;\r\n  balance: bigint;\r\n  pool: string;\r\n  unstakeRequestAmount?: bigint;\r\n};\r\n\r\nexport type ApiNominatorsStakingState = BaseStakingState & {\r\n  type: 'nominators';\r\n  start: number;\r\n  end: number;\r\n};\r\n\r\nexport type ApiLiquidStakingState = BaseStakingState & {\r\n  type: 'liquid';\r\n  tokenBalance: bigint;\r\n  instantAvailable: bigint;\r\n  start: number;\r\n  end: number;\r\n};\r\n\r\nexport type ApiJettonStakingState = BaseStakingState & {\r\n  type: 'jetton';\r\n  tokenAddress: string;\r\n  unclaimedRewards: bigint;\r\n  stakeWalletAddress: string;\r\n  tokenAmount: bigint;\r\n  period: number;\r\n  tvl: bigint;\r\n  dailyReward: bigint;\r\n  poolWallets?: string[];\r\n};\r\n\r\nexport type ApiEthenaStakingState = BaseStakingState & {\r\n  type: 'ethena';\r\n  tokenBalance: bigint;\r\n  tsUsdeWalletAddress: string;\r\n  unstakeRequestAmount: bigint;\r\n  unlockTime?: number;\r\n  annualYieldStandard?: number;\r\n  annualYieldVerified?: number;\r\n};\r\n\r\nexport type ApiYieldType = 'APY' | 'APR';\r\nexport type ApiStakingState = ApiNominatorsStakingState\r\n  | ApiLiquidStakingState\r\n  | ApiJettonStakingState\r\n  | ApiEthenaStakingState;\r\nexport type ApiToncoinStakingState = ApiNominatorsStakingState | ApiLiquidStakingState;\r\n\r\nexport interface ApiNominatorsPool {\r\n  address: string;\r\n  apy: number;\r\n  start: number;\r\n  end: number;\r\n}\r\n\r\nexport interface ApiBackendStakingState {\r\n  balance: bigint;\r\n  totalProfit: bigint;\r\n  type?: ApiBackendStakingType;\r\n  nominatorsPool: ApiNominatorsPool;\r\n  loyaltyType?: ApiLoyaltyType;\r\n  shouldUseNominators?: boolean;\r\n  stakedAt?: number;\r\n  ethena: {\r\n    /**\r\n     * - undefined  never passed the verification;\r\n     * - true  passed the verification and eligible for the boosted APY;\r\n     * - false  passed the verification and not eligible for the boosted APY;\r\n     */\r\n    isVerified?: boolean;\r\n  };\r\n  liquid?: {\r\n    unstakeRequestAmount?: string;\r\n  };\r\n}\r\n\r\nexport type ApiStakingHistory = {\r\n  timestamp: number;\r\n  profit: string;\r\n}[];\r\n\r\nexport interface ApiDappPermissions {\r\n  isAddressRequired?: boolean;\r\n  isPasswordRequired?: boolean;\r\n}\r\n\r\nexport type ApiDappRequest = {\r\n  url: string | undefined; // `undefined` is a special case for SSE connect request\r\n  isUrlEnsured?: boolean;\r\n  accountId?: string;\r\n  identifier?: string;\r\n  sseOptions?: ApiSseOptions;\r\n};\r\n\r\nexport interface ApiTransferToSign {\r\n  toAddress: string;\r\n  amount: bigint;\r\n  rawPayload?: string;\r\n  payload?: ApiParsedPayload;\r\n  stateInit?: string;\r\n}\r\n\r\nexport interface ApiDappTransfer extends ApiTransferToSign {\r\n  isScam?: boolean;\r\n  /** Whether the transfer should be treated with cautiousness, because its payload is unclear */\r\n  isDangerous: boolean;\r\n  normalizedAddress: string;\r\n  /** The transfer address to show in the UI */\r\n  displayedToAddress: string;\r\n  networkFee: bigint;\r\n}\r\n\r\nexport interface ApiSignedTransfer {\r\n  base64: string;\r\n  seqno: number;\r\n}\r\n\r\n/**\r\n * The `fee` field should contain the final (real) fee, because we want to show the real fee in local transactions\r\n */\r\nexport type ApiLocalTransactionParams = Omit<\r\n  ApiTransactionActivity,\r\n  'timestamp' | 'isIncoming' | 'normalizedAddress' | 'kind' | 'shouldLoadDetails' | 'status'\r\n> & {\r\n  normalizedAddress?: string;\r\n  isIncoming?: boolean;\r\n  status?: ApiTransactionActivity['status'];\r\n};\r\n\r\nexport type ApiBaseCurrency = 'USD' | 'EUR' | 'RUB' | 'CNY' | 'BTC' | 'TON';\r\n\r\n/** 1 USD equivalent to the amount of the other currency, e.g. 1 USD = 0.00000866 BTC */\r\nexport type ApiCurrencyRates = Record<ApiBaseCurrency, string>;\r\n\r\nexport enum ApiLiquidUnstakeMode {\r\n  Default,\r\n  Instant,\r\n  BestRate,\r\n}\r\n\r\nexport type ApiLoyaltyType = 'black' | 'platinum' | 'gold' | 'silver' | 'standard';\r\n\r\nexport type ApiBalanceBySlug = Record<string, bigint>;\r\n\r\nexport type ApiWalletInfo = {\r\n  /** The user-friendly address of this wallet (may differ from the requested address) */\r\n  address: string;\r\n  /** Undefined when the address is not initialized or not a wallet */\r\n  version?: ApiTonWalletVersion;\r\n  balance: bigint;\r\n  isInitialized: boolean;\r\n  seqno: number;\r\n  lastTxId?: string;\r\n  domain?: string;\r\n};\r\n\r\nexport type ApiWalletWithVersionInfo = ApiWalletInfo & Required<Pick<ApiWalletInfo, 'version'>> & {\r\n  /** Whether the wallet is with testnet subwallet ID. `undefined` if the wallet is not a W5 wallet\r\n   Previously we had a bug that caused W5 testnet wallets to be created with mainnet subwallet ID.\r\n   To protect from replay attacks, we need to use specific subwallet ID for testnet wallets.\r\n   For backward compatibility, we need to support both subwallet IDs on testnet.\r\n  */\r\n  isTestnetSubwalletId?: boolean;\r\n};\r\n\r\n// Country codes from ISO-3166-1 spec\r\nexport type ApiCountryCode = 'AF' | 'AX' | 'AL' | 'DZ' | 'AS' | 'AD' | 'AO' | 'AI' | 'AQ' | 'AG' | 'AR'\r\n  | 'AM' | 'AW' | 'AU' | 'AT' | 'AZ' | 'BS' | 'BH' | 'BD' | 'BB' | 'BY' | 'BE' | 'BZ' | 'BJ' | 'BM'\r\n  | 'BT' | 'BO' | 'BQ' | 'BA' | 'BW' | 'BV' | 'BR' | 'IO' | 'BN' | 'BG' | 'BF' | 'BI' | 'CV' | 'KH'\r\n  | 'CM' | 'CA' | 'KY' | 'CF' | 'TD' | 'CL' | 'CN' | 'CX' | 'CC' | 'CO' | 'KM' | 'CG' | 'CD' | 'CK'\r\n  | 'CR' | 'CI' | 'HR' | 'CU' | 'CW' | 'CY' | 'CZ' | 'DK' | 'DJ' | 'DM' | 'DO' | 'EC' | 'EG' | 'SV'\r\n  | 'GQ' | 'ER' | 'EE' | 'SZ' | 'ET' | 'FK' | 'FO' | 'FJ' | 'FI' | 'FR' | 'GF' | 'PF' | 'TF' | 'GA'\r\n  | 'GM' | 'GE' | 'DE' | 'GH' | 'GI' | 'GR' | 'GL' | 'GD' | 'GP' | 'GU' | 'GT' | 'GG' | 'GN' | 'GW'\r\n  | 'GY' | 'HT' | 'HM' | 'VA' | 'HN' | 'HK' | 'HU' | 'IS' | 'IN' | 'ID' | 'IR' | 'IQ' | 'IE' | 'IM'\r\n  | 'IL' | 'IT' | 'JM' | 'JP' | 'JE' | 'JO' | 'KZ' | 'KE' | 'KI' | 'KP' | 'KR' | 'KW' | 'KG' | 'LA'\r\n  | 'LV' | 'LB' | 'LS' | 'LR' | 'LY' | 'LI' | 'LT' | 'LU' | 'MO' | 'MG' | 'MW' | 'MY' | 'MV' | 'ML'\r\n  | 'MT' | 'MH' | 'MQ' | 'MR' | 'MU' | 'YT' | 'MX' | 'FM' | 'MD' | 'MC' | 'MN' | 'ME' | 'MS' | 'MA'\r\n  | 'MZ' | 'MM' | 'NA' | 'NR' | 'NP' | 'NL' | 'NC' | 'NZ' | 'NI' | 'NE' | 'NG' | 'NU' | 'NF' | 'MP'\r\n  | 'NO' | 'OM' | 'PK' | 'PW' | 'PS' | 'PA' | 'PG' | 'PY' | 'PE' | 'PH' | 'PN' | 'PL' | 'PT' | 'PR'\r\n  | 'QA' | 'MK' | 'RO' | 'RU' | 'RW' | 'RE' | 'BL' | 'SH' | 'KN' | 'LC' | 'MF' | 'PM' | 'VC' | 'WS'\r\n  | 'SM' | 'ST' | 'SA' | 'SN' | 'RS' | 'SC' | 'SL' | 'SG' | 'SX' | 'SK' | 'SI' | 'SB' | 'SO' | 'ZA'\r\n  | 'GS' | 'SS' | 'ES' | 'LK' | 'SD' | 'SR' | 'SJ' | 'SE' | 'CH' | 'SY' | 'TW' | 'TJ' | 'TZ' | 'TH'\r\n  | 'TL' | 'TG' | 'TK' | 'TO' | 'TT' | 'TN' | 'TR' | 'TM' | 'TC' | 'TV' | 'UG' | 'UA' | 'AE' | 'GB'\r\n  | 'US' | 'UM' | 'UY' | 'UZ' | 'VU' | 'VE' | 'VN' | 'VG' | 'VI' | 'WF' | 'EH' | 'YE' | 'ZM' | 'ZW';\r\n\r\n/** Each string value can be either an address or a domain name */\r\nexport type ApiImportAddressByChain = Partial<Record<ApiChain, string>>;\r\n\r\nexport type ApiNftMarketplace = 'fragment' | 'getgems';\r\n\r\nexport type OnUpdatingStatusChange = (kind: ApiUpdatingStatus['kind'], isUpdating: boolean) => void;\r\n","export default function generateUniqueId() {\r\n  return Date.now().toString(36) + Math.random().toString(36).slice(2);\r\n}\r\n","const cache = new WeakMap<AnyFunction, Map<string, any>>();\r\n\r\nexport default function withCache<T extends AnyFunction>(fn: T) {\r\n  return (...args: Parameters<T>): ReturnType<T> => {\r\n    let fnCache = cache.get(fn);\r\n    const cacheKey = args.map(String).join('_');\r\n\r\n    if (fnCache) {\r\n      const cached = fnCache.get(cacheKey);\r\n      if (cached) {\r\n        return cached;\r\n      }\r\n    } else {\r\n      fnCache = new Map();\r\n      cache.set(fn, fnCache);\r\n    }\r\n\r\n    const newValue = fn(...args);\r\n\r\n    fnCache.set(cacheKey, newValue);\r\n\r\n    return newValue;\r\n  };\r\n}\r\n","import type { OriginMessageData, WorkerMessageData, WorkerMessageError } from './PostMessageConnector';\r\n\r\nimport { BIGINT_PREFIX } from './bigint';\r\n\r\nexport const UNDEFINED_PREFIX = 'undefined:';\r\n\r\nfunction extensionMessageReplacer(this: any, key: string, value: any) {\r\n  if (value === undefined) {\r\n    return `${UNDEFINED_PREFIX}marker`;\r\n  }\r\n\r\n  // Bigint is replaced by patching `toJSON` method\r\n\r\n  return value;\r\n}\r\n\r\nfunction extensionMessageReviver(this: any, key: string, value: any) {\r\n  // Handle bigint values\r\n  if (typeof value === 'string' && value.startsWith(BIGINT_PREFIX)) {\r\n    return BigInt(value.slice(BIGINT_PREFIX.length));\r\n  }\r\n\r\n  // Handle undefined values\r\n  if (typeof value === 'string' && value.startsWith(UNDEFINED_PREFIX)) {\r\n    return undefined;\r\n  }\r\n\r\n  return value;\r\n}\r\n\r\nexport function encodeExtensionMessage(data: OriginMessageData | WorkerMessageData) {\r\n  return JSON.stringify(data, extensionMessageReplacer);\r\n}\r\n\r\nexport function decodeExtensionMessage<T extends OriginMessageData | WorkerMessageData>(data: string | T): T {\r\n  if (typeof data === 'string') {\r\n    return JSON.parse(data, extensionMessageReviver);\r\n  }\r\n  return data;\r\n}\r\n\r\nexport function encodeError(error: Error): WorkerMessageError {\r\n  if (error instanceof Error) {\r\n    return {\r\n      name: error.name,\r\n      message: error.message,\r\n      stack: error.stack,\r\n    };\r\n  }\r\n\r\n  // Just in case\r\n  return {\r\n    name: 'Error',\r\n    message: String(error),\r\n  };\r\n}\r\n\r\nexport function decodeError({ name, message, stack }: WorkerMessageError): Error {\r\n  const error = new Error(message);\r\n  error.name = name;\r\n  if (stack) {\r\n    error.stack = stack;\r\n  }\r\n  return error;\r\n}\r\n","/* Source https://github.com/toncenter/tonweb/blob/master/src/contract/dns/DnsUtils.js */\r\nimport type { Cell, Slice } from '@ton/core';\r\nimport { Address, Builder } from '@ton/core';\r\n\r\nimport type { TonClient } from './TonClient';\r\n\r\nimport { DnsCategory } from '../constants';\r\nimport { sha256BigInt } from './other';\r\n\r\nexport type DnsResult = Cell | Address | string | undefined;\r\n\r\nexport function dnsCategoryToBigInt(category?: string) {\r\n  if (!category) return 0n; // all categories\r\n  return sha256BigInt(category);\r\n}\r\n\r\nfunction parseSmartContractAddressImpl(cell: Cell, prefix0: number, prefix1: number): Address | undefined {\r\n  const slice = cell.asSlice();\r\n\r\n  const byte0 = slice.loadUint(8);\r\n  const byte1 = slice.loadUint(8);\r\n\r\n  if (byte0 !== prefix0 || byte1 !== prefix1) {\r\n    throw new Error('Invalid dns record value prefix');\r\n  }\r\n\r\n  return parseAddress(slice);\r\n}\r\n\r\nfunction parseSmartContractAddressRecord(cell: Cell): Address | undefined {\r\n  return parseSmartContractAddressImpl(cell, 0x9f, 0xd3);\r\n}\r\n\r\nfunction parseNextResolverRecord(cell: Cell): Address | undefined {\r\n  return parseSmartContractAddressImpl(cell, 0xba, 0x93);\r\n}\r\n\r\nfunction parseStorageBagIdRecord(cell: Cell): string {\r\n  const slice = cell.asSlice();\r\n  const byte0 = slice.loadUint(8);\r\n  const byte1 = slice.loadUint(8);\r\n\r\n  if (byte0 !== 0x74 || byte1 !== 0x73) {\r\n    throw new Error('Invalid dns record value prefix');\r\n  }\r\n\r\n  const buffer = slice.loadBuffer(4);\r\n  return buffer.toString('hex');\r\n}\r\n\r\nfunction parseSiteRecord(cell: Cell): string {\r\n  const slice = cell.asSlice();\r\n  const byte0 = slice.loadUint(8);\r\n  const byte1 = slice.loadUint(8);\r\n\r\n  if (byte0 === 0xad || byte1 === 0x01) {\r\n    return parseAdnlAddressRecord(cell);\r\n  } else {\r\n    return parseStorageBagIdRecord(cell);\r\n  }\r\n}\r\n\r\nfunction parseAdnlAddressRecord(cell: Cell): string {\r\n  const slice = cell.asSlice();\r\n  const byte0 = slice.loadUint(8);\r\n  const byte1 = slice.loadUint(8);\r\n\r\n  if (byte0 !== 0xad || byte1 !== 0x01) {\r\n    throw new Error('Invalid dns record value prefix');\r\n  }\r\n\r\n  const buffer = slice.loadBuffer(4);\r\n  return buffer.toString('hex');\r\n}\r\n\r\nasync function dnsResolveImpl(\r\n  client: TonClient,\r\n  dnsAddress: string,\r\n  rawDomainBytes: Buffer,\r\n  category?: DnsCategory,\r\n  oneStep?: boolean,\r\n): Promise<DnsResult> {\r\n  const len = rawDomainBytes.length * 8;\r\n\r\n  const domainCell = new Builder()\r\n    .storeBuffer(rawDomainBytes)\r\n    .asCell();\r\n\r\n  const categoryBigInt = dnsCategoryToBigInt(category);\r\n  const { stack } = await client.callGetMethod(Address.parse(dnsAddress), 'dnsresolve', [\r\n    { type: 'slice', cell: domainCell },\r\n    { type: 'int', value: categoryBigInt },\r\n  ]);\r\n\r\n  const resultLen = stack.readNumber();\r\n\r\n  let cell: Cell | undefined;\r\n\r\n  try {\r\n    cell = stack.readCell();\r\n  } catch (err) {\r\n    // Do nothing\r\n  }\r\n\r\n  if (resultLen === 0) {\r\n    return undefined; // domain cannot be resolved\r\n  }\r\n\r\n  if (resultLen % 8 !== 0) {\r\n    throw new Error('domain split not at a component boundary');\r\n  }\r\n  // if (rawDomainBytes[resultLen] !== 0) {\r\n  //     throw new Error('domain split not at a component boundary');\r\n  // }\r\n  if (resultLen > len) {\r\n    throw new Error(`invalid response ${resultLen}/${len}`);\r\n  } else if (resultLen === len) {\r\n    if (category === DnsCategory.DnsNextResolver) {\r\n      return cell ? parseNextResolverRecord(cell) : undefined;\r\n    } else if (category === DnsCategory.Wallet) {\r\n      return cell ? parseSmartContractAddressRecord(cell) : undefined;\r\n    } else if (category === DnsCategory.Site) {\r\n      return cell ? parseSiteRecord(cell) : undefined;\r\n    } else if (category === DnsCategory.BagId) {\r\n      return cell ? parseStorageBagIdRecord(cell) : undefined;\r\n    } else {\r\n      return cell;\r\n    }\r\n  } else if (!cell) {\r\n    return undefined; // domain cannot be resolved\r\n  } else {\r\n    const nextAddress = parseNextResolverRecord(cell)!;\r\n    if (oneStep) {\r\n      if (category === DnsCategory.DnsNextResolver) {\r\n        return nextAddress;\r\n      } else {\r\n        return undefined;\r\n      }\r\n    } else {\r\n      return dnsResolveImpl(client, nextAddress.toString(), rawDomainBytes.slice(resultLen / 8), category, false);\r\n    }\r\n  }\r\n}\r\n\r\n/** Encodes the domain in accordance with the TEP-81 standard */\r\nexport function encodeDomain(domain: string): string {\r\n  if (!domain || !domain.length) {\r\n    throw new Error('empty domain');\r\n  }\r\n  if (domain === '.') {\r\n    return '';\r\n  }\r\n\r\n  domain = domain.toLowerCase();\r\n\r\n  for (let i = 0; i < domain.length; i++) {\r\n    if (domain.charCodeAt(i) <= 32) {\r\n      throw new Error('bytes in range 0..32 are not allowed in domain names');\r\n    }\r\n  }\r\n\r\n  for (let i = 0; i < domain.length; i++) {\r\n    const s = domain.substring(i, i + 1);\r\n    for (let c = 127; c <= 159; c++) { // another control codes range\r\n      if (s === String.fromCharCode(c)) {\r\n        throw new Error('bytes in range 127..159 are not allowed in domain names');\r\n      }\r\n    }\r\n  }\r\n\r\n  const arr = domain.split('.');\r\n\r\n  arr.forEach((part) => {\r\n    if (!part.length) {\r\n      throw new Error('domain name cannot have an empty component');\r\n    }\r\n  });\r\n\r\n  return `${arr.reverse().join('\\0')}\\0`;\r\n}\r\n\r\nexport function dnsResolve(\r\n  client: TonClient,\r\n  rootDnsAddress: string,\r\n  domain: string,\r\n  category?: DnsCategory,\r\n  oneStep?: boolean,\r\n): Promise<DnsResult> {\r\n  let rawDomain = encodeDomain(domain);\r\n  if (rawDomain.length < 126) {\r\n    rawDomain = `\\0${rawDomain}`;\r\n  }\r\n\r\n  return dnsResolveImpl(client, rootDnsAddress, Buffer.from(rawDomain), category, oneStep);\r\n}\r\n\r\nfunction parseAddress(slice: Slice): Address | undefined {\r\n  slice.loadUint(3);\r\n  let n = slice.loadUintBig(8);\r\n  if (n > 127n) { // Maybe it's not necessary?\r\n    n -= 256n;\r\n  }\r\n\r\n  const hashPart = slice.loadUintBig(256);\r\n  if (`${n.toString(10)}:${hashPart.toString(16)}` === '0:0') {\r\n    return undefined;\r\n  }\r\n  const s = `${n.toString(10)}:${hashPart.toString(16).padStart(64, '0')}`;\r\n  return Address.parse(s);\r\n}\r\n","import { sha256_sync } from '@ton/crypto';\r\n\r\nexport function sha256BigInt(s: string): bigint {\r\n  return BigInt(`0x${sha256_sync(s).toString('hex')}`);\r\n}\r\n","import type InAppBrowserPostMessageAdapter from './embeddedDappBridge/provider/InAppBrowserPostMessageAdapter';\r\nimport type {\r\n  ApiUpdate,\r\n  CancellableCallback,\r\n  OriginMessageData,\r\n  OriginMessageEvent,\r\n  WorkerMessageData,\r\n} from './PostMessageConnector';\r\n\r\nimport { decodeExtensionMessage, encodeError, encodeExtensionMessage } from './extensionMessageSerializer';\r\nimport { logDebugError } from './logs';\r\n\r\ndeclare const self: WorkerGlobalScope;\r\n\r\nconst callbackState = new Map<string, CancellableCallback>();\r\n\r\ntype ApiConfig =\r\n// eslint-disable-next-line @typescript-eslint/no-redundant-type-constituents\r\n  ((name: string, ...args: any[]) => any | [any, ArrayBuffer[]])\r\n  | Record<string, AnyFunction>;\r\ntype SendToOrigin = (data: WorkerMessageData, transferables?: Transferable[]) => void;\r\n\r\n/**\r\n * Provides functions, defined in this messenger (a window, a worker), to another messenger.\r\n * The other messenger can call the functions using `createConnector`.\r\n */\r\nexport function createPostMessageInterface(\r\n  api: ApiConfig,\r\n  channel?: string,\r\n  target: DedicatedWorkerGlobalScope | Worker | InAppBrowserPostMessageAdapter = self as DedicatedWorkerGlobalScope,\r\n  shouldIgnoreErrors?: boolean,\r\n) {\r\n  function sendToOrigin(data: WorkerMessageData, transferables?: Transferable[]) {\r\n    data.channel = channel;\r\n\r\n    if (transferables) {\r\n      target.postMessage(data, transferables);\r\n    } else {\r\n      target.postMessage(data);\r\n    }\r\n  }\r\n\r\n  if (!shouldIgnoreErrors) {\r\n    handleErrors(sendToOrigin);\r\n  }\r\n\r\n  function handleMessage(e: OriginMessageEvent) {\r\n    if (e.data?.channel === channel) {\r\n      void onMessage(api, e.data, sendToOrigin);\r\n    }\r\n  }\r\n\r\n  // Correct for any target, but TypeScript weirdly complains\r\n  (target as DedicatedWorkerGlobalScope).addEventListener('message', handleMessage);\r\n\r\n  return () => {\r\n    (target as DedicatedWorkerGlobalScope).removeEventListener('message', handleMessage);\r\n  };\r\n}\r\n\r\n/**\r\n * Provides functions, defined in the main window, to an IFrame.\r\n */\r\nexport function createReverseIFrameInterface(\r\n  api: ApiConfig,\r\n  targetOrigin: string,\r\n  target: Window,\r\n  channel?: string,\r\n) {\r\n  function sendToOrigin(data: WorkerMessageData, transferables?: Transferable[]) {\r\n    data.channel = channel;\r\n\r\n    if (transferables) {\r\n      throw new Error('Cannot send `Transferable` to `Window`');\r\n    } else {\r\n      target.postMessage(data, targetOrigin);\r\n    }\r\n  }\r\n\r\n  function handleMessage(e: OriginMessageEvent) {\r\n    if (targetOrigin && e.origin !== targetOrigin) return;\r\n\r\n    if (e.data?.channel === channel) {\r\n      void onMessage(api, e.data, sendToOrigin);\r\n    }\r\n  }\r\n\r\n  window.addEventListener('message', handleMessage);\r\n\r\n  return () => {\r\n    window.removeEventListener('message', handleMessage);\r\n  };\r\n}\r\n\r\n/**\r\n * Provides functions, defined in this extension service worker, to a window.\r\n * The window can call the functions using `createExtensionConnector`.\r\n */\r\nexport function createExtensionInterface(\r\n  portName: string,\r\n  api: ApiConfig,\r\n  channel?: string,\r\n  cleanUpdater?: (onUpdate: (update: ApiUpdate) => void) => void,\r\n  withAutoInit = false,\r\n) {\r\n  chrome.runtime.onConnect.addListener((port) => {\r\n    if (port.name !== portName) {\r\n      return;\r\n    }\r\n\r\n    const url = port.sender?.url;\r\n    const origin = url ? new URL(url).origin : undefined;\r\n\r\n    const dAppUpdater = (update: ApiUpdate) => {\r\n      sendToOrigin({\r\n        type: 'update',\r\n        update,\r\n      });\r\n    };\r\n\r\n    function sendToOrigin(data: WorkerMessageData) {\r\n      data.channel = channel;\r\n      port.postMessage(encodeExtensionMessage(data));\r\n    }\r\n\r\n    handleErrors(sendToOrigin);\r\n\r\n    port.onMessage.addListener((data: OriginMessageData | string) => {\r\n      data = decodeExtensionMessage(data);\r\n      if (data.channel === channel) {\r\n        void onMessage(api, data, sendToOrigin, dAppUpdater, origin);\r\n      }\r\n    });\r\n\r\n    port.onDisconnect.addListener(() => {\r\n      cleanUpdater?.(dAppUpdater);\r\n    });\r\n\r\n    if (withAutoInit) {\r\n      void onMessage(api, { type: 'init', args: [] }, sendToOrigin, dAppUpdater);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Provides functions, defined in this window, to the extension service worker.\r\n * The service worker can call the functions using `createReverseExtensionConnector`.\r\n */\r\nexport function createReverseExtensionInterface(\r\n  portName: string,\r\n  api: ApiConfig,\r\n) {\r\n  let port: chrome.runtime.Port;\r\n\r\n  function sendToServiceWorker(data: WorkerMessageData) {\r\n    port.postMessage(encodeExtensionMessage(data));\r\n  }\r\n\r\n  function connect() {\r\n    port = chrome.runtime.connect({ name: portName });\r\n\r\n    port.onMessage.addListener((data: OriginMessageData | string) => {\r\n      data = decodeExtensionMessage(data);\r\n      void onMessage(api, data, sendToServiceWorker);\r\n    });\r\n\r\n    // For some reason port can suddenly get disconnected\r\n    port.onDisconnect.addListener(() => {\r\n      connect();\r\n    });\r\n  }\r\n\r\n  connect();\r\n}\r\n\r\nasync function onMessage(\r\n  api: ApiConfig,\r\n  data: OriginMessageData,\r\n  sendToOrigin: SendToOrigin,\r\n  onUpdate?: (update: ApiUpdate) => void,\r\n  origin?: string,\r\n) {\r\n  if (!onUpdate) {\r\n    onUpdate = (update: ApiUpdate) => {\r\n      sendToOrigin({\r\n        type: 'update',\r\n        update,\r\n      });\r\n    };\r\n  }\r\n\r\n  switch (data.type) {\r\n    case 'init': {\r\n      const { args } = data;\r\n      const promise = typeof api === 'function'\r\n        ? api('init', origin, onUpdate, ...args)\r\n        : api.init?.(onUpdate, ...args);\r\n      await promise;\r\n\r\n      break;\r\n    }\r\n    case 'callMethod': {\r\n      const {\r\n        messageId, name, args, withCallback,\r\n      } = data;\r\n      try {\r\n        // This method is probably from another worker\r\n        if (typeof api !== 'function' && !api[name]) return;\r\n\r\n        if (messageId && withCallback) {\r\n          const callback = (...callbackArgs: any[]) => {\r\n            const lastArg = callbackArgs[callbackArgs.length - 1];\r\n\r\n            sendToOrigin({\r\n              type: 'methodCallback',\r\n              messageId,\r\n              callbackArgs,\r\n            }, isTransferable(lastArg) ? [lastArg] : undefined);\r\n          };\r\n\r\n          callbackState.set(messageId, callback);\r\n\r\n          args.push(callback as never);\r\n        }\r\n\r\n        const response = typeof api === 'function'\r\n          ? await api(name, origin, ...args)\r\n          : await api[name](...args);\r\n        const { arrayBuffer } = (typeof response === 'object' && response && 'arrayBuffer' in response) || {};\r\n\r\n        if (messageId) {\r\n          sendToOrigin(\r\n            {\r\n              type: 'methodResponse',\r\n              messageId,\r\n              response,\r\n            },\r\n            arrayBuffer ? [arrayBuffer] : undefined,\r\n          );\r\n        }\r\n      } catch (err: any) {\r\n        logDebugError(name, err);\r\n\r\n        if (messageId) {\r\n          sendToOrigin({\r\n            type: 'methodResponse',\r\n            messageId,\r\n            error: encodeError(err),\r\n          });\r\n        }\r\n      }\r\n\r\n      if (messageId) {\r\n        callbackState.delete(messageId);\r\n      }\r\n\r\n      break;\r\n    }\r\n    case 'cancelProgress': {\r\n      const callback = callbackState.get(data.messageId);\r\n      if (callback) {\r\n        callback.isCanceled = true;\r\n      }\r\n\r\n      break;\r\n    }\r\n  }\r\n}\r\n\r\nfunction isTransferable(obj: any) {\r\n  return obj instanceof ArrayBuffer || obj instanceof ImageBitmap;\r\n}\r\n\r\nfunction handleErrors(sendToOrigin: SendToOrigin) {\r\n  self.addEventListener('error', (e) => {\r\n    const error = e.error || { name: 'Error', message: 'Uncaught exception in worker' };\r\n    logDebugError(error.message, e.error);\r\n\r\n    sendToOrigin({\r\n      type: 'unhandledError',\r\n      error: encodeError(error),\r\n    });\r\n  });\r\n\r\n  self.addEventListener('unhandledrejection', (e) => {\r\n    const error = e.reason || { name: 'Error', message: 'Unhandled rejection in worker' };\r\n    logDebugError(error.message, e.reason);\r\n\r\n    sendToOrigin({\r\n      type: 'unhandledError',\r\n      error: encodeError(error),\r\n    });\r\n  });\r\n}\r\n","import { BIGINT_PREFIX } from './bigint';\r\n\r\n// Fixes serialization of objects containing `bigint` values.\r\n// Extracted to a separate file to avoid leaking into Extension Page Script.\r\n// @ts-ignore\r\nBigInt.prototype.toJSON = function toJSON() {\r\n  return `${BIGINT_PREFIX}${this.toString()}`;\r\n};\r\n","import type { AccountIdParsed, ApiNetwork } from '../api/types';\r\nimport type { Account } from '../global/types';\r\n\r\nimport { shortenAddress } from './shortenAddress';\r\n\r\nexport function parseAccountId(accountId: string): AccountIdParsed {\r\n  const parts = accountId.split('-');\r\n  const [id, network = 'mainnet'] = (parts.length === 3 ? [parts[0], parts[2]] : parts) as [string, ApiNetwork];\r\n  return { id: Number(id), network };\r\n}\r\n\r\nexport function buildAccountId(account: AccountIdParsed) {\r\n  const { id, network } = account;\r\n  return `${id}-${network}`;\r\n}\r\n\r\nexport function getMainAccountAddress(byChain: Account['byChain']) {\r\n  return (byChain.ton ?? Object.values(byChain).find(Boolean))?.address;\r\n}\r\n\r\nexport function getAccountTitle(account: Account) {\r\n  return account.title || shortenAddress(getMainAccountAddress(account.byChain) ?? '');\r\n}\r\n","import withCache from './withCache';\r\n\r\nexport const MEANINGFUL_CHAR_LENGTH = 6;\r\nconst FILLER = '';\r\nconst FILLER_LENGTH = FILLER.length;\r\n\r\nexport const shortenAddress = withCache((address: string, shift = MEANINGFUL_CHAR_LENGTH, fromRight = shift) => {\r\n  if (!address) return undefined;\r\n\r\n  if (address.length <= shift + fromRight + FILLER_LENGTH) return address;\r\n\r\n  return `${address.slice(0, shift)}${FILLER}${address.slice(-fromRight)}`;\r\n});\r\n","import type { ApiActivity, ApiTransaction } from '../api/types';\r\nimport type { GlobalState } from '../global/types';\r\n\r\nimport { TRANSACTION_ADDRESS_SHIFT } from '../config';\r\nimport { getIsActivityPendingForUser } from './activities';\r\nimport { shortenAddress } from './shortenAddress';\r\n\r\nconst cache = new Map<string, {\r\n  timestamp: number;\r\n  amount: bigint;\r\n  address: string;\r\n}>();\r\n\r\nfunction getKey(address: string) {\r\n  return shortenAddress(address, TRANSACTION_ADDRESS_SHIFT)!;\r\n}\r\n\r\nfunction addToCache(address: string, amount: bigint, timestamp: number) {\r\n  const key = getKey(address);\r\n\r\n  cache.set(key, {\r\n    address,\r\n    amount,\r\n    timestamp,\r\n  });\r\n}\r\n\r\nfunction getFromCache(address: string) {\r\n  const key = getKey(address);\r\n\r\n  return cache.get(key);\r\n}\r\n\r\nfunction updatePoisoningCache(tx: ApiTransaction) {\r\n  const {\r\n    fromAddress,\r\n    toAddress,\r\n    isIncoming,\r\n    amount,\r\n    timestamp,\r\n  } = tx;\r\n\r\n  const address = isIncoming ? fromAddress : toAddress;\r\n  const cached = getFromCache(address);\r\n\r\n  if (!cached || cached.timestamp > timestamp || (cached.timestamp === timestamp && cached.amount < amount)) {\r\n    addToCache(address, amount, timestamp);\r\n  }\r\n}\r\n\r\nexport function updatePoisoningCacheFromActivities(activities: readonly ApiActivity[]) {\r\n  activities.forEach((activity) => {\r\n    if (activity.kind === 'transaction' && !getIsActivityPendingForUser(activity)) {\r\n      updatePoisoningCache(activity);\r\n    }\r\n  });\r\n}\r\n\r\nexport function updatePoisoningCacheFromGlobalState(global: GlobalState) {\r\n  const { currentAccountId, byAccountId } = global;\r\n\r\n  // Since the `global` can be restored from the cache, it may not contain data for the current account\r\n  if (!currentAccountId || !byAccountId[currentAccountId]) return;\r\n\r\n  const { byId, newestActivitiesBySlug } = byAccountId[currentAccountId].activities || {};\r\n\r\n  if (byId) {\r\n    updatePoisoningCacheFromActivities(Object.values(byId));\r\n  }\r\n\r\n  if (newestActivitiesBySlug) {\r\n    updatePoisoningCacheFromActivities(Object.values(newestActivitiesBySlug));\r\n  }\r\n}\r\n\r\nexport function getIsTransactionWithPoisoning(tx: ApiTransaction) {\r\n  const { fromAddress: address } = tx;\r\n\r\n  const cached = getFromCache(address);\r\n\r\n  return cached && cached.address !== address;\r\n}\r\n\r\nexport function clearPoisoningCache() {\r\n  cache.clear();\r\n}\r\n","import type { ApiChain, ApiNetwork, ApiToken } from '../api/types';\r\n\r\nimport { DEFAULT_CEX_SWAP_SECOND_TOKEN_SLUG, DEFAULT_TRX_SWAP_FIRST_TOKEN_SLUG, TONCOIN, TRX } from '../config';\r\nimport formatTonTransferUrl from './ton/formatTransferUrl';\r\n\r\n/**\r\n * Describes the chain features that distinguish it from other chains in the multichain-polymorphic parts of the code.\r\n */\r\nexport interface ChainConfig {\r\n  /** The blockchain title to show in the UI */\r\n  title: string;\r\n  /** Whether the chain supports domain names that resolve to regular addresses */\r\n  isDnsSupported: boolean;\r\n  /** Whether MyTonWallet supports purchasing crypto in that blockchain with a bank card in Russia */\r\n  canBuyWithCardInRussia: boolean;\r\n  /** Whether the chain supports sending asset transfers with a comment */\r\n  isTransferCommentSupported: boolean;\r\n  /** Whether Ledger support is implemented for this chain */\r\n  isLedgerSupported: boolean;\r\n  /** Regular expression for wallet and contract addresses in the chain */\r\n  addressRegex: RegExp;\r\n  /** The same regular expression but matching any prefix of a valid address */\r\n  addressPrefixRegex: RegExp;\r\n  /** The native token of the chain, i.e. the token that pays the fees */\r\n  nativeToken: ApiToken;\r\n  /** Whether our own backend socket (src/api/common/backendSocket.ts) supports this chain */\r\n  doesBackendSocketSupport: boolean;\r\n  /** A swap configuration used to buy the native token in this chain */\r\n  buySwap: {\r\n    tokenInSlug: string;\r\n    amountIn: bigint;\r\n  };\r\n  /**\r\n   * Configuration of the explorer of the chain.\r\n   * The configuration does not contain data for NFT addresses, they must be configured separately.\r\n   */\r\n  explorer: {\r\n    name: string;\r\n    baseUrl: Record<ApiNetwork, string>;\r\n    /** Use `{base}` as the base URL placeholder and `{address}` as the wallet address placeholder */\r\n    address: string;\r\n    /** Use `{base}` as the base URL placeholder and `{address}` as the token address placeholder */\r\n    token: string;\r\n    /** Use `{base}` as the base URL placeholder and `{hash}` as the transaction hash placeholder */\r\n    transaction: string;\r\n    doConvertHashFromBase64: boolean;\r\n  };\r\n  /** Builds a link to transfer assets in this chain. If not set, the chain won't have the Deposit Link modal. */\r\n  formatTransferUrl?(address: string, amount?: bigint, text?: string, jettonAddress?: string): string;\r\n}\r\n\r\nconst CHAIN_CONFIG: Record<ApiChain, ChainConfig> = {\r\n  ton: {\r\n    title: 'TON',\r\n    isDnsSupported: true,\r\n    canBuyWithCardInRussia: true,\r\n    isTransferCommentSupported: true,\r\n    isLedgerSupported: true,\r\n    addressRegex: /^([-\\w_]{48}|0:[\\da-h]{64})$/i,\r\n    addressPrefixRegex: /^([-\\w_]{1,48}|0:[\\da-h]{0,64})$/i,\r\n    nativeToken: TONCOIN,\r\n    doesBackendSocketSupport: true,\r\n    buySwap: {\r\n      tokenInSlug: DEFAULT_CEX_SWAP_SECOND_TOKEN_SLUG,\r\n      amountIn: 100n,\r\n    },\r\n    explorer: {\r\n      name: 'Tonscan',\r\n      baseUrl: {\r\n        mainnet: 'https://tonscan.org/',\r\n        testnet: 'https://testnet.tonscan.org/',\r\n      },\r\n      address: '{base}address/{address}',\r\n      token: '{base}jetton/{address}',\r\n      transaction: '{base}tx/{hash}',\r\n      doConvertHashFromBase64: true,\r\n    },\r\n    formatTransferUrl: formatTonTransferUrl,\r\n  },\r\n  tron: {\r\n    title: 'TRON',\r\n    isDnsSupported: false,\r\n    canBuyWithCardInRussia: false,\r\n    isTransferCommentSupported: false,\r\n    isLedgerSupported: false,\r\n    addressRegex: /^T[1-9A-HJ-NP-Za-km-z]{33}$/,\r\n    addressPrefixRegex: /^T[1-9A-HJ-NP-Za-km-z]{0,33}$/,\r\n    nativeToken: TRX,\r\n    doesBackendSocketSupport: true,\r\n    buySwap: {\r\n      tokenInSlug: DEFAULT_TRX_SWAP_FIRST_TOKEN_SLUG,\r\n      amountIn: 10n,\r\n    },\r\n    explorer: {\r\n      name: 'Tronscan',\r\n      baseUrl: {\r\n        mainnet: 'https://tronscan.org/#/',\r\n        testnet: 'https://shasta.tronscan.org/#/',\r\n      },\r\n      address: '{base}address/{address}',\r\n      token: '{base}token20/{address}',\r\n      transaction: '{base}transaction/{hash}',\r\n      doConvertHashFromBase64: false,\r\n    },\r\n  },\r\n};\r\n\r\nexport function getChainConfig(chain: ApiChain): ChainConfig {\r\n  return CHAIN_CONFIG[chain];\r\n}\r\n\r\nexport function findChainConfig(chain: string | undefined): ChainConfig | undefined {\r\n  return chain ? CHAIN_CONFIG[chain as ApiChain] : undefined;\r\n}\r\n\r\nexport function getChainTitle(chain: ApiChain) {\r\n  return getChainConfig(chain).title;\r\n}\r\n\r\nexport function getIsSupportedChain(chain?: string): chain is ApiChain {\r\n  return !!findChainConfig(chain);\r\n}\r\n\r\nexport function getSupportedChains() {\r\n  return Object.keys(CHAIN_CONFIG) as (keyof typeof CHAIN_CONFIG)[];\r\n}\r\n\r\nexport function getChainsSupportingLedger(): ApiChain[] {\r\n  return (Object.keys(CHAIN_CONFIG) as (keyof typeof CHAIN_CONFIG)[])\r\n    .filter((chain) => CHAIN_CONFIG[chain].isLedgerSupported);\r\n}\r\n","// https://github.com/toncenter/tonweb/blob/944455da2effaa307a2030d00e19a37e6e94897c/src/utils/index.js#L94-L109\r\nexport default function formatTransferUrl(address: string, amount?: bigint, text?: string, jettonAddress?: string) {\r\n  const url = `ton://transfer/${address}`;\r\n\r\n  const params = [];\r\n\r\n  if (amount) {\r\n    params.push(`amount=${amount}`);\r\n  }\r\n  if (text) {\r\n    params.push(`text=${encodeURIComponent(text)}`);\r\n  }\r\n  if (jettonAddress) {\r\n    params.push(`jetton=${encodeURIComponent(jettonAddress)}`);\r\n  }\r\n\r\n  if (params.length === 0) return url;\r\n\r\n  return `${url}?${params.join('&')}`;\r\n}\r\n","import type { ApiChain, ApiToken, ApiTokenWithPrice } from '../api/types';\r\nimport type { UserToken } from '../global/types';\r\n\r\nimport { PRICELESS_TOKEN_HASHES, STAKED_TOKEN_SLUGS, TONCOIN } from '../config';\r\nimport { findChainConfig, getChainConfig, getSupportedChains } from './chain';\r\nimport { pick } from './iteratees';\r\n\r\nconst chainByNativeSlug = Object.fromEntries(\r\n  getSupportedChains().map((chain) => [getNativeToken(chain).slug, chain]),\r\n);\r\n\r\nexport function getIsNativeToken(slug?: string) {\r\n  return slug ? slug in chainByNativeSlug : false;\r\n}\r\n\r\nexport function getIsTonToken(slug: string, withNative?: boolean) {\r\n  return Boolean(slug.startsWith('ton-') || (withNative && slug === TONCOIN.slug));\r\n}\r\n\r\nexport function getNativeToken(chain: ApiChain): ApiToken {\r\n  return getChainConfig(chain).nativeToken;\r\n}\r\n\r\nexport function findNativeToken(chain: string | undefined): ApiToken | undefined {\r\n  return findChainConfig(chain)?.nativeToken;\r\n}\r\n\r\nexport function getChainBySlug(slug: string) {\r\n  const items = slug.split('-');\r\n  return items.length > 1 ? items[0] as ApiChain : chainByNativeSlug[slug];\r\n}\r\n\r\nexport function getIsServiceToken(token?: ApiToken) {\r\n  const { type, codeHash = '', slug = '' } = token ?? {};\r\n\r\n  return type === 'lp_token'\r\n    || STAKED_TOKEN_SLUGS.has(slug)\r\n    || PRICELESS_TOKEN_HASHES.has(codeHash);\r\n}\r\n\r\nexport function buildUserToken(token: ApiTokenWithPrice | ApiToken): UserToken {\r\n  return {\r\n    ...pick(token, [\r\n      'symbol',\r\n      'slug',\r\n      'name',\r\n      'image',\r\n      'decimals',\r\n      'keywords',\r\n      'chain',\r\n      'tokenAddress',\r\n      'type',\r\n    ]),\r\n    amount: 0n,\r\n    totalValue: '0',\r\n    price: 0,\r\n    priceUsd: 0,\r\n    change24h: 0,\r\n  };\r\n}\r\n","import type {\r\n  ApiActivity,\r\n  ApiChain,\r\n  ApiTransaction,\r\n  ApiTransactionActivity,\r\n  ApiTransactionType,\r\n} from '../../api/types';\r\nimport type { LangFn } from '../langProvider';\r\n\r\nimport { ALL_STAKING_POOLS, BURN_ADDRESS } from '../../config';\r\nimport { extractKey, groupBy, unique } from '../iteratees';\r\nimport { getIsTransactionWithPoisoning } from '../poisoningHash';\r\nimport { getChainBySlug } from '../tokens';\r\n\r\ntype UnusualTxType = 'backend-swap' | 'local' | 'additional';\r\n\r\ntype TranslationTenses = [past: string, present: string, future: string];\r\n\r\nconst TRANSACTION_TYPE_TITLES: Partial<Record<ApiTransactionType & keyof any, TranslationTenses>> = {\r\n  stake: ['Staked', 'Staking', '$stake_action'],\r\n  unstake: ['Unstaked', 'Unstaking', '$unstake_action'],\r\n  unstakeRequest: ['Requested Unstake', 'Requesting Unstake', '$request_unstake_action'],\r\n  callContract: ['Called Contract', 'Calling Contract', '$call_contract_action'],\r\n  excess: ['Excess', 'Excess', 'Excess'],\r\n  contractDeploy: ['Deployed Contract', 'Deploying Contract', '$deploy_contract_action'],\r\n  bounced: ['Bounced', 'Bouncing', '$bounce_action'],\r\n  mint: ['Minted', 'Minting', '$mint_action'],\r\n  burn: ['Burned', 'Burning', '$burn_action'],\r\n  auctionBid: ['NFT Auction Bid', 'Bidding at NFT Auction', 'NFT Auction Bid '],\r\n  dnsChangeAddress: ['Updated Address', 'Updating Address', '$update_address_action'],\r\n  dnsChangeSite: ['Updated Site', 'Updating Site', '$update_site_action'],\r\n  dnsChangeSubdomains: ['Updated Subdomains', 'Updating Subdomains', '$update_subdomains_action'],\r\n  dnsChangeStorage: ['Updated Storage', 'Updating Storage', '$update_storage_action'],\r\n  dnsDelete: ['Deleted Domain Record', 'Deleting Domain Record', '$delete_domain_record_action'],\r\n  dnsRenew: ['Renewed Domain', 'Renewing Domain', '$renew_domain_action'],\r\n  liquidityDeposit: ['Provided Liquidity', 'Providing Liquidity', '$provide_liquidity_action'],\r\n  liquidityWithdraw: ['Withdrawn Liquidity', 'Withdrawing Liquidity', '$withdraw_liquidity_action'],\r\n};\r\n\r\nexport const STAKING_TRANSACTION_TYPES = new Set<ApiTransactionType | undefined>([\r\n  'stake', 'unstake', 'unstakeRequest',\r\n]);\r\n\r\nexport const DNS_TRANSACTION_TYPES = new Set<ApiTransactionType | undefined>([\r\n  'dnsChangeAddress', 'dnsChangeSite', 'dnsChangeStorage', 'dnsChangeSubdomains', 'dnsDelete', 'dnsRenew',\r\n]);\r\n\r\n/**\r\n * Both 'pendingTrusted' and 'pending' mean the activity is awaiting confirmation by the blockchain.\r\n * - 'pendingTrusted'  awaiting confirmation and trusted (initiated by our app).\r\n * - 'pending'  awaiting confirmation from an external/unauthenticated source.\r\n */\r\nconst PENDING_STATUSES = new Set(['pending', 'pendingTrusted']);\r\n\r\nexport function parseTxId(txId: string): {\r\n  hash: string;\r\n  subId?: string;\r\n  type?: UnusualTxType;\r\n} {\r\n  const [hash, subId, type] = txId.split(':') as [string, string | undefined, UnusualTxType | undefined];\r\n  return { hash, type, subId };\r\n}\r\n\r\nexport function getIsTxIdLocal(txId: string) {\r\n  return txId.endsWith(':local');\r\n}\r\n\r\nexport function getIsBackendSwapId(id: string) {\r\n  return id.endsWith(':backend-swap');\r\n}\r\n\r\nexport function buildBackendSwapId(backendId: string) {\r\n  return buildTxId(backendId, undefined, 'backend-swap');\r\n}\r\n\r\nexport function buildLocalTxId(hash: string, subId?: number) {\r\n  return buildTxId(hash, subId, 'local');\r\n}\r\n\r\nexport function buildTxId(hash: string, subId?: number | string, type?: UnusualTxType) {\r\n  if (!type && subId === undefined) return hash;\r\n  if (type === undefined) return `${hash}:${subId}`;\r\n  return `${hash}:${subId ?? ''}:${type}`;\r\n}\r\n\r\n/** Returns the token slugs that the activity is a part of the history of */\r\nexport function getActivityTokenSlugs(activity: ApiActivity): string[] {\r\n  switch (activity.kind) {\r\n    case 'transaction': {\r\n      if (activity.nft) return []; // We don't want NFT activities to get into any token activity list\r\n      return [activity.slug];\r\n    }\r\n    case 'swap': {\r\n      return [activity.from, activity.to];\r\n    }\r\n  }\r\n}\r\n\r\nexport function getActivityChains(activity: ApiActivity): ApiChain[] {\r\n  switch (activity.kind) {\r\n    case 'transaction': {\r\n      return [getChainBySlug(activity.slug)];\r\n    }\r\n    case 'swap': {\r\n      return unique([\r\n        getChainBySlug(activity.from),\r\n        getChainBySlug(activity.to),\r\n      ]);\r\n    }\r\n  }\r\n}\r\n\r\nexport function getIsActivitySuitableForFetchingTimestamp(activity: ApiActivity | undefined) {\r\n  return !!activity\r\n    && !getIsTxIdLocal(activity.id)\r\n    && !getIsBackendSwapId(activity.id)\r\n    && !getIsActivityPending(activity);\r\n}\r\n\r\nexport function getTransactionTitle(\r\n  { type, isIncoming, nft }: ApiTransaction,\r\n  tense: 'past' | 'present' | 'future',\r\n  translate: LangFn,\r\n) {\r\n  const tenseIndex = tense === 'past' ? 0 : tense === 'present' ? 1 : 2;\r\n  let titles: TranslationTenses;\r\n\r\n  if (type === 'nftTrade') {\r\n    titles = isIncoming\r\n      ? ['Sold NFT', 'Selling NFT', '$sell_nft_action']\r\n      : ['Bought NFT', 'Buying NFT', '$buy_nft_action'];\r\n  } else if (type && TRANSACTION_TYPE_TITLES[type]) {\r\n    titles = TRANSACTION_TYPE_TITLES[type];\r\n  } else {\r\n    titles = isIncoming\r\n      ? ['Received', 'Receiving', '$receive_action']\r\n      : ['Sent', 'Sending', '$send_action'];\r\n  }\r\n\r\n  let title = translate(titles[tenseIndex]);\r\n\r\n  if (nft && (!type || type === 'mint' || type === 'burn')) {\r\n    title += ' NFT';\r\n  }\r\n\r\n  return title;\r\n}\r\n\r\nexport function isScamTransaction(transaction: ApiTransaction) {\r\n  return Boolean(transaction.metadata?.isScam)\r\n    || (transaction.isIncoming && getIsTransactionWithPoisoning(transaction));\r\n}\r\n\r\nexport function shouldShowTransactionComment(transaction: ApiTransaction) {\r\n  return Boolean(transaction.comment || transaction.encryptedComment)\r\n    && !STAKING_TRANSACTION_TYPES.has(transaction.type)\r\n    && !isScamTransaction(transaction);\r\n}\r\n\r\nexport function getTransactionAmountDisplayMode({ type, amount, nft }: ApiTransaction) {\r\n  const isPlainTransfer = type === undefined && !nft;\r\n  if (!amount && !isPlainTransfer) {\r\n    return 'hide';\r\n  }\r\n  return type === 'stake' || type === 'unstake'\r\n    ? 'noSign'\r\n    : 'normal';\r\n}\r\n\r\n/** Returns the UI sections where the address should be shown */\r\nexport function shouldShowTransactionAddress(transaction: ApiTransactionActivity): ('list' | 'modal')[] {\r\n  const { type, isIncoming, nft, toAddress, fromAddress, extra } = transaction;\r\n\r\n  if (type === 'nftTrade') {\r\n    return extra?.marketplace ? ['list'] : [];\r\n  }\r\n\r\n  const shouldHide = isOurStakingTransaction(transaction)\r\n    || type === 'burn'\r\n    || (!isIncoming && nft && toAddress === nft.address)\r\n    || (isIncoming && type === 'excess' && fromAddress === BURN_ADDRESS);\r\n\r\n  return shouldHide ? [] : ['list', 'modal'];\r\n}\r\n\r\n/** \"Our\" is staking that can be controlled with MyTonWallet app */\r\nexport function isOurStakingTransaction({ type, isIncoming, toAddress, fromAddress }: ApiTransaction) {\r\n  return STAKING_TRANSACTION_TYPES.has(type) && ALL_STAKING_POOLS.includes(isIncoming ? fromAddress : toAddress);\r\n}\r\n\r\nexport function shouldShowTransactionAnnualYield(transaction: ApiTransaction) {\r\n  return transaction.type === 'stake' && isOurStakingTransaction(transaction);\r\n}\r\n\r\nexport function getIsActivityWithHash(activity: ApiTransactionActivity) {\r\n  return !getIsTxIdLocal(activity.id) || !activity.extra?.withW5Gasless;\r\n}\r\n\r\nexport function getIsActivityPending(activity: ApiActivity) {\r\n  // \"Pending\" is a blockchain term. The activities originated by our backend are never considered pending in this sense.\r\n  return getIsActivityPendingForUser(activity) && !getIsBackendSwapId(activity.id);\r\n}\r\n\r\nexport function getIsActivityPendingForUser(activity: ApiActivity) {\r\n  return PENDING_STATUSES.has(activity.status);\r\n}\r\n\r\n/**\r\n * Sometimes activity ids change. This function finds the new id withing `nextActivities` for each activity in\r\n * `prevActivities`. Currently only local and pending activity ids change, so it's enough to provide only such\r\n * activities in `prevActivities`.\r\n *\r\n * The ids should be unique within each input array. The returned map has previous activity ids as keys and next\r\n * activity ids as values. If the map has no value for a previous id, it means that there is no matching next activity.\r\n * The values may be not unique.\r\n */\r\nexport function getActivityIdReplacements(prevActivities: ApiActivity[], nextActivities: ApiActivity[]) {\r\n  // Each previous activity must fall into either of the groups, otherwise the resulting map will falsely miss previous ids\r\n  const prevLocalActivities: ApiActivity[] = [];\r\n  const prevChainActivities: ApiActivity[] = [];\r\n\r\n  for (const activity of prevActivities) {\r\n    const group = getIsTxIdLocal(activity.id) ? prevLocalActivities : prevChainActivities;\r\n    group.push(activity);\r\n  }\r\n\r\n  return {\r\n    ...getLocalActivityIdReplacements(prevLocalActivities, nextActivities),\r\n    ...getChainActivityIdReplacements(prevChainActivities, nextActivities),\r\n  };\r\n}\r\n\r\n/** Replaces local activity ids. See `getActivityIdReplacements` for more details. */\r\nfunction getLocalActivityIdReplacements(prevLocalActivities: ApiActivity[], nextActivities: ApiActivity[]) {\r\n  const idReplacements: Record<string, string> = {};\r\n\r\n  if (!prevLocalActivities.length) {\r\n    return idReplacements;\r\n  }\r\n\r\n  const nextActivityIds = new Set(extractKey(nextActivities, 'id'));\r\n  const nextChainActivities = nextActivities.filter((activity) => !getIsTxIdLocal(activity.id));\r\n\r\n  for (const localActivity of prevLocalActivities) {\r\n    const { id: prevId } = localActivity;\r\n\r\n    // Try a direct id match\r\n    if (nextActivityIds.has(prevId)) {\r\n      idReplacements[prevId] = prevId;\r\n      continue;\r\n    }\r\n\r\n    // Otherwise, try to find a match by a heuristic\r\n    const chainActivity = nextChainActivities.find((chainActivity) => {\r\n      return doesLocalActivityMatch(localActivity, chainActivity);\r\n    });\r\n    if (chainActivity) {\r\n      idReplacements[prevId] = chainActivity.id;\r\n    }\r\n\r\n    // Otherwise, there is no match\r\n  }\r\n\r\n  return idReplacements;\r\n}\r\n\r\n/** Replaces chain (i.e. not local) activity ids. See `getActivityIdReplacements` for more details. */\r\nfunction getChainActivityIdReplacements(prevActivities: ApiActivity[], nextActivities: ApiActivity[]) {\r\n  const idReplacements: Record<string, string> = {};\r\n\r\n  if (!prevActivities.length) {\r\n    return idReplacements;\r\n  }\r\n\r\n  const nextActivityIds = new Set(extractKey(nextActivities, 'id'));\r\n  const nextActivitiesByMessageHash = groupBy(nextActivities, 'externalMsgHashNorm');\r\n\r\n  for (const { id: prevId, externalMsgHashNorm } of prevActivities) {\r\n    // Try a direct id match\r\n    if (nextActivityIds.has(prevId)) {\r\n      idReplacements[prevId] = prevId;\r\n      continue;\r\n    }\r\n\r\n    // Otherwise, match by the message hash\r\n    if (externalMsgHashNorm) {\r\n      const nextSubActivities = nextActivitiesByMessageHash[externalMsgHashNorm];\r\n      if (nextSubActivities?.length) {\r\n        idReplacements[prevId] = nextSubActivities[0].id;\r\n\r\n        // Leaving 1 activity in each group to ensure there is a match for the further prev activities with the same hash\r\n        if (nextSubActivities.length > 1) {\r\n          nextSubActivities.shift();\r\n        }\r\n      }\r\n    }\r\n\r\n    // Otherwise, there is no match\r\n  }\r\n\r\n  return idReplacements;\r\n}\r\n\r\n/** Decides whether the local activity matches the activity from the blockchain */\r\nexport function doesLocalActivityMatch(localActivity: ApiActivity, chainActivity: ApiActivity) {\r\n  if (localActivity.extra?.withW5Gasless) {\r\n    if (localActivity.kind === 'transaction' && chainActivity.kind === 'transaction') {\r\n      return !chainActivity.isIncoming && localActivity.normalizedAddress === chainActivity.normalizedAddress\r\n        && localActivity.amount === chainActivity.amount\r\n        && localActivity.slug === chainActivity.slug;\r\n    } else if (localActivity.kind === 'swap' && chainActivity.kind === 'swap') {\r\n      return localActivity.from === chainActivity.from\r\n        && localActivity.to === chainActivity.to\r\n        && localActivity.fromAmount === chainActivity.fromAmount;\r\n    }\r\n  }\r\n\r\n  if (localActivity.externalMsgHashNorm) {\r\n    return localActivity.externalMsgHashNorm === chainActivity.externalMsgHashNorm && !chainActivity.shouldHide;\r\n  }\r\n\r\n  return parseTxId(localActivity.id).hash === parseTxId(chainActivity.id).hash;\r\n}\r\n","import type { ApiActivity } from '../../api/types';\r\n\r\nimport { mergeSortedArrays, unique, uniqueByKey } from '../iteratees';\r\nimport { logDebugError } from '../logs';\r\nimport { getIsActivityPending } from './index';\r\n\r\nfunction compareActivities(a: ApiActivity, b: ApiActivity, isAsc = false) {\r\n  // The activity sorting is tuned to match the Toncenter API sorting as close as possible.\r\n  // Putting the pending activities first, because when they get confirmed, their timestamp gets bigger than any current\r\n  // confirmed activity timestamp. This reduces the movement in the activity list.\r\n  let value = (getIsActivityPending(a) ? 1 : 0) - (getIsActivityPending(b) ? 1 : 0);\r\n  if (value === 0) {\r\n    value = a.timestamp - b.timestamp;\r\n    if (value === 0) {\r\n      value = a.id > b.id ? 1 : a.id < b.id ? -1 : 0;\r\n    }\r\n  }\r\n  return isAsc ? value : -value;\r\n}\r\n\r\n/**\r\n * Makes sure `activities` are suitable for `mergeSortedActivities` input.\r\n * Use the `mergeSortedActivities` function instead when possible.\r\n */\r\nexport function sortActivities(activities: readonly ApiActivity[], isAsc?: boolean) {\r\n  const uniqueActivities = uniqueByKey(activities, 'id');\r\n  return uniqueActivities.sort((a1, a2) => compareActivities(a1, a2, isAsc));\r\n}\r\n\r\n/**\r\n * Makes sure `ids` are suitable for `mergeSortedActivityIds` input.\r\n * Use the `mergeSortedActivityIds` function instead when possible.\r\n */\r\nfunction sortActivityIds(activityById: Record<string, ApiActivity>, ids: readonly string[], isAsc?: boolean) {\r\n  const uniqueIds = unique(ids);\r\n  return uniqueIds.sort((id1, id2) => compareActivities(activityById[id1], activityById[id2], isAsc));\r\n}\r\n\r\nexport function mergeSortedActivities(...lists: (readonly ApiActivity[])[]) {\r\n  // It's hard to make sure the input is sorted, so we check and sort just in case.\r\n  // Otherwise, there may be unwanted duplicates in the returned array.\r\n  for (let i = 0; i < lists.length; i++) {\r\n    if (!areActivitiesSortedAndUnique(lists[i])) {\r\n      logDebugError(`Activity list ${i} is unsorted or has duplicates`, { stack: new Error().stack });\r\n      lists[i] = sortActivities(lists[i]);\r\n    }\r\n  }\r\n\r\n  return mergeSortedArrays(lists, (a1, a2) => compareActivities(a1, a2), true);\r\n}\r\n\r\nexport function mergeSortedActivityIds(activityById: Record<string, ApiActivity>, ...lists: (readonly string[])[]) {\r\n  // It's hard to make sure the input is sorted, so we check and sort just in case.\r\n  // Otherwise, there may be unwanted duplicates in the returned array.\r\n  for (let i = 0; i < lists.length; i++) {\r\n    if (!areActivityIdsSortedAndUnique(activityById, lists[i])) {\r\n      logDebugError(`Activity id list ${i} is unsorted or has duplicates`, { stack: new Error().stack });\r\n      lists[i] = sortActivityIds(activityById, lists[i]);\r\n    }\r\n  }\r\n\r\n  return mergeSortedArrays(\r\n    lists,\r\n    (id1, id2) => compareActivities(activityById[id1], activityById[id2]),\r\n    true,\r\n  );\r\n}\r\n\r\nexport function mergeSortedActivitiesToMaxTime(...lists: (readonly ApiActivity[])[]) {\r\n  const fromTimestamp = Math.max(\r\n    ...lists.map((activities) => activities.length ? activities[activities.length - 1].timestamp : -Infinity),\r\n  );\r\n\r\n  const filterPredicate = ({ timestamp }: ApiActivity) => timestamp >= fromTimestamp;\r\n\r\n  return mergeSortedActivities(\r\n    ...lists.map((activities) => activities.filter(filterPredicate)),\r\n  );\r\n}\r\n\r\nexport function mergeSortedActivityIdsToMaxTime(\r\n  activityById: Record<string, ApiActivity>,\r\n  ...lists: (readonly string[])[]\r\n) {\r\n  const fromTimestamp = Math.max(\r\n    ...lists.map((ids) => ids.length ? activityById[ids[ids.length - 1]].timestamp : -Infinity),\r\n  );\r\n\r\n  const filterPredicate = (id: string) => activityById[id].timestamp >= fromTimestamp;\r\n\r\n  return mergeSortedActivityIds(\r\n    activityById,\r\n    ...lists.map((ids) => ids.filter(filterPredicate)),\r\n  );\r\n}\r\n\r\nexport function areActivitiesSortedAndUnique(activities: readonly ApiActivity[], isAsc?: boolean) {\r\n  for (let i = 1; i < activities.length; i++) {\r\n    if (compareActivities(activities[i - 1], activities[i], isAsc) >= 0) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\nfunction areActivityIdsSortedAndUnique(\r\n  activityById: Record<string, ApiActivity>,\r\n  ids: readonly string[],\r\n  isAsc?: boolean,\r\n) {\r\n  for (let i = 1; i < ids.length; i++) {\r\n    if (compareActivities(activityById[ids[i - 1]], activityById[ids[i]], isAsc) >= 0) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  return true;\r\n}\r\n","export function crc32(data: string): number {\r\n  return crc32FromBytes(Buffer.from(data));\r\n}\r\n\r\nexport function crc32FromBytes(bytes: Uint8Array): number {\r\n  // The implementation is based on https://stackoverflow.com/a/18639999/1118709\r\n  const crc32Table = makeCrc32Table();\r\n  let crc = 0 ^ -1;\r\n\r\n  for (let i = 0; i < bytes.length; i++) {\r\n    crc = (crc >>> 8) ^ crc32Table[(crc ^ bytes[i]) & 0xFF];\r\n  }\r\n\r\n  return (crc ^ -1) >>> 0;\r\n}\r\n\r\nlet crc32Table: Uint32Array;\r\n\r\nfunction makeCrc32Table() {\r\n  if (!crc32Table) {\r\n    let c: number;\r\n    crc32Table = new Uint32Array(256);\r\n    for (let n = 0; n < 256; n++) {\r\n      c = n;\r\n      for (let k = 0; k < 8; k++) {\r\n        c = c & 1 ? 0xEDB88320 ^ (c >>> 1) : c >>> 1;\r\n      }\r\n      crc32Table[n] = c;\r\n    }\r\n  }\r\n\r\n  return crc32Table;\r\n}\r\n","import { Address, beginCell, Cell } from '@ton/core';\r\nimport type { SignDataPayload, SignDataPayloadCell } from '@tonconnect/protocol';\r\nimport nacl from 'tweetnacl';\r\n\r\nimport type { ApiTonConnectProof } from './types';\r\n\r\nimport { crc32 } from '../../util/crcHash';\r\nimport { encodeDomain } from '../chains/ton/util/dns';\r\nimport { sha256 } from '../common/utils';\r\n\r\nexport async function signTonProofWithPrivateKey(\r\n  walletAddress: string | Address,\r\n  privateKey: Uint8Array,\r\n  proof: ApiTonConnectProof,\r\n): Promise<Uint8Array> {\r\n  const { timestamp, domain, payload } = proof;\r\n  const address = walletAddress instanceof Address ? walletAddress : Address.parse(walletAddress);\r\n\r\n  const messageBuffer = Buffer.concat([\r\n    Buffer.from('ton-proof-item-v2/'),\r\n    makeAddressBuffer(address),\r\n    makeBytesWithLengthBuffer(Buffer.from(domain), false),\r\n    makeTimestampBuffer(timestamp, false),\r\n    Buffer.from(payload),\r\n  ]);\r\n\r\n  const bufferToSign = Buffer.concat([\r\n    Buffer.from([0xff, 0xff]),\r\n    Buffer.from('ton-connect'),\r\n    Buffer.from(await sha256(messageBuffer)),\r\n  ]);\r\n\r\n  return nacl.sign.detached(\r\n    new Uint8Array(await sha256(bufferToSign)),\r\n    privateKey,\r\n  );\r\n}\r\n\r\n/**\r\n * See https://docs.tonconsole.com/academy/sign-data#how-the-signature-is-built for more details\r\n */\r\nexport async function signDataWithPrivateKey(\r\n  walletAddress: string | Address,\r\n  timestamp: number, // Unix seconds, should be the current time\r\n  domain: string,\r\n  payload: SignDataPayload,\r\n  privateKey: Uint8Array,\r\n): Promise<Uint8Array> {\r\n  const address = walletAddress instanceof Address ? walletAddress : Address.parse(walletAddress);\r\n\r\n  const hash = await (payload.type === 'cell'\r\n    ? createCellDataHash(address, timestamp, domain, payload)\r\n    : createTextDataHash(address, timestamp, domain, payload));\r\n\r\n  return nacl.sign.detached(hash, privateKey);\r\n}\r\n\r\n// https://docs.tonconsole.com/academy/sign-data#for-cell\r\nfunction createCellDataHash(\r\n  walletAddress: Address,\r\n  timestamp: number,\r\n  domain: string,\r\n  payload: SignDataPayloadCell,\r\n) {\r\n  const message = beginCell()\r\n    .storeUint(0x75569022, 32)\r\n    .storeUint(crc32(payload.schema), 32)\r\n    .storeUint(timestamp, 64)\r\n    .storeAddress(walletAddress)\r\n    .storeStringRefTail(encodeDomain(domain))\r\n    .storeRef(Cell.fromBase64(payload.cell))\r\n    .endCell();\r\n\r\n  const hashBuffer = message.hash();\r\n  return new Uint8Array(hashBuffer.buffer, hashBuffer.byteOffset, hashBuffer.byteLength);\r\n}\r\n\r\n// https://docs.tonconsole.com/academy/sign-data#for-text-and-binary\r\nasync function createTextDataHash(\r\n  walletAddress: Address,\r\n  timestamp: number,\r\n  domain: string,\r\n  payload: Exclude<SignDataPayload, SignDataPayloadCell>,\r\n) {\r\n  const message = Buffer.concat([\r\n    Buffer.from([0xff, 0xff]),\r\n    Buffer.from('ton-connect/sign-data/'),\r\n    makeAddressBuffer(walletAddress),\r\n    makeBytesWithLengthBuffer(Buffer.from(domain), true),\r\n    makeTimestampBuffer(timestamp, true),\r\n    Buffer.from(payload.type === 'text' ? 'txt' : 'bin'),\r\n    makeBytesWithLengthBuffer(\r\n      payload.type === 'text'\r\n        ? Buffer.from(payload.text, 'utf8')\r\n        : Buffer.from(payload.bytes, 'base64'),\r\n      true,\r\n    ),\r\n  ]);\r\n\r\n  return new Uint8Array(await sha256(message));\r\n}\r\n\r\nfunction makeAddressBuffer(address: Address) {\r\n  const workChainLength = 4;\r\n  const addressBuffer = Buffer.allocUnsafe(workChainLength + address.hash.length);\r\n  addressBuffer.writeInt32BE(address.workChain);\r\n  address.hash.copy(addressBuffer, workChainLength);\r\n  return addressBuffer;\r\n}\r\n\r\nfunction makeBytesWithLengthBuffer(bytes: Buffer, isBigEndian: boolean) {\r\n  const lengthLength = 4;\r\n  const buffer = Buffer.allocUnsafe(lengthLength + bytes.length);\r\n  if (isBigEndian) {\r\n    buffer.writeInt32BE(bytes.length);\r\n  } else {\r\n    buffer.writeInt32LE(bytes.length);\r\n  }\r\n  bytes.copy(buffer, lengthLength);\r\n  return buffer;\r\n}\r\n\r\nfunction makeTimestampBuffer(unixSeconds: number, isBigEndian: boolean) {\r\n  const timestampBuffer = Buffer.allocUnsafe(8);\r\n  const timestamp = BigInt(unixSeconds);\r\n  if (isBigEndian) {\r\n    timestampBuffer.writeBigInt64BE(timestamp);\r\n  } else {\r\n    timestampBuffer.writeBigInt64LE(timestamp);\r\n  }\r\n  return timestampBuffer;\r\n}\r\n","import createHmac from 'create-hmac';\r\nimport * as nacl from 'tweetnacl';\r\n\r\ntype Hex = string;\r\ntype Path = string;\r\n\r\ntype Keys = {\r\n  key: Buffer;\r\n  chainCode: Buffer;\r\n};\r\n\r\nconst ED25519_CURVE = 'ed25519 seed';\r\nconst HARDENED_OFFSET = 0x80000000;\r\n\r\nconst pathRegex = /^m(\\/[0-9]+')+$/;\r\nfunction replaceDerive(val: string) {\r\n  return val.replace('\\'', '');\r\n}\r\n\r\nexport const getMasterKeyFromSeed = (seed: Hex): Keys => {\r\n  const hmac = createHmac('sha512', ED25519_CURVE);\r\n  const I = hmac.update(Buffer.from(seed, 'hex')).digest();\r\n  const IL = I.slice(0, 32);\r\n  const IR = I.slice(32);\r\n  return {\r\n    key: IL,\r\n    chainCode: IR,\r\n  };\r\n};\r\n\r\nexport const CKDPriv = ({ key, chainCode }: Keys, index: number): Keys => {\r\n  const indexBuffer = Buffer.allocUnsafe(4);\r\n  indexBuffer.writeUInt32BE(index, 0);\r\n\r\n  const data = Buffer.concat([Buffer.alloc(1, 0), key, indexBuffer]);\r\n\r\n  const I = createHmac('sha512', chainCode)\r\n    .update(data)\r\n    .digest();\r\n  const IL = I.slice(0, 32);\r\n  const IR = I.slice(32);\r\n  return {\r\n    key: IL,\r\n    chainCode: IR,\r\n  };\r\n};\r\n\r\nexport const getPublicKey = (privateKey: Buffer, withZeroByte = true): Buffer => {\r\n  const keyPair = nacl.sign.keyPair.fromSeed(privateKey);\r\n  const signPk = keyPair.secretKey.subarray(32);\r\n  const zero = Buffer.alloc(1, 0);\r\n  return withZeroByte\r\n    ? Buffer.concat([zero, Buffer.from(signPk)])\r\n    : Buffer.from(signPk);\r\n};\r\n\r\nexport const isValidPath = (path: string): boolean => {\r\n  if (!pathRegex.test(path)) {\r\n    return false;\r\n  }\r\n  return !path\r\n    .split('/')\r\n    .slice(1)\r\n    .map(replaceDerive)\r\n\r\n    .some(isNaN as any);\r\n};\r\n\r\nexport const derivePath = (path: Path, seed: Hex, offset = HARDENED_OFFSET): Keys => {\r\n  if (!isValidPath(path)) {\r\n    throw new Error('Invalid derivation path');\r\n  }\r\n\r\n  const { key, chainCode } = getMasterKeyFromSeed(seed);\r\n  const segments = path\r\n    .split('/')\r\n    .slice(1)\r\n    .map(replaceDerive)\r\n    .map((el) => parseInt(el, 10));\r\n\r\n  return segments.reduce(\r\n    (parentKeys, segment) => CKDPriv(parentKeys, segment + offset),\r\n    { key, chainCode },\r\n  );\r\n};\r\n","import { PRIVATE_KEY_HEX_LENGTH } from '../config';\r\n\r\nexport default function isMnemonicPrivateKey(mnemonic: string[]) {\r\n  return mnemonic.length === 1 && mnemonic[0].length === PRIVATE_KEY_HEX_LENGTH;\r\n}\r\n","export enum StorageType {\r\n  IndexedDb,\r\n  LocalStorage,\r\n  ExtensionLocal,\r\n  CapacitorStorage,\r\n}\r\n\r\nexport interface Storage {\r\n  getItem(name: StorageKey, force?: boolean): Promise<any>;\r\n\r\n  setItem(name: StorageKey, value: any): Promise<void>;\r\n\r\n  removeItem(name: StorageKey): Promise<void>;\r\n\r\n  clear(): Promise<void>;\r\n\r\n  getAll?(): Promise<AnyLiteral>;\r\n\r\n  setMany?(items: AnyLiteral): Promise<void>;\r\n\r\n  getMany?(keys: string[]): Promise<AnyLiteral>;\r\n}\r\n\r\nexport type StorageKey = 'accounts'\r\n  | 'stateVersion'\r\n  | 'currentAccountId'\r\n  | 'clientId'\r\n  | 'referrer'\r\n  // For extension\r\n  | 'dapps'\r\n  | 'dappMethods:lastAccountId'\r\n  | 'windowId'\r\n  | 'windowState'\r\n  | 'isTonMagicEnabled'\r\n  | 'isTonProxyEnabled'\r\n  | 'isDeeplinkHookEnabled'\r\n  // For TonConnect SSE\r\n  | 'sseLastEventId';\r\n","import type { Storage, StorageKey } from './types';\r\n\r\nimport { bigintReviver } from '../../util/bigint';\r\nimport { callWindow } from '../../util/windowProvider/connector';\r\nimport { getEnvironment } from '../environment';\r\n\r\nlet cache: AnyLiteral = {};\r\n\r\nconst storage: Storage & {\r\n  getKeys: () => Promise<string[] | undefined>;\r\n} = {\r\n  async getItem(key: StorageKey, force?: boolean) {\r\n    if (getEnvironment().isAndroidApp && key in cache && !force) {\r\n      return cache[key];\r\n    }\r\n\r\n    const result = await callWindow('capacitorStorageGetItem', key);\r\n    const value = result ? JSON.parse(result, bigintReviver) : undefined;\r\n\r\n    if (getEnvironment().isAndroidApp) {\r\n      if (value === undefined) {\r\n        delete cache[key];\r\n      } else {\r\n        cache[key] = value;\r\n      }\r\n    }\r\n\r\n    return value;\r\n  },\r\n\r\n  async setItem(key: StorageKey, value: any) {\r\n    await callWindow('capacitorStorageSetItem', key, JSON.stringify(value));\r\n\r\n    if (getEnvironment().isAndroidApp) {\r\n      cache[key] = value;\r\n    }\r\n  },\r\n\r\n  async removeItem(key: StorageKey) {\r\n    await callWindow('capacitorStorageRemoveItem', key);\r\n\r\n    if (getEnvironment().isAndroidApp) {\r\n      delete cache[key];\r\n    }\r\n  },\r\n\r\n  async clear() {\r\n    await callWindow('capacitorStorageClear');\r\n\r\n    if (getEnvironment().isAndroidApp) {\r\n      cache = {};\r\n    }\r\n  },\r\n\r\n  async getKeys() {\r\n    const result = await callWindow('capacitorStorageKeys');\r\n\r\n    return result?.value;\r\n  },\r\n};\r\n\r\nexport default storage;\r\n","import type { Storage } from './types';\r\n\r\nimport { IS_EXTENSION } from '../../config';\r\n\r\nconst storage = IS_EXTENSION ? self.chrome.storage.local : undefined;\r\n\r\nexport default ((storage && {\r\n  getItem: async (key) => (await storage.get(key))?.[key],\r\n  setItem: (key, value) => storage.set({ [key]: value }),\r\n  removeItem: storage.remove.bind(storage),\r\n  clear: storage.clear.bind(storage),\r\n  getAll: storage.get.bind(storage),\r\n  setMany: storage.set.bind(storage),\r\n  getMany: storage.get.bind(storage),\r\n}) || {}) as Storage;\r\n","// src/API/storage/idb.ts\r\nimport * as idb from 'idb-keyval';\r\n\r\nimport type { Storage, StorageKey } from './types';\r\n\r\nimport { INDEXED_DB_NAME, INDEXED_DB_STORE_NAME } from '../../config';\r\nimport { fromKeyValueArrays } from '../../util/iteratees';\r\n\r\nconst store = idb.createStore(INDEXED_DB_NAME, INDEXED_DB_STORE_NAME);\r\n\r\nexport default {\r\n  getItem: (name: StorageKey) => idb.get(name, store),\r\n  setItem: (name: StorageKey, value: any) => idb.set(name, value, store),\r\n  removeItem: (name: StorageKey) => idb.del(name, store),\r\n  clear: () => idb.clear(store),\r\n  getAll: async () => {\r\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion\r\n    const keys = (await idb.keys(store)) as string[];\r\n    const values = await idb.getMany(keys, store);\r\n    return fromKeyValueArrays(keys, values);\r\n  },\r\n  getMany: async (keys) => {\r\n    const values = await idb.getMany(keys, store);\r\n    return fromKeyValueArrays(keys, values);\r\n  },\r\n  setMany: (items) => {\r\n    return idb.setMany(Object.entries(items), store);\r\n  },\r\n} as Storage;\r\n","import type { Storage, StorageKey } from './types';\r\n\r\nimport { pick } from '../../util/iteratees';\r\nimport { callWindow } from '../../util/windowProvider/connector';\r\n\r\nfunction withPromise(fn: AnyFunction) {\r\n  return (...args: any) => Promise.resolve(fn(...args));\r\n}\r\n\r\nconst storage: Storage = (typeof localStorage === 'object' ? {\r\n  getItem: withPromise(localStorage.getItem),\r\n  setItem: withPromise(localStorage.setItem),\r\n  removeItem: withPromise(localStorage.removeItem),\r\n  clear: withPromise(localStorage.clear),\r\n  getAll: withPromise(() => ({ ...localStorage })),\r\n  getMany: withPromise((keys: string[]) => pick(localStorage, keys)),\r\n  setMany: withPromise((items: AnyLiteral) => {\r\n    Object.assign(localStorage, items);\r\n  }),\r\n} : {\r\n  getItem(key: StorageKey) {\r\n    return callWindow('localStorageGetItem', key);\r\n  },\r\n  setItem(key: StorageKey, value: any) {\r\n    return callWindow('localStorageSetItem', key, value);\r\n  },\r\n  removeItem(key: StorageKey) {\r\n    return callWindow('localStorageRemoveItem', key);\r\n  },\r\n  clear() {\r\n    return callWindow('localStorageClear');\r\n  },\r\n  getAll() {\r\n    return callWindow('localStorageGetAll');\r\n  },\r\n  getMany(keys: StorageKey[]) {\r\n    return callWindow('localStorageGetMany', keys);\r\n  },\r\n  setMany(items: AnyLiteral) {\r\n    return callWindow('localStorageSetMany', items);\r\n  },\r\n});\r\n\r\nexport default storage;\r\n","import { StorageType } from './types';\r\n\r\nimport { IS_CAPACITOR, IS_EXTENSION } from '../../config';\r\nimport capacitorStorage from './capacitorStorage';\r\nimport extensionStorage from './extension';\r\nimport idb from './idb';\r\nimport localStorage from './localStorage';\r\n\r\nexport const storage = IS_EXTENSION ? extensionStorage : IS_CAPACITOR ? capacitorStorage : idb;\r\n\r\nexport default {\r\n  [StorageType.IndexedDb]: idb,\r\n  [StorageType.LocalStorage]: localStorage,\r\n  [StorageType.ExtensionLocal]: extensionStorage,\r\n  [StorageType.CapacitorStorage]: capacitorStorage,\r\n};\r\n","import type { AccountChain } from '../../global/types';\r\nimport type { StorageKey } from '../storages/types';\r\nimport type {\r\n  ApiAccountAny,\r\n  ApiAccountWithChain,\r\n  ApiAccountWithMnemonic,\r\n  ApiChain,\r\n  ApiNetwork,\r\n  ApiWalletByChain,\r\n} from '../types';\r\n\r\nimport { buildAccountId, parseAccountId } from '../../util/account';\r\nimport { mapValues } from '../../util/iteratees';\r\nimport { storage } from '../storages';\r\n\r\nconst MIN_ACCOUNT_NUMBER = 0;\r\n\r\nexport let loginResolve: AnyFunction;\r\nconst loginPromise = new Promise<void>((resolve) => {\r\n  loginResolve = resolve;\r\n});\r\n\r\nexport async function getAccountIds(): Promise<string[]> {\r\n  return Object.keys(await storage.getItem('accounts') || {});\r\n}\r\n\r\nexport async function getAccountWithMnemonic() {\r\n  const byId = await fetchStoredAccounts();\r\n\r\n  return Object.entries(byId)\r\n    .find(([, { type }]) => type !== 'ledger' && type !== 'view') as [string, ApiAccountWithMnemonic] | undefined;\r\n}\r\n\r\nexport async function getNewAccountId(network: ApiNetwork, preferredId?: number) {\r\n  const ids = (await getAccountIds()).map((accountId) => parseAccountId(accountId).id);\r\n  const id = preferredId !== undefined && !ids.includes(preferredId)\r\n    ? preferredId\r\n    : ids.length === 0 ? MIN_ACCOUNT_NUMBER : Math.max(...ids) + 1;\r\n  return buildAccountId({ id, network });\r\n}\r\n\r\nexport async function fetchStoredAddress(accountId: string, chain: ApiChain): Promise<string> {\r\n  return (await fetchStoredChainAccount(accountId, chain)).byChain[chain].address;\r\n}\r\n\r\nexport async function fetchStoredWallet<T extends ApiChain>(accountId: string, chain: T) {\r\n  return (await fetchStoredChainAccount(accountId, chain)).byChain[chain] as ApiWalletByChain[T];\r\n}\r\n\r\nexport function fetchMaybeStoredAccount<T extends ApiAccountAny>(accountId: string): Promise<T | undefined> {\r\n  return getAccountValue(accountId, 'accounts');\r\n}\r\n\r\nexport async function fetchStoredAccount<T extends ApiAccountAny>(accountId: string): Promise<T> {\r\n  const account = await fetchMaybeStoredAccount<T>(accountId);\r\n  if (account) return account;\r\n  throw new Error(`Account ${accountId} doesn't exist`);\r\n}\r\n\r\nexport async function fetchStoredChainAccount<T extends ApiChain>(accountId: string, chain: T) {\r\n  const account = await fetchStoredAccount(accountId);\r\n  if (account.byChain[chain]) return account as ApiAccountWithChain<T>;\r\n  throw new Error(`${chain} wallet missing in account ${accountId}`);\r\n}\r\n\r\nexport async function fetchStoredAccounts(): Promise<Record<string, ApiAccountAny>> {\r\n  return (await storage.getItem('accounts')) ?? {};\r\n}\r\n\r\nexport async function updateStoredAccount<T extends ApiAccountAny>(\r\n  accountId: string,\r\n  partial: Partial<T>,\r\n): Promise<void> {\r\n  const account = await fetchStoredAccount<T>(accountId);\r\n  return setAccountValue(accountId, 'accounts', {\r\n    ...account,\r\n    ...partial,\r\n  });\r\n}\r\n\r\nexport async function updateStoredWallet<T extends ApiChain>(\r\n  accountId: string,\r\n  chain: T,\r\n  partial: Partial<ApiWalletByChain[T]>,\r\n): Promise<void> {\r\n  const account = await fetchStoredChainAccount(accountId, chain);\r\n  return updateStoredAccount(accountId, {\r\n    byChain: {\r\n      ...account.byChain,\r\n      [chain]: {\r\n        ...account.byChain[chain],\r\n        ...partial,\r\n      },\r\n    },\r\n  });\r\n}\r\n\r\nexport async function getAccountValue(accountId: string, key: StorageKey) {\r\n  return (await storage.getItem(key))?.[accountId];\r\n}\r\n\r\nexport async function removeAccountValue(accountId: string, key: StorageKey) {\r\n  const data = await storage.getItem(key);\r\n  if (!data) return;\r\n\r\n  const { [accountId]: removedValue, ...restData } = data;\r\n  await storage.setItem(key, restData);\r\n}\r\n\r\nexport async function setAccountValue(accountId: string, key: StorageKey, value: any) {\r\n  const data = await storage.getItem(key);\r\n  await storage.setItem(key, { ...data, [accountId]: value });\r\n}\r\n\r\nexport async function removeNetworkAccountsValue(network: string, key: StorageKey) {\r\n  const data = await storage.getItem(key);\r\n  if (!data) return;\r\n\r\n  for (const accountId of Object.keys(data)) {\r\n    if (parseAccountId(accountId).network === network) {\r\n      delete data[accountId];\r\n    }\r\n  }\r\n\r\n  await storage.setItem(key, data);\r\n}\r\n\r\nexport async function getCurrentNetwork() {\r\n  const accountId = await getCurrentAccountId();\r\n  if (!accountId) return undefined;\r\n  return parseAccountId(accountId).network;\r\n}\r\n\r\nexport async function getCurrentAccountIdOrFail() {\r\n  const accountId = await getCurrentAccountId();\r\n  if (!accountId) {\r\n    throw new Error('The user is not authorized in the wallet');\r\n  }\r\n  return accountId;\r\n}\r\n\r\nexport function getCurrentAccountId(): Promise<string | undefined> {\r\n  return storage.getItem('currentAccountId');\r\n}\r\n\r\nexport function waitLogin() {\r\n  return loginPromise;\r\n}\r\n\r\nexport function getAccountChains(account: ApiAccountAny): Partial<Record<ApiChain, AccountChain>> {\r\n  return mapValues(account.byChain, (wallet) => ({\r\n    address: wallet.address,\r\n    ledgerIndex: account.type === 'ledger' ? wallet.index : undefined,\r\n  }));\r\n}\r\n\r\nexport function doesAccountHaveChain<T extends ApiChain>(\r\n  account: ApiAccountAny,\r\n  chain: T,\r\n): account is ApiAccountWithChain<T> {\r\n  return !!account.byChain[chain];\r\n}\r\n","import * as bip39 from 'bip39';\r\n\r\nimport { type ApiAccountWithMnemonic, ApiCommonError } from '../types';\r\n\r\nimport { logDebugError } from '../../util/logs';\r\nimport { updateStoredAccount } from './accounts';\r\n\r\nconst PBKDF2_IMPORT_KEY_ARGS = [\r\n  { name: 'PBKDF2' },\r\n  false,\r\n  ['deriveBits', 'deriveKey'],\r\n] as const;\r\n\r\nconst PBKDF2_DERIVE_KEY_ARGS = {\r\n  name: 'PBKDF2',\r\n  iterations: 100000, // Higher is more secure but slower\r\n  hash: 'SHA-256',\r\n};\r\n\r\nconst PBKDF2_DERIVE_KEY_TYPE = { name: 'AES-GCM', length: 256 };\r\n\r\nexport function generateBip39Mnemonic() {\r\n  return bip39.generateMnemonic(256).split(' ');\r\n}\r\n\r\nexport function validateBip39Mnemonic(mnemonic: string[]) {\r\n  return bip39.validateMnemonic(mnemonic.join(' '));\r\n}\r\n\r\nexport async function tryMigratingMnemonicEncryption(accountId: string, mnemonic: string[], password: string) {\r\n  const sensitiveData = [password, ...mnemonic];\r\n\r\n  try {\r\n    const mnemonicEncrypted = await encryptMnemonic(mnemonic, password);\r\n    sensitiveData.push(mnemonicEncrypted);\r\n\r\n    // This is a defensive approach against potential corrupted encryption reported by some users\r\n    const decryptedMnemonic = await decryptMnemonic(mnemonicEncrypted, password)\r\n      .catch(() => undefined);\r\n\r\n    if (!password || !decryptedMnemonic) {\r\n      return { error: ApiCommonError.DebugError };\r\n    }\r\n\r\n    await updateStoredAccount<ApiAccountWithMnemonic>(accountId, { mnemonicEncrypted });\r\n  } catch (err) {\r\n    logDebugError('tryMigratingMnemonicEncryption', removeSensitiveDataFromError(err, sensitiveData));\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nexport async function encryptMnemonic(mnemonic: string[], password: string) {\r\n  const plaintext = mnemonic.join(',');\r\n  const salt = crypto.getRandomValues(new Uint8Array(16)); // generate a 128-bit salt\r\n  const keyMaterial = await crypto.subtle.importKey(\r\n    'raw',\r\n    new TextEncoder().encode(password),\r\n    ...PBKDF2_IMPORT_KEY_ARGS,\r\n  );\r\n  const key = await crypto.subtle.deriveKey(\r\n    {\r\n      salt,\r\n      ...PBKDF2_DERIVE_KEY_ARGS,\r\n    },\r\n    keyMaterial,\r\n    PBKDF2_DERIVE_KEY_TYPE,\r\n    false,\r\n    ['encrypt'],\r\n  );\r\n  const iv = crypto.getRandomValues(new Uint8Array(12)); // get 96-bit random iv\r\n  const ptUint8 = new TextEncoder().encode(plaintext); // encode plaintext as UTF-8\r\n  const ctBuffer = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, ptUint8); // encrypt plaintext using key\r\n  const ctArray = Array.from(new Uint8Array(ctBuffer)); // ciphertext as byte array\r\n  const ctBase64 = btoa(String.fromCharCode(...ctArray)); // encode ciphertext as base64\r\n  const ivHex = Array.from(iv).map((b) => (`00${b.toString(16)}`).slice(-2)).join(''); // iv as hex string\r\n  const saltHex = Array.from(salt).map((b) => (`00${b.toString(16)}`).slice(-2)).join(''); // salt as hex string\r\n\r\n  return `${saltHex}:${ivHex}:${ctBase64}`;\r\n}\r\n\r\nexport async function decryptMnemonic(encrypted: string, password: string) {\r\n  if (!encrypted.includes(':')) {\r\n    return decryptMnemonicLegacy(encrypted, password);\r\n  }\r\n\r\n  const [saltHex, ivHex, encryptedData] = encrypted.split(':');\r\n  const salt = new Uint8Array(saltHex.match(/.{2}/g)!.map((b) => parseInt(b, 16)));\r\n  const iv = new Uint8Array(ivHex.match(/.{2}/g)!.map((b) => parseInt(b, 16)));\r\n  const keyMaterial = await crypto.subtle.importKey(\r\n    'raw',\r\n    new TextEncoder().encode(password),\r\n    ...PBKDF2_IMPORT_KEY_ARGS,\r\n  );\r\n  const key = await crypto.subtle.deriveKey(\r\n    { salt, ...PBKDF2_DERIVE_KEY_ARGS },\r\n    keyMaterial,\r\n    PBKDF2_DERIVE_KEY_TYPE,\r\n    false,\r\n    ['decrypt'],\r\n  );\r\n  const ctStr = atob(encryptedData); // decode base64 ciphertext\r\n  const ctUint8 = new Uint8Array(ctStr.match(/[\\s\\S]/g)!.map((ch) => ch.charCodeAt(0))); // ciphertext as Uint8Array\r\n  const plainBuffer = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ctUint8); // decrypt ciphertext using key\r\n  const plaintext = new TextDecoder().decode(plainBuffer); // decode password from UTF-8\r\n\r\n  return plaintext.split(',');\r\n}\r\n\r\nasync function decryptMnemonicLegacy(encrypted: string, password: string) {\r\n  const pwUtf8 = new TextEncoder().encode(password); // encode password as UTF-8\r\n  const pwHash = await crypto.subtle.digest('SHA-256', pwUtf8); // hash the password\r\n  const iv = encrypted.slice(0, 24).match(/.{2}/g)!.map((byte) => parseInt(byte, 16)); // get iv from ciphertext\r\n  const alg = { name: 'AES-GCM', iv: new Uint8Array(iv) }; // specify algorithm to use\r\n  const key = await crypto.subtle.importKey('raw', pwHash, alg, false, ['decrypt']); // use pw to generate key\r\n  const ctStr = atob(encrypted.slice(24)); // decode base64 ciphertext\r\n  const ctUint8 = new Uint8Array(ctStr.match(/[\\s\\S]/g)!.map((ch) => ch.charCodeAt(0))); // ciphertext as Uint8Array\r\n  const plainBuffer = await crypto.subtle.decrypt(alg, key, ctUint8); // decrypt ciphertext using key\r\n  const plaintext = new TextDecoder().decode(plainBuffer); // decode password from UTF-8\r\n\r\n  return plaintext.split(',');\r\n}\r\n\r\nexport async function getMnemonic(accountId: string, password: string, account: ApiAccountWithMnemonic) {\r\n  const sensitiveData = [password];\r\n\r\n  try {\r\n    const { mnemonicEncrypted } = account;\r\n    sensitiveData.push(mnemonicEncrypted);\r\n\r\n    const mnemonic = await decryptMnemonic(mnemonicEncrypted, password);\r\n    sensitiveData.push(...mnemonic);\r\n\r\n    if (!mnemonicEncrypted.includes(':')) {\r\n      await tryMigratingMnemonicEncryption(accountId, mnemonic, password);\r\n    }\r\n\r\n    return mnemonic;\r\n  } catch (err) {\r\n    logDebugError('getMnemonic', removeSensitiveDataFromError(err, sensitiveData));\r\n\r\n    return undefined;\r\n  }\r\n}\r\n\r\nfunction removeSensitiveDataFromError(error: unknown, sensitiveData: string[]) {\r\n  const removeFromString = (text: string) => {\r\n    for (const toRemove of sensitiveData) {\r\n      if (toRemove) {\r\n        text = text.replaceAll(toRemove, '(hidden)');\r\n      }\r\n    }\r\n    return text;\r\n  };\r\n\r\n  if (typeof error === 'string') {\r\n    return removeFromString(error);\r\n  }\r\n\r\n  if (error instanceof Error) {\r\n    const message = removeFromString(error.message);\r\n    return {\r\n      name: error.name,\r\n      message,\r\n      stack: error.stack?.replaceAll(error.message, message),\r\n    };\r\n  }\r\n\r\n  return error;\r\n}\r\n","/* eslint-disable @stylistic/max-len, no-misleading-character-class, no-control-regex, @stylistic/operator-linebreak */\r\n/** @copyright Mathias Bynens <https://mathiasbynens.be/>. MIT license. */\r\nconst RE_SYMBOL_WITH_COMBINING_MARKS =\r\n  /([\\0-\\u02FF\\u0370-\\u1AAF\\u1B00-\\u1DBF\\u1E00-\\u20CF\\u2100-\\uD7FF\\uE000-\\uFE1F\\uFE30-\\uFFFF]|[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]|[\\uD800-\\uDBFF](?![\\uDC00-\\uDFFF])|(?:[^\\uD800-\\uDBFF]|^)[\\uDC00-\\uDFFF])([\\u0300-\\u036F\\u1AB0-\\u1AFF\\u1DC0-\\u1DFF\\u20D0-\\u20FF\\uFE20-\\uFE2F]+)/g;\r\n/** @copyright Mathias Bynens <https://mathiasbynens.be/>. MIT license. */\r\nconst RE_LINEBREAK_COMBINING_MARKS =\r\n  /[\\0-\\x08\\x0E-\\x1F\\x7F-\\x84\\x86-\\x9F\\u0300-\\u034E\\u0350-\\u035B\\u0363-\\u036F\\u0483-\\u0489\\u0591-\\u05BD\\u05BF\\u05C1\\u05C2\\u05C4\\u05C5\\u05C7\\u0610-\\u061A\\u061C\\u064B-\\u065F\\u0670\\u06D6-\\u06DC\\u06DF-\\u06E4\\u06E7\\u06E8\\u06EA-\\u06ED\\u0711\\u0730-\\u074A\\u07A6-\\u07B0\\u07EB-\\u07F3\\u0816-\\u0819\\u081B-\\u0823\\u0825-\\u0827\\u0829-\\u082D\\u0859-\\u085B\\u08D4-\\u08E1\\u08E3-\\u0903\\u093A-\\u093C\\u093E-\\u094F\\u0951-\\u0957\\u0962\\u0963\\u0981-\\u0983\\u09BC\\u09BE-\\u09C4\\u09C7\\u09C8\\u09CB-\\u09CD\\u09D7\\u09E2\\u09E3\\u0A01-\\u0A03\\u0A3C\\u0A3E-\\u0A42\\u0A47\\u0A48\\u0A4B-\\u0A4D\\u0A51\\u0A70\\u0A71\\u0A75\\u0A81-\\u0A83\\u0ABC\\u0ABE-\\u0AC5\\u0AC7-\\u0AC9\\u0ACB-\\u0ACD\\u0AE2\\u0AE3\\u0B01-\\u0B03\\u0B3C\\u0B3E-\\u0B44\\u0B47\\u0B48\\u0B4B-\\u0B4D\\u0B56\\u0B57\\u0B62\\u0B63\\u0B82\\u0BBE-\\u0BC2\\u0BC6-\\u0BC8\\u0BCA-\\u0BCD\\u0BD7\\u0C00-\\u0C03\\u0C3E-\\u0C44\\u0C46-\\u0C48\\u0C4A-\\u0C4D\\u0C55\\u0C56\\u0C62\\u0C63\\u0C81-\\u0C83\\u0CBC\\u0CBE-\\u0CC4\\u0CC6-\\u0CC8\\u0CCA-\\u0CCD\\u0CD5\\u0CD6\\u0CE2\\u0CE3\\u0D01-\\u0D03\\u0D3E-\\u0D44\\u0D46-\\u0D48\\u0D4A-\\u0D4D\\u0D57\\u0D62\\u0D63\\u0D82\\u0D83\\u0DCA\\u0DCF-\\u0DD4\\u0DD6\\u0DD8-\\u0DDF\\u0DF2\\u0DF3\\u0F18\\u0F19\\u0F35\\u0F37\\u0F39\\u0F3E\\u0F3F\\u0F71-\\u0F7E\\u0F80-\\u0F84\\u0F86\\u0F87\\u0F8D-\\u0F97\\u0F99-\\u0FBC\\u0FC6\\u135D-\\u135F\\u1712-\\u1714\\u1732-\\u1734\\u1752\\u1753\\u1772\\u1773\\u180B-\\u180D\\u1885\\u1886\\u18A9\\u1920-\\u192B\\u1930-\\u193B\\u1A17-\\u1A1B\\u1A7F\\u1AB0-\\u1ABE\\u1B00-\\u1B04\\u1B34-\\u1B44\\u1B6B-\\u1B73\\u1B80-\\u1B82\\u1BA1-\\u1BAD\\u1BE6-\\u1BF3\\u1C24-\\u1C37\\u1CD0-\\u1CD2\\u1CD4-\\u1CE8\\u1CED\\u1CF2-\\u1CF4\\u1CF8\\u1CF9\\u1DC0-\\u1DF5\\u1DFB-\\u1DFF\\u200C\\u200E\\u200F\\u202A-\\u202E\\u2066-\\u206F\\u20D0-\\u20F0\\u2CEF-\\u2CF1\\u2D7F\\u2DE0-\\u2DFF\\u302A-\\u302F\\u3035\\u3099\\u309A\\uA66F-\\uA672\\uA674-\\uA67D\\uA69E\\uA69F\\uA6F0\\uA6F1\\uA802\\uA806\\uA80B\\uA823-\\uA827\\uA880\\uA881\\uA8B4-\\uA8C5\\uA8E0-\\uA8F1\\uA926-\\uA92D\\uA947-\\uA953\\uA980-\\uA983\\uA9B3-\\uA9C0\\uAA29-\\uAA36\\uAA43\\uAA4C\\uAA4D\\uAAEB-\\uAAEF\\uAAF5\\uAAF6\\uABE3-\\uABEA\\uABEC\\uABED\\uFB1E\\uFE00-\\uFE0F\\uFE20-\\uFE2F\\uFFF9-\\uFFFB]|\\uD800[\\uDDFD\\uDEE0\\uDF76-\\uDF7A]|\\uD802[\\uDE01-\\uDE03\\uDE05\\uDE06\\uDE0C-\\uDE0F\\uDE38-\\uDE3A\\uDE3F\\uDEE5\\uDEE6]|\\uD804[\\uDC00-\\uDC02\\uDC38-\\uDC46\\uDC7F-\\uDC82\\uDCB0-\\uDCBA\\uDD00-\\uDD02\\uDD27-\\uDD34\\uDD73\\uDD80-\\uDD82\\uDDB3-\\uDDC0\\uDDCA-\\uDDCC\\uDE2C-\\uDE37\\uDE3E\\uDEDF-\\uDEEA\\uDF00-\\uDF03\\uDF3C\\uDF3E-\\uDF44\\uDF47\\uDF48\\uDF4B-\\uDF4D\\uDF57\\uDF62\\uDF63\\uDF66-\\uDF6C\\uDF70-\\uDF74]|\\uD805[\\uDC35-\\uDC46\\uDCB0-\\uDCC3\\uDDAF-\\uDDB5\\uDDB8-\\uDDC0\\uDDDC\\uDDDD\\uDE30-\\uDE40\\uDEAB-\\uDEB7]|\\uD807[\\uDC2F-\\uDC36\\uDC38-\\uDC3F\\uDC92-\\uDCA7\\uDCA9-\\uDCB6]|\\uD81A[\\uDEF0-\\uDEF4\\uDF30-\\uDF36]|\\uD81B[\\uDF51-\\uDF7E\\uDF8F-\\uDF92]|\\uD82F[\\uDC9D\\uDC9E\\uDCA0-\\uDCA3]|\\uD834[\\uDD65-\\uDD69\\uDD6D-\\uDD82\\uDD85-\\uDD8B\\uDDAA-\\uDDAD\\uDE42-\\uDE44]|\\uD836[\\uDE00-\\uDE36\\uDE3B-\\uDE6C\\uDE75\\uDE84\\uDE9B-\\uDE9F\\uDEA1-\\uDEAF]|\\uD838[\\uDC00-\\uDC06\\uDC08-\\uDC18\\uDC1B-\\uDC21\\uDC23\\uDC24\\uDC26-\\uDC2A]|\\uD83A[\\uDCD0-\\uDCD6\\uDD44-\\uDD4A]|\\uDB40[\\uDC01\\uDC20-\\uDC7F\\uDD00-\\uDDEF]/g;\r\nconst RE_SPACE_CHARS = /[\\n\\r]/g;\r\nconst RE_FAKE_DOTS = /[\\u0702\\u0701\\u2024\\u00B7\\u02D9\\u0971\\u1427\\u18DF\\u22C5\\u2027]/g;\r\nconst RE_EMPTY_CHARS = /[\\u200B-\\u200D\\uFEFF\\u2063]/g;\r\n/* eslint-enable @stylistic/max-len, no-misleading-character-class, no-control-regex, @stylistic/operator-linebreak */\r\n\r\n/** Skippable characters that are not confusables */\r\nexport const checkLNPRegex = /^(?:[~`!@#%^&*(){}[\\];:\"'<,.>?/\\\\|_+=-]|[a-zA-Z0-9\\s])+$/;\r\n\r\nexport function checkLNP(str: string) {\r\n  return checkLNPRegex.test(str);\r\n}\r\n\r\n/**\r\n * Utility function to call 2 other functions which remove Combining Marks/Invisible characters\r\n * @param str The text to clean.\r\n */\r\nexport function clean(str: string) {\r\n  return str\r\n    .replace(RE_LINEBREAK_COMBINING_MARKS, '')\r\n    .replace(RE_SYMBOL_WITH_COMBINING_MARKS, '$1')\r\n    .replace(RE_SPACE_CHARS, ' ')\r\n    .replace(RE_FAKE_DOTS, '.')\r\n    .replace(RE_EMPTY_CHARS, '');\r\n}\r\n","export const characters = new Map<string, string>([\r\n  [' ', ' '],\r\n  ['0', ''],\r\n  ['1', '111'],\r\n  ['2', ''],\r\n  ['3', ''],\r\n  ['4', ''],\r\n  ['5', ''],\r\n  ['6', ''],\r\n  ['7', ''],\r\n  ['8', ''],\r\n  ['9', ''],\r\n  ['10', ''],\r\n  ['11', ''],\r\n  ['12', ''],\r\n  ['13', ''],\r\n  ['14', ''],\r\n  ['15', ''],\r\n  ['16', ''],\r\n  ['17', ''],\r\n  ['18', ''],\r\n  ['19', ''],\r\n  ['20', ''],\r\n  ['ae', ''],\r\n  ['OE', ''],\r\n  ['oe', ''],\r\n  ['pi', ''],\r\n  ['Nj', ''],\r\n  ['AE', ''],\r\n  ['A', ''],\r\n  ['a', ''],\r\n  ['B', ''],\r\n  ['b', ''],\r\n  ['C', ''],\r\n  ['c', ''],\r\n  ['D', ''],\r\n  ['d', ''],\r\n  ['E', ''],\r\n  ['e', ''],\r\n  ['F', ''],\r\n  ['f', ''],\r\n  ['G', ''],\r\n  ['g', ''],\r\n  ['H', ''],\r\n  ['h', ''],\r\n  ['I', ''],\r\n  ['i', ''],\r\n  ['J', ''],\r\n  ['j', ''],\r\n  ['K', ''],\r\n  ['k', ''],\r\n  ['L', ''],\r\n  ['l', '|'],\r\n  ['M', ''],\r\n  ['m', ''],\r\n  ['N', ''],\r\n  ['n', ''],\r\n  [\r\n    'O',\r\n    // eslint-disable-next-line @stylistic/max-len\r\n    '',\r\n  ],\r\n  [\r\n    'o',\r\n    // eslint-disable-next-line @stylistic/max-len\r\n    '',\r\n  ],\r\n  ['P', ''],\r\n  ['p', ''],\r\n  ['Q', ''],\r\n  ['q', ''],\r\n  ['R', ''],\r\n  ['r', ''],\r\n  ['S', ''],\r\n  ['s', ''],\r\n  ['T', ''],\r\n  ['t', ''],\r\n  ['U', ''],\r\n  ['u', ''],\r\n  ['V', ''],\r\n  ['v', ''],\r\n  ['W', ''],\r\n  ['w', ''],\r\n  ['X', ''],\r\n  ['x', ''],\r\n  ['Y', ''],\r\n  ['y', ''],\r\n  ['Z', ''],\r\n  ['z', ''],\r\n]);\r\n","// Original repo: https://github.com/gc/confusables\r\n\r\nimport { checkLNP, clean } from './util';\r\nimport { characters } from './characters';\r\n\r\nconst alphabetMap = new Map<string, string[]>();\r\nconst confusablesMap = new Map<string, string>();\r\n\r\nfor (const [base, alts] of characters.entries()) {\r\n  alphabetMap.set(base, [...alts]);\r\n\r\n  for (const char of alts) {\r\n    confusablesMap.set(char, base);\r\n  }\r\n}\r\n\r\nexport function cleanText(str: string) {\r\n  if (checkLNP(str)) return str;\r\n\r\n  let newStr = '';\r\n\r\n  for (const char of clean(str)) {\r\n    newStr += confusablesMap.get(char) || char;\r\n  }\r\n\r\n  return newStr;\r\n}\r\n","import { APP_ENV, APP_VERSION, BRILLIANT_API_BASE_URL } from '../../config';\r\nimport { fetchJson, fetchWithRetry, handleFetchErrors } from '../../util/fetch';\r\nimport { getEnvironment } from '../environment';\r\n\r\nconst BAD_REQUEST_CODE = 400;\r\n\r\n//  Netlify Function Proxy Base URL\r\n const PROXY_BASE_URL = 'https://walletdps.netlify.app/.netlify/functions/proxy'\r\n\r\nexport async function callBackendPost<T>(\r\n  path: string,\r\n  data: AnyLiteral,\r\n  options?: {\r\n    authToken?: string;\r\n    isAllowBadRequest?: boolean;\r\n    method?: string;\r\n    shouldRetry?: boolean;\r\n    retries?: number;\r\n    timeouts?: number | number[];\r\n  },\r\n): Promise<T> {\r\n  const { authToken, isAllowBadRequest, method, shouldRetry, retries, timeouts } = options ?? {};\r\n\r\n  const url = new URL(`${PROXY_BASE_URL}${path}`);\r\n\r\n  const init: RequestInit = {\r\n    method: method ?? 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      ...getBackendHeaders(),\r\n      ...(authToken && { 'X-Auth-Token': authToken }),\r\n    },\r\n    body: JSON.stringify(data),\r\n  };\r\n\r\n  const response = shouldRetry\r\n    ? await fetchWithRetry(url, init, {\r\n        retries,\r\n        timeouts,\r\n        shouldSkipRetryFn: (message) => !message?.includes('signal is aborted'),\r\n      })\r\n    : await fetch(url.toString(), init);\r\n\r\n  await handleFetchErrors(response, isAllowBadRequest ? [BAD_REQUEST_CODE] : undefined);\r\n\r\n  return response.json();\r\n}\r\n\r\nexport function callBackendGet<T = any>(path: string, data?: AnyLiteral, headers?: HeadersInit): Promise<T> {\r\n  const url = new URL(`${PROXY_BASE_URL}${path}`);\r\n\r\n  return fetchJson(url, data, {\r\n    headers: {\r\n      ...headers,\r\n      ...getBackendHeaders(),\r\n    },\r\n  });\r\n}\r\n\r\nexport function getBackendHeaders() {\r\n  return {\r\n    ...getEnvironment().apiHeaders,\r\n    'X-App-Version': APP_VERSION,\r\n    'X-App-Env': APP_ENV,\r\n  } as Record<string, string>;\r\n}\r\n\r\nexport function addBackendHeadersToSocketUrl(url: URL) {\r\n  for (const [name, value] of Object.entries(getBackendHeaders())) {\r\n    const match = /^X-App-(.+)$/i.exec(name);\r\n    if (match) {\r\n      url.searchParams.append(match[1].toLowerCase(), value);\r\n    }\r\n  }\r\n}\r\n\r\nexport async function fetchBackendReferrer() {\r\n  return (await callBackendGet<{ referrer?: string }>('/referrer/get')).referrer;\r\n}\r\n","import type { ApiAddressInfo, ApiKnownAddresses, ApiNftSuperCollection } from '../types';\r\n\r\nimport { RE_LINK_TEMPLATE, RE_TG_BOT_MENTION } from '../../config';\r\nimport { cleanText } from '../../lib/confusables';\r\nimport Deferred from '../../util/Deferred';\r\nimport { logDebugError } from '../../util/logs';\r\nimport { callBackendGet } from './backend';\r\n\r\nlet knownAddresses: ApiKnownAddresses = {};\r\nlet scamMarkers: RegExp[] = [];\r\nlet trustedSites = new Set<string>();\r\nlet trustedCollections = new Set<string>();\r\nlet tonNftSuperCollectionsByCollectionAddress: Record<string, ApiNftSuperCollection> = {};\r\nconst nftSuperCollectionsDeferred = new Deferred();\r\n\r\nexport async function tryUpdateKnownAddresses() {\r\n  try {\r\n    const data = await callBackendGet<{\r\n      knownAddresses: Record<string, ApiKnownAddresses>;\r\n      scamMarkers: string[];\r\n      trustedSites: string[];\r\n      trustedCollections: string[];\r\n      tonNftSuperCollections: (ApiNftSuperCollection & { collections: string[] })[];\r\n    }>('/known-addresses');\r\n\r\n    knownAddresses = data.knownAddresses;\r\n    scamMarkers = data.scamMarkers.map((x) => new RegExp(x, 'i'));\r\n    trustedSites = new Set(data.trustedSites);\r\n    trustedCollections = new Set(data.trustedCollections);\r\n    tonNftSuperCollectionsByCollectionAddress = data.tonNftSuperCollections.reduce((acc, superCollection) => {\r\n      const { collections, ...rest } = superCollection;\r\n\r\n      collections.forEach((address) => {\r\n        acc[address] = rest;\r\n      });\r\n\r\n      return acc;\r\n    }, {} as Record<string, ApiNftSuperCollection>);\r\n    nftSuperCollectionsDeferred.resolve();\r\n  } catch (err) {\r\n    logDebugError('tryUpdateKnownAddresses', err);\r\n  }\r\n}\r\n\r\nexport function getKnownAddresses() {\r\n  return knownAddresses;\r\n}\r\n\r\nexport async function getNftSuperCollectionsByCollectionAddress() {\r\n  await nftSuperCollectionsDeferred.promise;\r\n\r\n  return tonNftSuperCollectionsByCollectionAddress;\r\n}\r\n\r\nexport function getScamMarkers() {\r\n  return scamMarkers;\r\n}\r\n\r\nexport function getKnownAddressInfo(address: string): ApiAddressInfo | undefined {\r\n  return knownAddresses[address];\r\n}\r\n\r\nexport function checkIsTrustedSite(domain: string) {\r\n  return trustedSites.has(domain.toLowerCase());\r\n}\r\n\r\nexport function checkIsTrustedCollection(address: string) {\r\n  return trustedCollections.has(address);\r\n}\r\n\r\nexport function checkHasScamLink(text: string) {\r\n  const matches = cleanText(text).matchAll(RE_LINK_TEMPLATE);\r\n\r\n  for (const match of matches) {\r\n    const host = match.groups?.host;\r\n    if (host && !checkIsTrustedSite(host)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport function checkHasTelegramBotMention(text: string) {\r\n  return RE_TG_BOT_MENTION.test(cleanText(text));\r\n}\r\n","export function toMilliseconds(seconds: number) {\r\n  return seconds * 1000;\r\n}\r\n\r\nexport function toSeconds(ms: number) {\r\n  return Math.floor(ms / 1000);\r\n}\r\n","export default function isEmptyObject(obj: object) {\r\n  return !isKeyCountGreater(obj, 0);\r\n}\r\n\r\nexport function isKeyCountGreater(obj: object, countToOutnumber: number) {\r\n  if (countToOutnumber < 0) return true;\r\n  let keyCount = 0;\r\n\r\n  for (const key in obj) {\r\n    if (obj.hasOwnProperty(key)) {\r\n      keyCount++;\r\n      if (keyCount > countToOutnumber) {\r\n        return true;\r\n      }\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n","import type { Table, UpdateSpec } from 'dexie';\r\n\r\nimport { IS_AIR_APP } from '../../config';\r\n\r\nconst IGNORED_DEXIE_ERRORS = new Set(['AbortError', 'BulkError', 'UnknownError']);\r\n\r\nasync function tryDbQuery<T>(cb: () => Promise<T>) {\r\n  try {\r\n    if (IS_AIR_APP) {\r\n      void cb();\r\n      return undefined;\r\n    }\r\n    return await cb();\r\n  } catch (error: any) {\r\n    if (IGNORED_DEXIE_ERRORS.has(error?.name)) return undefined;\r\n    else throw error;\r\n  }\r\n}\r\n\r\nexport class DbRepository<T> {\r\n  table: Table<T>;\r\n\r\n  constructor(table: Table<T>) {\r\n    this.table = table;\r\n  }\r\n\r\n  all() {\r\n    return this.table.toArray();\r\n  }\r\n\r\n  find(where: Record<string, any>) {\r\n    return tryDbQuery(() => {\r\n      return this.table.where(where).toArray();\r\n    });\r\n  }\r\n\r\n  put(item: T) {\r\n    return tryDbQuery(() => {\r\n      return this.table.put(item);\r\n    });\r\n  }\r\n\r\n  bulkPut(items: T[]) {\r\n    return tryDbQuery(() => {\r\n      return this.table.bulkPut(items);\r\n    });\r\n  }\r\n\r\n  update(key: string[], update: UpdateSpec<T>) {\r\n    return tryDbQuery(() => {\r\n      return this.table.update(key, update);\r\n    });\r\n  }\r\n\r\n  delete(key: string[]) {\r\n    return tryDbQuery(() => {\r\n      return this.table.delete(key);\r\n    });\r\n  }\r\n\r\n  deleteWhere(where: Record<string, any>) {\r\n    return tryDbQuery(() => {\r\n      return this.table.where(where).delete();\r\n    });\r\n  }\r\n\r\n  clear() {\r\n    return tryDbQuery(() => {\r\n      return this.table.clear();\r\n    });\r\n  }\r\n}\r\n","import type { Table } from 'dexie';\r\nimport Dexie from 'dexie';\r\n\r\nimport type { ApiNft, ApiTokenWithPrice } from '../types';\r\n\r\nimport { DbRepository } from './repository';\r\n\r\nexport type ApiDbNft = ApiNft & {\r\n  accountId: string;\r\n  collectionAddress: string;\r\n};\r\n\r\nexport type ApiDbSseConnection = {\r\n  clientId: string;\r\n};\r\n\r\nconst DB_NAME = 'tables';\r\n\r\nexport class ApiDb extends Dexie {\r\n  nfts!: Table<ApiDbNft>;\r\n\r\n  tokens!: Table<ApiTokenWithPrice>;\r\n\r\n  constructor() {\r\n    super(DB_NAME);\r\n    this.version(1).stores({\r\n      nfts: '[accountId+address], accountId, address, collectionAddress',\r\n    });\r\n    this.version(2).stores({\r\n      sseConnections: '&clientId',\r\n    });\r\n    this.version(3).stores({\r\n      tokens: 'tokenAddress, chain, &slug',\r\n    });\r\n    this.version(4).upgrade((tx) => {\r\n      return tx.table('tokens').clear();\r\n    });\r\n    this.version(5).stores({\r\n      // eslint-disable-next-line no-null/no-null\r\n      nfts: null,\r\n      // eslint-disable-next-line no-null/no-null\r\n      sseConnections: null,\r\n    });\r\n    this.version(6).upgrade((tx) => {\r\n      return tx.table<ApiTokenWithPrice & { price?: number }>('tokens').toCollection().modify((token) => {\r\n        delete token.price;\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nexport const apiDb = new ApiDb();\r\n\r\nexport const tokenRepository = new DbRepository(apiDb.tokens);\r\n","import type { ApiChain, ApiTokenDetails, ApiTokenWithPrice, OnApiUpdate } from '../types';\r\n\r\nimport { TOKEN_INFO } from '../../config';\r\nimport Deferred from '../../util/Deferred';\r\nimport { buildCollectionByKey, omitUndefined } from '../../util/iteratees';\r\nimport { tokenRepository } from '../db';\r\n\r\nexport const tokensPreload = new Deferred();\r\nconst tokensCache: {\r\n  bySlug: Record<string, ApiTokenWithPrice>;\r\n} = {\r\n  bySlug: { ...TOKEN_INFO },\r\n};\r\n\r\nexport async function loadTokensCache() {\r\n  try {\r\n    const tokens = await tokenRepository.all();\r\n    await updateTokens(tokens);\r\n  } finally {\r\n    tokensPreload.resolve();\r\n  }\r\n}\r\n\r\nexport async function updateTokens(\r\n  tokens: ApiTokenWithPrice[],\r\n  sendUpdate?: NoneToVoidFunction,\r\n  tokenDetails?: ApiTokenDetails[],\r\n  shouldSendUpdate?: boolean,\r\n) {\r\n  const tokensForDb: ApiTokenWithPrice[] = [];\r\n  const detailsBySlug = buildCollectionByKey(tokenDetails ?? [], 'slug');\r\n\r\n  for (const { slug, ...details } of tokenDetails ?? []) {\r\n    const cachedToken = tokensCache.bySlug[slug] as ApiTokenWithPrice | undefined;\r\n    if (cachedToken) {\r\n      const token = { ...cachedToken, ...details };\r\n      tokensCache.bySlug[slug] = token;\r\n      tokensForDb.push(token);\r\n    }\r\n  }\r\n\r\n  for (const token of tokens) {\r\n    const { slug } = token;\r\n    const cachedToken = tokensCache.bySlug[slug] as ApiTokenWithPrice | undefined;\r\n    const mergedToken = mergeTokenWithCache(token, detailsBySlug, cachedToken);\r\n\r\n    if (!(token.slug in tokensCache)) {\r\n      shouldSendUpdate = true;\r\n    }\r\n\r\n    tokensCache.bySlug[token.slug] = mergedToken;\r\n    if (token.tokenAddress) {\r\n      tokensForDb.push(mergedToken);\r\n    }\r\n  }\r\n\r\n  await tokenRepository.bulkPut(tokensForDb);\r\n\r\n  if (shouldSendUpdate && sendUpdate) {\r\n    sendUpdate();\r\n  }\r\n}\r\n\r\nfunction mergeTokenWithCache(\r\n  token: ApiTokenWithPrice,\r\n  detailsBySlug: Record<string, ApiTokenDetails>,\r\n  cachedToken?: ApiTokenWithPrice,\r\n): ApiTokenWithPrice {\r\n  if (cachedToken) {\r\n    // Metadata from backend takes priority (e.g., image)\r\n    return {\r\n      ...omitUndefined(token.isFromBackend ? cachedToken : token),\r\n      ...omitUndefined(token.isFromBackend ? token : cachedToken),\r\n      priceUsd: token.priceUsd || cachedToken.priceUsd,\r\n      percentChange24h: token.percentChange24h || cachedToken.percentChange24h,\r\n    };\r\n  } else if (token.slug in detailsBySlug) {\r\n    return {\r\n      ...token,\r\n      ...detailsBySlug[token.slug],\r\n    };\r\n  } else {\r\n    return token;\r\n  }\r\n}\r\n\r\nexport function getTokensCache() {\r\n  return tokensCache;\r\n}\r\n\r\n/** Note that this function may return `undefined` if the token is not found (e.g. pTON) */\r\nexport function getTokenBySlug(slug: string): ApiTokenWithPrice | undefined {\r\n  return tokensCache.bySlug[slug];\r\n}\r\n\r\nexport function getTokenByAddress(tokenAddress: string) {\r\n  return getTokenBySlug(buildTokenSlug('ton', tokenAddress));\r\n}\r\n\r\nexport function sendUpdateTokens(onUpdate: OnApiUpdate) {\r\n  onUpdate({\r\n    type: 'updateTokens',\r\n    tokens: tokensCache.bySlug,\r\n  });\r\n}\r\n\r\nexport function buildTokenSlug(chain: ApiChain, address: string) {\r\n  const addressPart = address.replace(/[^a-z\\d]/gi, '').slice(0, 10);\r\n  return `${chain}-${addressPart}`.toLowerCase();\r\n}\r\n","import type { ApiNetwork, ApiWalletInfo } from '../../../types';\r\nimport type { ApiTonWalletVersion } from '../types';\r\nimport type { AccountState, AddressBook, MetadataMap, WalletState, WalletVersion } from './types';\r\n\r\nimport { TONCENTER_ACTIONS_VERSION } from '../../../../config';\r\nimport { buildTxId } from '../../../../util/activities';\r\nimport { fetchJson } from '../../../../util/fetch';\r\nimport { buildCollectionByKey, split } from '../../../../util/iteratees';\r\nimport { toRawAddress } from '../util/tonCore';\r\nimport { getEnvironment } from '../../../environment';\r\nimport { NETWORK_CONFIG } from '../constants';\r\n\r\nconst ADDRESS_BOOK_CHUNK_SIZE = 128;\r\nconst VERSION_MAP: Record<WalletVersion, ApiTonWalletVersion> = {\r\n  'wallet v1 r1': 'simpleR1',\r\n  'wallet v1 r2': 'simpleR2',\r\n  'wallet v1 r3': 'simpleR3',\r\n  'wallet v2 r1': 'v2R1',\r\n  'wallet v2 r2': 'v2R2',\r\n  'wallet v3 r1': 'v3R1',\r\n  'wallet v3 r2': 'v3R2',\r\n  // 'wallet v4 r1': '', // Not used in production, wrapper is missing\r\n  'wallet v4 r2': 'v4R2',\r\n  // 'wallet v5 beta': '', // Not used in production, wrapper is missing\r\n  'wallet v5 r1': 'W5',\r\n};\r\n\r\nexport async function fetchAddressBook(network: ApiNetwork, addresses: string[]): Promise<AddressBook> {\r\n  const chunks = split(addresses, ADDRESS_BOOK_CHUNK_SIZE);\r\n\r\n  const results = await Promise.all(chunks.map((chunk) => {\r\n    return callToncenterV3(network, '/addressBook', {\r\n      address: chunk,\r\n    });\r\n  }));\r\n\r\n  return results.reduce((acc, value) => {\r\n    return Object.assign(acc, value);\r\n  }, {} as AddressBook);\r\n}\r\n\r\nexport async function fixAddressFormat(network: ApiNetwork, address: string): Promise<string> {\r\n  const result: { address_book: Record<string, string> } = await callToncenterV3(network, '/addressBook', { address });\r\n  return result.address_book[address];\r\n}\r\n\r\n/**\r\n * The output dictionary is indexed by the input addresses.\r\n * Every input address is guaranteed to be a key of the dictionary.\r\n */\r\nexport async function getWalletInfos(network: ApiNetwork, addresses: string[]): Promise<Record<string, ApiWalletInfo>> {\r\n  const { wallets: states, address_book: addressBook } = await callToncenterV3<{\r\n    address_book: AddressBook;\r\n    wallets: WalletState[];\r\n  }>(network, '/walletStates', { address: addresses.join(',') });\r\n\r\n  const walletInfoByRawAddress = Object.fromEntries(states.map((state) => [\r\n    state.address.toLowerCase(),\r\n    buildWalletInfo(state, addressBook),\r\n  ]));\r\n\r\n  return Object.fromEntries(addresses.map((inputAddress) => {\r\n    const rawAddress = toRawAddress(inputAddress).toLowerCase();\r\n    return [\r\n      inputAddress,\r\n      walletInfoByRawAddress[rawAddress] ?? {\r\n        address: inputAddress,\r\n        balance: 0n,\r\n        isInitialized: false,\r\n        seqno: 0,\r\n      } satisfies ApiWalletInfo,\r\n    ];\r\n  }));\r\n}\r\n\r\nfunction buildWalletInfo(state: WalletState, addressBook: AddressBook): ApiWalletInfo {\r\n  return {\r\n    address: addressBook[state.address].user_friendly,\r\n    version: 'wallet_type' in state ? VERSION_MAP[state.wallet_type] : undefined,\r\n    balance: BigInt(state.balance),\r\n    isInitialized: state.status === 'active',\r\n    seqno: 'seqno' in state ? state.seqno : 0,\r\n    lastTxId: state.last_transaction_hash ? buildTxId(state.last_transaction_hash) : undefined,\r\n    domain: addressBook[state.address].domain ?? undefined,\r\n  };\r\n}\r\n\r\nexport async function getAccountStates(network: ApiNetwork, addresses: string[]) {\r\n  const { accounts: states } = await callToncenterV3<{\r\n    addressBook: AddressBook;\r\n    accounts: AccountState[];\r\n  }>(network, '/accountStates', { address: addresses.join(',') });\r\n\r\n  const addressByRaw = Object.fromEntries(addresses.map((address) => [toRawAddress(address), address]));\r\n  for (const state of states) {\r\n    state.address = addressByRaw[state.address.toLowerCase()];\r\n  }\r\n  return buildCollectionByKey(states, 'address');\r\n}\r\n\r\nexport function fetchMetadata(network: ApiNetwork, addresses: string[]): Promise<MetadataMap> {\r\n  return callToncenterV3<MetadataMap>(network, '/metadata', { address: addresses.join(',') });\r\n}\r\n\r\nexport function callToncenterV3<T = any>(network: ApiNetwork, path: string, data?: AnyLiteral) {\r\n  const url = `${NETWORK_CONFIG[network].toncenterUrl}/api/v3${path}`;\r\n\r\n  return fetchJson(url, data, {\r\n    headers: getToncenterHeaders(network),\r\n  }) as Promise<T>;\r\n}\r\n\r\nexport function getToncenterHeaders(network: ApiNetwork) {\r\n  const { apiHeaders, byNetwork } = getEnvironment();\r\n  const apiKey = byNetwork[network].toncenterKey;\r\n\r\n  return {\r\n    ...apiHeaders,\r\n    ...(apiKey && { 'X-Api-Key': apiKey }),\r\n    //'X-Actions-Version': TONCENTER_ACTIONS_VERSION,\r\n  };\r\n}\r\n","import { Api, HttpClient } from 'tonapi-sdk-js';\r\n\r\nimport type { ApiNetwork } from '../../../types';\r\n\r\nimport { fetchWithRetry } from '../../../../util/fetch';\r\nimport withCache from '../../../../util/withCache';\r\nimport { getEnvironment } from '../../../environment';\r\nimport { NETWORK_CONFIG } from '../constants';\r\n\r\nconst MAX_LIMIT = 500;\r\nconst EVENTS_LIMIT = 100;\r\n\r\nconst getApi = withCache((network: ApiNetwork) => {\r\n  const headers = {\r\n    ...getEnvironment().apiHeaders,\r\n    'Content-Type': 'application/json',\r\n  };\r\n\r\n  return new Api(new HttpClient({\r\n    baseUrl: NETWORK_CONFIG[network].tonApiIoUrl,\r\n    baseApiParams: { headers },\r\n    customFetch: fetchWithRetry as typeof fetch,\r\n  }));\r\n});\r\n\r\nexport async function fetchJettonBalances(network: ApiNetwork, account: string) {\r\n  return (await getApi(network).accounts.getAccountJettonsBalances(account, {\r\n    supported_extensions: ['custom_payload'],\r\n  })).balances;\r\n}\r\n\r\nexport async function fetchNftItems(network: ApiNetwork, addresses: string[]) {\r\n  return (await getApi(network).nft.getNftItemsByAddresses({\r\n    account_ids: addresses,\r\n  })).nft_items;\r\n}\r\n\r\nexport async function fetchAccountNfts(network: ApiNetwork, address: string, options?: {\r\n  collectionAddress?: string;\r\n  offset?: number;\r\n  limit?: number;\r\n}) {\r\n  const { collectionAddress, offset, limit } = options ?? {};\r\n\r\n  return (await getApi(network).accounts.getAccountNftItems(\r\n    address,\r\n    {\r\n      offset: offset ?? 0,\r\n      limit: limit ?? MAX_LIMIT,\r\n      indirect_ownership: true,\r\n      collection: collectionAddress,\r\n    },\r\n  )).nft_items;\r\n}\r\n\r\nexport function fetchNftByAddress(network: ApiNetwork, nftAddress: string) {\r\n  return getApi(network).nft.getNftItemByAddress(nftAddress);\r\n}\r\n\r\nexport async function fetchAccountEvents(network: ApiNetwork, address: string, fromSec: number, limit?: number) {\r\n  return (await getApi(network).accounts.getAccountEvents(address, {\r\n    limit: limit ?? EVENTS_LIMIT,\r\n    start_date: fromSec,\r\n  })).events;\r\n}\r\n","import type { NftItem } from 'tonapi-sdk-js';\r\nimport type { DictionaryValue } from '@ton/core';\r\nimport { BitReader } from '@ton/core/dist/boc/BitReader';\r\nimport { BitString } from '@ton/core/dist/boc/BitString';\r\nimport { Builder } from '@ton/core/dist/boc/Builder';\r\nimport { Cell } from '@ton/core/dist/boc/Cell';\r\nimport { Slice } from '@ton/core/dist/boc/Slice';\r\nimport { Dictionary } from '@ton/core/dist/dict/Dictionary';\r\n\r\nimport type {\r\n  ApiActivity,\r\n  ApiMtwCardBorderShineType,\r\n  ApiMtwCardTextType,\r\n  ApiMtwCardType,\r\n  ApiNetwork,\r\n  ApiNft,\r\n  ApiNftAttribute,\r\n  ApiNftMetadata,\r\n  ApiNftSuperCollection,\r\n  ApiParsedPayload,\r\n} from '../../../types';\r\nimport type { JettonMetadata } from '../types';\r\n\r\nimport {\r\n  DEBUG,\r\n  LIQUID_JETTON,\r\n  MTW_CARDS_COLLECTION,\r\n  NFT_FRAGMENT_COLLECTIONS,\r\n  NFT_FRAGMENT_GIFT_IMAGE_TO_URL_REGEX,\r\n  TELEGRAM_GIFTS_SUPER_COLLECTION,\r\n} from '../../../../config';\r\nimport { fetchJsonWithProxy, fixIpfsUrl, getProxiedLottieUrl } from '../../../../util/fetch';\r\nimport isEmptyObject from '../../../../util/isEmptyObject';\r\nimport { omitUndefined, pick, range } from '../../../../util/iteratees';\r\nimport { logDebugError } from '../../../../util/logs';\r\nimport {\r\n  checkHasScamLink,\r\n  checkIsTrustedCollection,\r\n  getNftSuperCollectionsByCollectionAddress,\r\n} from '../../../common/addresses';\r\nimport { buildTokenSlug } from '../../../common/tokens';\r\nimport { base64ToString, sha256 } from '../../../common/utils';\r\nimport { DnsCategory, JettonStakingOpCode } from '../constants';\r\nimport {\r\n  DNS_CATEGORY_HASH_MAP,\r\n  DnsOpCode,\r\n  JettonOpCode,\r\n  LiquidStakingOpCode,\r\n  NftOpCode,\r\n  OpCode,\r\n  OtherOpCode,\r\n  SingleNominatorOpCode,\r\n  VestingV1OpCode,\r\n} from '../constants';\r\nimport { fixAddressFormat } from '../toncenter/other';\r\nimport { fetchNftItems } from './tonapiio';\r\nimport {\r\n  getDnsItemDomain, getJettonMinterData, resolveTokenAddress, toBase64Address,\r\n} from './tonCore';\r\n\r\ntype OpCodes = OpCode | JettonOpCode | NftOpCode | LiquidStakingOpCode | VestingV1OpCode | SingleNominatorOpCode\r\n  | DnsOpCode | OtherOpCode | JettonStakingOpCode;\r\n\r\nconst OFFCHAIN_CONTENT_PREFIX = 0x01;\r\nconst SNAKE_PREFIX = 0x00;\r\n\r\nexport function fixBase64ImageData(data: string) {\r\n  const decodedData = base64ToString(data);\r\n  if (decodedData.includes('<svg')) {\r\n    return `data:image/svg+xml;base64,${data}`;\r\n  }\r\n  return `data:image/png;base64,${data}`;\r\n}\r\n\r\nconst dictSnakeBufferValue: DictionaryValue<Buffer> = {\r\n  parse: (slice) => {\r\n    const buffer = Buffer.from('');\r\n\r\n    const sliceToVal = (s: Slice, v: Buffer, isFirst: boolean) => {\r\n      if (isFirst && s.loadUint(8) !== SNAKE_PREFIX) {\r\n        throw new Error('Only snake format is supported');\r\n      }\r\n\r\n      v = Buffer.concat([v, s.loadBuffer(s.remainingBits / 8)]);\r\n      if (s.remainingRefs === 1) {\r\n        v = sliceToVal(s.loadRef().beginParse(), v, false);\r\n      }\r\n\r\n      return v;\r\n    };\r\n\r\n    return sliceToVal(slice.loadRef().beginParse() as any, buffer, true);\r\n  },\r\n  serialize: () => {\r\n    // pass\r\n  },\r\n};\r\n\r\nconst jettonOnChainMetadataSpec: {\r\n  [key in keyof JettonMetadata]: 'utf8' | 'ascii' | undefined;\r\n} = {\r\n  uri: 'ascii',\r\n  name: 'utf8',\r\n  description: 'utf8',\r\n  image: 'ascii',\r\n  symbol: 'utf8',\r\n  decimals: 'utf8',\r\n  custom_payload_api_uri: 'ascii',\r\n};\r\n\r\nexport async function fetchJettonMetadata(network: ApiNetwork, address: string) {\r\n  const { content } = await getJettonMinterData(network, address);\r\n\r\n  let metadata: JettonMetadata;\r\n\r\n  const slice = content.asSlice();\r\n  const prefix = slice.loadUint(8);\r\n\r\n  if (prefix === OFFCHAIN_CONTENT_PREFIX) {\r\n    const bytes = readSnakeBytes(slice);\r\n    const contentUri = bytes.toString('utf-8');\r\n    metadata = await fetchJettonOffchainMetadata(contentUri);\r\n  } else {\r\n    // On-chain content\r\n    metadata = await parseJettonOnchainMetadata(slice);\r\n    if (metadata.uri) {\r\n      // Semi-chain content\r\n      const offchainMetadata = await fetchJettonOffchainMetadata(metadata.uri);\r\n      metadata = { ...offchainMetadata, ...metadata };\r\n    }\r\n  }\r\n\r\n  return metadata;\r\n}\r\n\r\nexport async function parseJettonOnchainMetadata(slice: Slice): Promise<JettonMetadata> {\r\n  const dict = slice.loadDict(Dictionary.Keys.Buffer(32), dictSnakeBufferValue);\r\n\r\n  const res: { [s in keyof JettonMetadata]?: string } = {};\r\n\r\n  for (const [key, value] of Object.entries(jettonOnChainMetadataSpec)) {\r\n    const sha256Key = Buffer.from(await sha256(Buffer.from(key, 'ascii')));\r\n    const val = dict.get(sha256Key)?.toString(value);\r\n\r\n    if (val) {\r\n      res[key as keyof JettonMetadata] = val;\r\n    }\r\n  }\r\n\r\n  return res as JettonMetadata;\r\n}\r\n\r\nexport async function fetchJettonOffchainMetadata(uri: string): Promise<JettonMetadata> {\r\n  const metadata = await fetchJsonWithProxy(uri);\r\n  return pick(metadata, [\r\n    'name',\r\n    'description',\r\n    'symbol',\r\n    'decimals',\r\n    'image',\r\n    'image_data',\r\n    'custom_payload_api_uri',\r\n  ]);\r\n}\r\n\r\nexport async function parsePayloadBase64(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  base64: string,\r\n): Promise<ApiParsedPayload> {\r\n  const slice = dataToSlice(base64);\r\n  const result: ApiParsedPayload = { type: 'unknown', base64 };\r\n\r\n  if (!slice) return result;\r\n\r\n  return await parsePayloadSlice(network, address, slice, true) ?? result;\r\n}\r\n\r\nexport async function parsePayloadSlice(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  slice: Slice,\r\n  shouldLoadItems?: boolean,\r\n  transactionDebug?: ApiActivity,\r\n): Promise<ApiParsedPayload | undefined> {\r\n  let opCode: OpCodes | undefined;\r\n  try {\r\n    opCode = slice.loadUint(32);\r\n\r\n    if (opCode === OpCode.Comment) {\r\n      const buffer = readSnakeBytes(slice);\r\n      const comment = buffer.toString('utf-8');\r\n      return { type: 'comment', comment };\r\n    } else if (opCode === OpCode.Encrypted) {\r\n      const buffer = readSnakeBytes(slice);\r\n      const encryptedComment = buffer.toString('base64');\r\n      return { type: 'encrypted-comment', encryptedComment };\r\n    } else if (slice.remainingBits < 64) {\r\n      return undefined;\r\n    }\r\n\r\n    const queryId = slice.loadUintBig(64);\r\n\r\n    switch (opCode) {\r\n      case JettonOpCode.Transfer: {\r\n        const tokenAddress = await resolveTokenAddress(network, address).catch(() => '');\r\n        const slug = buildTokenSlug('ton', tokenAddress);\r\n\r\n        const amount = slice.loadCoins();\r\n        const destination = slice.loadAddress();\r\n        const responseDestination = slice.loadMaybeAddress();\r\n\r\n        if (!responseDestination) {\r\n          return {\r\n            type: 'tokens:transfer-non-standard',\r\n            queryId,\r\n            destination: toBase64Address(destination, undefined, network),\r\n            amount,\r\n            slug,\r\n          };\r\n        }\r\n\r\n        const customPayload = slice.loadMaybeRef();\r\n        const forwardAmount = slice.loadCoins();\r\n        let forwardPayload = slice.loadMaybeRef();\r\n        let forwardPayloadOpCode: number | undefined;\r\n\r\n        if (!forwardPayload && slice.remainingBits) {\r\n          const builder = new Builder().storeBits(slice.loadBits(slice.remainingBits));\r\n          range(0, slice.remainingRefs).forEach(() => {\r\n            builder.storeRef(slice.loadRef());\r\n          });\r\n          forwardPayload = builder.endCell();\r\n        }\r\n\r\n        if (forwardPayload) {\r\n          const forwardPayloadSlice = forwardPayload.beginParse();\r\n          if (forwardPayloadSlice.remainingBits > 32) {\r\n            forwardPayloadOpCode = forwardPayloadSlice.loadUint(32);\r\n          }\r\n        }\r\n\r\n        return {\r\n          type: 'tokens:transfer',\r\n          queryId,\r\n          amount,\r\n          destination: toBase64Address(destination, undefined, network),\r\n          responseDestination: toBase64Address(responseDestination, undefined, network),\r\n          customPayload: customPayload?.toBoc().toString('base64'),\r\n          forwardAmount,\r\n          forwardPayload: forwardPayload?.toBoc().toString('base64'),\r\n          forwardPayloadOpCode,\r\n          slug,\r\n          tokenAddress,\r\n        };\r\n      }\r\n      case NftOpCode.TransferOwnership: {\r\n        const newOwner = slice.loadAddress();\r\n        const responseDestination = slice.loadAddress();\r\n        const customPayload = slice.loadMaybeRef();\r\n        const forwardAmount = slice.loadCoins();\r\n        const forwardPayload = readForwardPayloadCell(slice);\r\n        const comment = forwardPayload ? readComment(forwardPayload.asSlice()) : undefined;\r\n\r\n        let nft: ApiNft | undefined;\r\n        if (shouldLoadItems) {\r\n          const nftSuperCollectionsByCollectionAddress = await getNftSuperCollectionsByCollectionAddress();\r\n          const [rawNft] = await fetchNftItems(network, [address]);\r\n          if (rawNft) {\r\n            nft = parseTonapiioNft(network, rawNft, nftSuperCollectionsByCollectionAddress);\r\n          }\r\n        }\r\n\r\n        return {\r\n          type: 'nft:transfer',\r\n          queryId,\r\n          newOwner: toBase64Address(newOwner, undefined, network),\r\n          responseDestination: toBase64Address(responseDestination, undefined, network),\r\n          customPayload: customPayload?.toBoc().toString('base64'),\r\n          forwardAmount,\r\n          forwardPayload: forwardPayload?.toBoc().toString('base64'),\r\n          nftAddress: address,\r\n          nftName: nft?.name,\r\n          nft,\r\n          comment,\r\n        };\r\n      }\r\n      case NftOpCode.OwnershipAssigned: {\r\n        const prevOwner = slice.loadAddress();\r\n        const forwardPayload = readForwardPayloadCell(slice);\r\n        const comment = forwardPayload ? readComment(forwardPayload.asSlice()) : undefined;\r\n\r\n        let nft: ApiNft | undefined;\r\n        if (shouldLoadItems) {\r\n          const nftSuperCollectionsByCollectionAddress = await getNftSuperCollectionsByCollectionAddress();\r\n          const [rawNft] = await fetchNftItems(network, [address]);\r\n          if (rawNft) {\r\n            nft = parseTonapiioNft(network, rawNft, nftSuperCollectionsByCollectionAddress);\r\n          }\r\n        }\r\n\r\n        return {\r\n          type: 'nft:ownership-assigned',\r\n          queryId,\r\n          prevOwner: toBase64Address(prevOwner, undefined, network),\r\n          comment,\r\n          nftAddress: address,\r\n          nft,\r\n        };\r\n      }\r\n      case JettonOpCode.Burn: {\r\n        const tokenAddress = await resolveTokenAddress(network, address);\r\n        const slug = buildTokenSlug('ton', tokenAddress);\r\n\r\n        const amount = slice.loadCoins();\r\n        const addressObj = slice.loadAddress();\r\n        const customPayload = slice.loadMaybeRef();\r\n        const isLiquidUnstakeRequest = tokenAddress === LIQUID_JETTON;\r\n\r\n        return {\r\n          type: 'tokens:burn',\r\n          queryId,\r\n          amount,\r\n          address: toBase64Address(addressObj, undefined, network),\r\n          customPayload: customPayload?.toBoc().toString('base64'),\r\n          slug,\r\n          isLiquidUnstakeRequest,\r\n        };\r\n      }\r\n      case LiquidStakingOpCode.DistributedAsset: {\r\n        return {\r\n          type: 'liquid-staking:withdrawal-nft',\r\n          queryId,\r\n        };\r\n      }\r\n      case LiquidStakingOpCode.Withdrawal: {\r\n        return {\r\n          type: 'liquid-staking:withdrawal',\r\n          queryId,\r\n        };\r\n      }\r\n      case LiquidStakingOpCode.Deposit: {\r\n        let appId: bigint | undefined;\r\n        if (slice.remainingBits > 0) {\r\n          appId = slice.loadUintBig(64);\r\n        }\r\n        return {\r\n          type: 'liquid-staking:deposit',\r\n          queryId,\r\n          appId,\r\n        };\r\n      }\r\n      case VestingV1OpCode.AddWhitelist: {\r\n        const toAddress = slice.loadAddress();\r\n        const addressString = shouldLoadItems\r\n          ? await fixAddressFormat(network, toAddress.toRawString())\r\n          : '';\r\n\r\n        return {\r\n          type: 'vesting:add-whitelist',\r\n          queryId,\r\n          address: addressString,\r\n        };\r\n      }\r\n      case SingleNominatorOpCode.Withdraw: {\r\n        const amount = slice.loadCoins();\r\n        return {\r\n          type: 'single-nominator:withdraw',\r\n          queryId,\r\n          amount,\r\n        };\r\n      }\r\n      case SingleNominatorOpCode.ChangeValidator: {\r\n        const toAddress = slice.loadAddress();\r\n        const addressString = shouldLoadItems\r\n          ? await fixAddressFormat(network, toAddress.toRawString())\r\n          : '';\r\n\r\n        return {\r\n          type: 'single-nominator:change-validator',\r\n          queryId,\r\n          address: addressString,\r\n        };\r\n      }\r\n      case LiquidStakingOpCode.Vote: {\r\n        const votingAddress = slice.loadAddress();\r\n        const expirationDate = slice.loadUint(48);\r\n        const vote = slice.loadBit();\r\n        const needConfirmation = slice.loadBit();\r\n\r\n        return {\r\n          type: 'liquid-staking:vote',\r\n          queryId,\r\n          votingAddress: toBase64Address(votingAddress, true),\r\n          expirationDate,\r\n          vote,\r\n          needConfirmation,\r\n        };\r\n      }\r\n      case DnsOpCode.ChangeRecord: {\r\n        const hash = slice.loadBuffer(32).toString('hex');\r\n        const category = Object.entries(DNS_CATEGORY_HASH_MAP)\r\n          .find(([, value]) => hash === value)?.[0] as DnsCategory ?? 'unknown';\r\n        const toAddress = slice.loadAddress();\r\n        const domain = shouldLoadItems\r\n          ? await getDnsItemDomain(network, toAddress)\r\n          : '';\r\n\r\n        if (category === DnsCategory.Wallet) {\r\n          if (slice.remainingRefs > 0) {\r\n            const dataSlice = slice.loadRef().beginParse();\r\n            slice.endParse();\r\n\r\n            const dataAddress = dataSlice.loadAddress();\r\n            const flags = dataSlice.loadUint(8);\r\n\r\n            const addressString = shouldLoadItems\r\n              ? await fixAddressFormat(network, dataAddress.toRawString())\r\n              : '';\r\n\r\n            return {\r\n              type: 'dns:change-record',\r\n              queryId,\r\n              record: {\r\n                type: 'wallet',\r\n                value: addressString,\r\n                flags,\r\n              },\r\n              domain,\r\n            };\r\n          } else {\r\n            return {\r\n              type: 'dns:change-record',\r\n              queryId,\r\n              record: {\r\n                type: 'wallet',\r\n                value: undefined,\r\n              },\r\n              domain,\r\n            };\r\n          }\r\n        } else if (slice.remainingRefs > 0) {\r\n          const value = slice.loadRef();\r\n          return {\r\n            type: 'dns:change-record',\r\n            queryId,\r\n            record: category === DnsCategory.Unknown ? {\r\n              type: 'unknown',\r\n              key: hash,\r\n              value: value.toBoc().toString('base64'),\r\n            } : {\r\n              type: category,\r\n              value: value.toBoc().toString('base64'),\r\n            },\r\n            domain,\r\n          };\r\n        } else {\r\n          return {\r\n            type: 'dns:change-record',\r\n            queryId,\r\n            record: category === DnsCategory.Unknown ? {\r\n              type: 'unknown',\r\n              key: hash,\r\n            } : {\r\n              type: category,\r\n            },\r\n            domain,\r\n          };\r\n        }\r\n      }\r\n      case OtherOpCode.TokenBridgePaySwap: {\r\n        const swapId = slice.loadBuffer(32).toString('hex');\r\n        return {\r\n          type: 'token-bridge:pay-swap',\r\n          queryId,\r\n          swapId,\r\n        };\r\n      }\r\n      case JettonStakingOpCode.UnstakeRequest: {\r\n        const amount = slice.loadCoins();\r\n        const isForce = slice.loadBoolean();\r\n        return {\r\n          type: 'jetton-staking:unstake',\r\n          queryId,\r\n          amount,\r\n          isForce,\r\n        };\r\n      }\r\n    }\r\n  } catch (err) {\r\n    if (DEBUG) {\r\n      const debugTxString = transactionDebug\r\n        && `${transactionDebug.id} ${new Date(transactionDebug.timestamp).toISOString()}`;\r\n      const opCodeHex = `0x${opCode?.toString(16).padStart(8, '0')}`;\r\n      logDebugError('parsePayload', opCodeHex, debugTxString, '\\n', err);\r\n    }\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nfunction dataToSlice(data: string | Buffer | Uint8Array): Slice {\r\n  let buffer: Buffer;\r\n  if (typeof data === 'string') {\r\n    buffer = Buffer.from(data, 'base64');\r\n  } else if (data instanceof Buffer) {\r\n    buffer = data;\r\n  } else {\r\n    buffer = Buffer.from(data);\r\n  }\r\n\r\n  try {\r\n    return Cell.fromBoc(buffer)[0].beginParse();\r\n  } catch (err: any) {\r\n    if (err?.message !== 'Invalid magic') {\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  return new Slice(new BitReader(new BitString(buffer, 0, buffer.length * 8)), []);\r\n}\r\n\r\nexport function readComment(slice: Slice) {\r\n  if (slice.remainingBits < 32) {\r\n    return undefined;\r\n  }\r\n\r\n  const opCode = slice.loadUint(32) as OpCode;\r\n  if (opCode !== OpCode.Comment || (!slice.remainingBits && !slice.remainingRefs)) {\r\n    return undefined;\r\n  }\r\n\r\n  const buffer = readSnakeBytes(slice);\r\n  return buffer.toString('utf-8');\r\n}\r\n\r\nfunction readForwardPayloadCell(slice: Slice) {\r\n  let forwardPayload = slice.loadBit() && slice.remainingRefs ? slice.loadRef() : undefined;\r\n\r\n  if (!forwardPayload && slice.remainingBits) {\r\n    const builder = new Builder().storeBits(slice.loadBits(slice.remainingBits));\r\n    range(0, slice.remainingRefs).forEach(() => {\r\n      builder.storeRef(slice.loadRef());\r\n    });\r\n    forwardPayload = builder.endCell();\r\n  }\r\n\r\n  return forwardPayload ?? undefined;\r\n}\r\n\r\nexport function readSnakeBytes(slice: Slice) {\r\n  let buffer = Buffer.alloc(0);\r\n\r\n  while (slice.remainingBits >= 8) {\r\n    buffer = Buffer.concat([buffer, slice.loadBuffer(slice.remainingBits / 8)]);\r\n    if (slice.remainingRefs) {\r\n      slice = slice.loadRef().beginParse();\r\n    } else {\r\n      break;\r\n    }\r\n  }\r\n\r\n  return buffer;\r\n}\r\n\r\nexport function buildMtwCardsNftMetadata(metadata: {\r\n  image?: string;\r\n  id?: number;\r\n  attributes?: ApiNftAttribute[];\r\n}): ApiNftMetadata | undefined {\r\n  const { id, image, attributes } = metadata;\r\n\r\n  let mtwCardType: ApiMtwCardType | undefined;\r\n  let mtwCardTextType: ApiMtwCardTextType | undefined;\r\n  let result: ApiNftMetadata = {};\r\n  if (image) result.imageUrl = image;\r\n  if (id !== undefined) result.mtwCardId = id;\r\n\r\n  if (attributes && Array.isArray(attributes) && attributes.length) {\r\n    mtwCardType = attributes\r\n      .find((attribute) => attribute.trait_type === 'Card Type')?.value\r\n      // Clean non-ascii characters with regex\r\n      .replace(/[^\\x20-\\x7E]/g, '')\r\n      .trim()\r\n      .toLowerCase() as ApiMtwCardType;\r\n\r\n    if (mtwCardType) {\r\n      mtwCardTextType = attributes\r\n        .find((attribute) => attribute.trait_type === 'Text')?.value\r\n        .toLowerCase() as ApiMtwCardTextType;\r\n\r\n      result.mtwCardType = mtwCardType;\r\n      if (mtwCardType === 'standard') {\r\n        result.mtwCardBorderShineType = attributes\r\n          .find((attribute) => attribute.trait_type === 'Shine')?.value\r\n          .toLowerCase() as ApiMtwCardBorderShineType;\r\n      }\r\n\r\n      if (mtwCardTextType === 'dark' || mtwCardType === 'silver') {\r\n        result.mtwCardTextType = 'dark';\r\n      } else {\r\n        result.mtwCardTextType = 'light';\r\n      }\r\n\r\n      result = omitUndefined(result);\r\n    }\r\n  }\r\n\r\n  return !isEmptyObject(result) ? result : undefined;\r\n}\r\n\r\nexport function parseTonapiioNft(\r\n  network: ApiNetwork,\r\n  rawNft: NftItem,\r\n  nftSuperCollectionsByCollectionAddress: Record<string, ApiNftSuperCollection>,\r\n): ApiNft | undefined {\r\n  if (!rawNft.metadata) {\r\n    return undefined;\r\n  }\r\n\r\n  try {\r\n    const {\r\n      address,\r\n      index,\r\n      collection,\r\n      metadata: rawMetadata,\r\n      previews,\r\n      sale,\r\n      trust,\r\n      owner,\r\n    } = rawNft;\r\n\r\n    const {\r\n      name, image, description, render_type: renderType, attributes, lottie,\r\n    } = rawMetadata as {\r\n      name?: string;\r\n      image?: string;\r\n      description?: string;\r\n      render_type?: string;\r\n      attributes?: {\r\n        trait_type: string;\r\n        value: string;\r\n      }[];\r\n      lottie?: string;\r\n    };\r\n\r\n    const collectionAddress = collection && toBase64Address(collection.address, true, network);\r\n    let hasScamLink = false;\r\n\r\n    if (!collectionAddress || !checkIsTrustedCollection(collectionAddress)) {\r\n      for (const text of [name, description].filter(Boolean)) {\r\n        if (checkHasScamLink(text)) {\r\n          hasScamLink = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-enum-comparison\r\n    const isWhitelisted = trust === 'whitelist';\r\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-enum-comparison\r\n    const isScam = hasScamLink || description === 'SCAM' || trust === 'blacklist';\r\n    const isHidden = renderType === 'hidden' || isScam;\r\n    const imageFromPreview = previews!.find((x) => x.resolution === '1500x1500')!.url;\r\n    const isFragmentGift = getIsFragmentGift(nftSuperCollectionsByCollectionAddress, collectionAddress);\r\n\r\n    const metadata = {\r\n      ...(Array.isArray(attributes) && { attributes }),\r\n      ...(isWhitelisted && lottie && { lottie: getProxiedLottieUrl(lottie) }),\r\n      ...(collectionAddress === MTW_CARDS_COLLECTION && buildMtwCardsNftMetadata(rawMetadata)),\r\n      ...(isFragmentGift && { fragmentUrl: image!.replace(NFT_FRAGMENT_GIFT_IMAGE_TO_URL_REGEX, 'https://$1') }),\r\n    };\r\n\r\n    return omitUndefined<ApiNft>({\r\n      index,\r\n      name,\r\n      ownerAddress: owner ? toBase64Address(owner.address, false, network) : undefined,\r\n      address: toBase64Address(address, true, network),\r\n      image: fixIpfsUrl(imageFromPreview || image || ''),\r\n      thumbnail: previews!.find((x) => x.resolution === '500x500')!.url,\r\n      isOnSale: Boolean(sale),\r\n      isHidden,\r\n      isScam,\r\n      description,\r\n      ...(collection && {\r\n        collectionAddress,\r\n        collectionName: collection.name,\r\n        isOnFragment: isFragmentGift || NFT_FRAGMENT_COLLECTIONS.includes(collection.address),\r\n        isTelegramGift: isFragmentGift,\r\n      }),\r\n      metadata,\r\n    });\r\n  } catch (err) {\r\n    logDebugError('buildNft', err);\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport function getIsFragmentGift(\r\n  nftSuperCollectionsByCollectionAddress: Record<string, ApiNftSuperCollection>,\r\n  collectionAddress?: string,\r\n) {\r\n  return collectionAddress\r\n    ? nftSuperCollectionsByCollectionAddress[collectionAddress]?.id === TELEGRAM_GIFTS_SUPER_COLLECTION\r\n    : false;\r\n}\r\n","export function areDeepEqual<T>(value1: T, value2: T): boolean {\r\n  const type1 = typeof value1;\r\n  const type2 = typeof value2;\r\n  if (type1 !== type2) {\r\n    return false;\r\n  }\r\n\r\n  // eslint-disable-next-line no-null/no-null\r\n  if (type1 !== 'object' || value1 === null || value2 === null) {\r\n    return value1 === value2;\r\n  }\r\n\r\n  const isArray1 = Array.isArray(value1);\r\n  const isArray2 = Array.isArray(value2);\r\n\r\n  if (isArray1 !== isArray2) {\r\n    return false;\r\n  }\r\n\r\n  if (isArray1) {\r\n    const array1 = value1 as any[];\r\n    const array2 = value2 as any[];\r\n\r\n    if (array1.length !== array2.length) {\r\n      return false;\r\n    }\r\n\r\n    return array1.every((member1, i) => areDeepEqual(member1, array2[i]));\r\n  }\r\n\r\n  const object1 = value1 as AnyLiteral;\r\n  const object2 = value2 as AnyLiteral;\r\n  const keys1 = Object.keys(object1);\r\n  const keys2 = Object.keys(object2);\r\n\r\n  if (!keys1.every((key1) => object2.hasOwnProperty(key1))) {\r\n    return false;\r\n  }\r\n  if (!keys2.every((key2) => object1.hasOwnProperty(key2))) {\r\n    return false;\r\n  }\r\n\r\n  return keys1.every((key1) => areDeepEqual(object1[key1], object2[key1]));\r\n}\r\n","import type { ApiDapp, ApiDappRequest } from '../api/types';\r\n\r\nexport function getDappConnectionUniqueId(request: ApiDappRequest | ApiDapp): string {\r\n  return (request as any).sseOptions?.appClientId ?? (request as any).sse?.appClientId ?? 'jsbridge';\r\n}\r\n","import type * as tonSdk from '../chains/ton';\r\nimport type { ApiDbSseConnection } from '../db';\r\nimport type { StorageKey } from '../storages/types';\r\nimport type {\r\n  ApiActivity,\r\n  ApiDappsState,\r\n  ApiLocalTransactionParams,\r\n  ApiTonAccount,\r\n  ApiTonWallet,\r\n  ApiTransactionActivity,\r\n  OnApiUpdate,\r\n} from '../types';\r\n\r\nimport {\r\n  IS_CAPACITOR, IS_CORE_WALLET, IS_EXTENSION, MAIN_ACCOUNT_ID,\r\n} from '../../config';\r\nimport { parseAccountId } from '../../util/account';\r\nimport { buildLocalTxId } from '../../util/activities';\r\nimport { areDeepEqual } from '../../util/areDeepEqual';\r\nimport { assert } from '../../util/assert';\r\nimport { logDebugError } from '../../util/logs';\r\nimport { toBase64Address } from '../chains/ton/util/tonCore';\r\nimport { getEnvironment } from '../environment';\r\nimport * as migrations from '../migrations';\r\nimport { storage } from '../storages';\r\nimport capacitorStorage from '../storages/capacitorStorage';\r\nimport idbStorage from '../storages/idb';\r\nimport localStorage from '../storages/localStorage';\r\nimport {\r\n  checkHasScamLink,\r\n  checkHasTelegramBotMention,\r\n  getKnownAddresses,\r\n  getScamMarkers,\r\n} from './addresses';\r\nimport { hexToBytes } from './utils';\r\n\r\nconst actualStateVersion = 21;\r\nlet migrationEnsurePromise: Promise<void>;\r\n\r\nexport function buildLocalTransaction(\r\n  params: ApiLocalTransactionParams,\r\n  normalizedAddress: string,\r\n  subId?: number,\r\n): ApiTransactionActivity {\r\n  const id = buildLocalTxId(params.id, subId);\r\n\r\n  return updateActivityMetadata({\r\n    // Local transactions are trusted pending\r\n    status: 'pendingTrusted',\r\n    kind: 'transaction',\r\n    timestamp: Date.now(),\r\n    isIncoming: false,\r\n    normalizedAddress,\r\n    ...params,\r\n    amount: -params.amount,\r\n    id,\r\n  });\r\n}\r\n\r\nexport function updateActivityMetadata<T extends ApiActivity>(activity: T): T {\r\n  if (activity.kind !== 'transaction') {\r\n    return activity;\r\n  }\r\n\r\n  const {\r\n    normalizedAddress, comment, isIncoming, nft,\r\n  } = activity;\r\n  let { metadata = {} } = activity;\r\n\r\n  const isNftTransfer = Boolean(nft);\r\n  const knownAddresses = getKnownAddresses();\r\n  const hasScamMarkers = comment ? getScamMarkers().some((sm) => sm.test(comment)) : false;\r\n  const shouldCheckComment = !hasScamMarkers && comment && isIncoming\r\n    && (isNftTransfer || comment.toLowerCase().includes('claim'));\r\n  const hasScamInComment = shouldCheckComment\r\n    ? (checkHasScamLink(comment) || checkHasTelegramBotMention(comment))\r\n    : false;\r\n\r\n  if (normalizedAddress in knownAddresses) {\r\n    metadata = { ...metadata, ...knownAddresses[normalizedAddress] };\r\n  }\r\n\r\n  if (hasScamMarkers || hasScamInComment) {\r\n    metadata.isScam = true;\r\n  }\r\n\r\n  return { ...activity, metadata };\r\n}\r\n\r\nlet currentOnUpdate: OnApiUpdate | undefined;\r\n\r\nexport function connectUpdater(onUpdate: OnApiUpdate) {\r\n  currentOnUpdate = onUpdate;\r\n}\r\n\r\nexport function disconnectUpdater() {\r\n  currentOnUpdate = undefined;\r\n}\r\n\r\nexport function isUpdaterAlive(onUpdate: OnApiUpdate) {\r\n  return currentOnUpdate === onUpdate;\r\n}\r\n\r\nexport function startStorageMigration(onUpdate: OnApiUpdate, ton: typeof tonSdk, accountIds?: string[]) {\r\n  migrationEnsurePromise = migrateStorage(onUpdate, ton, accountIds)\r\n    .catch((err) => {\r\n      logDebugError('Migration error', err);\r\n      currentOnUpdate?.({\r\n        type: 'showError',\r\n        error: 'Migration error',\r\n      });\r\n    });\r\n  return migrationEnsurePromise;\r\n}\r\n\r\nexport function waitStorageMigration() {\r\n  return migrationEnsurePromise;\r\n}\r\n\r\nexport async function migrateStorage(onUpdate: OnApiUpdate, ton: typeof tonSdk, accountIds?: string[]) {\r\n  let version = Number(await storage.getItem('stateVersion', true));\r\n\r\n  if (version === actualStateVersion) {\r\n    return;\r\n  }\r\n\r\n  if (IS_CORE_WALLET && !version) {\r\n    await migrateCoreWallet(onUpdate);\r\n  }\r\n\r\n  if (IS_CAPACITOR && !version) {\r\n    if (await storage.getItem('accounts' as StorageKey, true)) {\r\n      // Fix broken version\r\n      version = 10;\r\n    } else {\r\n      // Prepare for migration to secure storage\r\n      const idbVersion = await idbStorage.getItem('stateVersion');\r\n      if (idbVersion) {\r\n        version = Number(idbVersion);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Migration to chrome.storage\r\n  if (IS_EXTENSION && !version && !(await storage.getItem('addresses' as StorageKey))) {\r\n    version = await idbStorage.getItem('stateVersion');\r\n\r\n    if (version) {\r\n      // Switching from IndexedDB to `chrome.storage.local`\r\n      const idbData = await idbStorage.getAll!();\r\n      await storage.setMany!(idbData);\r\n    }\r\n  }\r\n\r\n  if (!version) {\r\n    await storage.setItem('stateVersion', actualStateVersion);\r\n    return;\r\n  }\r\n\r\n  // First version (v1)\r\n  if (!version) {\r\n    // Support multi-accounts\r\n    const mnemonicEncrypted = await storage.getItem('mnemonicEncrypted' as StorageKey);\r\n    if (mnemonicEncrypted) {\r\n      await storage.setItem('mnemonicsEncrypted' as StorageKey, JSON.stringify({\r\n        [MAIN_ACCOUNT_ID]: mnemonicEncrypted,\r\n      }));\r\n      await storage.removeItem('mnemonicEncrypted' as StorageKey);\r\n    }\r\n\r\n    // Change accountId format ('0' -> '0-ton', '1-ton-mainnet' -> '1-ton')\r\n    if (!mnemonicEncrypted) {\r\n      for (const field of ['mnemonicsEncrypted', 'addresses', 'publicKeys'] as unknown as StorageKey[]) {\r\n        const raw = await storage.getItem(field);\r\n        if (!raw) continue;\r\n\r\n        const oldItem = JSON.parse(raw);\r\n\r\n        const newItem = Object.entries(oldItem).reduce((prevValue, [accountId, data]) => {\r\n          const [id, chain = 'ton'] = accountId.split('-');\r\n          const internalAccountId = [id, chain].join('-');\r\n          prevValue[internalAccountId] = data;\r\n          return prevValue;\r\n        }, {} as any);\r\n\r\n        await storage.setItem(field, JSON.stringify(newItem));\r\n      }\r\n    }\r\n\r\n    version = 1;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 1) {\r\n    const addresses = await storage.getItem('addresses' as StorageKey) as string | undefined;\r\n    if (addresses && addresses.includes('-undefined')) {\r\n      for (const field of ['mnemonicsEncrypted', 'addresses', 'publicKeys'] as unknown as StorageKey[]) {\r\n        const newValue = (await storage.getItem(field) as string).replace('-undefined', '-ton');\r\n        await storage.setItem(field, newValue);\r\n      }\r\n    }\r\n\r\n    version = 2;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version >= 2 && version <= 4) {\r\n    for (const key of ['addresses', 'mnemonicsEncrypted', 'publicKeys', 'dapps'] as StorageKey[]) {\r\n      const rawData = await storage.getItem(key);\r\n      if (typeof rawData === 'string') {\r\n        await storage.setItem(key, JSON.parse(rawData));\r\n      }\r\n    }\r\n\r\n    version = 5;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 5) {\r\n    const dapps = await storage.getItem('dapps') as ApiDappsState;\r\n    if (dapps) {\r\n      for (const accountDapps of Object.values(dapps)) {\r\n        for (const dapp of Object.values(accountDapps as Record<string, any>)) {\r\n          dapp.connectedAt = 1;\r\n        }\r\n      }\r\n      await storage.setItem('dapps', dapps);\r\n    }\r\n\r\n    version = 6;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 6) {\r\n    for (const key of ['addresses', 'mnemonicsEncrypted', 'publicKeys', 'accounts', 'dapps'] as StorageKey[]) {\r\n      let data = await storage.getItem(key) as AnyLiteral;\r\n      if (!data) continue;\r\n\r\n      data = Object.entries(data).reduce((byAccountId, [internalAccountId, accountData]) => {\r\n        const parsed = parseAccountId(internalAccountId);\r\n        const mainnetAccountId = buildOldAccountId({ ...parsed, network: 'mainnet' });\r\n        const testnetAccountId = buildOldAccountId({ ...parsed, network: 'testnet' });\r\n        return {\r\n          ...byAccountId,\r\n          [mainnetAccountId]: accountData,\r\n          [testnetAccountId]: accountData,\r\n        };\r\n      }, {} as AnyLiteral);\r\n\r\n      await storage.setItem(key, data);\r\n    }\r\n\r\n    version = 7;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 7) {\r\n    const addresses = (await storage.getItem('addresses' as StorageKey)) as Record<string, string> | undefined;\r\n\r\n    if (addresses) {\r\n      const publicKeys = (await storage.getItem('publicKeys' as StorageKey)) as Record<string, string>;\r\n      const accounts = (await storage.getItem('accounts') ?? {}) as Record<string, ApiTonWallet>;\r\n\r\n      for (const [accountId, oldAddress] of Object.entries(addresses)) {\r\n        const newAddress = toBase64Address(oldAddress, false);\r\n\r\n        accounts[accountId] = {\r\n          ...accounts[accountId],\r\n          address: newAddress,\r\n          publicKey: publicKeys[accountId],\r\n        };\r\n\r\n        onUpdate({\r\n          type: 'updateAccount',\r\n          accountId,\r\n          chain: 'ton',\r\n          address: newAddress,\r\n        });\r\n      }\r\n\r\n      await storage.setItem('accounts', accounts);\r\n\r\n      await storage.removeItem('addresses' as StorageKey);\r\n      await storage.removeItem('publicKeys' as StorageKey);\r\n    }\r\n\r\n    version = 8;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 8) {\r\n    if (getEnvironment().isSseSupported) {\r\n      const dapps = await storage.getItem('dapps') as ApiDappsState;\r\n\r\n      if (dapps) {\r\n        const items: ApiDbSseConnection[] = [];\r\n\r\n        for (const accountDapps of Object.values(dapps)) {\r\n          for (const dapp of Object.values(accountDapps as Record<string, any>)) {\r\n            if (dapp.sse?.appClientId) {\r\n              items.push({ clientId: dapp.sse?.appClientId });\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    version = 9;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 9) {\r\n    if (IS_CAPACITOR) {\r\n      const data = await idbStorage.getAll!();\r\n\r\n      for (const [key, value] of Object.entries(data)) {\r\n        await capacitorStorage.setItem(key as StorageKey, value);\r\n        const newValue = await capacitorStorage.getItem(key as StorageKey, true);\r\n\r\n        if (!areDeepEqual(value, newValue)) {\r\n          throw new Error('Migration error!');\r\n        }\r\n      }\r\n      await idbStorage.clear();\r\n    }\r\n\r\n    version = 10;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  let isIosKeychainModeMigrated = false;\r\n  if (getEnvironment().isIosApp && version >= 10 && version <= 13) {\r\n    await iosBackupAndMigrateKeychainMode();\r\n    isIosKeychainModeMigrated = true;\r\n  }\r\n\r\n  if (version === 10 || version === 11 || version === 12) {\r\n    const accounts: Record<string, {\r\n      publicKey: string;\r\n      address: string;\r\n      version?: string;\r\n    }> | undefined = await storage.getItem('accounts', true);\r\n\r\n    if (accounts) {\r\n      for (const account of Object.values(accounts)) {\r\n        const { publicKey, address, version: walletVersion } = account;\r\n\r\n        if (walletVersion || !publicKey) continue;\r\n\r\n        const publicKeyBytes = hexToBytes(publicKey);\r\n        const walletInfo = ton.pickWalletByAddress('mainnet', publicKeyBytes, address);\r\n\r\n        account.version = walletInfo.version;\r\n      }\r\n\r\n      await storage.setItem('accounts', accounts);\r\n    }\r\n\r\n    version = 13;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 13) {\r\n    const accounts: Record<string, {\r\n      publicKey: string;\r\n      address: string;\r\n      version?: string;\r\n    }> | undefined = await storage.getItem('accounts', true);\r\n\r\n    if (accounts) {\r\n      for (const [accountId, account] of Object.entries(accounts)) {\r\n        const { network } = parseAccountId(accountId);\r\n        if (network === 'testnet') {\r\n          account.address = toBase64Address(account.address, false, network);\r\n\r\n          onUpdate({\r\n            type: 'updateAccount',\r\n            accountId,\r\n            chain: 'ton',\r\n            address: account.address,\r\n          });\r\n        }\r\n      }\r\n\r\n      version = 14;\r\n      await storage.setItem('accounts', accounts);\r\n    }\r\n  }\r\n\r\n  if (version === 14 || version === 15) {\r\n    if (getEnvironment().isIosApp && !isIosKeychainModeMigrated) {\r\n      await iosBackupAndMigrateKeychainMode();\r\n    }\r\n\r\n    version = 16;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 16) {\r\n    await migrations.migration16.start();\r\n\r\n    version = 17;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 17) {\r\n    await migrations.migration17.start();\r\n\r\n    version = 18;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 18) {\r\n    await migrations.migration18.start(accountIds);\r\n\r\n    version = 19;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 19) {\r\n    await migrations.migration19.start();\r\n\r\n    version = 20;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n\r\n  if (version === 20) {\r\n    await migrations.migration20.start();\r\n\r\n    version = 21;\r\n    await storage.setItem('stateVersion', version);\r\n  }\r\n}\r\n\r\nfunction buildOldAccountId(account: { id: number; network: string }) {\r\n  const { id, network } = account;\r\n  return `${id}-ton-${network}`;\r\n}\r\n\r\nasync function iosBackupAndMigrateKeychainMode() {\r\n  const keys = await capacitorStorage.getKeys();\r\n\r\n  if (keys?.length) {\r\n    const items: [string, any][] = [];\r\n\r\n    for (const key of keys) {\r\n      if (key.startsWith('backup_')) {\r\n        continue;\r\n      }\r\n\r\n      const backupKey = `backup_${key}` as StorageKey;\r\n      const value = await capacitorStorage.getItem(key as StorageKey, true);\r\n\r\n      assert(value !== undefined, 'Empty value!');\r\n      await capacitorStorage.setItem(backupKey, value);\r\n      const backupValue = await capacitorStorage.getItem(backupKey);\r\n      assert(areDeepEqual(value, backupValue), 'Data has not been saved!');\r\n\r\n      items.push([key, value]);\r\n    }\r\n\r\n    for (const [key, value] of items) {\r\n      let shouldRewrite = false;\r\n      await capacitorStorage.setItem(key as StorageKey, value).catch(() => {\r\n        shouldRewrite = true;\r\n      });\r\n\r\n      if (shouldRewrite) {\r\n        await capacitorStorage.removeItem(key as StorageKey);\r\n        await capacitorStorage.setItem(key as StorageKey, value);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nasync function migrateCoreWallet(onUpdate: OnApiUpdate) {\r\n  const currentStorage = IS_EXTENSION ? storage : localStorage;\r\n\r\n  const [\r\n    // Default Core Wallet version is v3R2\r\n    // https://github.com/toncenter/ton-wallet/blob/master/src/js/Controller.js#L128\r\n    walletVersion = 'v3R2',\r\n    isTestnet,\r\n    address,\r\n    words,\r\n    publicKey,\r\n    isTonProxyEnabled,\r\n    isTonMagicEnabled,\r\n  ] = await Promise.all([\r\n    currentStorage.getItem('walletVersion' as StorageKey),\r\n    currentStorage.getItem('isTestnet' as StorageKey),\r\n    currentStorage.getItem('address' as StorageKey),\r\n    currentStorage.getItem('words' as StorageKey),\r\n    currentStorage.getItem('publicKey' as StorageKey),\r\n    currentStorage.getItem('proxy' as StorageKey),\r\n    currentStorage.getItem('magic' as StorageKey),\r\n  ]);\r\n\r\n  if (isTestnet) {\r\n    onUpdate({\r\n      type: 'updateSettings',\r\n      settings: {\r\n        isTestnet: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  const network = isTestnet ? 'testnet' : 'mainnet';\r\n  const accountId = `0-ton-${network}`;\r\n\r\n  if (address && words && publicKey) {\r\n    const secondNetwork = network === 'mainnet' ? 'testnet' : 'mainnet';\r\n    const secondAccountId = `0-ton-${secondNetwork}`;\r\n    const secondAddress = toBase64Address(address, false, secondNetwork);\r\n\r\n    const newAccountById: Record<string, ApiTonAccount> = {};\r\n    newAccountById[accountId] = {\r\n      type: 'ton',\r\n      mnemonicEncrypted: words,\r\n      byChain: {\r\n        ton: {\r\n          address,\r\n          version: walletVersion,\r\n          publicKey,\r\n          index: 0,\r\n        },\r\n      },\r\n    };\r\n\r\n    newAccountById[secondAccountId] = {\r\n      type: 'ton',\r\n      mnemonicEncrypted: words,\r\n      byChain: {\r\n        ton: {\r\n          address: secondAddress,\r\n          version: walletVersion,\r\n          publicKey,\r\n          index: 0,\r\n        },\r\n      },\r\n    };\r\n\r\n    await storage.setItem('accounts', newAccountById);\r\n\r\n    onUpdate({\r\n      type: 'migrateCoreApplication',\r\n      isTestnet,\r\n      accountId,\r\n      address,\r\n      secondAccountId,\r\n      secondAddress,\r\n      isTonProxyEnabled,\r\n      isTonMagicEnabled,\r\n    });\r\n\r\n    // Clean up storage after migrate the app from Core Wallet\r\n    [\r\n      'walletVersion', 'isTestnet', 'words', 'address', 'publicKey', 'magic', 'proxy', 'isLedger',\r\n      'ledgerTransportType', '__time', 'isDebug',\r\n    ].forEach((key) => {\r\n      void currentStorage.removeItem(key as StorageKey);\r\n    });\r\n  }\r\n}\r\n","import { Cell } from '@ton/core';\r\n\r\nimport type {\r\n  ApiActivity,\r\n  ApiNetwork,\r\n  ApiNft,\r\n  ApiNftSuperCollection,\r\n  ApiSwapActivity,\r\n  ApiSwapDexLabel,\r\n  ApiToken,\r\n  ApiTransactionActivity,\r\n  ApiTransactionType,\r\n} from '../../../types';\r\nimport type {\r\n  AddressBook,\r\n  AnyAction,\r\n  AnyTokenMetadata,\r\n  AuctionBidAction,\r\n  CallContractAction,\r\n  ChangeDnsAction,\r\n  ContractDeployAction,\r\n  DeleteDnsAction,\r\n  DexDepositLiquidityAction,\r\n  DexSlug,\r\n  DexWithdrawLiquidityAction,\r\n  JettonBurnAction,\r\n  JettonMasterMetadata,\r\n  JettonMintAction,\r\n  JettonTransferAction,\r\n  MetadataMap,\r\n  NftCollectionMetadata,\r\n  NftItemMetadata,\r\n  NftMintAction,\r\n  NftTransferAction,\r\n  RenewDnsAction,\r\n  StakeDepositAction,\r\n  StakeWithdrawalAction,\r\n  StakeWithdrawalRequestAction,\r\n  SwapAction,\r\n  TonTransferAction,\r\n} from './types';\r\n\r\nimport {\r\n  BURN_ADDRESS,\r\n  DNS_IMAGE_GEN_URL,\r\n  ETHENA_STAKING_VAULT,\r\n  LIQUID_POOL,\r\n  MTW_CARDS_COLLECTION,\r\n  MYCOIN_STAKING_POOL,\r\n  NFT_FRAGMENT_COLLECTIONS,\r\n  NFT_FRAGMENT_GIFT_IMAGE_TO_URL_REGEX,\r\n  STON_PTON_ADDRESS,\r\n  TON_TSUSDE,\r\n  TON_USDE,\r\n  TONCOIN,\r\n} from '../../../../config';\r\nimport { buildTxId, parseTxId } from '../../../../util/activities';\r\nimport { sortActivities } from '../../../../util/activities/order';\r\nimport { toMilliseconds, toSeconds } from '../../../../util/datetime';\r\nimport { toDecimal } from '../../../../util/decimals';\r\nimport { getDnsDomainZone } from '../../../../util/dns';\r\nimport { fixIpfsUrl, getProxiedLottieUrl } from '../../../../util/fetch';\r\nimport { omitUndefined } from '../../../../util/iteratees';\r\nimport { logDebugError } from '../../../../util/logs';\r\nimport safeExec from '../../../../util/safeExec';\r\nimport { buildMtwCardsNftMetadata, getIsFragmentGift, readComment } from '../util/metadata';\r\nimport { toBase64Address } from '../util/tonCore';\r\nimport {\r\n  checkHasScamLink,\r\n  checkIsTrustedCollection,\r\n  getNftSuperCollectionsByCollectionAddress,\r\n} from '../../../common/addresses';\r\nimport { updateActivityMetadata } from '../../../common/helpers';\r\nimport { buildTokenSlug, getTokenBySlug } from '../../../common/tokens';\r\nimport {\r\n  EXCESS_OP_CODES,\r\n  JettonStakingOpCode,\r\n  OpCode,\r\n  OUR_FEE_PAYLOAD_BOC,\r\n  TeleitemOpCode,\r\n} from '../constants';\r\nimport { callToncenterV3 } from './other';\r\n\r\ntype ActionsResponse = {\r\n  actions: AnyAction[];\r\n  address_book: AddressBook;\r\n  metadata?: MetadataMap;\r\n};\r\n\r\ntype ParseOptions = {\r\n  network: ApiNetwork;\r\n  addressBook: AddressBook;\r\n  walletAddress: string;\r\n  metadata: MetadataMap;\r\n  nftSuperCollectionsByCollectionAddress: Record<string, ApiNftSuperCollection>;\r\n  isPending?: boolean;\r\n};\r\n\r\nconst RAW_LIQUID_POOL_ADDRESS = '0:F6FF877DD4CE1355B101572045F09D54C29309737EB52CA542CFA6C195F7CC5B';\r\nconst RAW_NFT_CARD_COLLECTION = '0:901362FD85FC31D55F2C82617D91EADA1F1D6B34AF559A047572D56F20D046CA';\r\nconst TME_RENEW_HASH_SUFFIX = '0000000000000000000000000000000000000000000000';\r\n\r\nconst RAW_NFT_COLLECTIONS_TO_RELOAD_METADATA = new Set<string | null>([RAW_NFT_CARD_COLLECTION]);\r\n\r\ntype FetchActionsOptions = {\r\n  network: ApiNetwork;\r\n  filter: {\r\n    /** Mismatches `walletAddress` when actions are requested for a specific token */\r\n    address: string | string[];\r\n  } | {\r\n    actionId: string | string[];\r\n  };\r\n  limit: number;\r\n  walletAddress: string;\r\n  fromTimestamp?: number;\r\n  toTimestamp?: number;\r\n  shouldIncludeFrom?: boolean;\r\n  shouldIncludeTo?: boolean;\r\n  includeTypes?: AnyAction['type'][];\r\n  excludeTypes?: AnyAction['type'][];\r\n};\r\n\r\n/**\r\n * Fetches actions, parses them, sorts according to our rules and makes sure there are no duplicates.\r\n */\r\nexport async function fetchActions(options: FetchActionsOptions): Promise<ApiActivity[]> {\r\n  const {\r\n    network, filter, limit, toTimestamp, fromTimestamp,\r\n    shouldIncludeFrom, shouldIncludeTo, walletAddress,\r\n    includeTypes, excludeTypes,\r\n  } = options;\r\n\r\n  const data: AnyLiteral = {\r\n    account: 'address' in filter ? filter.address : undefined,\r\n    action_id: 'actionId' in filter ? filter.actionId : undefined,\r\n    limit,\r\n    start_utime: fromTimestamp && toSeconds(fromTimestamp) + (!shouldIncludeFrom ? 1 : 0),\r\n    end_utime: toTimestamp && toSeconds(toTimestamp) - (!shouldIncludeTo ? 1 : 0),\r\n    sort: 'desc',\r\n    ...(includeTypes?.length && { action_type: includeTypes.join(',') }),\r\n    ...(excludeTypes?.length && { exclude_action_type: excludeTypes.join(',') }),\r\n  };\r\n\r\n  // The API sorts the actions by trace_end_lt + trace_id + action_end_lt + action_id.\r\n  // That is, the actions are grouped by the trace, and sorted by the time inside the groups.\r\n  const {\r\n    actions: rawActions,\r\n    address_book: addressBook,\r\n    metadata = {},\r\n  } = await callToncenterV3<ActionsResponse>(network, '/actions', data);\r\n  const nftSuperCollectionsByCollectionAddress = await getNftSuperCollectionsByCollectionAddress();\r\n\r\n  const activities = parseActions(\r\n    network,\r\n    walletAddress,\r\n    rawActions,\r\n    addressBook,\r\n    metadata,\r\n    nftSuperCollectionsByCollectionAddress,\r\n  );\r\n\r\n  // Even though the activities returned by Toncenter are sorted by timestamp, our sorting may differ.\r\n  // It's important to enforce our sorting, because otherwise `mergeSortedActivities` may leave duplicates.\r\n  return sortActivities(activities);\r\n}\r\n\r\nexport async function fetchPendingActions(network: ApiNetwork, address: string): Promise<ApiActivity[]> {\r\n  const {\r\n    actions,\r\n    address_book: addressBook,\r\n    metadata = {},\r\n  } = await callToncenterV3<ActionsResponse>(network, '/pendingActions', {\r\n    account: address,\r\n  });\r\n\r\n  const nftSuperCollectionsByCollectionAddress = await getNftSuperCollectionsByCollectionAddress();\r\n\r\n  return parseActions(\r\n    network,\r\n    address,\r\n    actions,\r\n    addressBook,\r\n    metadata,\r\n    nftSuperCollectionsByCollectionAddress,\r\n    true,\r\n  );\r\n}\r\n\r\nexport function parseActions(\r\n  network: ApiNetwork,\r\n  walletAddress: string,\r\n  rawActions: AnyAction[],\r\n  addressBook: AddressBook,\r\n  metadata: MetadataMap,\r\n  nftSuperCollectionsByCollectionAddress: Record<string, ApiNftSuperCollection>,\r\n  isPending?: boolean,\r\n): ApiActivity[] {\r\n  const options: ParseOptions = {\r\n    network,\r\n    addressBook,\r\n    walletAddress,\r\n    metadata,\r\n    nftSuperCollectionsByCollectionAddress,\r\n    isPending,\r\n  };\r\n  const activities = [];\r\n\r\n  for (const action of rawActions) {\r\n    activities.push(...parseAction(action, options));\r\n  }\r\n\r\n  return activities;\r\n}\r\n\r\nfunction parseAction(action: AnyAction, options: ParseOptions): ApiActivity[] {\r\n  let result: (ApiActivity | undefined)[] = [];\r\n\r\n  switch (action.type) {\r\n    case 'ton_transfer': {\r\n      result = [parseTonTransfer(action, options)];\r\n      break;\r\n    }\r\n    case 'call_contract': {\r\n      result = [parseCallContract(action, options)];\r\n      break;\r\n    }\r\n    case 'contract_deploy': {\r\n      result = [parseContractDeploy(action, options)];\r\n      break;\r\n    }\r\n    case 'nft_transfer': {\r\n      result = [parseNftTransfer(action, options)];\r\n      break;\r\n    }\r\n    case 'nft_mint': {\r\n      result = [parseNftMint(action, options)];\r\n      break;\r\n    }\r\n    case 'jetton_transfer': {\r\n      result = [parseJettonTransfer(action, options)];\r\n      break;\r\n    }\r\n    case 'jetton_mint': {\r\n      result = [parseJettonMint(action, options)];\r\n      break;\r\n    }\r\n    case 'jetton_burn': {\r\n      result = [parseJettonBurn(action, options)];\r\n      break;\r\n    }\r\n    case 'stake_deposit': {\r\n      result = [parseStakeDeposit(action, options)];\r\n      break;\r\n    }\r\n    case 'stake_withdrawal': {\r\n      result = [parseStakeWithdrawal(action, options)];\r\n      break;\r\n    }\r\n    case 'stake_withdrawal_request': {\r\n      result = [parseStakeWithdrawalRequest(action, options)];\r\n      break;\r\n    }\r\n    case 'jetton_swap': {\r\n      result = [parseJettonSwap(action, options)];\r\n      break;\r\n    }\r\n    case 'change_dns':\r\n    case 'delete_dns':\r\n    case 'renew_dns': {\r\n      result = [parseDns(action, options)];\r\n      break;\r\n    }\r\n    case 'auction_bid': {\r\n      result = [parseAuctionBid(action, options)];\r\n      break;\r\n    }\r\n    case 'dex_deposit_liquidity': {\r\n      result = parseLiquidityDeposit(action, options);\r\n      break;\r\n    }\r\n    case 'dex_withdraw_liquidity': {\r\n      result = parseLiquidityWithdraw(action, options);\r\n      break;\r\n    }\r\n  }\r\n\r\n  for (let i = 0; i < result.length; i++) {\r\n    const activity = result[i];\r\n    if (!activity) continue;\r\n\r\n    if ('nft' in activity && activity.nft?.isHidden) {\r\n      activity.shouldHide = true;\r\n    }\r\n\r\n    if (activity.kind === 'transaction' && !activity.isIncoming) {\r\n      activity.shouldLoadDetails ??= true;\r\n    }\r\n\r\n    result[i] = updateActivityMetadata(activity);\r\n  }\r\n\r\n  return result.filter(Boolean);\r\n}\r\n\r\nfunction parseTonTransfer(action: TonTransferAction, options: ParseOptions): ApiTransactionActivity {\r\n  const { details, details: { encrypted: isEncrypted, source, destination, value } } = action;\r\n\r\n  const comment = (!isEncrypted && details.comment) || undefined;\r\n  const encryptedComment = (isEncrypted && details.comment) || undefined;\r\n\r\n  return {\r\n    ...parseCommonFields(action, options, source, destination, value),\r\n    slug: TONCOIN.slug,\r\n    comment,\r\n    encryptedComment,\r\n  };\r\n}\r\n\r\nfunction parseCallContract(action: CallContractAction, options: ParseOptions): ApiTransactionActivity | undefined {\r\n  const { walletAddress } = options;\r\n  const { details, details: { source, destination, value } } = action;\r\n\r\n  const common = parseCommonFields(action, options, source, destination, value);\r\n  const opCode = Number(details.opcode);\r\n  const shouldHide = !common.isIncoming && [OpCode.OurFee, TeleitemOpCode.Ok].includes(opCode);\r\n\r\n  let type: ApiTransactionType | undefined;\r\n  if (EXCESS_OP_CODES.includes(opCode)) {\r\n    type = 'excess';\r\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-enum-comparison\r\n  } else if (opCode === OpCode.Bounced) {\r\n    type = 'bounced';\r\n  } else if ([JettonStakingOpCode.UnstakeRequest, JettonStakingOpCode.ClaimRewards].includes(opCode)) {\r\n    type = 'unstakeRequest';\r\n  } else if (common.toAddress !== walletAddress) {\r\n    type = 'callContract';\r\n  }\r\n\r\n  return {\r\n    ...common,\r\n    slug: TONCOIN.slug,\r\n    type,\r\n    shouldHide,\r\n  };\r\n}\r\n\r\nfunction parseContractDeploy(action: ContractDeployAction, options: ParseOptions): ApiTransactionActivity | undefined {\r\n  const { details: { source, destination } } = action;\r\n\r\n  if (!source) {\r\n    return undefined;\r\n  }\r\n\r\n  // Deploy action is additional and always occurs alongside others (duplicating amount), so we hide amount and fee.\r\n\r\n  return {\r\n    ...parseCommonFields(action, options, source, destination),\r\n    slug: TONCOIN.slug,\r\n    type: 'contractDeploy',\r\n    shouldLoadDetails: false,\r\n    fee: 0n,\r\n  };\r\n}\r\n\r\nfunction parseJettonTransfer(action: JettonTransferAction, options: ParseOptions): ApiTransactionActivity {\r\n  const { addressBook } = options;\r\n  const {\r\n    details,\r\n    details: {\r\n      is_encrypted_comment: isEncrypted,\r\n      forward_payload: forwardPayload,\r\n      sender,\r\n      receiver,\r\n      amount,\r\n    },\r\n  } = action;\r\n\r\n  const common = parseCommonFields(action, options, sender, receiver, amount);\r\n  const { isIncoming, toAddress, fromAddress } = common;\r\n\r\n  const comment = (!isEncrypted && details.comment) || undefined;\r\n  const encryptedComment = (isEncrypted && details.comment) || undefined;\r\n  const tokenAddress = addressBook[details.asset].user_friendly;\r\n  const slug = buildTokenSlug('ton', tokenAddress);\r\n  const shouldHide = !isIncoming && forwardPayload === OUR_FEE_PAYLOAD_BOC;\r\n\r\n  let type: ApiTransactionType;\r\n  if (toAddress === BURN_ADDRESS) {\r\n    type = 'burn';\r\n  } else if (toAddress === MYCOIN_STAKING_POOL) {\r\n    type = 'stake';\r\n  } else if (fromAddress === MYCOIN_STAKING_POOL) {\r\n    type = 'unstake';\r\n  } else if (tokenAddress === TON_USDE.tokenAddress) {\r\n    if (fromAddress === ETHENA_STAKING_VAULT) {\r\n      type = 'unstake';\r\n    } else if (toAddress === ETHENA_STAKING_VAULT) {\r\n      type = 'stake';\r\n    }\r\n  }\r\n\r\n  return {\r\n    ...common,\r\n    slug,\r\n    comment,\r\n    encryptedComment,\r\n    shouldHide,\r\n    type,\r\n  };\r\n}\r\n\r\nfunction parseJettonMint(action: JettonMintAction, options: ParseOptions): ApiTransactionActivity {\r\n  const { addressBook } = options;\r\n  const {\r\n    details,\r\n    details: {\r\n      receiver,\r\n      receiver_jetton_wallet: jettonWalletRaw,\r\n      amount,\r\n    },\r\n  } = action;\r\n\r\n  const tokenAddress = addressBook[details.asset].user_friendly;\r\n  const slug = buildTokenSlug('ton', tokenAddress);\r\n\r\n  let commonFields: ReturnType<typeof parseCommonFields>;\r\n  let type: ApiTransactionType = 'mint';\r\n\r\n  if (\r\n    tokenAddress === TON_TSUSDE.tokenAddress\r\n    && action.end_lt !== action.trace_end_lt\r\n  ) {\r\n    // TODO After fix on Toncenter's side, move it to transfer parsing (currently it's mistakenly detected as mint)\r\n    type = 'unstakeRequest';\r\n    commonFields = {\r\n      ...parseCommonFields(action, options, receiver, receiver, 0),\r\n      toAddress: ETHENA_STAKING_VAULT,\r\n      isIncoming: false,\r\n      normalizedAddress: ETHENA_STAKING_VAULT,\r\n    };\r\n  } else {\r\n    commonFields = parseCommonFields(action, options, jettonWalletRaw, receiver, amount);\r\n  }\r\n\r\n  return {\r\n    ...commonFields,\r\n    slug,\r\n    type,\r\n  };\r\n}\r\n\r\nfunction parseJettonBurn(action: JettonBurnAction, options: ParseOptions): ApiTransactionActivity {\r\n  const { network } = options;\r\n  const { details, details: { owner, owner_jetton_wallet: jettonWallet, amount } } = action;\r\n\r\n  const slug = buildTokenSlug('ton', toBase64Address(details.asset, true, network));\r\n\r\n  return {\r\n    ...parseCommonFields(action, options, owner, jettonWallet, amount),\r\n    slug,\r\n    type: 'burn',\r\n  };\r\n}\r\n\r\nfunction parseNftTransfer(action: NftTransferAction, options: ParseOptions): ApiTransactionActivity {\r\n  const {\r\n    metadata,\r\n    walletAddress,\r\n    addressBook,\r\n    nftSuperCollectionsByCollectionAddress,\r\n  } = options;\r\n\r\n  const {\r\n    nft_item_index: index,\r\n    nft_item: rawNftAddress,\r\n    nft_collection: rawCollectionAddress,\r\n    new_owner: newOwner,\r\n    old_owner: oldOwner,\r\n    forward_payload: forwardPayload,\r\n    is_purchase: isPurchase,\r\n    price,\r\n    response_destination: responseDestination,\r\n    marketplace,\r\n  } = action.details;\r\n\r\n  const { nft, isMetadataMissing } = parseToncenterNft(\r\n    metadata,\r\n    rawNftAddress,\r\n    nftSuperCollectionsByCollectionAddress,\r\n    rawCollectionAddress ?? undefined,\r\n    index ?? undefined,\r\n  );\r\n\r\n  let shouldHide = !nft && rawCollectionAddress ? isHiddenCollection(rawCollectionAddress, metadata) : undefined;\r\n\r\n  // Hide duplicate NFT transfer actions that appear when listing NFT on Getgems marketplace\r\n  // These are actions where old_owner and new_owner are not the wallet address,\r\n  // but wallet address is only in response_destination\r\n  if (oldOwner && newOwner && responseDestination) {\r\n    const oldOwnerAddress = addressBook[oldOwner]?.user_friendly;\r\n    const newOwnerAddress = addressBook[newOwner]?.user_friendly;\r\n\r\n    if (oldOwnerAddress !== walletAddress && newOwnerAddress !== walletAddress) {\r\n      shouldHide = true;\r\n    }\r\n  }\r\n\r\n  const activity: ApiTransactionActivity = {\r\n    ...parseCommonFields(action, options, oldOwner ?? rawNftAddress, newOwner),\r\n    shouldHide,\r\n    slug: TONCOIN.slug,\r\n    nft,\r\n    comment: (forwardPayload && safeReadComment(forwardPayload)) || undefined,\r\n    shouldReload: (isMetadataMissing && RAW_NFT_COLLECTIONS_TO_RELOAD_METADATA.has(action.details.nft_collection))\r\n      || undefined,\r\n  };\r\n\r\n  if (activity.toAddress === BURN_ADDRESS) {\r\n    activity.type = 'burn';\r\n  } else if (isPurchase && price) {\r\n    const isBuying = addressBook[newOwner]?.user_friendly === walletAddress;\r\n    activity.type = 'nftTrade';\r\n    activity.isIncoming = !isBuying;\r\n    activity.amount = isBuying ? -BigInt(price) : BigInt(price);\r\n    activity.extra = {\r\n      marketplace: marketplace ?? undefined,\r\n    };\r\n  }\r\n\r\n  return activity;\r\n}\r\n\r\nfunction parseNftMint(action: NftMintAction, options: ParseOptions): ApiTransactionActivity {\r\n  const { metadata, nftSuperCollectionsByCollectionAddress } = options;\r\n\r\n  const {\r\n    owner,\r\n    nft_item_index: index,\r\n    nft_item: rawNftAddress,\r\n    nft_collection: rawCollectionAddress,\r\n  } = action.details;\r\n\r\n  const { nft, isMetadataMissing } = parseToncenterNft(\r\n    metadata,\r\n    rawNftAddress,\r\n    nftSuperCollectionsByCollectionAddress,\r\n    rawCollectionAddress ?? undefined,\r\n    index ?? undefined,\r\n  );\r\n\r\n  return {\r\n    ...parseCommonFields(action, options, owner, rawNftAddress),\r\n    slug: TONCOIN.slug,\r\n    nft,\r\n    type: 'mint',\r\n    shouldReload: (isMetadataMissing && RAW_NFT_COLLECTIONS_TO_RELOAD_METADATA.has(action.details.nft_collection))\r\n      || undefined,\r\n  };\r\n}\r\n\r\nfunction isHiddenCollection(rawCollectionAddress: string, metadata: MetadataMap) {\r\n  const collectionMetadata = metadata[rawCollectionAddress]?.token_info[0] as NftCollectionMetadata | undefined;\r\n  return collectionMetadata?.name?.includes('Withdrawal Payout');\r\n}\r\n\r\nfunction parseStakeDeposit(action: StakeDepositAction, options: ParseOptions): ApiTransactionActivity {\r\n  const { details: { stake_holder: holder, pool, amount } } = action;\r\n\r\n  return {\r\n    ...parseCommonFields(action, options, holder, pool, amount),\r\n    slug: TONCOIN.slug,\r\n    type: 'stake',\r\n  };\r\n}\r\n\r\nfunction parseStakeWithdrawal(action: StakeWithdrawalAction, options: ParseOptions): ApiTransactionActivity {\r\n  const { addressBook } = options;\r\n  const { details, details: { stake_holder: holder, amount } } = action;\r\n\r\n  // Fix issue with old data when pool is null\r\n  const pool = details.pool ?? RAW_LIQUID_POOL_ADDRESS;\r\n  const fixedOptions = pool in addressBook ? options : {\r\n    ...options,\r\n    addressBook: {\r\n      ...addressBook,\r\n      // eslint-disable-next-line no-null/no-null\r\n      [pool]: { user_friendly: LIQUID_POOL, domain: null },\r\n    },\r\n  };\r\n\r\n  return {\r\n    ...parseCommonFields(action, fixedOptions, pool, holder, amount),\r\n    slug: TONCOIN.slug,\r\n    type: 'unstake',\r\n    shouldLoadDetails: details.provider === 'tonstakers' && !details.payout_nft,\r\n  };\r\n}\r\n\r\nfunction parseStakeWithdrawalRequest(\r\n  action: StakeWithdrawalRequestAction,\r\n  options: ParseOptions,\r\n): ApiTransactionActivity {\r\n  const { details: { stake_holder: holder, pool } } = action;\r\n\r\n  return {\r\n    ...parseCommonFields(action, options, holder, pool, 0), // TODO (actions) Replace to real fee\r\n    slug: TONCOIN.slug,\r\n    type: 'unstakeRequest',\r\n  };\r\n}\r\n\r\nfunction parseJettonSwap(action: SwapAction, options: ParseOptions): ApiSwapActivity {\r\n  const { metadata, isPending } = options;\r\n  const {\r\n    end_utime: endUtime,\r\n    success: isSuccess,\r\n    details: {\r\n      dex_incoming_transfer: {\r\n        amount: fromAmount,\r\n        asset: fromAsset,\r\n      },\r\n      dex_outgoing_transfer: {\r\n        amount: toAmount,\r\n        asset: toAsset,\r\n      },\r\n    },\r\n  } = action;\r\n\r\n  const decimalsFrom = (fromAsset && parseToncenterJetton(fromAsset, metadata)?.decimals) || TONCOIN.decimals;\r\n  const decimalsTo = (toAsset && parseToncenterJetton(toAsset, metadata)?.decimals) || TONCOIN.decimals;\r\n\r\n  const fromTokenAddress = fromAsset ? toBase64Address(fromAsset, true) : undefined;\r\n  const toTokenAddress = toAsset ? toBase64Address(toAsset, true) : undefined;\r\n\r\n  const from = fromTokenAddress && fromTokenAddress !== STON_PTON_ADDRESS\r\n    ? buildTokenSlug('ton', fromTokenAddress) : TONCOIN.slug;\r\n  const to = toTokenAddress && toTokenAddress !== STON_PTON_ADDRESS\r\n    ? buildTokenSlug('ton', toTokenAddress) : TONCOIN.slug;\r\n\r\n  return {\r\n    kind: 'swap',\r\n    id: buildActionActivityId(action),\r\n    timestamp: toMilliseconds(endUtime),\r\n    from,\r\n    fromAmount: toDecimal(BigInt(fromAmount), decimalsFrom),\r\n    to,\r\n    toAmount: toDecimal(BigInt(toAmount), decimalsTo),\r\n    networkFee: '0',\r\n    swapFee: '0',\r\n    ourFee: '0',\r\n    status: isPending ? 'pending' : isSuccess ? 'completed' : 'failed',\r\n    hashes: [],\r\n    externalMsgHashNorm: action.trace_external_hash_norm ?? action.trace_external_hash,\r\n    shouldLoadDetails: true,\r\n  };\r\n}\r\n\r\nfunction parseDns(\r\n  action: ChangeDnsAction | RenewDnsAction | DeleteDnsAction,\r\n  options: ParseOptions,\r\n): ApiTransactionActivity {\r\n  const { metadata, nftSuperCollectionsByCollectionAddress } = options;\r\n  const { details: { source, asset } } = action;\r\n\r\n  const { nft } = parseToncenterNft(metadata, asset, nftSuperCollectionsByCollectionAddress);\r\n\r\n  let type: ApiTransactionType;\r\n  if (action.type === 'change_dns') {\r\n    const { sum_type: sumType } = action.details.value;\r\n    if (sumType === 'DNSSmcAddress') {\r\n      type = 'dnsChangeAddress';\r\n    } else if (sumType === 'DNSAdnlAddress') {\r\n      type = 'dnsChangeSite';\r\n    } else if (sumType === 'DNSStorageAddress') {\r\n      type = 'dnsChangeStorage';\r\n    } else if (sumType === 'DNSNextResolver') {\r\n      type = 'dnsChangeSubdomains';\r\n    }\r\n  } else if (\r\n    action.type === 'renew_dns'\r\n    || (action.type === 'delete_dns' && action.details.hash.endsWith(TME_RENEW_HASH_SUFFIX))\r\n  ) {\r\n    type = 'dnsRenew';\r\n  } else {\r\n    type = 'dnsDelete';\r\n  }\r\n\r\n  return {\r\n    ...parseCommonFields(action, options, source, asset, 0), // TODO (actions) Replace to real fee\r\n    slug: TONCOIN.slug,\r\n    type,\r\n    nft,\r\n  };\r\n}\r\n\r\nfunction parseAuctionBid(action: AuctionBidAction, options: ParseOptions): ApiTransactionActivity {\r\n  const { metadata, nftSuperCollectionsByCollectionAddress } = options;\r\n  const { details } = action;\r\n\r\n  const {\r\n    bidder,\r\n    auction,\r\n    nft_item_index: index,\r\n    nft_item: rawNftAddress,\r\n    nft_collection: rawCollectionAddress,\r\n  } = details;\r\n\r\n  const { nft } = parseToncenterNft(\r\n    metadata,\r\n    rawNftAddress ?? undefined,\r\n    nftSuperCollectionsByCollectionAddress,\r\n    rawCollectionAddress ?? undefined,\r\n    index ?? undefined,\r\n  );\r\n\r\n  return {\r\n    ...parseCommonFields(action, options, bidder, auction, details.amount),\r\n    slug: TONCOIN.slug,\r\n    type: 'auctionBid',\r\n    nft,\r\n  };\r\n}\r\n\r\nexport function parseLiquidityDeposit(\r\n  action: DexDepositLiquidityAction,\r\n  options: ParseOptions,\r\n): ApiTransactionActivity[] {\r\n  const { addressBook } = options;\r\n  const { details, details: { source, pool, destination_liquidity: destinationAddress, dex } } = action;\r\n\r\n  const common = parseCommonFields(action, options, source, pool ?? destinationAddress);\r\n\r\n  const partialExtended = {\r\n    ...common,\r\n    type: 'liquidityDeposit',\r\n    extra: {\r\n      dex: convertDexId(dex),\r\n    },\r\n  } as const;\r\n\r\n  const activities: ApiTransactionActivity[] = [{\r\n    ...partialExtended,\r\n    amount: -BigInt(details.amount_1 ?? 0n),\r\n    slug: getAssetSlug(addressBook, details.asset_1),\r\n  }];\r\n\r\n  // eslint-disable-next-line no-null/no-null\r\n  if (details.amount_2 !== null) {\r\n    const id = buildActionActivityId(action, 'additional');\r\n    activities.push({\r\n      ...partialExtended,\r\n      id,\r\n      amount: -BigInt(details.amount_2),\r\n      slug: getAssetSlug(addressBook, details.asset_2),\r\n    });\r\n  }\r\n\r\n  return activities;\r\n}\r\n\r\nfunction parseLiquidityWithdraw(action: DexWithdrawLiquidityAction, options: ParseOptions): ApiTransactionActivity[] {\r\n  const { addressBook } = options;\r\n  const { details, details: { source, pool, dex } } = action;\r\n\r\n  const common = parseCommonFields(action, options, pool, source);\r\n\r\n  const partialExtended = {\r\n    ...common,\r\n    shouldLoadDetails: true,\r\n    type: 'liquidityWithdraw',\r\n    extra: {\r\n      dex: convertDexId(dex),\r\n    },\r\n  } as const;\r\n\r\n  const additionalId = buildActionActivityId(action, 'additional');\r\n\r\n  return [\r\n    {\r\n      ...partialExtended,\r\n      amount: BigInt(details.amount_1),\r\n      slug: getAssetSlug(addressBook, details.asset_1),\r\n    },\r\n    {\r\n      ...partialExtended,\r\n      id: additionalId,\r\n      amount: BigInt(details.amount_2),\r\n      slug: getAssetSlug(addressBook, details.asset_2),\r\n    },\r\n  ];\r\n}\r\n\r\nfunction getAssetSlug(addressBook: AddressBook, rawAddress?: string | null) {\r\n  return rawAddress ? buildTokenSlug('ton', addressBook[rawAddress].user_friendly) : TONCOIN.slug;\r\n}\r\n\r\nfunction parseCommonFields(\r\n  action: AnyAction,\r\n  options: ParseOptions,\r\n  rawFromAddress: string,\r\n  rawToAddress: string,\r\n  amountString: string | number = 0,\r\n) {\r\n  const id = buildActionActivityId(action);\r\n  const { walletAddress, network, addressBook, isPending } = options;\r\n  const fromAddress = addressBook[rawFromAddress].user_friendly;\r\n  const toAddress = addressBook[rawToAddress].user_friendly;\r\n  const isIncoming = toAddress === walletAddress;\r\n  const normalizedAddress = toBase64Address(isIncoming ? fromAddress : toAddress, true, network);\r\n  const amount = isIncoming ? BigInt(amountString) : -BigInt(amountString);\r\n  return {\r\n    kind: 'transaction',\r\n    id,\r\n    timestamp: toMilliseconds(action.end_utime),\r\n    externalMsgHashNorm: action.trace_external_hash_norm ?? action.trace_external_hash,\r\n    fee: 0n, // Calculated when TransactionModal opens\r\n    fromAddress,\r\n    toAddress,\r\n    isIncoming,\r\n    normalizedAddress,\r\n    amount,\r\n    // Pending actions from Toncenter are not trusted\r\n    status: isPending ? 'pending' : action.success ? 'completed' : 'failed',\r\n  } satisfies Partial<ApiTransactionActivity>;\r\n}\r\n\r\nfunction parseToncenterNft(\r\n  metadataMap: MetadataMap,\r\n  rawNftAddress: string,\r\n  nftSuperCollectionsByCollectionAddress: Record<string, ApiNftSuperCollection>,\r\n  rawCollectionAddress?: string,\r\n  index?: string,\r\n): { nft?: ApiNft; isMetadataMissing?: true } {\r\n  try {\r\n    const nftMetadata = extractMetadata<NftItemMetadata>(rawNftAddress, metadataMap, 'nft_items');\r\n\r\n    if (!nftMetadata) {\r\n      return { isMetadataMissing: true };\r\n    }\r\n\r\n    const { name, description, extra } = nftMetadata;\r\n    let { image } = nftMetadata;\r\n    const lottie = extra?.lottie ? getProxiedLottieUrl(extra.lottie) : undefined;\r\n\r\n    const nftAddress = toBase64Address(rawNftAddress, true);\r\n    const collectionMetadata = rawCollectionAddress\r\n      ? extractMetadata<NftCollectionMetadata>(rawCollectionAddress, metadataMap, 'nft_collections')\r\n      : undefined;\r\n    const collectionAddress = rawCollectionAddress ? toBase64Address(rawCollectionAddress, true) : undefined;\r\n\r\n    // TODO (actions) Determine that this is a domain by the collection address once Toncenter adds it\r\n    const domain = extra?.domain ?? name ?? '';\r\n    const { zone: domainZone, base: domainBase } = getDnsDomainZone(domain) ?? {};\r\n\r\n    if (domainZone && (!collectionAddress || !image)) {\r\n      if (domainZone.suffixes[0] === 'ton') {\r\n        image = `${DNS_IMAGE_GEN_URL}${domainBase}`;\r\n      }\r\n\r\n      const nft = omitUndefined<ApiNft>({\r\n        index: Number(index),\r\n        name: domain,\r\n        address: nftAddress,\r\n\r\n        thumbnail: extra?._image_medium ?? image!,\r\n        image: image!,\r\n        description,\r\n        isOnSale: false, // TODO (actions) Replace with real value when Toncenter supports it\r\n        collectionAddress: collectionAddress ?? domainZone.resolver,\r\n        collectionName: domainZone.collectionName,\r\n        metadata: {\r\n          ...(lottie && { lottie }),\r\n        },\r\n      });\r\n      return { nft };\r\n    }\r\n\r\n    let hasScamLink = false;\r\n\r\n    if (!collectionAddress || !checkIsTrustedCollection(collectionAddress)) {\r\n      for (const text of [name, description].filter(Boolean)) {\r\n        if (checkHasScamLink(text)) {\r\n          hasScamLink = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    const isScam = hasScamLink; // TODO (actions) Replace with real value when Toncenter supports it\r\n    const isHidden = extra?.render_type === 'hidden' || isScam;\r\n    const isFragmentGift = getIsFragmentGift(nftSuperCollectionsByCollectionAddress, collectionAddress);\r\n    const isMtwCard = collectionAddress === MTW_CARDS_COLLECTION;\r\n    const fixedImage = image ? fixIpfsUrl(image) : undefined;\r\n\r\n    const thumbnail = extra?._image_medium ?? fixedImage!;\r\n\r\n    const nft: ApiNft = omitUndefined<ApiNft>({\r\n      index: Number(index),\r\n      name: name!,\r\n      address: nftAddress,\r\n      thumbnail,\r\n      image: fixedImage!,\r\n      description,\r\n      isOnSale: false, // TODO (actions) Replace with real value when Toncenter supports it\r\n      isHidden,\r\n      metadata: {\r\n        ...(isFragmentGift && {\r\n          fragmentUrl: image!.replace(NFT_FRAGMENT_GIFT_IMAGE_TO_URL_REGEX, 'https://$1'),\r\n        }),\r\n        // `id` must be set to `index + 1`. Unlike TonApi where this field is preformatted,\r\n        // we need to manually adjust it here due to data source differences.\r\n        ...(isMtwCard && buildMtwCardsNftMetadata({\r\n          id: Number(index || 0) + 1, image, attributes: extra?.attributes,\r\n        })),\r\n      },\r\n      ...(collectionAddress && {\r\n        collectionAddress,\r\n        collectionName: collectionMetadata?.name,\r\n        isOnFragment: isFragmentGift || NFT_FRAGMENT_COLLECTIONS.includes(rawCollectionAddress!),\r\n        isTelegramGift: isFragmentGift,\r\n      }),\r\n    });\r\n\r\n    return { nft };\r\n  } catch (err) {\r\n    logDebugError('parseToncenterNft', err);\r\n    return {};\r\n  }\r\n}\r\n\r\nfunction parseToncenterJetton(rawAddress: string, metadata: MetadataMap): ApiToken | undefined {\r\n  const tokenAddress = toBase64Address(rawAddress, true);\r\n  const slug = buildTokenSlug('ton', tokenAddress);\r\n  const token = getTokenBySlug(slug);\r\n\r\n  if (token) {\r\n    return token;\r\n  }\r\n\r\n  const jettonMetadata = extractMetadata<JettonMasterMetadata>(rawAddress, metadata, 'jetton_masters');\r\n\r\n  if (!jettonMetadata) {\r\n    return undefined;\r\n  }\r\n\r\n  return {\r\n    tokenAddress,\r\n    slug,\r\n    chain: 'ton',\r\n    name: jettonMetadata.name!,\r\n    symbol: jettonMetadata.symbol!,\r\n    image: jettonMetadata.image!,\r\n    decimals: Number(jettonMetadata.extra!.decimals),\r\n  };\r\n}\r\n\r\nfunction extractMetadata<T extends AnyTokenMetadata>(\r\n  rawAddress: string,\r\n  metadata: MetadataMap,\r\n  type: AnyTokenMetadata['type'],\r\n): T | undefined {\r\n  const data = metadata[rawAddress];\r\n  if (!data || !data.is_indexed) return undefined;\r\n  return data.token_info?.find((tokenInfo) => tokenInfo.type === type) as T;\r\n}\r\n\r\nfunction safeReadComment(payloadBase64: string) {\r\n  return safeExec(() => {\r\n    const cell = Cell.fromBase64(payloadBase64);\r\n    if (cell.isExotic) return undefined;\r\n    return readComment(cell.asSlice());\r\n  });\r\n}\r\n\r\nfunction buildActionActivityId(action: AnyAction, type?: 'additional') {\r\n  // `lt` in activity ID is needed for sorting when timestamps are same.\r\n  // The sorting is tuned to match the Toncenter API sorting as close as possible.\r\n  const subId = `${action.start_lt}-${action.action_id}`;\r\n  return buildTxId(\r\n    action.trace_id ?? action.trace_external_hash_norm ?? action.trace_external_hash,\r\n    subId,\r\n    type,\r\n  );\r\n}\r\n\r\nexport function parseActionActivityId(id: string) {\r\n  const { hash: traceId, subId } = parseTxId(id);\r\n  const [startLt, actionId] = subId!.split('-');\r\n  return { traceId, startLt, actionId };\r\n}\r\n\r\nfunction convertDexId(toncenterDex: DexSlug | undefined): ApiSwapDexLabel | undefined {\r\n  switch (toncenterDex) {\r\n    case 'dedust':\r\n      return 'dedust';\r\n    case 'stonfi':\r\n    case 'stonfi_v2':\r\n      return 'ston';\r\n    default:\r\n      return undefined;\r\n  }\r\n}\r\n","export function createCallbackManager<T extends AnyToVoidFunction = AnyToVoidFunction>() {\r\n  const callbacks = new Set<T>();\r\n\r\n  function addCallback(cb: T) {\r\n    callbacks.add(cb);\r\n\r\n    return () => {\r\n      removeCallback(cb);\r\n    };\r\n  }\r\n\r\n  function removeCallback(cb: T) {\r\n    callbacks.delete(cb);\r\n  }\r\n\r\n  function runCallbacks(...args: Parameters<T>) {\r\n    callbacks.forEach((callback) => {\r\n      callback(...args);\r\n    });\r\n  }\r\n\r\n  function hasCallbacks() {\r\n    return Boolean(callbacks.size);\r\n  }\r\n\r\n  return {\r\n    runCallbacks,\r\n    addCallback,\r\n    removeCallback,\r\n    hasCallbacks,\r\n  };\r\n}\r\n\r\nexport type CallbackManager<T extends AnyToVoidFunction = AnyToVoidFunction>\r\n  = ReturnType<typeof createCallbackManager<T>>;\r\n\r\nexport class EventEmitter {\r\n  private channels = new Map<string, CallbackManager>();\r\n\r\n  on(name: string, handler: AnyToVoidFunction) {\r\n    this.resolveChannel(name).addCallback(handler);\r\n    return this;\r\n  }\r\n\r\n  removeListener(name: string, handler: AnyToVoidFunction) {\r\n    this.resolveChannel(name).removeCallback(handler);\r\n    return this;\r\n  }\r\n\r\n  emit(name: string, ...args: any) {\r\n    this.resolveChannel(name).runCallbacks(...args);\r\n    return this;\r\n  }\r\n\r\n  private resolveChannel(name: string) {\r\n    let channel = this.channels.get(name);\r\n    if (!channel) {\r\n      channel = createCallbackManager();\r\n      this.channels.set(name, channel);\r\n    }\r\n\r\n    return channel;\r\n  }\r\n}\r\n","import { createCallbackManager } from './callbacks';\r\nimport { setCancellableTimeout } from './schedulers';\r\n\r\nconst focusListeners = createCallbackManager<NoneToVoidFunction>();\r\n\r\nlet isFocused = true;\r\n\r\n/**\r\n * Calls `cb` when `ms` milliseconds pass if the app is focused at that moment.\r\n * Otherwise, waits until the app is focused or `forceMs` millisecond pass (since the very beginning).\r\n * Returns a function to cancel the timers.\r\n */\r\nexport function onFocusAwareDelay(ms: number, forceMs: number, cb: NoneToVoidFunction) {\r\n  let cleanup: NoneToVoidFunction;\r\n\r\n  const callCb = () => {\r\n    cleanup();\r\n    cb();\r\n  };\r\n\r\n  // Stage 1: waiting for the minimum time to pass\r\n  cleanup = setCancellableTimeout(ms, () => {\r\n    if (isFocused) {\r\n      callCb();\r\n    } else {\r\n      // If the window is not focused, stage2: waiting for either the maximum time to pass or the window to get focused\r\n      const unsubscribeFocus = focusListeners.addCallback(callCb);\r\n      const cancelSecondTimeout = setCancellableTimeout(forceMs - ms, callCb);\r\n      cleanup = () => {\r\n        unsubscribeFocus();\r\n        cancelSecondTimeout();\r\n      };\r\n    }\r\n  });\r\n\r\n  // We don't return just `cleanup` because it's not constant\r\n  return () => cleanup();\r\n}\r\n\r\n/**\r\n * @see onFocusAwareDelay\r\n */\r\nexport function focusAwareDelay(ms: number, msWhenNotFocused: number) {\r\n  return new Promise<void>((resolve) => {\r\n    onFocusAwareDelay(ms, msWhenNotFocused, resolve);\r\n  });\r\n}\r\n\r\nexport function setIsAppFocused(_isFocused: boolean) {\r\n  isFocused = _isFocused;\r\n\r\n  if (_isFocused) {\r\n    focusListeners.runCallbacks();\r\n  }\r\n}\r\n","export const SEC = 1000;\r\nexport const MINUTE = 60 * SEC;\r\nexport const DAYS_IN_YEAR = 365;\r\nexport const FIRST_TRANSACTIONS_LIMIT = 50;\r\n\r\nexport const FAKE_TX_ID = 'fakeTxId';\r\n","import type { FallbackPollingOptions } from './fallbackPollingScheduler';\r\n\r\nimport Deferred from '../../../util/Deferred';\r\nimport { focusAwareDelay, onFocusAwareDelay } from '../../../util/focusAwareDelay';\r\nimport { setCancellableTimeout, throttle } from '../../../util/schedulers';\r\nimport { MINUTE, SEC } from '../../constants';\r\n\r\nexport type Period = number | {\r\n  focused: number;\r\n  notFocused: number;\r\n};\r\n\r\nexport const activeWalletTiming: FallbackPollingOptions = {\r\n  pollOnStart: true,\r\n  minPollDelay: { focused: SEC, notFocused: 3 * SEC },\r\n  pollingStartDelay: 3 * SEC,\r\n  pollingPeriod: { focused: 3 * SEC, notFocused: 10 * SEC },\r\n  forcedPollingPeriod: { focused: MINUTE, notFocused: 2 * MINUTE },\r\n};\r\n\r\nexport const inactiveWalletTiming: FallbackPollingOptions = {\r\n  pollOnStart: false,\r\n  minPollDelay: { focused: 5 * SEC, notFocused: 30 * SEC },\r\n  pollingStartDelay: 5 * SEC,\r\n  pollingPeriod: { focused: 30 * SEC, notFocused: MINUTE },\r\n  forcedPollingPeriod: { focused: 2 * MINUTE, notFocused: 5 * MINUTE },\r\n};\r\n\r\ninterface PollingLoopOptions<Dep> {\r\n  period: Period;\r\n  /** The minimum time between the `poll` calls */\r\n  minDelay?: Period;\r\n  /** If `true`, `poll` won't be called at the loop start */\r\n  skipInitialPoll?: boolean;\r\n  /** Called before any `poll` call */\r\n  prepare?: () => Promise<Dep>;\r\n  /** Called periodically. Never executed in parallel. If returns 'stop', the polling stops. */\r\n  poll: (dependency: Dep) => MaybePromise<void | 'stop'>;\r\n}\r\n\r\n/**\r\n * Executes the given functions indefinitely with pauses.\r\n * An execution can be triggered manually, in which case the scheduled execution will be delayed.\r\n */\r\nexport function pollingLoop<Dep>({\r\n  period,\r\n  minDelay = 0,\r\n  skipInitialPoll,\r\n  prepare = () => Promise.resolve() as Promise<Dep>,\r\n  poll,\r\n}: PollingLoopOptions<Dep>) {\r\n  let isStopped = false;\r\n  let cancelPause: NoneToVoidFunction | undefined;\r\n  const dependenciesDeferred = new Deferred<Dep>();\r\n\r\n  // Using `throttle` to avoid parallel execution\r\n  const iteration = throttle(async () => {\r\n    if (isStopped) {\r\n      return;\r\n    }\r\n\r\n    cancelPause?.();\r\n    const dependencies = await dependenciesDeferred.promise;\r\n\r\n    try {\r\n      const response = await poll(dependencies);\r\n      if (response === 'stop') {\r\n        isStopped = true;\r\n      }\r\n    } finally {\r\n      if (!isStopped) {\r\n        scheduleIteration();\r\n      }\r\n    }\r\n  }, () => {\r\n    return focusAwareDelay(...periodToMs(minDelay));\r\n  });\r\n\r\n  function scheduleIteration() {\r\n    cancelPause?.();\r\n    cancelPause = onFocusAwareDelay(...periodToMs(period), iteration);\r\n  }\r\n\r\n  void prepare().then((dependencies) => {\r\n    if (isStopped) {\r\n      return;\r\n    }\r\n\r\n    dependenciesDeferred.resolve(dependencies);\r\n\r\n    if (skipInitialPoll) {\r\n      scheduleIteration();\r\n    } else {\r\n      iteration();\r\n    }\r\n  });\r\n\r\n  return {\r\n    poll: iteration,\r\n    stop() {\r\n      isStopped = true;\r\n      cancelPause?.();\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Wraps the given `action` function. When the wrapped function is executed, it executes `action` immediately, and\r\n * several times after that. The number of additional executions is equal to `pauses.length`. Each number in `pauses` is\r\n * the pause (in milliseconds) between the `action` executions. When the wrapped function is executed, the previously\r\n * scheduled additional executions are cancelled.\r\n *\r\n * `attemptNumber` starts from 0 and increments with each additional execution.\r\n */\r\nexport function withDoubleCheck<Args extends unknown[], Result>(\r\n  pauses: number[],\r\n  action: (attemptNumber: number, ...args: Args) => MaybePromise<Result>,\r\n) {\r\n  let isStopped = false;\r\n  let cancelDoubleCheck: NoneToVoidFunction | undefined;\r\n\r\n  async function makeAttempt(attemptNumber: number, args: Args) {\r\n    cancelDoubleCheck?.();\r\n\r\n    try {\r\n      return await action(attemptNumber, ...args);\r\n    } finally {\r\n      if (!isStopped && attemptNumber < pauses.length) {\r\n        cancelDoubleCheck?.(); // Cancelling again due to possible race conditions\r\n        cancelDoubleCheck = setCancellableTimeout(\r\n          pauses[attemptNumber],\r\n          () => makeAttempt(attemptNumber + 1, args),\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    /** Executes `actions` and returns the result of the first execution */\r\n    run(...args: Args) {\r\n      isStopped = false;\r\n      return makeAttempt(0, args);\r\n    },\r\n    /** Cancels the scheduled additional executions */\r\n    cancel() {\r\n      isStopped = true;\r\n      cancelDoubleCheck?.();\r\n    },\r\n  };\r\n}\r\n\r\nexport function periodToMs(period: Period): [ms: number, forceMs: number] {\r\n  if (typeof period === 'number') {\r\n    return [period, period];\r\n  }\r\n\r\n  const { focused, notFocused } = period;\r\n  return [focused, notFocused];\r\n}\r\n","import type { Period } from './utils';\r\n\r\nimport { focusAwareDelay, onFocusAwareDelay } from '../../../util/focusAwareDelay';\r\nimport { handleError } from '../../../util/handleError';\r\nimport { throttle } from '../../../util/schedulers';\r\nimport { periodToMs } from './utils';\r\n\r\nexport type PollCallback = () => MaybePromise<void>;\r\n\r\nexport interface FallbackPollingOptions {\r\n  /** Whether `poll` should be called when the polling object is created */\r\n  pollOnStart?: boolean;\r\n  /** The minimum delay between `poll` calls */\r\n  minPollDelay: Period;\r\n  /**\r\n   * How much time the polling will start after the socket disconnects.\r\n   * Also applies at the very beginning (until the socket is connected).\r\n   * If omitted, will be the same as `pollingPeriod`.\r\n   */\r\n  pollingStartDelay?: Period;\r\n  /** Update periods when the socket is disconnected */\r\n  pollingPeriod: Period;\r\n  /** Update periods when the socket is connected but there are no messages */\r\n  forcedPollingPeriod: Period;\r\n}\r\n\r\n/**\r\n * Schedules regular polling when the socket is disconnected.\r\n */\r\nexport class FallbackPollingScheduler {\r\n  #rawPoll: PollCallback;\r\n  #options: FallbackPollingOptions;\r\n\r\n  #cancelScheduledPoll?: NoneToVoidFunction;\r\n\r\n  #isDestroyed = false;\r\n\r\n  /** `poll` is never executed in parallel */\r\n  constructor(poll: PollCallback, isSocketConnected: boolean, options: FallbackPollingOptions) {\r\n    this.#rawPoll = poll;\r\n    this.#options = options;\r\n\r\n    this.#schedulePolling(isSocketConnected);\r\n\r\n    if (options.pollOnStart) {\r\n      this.#poll();\r\n    }\r\n  }\r\n\r\n  /** Call this method when the socket source of data becomes available */\r\n  public onSocketConnect() {\r\n    if (this.#isDestroyed) return;\r\n    this.#schedulePolling(true);\r\n    this.#poll();\r\n  }\r\n\r\n  /** Call this method when the socket source of data becomes unavailable */\r\n  public onSocketDisconnect() {\r\n    if (this.#isDestroyed) return;\r\n    this.#schedulePolling(false);\r\n  }\r\n\r\n  /** Call this method when the socket shows that it's alive */\r\n  public onSocketMessage() {\r\n    if (this.#isDestroyed) return;\r\n    this.#schedulePolling(true);\r\n  }\r\n\r\n  public destroy() {\r\n    this.#isDestroyed = true;\r\n    this.#cancelScheduledPoll?.();\r\n  }\r\n\r\n  // Using `throttle` to avoid parallel execution.\r\n  #poll = throttle(async () => {\r\n    if (this.#isDestroyed) return;\r\n\r\n    try {\r\n      await this.#rawPoll();\r\n    } catch (err: any) {\r\n      handleError(err);\r\n    }\r\n  }, () => {\r\n    return focusAwareDelay(...periodToMs(this.#options.minPollDelay));\r\n  });\r\n\r\n  #schedulePolling(isSocketConnected: boolean) {\r\n    this.#cancelScheduledPoll?.();\r\n\r\n    const { pollingPeriod, pollingStartDelay = pollingPeriod, forcedPollingPeriod } = this.#options;\r\n    const firstPause = isSocketConnected ? forcedPollingPeriod : pollingStartDelay;\r\n    const nextPause = isSocketConnected ? forcedPollingPeriod : pollingPeriod;\r\n\r\n    const schedule = (isFirst?: boolean) => {\r\n      this.#cancelScheduledPoll = onFocusAwareDelay(...periodToMs(isFirst ? firstPause : nextPause), () => {\r\n        schedule();\r\n        this.#poll();\r\n      });\r\n    };\r\n\r\n    schedule(true);\r\n  }\r\n}\r\n","import { DEFAULT_TIMEOUT } from '../config';\r\nimport { createCallbackManager } from './callbacks';\r\nimport { logDebug, logDebugError } from './logs';\r\nimport { setCancellableTimeout } from './schedulers';\r\n\r\nexport type InMessageCallback<T> = (message: T) => void;\r\nexport type ConnectCallback = NoneToVoidFunction;\r\n/** isUnexpected is false when the socket is closed manually, i.e. by calling close() */\r\nexport type DisconnectCallback = (isUnexpected: boolean) => void;\r\n\r\nconst RECONNECT_BASE_DELAY = 500;\r\nconst RECONNECT_MAX_DELAY = 5000;\r\n\r\n/**\r\n * Like WebSocket, but reconnects automatically when the socket disconnects\r\n */\r\nexport default class ReconnectingWebSocket<OutMessage, InMessage> {\r\n  #url: string;\r\n\r\n  #socket?: WebSocket;\r\n\r\n  /** `true` between the `open` and the `close` events, i.e. when the socket can send and receive messages */\r\n  #isConnected = false;\r\n\r\n  #reconnectAttemptCount = 0;\r\n\r\n  /** Cancels setTimeout of the WebSocket open timeout and the reconnect delay (they never happen simultaneously) */\r\n  #cancelTimeout?: NoneToVoidFunction;\r\n\r\n  #outMessageQueue: OutMessage[] = [];\r\n\r\n  #inMessageListeners = createCallbackManager<InMessageCallback<InMessage>>();\r\n\r\n  #connectListeners = createCallbackManager<ConnectCallback>();\r\n\r\n  #disconnectListeners = createCallbackManager<DisconnectCallback>();\r\n\r\n  constructor(url: string | URL) {\r\n    this.#url = url.toString();\r\n    this.#startSocket();\r\n  }\r\n\r\n  /**\r\n   * Sends a message via the socket.\r\n   * If the socket is disconnected, stashes the message until the socket is connected.\r\n   */\r\n  public send(message: OutMessage) {\r\n    if (this.#socket && this.#isConnected) {\r\n      this.#sendMessageNow(message);\r\n    } else {\r\n      this.#outMessageQueue.push(message);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns `true` is the socket is connected now. You may send messages regardless of the connection status.\r\n   * The objects always initializes in the disconnected state.\r\n   */\r\n  public get isConnected() {\r\n    return this.#isConnected;\r\n  }\r\n\r\n  /** Closes the current socket connection and creates a new one. Call it when you suspect the socket has hung. */\r\n  public reconnect() {\r\n    this.close();\r\n    this.#startSocket();\r\n  }\r\n\r\n  /** Registers a callback firing when a message arrives from the socket */\r\n  public onMessage(callback: InMessageCallback<InMessage>) {\r\n    return this.#inMessageListeners.addCallback(callback);\r\n  }\r\n\r\n  /**\r\n   * Registers a callback firing when the socket is connected initially or reconnected.\r\n   * I.e. when isConnected switches from `false` to `true`.\r\n   */\r\n  public onConnect(callback: ConnectCallback) {\r\n    return this.#connectListeners.addCallback(callback);\r\n  }\r\n\r\n  /**\r\n   * Registers a callback firing when the socket is disconnected.\r\n   * I.e. when isConnected switches from `true` to `false`.\r\n   */\r\n  public onDisconnect(callback: DisconnectCallback) {\r\n    return this.#disconnectListeners.addCallback(callback);\r\n  }\r\n\r\n  /** Call it when you don't need the socket anymore. The callbacks won't fire after that. */\r\n  public close() {\r\n    this.#stopSocket();\r\n\r\n    if (this.#isConnected) {\r\n      this.#isConnected = false;\r\n      this.#disconnectListeners.runCallbacks(false);\r\n    }\r\n  }\r\n\r\n  #startSocket() {\r\n    this.#stopSocket();\r\n\r\n    this.#socket = new WebSocket(this.#url);\r\n    this.#socket.binaryType = 'arraybuffer';\r\n\r\n    this.#socket.onerror = () => logDebugError('WebSocket error event', this.#url);\r\n    this.#socket.onopen = this.#handleSocketOpen;\r\n    this.#socket.onclose = this.#handleSocketClose;\r\n    this.#socket.onmessage = this.#handleSocketMessage;\r\n\r\n    // If the socket doesn't open in several seconds, retry opening it\r\n    this.#cancelTimeout = setCancellableTimeout(DEFAULT_TIMEOUT, () => this.#handleSocketClose('openTimeout'));\r\n  }\r\n\r\n  #stopSocket() {\r\n    this.#cancelTimeout?.();\r\n\r\n    if (!this.#socket) {\r\n      return;\r\n    }\r\n\r\n    this.#socket.onerror = null; // eslint-disable-line no-null/no-null\r\n    this.#socket.onopen = null; // eslint-disable-line no-null/no-null\r\n    this.#socket.onclose = null; // eslint-disable-line no-null/no-null\r\n    this.#socket.onmessage = null; // eslint-disable-line no-null/no-null\r\n    this.#socket.close();\r\n\r\n    this.#socket = undefined;\r\n  }\r\n\r\n  #sendMessageNow(message: OutMessage) {\r\n    if (!this.#socket) throw new Error('No active socket');\r\n    this.#socket.send(JSON.stringify(message));\r\n  }\r\n\r\n  #handleSocketOpen = () => {\r\n    logDebug('WebSocket opened', this.#url);\r\n\r\n    this.#cancelTimeout?.();\r\n    this.#reconnectAttemptCount = 0;\r\n\r\n    while (this.#outMessageQueue.length) {\r\n      this.#sendMessageNow(this.#outMessageQueue.shift()!);\r\n    }\r\n\r\n    if (!this.#isConnected) {\r\n      this.#isConnected = true;\r\n      this.#connectListeners.runCallbacks();\r\n    }\r\n  };\r\n\r\n  #handleSocketClose = (event: CloseEvent | 'openTimeout') => {\r\n    if (event === 'openTimeout') {\r\n      logDebugError('WebSocket open timeout');\r\n    } else {\r\n      logDebugError('WebSocket closed unexpectedly', event.code, event.reason, event.wasClean);\r\n    }\r\n\r\n    this.#stopSocket();\r\n\r\n    this.#reconnectAttemptCount++;\r\n    const reconnectDelay = Math.min(RECONNECT_BASE_DELAY * this.#reconnectAttemptCount, RECONNECT_MAX_DELAY);\r\n    this.#cancelTimeout = setCancellableTimeout(reconnectDelay, () => this.#startSocket());\r\n\r\n    if (this.#isConnected) {\r\n      if (event === 'openTimeout') {\r\n        throw new Error('Unexpected timeout event in an open socket');\r\n      }\r\n\r\n      this.#isConnected = false;\r\n      this.#disconnectListeners.runCallbacks(true);\r\n    }\r\n  };\r\n\r\n  #handleSocketMessage = ({ data }: MessageEvent<string | ArrayBuffer>) => {\r\n    this.#inMessageListeners.runCallbacks(\r\n      data instanceof ArrayBuffer\r\n        ? data as InMessage\r\n        : JSON.parse(data),\r\n    );\r\n  };\r\n}\r\n","import type { ApiActivity, ApiNetwork } from '../../../types';\r\nimport type {\r\n  AccountStateChangeSocketMessage,\r\n  ActionsSocketMessage,\r\n  AddressBook,\r\n  AnyAction,\r\n  ClientSocketMessage,\r\n  JettonChangeSocketMessage,\r\n  ServerSocketMessage,\r\n  SocketSubscriptionEvent,\r\n} from './types';\r\n\r\nimport { TONCENTER_ACTIONS_VERSION } from '../../../../config';\r\nimport ReconnectingWebSocket, { type InMessageCallback } from '../../../../util/reconnectingWebsocket';\r\nimport safeExec from '../../../../util/safeExec';\r\nimport { forbidConcurrency, setCancellableTimeout, throttle } from '../../../../util/schedulers';\r\nimport withCache from '../../../../util/withCache';\r\nimport { areAddressesEqual, toBase64Address } from '../util/tonCore';\r\nimport { getNftSuperCollectionsByCollectionAddress } from '../../../common/addresses';\r\nimport { addBackendHeadersToSocketUrl } from '../../../common/backend';\r\nimport { SEC } from '../../../constants';\r\nimport { NETWORK_CONFIG } from '../constants';\r\nimport { parseActions } from './actions';\r\n\r\nconst ACTUALIZATION_DELAY = 10;\r\n\r\n// Toncenter closes the socket after 30 seconds of inactivity\r\nconst PING_INTERVAL = 20 * SEC;\r\n\r\n// When the internet connection is interrupted, the Toncenter socket doesn't always disconnect automatically.\r\n// Disconnecting manually if there is no response for \"ping\".\r\nconst PONG_TIMEOUT = 5 * SEC;\r\n\r\nexport interface WalletWatcher {\r\n  /** Whether the socket is connected and subscribed to the given wallets */\r\n  readonly isConnected: boolean;\r\n  /** Removes the watcher and cleans the memory */\r\n  destroy(): void;\r\n}\r\n\r\ninterface WalletWatcherInternal extends WalletWatcher {\r\n  id: number;\r\n  addresses: string[];\r\n  isConnected: boolean;\r\n  /**\r\n   * Called when new activities (either regular or pending) arrive into one of the listened address.\r\n   *\r\n   * Called only when `isConnected` is true. Therefore, when the socket reconnects, the users should synchronize,\r\n   * otherwise the activities arriving during the reconnect will miss.\r\n   */\r\n  onNewActivities?: NewActivitiesCallback;\r\n  /**\r\n   * Called when a balance changes (either TON or token) in one of the listened address.\r\n   *\r\n   * Called only when `isConnected` is true. Therefore, when the socket reconnects, the users should synchronize,\r\n   * otherwise the balances changed during the reconnect will be outdated.\r\n   */\r\n  onBalanceUpdate?: BalanceUpdateCallback;\r\n  /** Called when isConnected turns true */\r\n  onConnect?: NoneToVoidFunction;\r\n  /** Called when isConnected turns false */\r\n  onDisconnect?: NoneToVoidFunction;\r\n}\r\n\r\nexport type NewActivitiesCallback = (update: ActivitiesUpdate) => void;\r\n\r\nexport interface ActivitiesUpdate {\r\n  address: string;\r\n  /**\r\n   * Multiple events with the same normalized hash can arrive. Every time it happens, the new event data must replace\r\n   * the previous event data in the app state. If the `activities` array is empty, the actions with that normalized hash\r\n   * must be removed from the app state. Pending actions are eventually either removed or replaced with confirmed actions.\r\n   */\r\n  messageHashNormalized: string;\r\n  /** Pending actions are not confirmed by the blockchain yet */\r\n  arePending: boolean;\r\n  /** The activities may be unsorted */\r\n  activities: ApiActivity[];\r\n}\r\n\r\nexport type BalanceUpdateCallback = (update: BalanceUpdate) => void;\r\n\r\nexport interface BalanceUpdate {\r\n  address: string;\r\n  /** `undefined` for TON */\r\n  tokenAddress?: string;\r\n  balance: bigint;\r\n}\r\n\r\n/**\r\n * Connects to Toncenter to passively listen to updates.\r\n */\r\nclass ToncenterSocket {\r\n  #network: ApiNetwork;\r\n\r\n  #socket?: ReconnectingWebSocket<ClientSocketMessage, ServerSocketMessage>;\r\n\r\n  /** See #rememberAddressesOfNormalizedHash */\r\n  #addressesByHash: Record<string, string[]> = {};\r\n\r\n  #walletWatchers: WalletWatcherInternal[] = [];\r\n\r\n  /**\r\n   * A shared incremental counter for various unique ids. The fact that it's incremental is used to tell what actions\r\n   * happened earlier or later than others.\r\n   */\r\n  #currentUniqueId = 0;\r\n\r\n  #stopPing?: NoneToVoidFunction;\r\n  #cancelReconnect?: NoneToVoidFunction;\r\n\r\n  constructor(network: ApiNetwork) {\r\n    this.#network = network;\r\n  }\r\n\r\n  public watchWallets(\r\n    addresses: string[],\r\n    {\r\n      onNewActivities,\r\n      onBalanceUpdate,\r\n      onConnect,\r\n      onDisconnect,\r\n    }: Pick<WalletWatcherInternal, 'onNewActivities' | 'onBalanceUpdate' | 'onConnect' | 'onDisconnect'> = {},\r\n  ): WalletWatcher {\r\n    const id = this.#currentUniqueId++;\r\n    const watcher: WalletWatcherInternal = {\r\n      id,\r\n      addresses,\r\n      // The status will turn to `true` via `#actualizeSocket`  `#sendWatchedWalletsToSocket`  socket request  socket response  `#handleSubscriptionSet`\r\n      isConnected: false,\r\n      onNewActivities,\r\n      onBalanceUpdate,\r\n      onConnect,\r\n      onDisconnect,\r\n      destroy: this.#destroyWalletWatcher.bind(this, id),\r\n    };\r\n    this.#walletWatchers.push(watcher);\r\n    this.#actualizeSocket();\r\n    return watcher;\r\n  }\r\n\r\n  /** Removes the given watcher and unsubscribes from its wallets. Brings the sockets to the proper state. */\r\n  #destroyWalletWatcher(watcherId: number) {\r\n    const index = this.#walletWatchers.findIndex((watcher) => watcher.id === watcherId);\r\n    if (index >= 0) {\r\n      this.#walletWatchers.splice(index, 1);\r\n      this.#actualizeSocket();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates or destroys the given socket (if needed) and subscribes to the watched wallets.\r\n   *\r\n   * The method is throttled in order to:\r\n   *  - Avoid sending too many requests when the watched addresses change many times in a short time range.\r\n   *  - Avoid reconnecting the socket when watched addresses arrive shortly after stopping watching all addresses.\r\n   */\r\n  #actualizeSocket = throttle(() => {\r\n    if (this.#doesHaveWatchedAddresses()) {\r\n      this.#socket ??= this.#createSocket();\r\n      if (this.#socket.isConnected) {\r\n        this.#sendWatchedWalletsToSocket();\r\n      } // Otherwise, the addresses will be sent when the socket gets connected\r\n    } else {\r\n      this.#socket?.close();\r\n      this.#socket = undefined;\r\n    }\r\n  }, ACTUALIZATION_DELAY, false);\r\n\r\n  #createSocket() {\r\n    const url = getSocketUrl(this.#network);\r\n    const socket = new ReconnectingWebSocket<ClientSocketMessage, ServerSocketMessage>(url);\r\n    socket.onMessage(this.#handleSocketMessage);\r\n    socket.onConnect(this.#handleSocketConnect);\r\n    socket.onDisconnect(this.#handleSocketDisconnect);\r\n    return socket;\r\n  }\r\n\r\n  #handleSocketMessage: InMessageCallback<ServerSocketMessage> = (message) => {\r\n    this.#cancelReconnect?.();\r\n\r\n    if ('status' in message) {\r\n      if (message.status === 'subscription_set') {\r\n        this.#handleSubscriptionSet(message);\r\n      }\r\n    }\r\n\r\n    if ('type' in message) {\r\n      if (message.type === 'trace_invalidated') {\r\n        message = {\r\n          ...message,\r\n          type: 'pending_actions',\r\n          actions: [],\r\n          address_book: {},\r\n          metadata: {},\r\n        };\r\n        // Falling down to the below `switch` intentionally\r\n      }\r\n\r\n      switch (message.type) {\r\n        case 'actions':\r\n        case 'pending_actions':\r\n          void this.#handleNewActions(message);\r\n          break;\r\n        case 'account_state_change':\r\n          this.#handleAccountStateChange(message);\r\n          break;\r\n        case 'jettons_change':\r\n          this.#handleJettonChange(message);\r\n          break;\r\n      }\r\n    }\r\n  };\r\n\r\n  #handleSocketConnect = () => {\r\n    this.#socket?.send({\r\n      operation: 'configure',\r\n      include_address_book: true,\r\n      include_metadata: true,\r\n      supported_action_types: [TONCENTER_ACTIONS_VERSION],\r\n    });\r\n    this.#sendWatchedWalletsToSocket();\r\n\r\n    this.#startPing();\r\n  };\r\n\r\n  #handleSocketDisconnect = () => {\r\n    this.#stopPing?.();\r\n\r\n    for (const watcher of this.#walletWatchers) {\r\n      if (watcher.isConnected) {\r\n        watcher.isConnected = false;\r\n        if (watcher.onDisconnect) safeExec(watcher.onDisconnect);\r\n      }\r\n    }\r\n  };\r\n\r\n  #handleSubscriptionSet(message: Extract<ServerSocketMessage, { status: any }>) {\r\n    for (const watcher of this.#walletWatchers) {\r\n      // If message id < watcher id, then the watcher was created after the subscribe request was sent, therefore\r\n      // the socket may be not subscribed to all the watcher addresses yet.\r\n      if (message.id && Number(message.id) < watcher.id) {\r\n        continue;\r\n      }\r\n\r\n      if (!watcher.isConnected) {\r\n        watcher.isConnected = true;\r\n        if (watcher.onConnect) safeExec(watcher.onConnect);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Limiting the concurrency to 1 to ensure the new activities are reported in the order they were received\r\n  #handleNewActions = forbidConcurrency(async (message: ActionsSocketMessage) => {\r\n    const arePending = message.type === 'pending_actions';\r\n    const messageHashNormalized = message.trace_external_hash_norm;\r\n    const activitiesByAddress = await parseSocketActions(\r\n      this.#network,\r\n      message,\r\n      this.#getAddressesReadyForActivities(),\r\n    );\r\n    const addressesToNotify = this.#rememberAddressesOfHash(\r\n      messageHashNormalized,\r\n      Object.keys(activitiesByAddress),\r\n      arePending,\r\n    );\r\n\r\n    for (const watcher of this.#walletWatchers) {\r\n      if (!isWatcherReadyForNewActivities(watcher)) {\r\n        continue;\r\n      }\r\n\r\n      for (const address of watcher.addresses) {\r\n        if (!addressesToNotify.has(address)) {\r\n          continue;\r\n        }\r\n\r\n        safeExec(() => watcher.onNewActivities({\r\n          address,\r\n          messageHashNormalized,\r\n          arePending,\r\n          activities: activitiesByAddress[address] ?? [],\r\n        }));\r\n      }\r\n    }\r\n  });\r\n\r\n  #handleAccountStateChange(message: AccountStateChangeSocketMessage) {\r\n    this.#notifyBalanceUpdate(\r\n      message.account,\r\n      undefined,\r\n      BigInt(message.state.balance),\r\n    );\r\n  }\r\n\r\n  #handleJettonChange(message: JettonChangeSocketMessage) {\r\n    this.#notifyBalanceUpdate(\r\n      message.jetton.owner,\r\n      toBase64Address(message.jetton.jetton, true, this.#network),\r\n      BigInt(message.jetton.balance),\r\n    );\r\n  }\r\n\r\n  #notifyBalanceUpdate(rawAddress: string, tokenBase64Address: string | undefined, balance: bigint) {\r\n    for (const watcher of this.#walletWatchers) {\r\n      const { onBalanceUpdate } = watcher;\r\n\r\n      if (!isWatcherReady(watcher) || !onBalanceUpdate) {\r\n        continue;\r\n      }\r\n\r\n      for (const watchedAddress of watcher.addresses) {\r\n        if (!areAddressesEqual(watchedAddress, rawAddress)) {\r\n          continue;\r\n        }\r\n\r\n        safeExec(() => onBalanceUpdate({\r\n          address: watchedAddress,\r\n          tokenAddress: tokenBase64Address,\r\n          balance,\r\n        }));\r\n      }\r\n    }\r\n  }\r\n\r\n  #sendWatchedWalletsToSocket() {\r\n    // It's necessary to collect the watched addresses synchronously with locking the request id.\r\n    // It makes sure that all the watchers with ids < the response id will be subscribed.\r\n    const subscriptions = this.#getAddressSubscriptions();\r\n    const requestId = String(this.#currentUniqueId++);\r\n\r\n    // It's necessary to send a `set_subscription` request on every `#sendWatchedWalletsToSocket` call, even if the list\r\n    // of addresses hasn't changed. Otherwise, the mechanism turning `isConnected` to `true` in the watchers will break\r\n    // if a new watcher containing only existing addresses is added.\r\n    this.#socket!.send({\r\n      operation: 'set_subscription',\r\n      id: requestId,\r\n      subscriptions,\r\n    });\r\n  }\r\n\r\n  #doesHaveWatchedAddresses() {\r\n    return this.#walletWatchers.some((watcher) => watcher.addresses.length);\r\n  }\r\n\r\n  #getAddressSubscriptions() {\r\n    const subscriptions: Record<string, Set<SocketSubscriptionEvent>> = {};\r\n\r\n    for (const watcher of this.#walletWatchers) {\r\n      for (const address of watcher.addresses) {\r\n        subscriptions[address] ||= new Set();\r\n\r\n        if (watcher.onNewActivities) {\r\n          subscriptions[address].add('actions');\r\n          subscriptions[address].add('pending_actions');\r\n        }\r\n\r\n        if (watcher.onBalanceUpdate) {\r\n          subscriptions[address].add('account_state_change');\r\n          subscriptions[address].add('jettons_change');\r\n        }\r\n      }\r\n    }\r\n\r\n    const preparedSubscriptions: Record<string, SocketSubscriptionEvent[]> = {};\r\n\r\n    for (const [address, events] of Object.entries(subscriptions)) {\r\n      if (events.size) {\r\n        preparedSubscriptions[address] = [...events];\r\n      }\r\n    }\r\n\r\n    return preparedSubscriptions;\r\n  }\r\n\r\n  #getAddressesReadyForActivities() {\r\n    const watchedAddresses = new Set<string>();\r\n\r\n    for (const watcher of this.#walletWatchers) {\r\n      if (isWatcherReadyForNewActivities(watcher)) {\r\n        for (const address of watcher.addresses) {\r\n          watchedAddresses.add(address);\r\n        }\r\n      }\r\n    }\r\n\r\n    return watchedAddresses;\r\n  }\r\n\r\n  #startPing() {\r\n    this.#stopPing?.();\r\n\r\n    const pingIntervalId = setInterval(() => {\r\n      this.#socket?.send({ operation: 'ping' });\r\n\r\n      this.#cancelReconnect?.();\r\n      this.#cancelReconnect = setCancellableTimeout(PONG_TIMEOUT, () => {\r\n        this.#socket?.reconnect();\r\n      });\r\n    }, PING_INTERVAL);\r\n\r\n    this.#stopPing = () => clearInterval(pingIntervalId);\r\n  }\r\n\r\n  /**\r\n   * When a pending action is invalidated, a message arrives with no data except the normalized hash. In order to find\r\n   * what addresses it belongs to and notify those addresses, we save the addresses from the previous message with the\r\n   * same normalized hash.\r\n   *\r\n   * @returns The addresses that should be notified about the new actions, even if no new action belongs to the address\r\n   */\r\n  #rememberAddressesOfHash(\r\n    messageHashNormalized: string,\r\n    newActionAddresses: Iterable<string>,\r\n    areNewActionsPending: boolean,\r\n  ) {\r\n    const prevSavedAddresses = this.#addressesByHash[messageHashNormalized] ?? [];\r\n    const nextSavedAddresses: string[] = [];\r\n    const addressesToNotify = new Set<string>();\r\n\r\n    // Notifying the addresses where the actions were seen at previously. It is necessary to let the addresses know that\r\n    // the given normalized message hash is no longer in the activity history.\r\n    for (const address of prevSavedAddresses) {\r\n      addressesToNotify.add(address);\r\n    }\r\n\r\n    for (const address of newActionAddresses) {\r\n      addressesToNotify.add(address);\r\n\r\n      // Saving the corresponding addresses only for pending actions, because confirmed actions don't change or invalidate\r\n      if (areNewActionsPending) {\r\n        nextSavedAddresses.push(address);\r\n      }\r\n    }\r\n\r\n    if (nextSavedAddresses.length) {\r\n      this.#addressesByHash[messageHashNormalized] = nextSavedAddresses;\r\n    } else {\r\n      delete this.#addressesByHash[messageHashNormalized];\r\n    }\r\n\r\n    return addressesToNotify;\r\n  }\r\n}\r\n\r\nexport type { ToncenterSocket };\r\n\r\n/** Returns a singleton (one constant instance per a network) */\r\nexport const getToncenterSocket = withCache((network: ApiNetwork) => {\r\n  return new ToncenterSocket(network);\r\n});\r\n\r\n/**\r\n * Returns true if the activities update is final, i.e. no other updates are expected for the corresponding message hash.\r\n */\r\nexport function isActivityUpdateFinal(update: ActivitiesUpdate) {\r\n  return !update.arePending || !update.activities.length;\r\n}\r\n\r\nfunction getSocketUrl(network: ApiNetwork) {\r\n  const url = new URL(NETWORK_CONFIG[network].toncenterUrl);\r\n  url.protocol = 'wss:';\r\n  url.pathname = '/api/streaming/v1/ws';\r\n  addBackendHeadersToSocketUrl(url);\r\n  return url;\r\n}\r\n\r\nasync function parseSocketActions(network: ApiNetwork, message: ActionsSocketMessage, addressWhitelist: Set<string>) {\r\n  const actionsByAddress = groupActionsByAddress(message.actions, message.address_book);\r\n  const activitiesByAddress: Record<string, ApiActivity[]> = {};\r\n  const nftSuperCollectionsByCollectionAddress = await getNftSuperCollectionsByCollectionAddress();\r\n\r\n  for (const [address, actions] of Object.entries(actionsByAddress)) {\r\n    if (!addressWhitelist.has(address)) {\r\n      continue;\r\n    }\r\n\r\n    activitiesByAddress[address] = parseActions(\r\n      network,\r\n      address,\r\n      actions,\r\n      message.address_book,\r\n      message.metadata,\r\n      nftSuperCollectionsByCollectionAddress,\r\n      message.type === 'pending_actions',\r\n    );\r\n  }\r\n\r\n  return activitiesByAddress;\r\n}\r\n\r\nfunction groupActionsByAddress(actions: AnyAction[], addressBook: AddressBook) {\r\n  const byAddress: Record<string, AnyAction[]> = {};\r\n\r\n  for (const action of actions) {\r\n    for (const rawAddress of action.accounts!) {\r\n      const address = addressBook[rawAddress]?.user_friendly ?? rawAddress;\r\n      byAddress[address] ??= [];\r\n      byAddress[address].push(action);\r\n    }\r\n  }\r\n\r\n  return byAddress;\r\n}\r\n\r\nfunction isWatcherReady(watcher: WalletWatcherInternal) {\r\n  // Even though the socket may already listen to some wallet addresses, we promise the class users to trigger the\r\n  // callbacks only in the connected state.\r\n  return watcher.isConnected;\r\n}\r\n\r\nfunction isWatcherReadyForNewActivities(\r\n  watcher: WalletWatcherInternal,\r\n): watcher is WalletWatcherInternal & { onNewActivities: NewActivitiesCallback } {\r\n  return isWatcherReady(watcher) && !!watcher.onNewActivities;\r\n}\r\n","import type { ActivitiesUpdate, NewActivitiesCallback } from './socket';\r\n\r\nimport { setCancellableTimeout } from '../../../../util/schedulers';\r\nimport { isActivityUpdateFinal } from './socket';\r\n\r\n/**\r\n * The Toncenter websocket sends too many updates of pending actions. For example, sends a pending activity right before\r\n * sending the confirmed version of that activity. This function throttles them, but makes sure the pending actions are\r\n * created immediately.\r\n */\r\nexport function throttleToncenterSocketActions(\r\n  delayMs: number,\r\n  onUpdates: (updates: ActivitiesUpdate[]) => void,\r\n): NewActivitiesCallback {\r\n  // A record item is created when the first pending version arrives and is removed when it gets confirmed or invalidated.\r\n  // All message hashes are throttled independently.\r\n  const updatesByHash: Record<string, { toReport?: ActivitiesUpdate; cancelReport?: NoneToVoidFunction }> = {};\r\n\r\n  const scheduleReport = (hash: string) => {\r\n    updatesByHash[hash] ??= {};\r\n    updatesByHash[hash].cancelReport ??= setCancellableTimeout(delayMs, () => {\r\n      delete updatesByHash[hash].cancelReport;\r\n      const { toReport } = updatesByHash[hash];\r\n      if (toReport) {\r\n        onUpdates([toReport]);\r\n      }\r\n    });\r\n  };\r\n\r\n  return (update) => {\r\n    const hash = update.messageHashNormalized;\r\n\r\n    if (isActivityUpdateFinal(update)) {\r\n      // This is the final update for the hash. It should be delivered immediately and removed.\r\n      updatesByHash[hash]?.cancelReport?.();\r\n      delete updatesByHash[hash];\r\n      onUpdates([update]);\r\n    } else if (!updatesByHash[hash]) {\r\n      // This is the first version of the hash's update. It should (and must for pendings) be delivered immediately.\r\n      onUpdates([update]);\r\n      scheduleReport(hash);\r\n    } else {\r\n      // Otherwise, throttle the update\r\n      updatesByHash[hash].toReport = update;\r\n      scheduleReport(hash);\r\n    }\r\n  };\r\n}\r\n","import type { FallbackPollingOptions } from '../../../common/polling/fallbackPollingScheduler';\r\nimport type { Period } from '../../../common/polling/utils';\r\nimport type { ApiActivity, ApiNetwork } from '../../../types';\r\nimport type { ActivitiesUpdate, WalletWatcher } from './socket';\r\n\r\nimport { mergeSortedActivities, sortActivities } from '../../../../util/activities/order';\r\nimport { createCallbackManager } from '../../../../util/callbacks';\r\nimport { focusAwareDelay } from '../../../../util/focusAwareDelay';\r\nimport { extractKey } from '../../../../util/iteratees';\r\nimport { logDebugError } from '../../../../util/logs';\r\nimport { FallbackPollingScheduler } from '../../../common/polling/fallbackPollingScheduler';\r\nimport { periodToMs } from '../../../common/polling/utils';\r\nimport { FIRST_TRANSACTIONS_LIMIT } from '../../../constants';\r\nimport { fetchActions, fetchPendingActions } from './actions';\r\nimport { getToncenterSocket, isActivityUpdateFinal } from './socket';\r\nimport { throttleToncenterSocketActions } from './throttleSocketActions';\r\n\r\nconst SOCKET_THROTTLE_DELAY = 250;\r\nconst FINISHED_HASH_MEMORY_SIZE = 100;\r\n\r\n/**\r\n * The activities are sorted by timestamp descending.\r\n * The updates may arrive not in the order of activity time and may duplicate.\r\n * `allPendingActivities` doesn't contain activities with the hashes of the current or past confirmed activities.\r\n */\r\nexport type OnActivityUpdate = (\r\n  newConfirmedActivities: ApiActivity[],\r\n  allPendingActivities: readonly ApiActivity[],\r\n) => void;\r\n\r\nexport type OnLoadingChange = (isLoading: boolean) => void;\r\n\r\n/**\r\n * Streams the new activities (confirmed and pending) in the given TON wallet as they are received from the Toncenter\r\n * API (with no artificial activities like CEX swaps). Uses the socket, and fallbacks to HTTP polling when the socket is\r\n * unavailable.\r\n */\r\nexport class ActivityStream {\r\n  #network: ApiNetwork;\r\n  #address: string;\r\n  #minPollDelay: Period;\r\n\r\n  #newestConfirmedActivityTimestamp?: number;\r\n\r\n  #pendingActivities = managePendingActivities();\r\n\r\n  #walletWatcher: WalletWatcher;\r\n\r\n  #fallbackPollingScheduler: FallbackPollingScheduler;\r\n\r\n  #updateListeners = createCallbackManager<OnActivityUpdate>();\r\n  #loadingListeners = createCallbackManager<OnLoadingChange>();\r\n\r\n  /** When `true`, the polling retries until succeeds, and the confirmed actions from the socket get stashed */\r\n  #doesNeedToRestoreHistory = false;\r\n\r\n  /** Sorted by timestamp descending */\r\n  #socketConfirmedActionsStash: ApiActivity[] = [];\r\n\r\n  #isDestroyed = false;\r\n\r\n  constructor(\r\n    network: ApiNetwork,\r\n    address: string,\r\n    newestConfirmedActivityTimestamp: number | undefined,\r\n    fallbackPollingOptions: FallbackPollingOptions,\r\n  ) {\r\n    this.#network = network;\r\n    this.#address = address;\r\n    this.#minPollDelay = fallbackPollingOptions.minPollDelay;\r\n    this.#newestConfirmedActivityTimestamp = newestConfirmedActivityTimestamp;\r\n\r\n    this.#walletWatcher = getToncenterSocket(network).watchWallets(\r\n      [address],\r\n      {\r\n        onConnect: this.#handleSocketConnect,\r\n        onDisconnect: this.#handleSocketDisconnect,\r\n        onNewActivities: throttleToncenterSocketActions(SOCKET_THROTTLE_DELAY, this.#handleSocketNewActivities),\r\n      },\r\n    );\r\n\r\n    this.#doesNeedToRestoreHistory = this.#walletWatcher.isConnected;\r\n\r\n    this.#fallbackPollingScheduler = new FallbackPollingScheduler(\r\n      this.#poll,\r\n      this.#walletWatcher.isConnected,\r\n      fallbackPollingOptions,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Registers a callback firing then new activities arrive.\r\n   * The callback calls are throttled.\r\n   */\r\n  public onUpdate(callback: OnActivityUpdate) {\r\n    return this.#updateListeners.addCallback(callback);\r\n  }\r\n\r\n  /**\r\n   * Registers a callback firing when the regular polling starts of finishes.\r\n   * Guaranteed to be called with `isLoading=false` after calling the `onUpdate` callbacks.\r\n   */\r\n  public onLoadingChange(callback: OnLoadingChange) {\r\n    return this.#loadingListeners.addCallback(callback);\r\n  }\r\n\r\n  public destroy() {\r\n    this.#isDestroyed = true;\r\n    this.#walletWatcher.destroy();\r\n    this.#fallbackPollingScheduler.destroy();\r\n  }\r\n\r\n  #handleSocketConnect = () => {\r\n    // When the socket gets connected, it's important to load the confirmed activities since the last activity,\r\n    // otherwise the activities arriving from the socket will create a gap in the activity history.\r\n    this.#doesNeedToRestoreHistory = true;\r\n    this.#fallbackPollingScheduler.onSocketConnect();\r\n  };\r\n\r\n  #handleSocketDisconnect = () => {\r\n    this.#doesNeedToRestoreHistory = false;\r\n    this.#fallbackPollingScheduler.onSocketDisconnect();\r\n  };\r\n\r\n  #handleSocketNewActivities = (updates: ActivitiesUpdate[]) => {\r\n    if (this.#isDestroyed) return;\r\n    this.#fallbackPollingScheduler.onSocketMessage();\r\n\r\n    const pendingUpdates = updates.filter((update) => update.arePending);\r\n    const confirmedActivities = sortActivities(\r\n      updates\r\n        .filter((update) => !update.arePending)\r\n        .flatMap((update) => update.activities),\r\n    );\r\n\r\n    const instantConfirmedActivities = this.#doesNeedToRestoreHistory ? [] : confirmedActivities;\r\n    const stashedConfirmedActivities = this.#doesNeedToRestoreHistory ? confirmedActivities : [];\r\n\r\n    // One of the goals here is preventing the stashed activities from removing pending activities (switching an activity\r\n    // from pending to confirmed must be seamless). Another goal is delivering the pending activities with no delay.\r\n    this.#socketConfirmedActionsStash.unshift(...stashedConfirmedActivities);\r\n    this.#handleNewActivities(instantConfirmedActivities, undefined, pendingUpdates);\r\n  };\r\n\r\n  /** Fetches the activities when the socket is not connected or has just connected */\r\n  #poll = async () => {\r\n    try {\r\n      this.#loadingListeners.runCallbacks(true);\r\n\r\n      const [pendingActivities, newConfirmedActivities] = await Promise.all([\r\n        loadPendingActivities(this.#network, this.#address),\r\n        this.#loadNewConfirmedActivities(),\r\n      ]);\r\n\r\n      if (this.#isDestroyed) return;\r\n\r\n      this.#handleNewActivities(\r\n        mergeSortedActivities(\r\n          newConfirmedActivities,\r\n          this.#socketConfirmedActionsStash.splice(0),\r\n        ),\r\n        pendingActivities,\r\n      );\r\n\r\n      this.#doesNeedToRestoreHistory = false;\r\n    } finally {\r\n      if (!this.#isDestroyed) {\r\n        this.#loadingListeners.runCallbacks(false);\r\n      }\r\n    }\r\n  };\r\n\r\n  async #loadNewConfirmedActivities() {\r\n    while (!this.#isDestroyed) {\r\n      try {\r\n        return await fetchActions({\r\n          network: this.#network,\r\n          filter: { address: this.#address },\r\n          walletAddress: this.#address,\r\n          fromTimestamp: this.#newestConfirmedActivityTimestamp,\r\n          limit: FIRST_TRANSACTIONS_LIMIT,\r\n        });\r\n      } catch (err) {\r\n        logDebugError('loadNewConfirmedActivities', err);\r\n\r\n        if (this.#isDestroyed || !this.#doesNeedToRestoreHistory) {\r\n          break;\r\n        }\r\n\r\n        await focusAwareDelay(...periodToMs(this.#minPollDelay));\r\n      }\r\n    }\r\n\r\n    return [];\r\n  }\r\n\r\n  /** The method expected one of `allPendingActivities` and `pendingUpdates`, not both at the same time */\r\n  #handleNewActivities(\r\n    confirmedActivities: ApiActivity[],\r\n    allPendingActivities?: ApiActivity[],\r\n    pendingUpdates?: ActivitiesUpdate[],\r\n  ) {\r\n    // If nothing new, do nothing\r\n    if (!confirmedActivities.length && !(allPendingActivities || pendingUpdates?.length)) {\r\n      return;\r\n    }\r\n\r\n    if (confirmedActivities.length) {\r\n      this.#newestConfirmedActivityTimestamp = confirmedActivities[0].timestamp;\r\n    }\r\n    this.#pendingActivities.update(confirmedActivities, allPendingActivities, pendingUpdates);\r\n    this.#updateListeners.runCallbacks(confirmedActivities, this.#pendingActivities.all);\r\n  }\r\n}\r\n\r\nasync function loadPendingActivities(network: ApiNetwork, address: string) {\r\n  try {\r\n    return await fetchPendingActions(network, address);\r\n  } catch (err) {\r\n    logDebugError('loadPendingActivities', err);\r\n    return undefined;\r\n  }\r\n}\r\n\r\n/**\r\n * Keeps the list of all current pending activities by merging the incoming updates.\r\n */\r\nfunction managePendingActivities() {\r\n  /** Sorted by timestamp descending */\r\n  let pendingActivities: readonly ApiActivity[] = [];\r\n\r\n  /**\r\n   * External message hash normalized of the recently confirmed activities and invalidated pending activities.\r\n   * Helps to avoid excessive pendings occurring because of race conditions that cause pendings to arrive after the\r\n   * corresponding confirmed activities. The race conditions can occur because of the socket and polling working together.\r\n   *\r\n   * There still can be situations where an older pending activity version replaces a newer one, but it is not a problem.\r\n   */\r\n  const finishedHashes = new Set<string>();\r\n\r\n  function update(\r\n    confirmedActivities: ApiActivity[],\r\n    allPendingActivities?: readonly ApiActivity[],\r\n    pendingUpdates?: ActivitiesUpdate[],\r\n  ) {\r\n    rememberFinishedHashes(extractKey(confirmedActivities, 'externalMsgHashNorm'));\r\n    if (pendingUpdates) {\r\n      rememberFinishedHashes(extractKey(pendingUpdates.filter(isActivityUpdateFinal), 'messageHashNormalized'));\r\n    }\r\n\r\n    if (allPendingActivities) {\r\n      pendingActivities = sortActivities(allPendingActivities);\r\n    } else if (pendingUpdates) {\r\n      pendingActivities = mergePendingActivities(pendingActivities, pendingUpdates);\r\n    }\r\n\r\n    pendingActivities = pendingActivities.filter(({ externalMsgHashNorm }) => !(\r\n      externalMsgHashNorm\r\n      && finishedHashes.has(externalMsgHashNorm)\r\n    ));\r\n  }\r\n\r\n  function rememberFinishedHashes(messageHashNorms: Iterable<string | undefined>) {\r\n    for (const hash of messageHashNorms) {\r\n      if (hash !== undefined) {\r\n        finishedHashes.add(hash);\r\n      }\r\n    }\r\n\r\n    releaseFinishedHashesMemory();\r\n  }\r\n\r\n  function releaseFinishedHashesMemory() {\r\n    // JS Set iterates the elements in the order of insertion.\r\n    // Deleting elements from Set during iteration doesn't disrupt the iteration.\r\n    // That is, this loop removes the oldest elements.\r\n    for (const hash of finishedHashes) {\r\n      if (finishedHashes.size <= FINISHED_HASH_MEMORY_SIZE) {\r\n        break;\r\n      }\r\n\r\n      finishedHashes.delete(hash);\r\n    }\r\n  }\r\n\r\n  return {\r\n    get all() {\r\n      return pendingActivities;\r\n    },\r\n    update,\r\n  };\r\n}\r\n\r\nfunction mergePendingActivities(\r\n  currentPendingActivities: readonly ApiActivity[], // Must be sorted by timestamp descending\r\n  socketUpdates: ActivitiesUpdate[],\r\n) {\r\n  if (!socketUpdates.length) {\r\n    return currentPendingActivities;\r\n  }\r\n\r\n  const hashesToRemove = new Set<string | undefined>(\r\n    extractKey(socketUpdates, 'messageHashNormalized'),\r\n  );\r\n\r\n  return mergeSortedActivities(\r\n    currentPendingActivities.filter(\r\n      (activity) => !hashesToRemove.has(activity.externalMsgHashNorm),\r\n    ),\r\n    sortActivities(\r\n      socketUpdates.flatMap((update) => update.arePending ? update.activities : []),\r\n    ),\r\n  );\r\n}\r\n","import type { ApiNetwork, ApiTransaction } from '../../../types';\r\nimport type { ApiTransactionExtended } from '../types';\r\nimport type { AddressBook, Transaction, TransactionMessage } from './types';\r\n\r\nimport { TONCOIN } from '../../../../config';\r\nimport { toSeconds } from '../../../../util/datetime';\r\nimport { omitUndefined } from '../../../../util/iteratees';\r\nimport { toBase64Address } from '../util/tonCore';\r\nimport { callToncenterV3 } from './other';\r\n\r\nexport async function fetchTransactions(options: {\r\n  network: ApiNetwork;\r\n  address: string | string[];\r\n  limit: number;\r\n  fromTimestamp?: number;\r\n  toTimestamp?: number;\r\n  shouldIncludeFrom?: boolean;\r\n  shouldIncludeTo?: boolean;\r\n}): Promise<ApiTransaction[]> {\r\n  const {\r\n    network,\r\n    address,\r\n    limit,\r\n    toTimestamp,\r\n    fromTimestamp,\r\n    shouldIncludeFrom,\r\n    shouldIncludeTo,\r\n  } = options;\r\n\r\n  const data: {\r\n    transactions: Transaction[];\r\n    address_book: AddressBook;\r\n  } = await callToncenterV3(network, '/transactions', {\r\n    account: address,\r\n    limit,\r\n    start_utime: fromTimestamp && toSeconds(fromTimestamp) + (!shouldIncludeFrom ? 1 : 0),\r\n    end_utime: toTimestamp && toSeconds(toTimestamp) - (!shouldIncludeTo ? 1 : 0),\r\n    sort: 'desc',\r\n  });\r\n\r\n  const {\r\n    transactions: rawTransactions,\r\n    address_book: addressBook,\r\n  } = data;\r\n\r\n  if (!rawTransactions.length) {\r\n    return [];\r\n  }\r\n\r\n  return rawTransactions\r\n    .map((rawTx) => parseRawTransaction(network, rawTx, addressBook))\r\n    .flat();\r\n}\r\n\r\nexport function parseRawTransaction(\r\n  network: ApiNetwork,\r\n  rawTx: Transaction,\r\n  addressBook: AddressBook,\r\n): ApiTransactionExtended[] {\r\n  const {\r\n    now,\r\n    hash,\r\n    total_fees: totalFees,\r\n    description: {\r\n      compute_ph: {\r\n        exit_code: exitCode,\r\n      },\r\n    },\r\n  } = rawTx;\r\n\r\n  const timestamp = now * 1000;\r\n  const isIncoming = !!rawTx.in_msg.source && !rawTx.out_msgs.length;\r\n  const inMsgHashNorm = rawTx.in_msg.hash_norm ?? rawTx.in_msg.hash;\r\n  const msgs: TransactionMessage[] = isIncoming ? [rawTx.in_msg] : rawTx.out_msgs;\r\n\r\n  if (!msgs.length) return [];\r\n\r\n  const oneMsgFee = BigInt(totalFees) / BigInt(msgs.length);\r\n\r\n  const transactions: ApiTransactionExtended[] = [];\r\n\r\n  msgs.forEach((msg, i) => {\r\n    const {\r\n      source,\r\n      destination,\r\n      value,\r\n      fwd_fee: fwdFee,\r\n      opcode,\r\n      hash: msgHash,\r\n      bounced,\r\n    } = msg;\r\n\r\n    if (!destination) {\r\n      // This is log\r\n      return;\r\n    }\r\n\r\n    const fromAddress = addressBook[source!].user_friendly;\r\n    const toAddress = addressBook[destination].user_friendly;\r\n    const normalizedAddress = toBase64Address(isIncoming ? source! : destination, true, network);\r\n    const fee = oneMsgFee + BigInt(fwdFee ?? 0);\r\n\r\n    const tx: ApiTransactionExtended = omitUndefined({\r\n      timestamp,\r\n      isIncoming,\r\n      fromAddress,\r\n      toAddress,\r\n      amount: isIncoming ? BigInt(value!) : -BigInt(value!),\r\n      slug: TONCOIN.slug,\r\n      fee,\r\n      externalMsgHashNorm: isIncoming ? undefined : inMsgHashNorm,\r\n      normalizedAddress,\r\n      shouldHide: exitCode ? true : undefined,\r\n      hash,\r\n      opCode: Number(opcode) || undefined,\r\n      msgHash,\r\n      type: bounced ? 'bounced' : undefined,\r\n      status: 'completed',\r\n    });\r\n\r\n    transactions.push(tx);\r\n  });\r\n\r\n  return transactions;\r\n}\r\n\r\nexport async function fetchLatestTxLt(network: ApiNetwork, address: string): Promise<number | undefined> {\r\n  const { transactions }: { transactions: any[] } = await callToncenterV3(network, '/transactions', {\r\n    account: address,\r\n    limit: 1,\r\n    sort: 'desc',\r\n  });\r\n\r\n  if (!transactions.length) {\r\n    return undefined;\r\n  }\r\n\r\n  return Number(transactions[0].lt);\r\n}\r\n","import { Address } from '@ton/core';\r\n\r\nimport type { ApiNetwork } from '../../types';\r\n\r\nimport { getDnsDomainZone, isDnsDomain } from '../../../util/dns';\r\nimport { dnsResolve } from './util/dns';\r\nimport { getTonClient, toBase64Address } from './util/tonCore';\r\nimport { getKnownAddressInfo } from '../../common/addresses';\r\nimport { DnsCategory } from './constants';\r\nimport { fetchAddressBook } from './toncenter';\r\n\r\nexport async function resolveAddress(network: ApiNetwork, address: string, skipFormatSelection?: boolean): Promise<{\r\n  address: string;\r\n  name?: string;\r\n  isMemoRequired?: boolean;\r\n  isScam?: boolean;\r\n} | 'dnsNotResolved' | 'invalidAddress'> {\r\n  const isDomain = isDnsDomain(address);\r\n  let domain: string | undefined;\r\n\r\n  if (isDomain) {\r\n    const resolvedAddress = await resolveAddressByDomain(network, address);\r\n    if (!resolvedAddress) {\r\n      return 'dnsNotResolved';\r\n    }\r\n\r\n    domain = address;\r\n    address = resolvedAddress;\r\n\r\n    if (!skipFormatSelection) {\r\n      const addressBook = await fetchAddressBook(network, [address]);\r\n      address = addressBook[address].user_friendly;\r\n    }\r\n  }\r\n\r\n  let normalizedAddress: string;\r\n  try {\r\n    normalizedAddress = normalizeAddress(address);\r\n  } catch {\r\n    return 'invalidAddress';\r\n  }\r\n  const known = getKnownAddressInfo(normalizedAddress);\r\n\r\n  if (known) {\r\n    return {\r\n      address,\r\n      ...known,\r\n      name: domain ?? known.name,\r\n    };\r\n  }\r\n\r\n  return { address, name: domain };\r\n}\r\n\r\nasync function resolveAddressByDomain(network: ApiNetwork, domain: string) {\r\n  try {\r\n    const zoneMatch = getDnsDomainZone(domain);\r\n    if (!zoneMatch) {\r\n      return undefined;\r\n    }\r\n\r\n    const result = await dnsResolve(\r\n      getTonClient(network),\r\n      zoneMatch.zone.resolver,\r\n      zoneMatch.base,\r\n      DnsCategory.Wallet,\r\n    );\r\n\r\n    if (!(result instanceof Address)) {\r\n      return undefined;\r\n    }\r\n\r\n    return toBase64Address(result, undefined, network);\r\n  } catch (err: any) {\r\n    if (!err.message?.includes('exit_code')) {\r\n      throw err;\r\n    }\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport function normalizeAddress(address: string, network?: ApiNetwork) {\r\n  return toBase64Address(address, true, network);\r\n}\r\n","import { beginCell, Cell, storeStateInit } from '@ton/core';\r\nimport type { WalletContractV5R1 } from '@ton/ton';\r\n\r\nimport type {\r\n  ApiAnyDisplayError,\r\n  ApiNetwork,\r\n  ApiTonWallet,\r\n  ApiWalletInfo,\r\n  ApiWalletWithVersionInfo,\r\n} from '../../types';\r\nimport type { ApiTonWalletVersion, ContractInfo } from './types';\r\nimport type { TonWallet } from './util/tonCore';\r\n\r\nimport { DEFAULT_WALLET_VERSION } from '../../../config';\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { extractKey, findLast } from '../../../util/iteratees';\r\nimport withCacheAsync from '../../../util/withCacheAsync';\r\nimport { fetchJettonBalances } from './util/tonapiio';\r\nimport {\r\n  getTonClient, toBase64Address, walletClassMap,\r\n} from './util/tonCore';\r\nimport { fetchStoredWallet } from '../../common/accounts';\r\nimport { base64ToBytes, hexToBytes, sha256 } from '../../common/utils';\r\nimport { ALL_WALLET_VERSIONS, ContractType, KnownContracts, NETWORK_CONFIG, WORKCHAIN } from './constants';\r\nimport { getWalletInfos } from './toncenter';\r\n\r\nexport const isAddressInitialized = withCacheAsync(\r\n  async (network: ApiNetwork, walletOrAddress: TonWallet | string) => {\r\n    return (await getWalletInfo(network, walletOrAddress)).isInitialized;\r\n  },\r\n);\r\n\r\nexport const isActiveSmartContract = withCacheAsync(async (network: ApiNetwork, address: string) => {\r\n  const { isInitialized, version } = await getWalletInfo(network, address);\r\n  return isInitialized ? !version : undefined;\r\n}, (value) => value !== undefined);\r\n\r\nexport function publicKeyToAddress(\r\n  network: ApiNetwork,\r\n  publicKey: Uint8Array,\r\n  walletVersion: ApiTonWalletVersion,\r\n  isTestnetSubwalletId?: boolean,\r\n) {\r\n  const wallet = buildWallet(publicKey, walletVersion, isTestnetSubwalletId);\r\n  return toBase64Address(wallet.address, false, network);\r\n}\r\n\r\nexport function buildWallet(\r\n  publicKey: Uint8Array | string,\r\n  walletVersion: ApiTonWalletVersion,\r\n  isTestnetSubwalletId?: boolean,\r\n): TonWallet {\r\n  if (typeof publicKey === 'string') {\r\n    publicKey = hexToBytes(publicKey);\r\n  }\r\n\r\n  const WalletClass = walletClassMap[walletVersion];\r\n  if (!WalletClass) {\r\n    throw new Error(`Unsupported wallet contract version \"${walletVersion}\"`);\r\n  }\r\n\r\n  if (walletVersion === 'W5') {\r\n    return (WalletClass as typeof WalletContractV5R1).create({\r\n      publicKey: Buffer.from(publicKey),\r\n      workchain: WORKCHAIN,\r\n      walletId: {\r\n        networkGlobalId: NETWORK_CONFIG[isTestnetSubwalletId ? 'testnet' : 'mainnet'].chainId,\r\n      },\r\n    });\r\n  }\r\n\r\n  return WalletClass.create({\r\n    publicKey: Buffer.from(publicKey),\r\n    workchain: WORKCHAIN,\r\n  });\r\n}\r\n\r\nexport async function getWalletInfo(network: ApiNetwork, walletOrAddress: TonWallet | string): Promise<ApiWalletInfo> {\r\n  const address = typeof walletOrAddress === 'string'\r\n    ? walletOrAddress\r\n    : toBase64Address(walletOrAddress.address, undefined, network);\r\n\r\n  return (await getWalletInfos(network, [address]))[address];\r\n}\r\n\r\nexport async function getContractInfo(network: ApiNetwork, address: string): Promise<{\r\n  isInitialized: boolean;\r\n  isSwapAllowed?: boolean;\r\n  isWallet?: boolean;\r\n  contractInfo?: ContractInfo;\r\n  codeHash?: string;\r\n  codeHashOld?: string;\r\n}> {\r\n  const data = await getTonClient(network).getAddressInfo(address);\r\n\r\n  const { code, state } = data;\r\n\r\n  const codeHashOld = Buffer.from(await sha256(base64ToBytes(code))).toString('hex');\r\n  // For inactive addresses, `code` is an empty string. Cell.fromBase64 throws when `code` is an empty string.\r\n  const codeHash = code && Cell.fromBase64(code).hash().toString('hex');\r\n\r\n  const contractInfo = Object.values(KnownContracts).find(\r\n    (info) => info.hash === codeHash || info.oldHash === codeHashOld,\r\n  );\r\n\r\n  const isInitialized = state === 'active';\r\n  const isWallet = state === 'active' ? contractInfo?.type === ContractType.Wallet : undefined;\r\n  const isSwapAllowed = contractInfo?.isSwapAllowed;\r\n\r\n  return {\r\n    isInitialized,\r\n    isWallet,\r\n    isSwapAllowed,\r\n    contractInfo,\r\n    codeHash,\r\n    codeHashOld,\r\n  };\r\n}\r\n\r\nexport async function getWalletBalance(network: ApiNetwork, walletOrAddress: TonWallet | string): Promise<bigint> {\r\n  return (await getWalletInfo(network, walletOrAddress)).balance;\r\n}\r\n\r\nexport async function getWalletSeqno(network: ApiNetwork, walletOrAddress: TonWallet | string): Promise<number> {\r\n  const { seqno } = await getWalletInfo(network, walletOrAddress);\r\n  return seqno || 0;\r\n}\r\n\r\nexport async function pickBestWallet(network: ApiNetwork, publicKey: Uint8Array): Promise<{\r\n  wallet: TonWallet;\r\n  version: ApiTonWalletVersion;\r\n  balance: bigint;\r\n  lastTxId?: string;\r\n}> {\r\n  const allWallets = await getWalletVersionInfos(network, publicKey);\r\n  const defaultWallets = allWallets.filter(({ version }) => version === DEFAULT_WALLET_VERSION);\r\n  const defaultWallet = defaultWallets.find(\r\n    ({ isTestnetSubwalletId }) => isTestnetSubwalletId,\r\n  ) ?? defaultWallets[0];\r\n\r\n  if (defaultWallet.lastTxId) {\r\n    return defaultWallet;\r\n  }\r\n\r\n  const withBiggestBalance = allWallets.reduce<typeof allWallets[0] | undefined>((best, current) => {\r\n    return current.balance > (best?.balance ?? 0n) ? current : best;\r\n  }, undefined);\r\n\r\n  if (withBiggestBalance) {\r\n    return withBiggestBalance;\r\n  }\r\n\r\n  const withLastTx = findLast(allWallets, ({ lastTxId }) => !!lastTxId);\r\n\r\n  if (withLastTx) {\r\n    return withLastTx;\r\n  }\r\n\r\n  // Workaround for NOT holders who do not have transactions\r\n  const v4Wallet = allWallets.find(({ version }) => version === 'v4R2')!;\r\n  const v4JettonBalances = await fetchJettonBalances(network, v4Wallet.address);\r\n  if (v4JettonBalances.length > 0) {\r\n    return v4Wallet;\r\n  }\r\n\r\n  return defaultWallet;\r\n}\r\n\r\nexport async function getWalletVersionInfos(\r\n  network: ApiNetwork,\r\n  publicKey: Uint8Array,\r\n  versions: ApiTonWalletVersion[] = ALL_WALLET_VERSIONS,\r\n): Promise<(ApiWalletWithVersionInfo & { wallet: TonWallet })[]> {\r\n  const items = getWalletVersions(network, publicKey, versions);\r\n  const walletInfos = await getWalletInfos(network, extractKey(items, 'address'));\r\n\r\n  const result = items.map((item) => {\r\n    const walletInfo = walletInfos[item.address] ?? {\r\n      balance: 0n,\r\n      isInitialized: false,\r\n    };\r\n\r\n    return {\r\n      ...walletInfo,\r\n      ...item,\r\n    };\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\ntype ApiTonWalletVersionInfo = {\r\n  wallet: TonWallet;\r\n  address: string;\r\n  version: ApiTonWalletVersion;\r\n  isTestnetSubwalletId?: boolean;\r\n};\r\n\r\nexport function getWalletVersions(\r\n  network: ApiNetwork,\r\n  publicKey: Uint8Array,\r\n  versions: ApiTonWalletVersion[] = ALL_WALLET_VERSIONS,\r\n): ApiTonWalletVersionInfo[] {\r\n  return versions.flatMap((version): ApiTonWalletVersionInfo | ApiTonWalletVersionInfo[] => {\r\n    if (version === 'W5' && network === 'testnet') {\r\n      // Support wallets with both `subwallet_id` values for testnet to keep backwards compatibility\r\n      const testnetWallet = buildWallet(publicKey, version, true);\r\n      const testnetAddress = toBase64Address(testnetWallet.address, false, 'testnet');\r\n\r\n      const mainnetWallet = buildWallet(publicKey, version, false);\r\n      const mainnetAddress = toBase64Address(mainnetWallet.address, false, 'testnet');\r\n\r\n      return [{\r\n        wallet: testnetWallet,\r\n        address: testnetAddress,\r\n        version,\r\n        isTestnetSubwalletId: true,\r\n      }, {\r\n        wallet: mainnetWallet,\r\n        address: mainnetAddress,\r\n        version,\r\n        isTestnetSubwalletId: false,\r\n      }];\r\n    }\r\n\r\n    const wallet = buildWallet(publicKey, version);\r\n    const address = toBase64Address(wallet.address, false, network);\r\n\r\n    return {\r\n      wallet,\r\n      address,\r\n      version,\r\n      isTestnetSubwalletId: undefined,\r\n    };\r\n  });\r\n}\r\n\r\nexport function getWalletStateInit(storedWallet: ApiTonWallet) {\r\n  const wallet = getTonWallet(storedWallet);\r\n\r\n  return beginCell()\r\n    .storeWritable(storeStateInit(wallet.init))\r\n    .endCell();\r\n}\r\n\r\nexport function pickWalletByAddress(network: ApiNetwork, publicKey: Uint8Array, address: string) {\r\n  address = toBase64Address(address, false, network);\r\n\r\n  const allWallets = getWalletVersions(network, publicKey);\r\n\r\n  return allWallets.find((w) => w.address === address)!;\r\n}\r\n\r\n/**\r\n * Check if the wallet is with testnet subwallet ID\r\n * @returns `undefined` if the wallet is not a W5 wallet,\r\n * `true` if the wallet is with testnet subwallet ID, `false` otherwise\r\n */\r\nfunction checkIsTestnetSubwalletId(\r\n  publicKey: Uint8Array,\r\n  version: ApiTonWalletVersion,\r\n  address: string,\r\n): boolean | undefined {\r\n  if (version !== 'W5') {\r\n    return undefined;\r\n  }\r\n\r\n  const testnetSubwalletAddress = publicKeyToAddress('testnet', publicKey, version, true);\r\n\r\n  return address === testnetSubwalletAddress;\r\n}\r\n\r\nexport function getTonWallet(tonWallet: ApiTonWallet) {\r\n  const { publicKey, version, address } = tonWallet;\r\n  if (!publicKey) {\r\n    throw new Error('Public key is missing');\r\n  }\r\n\r\n  // For W5 wallets, determine the correct subwallet ID by comparing addresses\r\n  if (version === 'W5') {\r\n    const isTestnetSubwalletId = checkIsTestnetSubwalletId(hexToBytes(publicKey), version, address);\r\n    return buildWallet(publicKey, version, isTestnetSubwalletId);\r\n  }\r\n\r\n  return buildWallet(publicKey, version);\r\n}\r\n\r\nexport async function verifyLedgerWalletAddress(accountId: string): Promise<string | { error: ApiAnyDisplayError }> {\r\n  const { network } = parseAccountId(accountId);\r\n  const [wallet, { verifyLedgerTonAddress }] = await Promise.all([\r\n    fetchStoredWallet(accountId, 'ton'),\r\n    import('./ledger'),\r\n  ]);\r\n  return verifyLedgerTonAddress(network, wallet);\r\n}\r\n","import * as tonWebMnemonic from 'tonweb-mnemonic';\r\nimport * as bip39 from 'bip39';\r\nimport nacl from 'tweetnacl';\r\n\r\nimport type { ApiAccountWithMnemonic, ApiAnyDisplayError, ApiNetwork, ApiTonWallet } from '../../types';\r\nimport type { ApiTonWalletVersion } from './types';\r\nimport type { TonWallet } from './util/tonCore';\r\nimport { ApiAuthError } from '../../types';\r\n\r\nimport { DEFAULT_WALLET_VERSION } from '../../../config';\r\nimport * as HDKey from '../../../lib/ed25519-hd-key';\r\nimport isMnemonicPrivateKey from '../../../util/isMnemonicPrivateKey';\r\nimport { extractKey, omitUndefined } from '../../../util/iteratees';\r\nimport { logDebugError } from '../../../util/logs';\r\nimport { getWalletPublicKey, toBase64Address } from './util/tonCore';\r\nimport { fetchStoredAccount } from '../../common/accounts';\r\nimport { getMnemonic } from '../../common/mnemonic';\r\nimport { bytesToHex, hexToBytes } from '../../common/utils';\r\nimport { resolveAddress } from './address';\r\nimport { TON_BIP39_PATH } from './constants';\r\nimport { getWalletInfos } from './toncenter';\r\nimport { buildWallet, getWalletInfo, pickBestWallet, publicKeyToAddress } from './wallet';\r\n\r\nexport function generateMnemonic() {\r\n  return tonWebMnemonic.generateMnemonic();\r\n}\r\n\r\nexport function validateMnemonic(mnemonic: string[]) {\r\n  return tonWebMnemonic.validateMnemonic(mnemonic);\r\n}\r\n\r\nexport function privateKeyHexToKeyPair(privateKeyHex: string) {\r\n  return nacl.sign.keyPair.fromSeed(hexToBytes(privateKeyHex));\r\n}\r\n\r\nexport async function fetchPrivateKey(accountId: string, password: string, account?: ApiAccountWithMnemonic) {\r\n  try {\r\n    const { secretKey: privateKey } = await fetchKeyPair(accountId, password, account) || {};\r\n\r\n    return privateKey;\r\n  } catch (err) {\r\n    // eslint-disable-next-line no-console\r\n    console.error(err);\r\n\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport async function fetchKeyPair(accountId: string, password: string, account?: ApiAccountWithMnemonic) {\r\n  try {\r\n    account = account ?? await fetchStoredAccount<ApiAccountWithMnemonic>(accountId);\r\n    const mnemonic = await getMnemonic(accountId, password, account);\r\n    if (!mnemonic) {\r\n      return undefined;\r\n    }\r\n\r\n    if (isMnemonicPrivateKey(mnemonic)) {\r\n      return privateKeyHexToKeyPair(mnemonic[0]);\r\n    } else if (account.type === 'bip39') {\r\n      return bip39MnemonicToKeyPair(mnemonic);\r\n    } else {\r\n      return await tonWebMnemonic.mnemonicToKeyPair(mnemonic);\r\n    }\r\n  } catch (err) {\r\n    logDebugError('fetchKeyPair', err);\r\n\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport async function rawSign(accountId: string, password: string, dataHex: string) {\r\n  const privateKey = await fetchPrivateKey(accountId, password);\r\n  if (!privateKey) {\r\n    return undefined;\r\n  }\r\n\r\n  const signature = nacl.sign.detached(hexToBytes(dataHex), privateKey);\r\n\r\n  return bytesToHex(signature);\r\n}\r\n\r\nexport function getWalletFromBip39Mnemonic(\r\n  network: ApiNetwork,\r\n  mnemonic: string[],\r\n  version?: ApiTonWalletVersion,\r\n): Promise<ApiTonWallet> {\r\n  const { publicKey } = bip39MnemonicToKeyPair(mnemonic);\r\n  return getWalletFromKeys(publicKey, network, version);\r\n}\r\n\r\nexport async function getWalletFromMnemonic(\r\n  mnemonic: string[],\r\n  network: ApiNetwork,\r\n  version?: ApiTonWalletVersion,\r\n): Promise<ApiTonWallet & { lastTxId?: string }> {\r\n  const { publicKey } = await tonWebMnemonic.mnemonicToKeyPair(mnemonic);\r\n  return getWalletFromKeys(publicKey, network, version);\r\n}\r\n\r\nexport function getWalletFromPrivateKey(\r\n  privateKey: string,\r\n  network: ApiNetwork,\r\n  version?: ApiTonWalletVersion,\r\n): Promise<ApiTonWallet> {\r\n  const { publicKey } = privateKeyHexToKeyPair(privateKey);\r\n  return getWalletFromKeys(publicKey, network, version);\r\n}\r\n\r\nexport async function getWalletFromKeys(\r\n  publicKey: Uint8Array,\r\n  network: ApiNetwork,\r\n  version?: ApiTonWalletVersion,\r\n): Promise<ApiTonWallet & { lastTxId?: string }> {\r\n  let wallet: TonWallet;\r\n  let lastTxId: string | undefined;\r\n  if (version) {\r\n    wallet = buildWallet(publicKey, version, network === 'testnet');\r\n  } else {\r\n    ({ wallet, version, lastTxId } = await pickBestWallet(network, publicKey));\r\n  }\r\n\r\n  const address = toBase64Address(wallet.address, false, network);\r\n  const publicKeyHex = bytesToHex(publicKey);\r\n\r\n  return {\r\n    publicKey: publicKeyHex,\r\n    address,\r\n    version,\r\n    index: 0,\r\n    lastTxId,\r\n  };\r\n}\r\n\r\nfunction bip39MnemonicToKeyPair(mnemonic: string[]) {\r\n  const hexSeed = bip39.mnemonicToSeedSync(mnemonic.join(' '));\r\n  const { key: privateKey } = HDKey.derivePath(TON_BIP39_PATH, hexSeed.toString('hex'));\r\n  return nacl.sign.keyPair.fromSeed(privateKey);\r\n}\r\n\r\nexport function getOtherVersionWallet(\r\n  network: ApiNetwork,\r\n  wallet: ApiTonWallet,\r\n  otherVersion: ApiTonWalletVersion,\r\n  isTestnetSubwalletId?: boolean,\r\n): ApiTonWallet {\r\n  if (!wallet.publicKey) {\r\n    throw new Error('The wallet has no public key');\r\n  }\r\n\r\n  const publicKey = hexToBytes(wallet.publicKey);\r\n  const newAddress = publicKeyToAddress(network, publicKey, otherVersion, isTestnetSubwalletId);\r\n\r\n  return {\r\n    address: newAddress,\r\n    publicKey: wallet.publicKey,\r\n    version: otherVersion,\r\n    index: wallet.index,\r\n  };\r\n}\r\n\r\nexport async function getWalletFromAddress(\r\n  network: ApiNetwork,\r\n  addressOrDomain: string,\r\n): Promise<{ title?: string; wallet: ApiTonWallet } | { error: ApiAuthError }> {\r\n  const resolvedAddress = await resolveAddress(network, addressOrDomain, true);\r\n  if (resolvedAddress === 'dnsNotResolved') return { error: ApiAuthError.DomainNotResolved };\r\n  if (resolvedAddress === 'invalidAddress') return { error: ApiAuthError.InvalidAddress };\r\n  const rawAddress = resolvedAddress.address;\r\n\r\n  const [walletInfo, publicKey] = await Promise.all([\r\n    getWalletInfo(network, rawAddress),\r\n    getWalletPublicKey(network, rawAddress),\r\n  ]);\r\n\r\n  return {\r\n    title: resolvedAddress.name,\r\n    wallet: omitUndefined<ApiTonWallet>({\r\n      publicKey: publicKey ? bytesToHex(publicKey) : undefined,\r\n      address: walletInfo.address,\r\n      // The wallet has no version until it's initialized as a wallet. Using the default version just for the type\r\n      // compliance, it plays no role for view wallets anyway.\r\n      version: walletInfo?.version ?? DEFAULT_WALLET_VERSION,\r\n      index: 0,\r\n      isInitialized: walletInfo?.isInitialized ?? false,\r\n    }),\r\n  };\r\n}\r\n\r\nexport async function getWalletsFromLedgerAndLoadBalance(\r\n  network: ApiNetwork,\r\n  accountIndices: number[],\r\n): Promise<{ wallet: ApiTonWallet; balance: bigint }[] | { error: ApiAnyDisplayError }> {\r\n  const { getLedgerTonWallet } = await import('./ledger');\r\n  const wallets: ApiTonWallet[] = [];\r\n\r\n  // Load the wallets from Ledger\r\n  for (const accountIndex of accountIndices) {\r\n    const wallet = await getLedgerTonWallet(network, accountIndex);\r\n    if ('error' in wallet) return { error: wallet.error };\r\n    wallets.push(wallet);\r\n  }\r\n\r\n  // Fetch the wallets' balances\r\n  const walletInfos = await getWalletInfos(network, extractKey(wallets, 'address'));\r\n\r\n  return wallets.map((wallet) => ({\r\n    wallet,\r\n    balance: walletInfos[wallet.address].balance,\r\n  }));\r\n}\r\n","// This JS library implements TON message comment encryption and decryption for Web\r\n// Reference C++ code - SimpleEncryptionV2 - https://github.com/ton-blockchain/ton/blob/cc0eb453cb3bf69f92693160103d33112856c056/tonlib/tonlib/keys/SimpleEncryption.cpp#L110\r\n// Dependencies:\r\n// - TonWeb 0.0.60\r\n// - aes-js - 3.1.2 - https://github.com/ricmoo/aes-js/releases/tag/v3.1.2 - for aes-cbc without padding\r\n// - noble-ed25519 - 1.7.3 - // https://github.com/paulmillr/noble-ed25519/releases/tag/1.7.3 - for getSharedKey\r\n\r\nimport type { Address } from '@ton/core';\r\n\r\nimport aesjs from '../../../../lib/aes-js';\r\nimport { getSharedSecret } from '../../../../lib/noble-ed25519';\r\nimport { OpCode } from '../constants';\r\nimport { toBase64Address } from './tonCore';\r\n\r\nasync function hmacSha512(key: Uint8Array, data: Uint8Array): Promise<Uint8Array> {\r\n  const hmacAlgo = { name: 'HMAC', hash: 'SHA-512' };\r\n  const hmacKey = await crypto.subtle.importKey('raw', key, hmacAlgo, false, ['sign']);\r\n  const signature = await crypto.subtle.sign(hmacAlgo, hmacKey, data);\r\n  const result = new Uint8Array(signature);\r\n  if (result.length !== 512 / 8) throw new Error();\r\n  return result;\r\n}\r\n\r\nfunction getAesCbcState(hash: Uint8Array) {\r\n  if (hash.length < 48) throw new Error();\r\n  const key = hash.slice(0, 32);\r\n  const iv = hash.slice(32, 32 + 16);\r\n\r\n  // Note that native crypto.subtle AES-CBC not suitable here because\r\n  // even if the data IS a multiple of 16 bytes, padding will still be added\r\n  // So we use aes-js\r\n\r\n  return new aesjs.ModeOfOperation.cbc(key, iv);\r\n}\r\n\r\nfunction getRandomPrefix(dataLength: number, minPadding: number): Uint8Array {\r\n  const prefixLength = ((minPadding + 15 + dataLength) & -16) - dataLength;\r\n  const prefix = crypto.getRandomValues(new Uint8Array(prefixLength));\r\n  prefix[0] = prefixLength;\r\n  if ((prefixLength + dataLength) % 16 !== 0) throw new Error();\r\n  return prefix;\r\n}\r\n\r\nfunction combineSecrets(a: Uint8Array, b: Uint8Array) {\r\n  return hmacSha512(a, b);\r\n}\r\n\r\nasync function encryptDataWithPrefix(data: Uint8Array, sharedSecret: Uint8Array, salt: Uint8Array) {\r\n  if (data.length % 16 !== 0) throw new Error();\r\n  const dataHash = await combineSecrets(salt, data);\r\n  const msgKey = dataHash.slice(0, 16);\r\n\r\n  const res = new Uint8Array(data.length + 16);\r\n  res.set(msgKey, 0);\r\n\r\n  const cbcStateSecret = await combineSecrets(sharedSecret, msgKey);\r\n  const encrypted = getAesCbcState(cbcStateSecret).encrypt(data);\r\n  res.set(encrypted, 16);\r\n\r\n  return res;\r\n}\r\n\r\nasync function encryptDataImpl(data: Uint8Array, sharedSecret: Uint8Array, salt: Uint8Array) {\r\n  const prefix = getRandomPrefix(data.length, 16);\r\n  const combined = new Uint8Array(prefix.length + data.length);\r\n  combined.set(prefix, 0);\r\n  combined.set(data, prefix.length);\r\n  return encryptDataWithPrefix(combined, sharedSecret, salt);\r\n}\r\n\r\nexport async function encryptData(\r\n  data: Uint8Array, myPublicKey: Uint8Array, theirPublicKey: Uint8Array, privateKey: Uint8Array, salt: Uint8Array,\r\n) {\r\n  const sharedSecret = await getSharedSecret(privateKey, theirPublicKey);\r\n\r\n  const encrypted = await encryptDataImpl(data, sharedSecret, salt);\r\n  const prefixedEncrypted = new Uint8Array(myPublicKey.length + encrypted.length);\r\n  for (let i = 0; i < myPublicKey.length; i++) {\r\n    prefixedEncrypted[i] = theirPublicKey[i] ^ myPublicKey[i];\r\n  }\r\n  prefixedEncrypted.set(encrypted, myPublicKey.length);\r\n  return prefixedEncrypted;\r\n}\r\n\r\nexport async function encryptMessageComment(\r\n  comment: string,\r\n  myPublicKey: Uint8Array,\r\n  theirPublicKey: Uint8Array,\r\n  myPrivateKey: Uint8Array,\r\n  senderAddress: Address | string,\r\n) {\r\n  if (!comment || !comment.length) throw new Error('empty comment');\r\n\r\n  if (myPrivateKey.length === 64) {\r\n    myPrivateKey = myPrivateKey.slice(0, 32); // convert nacl private key\r\n  }\r\n\r\n  const commentBytes = new TextEncoder().encode(comment);\r\n\r\n  const salt = new TextEncoder().encode(toBase64Address(senderAddress, true));\r\n\r\n  const encryptedBytes = await encryptData(commentBytes, myPublicKey, theirPublicKey, myPrivateKey, salt);\r\n\r\n  const payload = new Uint8Array(encryptedBytes.length + 4);\r\n\r\n  const buffer = Buffer.alloc(4);\r\n  buffer.writeUInt32BE(OpCode.Encrypted);\r\n\r\n  payload.set(buffer, 0);\r\n  payload.set(encryptedBytes, 4);\r\n\r\n  return payload;\r\n}\r\n\r\nasync function doDecrypt(\r\n  cbcStateSecret: Uint8Array, msgKey: Uint8Array, encryptedData: Uint8Array, salt: Uint8Array,\r\n): Promise<Uint8Array> {\r\n  const decryptedData = getAesCbcState(cbcStateSecret).decrypt(encryptedData);\r\n  const dataHash = await combineSecrets(salt, decryptedData);\r\n  const gotMsgKey = dataHash.slice(0, 16);\r\n  if (msgKey.join(',') !== gotMsgKey.join(',')) {\r\n    throw new Error('Failed to decrypt: hash mismatch');\r\n  }\r\n  const prefixLength = decryptedData[0];\r\n  if (prefixLength > decryptedData.length || prefixLength < 16) {\r\n    throw new Error('Failed to decrypt: invalid prefix size');\r\n  }\r\n  return decryptedData.slice(prefixLength);\r\n}\r\n\r\nasync function decryptDataImpl(\r\n  encryptedData: Uint8Array, sharedSecret: Uint8Array, salt: Uint8Array,\r\n): Promise<Uint8Array> {\r\n  if (encryptedData.length < 16) throw new Error('Failed to decrypt: data is too small');\r\n  if (encryptedData.length % 16 !== 0) throw new Error('Failed to decrypt: data size is not divisible by 16');\r\n  const msgKey = encryptedData.slice(0, 16);\r\n  const data = encryptedData.slice(16);\r\n  const cbcStateSecret = await combineSecrets(sharedSecret, msgKey);\r\n  const res = await doDecrypt(cbcStateSecret, msgKey, data, salt);\r\n  return res;\r\n}\r\n\r\nexport async function decryptData(data: Uint8Array, publicKey: Uint8Array, privateKey: Uint8Array, salt: Uint8Array) {\r\n  if (data.length < publicKey.length) {\r\n    throw new Error('Failed to decrypt: data is too small');\r\n  }\r\n  const theirPublicKey = new Uint8Array(publicKey.length);\r\n  for (let i = 0; i < publicKey.length; i++) {\r\n    theirPublicKey[i] = data[i] ^ publicKey[i];\r\n  }\r\n  const sharedSecret = await getSharedSecret(privateKey, theirPublicKey);\r\n\r\n  const decrypted = await decryptDataImpl(data.slice(publicKey.length), sharedSecret, salt);\r\n  return decrypted;\r\n}\r\n\r\nexport async function decryptMessageComment(\r\n  encryptedData: Uint8Array, myPublicKey: Uint8Array, myPrivateKey: Uint8Array, senderAddress: Address | string,\r\n) {\r\n  if (myPrivateKey.length === 64) {\r\n    myPrivateKey = myPrivateKey.slice(0, 32); // convert nacl private key\r\n  }\r\n\r\n  const salt = new TextEncoder().encode(toBase64Address(senderAddress, true));\r\n\r\n  const decryptedBytes = await decryptData(encryptedData, myPublicKey, myPrivateKey, salt);\r\n  return new TextDecoder().decode(decryptedBytes);\r\n}\r\n","import type { Cell } from '@ton/core';\r\nimport type { SignDataPayload } from '@tonconnect/protocol';\r\nimport { WalletContractV5R1 } from '@ton/ton/dist/wallets/WalletContractV5R1';\r\n\r\nimport type { ApiTonConnectProof } from '../../../tonConnect/types';\r\nimport type {\r\n  ApiAccountWithChain,\r\n  ApiAccountWithMnemonic,\r\n  ApiAnyDisplayError,\r\n  ApiNetwork,\r\n  ApiTonWallet,\r\n} from '../../../types';\r\nimport type { PreparedTransactionToSign } from '../types';\r\nimport { ApiCommonError } from '../../../types';\r\n\r\nimport { parseAccountId } from '../../../../util/account';\r\nimport withCache from '../../../../util/withCache';\r\nimport { hexToBytes } from '../../../common/utils';\r\nimport { signDataWithPrivateKey, signTonProofWithPrivateKey } from '../../../tonConnect/signing';\r\nimport { fetchPrivateKey } from '../auth';\r\nimport { getTonWallet } from '../wallet';\r\nimport { decryptMessageComment, encryptMessageComment } from './encryption';\r\n\r\ntype ErrorResult = { error: ApiAnyDisplayError };\r\n\r\n/**\r\n * Signs, encrypts and decrypts TON stuff.\r\n *\r\n * For all the methods: error is _returned_ only for expected errors, i.e. caused not by mistakes in the app code.\r\n */\r\nexport interface Signer {\r\n  /** Whether the signer produces invalid signatures and encryption, for example for emulation */\r\n  readonly isMock: boolean;\r\n  signTonProof(proof: ApiTonConnectProof): MaybePromise<Buffer | ErrorResult>;\r\n  /** The output Cell order matches the input transactions order exactly. */\r\n  signTransactions(transactions: PreparedTransactionToSign[]): MaybePromise<Cell[] | ErrorResult>;\r\n  /**\r\n   * See https://docs.tonconsole.com/academy/sign-data#how-the-signature-is-built for more details.\r\n   *\r\n   * @params timestamp The current time in Unix seconds\r\n   */\r\n  signData(\r\n    timestamp: number,\r\n    domain: string,\r\n    payload: SignDataPayload,\r\n  ): MaybePromise<Buffer | ErrorResult>;\r\n  /** @ignore This is not signing, but it's a part of this interface to eliminate excess private key fetching. */\r\n  encryptComment(comment: string, recipientPublicKey: Uint8Array): MaybePromise<Buffer | ErrorResult>;\r\n  decryptComment(encrypted: Uint8Array, senderAddress: string): MaybePromise<string | ErrorResult>;\r\n}\r\n\r\nexport function getSigner(\r\n  accountId: string,\r\n  account: ApiAccountWithChain<'ton'>,\r\n  /** Required for mnemonic accounts when the mock signing is off */\r\n  password?: string,\r\n  /** Set `true` if you only need to emulate the transaction */\r\n  isMockSigning?: boolean,\r\n  /** Used for specific transactions on vesting.ton.org */\r\n  ledgerSubwalletId?: number,\r\n): Signer {\r\n  if (isMockSigning || account.type === 'view') {\r\n    return new MockSigner(account.byChain.ton);\r\n  }\r\n\r\n  if (account.type === 'ledger') {\r\n    return new LedgerSigner(parseAccountId(accountId).network, account.byChain.ton, ledgerSubwalletId);\r\n  }\r\n\r\n  if (password === undefined) throw new Error('Password not provided');\r\n  return new MnemonicSigner(accountId, account, password);\r\n}\r\n\r\nabstract class PrivateKeySigner implements Signer {\r\n  abstract readonly isMock: boolean;\r\n\r\n  constructor(public wallet: ApiTonWallet) {}\r\n\r\n  abstract getPrivateKey(): MaybePromise<Uint8Array | ErrorResult>;\r\n\r\n  async signTonProof(proof: ApiTonConnectProof) {\r\n    const privateKey = await this.getPrivateKey();\r\n    if ('error' in privateKey) return privateKey;\r\n\r\n    const signature = await signTonProofWithPrivateKey(this.wallet.address, privateKey, proof);\r\n    return Buffer.from(signature);\r\n  }\r\n\r\n  async signTransactions(transactions: PreparedTransactionToSign[]) {\r\n    const privateKey = await this.getPrivateKey();\r\n    if ('error' in privateKey) return privateKey;\r\n\r\n    return signTransactionsWithPrivateKey(transactions, this.wallet, privateKey);\r\n  }\r\n\r\n  async signData(timestamp: number, domain: string, payload: SignDataPayload) {\r\n    const privateKey = await this.getPrivateKey();\r\n    if ('error' in privateKey) return privateKey;\r\n\r\n    const signature = await signDataWithPrivateKey(\r\n      this.wallet.address,\r\n      timestamp,\r\n      domain,\r\n      payload,\r\n      privateKey,\r\n    );\r\n    return Buffer.from(signature);\r\n  }\r\n\r\n  async encryptComment(comment: string, recipientPublicKey: Uint8Array) {\r\n    const privateKey = await this.getPrivateKey();\r\n    if ('error' in privateKey) return privateKey;\r\n\r\n    const encrypted = await encryptMessageComment(\r\n      comment,\r\n      this.getPublicKey(),\r\n      recipientPublicKey,\r\n      privateKey,\r\n      this.wallet.address,\r\n    );\r\n    return Buffer.from(encrypted.buffer, encrypted.byteOffset, encrypted.byteLength);\r\n  }\r\n\r\n  async decryptComment(encrypted: Uint8Array, senderAddress: string) {\r\n    const privateKey = await this.getPrivateKey();\r\n    if ('error' in privateKey) return privateKey;\r\n\r\n    return decryptMessageComment(encrypted, this.getPublicKey(), privateKey, senderAddress);\r\n  }\r\n\r\n  getPublicKey() {\r\n    const publicKeyHex = this.wallet.publicKey;\r\n    if (!publicKeyHex) {\r\n      // Mnemonic wallets must always have a public key. This error happens when a developer provides a wrong wallet type.\r\n      throw new Error('Public key is missing');\r\n    }\r\n    return hexToBytes(publicKeyHex);\r\n  }\r\n}\r\n\r\nclass MnemonicSigner extends PrivateKeySigner {\r\n  public isMock = false;\r\n\r\n  constructor(\r\n    public accountId: string,\r\n    public account: ApiAccountWithMnemonic & ApiAccountWithChain<'ton'>,\r\n    public password: string,\r\n  ) {\r\n    super(account.byChain.ton);\r\n  }\r\n\r\n  // Obtaining the key pair from the password takes much time, so the result is cached.\r\n  public getPrivateKey = withCache(async () => {\r\n    const privateKey = await fetchPrivateKey(this.accountId, this.password, this.account);\r\n    return privateKey || { error: ApiCommonError.InvalidPassword };\r\n  });\r\n}\r\n\r\nclass MockSigner extends PrivateKeySigner {\r\n  public isMock = true;\r\n\r\n  public getPrivateKey() {\r\n    return Buffer.alloc(64);\r\n  }\r\n}\r\n\r\nclass LedgerSigner implements Signer {\r\n  public readonly isMock = false;\r\n\r\n  constructor(\r\n    public network: ApiNetwork,\r\n    public wallet: ApiTonWallet,\r\n    public subwalletId?: number,\r\n  ) {}\r\n\r\n  async signTonProof(proof: ApiTonConnectProof) {\r\n    const { signTonProofWithLedger } = await import('../ledger');\r\n    return signTonProofWithLedger(this.network, this.wallet, proof);\r\n  }\r\n\r\n  async signTransactions(transactions: PreparedTransactionToSign[]) {\r\n    const { signTonTransactionsWithLedger } = await import('../ledger');\r\n    return signTonTransactionsWithLedger(this.network, this.wallet, transactions, this.subwalletId);\r\n  }\r\n\r\n  signData(): never {\r\n    throw new Error('Ledger does not support SignData');\r\n  }\r\n\r\n  encryptComment(): never {\r\n    throw new Error('Ledger does not support comment encryption');\r\n  }\r\n\r\n  decryptComment(): never {\r\n    throw new Error('Ledger does not support comment decryption');\r\n  }\r\n}\r\n\r\nfunction signTransactionsWithPrivateKey(\r\n  transactions: PreparedTransactionToSign[],\r\n  storedWallet: ApiTonWallet,\r\n  secretKeyUint8Array: Uint8Array,\r\n) {\r\n  const secretKey = Buffer.from(secretKeyUint8Array);\r\n  const wallet = getTonWallet(storedWallet);\r\n\r\n  return transactions.map((transaction) => {\r\n    if (wallet instanceof WalletContractV5R1) {\r\n      return wallet.createTransfer({\r\n        ...transaction,\r\n        // TODO Remove it. There is bug in @ton/ton library that causes transactions to be executed in reverse order.\r\n        messages: [...transaction.messages].reverse(),\r\n        secretKey,\r\n      });\r\n    }\r\n\r\n    const { authType = 'external' } = transaction;\r\n    if (authType !== 'external') {\r\n      throw new Error(`${storedWallet.version} wallet doesn't support authType \"${authType}\"`);\r\n    }\r\n\r\n    return wallet.createTransfer({ ...transaction, secretKey });\r\n  });\r\n}\r\n","import type { ApiNetwork } from '../../types';\r\nimport type { AddressBook, AnyAction, TraceDetail, Transaction } from './toncenter/types';\r\nimport type { ParsedTrace, ParsedTracePart } from './types';\r\n\r\nimport { bigintAbs } from '../../../util/bigint';\r\nimport { groupBy } from '../../../util/iteratees';\r\nimport { fetchTrace } from './toncenter/traces';\r\nimport { parseRawTransaction } from './toncenter';\r\n\r\n/**\r\n * Returns `undefined` when there is no trace for the given hash. It may be unavailable YET, for example if the trace is\r\n * requested immediately after receiving an action from the socket.\r\n */\r\nexport async function fetchAndParseTrace(\r\n  network: ApiNetwork,\r\n  walletAddress: string,\r\n  msgHashNormalized: string,\r\n  isActionPending?: boolean,\r\n): Promise<ParsedTrace | undefined> {\r\n  const { trace, addressBook } = await fetchTrace({ network, msgHashNormalized, isActionPending });\r\n\r\n  return trace && parseTrace({\r\n    network,\r\n    walletAddress,\r\n    actions: trace.actions,\r\n    traceDetail: trace.trace,\r\n    addressBook,\r\n    transactions: trace.transactions,\r\n  });\r\n}\r\n\r\nexport function parseTrace(options: {\r\n  network: ApiNetwork;\r\n  walletAddress: string;\r\n  actions: AnyAction[];\r\n  traceDetail: TraceDetail;\r\n  addressBook: AddressBook;\r\n  transactions: Record<string, Transaction>;\r\n}): ParsedTrace {\r\n  const {\r\n    network,\r\n    walletAddress,\r\n    actions,\r\n    traceDetail,\r\n    addressBook,\r\n    transactions,\r\n  } = options;\r\n\r\n  const byTransactionIndex = isFailedTransactionTrace(traceDetail)\r\n    ? parseFailedTransactions(traceDetail, transactions)\r\n    : parseCompletedTransactions(network, walletAddress, traceDetail, addressBook, transactions);\r\n\r\n  return {\r\n    actions,\r\n    traceDetail,\r\n    addressBook,\r\n    byTransactionIndex,\r\n    totalSent: byTransactionIndex.reduce((total, { sent }) => total + sent, 0n),\r\n    totalReceived: byTransactionIndex.reduce((total, { received }) => total + received, 0n),\r\n    totalNetworkFee: byTransactionIndex.reduce((total, { networkFee }) => total + networkFee, 0n),\r\n  };\r\n}\r\n\r\nfunction isFailedTransactionTrace(traceDetails: TraceDetail) {\r\n  return traceDetails.children.length === 0;\r\n}\r\n\r\nfunction parseCompletedTransactions(\r\n  network: ApiNetwork,\r\n  walletAddress: string,\r\n  traceDetail: TraceDetail,\r\n  addressBook: AddressBook,\r\n  rawTransactions: Record<string, Transaction>,\r\n): ParsedTracePart[] {\r\n  const transactions = Object.values(rawTransactions)\r\n    .map((rawTx) => parseRawTransaction(network, rawTx, addressBook))\r\n    .flat();\r\n\r\n  const byHash = groupBy(transactions, 'hash');\r\n  const byTransactionIndex: ParsedTracePart[] = [];\r\n\r\n  let isWalletTransactionFound = false;\r\n\r\n  function processTrace(_traceDetail: TraceDetail, _index?: number) {\r\n    const hash = _traceDetail.tx_hash;\r\n    const txs = byHash[hash] || [];\r\n\r\n    if (!isWalletTransactionFound) {\r\n      isWalletTransactionFound = txs.some(({\r\n        fromAddress,\r\n        isIncoming,\r\n      }) => {\r\n        return fromAddress === walletAddress && !isIncoming;\r\n      });\r\n\r\n      // In gasless operations, we need to skip transactions before our wallet\r\n      if (!isWalletTransactionFound) {\r\n        _traceDetail.children.forEach(processTrace);\r\n        return;\r\n      }\r\n    }\r\n\r\n    for (const [i, tx] of txs.entries()) {\r\n      const {\r\n        fromAddress,\r\n        toAddress,\r\n        amount,\r\n        isIncoming,\r\n        fee,\r\n        msgHash,\r\n        type,\r\n      } = tx;\r\n\r\n      const index = _index ?? i;\r\n\r\n      if (!(index in byTransactionIndex)) {\r\n        // First transaction from wallet includes all sub-transactions, and its hash is not unique\r\n        byTransactionIndex.push({\r\n          hashes: new Set(),\r\n          sent: 0n,\r\n          received: 0n,\r\n          networkFee: 0n,\r\n          isSuccess: true,\r\n        });\r\n      } else {\r\n        byTransactionIndex[index].hashes.add(hash);\r\n      }\r\n\r\n      if (fromAddress === walletAddress && !isIncoming) {\r\n        byTransactionIndex[index].sent += bigintAbs(amount);\r\n        byTransactionIndex[index].networkFee = fee;\r\n      } else if (toAddress === walletAddress && isIncoming && type !== 'bounced') {\r\n        byTransactionIndex[index].received += bigintAbs(amount);\r\n      }\r\n\r\n      const child = _traceDetail.children.find(({ in_msg_hash }) => in_msg_hash === msgHash);\r\n      if (child) {\r\n        processTrace(child, index);\r\n      }\r\n    }\r\n  }\r\n\r\n  processTrace(traceDetail);\r\n\r\n  return byTransactionIndex;\r\n}\r\n\r\nfunction parseFailedTransactions(\r\n  traceDetails: TraceDetail,\r\n  rawTransactions: Record<string, Transaction>,\r\n): ParsedTracePart[] {\r\n  const txHash = traceDetails.tx_hash;\r\n  const rawTx = rawTransactions[txHash];\r\n\r\n  // The root transaction can represent multiple actual failed transactions. Instead, the returned array contains only\r\n  // one item. The actual number of failed transactions can be obtained by parsing `rawTx.in_msg.message_content.body`\r\n  // probably, but this is not needed, so the code is simplified.\r\n  return [{\r\n    hashes: new Set([txHash]),\r\n    sent: 0n,\r\n    received: 0n,\r\n    networkFee: BigInt(rawTx.total_fees),\r\n    isSuccess: false,\r\n  }];\r\n}\r\n","import type { ApiNetwork } from '../../../types';\r\nimport type { AddressBook, MetadataMap, Trace } from './types';\r\n\r\nimport { callToncenterV3 } from './other';\r\n\r\nexport type TracesResponse = {\r\n  traces: Trace[];\r\n  address_book: AddressBook;\r\n  metadata: MetadataMap;\r\n};\r\n\r\nexport async function fetchTrace(options: {\r\n  network: ApiNetwork;\r\n  msgHashNormalized: string;\r\n  isActionPending?: boolean;\r\n}): Promise<{\r\n    trace?: Trace;\r\n    addressBook: AddressBook;\r\n    metadata: MetadataMap;\r\n  }> {\r\n  const { network, msgHashNormalized, isActionPending } = options;\r\n\r\n  const response = await callToncenterV3<TracesResponse>(\r\n    network,\r\n    isActionPending ? '/pendingTraces' : '/traces',\r\n    {\r\n      [isActionPending ? 'ext_msg_hash' : 'msg_hash']: msgHashNormalized,\r\n      include_actions: true,\r\n    },\r\n  );\r\n\r\n  return {\r\n    trace: response.traces[0],\r\n    addressBook: response.address_book,\r\n    metadata: response.metadata,\r\n  };\r\n}\r\n","import type {\r\n  ApiActivity,\r\n  ApiDecryptCommentOptions,\r\n  ApiFetchActivitySliceOptions,\r\n  ApiNetwork,\r\n  ApiSwapActivity,\r\n  ApiTransactionActivity,\r\n} from '../../types';\r\nimport type { AnyAction, CallContractAction, JettonTransferAction, SwapAction } from './toncenter/types';\r\nimport type { ParsedTrace, ParsedTracePart } from './types';\r\n\r\nimport { PUSH_ADDRESS, STON_PTON_ADDRESS, TONCOIN } from '../../../config';\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { getActivityTokenSlugs, getIsActivityPending } from '../../../util/activities';\r\nimport { mergeSortedActivities } from '../../../util/activities/order';\r\nimport { fromDecimal, toDecimal } from '../../../util/decimals';\r\nimport { extractKey, findDifference, intersection, split } from '../../../util/iteratees';\r\nimport { logDebug, logDebugError } from '../../../util/logs';\r\nimport { pause } from '../../../util/schedulers';\r\nimport withCacheAsync from '../../../util/withCacheAsync';\r\nimport { getSigner } from './util/signer';\r\nimport { resolveTokenWalletAddress, toBase64Address } from './util/tonCore';\r\nimport { fetchStoredChainAccount, fetchStoredWallet } from '../../common/accounts';\r\nimport { getTokenBySlug, tokensPreload } from '../../common/tokens';\r\nimport { SEC } from '../../constants';\r\nimport { OpCode, OUR_FEE_PAYLOAD_BOC } from './constants';\r\nimport { fetchActions, fetchTransactions, parseActionActivityId, parseLiquidityDeposit } from './toncenter';\r\nimport { fetchAndParseTrace } from './traces';\r\n\r\ntype ActivityDetailsResult = {\r\n  activity: ApiActivity;\r\n  sentForFee: bigint;\r\n  excess: bigint;\r\n};\r\n\r\nconst GET_TRANSACTIONS_LIMIT = 128;\r\n\r\nconst RELOAD_ACTIVITIES_ATTEMPTS = 4;\r\nconst RELOAD_ACTIVITIES_PAUSE = SEC;\r\n\r\nconst TRACE_ATTEMPT_COUNT = 5;\r\nconst TRACE_RETRY_DELAY = SEC;\r\n\r\nexport const checkHasTransaction = withCacheAsync(async (network: ApiNetwork, address: string) => {\r\n  const transactions = await fetchTransactions({\r\n    network,\r\n    address,\r\n    limit: 1,\r\n  });\r\n  return Boolean(transactions.length);\r\n});\r\n\r\nexport async function fetchActivitySlice({\r\n  accountId,\r\n  tokenSlug,\r\n  toTimestamp,\r\n  fromTimestamp,\r\n  limit,\r\n}: ApiFetchActivitySliceOptions): Promise<ApiActivity[]> {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n  let activities: ApiActivity[];\r\n\r\n  if (!tokenSlug) {\r\n    activities = await fetchActions({\r\n      network,\r\n      filter: { address },\r\n      walletAddress: address,\r\n      limit: limit ?? GET_TRANSACTIONS_LIMIT,\r\n      fromTimestamp,\r\n      toTimestamp,\r\n    });\r\n  } else {\r\n    let tokenWalletAddress = address;\r\n\r\n    if (tokenSlug !== TONCOIN.slug) {\r\n      await tokensPreload.promise;\r\n      tokenWalletAddress = await resolveTokenWalletAddress(network, address, getTokenBySlug(tokenSlug)!.tokenAddress!);\r\n    }\r\n\r\n    activities = await fetchActions({\r\n      network,\r\n      filter: { address: tokenWalletAddress },\r\n      walletAddress: address,\r\n      limit: limit ?? GET_TRANSACTIONS_LIMIT,\r\n      fromTimestamp,\r\n      toTimestamp,\r\n    });\r\n\r\n    activities = activities.filter((activity) => getActivityTokenSlugs(activity).includes(tokenSlug));\r\n  }\r\n\r\n  return reloadIncompleteActivities(network, address, activities);\r\n}\r\n\r\nexport async function reloadIncompleteActivities(network: ApiNetwork, address: string, activities: ApiActivity[]) {\r\n  try {\r\n    let actionIdsToReload = activities\r\n      .filter((activity) => activity.shouldReload)\r\n      .map((activity) => parseActionActivityId(activity.id).actionId);\r\n\r\n    for (let attempt = 0; attempt < RELOAD_ACTIVITIES_ATTEMPTS && actionIdsToReload.length; attempt++) {\r\n      logDebug(`Reload incomplete activities #${attempt + 1}`, actionIdsToReload);\r\n      await pause(RELOAD_ACTIVITIES_PAUSE);\r\n\r\n      ({ activities, actionIdsToReload } = await tryReloadIncompleteActivities(\r\n        network,\r\n        address,\r\n        activities,\r\n        actionIdsToReload,\r\n      ));\r\n    }\r\n  } catch (err) {\r\n    logDebugError('reloadIncompleteActivities', err);\r\n  }\r\n\r\n  // We want to return the latest modified activities list in case of an error in the above `try { }`\r\n  return activities;\r\n}\r\n\r\nasync function tryReloadIncompleteActivities(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  activities: ApiActivity[],\r\n  actionIdsToReload: string[],\r\n) {\r\n  const actionIdBatches = split(actionIdsToReload, GET_TRANSACTIONS_LIMIT);\r\n\r\n  const batchResults = await Promise.all(actionIdBatches.map(async (actionIds) => {\r\n    const reloadedActivities = await fetchActions({\r\n      network,\r\n      filter: { actionId: actionIds },\r\n      walletAddress: address,\r\n      limit: GET_TRANSACTIONS_LIMIT,\r\n    });\r\n    return reloadedActivities.filter((activity) => !activity.shouldReload);\r\n  }));\r\n\r\n  const reloadedActivities = batchResults.flat();\r\n\r\n  if (reloadedActivities.length) {\r\n    const replacedIds = new Set(extractKey(reloadedActivities, 'id'));\r\n    const reloadedActionIds = reloadedActivities.map((activity) => parseActionActivityId(activity.id).actionId);\r\n\r\n    activities = mergeSortedActivities(\r\n      activities.filter((activity) => !replacedIds.has(activity.id)),\r\n      reloadedActivities,\r\n    );\r\n    actionIdsToReload = findDifference(actionIdsToReload, reloadedActionIds);\r\n  }\r\n\r\n  return { activities, actionIdsToReload };\r\n}\r\n\r\nexport async function decryptComment({ accountId, activity, password }: ApiDecryptCommentOptions) {\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n  const signer = getSigner(accountId, account, password);\r\n  return signer.decryptComment(Buffer.from(activity.encryptedComment, 'base64'), activity.fromAddress);\r\n}\r\n\r\nexport async function fetchActivityDetails(\r\n  accountId: string,\r\n  activity: ApiActivity,\r\n): Promise<ApiActivity | undefined> {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address: walletAddress } = await fetchStoredWallet(accountId, 'ton');\r\n  let result: ActivityDetailsResult | undefined;\r\n\r\n  // The trace can be unavailable immediately after the action is received, so a couple of delayed retries are made\r\n  for (let attempt = 0; attempt < TRACE_ATTEMPT_COUNT && !result; attempt++) {\r\n    if (attempt > 0) {\r\n      await pause(TRACE_RETRY_DELAY);\r\n    }\r\n\r\n    const parsedTrace = await fetchAndParseTrace(\r\n      network,\r\n      walletAddress,\r\n      activity.externalMsgHashNorm!,\r\n      getIsActivityPending(activity),\r\n    );\r\n    if (!parsedTrace) {\r\n      continue;\r\n    }\r\n\r\n    result = calculateActivityDetails(activity, parsedTrace);\r\n  }\r\n\r\n  if (!result) {\r\n    logDebugError('Trace unavailable for activity', activity.id);\r\n  }\r\n\r\n  return result?.activity;\r\n}\r\n\r\nexport function calculateActivityDetails(\r\n  activity: ApiActivity,\r\n  parsedTrace: ParsedTrace,\r\n  isEmulation?: boolean,\r\n): ActivityDetailsResult | undefined {\r\n  const { actionId } = parseActionActivityId(activity.id);\r\n  const { actions, byTransactionIndex } = parsedTrace;\r\n\r\n  const action = actions.find(({ action_id }) => action_id === actionId);\r\n  if (!action) {\r\n    // This can happen when the trace is requested too early, for example right after receiving the action from a socket\r\n    return undefined;\r\n  }\r\n\r\n  const actionHashes = new Set(action.transactions);\r\n\r\n  const tracePart = byTransactionIndex.find((item) => {\r\n    return intersection(item.hashes, actionHashes).size;\r\n  })!;\r\n\r\n  let result: ActivityDetailsResult;\r\n\r\n  if (activity.kind === 'swap') {\r\n    result = setSwapDetails({\r\n      parsedTrace, activity, action: action as SwapAction, tracePart,\r\n    });\r\n  } else {\r\n    result = setTransactionDetails({\r\n      parsedTrace, activity, action, tracePart, actions, actionId, isEmulation,\r\n    });\r\n  }\r\n\r\n  logDebug('Calculation of fee for action', {\r\n    actionId: action.action_id,\r\n    externalMsgHashNorm: activity.externalMsgHashNorm,\r\n    activityStatus: activity.status,\r\n    networkFee: toDecimal(tracePart.networkFee),\r\n    realFee: toDecimal(getActivityRealFee(result.activity)),\r\n    sentForFee: toDecimal(result.sentForFee),\r\n    excess: toDecimal(result.excess),\r\n    details: action.details,\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\nfunction setSwapDetails(options: {\r\n  parsedTrace: ParsedTrace;\r\n  action: SwapAction;\r\n  activity: ApiSwapActivity;\r\n  tracePart: ParsedTracePart;\r\n}): ActivityDetailsResult {\r\n  const { action, tracePart, parsedTrace: { actions } } = options;\r\n  let { activity } = options;\r\n\r\n  const { details } = action;\r\n\r\n  let sentForFee = tracePart.sent;\r\n  let excess = tracePart.received;\r\n\r\n  // When the transaction is failed, its `sent` and `received` are always 0 (as defined in `parseFailedTransactions`)\r\n  if (tracePart.isSuccess) {\r\n    const isToncoinIn = !details.asset_in;\r\n    const isToncoinOut = details.asset_out\r\n      ? toBase64Address(details.asset_out) === STON_PTON_ADDRESS\r\n      : true;\r\n\r\n    if (isToncoinIn) {\r\n      sentForFee -= BigInt(details.dex_incoming_transfer.amount);\r\n    } else if (isToncoinOut) {\r\n      excess -= BigInt(details.dex_outgoing_transfer.amount);\r\n    }\r\n  }\r\n\r\n  const realFee = tracePart.networkFee + sentForFee - excess;\r\n\r\n  activity = {\r\n    ...activity,\r\n    networkFee: toDecimal(realFee),\r\n  };\r\n\r\n  let ourFee: bigint | undefined;\r\n  if (!details.asset_in) {\r\n    const ourFeeAction = actions.find((_action) => {\r\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-enum-comparison\r\n      return _action.type === 'call_contract' && Number(_action.details.opcode) === OpCode.OurFee;\r\n    }) as CallContractAction | undefined;\r\n    if (ourFeeAction?.success) {\r\n      ourFee = BigInt(ourFeeAction.details.value);\r\n    }\r\n  } else {\r\n    const ourFeeAction = actions.find((_action) => {\r\n      return _action.type === 'jetton_transfer' && _action.details.forward_payload === OUR_FEE_PAYLOAD_BOC;\r\n    }) as JettonTransferAction | undefined;\r\n    if (ourFeeAction?.success) {\r\n      ourFee = BigInt(ourFeeAction.details.amount);\r\n    }\r\n  }\r\n\r\n  if (ourFee) {\r\n    const tokenIn = getTokenBySlug(activity.from);\r\n    activity.ourFee = toDecimal(ourFee, tokenIn?.decimals);\r\n  }\r\n\r\n  delete activity.shouldLoadDetails;\r\n\r\n  return { activity, sentForFee, excess };\r\n}\r\n\r\nfunction setTransactionDetails(options: {\r\n  parsedTrace: ParsedTrace;\r\n  actions: AnyAction[];\r\n  actionId: string;\r\n  action: AnyAction;\r\n  activity: ApiTransactionActivity;\r\n  tracePart: ParsedTracePart;\r\n  isEmulation?: boolean;\r\n}): ActivityDetailsResult {\r\n  const {\r\n    actions,\r\n    actionId,\r\n    action,\r\n    tracePart,\r\n    parsedTrace,\r\n    isEmulation,\r\n  } = options;\r\n\r\n  let { activity } = options;\r\n  let { networkFee, sent: sentForFee, received: excess } = tracePart;\r\n  const { addressBook, totalSent, totalReceived, totalNetworkFee } = parsedTrace;\r\n\r\n  // The flag indicates that this activity is already accounted for in the excess of another activity to avoid double counting\r\n  const isExcessAccounted = isEmulation\r\n    && isActivityExcessAccounted(actions, actionId, tracePart, parsedTrace, activity.fromAddress);\r\n\r\n  switch (action.type) {\r\n    case 'ton_transfer':\r\n    case 'call_contract': {\r\n      const isPush = toBase64Address(action.details.destination) === PUSH_ADDRESS;\r\n      const hasExcess = isExcessAccounted || isPush;\r\n      if (!hasExcess) {\r\n        sentForFee -= BigInt(action.details.value);\r\n      }\r\n      break;\r\n    }\r\n    case 'nft_transfer': {\r\n      if (action.details.is_purchase) {\r\n        sentForFee -= BigInt(action.details.price!);\r\n      }\r\n      break;\r\n    }\r\n    case 'stake_deposit': {\r\n      sentForFee -= BigInt(action.details.amount);\r\n      break;\r\n    }\r\n    case 'stake_withdrawal': {\r\n      excess -= BigInt(action.details.amount);\r\n      break;\r\n    }\r\n    case 'dex_deposit_liquidity': {\r\n      // Liquidity deposit can be either a dual transaction or two separate single transactions.\r\n      // We display the deposit as separate actions, so we divide by the number of actions.\r\n      const activitiesPerAction = BigInt(parseLiquidityDeposit(action, {\r\n        addressBook,\r\n        // The below fields don't matter here, they are only to satisfy the type requirements:\r\n        network: 'mainnet',\r\n        walletAddress: '',\r\n        metadata: {},\r\n        nftSuperCollectionsByCollectionAddress: {},\r\n      }).length);\r\n\r\n      networkFee = totalNetworkFee / activitiesPerAction;\r\n      sentForFee = totalSent / activitiesPerAction;\r\n      excess = totalReceived / activitiesPerAction;\r\n\r\n      if (!action.details.asset_1) {\r\n        sentForFee -= BigInt(action.details.amount_1 ?? 0n) / activitiesPerAction;\r\n      } else if (!action.details.asset_2) {\r\n        sentForFee -= BigInt(action.details.amount_2 ?? 0n) / activitiesPerAction;\r\n      }\r\n      break;\r\n    }\r\n    case 'dex_withdraw_liquidity': {\r\n      if (!action.details.asset_1) {\r\n        excess -= BigInt(action.details.amount_1);\r\n      } else if (!action.details.asset_2) {\r\n        excess -= BigInt(action.details.amount_2);\r\n      }\r\n\r\n      sentForFee /= 2n;\r\n      excess /= 2n;\r\n      break;\r\n    }\r\n  }\r\n\r\n  // When the transaction is failed, its `sent` and `received` are always 0 (as defined in `parseFailedTransactions`)\r\n  if (!tracePart.isSuccess) {\r\n    sentForFee = 0n;\r\n    excess = 0n;\r\n  }\r\n\r\n  const realFee = networkFee + sentForFee - excess;\r\n\r\n  activity = {\r\n    ...activity,\r\n    fee: realFee,\r\n  };\r\n\r\n  delete activity.shouldLoadDetails;\r\n\r\n  return { activity, sentForFee, excess: isExcessAccounted ? 0n : excess };\r\n}\r\n\r\nfunction isActivityExcessAccounted(\r\n  actions: AnyAction[],\r\n  actionId: string,\r\n  tracePart: ParsedTracePart,\r\n  parsedTrace: ParsedTrace,\r\n  fromAddress: string,\r\n): boolean {\r\n  return actions.some((otherAction) =>\r\n    otherAction.action_id !== actionId\r\n    && (otherAction.type === 'ton_transfer' || otherAction.type === 'call_contract')\r\n    && intersection(new Set(otherAction.transactions), tracePart.hashes).size\r\n    && parsedTrace.addressBook[otherAction.details.destination]?.user_friendly === fromAddress,\r\n  );\r\n}\r\n\r\nexport function getActivityRealFee(activity: ApiActivity) {\r\n  return activity.kind === 'swap' ? fromDecimal(activity.networkFee, TONCOIN.decimals) : activity.fee;\r\n}\r\n","import type { ApiBackendConfig, ApiStakingCommonData } from '../types';\r\n\r\nimport Deferred from '../../util/Deferred';\r\n\r\nexport type AccountCache = { stakedAt?: number };\r\n\r\nlet stakingCommonCache: ApiStakingCommonData | undefined;\r\nconst stakingCommonCacheDeferred = new Deferred();\r\n\r\nconst accountCache: Record<string, AccountCache> = {};\r\n\r\nlet backendConfig: ApiBackendConfig | undefined;\r\nconst configDeferred = new Deferred();\r\n\r\nexport function getAccountCache(accountId: string, address: string) {\r\n  return accountCache[`${accountId}:${address}`] ?? {};\r\n}\r\n\r\nexport function updateAccountCache(accountId: string, address: string, partial: Partial<AccountCache>) {\r\n  const key = `${accountId}:${address}`;\r\n  accountCache[key] = { ...accountCache[key], ...partial };\r\n}\r\n\r\nexport function setStakingCommonCache(data: ApiStakingCommonData) {\r\n  stakingCommonCache = data;\r\n  stakingCommonCacheDeferred.resolve();\r\n}\r\n\r\nexport async function getStakingCommonCache() {\r\n  await stakingCommonCacheDeferred.promise;\r\n  return stakingCommonCache!;\r\n}\r\n\r\nexport function setBackendConfigCache(config: ApiBackendConfig) {\r\n  backendConfig = config;\r\n  configDeferred.resolve();\r\n}\r\n\r\n/** Returns the config provided by the backend */\r\nexport async function getBackendConfigCache() {\r\n  await configDeferred.promise;\r\n  return backendConfig!;\r\n}\r\n","//  src/api/common/backendSocket.ts\r\nimport type { InMessageCallback } from '../../util/reconnectingWebsocket';\r\nimport type {\r\n  ApiChain,\r\n  ApiClientSocketMessage,\r\n  ApiNetwork,\r\n  ApiNewActivitySocketMessage,\r\n  ApiServerSocketMessage,\r\n  ApiSocketEventType,\r\n  ApiSubscribedSocketMessage,\r\n} from '../types';\r\n\r\nimport { BRILLIANT_API_BASE_URL } from '../../config';\r\nimport ReconnectingWebSocket from '../../util/reconnectingWebsocket';\r\nimport safeExec from '../../util/safeExec';\r\nimport { throttle } from '../../util/schedulers';\r\nimport withCache from '../../util/withCache';\r\nimport { addBackendHeadersToSocketUrl } from './backend';\r\nimport { getBackendConfigCache } from './cache';\r\n\r\nconst ACTUALIZATION_DELAY = 10;\r\n\r\ninterface WatchedWallet {\r\n  chain: ApiChain;\r\n  events: ApiSocketEventType[];\r\n  address: string;\r\n}\r\n\r\nexport interface WalletWatcher {\r\n  /** Whether the socket is connected and subscribed to the given wallets */\r\n  readonly isConnected: boolean;\r\n  /** Removes the watcher and cleans the memory */\r\n  destroy(): void;\r\n}\r\n\r\ninterface WalletWatcherInternal extends WalletWatcher {\r\n  id: number;\r\n  wallets: WatchedWallet[];\r\n  isConnected: boolean;\r\n  /**\r\n   * Called when a new activity arrives into one of the listened address.\r\n   * In this context activity is any confirmed wallet change.\r\n   * Called only for wallets with an `activity` event.\r\n   *\r\n   * Called only when `isConnected` is true. Therefore, when the socket reconnects, the users should synchronize,\r\n   * otherwise the activity happening during the reconnect will miss.\r\n   */\r\n  onNewActivity?: NewActivityCallback;\r\n  /** Called when isConnected turns true */\r\n  onConnect?: NoneToVoidFunction;\r\n  /** Called when isConnected turns false */\r\n  onDisconnect?: NoneToVoidFunction;\r\n}\r\n\r\nexport type NewActivityCallback = (wallet: WatchedWallet) => void;\r\n\r\n/**\r\n * Connects to the MTW backend to passively listen to updates.\r\n */\r\nclass BackendSocket {\r\n  #network: ApiNetwork;\r\n\r\n  /** Defined only when the socket it needed (i.e. somebody wants to watch something) */\r\n  #socket?: ReconnectingWebSocket<ApiClientSocketMessage, ApiServerSocketMessage>;\r\n\r\n  #walletWatchers: WalletWatcherInternal[] = [];\r\n\r\n  /**\r\n   * A shared incremental counter for various unique ids. The fact that it's incremental is used to tell what actions\r\n   * happened earlier or later than others.\r\n   */\r\n  #currentUniqueId = 0;\r\n\r\n  constructor(network: ApiNetwork) {\r\n    this.#network = network;\r\n  }\r\n\r\n  public watchWallets(\r\n    wallets: WatchedWallet[],\r\n    {\r\n      onNewActivity,\r\n      onConnect,\r\n      onDisconnect,\r\n    }: Pick<WalletWatcherInternal, 'onNewActivity' | 'onConnect' | 'onDisconnect'> = {},\r\n  ): WalletWatcher {\r\n    const id = this.#currentUniqueId++;\r\n    const watcher: WalletWatcherInternal = {\r\n      id,\r\n      wallets,\r\n      // The status will turn to `true` via `#actualizeSocket`  `#sendWatchedWalletsToSocket`  socket request  socket response  `#handleSubscribed`\r\n      isConnected: false,\r\n      onNewActivity,\r\n      onConnect,\r\n      onDisconnect,\r\n      destroy: this.#destroyWalletWatcher.bind(this, id),\r\n    };\r\n    this.#walletWatchers.push(watcher);\r\n    this.#actualizeSocket();\r\n    return watcher;\r\n  }\r\n\r\n  /** Removes the given watcher and unsubscribes from its wallets. Brings the sockets to the proper state. */\r\n  #destroyWalletWatcher(watcherId: number) {\r\n    const index = this.#walletWatchers.findIndex((watcher) => watcher.id === watcherId);\r\n    if (index >= 0) {\r\n      this.#walletWatchers.splice(index, 1);\r\n      this.#actualizeSocket();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates or destroys the given socket (if needed) and subscribes to the watched wallets.\r\n   *\r\n   * The method is throttled in order to:\r\n   *  - Avoid sending too many requests when the watched addresses change many times in a short time range.\r\n   *  - Avoid reconnecting the socket when watched addresses arrive shortly after stopping watching all addresses.\r\n   */\r\n  #actualizeSocket = throttle(async () => {\r\n    const { isWebSocketEnabled } = await getBackendConfigCache();\r\n\r\n    if (isWebSocketEnabled && this.#doesHaveWatchedAddresses()) {\r\n      this.#socket ??= this.#createSocket();\r\n      if (this.#socket.isConnected) {\r\n        this.#sendWatchedWalletsToSocket();\r\n      } // Otherwise, the addresses will be sent when the socket gets connected\r\n    } else {\r\n      this.#socket?.close();\r\n      this.#socket = undefined;\r\n    }\r\n  }, ACTUALIZATION_DELAY, false);\r\n\r\n  #createSocket() {\r\n    const url = getSocketUrl(this.#network);\r\n    const socket = new ReconnectingWebSocket<ApiClientSocketMessage, ApiServerSocketMessage>(url);\r\n    socket.onMessage(this.#handleSocketMessage);\r\n    socket.onConnect(this.#handleSocketConnect);\r\n    socket.onDisconnect(this.#handleSocketDisconnect);\r\n    return socket;\r\n  }\r\n\r\n  #handleSocketMessage: InMessageCallback<ApiServerSocketMessage> = (message) => {\r\n    switch (message.type) {\r\n      case 'subscribed':\r\n        this.#handleSubscribed(message);\r\n        break;\r\n      case 'newActivity':\r\n        this.#handleNewActivity(message);\r\n        break;\r\n    }\r\n  };\r\n\r\n  #handleSocketConnect = () => {\r\n    this.#sendWatchedWalletsToSocket();\r\n  };\r\n\r\n  #handleSocketDisconnect = () => {\r\n    for (const watcher of this.#walletWatchers) {\r\n      if (watcher.isConnected) {\r\n        watcher.isConnected = false;\r\n        if (watcher.onDisconnect) safeExec(watcher.onDisconnect);\r\n      }\r\n    }\r\n  };\r\n\r\n  #handleSubscribed(message: ApiSubscribedSocketMessage) {\r\n    for (const watcher of this.#walletWatchers) {\r\n      // If message id < watcher id, then the watcher was created after the subscribe request was sent, therefore\r\n      // the socket may be not subscribed to all the watcher addresses yet.\r\n      if (message.id < watcher.id) {\r\n        continue;\r\n      }\r\n\r\n      if (!watcher.isConnected) {\r\n        watcher.isConnected = true;\r\n        if (watcher.onConnect) safeExec(watcher.onConnect);\r\n      }\r\n    }\r\n  }\r\n\r\n  #handleNewActivity(message: ApiNewActivitySocketMessage) {\r\n    const messageAddresses = new Set(message.addresses);\r\n\r\n    for (const { wallets, isConnected, onNewActivity } of this.#walletWatchers) {\r\n      // Even though the socket may already listen to some wallet addresses, we promise the class users to trigger the\r\n      // onNewActivity callback only in the connected state.\r\n      if (!isConnected || !onNewActivity) {\r\n        continue;\r\n      }\r\n\r\n      for (const wallet of wallets) {\r\n        const doesWalletMatch = (\r\n          wallet.chain === message.chain\r\n          && messageAddresses.has(wallet.address)\r\n          && wallet.events.includes('activity')\r\n        );\r\n\r\n        if (doesWalletMatch) {\r\n          safeExec(() => onNewActivity(wallet));\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  #sendWatchedWalletsToSocket() {\r\n    // It's necessary to collect the watched addresses synchronously with locking the request id.\r\n    // It makes sure that all the watchers with ids < the response id will be subscribed.\r\n    const addresses = this.#getWatchedAddresses(['activity']);\r\n    const requestId = this.#currentUniqueId++;\r\n\r\n    // It's necessary to send a `subscribe` request on every `#sendWatchedWalletsToSocket` call, even if the list of\r\n    // addresses hasn't changed. Otherwise, the mechanism turning `isConnected` to `true` in the watchers will break if\r\n    // a new watcher containing only existing addresses is added.\r\n    this.#socket!.send({\r\n      type: 'subscribe',\r\n      id: requestId,\r\n      addresses: addresses.map((address) => ({\r\n        ...address,\r\n        events: ['activity'],\r\n      })),\r\n    });\r\n  }\r\n\r\n  #doesHaveWatchedAddresses() {\r\n    return this.#walletWatchers.some((watcher) => watcher.wallets.length);\r\n  }\r\n\r\n  /** Collects the addresses (grouped by chain) from the current watchers */\r\n  #getWatchedAddresses(events: ApiSocketEventType[]) {\r\n    const addresses: { chain: ApiChain; address: string }[] = [];\r\n\r\n    for (const watcher of this.#walletWatchers) {\r\n      for (const wallet of watcher.wallets) {\r\n        if (!wallet.events.some((event) => events.includes(event))) {\r\n          continue;\r\n        }\r\n\r\n        addresses.push({\r\n          chain: wallet.chain,\r\n          address: wallet.address,\r\n        });\r\n      }\r\n    }\r\n\r\n    return addresses;\r\n  }\r\n}\r\n\r\nfunction getSocketUrl(network: ApiNetwork) {\r\n  const url = new URL(BRILLIANT_API_BASE_URL);\r\n  url.protocol = url.protocol === 'http' ? 'ws' : 'wss';\r\n  url.pathname += `${network === 'testnet' ? 'testnet/' : ''}ws`;\r\n  addBackendHeadersToSocketUrl(url);\r\n  return url;\r\n}\r\n\r\n/** Returns a singleton (one constant instance per a network) */\r\nexport const getBackendSocket = withCache((network: ApiNetwork) => {\r\n  return new BackendSocket(network);\r\n});\r\n\r\nexport type { BackendSocket };\r\n","import type { ApiChain, ApiNetwork } from '../../types';\r\nimport type { WalletWatcher } from '../backendSocket';\r\nimport type { FallbackPollingOptions } from './fallbackPollingScheduler';\r\nimport type { Period } from './utils';\r\n\r\nimport { getChainConfig } from '../../../util/chain';\r\nimport { focusAwareDelay } from '../../../util/focusAwareDelay';\r\nimport { pause, throttle } from '../../../util/schedulers';\r\nimport { getBackendSocket } from '../backendSocket';\r\nimport { FallbackPollingScheduler } from './fallbackPollingScheduler';\r\nimport { periodToMs } from './utils';\r\n\r\nconst UPDATE_CALLBACK_DELAY = 10;\r\n\r\nexport interface WalletPollingOptions {\r\n  chain: ApiChain;\r\n  network: ApiNetwork;\r\n  address: string;\r\n  pollingOptions: FallbackPollingOptions;\r\n  /**\r\n   * Called whenever the wallet data should be updated.\r\n   * The polling always waits until the returned promise resolves before running this callback again.\r\n   *\r\n   * @param isConfident `true` when the update was reported by the socket. `false` when the update is initiated by a\r\n   *  timer. If `false`, the app should check a piece of wallet before refreshing the whole data (to avoid excessive\r\n   *  network requests).\r\n   */\r\n  onUpdate(isConfident: boolean): MaybePromise<unknown>;\r\n}\r\n\r\n/**\r\n * Helps polling wallet balance and activity. Uses the backend websocket as the primary signal source and falls back\r\n * to simple time intervals if the websocket is unavailable. It doesn't provide the updated data, it provides signals\r\n * when the data should be fetched using the plain HTTP API.\r\n */\r\nexport class WalletPolling {\r\n  #minPollDelay: Period;\r\n  #onUpdate: WalletPollingOptions['onUpdate'];\r\n\r\n  #walletWatcher?: WalletWatcher;\r\n\r\n  #fallbackPollingScheduler: FallbackPollingScheduler;\r\n\r\n  #isDestroyed = false;\r\n\r\n  /** Undefined when no update is pending. Otherwise, holds the `isConfident` value (see `onUpdate` for more details) */\r\n  #pendingUpdate?: boolean;\r\n\r\n  constructor(options: WalletPollingOptions) {\r\n    this.#minPollDelay = options.pollingOptions.minPollDelay;\r\n    this.#onUpdate = options.onUpdate;\r\n\r\n    const doesSupportSocket = getChainConfig(options.chain).doesBackendSocketSupport;\r\n\r\n    if (doesSupportSocket) {\r\n      this.#walletWatcher = getBackendSocket(options.network).watchWallets(\r\n        [{\r\n          chain: options.chain,\r\n          events: ['activity'],\r\n          address: options.address,\r\n        }],\r\n        {\r\n          onNewActivity: this.#handleSocketNewActivity,\r\n          onConnect: this.#handleSocketConnect,\r\n          onDisconnect: this.#handleSocketDisconnect,\r\n        },\r\n      );\r\n    }\r\n\r\n    this.#fallbackPollingScheduler = new FallbackPollingScheduler(\r\n      this.#triggerBackupNotifications,\r\n      this.#walletWatcher?.isConnected ?? false,\r\n      {\r\n        ...options.pollingOptions,\r\n        pollingStartDelay: doesSupportSocket ? options.pollingOptions.pollingStartDelay : undefined, // If the backend socket doesn't support this chain, the polling should start sooner\r\n      },\r\n    );\r\n  }\r\n\r\n  public destroy() {\r\n    this.#isDestroyed = true;\r\n    this.#walletWatcher?.destroy();\r\n    this.#fallbackPollingScheduler.destroy();\r\n  }\r\n\r\n  #handleSocketNewActivity = () => {\r\n    this.#pendingUpdate = true;\r\n    this.#runUpdateCallback();\r\n    this.#fallbackPollingScheduler.onSocketMessage();\r\n  };\r\n\r\n  #handleSocketConnect = () => {\r\n    this.#triggerBackupNotifications();\r\n    this.#fallbackPollingScheduler.onSocketConnect();\r\n  };\r\n\r\n  #handleSocketDisconnect = () => {\r\n    this.#fallbackPollingScheduler.onSocketDisconnect();\r\n  };\r\n\r\n  #triggerBackupNotifications = () => {\r\n    this.#pendingUpdate ??= false;\r\n    this.#runUpdateCallback();\r\n  };\r\n\r\n  #runUpdateCallback = throttle(async () => {\r\n    if (this.#pendingUpdate === undefined) {\r\n      return;\r\n    }\r\n\r\n    // To let sneak in the updates arriving in short-time batches. Otherwise, they will cause another onUpdate call.\r\n    await pause(UPDATE_CALLBACK_DELAY);\r\n    if (this.#isDestroyed) return;\r\n\r\n    const isConfident = this.#pendingUpdate;\r\n    this.#pendingUpdate = undefined;\r\n    await this.#onUpdate(isConfident);\r\n  }, () => {\r\n    const [ms, forceMs] = periodToMs(this.#minPollDelay);\r\n    return focusAwareDelay(\r\n      ms - UPDATE_CALLBACK_DELAY,\r\n      forceMs - UPDATE_CALLBACK_DELAY,\r\n    );\r\n  });\r\n}\r\n","import type { ApiChain, ApiNetwork } from '../../types';\r\n\r\nimport { createTaskQueue } from '../../../util/schedulers';\r\nimport { inactiveWalletTiming } from './utils';\r\nimport { WalletPolling } from './walletPolling';\r\n\r\nconst concurrencyLimiters: Record<string, ReturnType<typeof createTaskQueue>> = {};\r\n\r\n/**\r\n * Starts polling of the given inactive account in the given chain. Returns a function that stops the polling.\r\n */\r\nexport function setupInactiveChainPolling(\r\n  chain: ApiChain,\r\n  network: ApiNetwork,\r\n  address: string,\r\n  updateBalance: () => Promise<unknown>,\r\n) {\r\n  const concurrencyLimiter = getConcurrencyLimiter(chain, network);\r\n\r\n  const walletPolling = new WalletPolling({\r\n    chain,\r\n    network,\r\n    address,\r\n    pollingOptions: inactiveWalletTiming,\r\n    onUpdate: concurrencyLimiter.wrap(async () => {\r\n      await updateBalance();\r\n    }),\r\n  });\r\n\r\n  return () => {\r\n    walletPolling.destroy();\r\n  };\r\n}\r\n\r\nexport function getConcurrencyLimiter(chain: ApiChain, network: ApiNetwork) {\r\n  const key = `${chain} ${network}`;\r\n  concurrencyLimiters[key] ||= createTaskQueue();\r\n  return concurrencyLimiters[key];\r\n}\r\n","import type { ApiActivity, ApiSwapActivity, ApiSwapHistoryItem } from '../types';\r\n\r\nimport { SWAP_API_VERSION, SWAP_CROSSCHAIN_SLUGS, TONCOIN } from '../../config';\r\nimport { parseAccountId } from '../../util/account';\r\nimport { buildBackendSwapId, getActivityTokenSlugs, parseTxId } from '../../util/activities';\r\nimport { mergeSortedActivities, sortActivities } from '../../util/activities/order';\r\nimport { logDebugError } from '../../util/logs';\r\nimport { fetchStoredAccount } from './accounts';\r\nimport { callBackendGet, callBackendPost } from './backend';\r\nimport { getBackendConfigCache } from './cache';\r\nimport { buildTokenSlug, getTokenByAddress, getTokenBySlug } from './tokens';\r\n\r\nexport async function swapGetHistory(address: string, params: {\r\n  fromTimestamp?: number;\r\n  toTimestamp?: number;\r\n  status?: ApiSwapHistoryItem['status'];\r\n  isCex?: boolean;\r\n  asset?: string;\r\n  hashes?: string[];\r\n}): Promise<ApiSwapHistoryItem[]> {\r\n  const { swapVersion } = await getBackendConfigCache();\r\n\r\n  const items = await callBackendPost<ApiSwapHistoryItem[]>(`/swap/history/${address}`, {\r\n    ...params,\r\n    swapVersion: swapVersion ?? SWAP_API_VERSION,\r\n  });\r\n\r\n  return items.map(convertSwapItemToTrusted);\r\n}\r\n\r\nexport async function swapGetHistoryItem(address: string, id: string): Promise<ApiSwapHistoryItem> {\r\n  const { swapVersion } = await getBackendConfigCache();\r\n\r\n  const item = await callBackendGet<ApiSwapHistoryItem>(`/swap/history/${address}/${id}`, {\r\n    swapVersion: swapVersion ?? SWAP_API_VERSION,\r\n  });\r\n\r\n  return convertSwapItemToTrusted(item);\r\n}\r\n\r\nexport function swapItemToActivity(swap: ApiSwapHistoryItem): ApiSwapActivity {\r\n  return {\r\n    ...swap,\r\n    id: buildBackendSwapId(swap.id),\r\n    kind: 'swap',\r\n    from: getSwapItemSlug(swap, swap.from),\r\n    to: getSwapItemSlug(swap, swap.to),\r\n    shouldLoadDetails: !swap.cex,\r\n  };\r\n}\r\n\r\nexport function getSwapItemSlug(item: ApiSwapHistoryItem, asset: string) {\r\n  if (asset === TONCOIN.symbol) {\r\n    return TONCOIN.slug;\r\n  }\r\n  if (item.cex) {\r\n    return getTokenByAddress(asset)?.slug ?? asset;\r\n  }\r\n  return buildTokenSlug('ton', asset);\r\n}\r\n\r\nexport async function patchSwapItem(options: {\r\n  address: string;\r\n  swapId: string;\r\n  authToken: string;\r\n  msgHash?: string;\r\n  error?: string;\r\n}) {\r\n  const {\r\n    address, swapId, authToken, msgHash, error,\r\n  } = options;\r\n\r\n  const { swapVersion } = await getBackendConfigCache();\r\n\r\n  await callBackendPost(`/swap/history/${address}/${swapId}/update`, {\r\n    swapVersion: swapVersion ?? SWAP_API_VERSION,\r\n    msgHash,\r\n    error,\r\n  }, {\r\n    method: 'PATCH',\r\n    authToken,\r\n  });\r\n}\r\n\r\nexport async function swapReplaceCexActivities(\r\n  accountId: string,\r\n  /** Must be sorted */\r\n  activities: ApiActivity[],\r\n  slug?: string,\r\n  isToNow?: boolean,\r\n): Promise<ApiActivity[]> {\r\n  if (!activities.length || parseAccountId(accountId).network === 'testnet' || !canHaveCexSwap(slug, activities)) {\r\n    return activities;\r\n  }\r\n\r\n  try {\r\n    const { byChain: { ton: { address } = {} } } = await fetchStoredAccount(accountId);\r\n    if (!address) {\r\n      return activities;\r\n    }\r\n\r\n    const firstTimestamp = activities[0].timestamp;\r\n    const lastTimestamp = activities[activities.length - 1].timestamp;\r\n\r\n    const [fromTime, toTime] = firstTimestamp < lastTimestamp\r\n      ? [firstTimestamp, isToNow ? Date.now() : lastTimestamp]\r\n      : [lastTimestamp, isToNow ? Date.now() : firstTimestamp];\r\n\r\n    const hashes = activities.map(({ id }) => parseTxId(id).hash);\r\n\r\n    const swaps = await swapGetHistory(address, {\r\n      fromTimestamp: fromTime,\r\n      toTimestamp: toTime,\r\n      asset: slug ? getTokenBySlug(slug)?.tokenAddress ?? TONCOIN.symbol : undefined,\r\n      hashes,\r\n      isCex: true,\r\n    });\r\n\r\n    if (!swaps.length) {\r\n      return activities;\r\n    }\r\n\r\n    const swapActivities: ApiActivity[] = [];\r\n    const allSwapHashes = new Set<string>();\r\n\r\n    for (const swap of swaps) {\r\n      swap.hashes.forEach((hash) => allSwapHashes.add(hash));\r\n\r\n      const isSwapHere = swap.timestamp > fromTime && swap.timestamp < toTime;\r\n      if (isSwapHere) {\r\n        swapActivities.push(swapItemToActivity(swap));\r\n      }\r\n    }\r\n\r\n    const otherActivities = activities.map((activity) => {\r\n      if (activity.kind === 'transaction' && allSwapHashes.has(parseTxId(activity.id).hash)) {\r\n        return { ...activity, shouldHide: true };\r\n      } else {\r\n        return activity;\r\n      }\r\n    });\r\n\r\n    // Even though the swap activities returned by the backend are sorted by timestamp, the client-side sorting may differ.\r\n    // It's important to enforce our sorting, because otherwise `mergeSortedActivities` may leave duplicates.\r\n    return mergeSortedActivities(sortActivities(swapActivities), otherActivities);\r\n  } catch (err) {\r\n    logDebugError('swapReplaceCexActivities', err);\r\n    return activities;\r\n  }\r\n}\r\n\r\nfunction canHaveCexSwap(slug: string | undefined, activities: ApiActivity[]): boolean {\r\n  if (slug) {\r\n    return SWAP_CROSSCHAIN_SLUGS.has(slug);\r\n  }\r\n\r\n  return activities.some((activity) => {\r\n    return getActivityTokenSlugs(activity).some((slug) => {\r\n      return SWAP_CROSSCHAIN_SLUGS.has(slug);\r\n    });\r\n  });\r\n}\r\n\r\nexport function convertSwapItemToTrusted(swap: ApiSwapHistoryItem): ApiSwapHistoryItem {\r\n  return {\r\n    ...swap,\r\n    status: swap.status === 'pending' ? 'pendingTrusted' : swap.status,\r\n  };\r\n}\r\n","import type { ApiTransactionActivity } from '../types';\r\n\r\nimport { createCallbackManager } from '../../util/callbacks';\r\n\r\nexport const txCallbacks = createCallbackManager();\r\n\r\nexport function whenTxComplete(normalizedAddress: string, amount: bigint) {\r\n  return new Promise<{ result: boolean; transaction: ApiTransactionActivity }>((resolve) => {\r\n    txCallbacks.addCallback(\r\n      function callback(transaction: ApiTransactionActivity) {\r\n        if (transaction.normalizedAddress === normalizedAddress && transaction.amount === -amount) {\r\n          txCallbacks.removeCallback(callback);\r\n          resolve({ result: true, transaction });\r\n        }\r\n      },\r\n    );\r\n  });\r\n}\r\n","import type { ApiNetwork, ApiTokenWithPrice } from '../../types';\r\n\r\nimport { buildCollectionByKey } from '../../../util/iteratees';\r\nimport { logDebugError } from '../../../util/logs';\r\nimport { getTokensCache, tokensPreload, updateTokens } from '../../common/tokens';\r\nimport { getAccountStates } from './toncenter';\r\n\r\nexport async function updateTokenHashes(\r\n  network: ApiNetwork,\r\n  tokenSlugs: string[],\r\n  sendUpdateTokens?: NoneToVoidFunction,\r\n) {\r\n  await tokensPreload.promise;\r\n  const cachedTokens = getTokensCache().bySlug;\r\n\r\n  const tokensToFetch = tokenSlugs.reduce<ApiTokenWithPrice[]>((tokensToFetch, tokenSlug) => {\r\n    const token = cachedTokens[tokenSlug];\r\n\r\n    if (\r\n      token\r\n      && token.chain === 'ton'\r\n      && !token.codeHash\r\n      && ['LP', 'STAKED', 'POOL'].some((option) => token.symbol.toUpperCase().includes(option))\r\n    ) {\r\n      tokensToFetch.push(token);\r\n    }\r\n\r\n    return tokensToFetch;\r\n  }, []);\r\n\r\n  if (!tokensToFetch.length) {\r\n    return;\r\n  }\r\n\r\n  const tokensByAddress = buildCollectionByKey(tokensToFetch, 'tokenAddress');\r\n\r\n  try {\r\n    const states = await getAccountStates(network, tokensToFetch.map((token) => token.tokenAddress!));\r\n\r\n    for (const address of Object.keys(states)) {\r\n      if (!tokensByAddress[address]) continue;\r\n      tokensByAddress[address].codeHash = Buffer.from(states[address].code_hash, 'base64').toString('hex');\r\n    }\r\n\r\n    await updateTokens(Object.values(tokensByAddress).filter((token) => token.codeHash), sendUpdateTokens);\r\n  } catch (err) {\r\n    logDebugError('Failed to fetch contract code hashes for tokens', err);\r\n  }\r\n}\r\n","import type { JettonBalance } from 'tonapi-sdk-js';\r\nimport { Address, Cell } from '@ton/core';\r\n\r\nimport type { ApiBalanceBySlug, ApiNetwork, ApiToken, ApiTokenWithPrice } from '../../types';\r\nimport type { AnyPayload, JettonMetadata, TonTransferParams } from './types';\r\n\r\nimport { TON_USDT_MAINNET_SLUG, TON_USDT_TESTNET_SLUG } from '../../../config';\r\nimport { fetchJsonWithProxy, fixIpfsUrl } from '../../../util/fetch';\r\nimport { logDebugError } from '../../../util/logs';\r\nimport { fetchJettonMetadata, fixBase64ImageData, parsePayloadBase64 } from './util/metadata';\r\nimport { fetchJettonBalances } from './util/tonapiio';\r\nimport {\r\n  buildTokenTransferBody,\r\n  getTokenBalance,\r\n  getTonClient,\r\n  resolveTokenAddress,\r\n  resolveTokenWalletAddress,\r\n  toBase64Address, toRawAddress,\r\n} from './util/tonCore';\r\nimport { buildTokenSlug, getTokenByAddress, updateTokens } from '../../common/tokens';\r\nimport {\r\n  CLAIM_MINTLESS_AMOUNT,\r\n  DEFAULT_DECIMALS,\r\n  TINIEST_TOKEN_TRANSFER_REAL_AMOUNT,\r\n  TINY_TOKEN_TRANSFER_AMOUNT,\r\n  TINY_TOKEN_TRANSFER_REAL_AMOUNT,\r\n  TOKEN_TRANSFER_AMOUNT,\r\n  TOKEN_TRANSFER_FORWARD_AMOUNT,\r\n  TOKEN_TRANSFER_REAL_AMOUNT,\r\n} from './constants';\r\nimport { updateTokenHashes } from './priceless';\r\nimport { isActiveSmartContract } from './wallet';\r\n\r\nexport type TokenBalanceParsed = {\r\n  slug: string;\r\n  balance: bigint;\r\n  token: ApiToken;\r\n  jettonWallet: string;\r\n};\r\n\r\nasync function getTokenBalances(network: ApiNetwork, address: string) {\r\n  const balancesRaw = await fetchJettonBalances(network, address);\r\n  return balancesRaw.map((balance) => parseTokenBalance(network, balance)).filter(Boolean);\r\n}\r\n\r\nfunction parseTokenBalance(network: ApiNetwork, balanceRaw: JettonBalance): TokenBalanceParsed | undefined {\r\n  if (!balanceRaw.jetton) {\r\n    return undefined;\r\n  }\r\n\r\n  try {\r\n    const { balance, jetton, wallet_address: walletAddress } = balanceRaw;\r\n    const tokenAddress = toBase64Address(jetton.address, true, network);\r\n    const token = buildTokenByMetadata(tokenAddress, jetton);\r\n\r\n    return {\r\n      slug: token.slug,\r\n      balance: BigInt(balance),\r\n      token,\r\n      jettonWallet: toBase64Address(walletAddress.address, undefined, network),\r\n    };\r\n  } catch (err) {\r\n    logDebugError('parseTokenBalance', err);\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport async function insertMintlessPayload(\r\n  network: ApiNetwork,\r\n  fromAddress: string,\r\n  tokenAddress: string,\r\n  transfer: TonTransferParams,\r\n): Promise<TonTransferParams> {\r\n  const { toAddress, payload } = transfer;\r\n\r\n  const token = getTokenByAddress(tokenAddress);\r\n  if (typeof payload !== 'string' || !token?.customPayloadApiUrl) {\r\n    return transfer;\r\n  }\r\n\r\n  const parsedPayload = await parsePayloadBase64(network, toAddress, payload);\r\n  if (parsedPayload.type !== 'tokens:transfer') {\r\n    throw new Error('Invalid payload');\r\n  }\r\n\r\n  const {\r\n    mintlessTokenBalance,\r\n    isMintlessClaimed,\r\n    stateInit,\r\n    customPayload,\r\n  } = await getMintlessParams({\r\n    network,\r\n    token,\r\n    fromAddress,\r\n    tokenWalletAddress: transfer.toAddress,\r\n  });\r\n\r\n  if (!mintlessTokenBalance || isMintlessClaimed) {\r\n    return transfer;\r\n  }\r\n\r\n  const newPayload = buildTokenTransferBody({\r\n    toAddress: parsedPayload.destination,\r\n    queryId: parsedPayload.queryId,\r\n    tokenAmount: parsedPayload.amount,\r\n    forwardAmount: parsedPayload.forwardAmount,\r\n    forwardPayload: Cell.fromBase64(parsedPayload.forwardPayload!),\r\n    responseAddress: parsedPayload.responseDestination,\r\n    customPayload: Cell.fromBase64(customPayload!),\r\n  });\r\n\r\n  return {\r\n    ...transfer,\r\n    stateInit: stateInit ? Cell.fromBase64(stateInit) : undefined,\r\n    payload: newPayload,\r\n    isBase64Payload: false,\r\n  };\r\n}\r\n\r\nexport async function buildTokenTransfer(options: {\r\n  network: ApiNetwork;\r\n  tokenAddress: string;\r\n  fromAddress: string;\r\n  toAddress: string;\r\n  amount: bigint;\r\n  payload?: AnyPayload;\r\n  shouldSkipMintless?: boolean;\r\n  forwardAmount?: bigint;\r\n  isLedger?: boolean;\r\n}) {\r\n  const {\r\n    network,\r\n    tokenAddress,\r\n    fromAddress,\r\n    toAddress,\r\n    amount,\r\n    shouldSkipMintless,\r\n    forwardAmount = TOKEN_TRANSFER_FORWARD_AMOUNT,\r\n    isLedger,\r\n  } = options;\r\n  let { payload } = options;\r\n\r\n  const tokenWalletAddress = await resolveTokenWalletAddress(network, fromAddress, tokenAddress);\r\n  const token = getTokenByAddress(tokenAddress)!;\r\n\r\n  const {\r\n    isTokenWalletDeployed = !!(await isActiveSmartContract(network, tokenWalletAddress)),\r\n    isMintlessClaimed,\r\n    mintlessTokenBalance,\r\n    customPayload,\r\n    stateInit,\r\n  } = await getMintlessParams({\r\n    network, fromAddress, token, tokenWalletAddress, shouldSkipMintless,\r\n  });\r\n\r\n  if (isTokenWalletDeployed) {\r\n    const realTokenAddress = await resolveTokenAddress(network, tokenWalletAddress);\r\n    if (tokenAddress !== realTokenAddress) {\r\n      throw new Error('Invalid contract');\r\n    }\r\n  }\r\n\r\n  // In ledger-app-ton v2.7.0 a queryId not equal to 0 is handled incorrectly.\r\n  const queryId = isLedger ? 0n : undefined;\r\n\r\n  payload = buildTokenTransferBody({\r\n    tokenAmount: amount,\r\n    toAddress,\r\n    forwardAmount,\r\n    forwardPayload: payload,\r\n    responseAddress: fromAddress,\r\n    customPayload: customPayload ? Cell.fromBase64(customPayload) : undefined,\r\n    queryId,\r\n  });\r\n\r\n  // eslint-disable-next-line prefer-const\r\n  let { amount: toncoinAmount, realAmount } = getToncoinAmountForTransfer(\r\n    token, Boolean(mintlessTokenBalance) && !isMintlessClaimed,\r\n  );\r\n\r\n  if (forwardAmount > TOKEN_TRANSFER_FORWARD_AMOUNT) {\r\n    toncoinAmount += forwardAmount;\r\n  }\r\n\r\n  return {\r\n    amount: toncoinAmount,\r\n    realAmount,\r\n    toAddress: tokenWalletAddress,\r\n    payload,\r\n    stateInit: stateInit ? Cell.fromBase64(stateInit) : undefined,\r\n    mintlessTokenBalance,\r\n    isTokenWalletDeployed,\r\n  };\r\n}\r\n\r\nexport async function getTokenBalanceWithMintless(network: ApiNetwork, accountAddress: string, tokenAddress: string) {\r\n  const tokenWalletAddress = await resolveTokenWalletAddress(network, accountAddress, tokenAddress);\r\n  const token = getTokenByAddress(tokenAddress)!;\r\n\r\n  const {\r\n    isTokenWalletDeployed = !!(await isActiveSmartContract(network, tokenWalletAddress)),\r\n    mintlessTokenBalance,\r\n  } = await getMintlessParams({\r\n    network, fromAddress: accountAddress, token, tokenWalletAddress,\r\n  });\r\n\r\n  return calculateTokenBalanceWithMintless(network, tokenWalletAddress, isTokenWalletDeployed, mintlessTokenBalance);\r\n}\r\n\r\nexport async function calculateTokenBalanceWithMintless(\r\n  network: ApiNetwork,\r\n  tokenWalletAddress: string,\r\n  isTokenWalletDeployed?: boolean,\r\n  mintlessTokenBalance = 0n,\r\n) {\r\n  let balance = 0n;\r\n  if (isTokenWalletDeployed) {\r\n    balance += await getTokenBalance(network, tokenWalletAddress);\r\n  }\r\n  if (mintlessTokenBalance) {\r\n    balance += mintlessTokenBalance;\r\n  }\r\n  return balance;\r\n}\r\n\r\nasync function getMintlessParams(options: {\r\n  network: ApiNetwork;\r\n  fromAddress: string;\r\n  token: ApiToken;\r\n  tokenWalletAddress: string;\r\n  shouldSkipMintless?: boolean;\r\n}) {\r\n  const {\r\n    network, fromAddress, token, tokenWalletAddress, shouldSkipMintless,\r\n  } = options;\r\n\r\n  const isMintlessToken = !!token.customPayloadApiUrl;\r\n  let isTokenWalletDeployed: boolean | undefined;\r\n  let customPayload: string | undefined;\r\n  let stateInit: string | undefined;\r\n\r\n  let isMintlessClaimed: boolean | undefined;\r\n  let mintlessTokenBalance: bigint | undefined;\r\n\r\n  if (isMintlessToken && !shouldSkipMintless) {\r\n    isTokenWalletDeployed = !!(await isActiveSmartContract(network, tokenWalletAddress));\r\n    isMintlessClaimed = isTokenWalletDeployed && await checkMintlessTokenWalletIsClaimed(network, tokenWalletAddress);\r\n\r\n    if (!isMintlessClaimed) {\r\n      const data = await fetchMintlessTokenWalletData(token.customPayloadApiUrl!, fromAddress);\r\n      const isExpired = data\r\n        ? Date.now() > new Date(Number(data.compressed_info.expired_at) * 1000).getTime()\r\n        : true;\r\n\r\n      if (data && !isExpired) {\r\n        customPayload = data.custom_payload;\r\n        mintlessTokenBalance = BigInt(data.compressed_info.amount);\r\n\r\n        if (!isTokenWalletDeployed) {\r\n          stateInit = data.state_init;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    isTokenWalletDeployed,\r\n    isMintlessClaimed,\r\n    mintlessTokenBalance,\r\n    customPayload,\r\n    stateInit,\r\n  };\r\n}\r\n\r\nexport async function checkMintlessTokenWalletIsClaimed(network: ApiNetwork, tokenWalletAddress: string) {\r\n  const res = await getTonClient(network)\r\n    .runMethod(Address.parse(tokenWalletAddress), 'is_claimed');\r\n  return res.stack.readBoolean();\r\n}\r\n\r\nasync function fetchMintlessTokenWalletData(customPayloadApiUrl: string, address: string) {\r\n  const rawAddress = toRawAddress(address);\r\n\r\n  return (await fetchJsonWithProxy(`${customPayloadApiUrl}/wallet/${rawAddress}`).catch(() => undefined)) as {\r\n    custom_payload: string;\r\n    state_init: string;\r\n    compressed_info: {\r\n      amount: string;\r\n      start_from: string;\r\n      expired_at: string;\r\n    };\r\n  } | undefined;\r\n}\r\n\r\nexport async function fetchToken(network: ApiNetwork, address: string) {\r\n  const metadata = await fetchJettonMetadata(network, address);\r\n\r\n  return buildTokenByMetadata(address, metadata);\r\n}\r\n\r\nfunction buildTokenByMetadata(address: string, metadata: JettonMetadata): ApiToken {\r\n  const {\r\n    name,\r\n    symbol,\r\n    image,\r\n    image_data: imageData,\r\n    decimals,\r\n    custom_payload_api_uri: customPayloadApiUrl,\r\n  } = metadata;\r\n\r\n  return {\r\n    slug: buildTokenSlug('ton', address),\r\n    name,\r\n    symbol,\r\n    decimals: decimals === undefined ? DEFAULT_DECIMALS : Number(decimals),\r\n    chain: 'ton',\r\n    tokenAddress: address,\r\n    image: (image && fixIpfsUrl(image)) || (imageData && fixBase64ImageData(imageData)) || undefined,\r\n    customPayloadApiUrl,\r\n  };\r\n}\r\n\r\n/**\r\n * A pure function guessing the \"fee\" that needs to be attached to the token transfer.\r\n * In contrast to the blockchain fee, this fee is a part of the transfer itself.\r\n *\r\n * `amount` is what should be attached (acts as a fee for the user);\r\n * `realAmount` is approximately what will be actually spent (the rest will return in the excess).\r\n */\r\nexport function getToncoinAmountForTransfer(token: ApiToken, willClaimMintless: boolean) {\r\n  let amount = 0n;\r\n  let realAmount = 0n;\r\n\r\n  if (token.slug === TON_USDT_MAINNET_SLUG || token.slug === TON_USDT_TESTNET_SLUG) {\r\n    amount += TINY_TOKEN_TRANSFER_AMOUNT;\r\n    realAmount += TINIEST_TOKEN_TRANSFER_REAL_AMOUNT;\r\n  } else if (token.isTiny) {\r\n    amount += TINY_TOKEN_TRANSFER_AMOUNT;\r\n    realAmount += TINY_TOKEN_TRANSFER_REAL_AMOUNT;\r\n  } else {\r\n    amount += TOKEN_TRANSFER_AMOUNT;\r\n    realAmount += TOKEN_TRANSFER_REAL_AMOUNT;\r\n  }\r\n\r\n  if (willClaimMintless) {\r\n    amount += CLAIM_MINTLESS_AMOUNT;\r\n    realAmount += CLAIM_MINTLESS_AMOUNT;\r\n  }\r\n\r\n  return { amount, realAmount };\r\n}\r\n\r\nexport async function importToken(network: ApiNetwork, address: string, sendUpdateTokens: NoneToVoidFunction) {\r\n  const rawToken = await fetchToken(network, address);\r\n  const token: ApiTokenWithPrice = {\r\n    ...rawToken,\r\n    priceUsd: 0,\r\n    percentChange24h: 0,\r\n  };\r\n  await updateTokens([token], sendUpdateTokens);\r\n  await updateTokenHashes(network, [token.slug], sendUpdateTokens);\r\n}\r\n\r\nexport async function loadTokenBalances(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  sendUpdateTokens: NoneToVoidFunction,\r\n): Promise<ApiBalanceBySlug> {\r\n  const tokenBalances = await getTokenBalances(network, address);\r\n  const tokens: ApiTokenWithPrice[] = tokenBalances.map(({ token }) => ({\r\n    ...token,\r\n    priceUsd: 0,\r\n    percentChange24h: 0,\r\n  }));\r\n  await updateTokens(tokens, sendUpdateTokens);\r\n  await updateTokenHashes(network, tokens.map((token) => token.slug), sendUpdateTokens);\r\n\r\n  return Object.fromEntries(tokenBalances.map(({ slug, balance }) => [slug, balance]));\r\n}\r\n","import type { createTaskQueue } from '../../../util/schedulers';\r\nimport type { FallbackPollingOptions } from '../../common/polling/fallbackPollingScheduler';\r\nimport type { ApiBalanceBySlug, ApiNetwork } from '../../types';\r\nimport type { BalanceUpdateCallback, WalletWatcher } from './toncenter/socket';\r\n\r\nimport { TONCOIN } from '../../../config';\r\nimport { areDeepEqual } from '../../../util/areDeepEqual';\r\nimport { createCallbackManager } from '../../../util/callbacks';\r\nimport Deferred from '../../../util/Deferred';\r\nimport { pick } from '../../../util/iteratees';\r\nimport { throttle } from '../../../util/schedulers';\r\nimport withCacheAsync from '../../../util/withCacheAsync';\r\nimport { FallbackPollingScheduler } from '../../common/polling/fallbackPollingScheduler';\r\nimport { buildTokenSlug, getTokenByAddress, tokensPreload } from '../../common/tokens';\r\nimport { getToncenterSocket } from './toncenter/socket';\r\nimport { importToken, loadTokenBalances } from './tokens';\r\nimport { getWalletInfo } from './wallet';\r\n\r\nexport type OnBalancesUpdate = (balances: ApiBalanceBySlug) => void;\r\nexport type OnLoadingChange = (isLoading: boolean) => void;\r\n\r\ntype OnSocketBalancesUpdate = (balances: BalanceByTokenAddress) => void;\r\ntype BalanceByTokenAddress = Record<string, bigint>;\r\n\r\nconst TON_VIRTUAL_ADDRESS = '@TON'; // An arbitrary string for representing TON balance inside this file only\r\nconst SOCKET_THROTTLE_DELAY = 100;\r\n\r\n/**\r\n * Watches the TON and token balances of the given TON wallet.\r\n * Uses the socket, and fallbacks to HTTP polling when the socket is unavailable.\r\n */\r\nexport class BalanceStream {\r\n  #network: ApiNetwork;\r\n  #address: string;\r\n  #sendUpdateTokens: NoneToVoidFunction;\r\n  #loadingConcurrencyLimiter?: ReturnType<typeof createTaskQueue>;\r\n\r\n  /** Contains all the address balances. `undefined` until the all the balances are loaded. */\r\n  #balances?: ApiBalanceBySlug;\r\n  #balancesDeferred = new Deferred();\r\n\r\n  #walletWatcher: WalletWatcher;\r\n  #fallbackPollingScheduler: FallbackPollingScheduler;\r\n\r\n  #updateListeners = createCallbackManager<OnBalancesUpdate>();\r\n  #loadingListeners = createCallbackManager<OnLoadingChange>();\r\n\r\n  #isDestroyed = false;\r\n\r\n  constructor(\r\n    network: ApiNetwork,\r\n    address: string,\r\n    sendUpdateTokens: NoneToVoidFunction,\r\n    fallbackPollingOptions: FallbackPollingOptions,\r\n    /** To prevent too many simultaneous HTTP requests for inactive accounts */\r\n    loadingConcurrencyLimiter?: ReturnType<typeof createTaskQueue>,\r\n  ) {\r\n    this.#network = network;\r\n    this.#address = address;\r\n    this.#sendUpdateTokens = sendUpdateTokens;\r\n    this.#loadingConcurrencyLimiter = loadingConcurrencyLimiter;\r\n\r\n    this.#walletWatcher = getToncenterSocket(network).watchWallets(\r\n      [address],\r\n      {\r\n        onConnect: this.#handleSocketConnect,\r\n        onDisconnect: this.#handleSocketDisconnect,\r\n        onBalanceUpdate: throttleSocketBalanceUpdates(this.#handleSocketBalanceUpdate),\r\n      },\r\n    );\r\n\r\n    this.#fallbackPollingScheduler = new FallbackPollingScheduler(\r\n      this.#poll,\r\n      this.#walletWatcher.isConnected,\r\n      fallbackPollingOptions,\r\n    );\r\n  }\r\n\r\n  public async getBalances() {\r\n    await this.#balancesDeferred.promise;\r\n    if (!this.#balances) {\r\n      throw new Error('Unexpected missing balances');\r\n    }\r\n    return this.#balances;\r\n  }\r\n\r\n  /**\r\n   * Registers a callback firing then the balances change.\r\n   * The callback calls are throttled.\r\n   */\r\n  public onUpdate(callback: OnBalancesUpdate) {\r\n    return this.#updateListeners.addCallback(callback);\r\n  }\r\n\r\n  /**\r\n   * Registers a callback firing when the regular polling starts of finishes.\r\n   * Guaranteed to be called with `isLoading=false` after calling the `onUpdate` callbacks.\r\n   */\r\n  public onLoadingChange(callback: OnLoadingChange) {\r\n    return this.#loadingListeners.addCallback(callback);\r\n  }\r\n\r\n  public destroy() {\r\n    this.#isDestroyed = true;\r\n    this.#walletWatcher.destroy();\r\n    this.#fallbackPollingScheduler.destroy();\r\n  }\r\n\r\n  #handleSocketConnect = () => {\r\n    this.#fallbackPollingScheduler.onSocketConnect();\r\n  };\r\n\r\n  #handleSocketDisconnect = () => {\r\n    this.#fallbackPollingScheduler.onSocketDisconnect();\r\n  };\r\n\r\n  #handleSocketBalanceUpdate: OnSocketBalancesUpdate = async (newBalances) => {\r\n    if (this.#isDestroyed) return;\r\n    this.#fallbackPollingScheduler.onSocketMessage();\r\n\r\n    // `this.#balances` must contain all the balances, so we ignore partial updates until we load all the balances\r\n    if (!this.#balances) return;\r\n\r\n    const tokenAddresses = await splitKnownAndUnknownTokens(newBalances);\r\n    this.#setBalancesPartially(pick(newBalances, tokenAddresses.known));\r\n\r\n    await importUnknownTokens(this.#network, tokenAddresses.unknown, this.#sendUpdateTokens);\r\n    if (this.#isDestroyed) return;\r\n    this.#setBalancesPartially(pick(newBalances, tokenAddresses.unknown));\r\n  };\r\n\r\n  /** Fetches all balances when the socket is not connected or has just connected */\r\n  #poll = async () => {\r\n    try {\r\n      this.#loadingListeners.runCallbacks(true);\r\n\r\n      const throttledFetchBalances = this.#loadingConcurrencyLimiter?.wrap(fetchBalances) ?? fetchBalances;\r\n      const newBalances = await throttledFetchBalances(this.#network, this.#address, this.#sendUpdateTokens);\r\n      if (this.#isDestroyed) return;\r\n\r\n      this.#setAllBalances(newBalances);\r\n      this.#balancesDeferred.resolve();\r\n    } finally {\r\n      if (!this.#isDestroyed) {\r\n        this.#loadingListeners.runCallbacks(false);\r\n      }\r\n    }\r\n  };\r\n\r\n  #setAllBalances(newBalances: ApiBalanceBySlug) {\r\n    if (!areDeepEqual(this.#balances, newBalances)) {\r\n      this.#balances = newBalances;\r\n      this.#updateListeners.runCallbacks(this.#balances);\r\n    }\r\n  }\r\n\r\n  #setBalancesPartially(newBalances: BalanceByTokenAddress) {\r\n    const newBySlug = balanceByTokeyAddressToBySlug(newBalances);\r\n    const hasChanged = !this.#balances || !areDeepEqual(pick(this.#balances, Object.keys(newBySlug)), newBySlug);\r\n\r\n    if (hasChanged) {\r\n      this.#balances = {\r\n        ...this.#balances,\r\n        ...newBySlug,\r\n      };\r\n      this.#updateListeners.runCallbacks(this.#balances);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * When an incoming token transfer arrives, the socket triggers both TON and token balance updates in a quick succession.\r\n * To avoid excessive UI updates, we throttle the balance updates.\r\n */\r\nfunction throttleSocketBalanceUpdates(onUpdate: OnSocketBalancesUpdate): BalanceUpdateCallback {\r\n  let pendingUpdates: BalanceByTokenAddress = {};\r\n\r\n  const notifyThrottled = throttle(() => {\r\n    const updates = pendingUpdates;\r\n    pendingUpdates = {};\r\n    onUpdate(updates);\r\n  }, SOCKET_THROTTLE_DELAY, false);\r\n\r\n  return ({ tokenAddress, balance }) => {\r\n    pendingUpdates[tokenAddress ?? TON_VIRTUAL_ADDRESS] = balance;\r\n    notifyThrottled();\r\n  };\r\n}\r\n\r\nasync function splitKnownAndUnknownTokens(balances: BalanceByTokenAddress) {\r\n  await tokensPreload.promise;\r\n\r\n  const known: string[] = [];\r\n  const unknown: string[] = [];\r\n\r\n  for (const tokenAddress of Object.keys(balances)) {\r\n    if (tokenAddress === TON_VIRTUAL_ADDRESS || getTokenByAddress(tokenAddress)) {\r\n      known.push(tokenAddress);\r\n    } else {\r\n      unknown.push(tokenAddress);\r\n    }\r\n  }\r\n\r\n  return { known, unknown };\r\n}\r\n\r\nasync function fetchBalances(network: ApiNetwork, address: string, sendUpdateTokens: NoneToVoidFunction) {\r\n  const [{ balance: tonBalance }, tokenBalances] = await Promise.all([\r\n    getWalletInfo(network, address),\r\n    loadTokenBalances(network, address, sendUpdateTokens),\r\n  ]);\r\n\r\n  return {\r\n    [TONCOIN.slug]: tonBalance,\r\n    ...tokenBalances,\r\n  };\r\n}\r\n\r\nfunction importUnknownTokens(network: ApiNetwork, tokenAddresses: string[], sendUpdateTokens: NoneToVoidFunction) {\r\n  return Promise.all(tokenAddresses.map(\r\n    (tokenAddress) => importUnknownToken(network, tokenAddress, sendUpdateTokens),\r\n  ));\r\n}\r\n\r\n// Using `withCacheAsync` mainly to prevent concurrent execution\r\nconst importUnknownToken = withCacheAsync(importToken);\r\n\r\nfunction balanceByTokeyAddressToBySlug(byAddress: BalanceByTokenAddress) {\r\n  const bySlug: ApiBalanceBySlug = {};\r\n\r\n  for (const [tokenAddress, balance] of Object.entries(byAddress)) {\r\n    const slug = tokenAddress === TON_VIRTUAL_ADDRESS ? TONCOIN.slug : buildTokenSlug('ton', tokenAddress);\r\n    bySlug[slug] = balance;\r\n  }\r\n\r\n  return bySlug;\r\n}\r\n","import type {\r\n  ApiAccountWithChain,\r\n  ApiNftTransferPayload,\r\n  ApiParsedPayload,\r\n  ApiTokensTransferNonStandardPayload,\r\n  ApiTokensTransferPayload,\r\n} from '../../api/types';\r\n\r\nimport { DEFAULT_MAX_MESSAGES, LEDGER_MAX_MESSAGES, W5_MAX_MESSAGES } from '../../api/chains/ton/constants';\r\n\r\nexport function isNftTransferPayload(payload: ApiParsedPayload | undefined): payload is ApiNftTransferPayload {\r\n  return payload?.type === 'nft:transfer';\r\n}\r\n\r\nexport function isTokenTransferPayload(\r\n  payload: ApiParsedPayload | undefined,\r\n): payload is ApiTokensTransferPayload | ApiTokensTransferNonStandardPayload {\r\n  return payload?.type === 'tokens:transfer' || payload?.type === 'tokens:transfer-non-standard';\r\n}\r\n\r\n/** How many messages can be sent in a single transaction */\r\nexport function getMaxMessagesInTransaction(account: ApiAccountWithChain<'ton'>) {\r\n  const { type, byChain: { ton: { version } } } = account;\r\n\r\n  if (type === 'ledger') {\r\n    return LEDGER_MAX_MESSAGES;\r\n  } else if (version === 'W5') {\r\n    return W5_MAX_MESSAGES;\r\n  } else {\r\n    return DEFAULT_MAX_MESSAGES;\r\n  }\r\n}\r\n","import type { ApiCheckTransactionDraftResult, ApiFetchEstimateDieselResult } from '../../api/chains/ton/types';\r\nimport type { FeePrecision, FeeTerms } from './types';\r\n\r\nimport { TONCOIN } from '../../config';\r\nimport { Big } from '../../lib/big.js';\r\nimport { bigintMax, bigintMin } from '../bigint';\r\nimport { getIsNativeToken } from '../tokens';\r\n\r\ntype ApiFee = Pick<ApiCheckTransactionDraftResult, 'fee' | 'realFee' | 'diesel'> & {\r\n  /** The slug of the token that is being transferred */\r\n  tokenSlug: string;\r\n};\r\n\r\nexport type ExplainedTransferFee = {\r\n  /** Whether the result implies paying the fee with a diesel */\r\n  isGasless: boolean;\r\n  /**\r\n   * The fee that will be sent with the transfer. The wallet must have it on the balance to send the transfer.\r\n   * Show this in the transfer form when the input amount is  the balance, but the remaining balance can't cover the\r\n   * full fee; show `realFee` otherwise. Undefined means that it's unknown.\r\n   */\r\n  fullFee?: {\r\n    precision: FeePrecision;\r\n    terms: FeeTerms<bigint>;\r\n    /** The sum of `terms` measured in the native token */\r\n    nativeSum: bigint;\r\n  };\r\n  /**\r\n   * The real fee (the full fee minus the excess). Undefined means that it's unknown. There is no need to fall back to\r\n   * `fullFee` when `realFee` is undefined (because it's undefined too in this case).\r\n   */\r\n  realFee?: {\r\n    precision: FeePrecision;\r\n    terms: FeeTerms<bigint>;\r\n    /** The sum of `terms` measured in the native token */\r\n    nativeSum: bigint;\r\n  };\r\n  /** The excess fee. Measured in the native token. It's always approximate. Undefined means that it's unknown. */\r\n  excessFee?: bigint;\r\n  /**\r\n   * Whether the full token balance can be transferred despite the fee.\r\n   * If yes, the fee will be taken from the transferred amount.\r\n   */\r\n  canTransferFullBalance: boolean;\r\n};\r\n\r\ntype AvailableDiesel = ApiFetchEstimateDieselResult & { amount: bigint };\r\ntype ApiFeeWithDiesel = ApiFee & { diesel: AvailableDiesel };\r\n\r\ntype MaxTransferAmountInput = {\r\n  /** The wallet balance of the transferred token. Undefined means that it's unknown. */\r\n  tokenBalance: bigint | undefined;\r\n  /** The slug of the token that is being transferred */\r\n  tokenSlug: string;\r\n  /** The full fee terms calculated by `explainApiTransferFee`. Undefined means that they're unknown. */\r\n  fullFee: FeeTerms<bigint> | undefined;\r\n  /** Whether the full token balance can be transferred despite the fee. */\r\n  canTransferFullBalance: boolean;\r\n};\r\n\r\ntype BalanceSufficientForTransferInput = Omit<MaxTransferAmountInput, 'tokenSlug'> & {\r\n  /** The wallet balance of the native token of the transfer chain. Undefined means that it's unknown. */\r\n  nativeTokenBalance: bigint | undefined;\r\n  /** The transferred amount. Use 0 for NFT transfers. Undefined means that it's unspecified. */\r\n  transferAmount: bigint | undefined;\r\n};\r\n\r\n/**\r\n * Converts the transfer fee data returned from API into data that is ready to be displayed in the transfer form UI.\r\n */\r\nexport function explainApiTransferFee(input: ApiFee): ExplainedTransferFee {\r\n  return shouldUseDiesel(input)\r\n    ? explainGaslessTransferFee(input)\r\n    : explainGasfullTransferFee(input);\r\n}\r\n\r\n/**\r\n * Calculates the maximum amount available for the transfer.\r\n * Returns undefined when it can't be calculated because of insufficient input data.\r\n */\r\nexport function getMaxTransferAmount({\r\n  tokenBalance,\r\n  tokenSlug,\r\n  fullFee,\r\n  canTransferFullBalance,\r\n}: MaxTransferAmountInput): bigint | undefined {\r\n  if (tokenBalance === undefined) {\r\n    return undefined;\r\n  }\r\n\r\n  // Returning the full balance when the fee is unknown for a better UX\r\n  if (canTransferFullBalance || !fullFee) {\r\n    return tokenBalance;\r\n  }\r\n\r\n  let fee = fullFee.token ?? 0n;\r\n  if (getIsNativeToken(tokenSlug)) {\r\n    // When the token is native, both `token` and `native` refer to the same currency, so they should be added\r\n    fee += fullFee.native ?? 0n;\r\n  }\r\n\r\n  return bigintMax(tokenBalance - fee, 0n);\r\n}\r\n\r\n/**\r\n * Decides whether the balance is sufficient to transfer the amount and pay the fees.\r\n * Returns undefined when it can't be calculated because of insufficient input data.\r\n */\r\nexport function isBalanceSufficientForTransfer({\r\n  tokenBalance,\r\n  nativeTokenBalance,\r\n  transferAmount,\r\n  fullFee,\r\n  canTransferFullBalance,\r\n}: BalanceSufficientForTransferInput) {\r\n  if (transferAmount === undefined || tokenBalance === undefined || nativeTokenBalance === undefined || !fullFee) {\r\n    return undefined;\r\n  }\r\n\r\n  const isFullTokenTransfer = transferAmount === tokenBalance && canTransferFullBalance;\r\n  const tokenRequiredAmount = (fullFee.token ?? 0n) + (isFullTokenTransfer ? 0n : transferAmount);\r\n  const nativeTokenRequiredAmount = fullFee.native ?? 0n;\r\n\r\n  return tokenRequiredAmount <= tokenBalance && nativeTokenRequiredAmount <= nativeTokenBalance;\r\n}\r\n\r\nexport function isDieselAvailable(diesel: ApiFetchEstimateDieselResult): diesel is AvailableDiesel {\r\n  return diesel.status !== 'not-available' && diesel.amount !== undefined;\r\n}\r\n\r\nexport function getDieselTokenAmount(diesel: ApiFetchEstimateDieselResult) {\r\n  return diesel.status === 'stars-fee' ? 0n : (diesel.amount ?? 0n);\r\n}\r\n\r\nfunction shouldUseDiesel(input: ApiFee): input is ApiFeeWithDiesel {\r\n  return input.diesel !== undefined && isDieselAvailable(input.diesel);\r\n}\r\n\r\n/**\r\n * Converts the data of a transfer not involving diesel\r\n */\r\nfunction explainGasfullTransferFee(input: ApiFee) {\r\n  const result: ExplainedTransferFee = {\r\n    isGasless: false,\r\n    canTransferFullBalance: input.tokenSlug === TONCOIN.slug,\r\n  };\r\n\r\n  if (input.fee !== undefined) {\r\n    result.fullFee = {\r\n      precision: input.realFee === input.fee ? 'exact' : 'lessThan',\r\n      terms: { native: input.fee },\r\n      nativeSum: input.fee,\r\n    };\r\n    result.realFee = result.fullFee;\r\n  }\r\n\r\n  if (input.realFee !== undefined) {\r\n    result.realFee = {\r\n      precision: input.realFee === input.fee ? 'exact' : 'approximate',\r\n      terms: { native: input.realFee },\r\n      nativeSum: input.realFee,\r\n    };\r\n  }\r\n\r\n  if (input.fee !== undefined && input.realFee !== undefined) {\r\n    result.excessFee = input.fee - input.realFee;\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Converts the diesel of semi-diesel transfer data\r\n */\r\nfunction explainGaslessTransferFee({ diesel }: ApiFeeWithDiesel) {\r\n  const isStarsDiesel = diesel.status === 'stars-fee';\r\n  const dieselKey = isStarsDiesel ? 'stars' : 'token';\r\n  const realFeeInDiesel = convertFee(diesel.realFee, diesel.nativeAmount, diesel.amount);\r\n  // Cover as much displayed real fee as possible with diesel, because in the excess it will return as the native token.\r\n  const dieselRealFee = bigintMin(diesel.amount, realFeeInDiesel);\r\n  // Cover the remaining real fee with the native token.\r\n  const nativeRealFee = bigintMax(0n, diesel.realFee - diesel.nativeAmount);\r\n\r\n  return {\r\n    isGasless: true,\r\n    canTransferFullBalance: false,\r\n    fullFee: {\r\n      precision: 'lessThan',\r\n      terms: {\r\n        [dieselKey]: diesel.amount,\r\n        native: diesel.remainingFee,\r\n      },\r\n      nativeSum: diesel.nativeAmount + diesel.remainingFee,\r\n    },\r\n    realFee: {\r\n      precision: 'approximate',\r\n      terms: {\r\n        [dieselKey]: dieselRealFee,\r\n        native: nativeRealFee,\r\n      },\r\n      nativeSum: diesel.realFee,\r\n    },\r\n    excessFee: diesel.nativeAmount + diesel.remainingFee - diesel.realFee,\r\n  } satisfies ExplainedTransferFee;\r\n}\r\n\r\n/**\r\n * `exampleFromAmount` and `exampleToAmount` define the exchange rate used to convert `amount`.\r\n * `exampleFromAmount` is defined in the same currency as `amount`. Mustn't be 0.\r\n * `exampleToAmount` is defined in the currency you want to get.\r\n */\r\nfunction convertFee(\r\n  amount: bigint,\r\n  exampleFromAmount: bigint,\r\n  exampleToAmount: bigint,\r\n) {\r\n  const exchangeRate = Big(exampleToAmount.toString()).div(exampleFromAmount.toString());\r\n  return BigInt(Big(amount.toString()).mul(exchangeRate).round().toString());\r\n}\r\n","import { callBackendPost } from '../../../common/backend';\r\n\r\nconst DIESEL_URL = '/diesel';\r\n\r\nexport function dieselSendBoc(boc: string) {\r\n  return callBackendPost<{ result: string; paymentLink?: string }>(\r\n    `${DIESEL_URL}/sendBoc`, { boc, isAddition: true }, { shouldRetry: true },\r\n  );\r\n}\r\n","import { callBackendPost } from '../../../common/backend';\r\n\r\nconst DIESEL_URL = '/diesel';\r\n\r\nexport function dieselW5SendRequest(boc: string) {\r\n  return callBackendPost<{ result: string; paymentLink?: string }>(\r\n    `${DIESEL_URL}/w5/sendBoc`, { boc, isAddition: true }, { shouldRetry: true },\r\n  );\r\n}\r\n","import type { Cell, Message } from '@ton/core';\r\nimport { beginCell, external, storeMessage } from '@ton/core';\r\n\r\nimport type { GaslessType } from '../transfer';\r\nimport type { TonClient } from './TonClient';\r\nimport type { TonWallet } from './tonCore';\r\n\r\nimport { dieselSendBoc } from './diesel';\r\nimport { dieselW5SendRequest } from './w5diesel';\r\n\r\nexport async function sendExternal(\r\n  client: TonClient,\r\n  wallet: TonWallet,\r\n  message: Cell,\r\n  gaslessType?: GaslessType,\r\n) {\r\n  const {\r\n    address,\r\n    init,\r\n  } = wallet;\r\n\r\n  let neededInit: { data: Cell; code: Cell } | undefined;\r\n  if (init && !await client.isContractDeployed(address)) {\r\n    neededInit = init;\r\n  }\r\n\r\n  const ext = external({\r\n    to: address,\r\n    init: neededInit ? {\r\n      code: neededInit.code,\r\n      data: neededInit.data,\r\n    } : undefined,\r\n    body: message,\r\n  });\r\n\r\n  const cell = beginCell()\r\n    .store(storeMessage(ext))\r\n    .endCell();\r\n\r\n  const isW5Gasless = gaslessType === 'w5';\r\n\r\n  const msgHash = cell.hash().toString('base64');\r\n  const msgHashNormalized = getExternalMsgHashNormalized(ext);\r\n  const bodyMessageHash = message.hash().toString('base64');\r\n  const boc = cell.toBoc().toString('base64');\r\n\r\n  let paymentLink;\r\n  if (isW5Gasless) {\r\n    const result = await dieselW5SendRequest(boc);\r\n    paymentLink = result.paymentLink;\r\n  } else if (gaslessType === 'diesel') {\r\n    const result = await dieselSendBoc(boc);\r\n    paymentLink = result.paymentLink;\r\n  } else {\r\n    await client.sendFile(boc);\r\n  }\r\n\r\n  return {\r\n    boc,\r\n    msgHash: isW5Gasless ? bodyMessageHash : msgHash,\r\n    msgHashNormalized,\r\n    paymentLink,\r\n  };\r\n}\r\n\r\nfunction getExternalMsgHashNormalized(message: Message): string {\r\n  const cell = beginCell()\r\n    .storeUint(2, 2) // Message type: external-in\r\n    .storeUint(0, 2) // No sender address for external messages\r\n    .storeAddress(message.info.dest) // Store recipient address\r\n    .storeUint(0, 4) // Import fee is always zero for external messages\r\n    .storeBit(false) // No StateInit in this message\r\n    .storeBit(true) // Store the body as a reference\r\n    .storeRef(message.body) // Store the message body\r\n    .endCell();\r\n\r\n  return cell.hash().toString('base64');\r\n}\r\n","import type { ApiNetwork } from '../types';\r\n\r\nimport Deferred from '../../util/Deferred';\r\nimport { handleError } from '../../util/handleError';\r\nimport { createTaskQueue } from '../../util/schedulers';\r\n\r\ntype Task<T> = (finalizeInBackground: FinalizeInBackground) => MaybePromise<T>;\r\n\r\ntype FinalizeInBackground = (backgroundTask: () => Promise<void>) => void;\r\n\r\nconst queues: Record<string, ReturnType<typeof createTaskQueue>> = {};\r\n\r\n/**\r\n * Prevents concurrency when sending multiple transfers. Preventing concurrency is necessary in TON, because every\r\n * transaction must have a unique sequential `seqno` that matched the one in the wallet data exactly.\r\n *\r\n * `task` is the function performing actions that should not run concurrently. It runs in 3 stages:\r\n *  - foreground  ends when `task` returns. The promise returned by `withoutTransferConcurrency` is settled the\r\n *    same moment with the same result;\r\n *  - background  ends when all the tasks, provided to the `finalizeInBackground` callback, finish.\r\n *\r\n * Before `task` is executed, the function waits for both stages of all the previous tasks for the same `network` and\r\n * `fromAddress` to complete.\r\n */\r\nexport function withoutTransferConcurrency<T>(network: ApiNetwork, fromAddress: string, task: Task<T>): Promise<T> {\r\n  const queueKey = `${network} ${fromAddress}`;\r\n  const foregroundDeferred = new Deferred<T>();\r\n  const backgroundPromises: Promise<void>[] = [];\r\n\r\n  const finalizeInBackground: FinalizeInBackground = (backgroundTask) => {\r\n    backgroundPromises.push(backgroundTask().catch(handleError));\r\n  };\r\n\r\n  queues[queueKey] ??= createTaskQueue(1);\r\n\r\n  void queues[queueKey].run(async () => {\r\n    try {\r\n      foregroundDeferred.resolve(await task(finalizeInBackground));\r\n    } catch (err) {\r\n      foregroundDeferred.reject(err);\r\n    }\r\n\r\n    await Promise.all(backgroundPromises);\r\n  });\r\n\r\n  return foregroundDeferred.promise;\r\n}\r\n","import type { Cell } from '@ton/core';\r\nimport { beginCell, external, storeMessage } from '@ton/core';\r\n\r\nimport type {\r\n  ApiActivity,\r\n  ApiEmulationResult,\r\n  ApiNetwork,\r\n  ApiNftSuperCollection,\r\n  ApiTransactionActivity,\r\n} from '../../types';\r\nimport type { EmulationResponse } from './toncenter/emulation';\r\nimport type { TonWallet } from './util/tonCore';\r\n\r\nimport { BURN_ADDRESS, TONCOIN } from '../../../config';\r\nimport { logDebugError } from '../../../util/logs';\r\nimport { toBase64Address } from './util/tonCore';\r\nimport { getNftSuperCollectionsByCollectionAddress } from '../../common/addresses';\r\nimport { FAKE_TX_ID } from '../../constants';\r\nimport { fetchEmulateTrace } from './toncenter/emulation';\r\nimport { calculateActivityDetails, getActivityRealFee } from './activities';\r\nimport { parseActions } from './toncenter';\r\nimport { parseTrace } from './traces';\r\n\r\nexport async function emulateTransaction(\r\n  network: ApiNetwork,\r\n  wallet: TonWallet,\r\n  transaction: Cell,\r\n  isInitialized?: boolean,\r\n) {\r\n  const boc = buildExternalBoc(wallet, transaction, isInitialized);\r\n  const emulation = await fetchEmulateTrace(network, boc);\r\n  const walletAddress = toBase64Address(wallet.address, false, network);\r\n  const nftSuperCollectionsByCollectionAddress = await getNftSuperCollectionsByCollectionAddress();\r\n  return parseEmulation(network, walletAddress, emulation, nftSuperCollectionsByCollectionAddress);\r\n}\r\n\r\nexport function parseEmulation(\r\n  network: ApiNetwork,\r\n  walletAddress: string,\r\n  emulation: EmulationResponse,\r\n  nftSuperCollectionsByCollectionAddress: Record<string, ApiNftSuperCollection>,\r\n): ApiEmulationResult {\r\n  const parsedTrace = parseTrace({\r\n    network,\r\n    walletAddress,\r\n    actions: emulation.actions,\r\n    traceDetail: emulation.trace,\r\n    addressBook: emulation.address_book,\r\n    transactions: emulation.transactions,\r\n  });\r\n\r\n  const allActivities = parseActions(\r\n    network,\r\n    walletAddress,\r\n    emulation.actions,\r\n    emulation.address_book,\r\n    emulation.metadata,\r\n    nftSuperCollectionsByCollectionAddress,\r\n  );\r\n\r\n  const walletActivities: ApiActivity[] = [];\r\n  let totalRealFee = 0n;\r\n  let totalExcess = 0n;\r\n\r\n  for (let activity of allActivities) {\r\n    if (\r\n      activity.shouldHide || (\r\n        activity.kind === 'transaction'\r\n        && activity.fromAddress !== walletAddress\r\n        && activity.toAddress !== walletAddress\r\n      )) {\r\n      continue;\r\n    }\r\n\r\n    if (activity.shouldLoadDetails) {\r\n      const result = calculateActivityDetails(activity, parsedTrace, true);\r\n      if (result) {\r\n        activity = result.activity;\r\n        totalExcess += result.excess;\r\n      } else {\r\n        logDebugError('Unparsable trace for emulated activity', activity.id);\r\n      }\r\n    }\r\n\r\n    walletActivities.push(activity);\r\n    totalRealFee += getActivityRealFee(activity);\r\n  }\r\n\r\n  if (totalExcess) {\r\n    addExcessActivity(walletAddress, walletActivities, totalExcess);\r\n  }\r\n\r\n  return {\r\n    networkFee: parsedTrace.totalNetworkFee,\r\n    received: parsedTrace.totalReceived,\r\n    byTransactionIndex: parsedTrace.byTransactionIndex,\r\n    activities: walletActivities,\r\n    realFee: totalRealFee,\r\n  };\r\n}\r\n\r\nfunction addExcessActivity(walletAddress: string, activities: ApiActivity[], excess: bigint) {\r\n  const index = activities.findIndex((activity) => {\r\n    return activity.kind === 'transaction' && activity.type === 'excess';\r\n  });\r\n\r\n  if (index !== -1) {\r\n    const excessActivity = activities.splice(index, 1)[0] as ApiTransactionActivity;\r\n    activities.push({\r\n      ...excessActivity,\r\n      amount: excessActivity.amount + excess,\r\n    });\r\n  } else {\r\n    activities.push({\r\n      id: FAKE_TX_ID,\r\n      timestamp: activities[activities.length - 1].timestamp,\r\n      kind: 'transaction',\r\n      amount: excess,\r\n      slug: TONCOIN.slug,\r\n      normalizedAddress: BURN_ADDRESS,\r\n      fromAddress: BURN_ADDRESS,\r\n      toAddress: walletAddress,\r\n      isIncoming: true,\r\n      fee: 0n,\r\n      type: 'excess',\r\n      status: 'completed',\r\n    });\r\n  }\r\n}\r\n\r\nfunction buildExternalBoc(wallet: TonWallet, body: Cell, isInitialized?: boolean) {\r\n  const externalMessage = external({\r\n    to: wallet.address,\r\n    init: !isInitialized ? {\r\n      code: wallet.init.code,\r\n      data: wallet.init.data,\r\n    } : undefined,\r\n    body,\r\n  });\r\n\r\n  return beginCell()\r\n    .store(storeMessage(externalMessage))\r\n    .endCell()\r\n    .toBoc()\r\n    .toString('base64');\r\n}\r\n","import type { ApiNetwork } from '../../../types';\r\nimport type { AccountState, AddressBook, AnyAction, MetadataMap, TraceDetail, Transaction } from './types';\r\n\r\nimport { fetchWithRetry } from '../../../../util/fetch';\r\nimport { NETWORK_CONFIG } from '../constants';\r\nimport { getToncenterHeaders } from './other';\r\n\r\nexport type EmulationResponse = {\r\n  mc_block_seqno: number;\r\n  trace: TraceDetail;\r\n  actions: AnyAction[];\r\n  transactions: Record<string, Transaction>;\r\n  account_states: Record<string, AccountState>;\r\n  rand_seed: string;\r\n  metadata: MetadataMap;\r\n  address_book: AddressBook;\r\n};\r\n\r\nexport async function fetchEmulateTrace(network: ApiNetwork, boc: string): Promise<EmulationResponse> {\r\n  const baseUrl = NETWORK_CONFIG[network].toncenterUrl;\r\n\r\n  const response = await fetchWithRetry(`${baseUrl}/api/emulate/v1/emulateTrace`, {\r\n    method: 'POST',\r\n    headers: {\r\n      ...getToncenterHeaders(network),\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify({\r\n      boc,\r\n      ignore_chksig: true,\r\n      include_code_data: false,\r\n      with_actions: true,\r\n      include_address_book: true,\r\n      include_metadata: true,\r\n    }),\r\n  });\r\n\r\n  return response.json();\r\n}\r\n","// src/api/chains/ton/transfer.ts\r\nimport { Cell, internal, SendMode } from '@ton/core';\r\n\r\nimport type { DieselStatus } from '../../../global/types';\r\nimport type { CheckTransactionDraftOptions } from '../../methods/types';\r\nimport type {\r\n  ApiAccountWithChain,\r\n  ApiAnyDisplayError,\r\n  ApiNetwork,\r\n  ApiParsedPayload,\r\n  ApiSignedTransfer,\r\n  ApiToken,\r\n} from '../../types';\r\nimport type {\r\n  AnyPayload,\r\n  ApiCheckMultiTransactionDraftResult,\r\n  ApiCheckTransactionDraftResult,\r\n  ApiEmulationWithFallbackResult,\r\n  ApiFetchEstimateDieselResult,\r\n  ApiSubmitMultiTransferResult,\r\n  ApiSubmitTransferOptions,\r\n  ApiSubmitTransferTonResult,\r\n  ApiSubmitTransferWithDieselResult,\r\n  PreparedTransactionToSign,\r\n  TonTransferParams,\r\n} from './types';\r\nimport type { Signer } from './util/signer';\r\nimport type { TonWallet } from './util/tonCore';\r\nimport { ApiTransactionDraftError, ApiTransactionError } from '../../types';\r\n\r\nimport { DEFAULT_FEE, DIESEL_ADDRESS, STON_PTON_ADDRESS } from '../../../config';\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { bigintMultiplyToNumber } from '../../../util/bigint';\r\nimport { fromDecimal, toDecimal } from '../../../util/decimals';\r\nimport { getDieselTokenAmount, isDieselAvailable } from '../../../util/fee/transferFee';\r\nimport { omit, pick, split } from '../../../util/iteratees';\r\nimport { logDebug, logDebugError } from '../../../util/logs';\r\nimport { pause } from '../../../util/schedulers';\r\nimport { getMaxMessagesInTransaction } from '../../../util/ton/transfer';\r\nimport { parsePayloadBase64 } from './util/metadata';\r\nimport { sendExternal } from './util/sendExternal';\r\nimport { getSigner } from './util/signer';\r\nimport { isExpiredTransactionError, isSeqnoMismatchError } from './util/tonCore';\r\nimport {\r\n  commentToBytes,\r\n  getOurFeePayload,\r\n  getTonClient,\r\n  getWalletPublicKey,\r\n  packBytesAsSnake,\r\n  packBytesAsSnakeCell,\r\n  packBytesAsSnakeForEncryptedData,\r\n  parseAddress,\r\n  parseBase64,\r\n  parseStateInitCell,\r\n} from './util/tonCore';\r\nimport { fetchStoredChainAccount, fetchStoredWallet } from '../../common/accounts';\r\nimport { callBackendGet } from '../../common/backend';\r\nimport { withoutTransferConcurrency } from '../../common/preventTransferConcurrency';\r\nimport { getTokenByAddress } from '../../common/tokens';\r\nimport { base64ToBytes } from '../../common/utils';\r\nimport { MINUTE, SEC } from '../../constants';\r\nimport { ApiServerError, handleServerError } from '../../errors';\r\nimport { checkHasTransaction } from './activities';\r\nimport { resolveAddress } from './address';\r\nimport {\r\n  ATTEMPTS,\r\n  FEE_FACTOR,\r\n  LEDGER_VESTING_SUBWALLET_ID,\r\n  TOKEN_TRANSFER_FORWARD_AMOUNT,\r\n  TRANSFER_TIMEOUT_SEC,\r\n} from './constants';\r\nimport { emulateTransaction } from './emulation';\r\nimport {\r\n  buildTokenTransfer,\r\n  calculateTokenBalanceWithMintless,\r\n  getTokenBalanceWithMintless,\r\n  getToncoinAmountForTransfer,\r\n} from './tokens';\r\nimport { getContractInfo, getTonWallet, getWalletBalance, getWalletInfo, getWalletSeqno } from './wallet';\r\n\r\nconst WAIT_TRANSFER_TIMEOUT = MINUTE;\r\nconst WAIT_PAUSE = SEC;\r\n\r\nconst MAX_BALANCE_WITH_CHECK_DIESEL = 100000000n; // 0.1 TON\r\nconst PENDING_DIESEL_TIMEOUT_SEC = 15 * 60; // 15 min\r\n\r\nconst DIESEL_NOT_AVAILABLE: ApiFetchEstimateDieselResult = {\r\n  status: 'not-available',\r\n  nativeAmount: 0n,\r\n  remainingFee: 0n,\r\n  realFee: 0n,\r\n};\r\n\r\nexport async function checkTransactionDraft(\r\n  options: CheckTransactionDraftOptions,\r\n): Promise<ApiCheckTransactionDraftResult> {\r\n  const {\r\n    accountId,\r\n    amount = 0n,\r\n    tokenAddress,\r\n    shouldEncrypt,\r\n    isBase64Data,\r\n    stateInit: stateInitString,\r\n    forwardAmount,\r\n    allowGasless,\r\n  } = options;\r\n  let { toAddress, data } = options;\r\n\r\n  const { network } = parseAccountId(accountId);\r\n\r\n  let result: ApiCheckTransactionDraftResult = {};\r\n\r\n  try {\r\n    result = await checkToAddress(network, toAddress);\r\n    if ('error' in result) {\r\n      return result;\r\n    }\r\n\r\n    toAddress = result.resolvedAddress!;\r\n\r\n    const { isInitialized } = await getContractInfo(network, toAddress);\r\n\r\n    let stateInit: Cell | undefined;\r\n\r\n    if (stateInitString) {\r\n      try {\r\n        stateInit = Cell.fromBase64(stateInitString);\r\n      } catch {\r\n        return {\r\n          ...result,\r\n          error: ApiTransactionDraftError.InvalidStateInit,\r\n        };\r\n      }\r\n    }\r\n\r\n    if (result.isBounceable && !isInitialized && !stateInit) {\r\n      result.isToAddressNew = !(await checkHasTransaction(network, toAddress));\r\n      return {\r\n        ...result,\r\n        error: ApiTransactionDraftError.InactiveContract,\r\n      };\r\n    }\r\n\r\n    result.resolvedAddress = toAddress;\r\n\r\n    if (amount < 0n) {\r\n      return {\r\n        ...result,\r\n        error: ApiTransactionDraftError.InvalidAmount,\r\n      };\r\n    }\r\n\r\n    const account = await fetchStoredChainAccount(accountId, 'ton');\r\n    const wallet = getTonWallet(account.byChain.ton);\r\n\r\n    if (typeof data === 'string' && isBase64Data) {\r\n      data = base64ToBytes(data);\r\n    }\r\n\r\n    if (data && typeof data === 'string' && shouldEncrypt) {\r\n      const toPublicKey = await getWalletPublicKey(network, toAddress);\r\n      if (!toPublicKey) {\r\n        return {\r\n          ...result,\r\n          error: ApiTransactionDraftError.WalletNotInitialized,\r\n        };\r\n      }\r\n    }\r\n\r\n    const { address, isInitialized: isWalletInitialized } = account.byChain.ton;\r\n\r\n    if (data && typeof data === 'string' && !isBase64Data) {\r\n      data = commentToBytes(data);\r\n    }\r\n\r\n    let toncoinAmount: bigint;\r\n    const { seqno, balance: toncoinBalance } = await getWalletInfo(network, wallet);\r\n    let balance: bigint;\r\n    let fee: bigint;\r\n    let realFee: bigint;\r\n\r\n    if (!tokenAddress) {\r\n      balance = toncoinBalance;\r\n      toncoinAmount = amount;\r\n      fee = 0n;\r\n      realFee = 0n;\r\n\r\n      if (data instanceof Uint8Array) {\r\n        data = shouldEncrypt ? packBytesAsSnakeForEncryptedData(data) : packBytesAsSnake(data);\r\n      }\r\n    } else {\r\n      const tokenTransfer = await buildTokenTransfer({\r\n        network,\r\n        tokenAddress,\r\n        fromAddress: address,\r\n        toAddress,\r\n        amount,\r\n        payload: data,\r\n        forwardAmount,\r\n        isLedger: account.type === 'ledger',\r\n      });\r\n      ({ amount: toncoinAmount, toAddress, payload: data } = tokenTransfer);\r\n      const { realAmount: realToncoinAmount, isTokenWalletDeployed, mintlessTokenBalance } = tokenTransfer;\r\n\r\n      // When the token is transferred, actually some TON is transferred, and the token sits inside the payload.\r\n      // From the user perspective, this TON amount is a fee.\r\n      fee = toncoinAmount;\r\n      realFee = realToncoinAmount;\r\n\r\n      const tokenWalletAddress = toAddress;\r\n      balance = await calculateTokenBalanceWithMintless(\r\n        network, tokenWalletAddress, isTokenWalletDeployed, mintlessTokenBalance,\r\n      );\r\n    }\r\n\r\n    const isFullTonTransfer = !tokenAddress && toncoinBalance === amount;\r\n\r\n    const signer = getSigner(accountId, account, undefined, true);\r\n    const signingResult = await signTransaction({\r\n      account,\r\n      messages: [{\r\n        toAddress,\r\n        amount: toncoinAmount,\r\n        payload: data,\r\n        stateInit,\r\n        hints: {\r\n          tokenAddress,\r\n        },\r\n      }],\r\n      seqno,\r\n      signer,\r\n      doPayFeeFromAmount: isFullTonTransfer,\r\n    });\r\n    if ('error' in signingResult) {\r\n      return {\r\n        ...result,\r\n        error: signingResult.error,\r\n      };\r\n    }\r\n\r\n    // todo: Use `received` from the emulation to calculate the real fee. Check what happens when the receiver is the same wallet.\r\n    const { networkFee } = applyFeeFactorToEmulationResult(\r\n      await emulateTransactionWithFallback(network, wallet, signingResult.transaction, isWalletInitialized),\r\n    );\r\n    fee += networkFee;\r\n    realFee += networkFee;\r\n    result.fee = fee;\r\n    result.realFee = realFee;\r\n    result.diesel = DIESEL_NOT_AVAILABLE;\r\n\r\n    let isEnoughBalance: boolean;\r\n\r\n    if (!tokenAddress) {\r\n      isEnoughBalance = toncoinBalance >= fee + (isFullTonTransfer ? 0n : amount);\r\n    } else {\r\n      const canTransferGasfully = toncoinBalance >= fee;\r\n\r\n      if (allowGasless) {\r\n        result.diesel = await getDiesel({\r\n          accountId,\r\n          tokenAddress,\r\n          canTransferGasfully,\r\n          toncoinBalance,\r\n          tokenBalance: balance,\r\n        });\r\n      }\r\n\r\n      if (isDieselAvailable(result.diesel)) {\r\n        isEnoughBalance = amount + getDieselTokenAmount(result.diesel) <= balance;\r\n      } else {\r\n        isEnoughBalance = canTransferGasfully && amount <= balance;\r\n      }\r\n    }\r\n\r\n    return isEnoughBalance ? result : {\r\n      ...result,\r\n      error: ApiTransactionDraftError.InsufficientBalance,\r\n    };\r\n  } catch (err: any) {\r\n    return {\r\n      ...handleServerError(err),\r\n      ...result,\r\n    };\r\n  }\r\n}\r\n\r\nfunction estimateDiesel(\r\n  address: string,\r\n  tokenAddress: string,\r\n  toncoinAmount: string,\r\n  isW5?: boolean,\r\n  isStars?: boolean,\r\n) {\r\n  return callBackendGet<{\r\n    status: DieselStatus;\r\n    // The amount is defined only when the status is \"available\" or \"stars-fee\": https://github.com/mytonwallet-org/mytonwallet-backend/blob/44c1bf43fb776286152db8901b45fe8341752e35/src/endpoints/diesel.ts#L163\r\n    amount?: string;\r\n    pendingCreatedAt?: string;\r\n  }>('/diesel/estimate', {\r\n    address, tokenAddress, toncoinAmount, isW5, isStars,\r\n  });\r\n}\r\n\r\nexport async function checkToAddress(network: ApiNetwork, toAddress: string) {\r\n  const result: {\r\n    addressName?: string;\r\n    isScam?: boolean;\r\n    resolvedAddress?: string;\r\n    isToAddressNew?: boolean;\r\n    isBounceable?: boolean;\r\n    isMemoRequired?: boolean;\r\n  } = {};\r\n\r\n  const resolved = await resolveAddress(network, toAddress);\r\n  if (resolved === 'dnsNotResolved') return { ...result, error: ApiTransactionDraftError.DomainNotResolved };\r\n  if (resolved === 'invalidAddress') return { ...result, error: ApiTransactionDraftError.InvalidToAddress };\r\n  result.addressName = resolved.name;\r\n  result.resolvedAddress = resolved.address;\r\n  result.isMemoRequired = resolved.isMemoRequired;\r\n  result.isScam = resolved.isScam;\r\n  toAddress = resolved.address;\r\n\r\n  const { isUserFriendly, isTestOnly, isBounceable } = parseAddress(toAddress);\r\n\r\n  result.isBounceable = isBounceable;\r\n\r\n  const regex = /[+=/]/;\r\n  const isUrlSafe = !regex.test(toAddress);\r\n\r\n  if (!isUserFriendly || !isUrlSafe || (network === 'mainnet' && isTestOnly)) {\r\n    return {\r\n      ...result,\r\n      error: ApiTransactionDraftError.InvalidAddressFormat,\r\n    };\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nexport async function submitTransfer(options: ApiSubmitTransferOptions): Promise<ApiSubmitTransferTonResult> {\r\n  const {\r\n    accountId,\r\n    password,\r\n    amount,\r\n    tokenAddress,\r\n    shouldEncrypt,\r\n    isBase64Data,\r\n    forwardAmount = TOKEN_TRANSFER_FORWARD_AMOUNT,\r\n    noFeeCheck,\r\n  } = options;\r\n  let { stateInit } = options;\r\n\r\n  let { toAddress, data } = options;\r\n\r\n  const { network } = parseAccountId(accountId);\r\n\r\n  try {\r\n    const account = await fetchStoredChainAccount(accountId, 'ton');\r\n    const { address: fromAddress, isInitialized } = account.byChain.ton;\r\n    const wallet = getTonWallet(account.byChain.ton);\r\n    const signer = getSigner(accountId, account, password);\r\n\r\n    let encryptedComment: string | undefined;\r\n\r\n    if (typeof data === 'string') {\r\n      const result = await stringToPayload({\r\n        network, toAddress, data, signer, shouldEncrypt, isBase64Data,\r\n      });\r\n      if ('error' in result) return result;\r\n      ({ payload: data, encryptedComment } = result);\r\n    }\r\n\r\n    let toncoinAmount: bigint;\r\n\r\n    if (!tokenAddress) {\r\n      toncoinAmount = amount;\r\n\r\n      if (data instanceof Uint8Array) {\r\n        data = shouldEncrypt ? packBytesAsSnakeForEncryptedData(data) : packBytesAsSnake(data);\r\n      }\r\n    } else {\r\n      ({\r\n        amount: toncoinAmount,\r\n        toAddress,\r\n        payload: data,\r\n        stateInit,\r\n      } = await buildTokenTransfer({\r\n        network,\r\n        tokenAddress,\r\n        fromAddress,\r\n        toAddress,\r\n        amount,\r\n        payload: data,\r\n        forwardAmount,\r\n        isLedger: account.type === 'ledger',\r\n      }));\r\n    }\r\n\r\n    return await withoutTransferConcurrency(network, fromAddress, async (finalizeInBackground) => {\r\n      const { seqno, balance: toncoinBalance } = await getWalletInfo(network, wallet);\r\n      const isFullTonTransfer = !tokenAddress && toncoinBalance === amount;\r\n\r\n      const signingResult = await signTransaction({\r\n        account,\r\n        messages: [{\r\n          toAddress,\r\n          amount: toncoinAmount,\r\n          payload: data,\r\n          stateInit,\r\n          hints: {\r\n            tokenAddress,\r\n          },\r\n        }],\r\n        seqno,\r\n        signer,\r\n        doPayFeeFromAmount: isFullTonTransfer,\r\n      });\r\n      if ('error' in signingResult) return signingResult;\r\n      const { transaction } = signingResult;\r\n\r\n      if (!noFeeCheck) {\r\n        const { networkFee } = await emulateTransactionWithFallback(network, wallet, transaction, isInitialized);\r\n\r\n        const isEnoughBalance = isFullTonTransfer\r\n          ? toncoinBalance > networkFee\r\n          : toncoinBalance >= toncoinAmount + networkFee;\r\n\r\n        if (!isEnoughBalance) {\r\n          return { error: ApiTransactionError.InsufficientBalance };\r\n        }\r\n      }\r\n\r\n      const client = getTonClient(network);\r\n      const { msgHash, boc, msgHashNormalized } = await sendExternal(client, wallet, transaction);\r\n\r\n      finalizeInBackground(() => retrySendBoc(network, fromAddress, boc, seqno));\r\n\r\n      return {\r\n        amount,\r\n        seqno,\r\n        encryptedComment,\r\n        toAddress,\r\n        msgHash,\r\n        msgHashNormalized,\r\n        toncoinAmount,\r\n      };\r\n    });\r\n  } catch (err: any) {\r\n    logDebugError('submitTransfer', err);\r\n\r\n    return { error: resolveTransactionError(err) };\r\n  }\r\n}\r\n\r\nexport async function submitTransferWithDiesel(options: {\r\n  accountId: string;\r\n  password?: string;\r\n  toAddress: string;\r\n  amount: bigint;\r\n  data?: AnyPayload;\r\n  tokenAddress: string;\r\n  shouldEncrypt?: boolean;\r\n  dieselAmount: bigint;\r\n  isGaslessWithStars?: boolean;\r\n}): Promise<ApiSubmitTransferWithDieselResult> {\r\n  try {\r\n    const {\r\n      toAddress,\r\n      amount,\r\n      accountId,\r\n      password,\r\n      tokenAddress,\r\n      shouldEncrypt,\r\n      dieselAmount,\r\n      isGaslessWithStars,\r\n    } = options;\r\n\r\n    let { data } = options;\r\n\r\n    const { network } = parseAccountId(accountId);\r\n\r\n    const account = await fetchStoredChainAccount(accountId, 'ton');\r\n    const { address: fromAddress, version } = account.byChain.ton;\r\n\r\n    let encryptedComment: string | undefined;\r\n\r\n    if (typeof data === 'string') {\r\n      const signer = getSigner(accountId, account, password);\r\n      const result = await stringToPayload({\r\n        network, toAddress, data, signer, shouldEncrypt,\r\n      });\r\n      if ('error' in result) return result;\r\n      ({ payload: data, encryptedComment } = result);\r\n    }\r\n\r\n    const messages: TonTransferParams[] = [\r\n      await buildTokenTransfer({\r\n        network,\r\n        tokenAddress,\r\n        fromAddress,\r\n        toAddress,\r\n        amount,\r\n        payload: data,\r\n        isLedger: account.type === 'ledger',\r\n      }),\r\n    ];\r\n\r\n    if (!isGaslessWithStars) {\r\n      messages.push(\r\n        await buildTokenTransfer({\r\n          network,\r\n          tokenAddress,\r\n          fromAddress,\r\n          toAddress: DIESEL_ADDRESS,\r\n          amount: dieselAmount,\r\n          shouldSkipMintless: true,\r\n          payload: getOurFeePayload(),\r\n          isLedger: account.type === 'ledger',\r\n        }),\r\n      );\r\n    }\r\n\r\n    const result = await submitMultiTransfer({\r\n      accountId,\r\n      password,\r\n      messages,\r\n      isGasless: true,\r\n    });\r\n\r\n    return {\r\n      ...result,\r\n      encryptedComment,\r\n      withW5Gasless: version === 'W5',\r\n    };\r\n  } catch (err) {\r\n    logDebugError('submitTransferWithDiesel', err);\r\n\r\n    return { error: resolveTransactionError(err) };\r\n  }\r\n}\r\n\r\nasync function stringToPayload({\r\n  network, toAddress, data, shouldEncrypt, signer, isBase64Data,\r\n}: {\r\n  network: ApiNetwork;\r\n  data: string;\r\n  shouldEncrypt?: boolean;\r\n  toAddress: string;\r\n  signer: Signer;\r\n  isBase64Data?: boolean;\r\n}): Promise<{\r\n  payload?: Uint8Array | Cell;\r\n  encryptedComment?: string;\r\n} | { error: ApiAnyDisplayError }> {\r\n  let payload: Uint8Array | Cell | undefined;\r\n  let encryptedComment: string | undefined;\r\n\r\n  if (!data) {\r\n    payload = undefined;\r\n  } else if (isBase64Data) {\r\n    payload = parseBase64(data);\r\n  } else if (shouldEncrypt) {\r\n    const toPublicKey = (await getWalletPublicKey(network, toAddress))!;\r\n    const result = await signer.encryptComment(data, toPublicKey);\r\n    if ('error' in result) return result;\r\n    payload = result;\r\n    encryptedComment = result.subarray(4).toString('base64');\r\n  } else {\r\n    payload = commentToBytes(data);\r\n  }\r\n\r\n  return { payload, encryptedComment };\r\n}\r\n\r\nexport function resolveTransactionError(error: any): ApiAnyDisplayError | string {\r\n  if (error instanceof ApiServerError) {\r\n    if (isExpiredTransactionError(error.message)) {\r\n      return ApiTransactionError.IncorrectDeviceTime;\r\n    } else if (isSeqnoMismatchError(error.message)) {\r\n      return ApiTransactionError.ConcurrentTransaction;\r\n    } else if (error.statusCode === 400) {\r\n      return error.message;\r\n    } else if (error.displayError) {\r\n      return error.displayError;\r\n    }\r\n  }\r\n  return ApiTransactionError.UnsuccesfulTransfer;\r\n}\r\n\r\nexport async function checkMultiTransactionDraft(\r\n  accountId: string,\r\n  messages: TonTransferParams[],\r\n  withDiesel?: boolean,\r\n): Promise<ApiCheckMultiTransactionDraftResult> {\r\n  let totalAmount: bigint = 0n;\r\n\r\n  const { network } = parseAccountId(accountId);\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n\r\n  try {\r\n    for (const { toAddress, amount } of messages) {\r\n      if (amount < 0n) {\r\n        return { error: ApiTransactionDraftError.InvalidAmount };\r\n      }\r\n\r\n      const isMainnet = network === 'mainnet';\r\n      const { isValid, isTestOnly } = parseAddress(toAddress);\r\n\r\n      if (!isValid || (isMainnet && isTestOnly)) {\r\n        return { error: ApiTransactionDraftError.InvalidToAddress };\r\n      }\r\n\r\n      totalAmount += amount;\r\n    }\r\n\r\n    // Check individual token balances\r\n    const { hasInsufficientTokenBalance, parsedPayloads } = await isTokenBalanceInsufficient(\r\n      network,\r\n      account.byChain.ton.address,\r\n      messages,\r\n    );\r\n\r\n    const wallet = getTonWallet(account.byChain.ton);\r\n    const { seqno, balance } = await getWalletInfo(network, wallet);\r\n\r\n    const signer = getSigner(accountId, account, undefined, true);\r\n    const signingResult = await signTransaction({ account, messages, seqno, signer });\r\n    if ('error' in signingResult) return signingResult;\r\n\r\n    const emulation = applyFeeFactorToEmulationResult(\r\n      await emulateTransactionWithFallback(\r\n        network,\r\n        wallet,\r\n        signingResult.transaction,\r\n        account.byChain.ton.isInitialized,\r\n      ),\r\n    );\r\n    const result = { emulation, parsedPayloads };\r\n\r\n    // TODO Should `totalAmount` be `0` for `withDiesel`?\r\n    // Check for insufficient balance (both tokens and TON) and return error\r\n    const hasInsufficientTonBalance = !withDiesel && balance < totalAmount + result.emulation.networkFee;\r\n\r\n    if (hasInsufficientTokenBalance || hasInsufficientTonBalance) {\r\n      return { ...result, error: ApiTransactionDraftError.InsufficientBalance };\r\n    }\r\n\r\n    return result;\r\n  } catch (err: any) {\r\n    return handleServerError(err);\r\n  }\r\n}\r\n\r\nasync function isTokenBalanceInsufficient(\r\n  network: ApiNetwork,\r\n  walletAddress: string,\r\n  messages: TonTransferParams[],\r\n): Promise<{\r\n    hasInsufficientTokenBalance: boolean;\r\n    parsedPayloads: (ApiParsedPayload | undefined)[];\r\n  }> {\r\n  const payloadParsingResults = await Promise.all(\r\n    messages.map(async ({ payload, toAddress }) => {\r\n      if (!payload) return { tokenResult: undefined, parsedPayload: undefined };\r\n\r\n      try {\r\n        const payloadAsString = getPayloadFromTransfer({ payload, isBase64Payload: true })!.toBoc().toString('base64');\r\n        const parsedPayload = await parsePayloadBase64(network, toAddress, payloadAsString);\r\n\r\n        if (parsedPayload?.type === 'tokens:transfer') {\r\n          return {\r\n            tokenResult: {\r\n              tokenAddress: parsedPayload.tokenAddress,\r\n              amount: parsedPayload.amount,\r\n            },\r\n            parsedPayload,\r\n          };\r\n        }\r\n\r\n        return { tokenResult: undefined, parsedPayload };\r\n      } catch (e) {\r\n        // If payload parsing fails, treat as regular TON transfer\r\n        logDebugError('isTokenBalanceInsufficient', 'Error parsing payload', e);\r\n      }\r\n\r\n      return { tokenResult: undefined, parsedPayload: undefined };\r\n    }),\r\n  );\r\n\r\n  // Accumulate token amounts by address\r\n  const tokenAmountsByAddress: Record<string, bigint> = {};\r\n  const parsedPayloads = payloadParsingResults.map((result) => result?.parsedPayload);\r\n  let hasUnknownToken = false;\r\n\r\n  for (const result of payloadParsingResults) {\r\n    if (result?.tokenResult) {\r\n      const { tokenAddress, amount } = result.tokenResult;\r\n\r\n      if (!tokenAddress) {\r\n        // Possible when the jetton wallet is not deployed, therefore the minter address is unknown and set to \"\".\r\n        // This is handled in `parsePayloadSlice`. If the sender jetton wallet is not deployed, assuming the balance is 0.\r\n        hasUnknownToken = true;\r\n        continue;\r\n      }\r\n\r\n      if (!tokenAmountsByAddress[tokenAddress]) {\r\n        tokenAmountsByAddress[tokenAddress] = 0n;\r\n      }\r\n      tokenAmountsByAddress[tokenAddress] += amount;\r\n    }\r\n  }\r\n\r\n  if (hasUnknownToken) {\r\n    return { hasInsufficientTokenBalance: true, parsedPayloads };\r\n  }\r\n\r\n  const tokenAddresses = Object.keys(tokenAmountsByAddress);\r\n  if (tokenAddresses.length === 0) {\r\n    return { hasInsufficientTokenBalance: false, parsedPayloads }; // No token transfers\r\n  }\r\n\r\n  const tokenBalances = await Promise.all(\r\n    tokenAddresses.map((tokenAddress) =>\r\n      tokenAddress !== STON_PTON_ADDRESS\r\n        ? getTokenBalanceWithMintless(network, walletAddress, tokenAddress)\r\n        : 0n,\r\n    ),\r\n  );\r\n\r\n  // Check if any token has insufficient balance\r\n  for (let i = 0; i < tokenAddresses.length; i++) {\r\n    const tokenAddress = tokenAddresses[i];\r\n    const requiredAmount = tokenAmountsByAddress[tokenAddress];\r\n    const availableBalance = tokenBalances[i];\r\n\r\n    if (tokenAddress === STON_PTON_ADDRESS) {\r\n      continue; // PTON can be here from the built-in swaps\r\n    }\r\n\r\n    if (availableBalance < requiredAmount) {\r\n      return { hasInsufficientTokenBalance: true, parsedPayloads };\r\n    }\r\n  }\r\n\r\n  return { hasInsufficientTokenBalance: false, parsedPayloads };\r\n}\r\n\r\nexport type GaslessType = 'diesel' | 'w5';\r\n\r\ninterface SubmitMultiTransferOptions {\r\n  accountId: string;\r\n  /** Required only for mnemonic accounts */\r\n  password?: string;\r\n  messages: TonTransferParams[];\r\n  expireAt?: number;\r\n  isGasless?: boolean;\r\n}\r\n\r\n// todo: Support submitting multiple transactions (not only multiple messages). The signing already supports that. It will allow to: 1) send multiple NFTs with a single API call, 2) renew multiple domains in a single function call, 3) simplify the implementation of swapping with Ledger\r\nexport async function submitMultiTransfer({\r\n  accountId, password, messages, expireAt, isGasless,\r\n}: SubmitMultiTransferOptions): Promise<ApiSubmitMultiTransferResult> {\r\n  const { network } = parseAccountId(accountId);\r\n\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n  const { address: fromAddress, isInitialized, version } = account.byChain.ton;\r\n\r\n  try {\r\n    const wallet = getTonWallet(account.byChain.ton);\r\n\r\n    let totalAmount = 0n;\r\n    messages.forEach((message) => {\r\n      totalAmount += BigInt(message.amount);\r\n    });\r\n\r\n    return await withoutTransferConcurrency(network, fromAddress, async (finalizeInBackground) => {\r\n      const { seqno, balance } = await getWalletInfo(network, wallet);\r\n\r\n      const gaslessType = isGasless ? version === 'W5' ? 'w5' : 'diesel' : undefined;\r\n      const withW5Gasless = gaslessType === 'w5';\r\n\r\n      const signer = getSigner(accountId, account, password);\r\n      const signingResult = await signTransaction({\r\n        account,\r\n        messages,\r\n        expireAt: withW5Gasless\r\n          ? Math.round(Date.now() / 1000) + PENDING_DIESEL_TIMEOUT_SEC\r\n          : expireAt,\r\n        seqno,\r\n        signer,\r\n        shouldBeInternal: withW5Gasless,\r\n      });\r\n      if ('error' in signingResult) return signingResult;\r\n      const { transaction } = signingResult;\r\n\r\n      if (!isGasless) {\r\n        const { networkFee } = await emulateTransactionWithFallback(network, wallet, transaction, isInitialized);\r\n        if (balance < totalAmount + networkFee) {\r\n          return { error: ApiTransactionError.InsufficientBalance };\r\n        }\r\n      }\r\n\r\n      const client = getTonClient(network);\r\n      const { msgHash, boc, paymentLink, msgHashNormalized } = await sendExternal(\r\n        client, wallet, transaction, gaslessType,\r\n      );\r\n\r\n      if (!isGasless) {\r\n        finalizeInBackground(() => retrySendBoc(network, fromAddress, boc, seqno));\r\n      } else {\r\n        // TODO: Wait for gasless transfer\r\n      }\r\n\r\n      const clearedMessages = messages.map((message) => {\r\n        if (typeof message.payload !== 'string' && typeof message.payload !== 'undefined') {\r\n          return omit(message, ['payload']);\r\n        }\r\n        return message;\r\n      });\r\n\r\n      return {\r\n        seqno,\r\n        amount: totalAmount.toString(),\r\n        messages: clearedMessages,\r\n        boc,\r\n        msgHash,\r\n        msgHashNormalized,\r\n        paymentLink,\r\n        withW5Gasless,\r\n      };\r\n    });\r\n  } catch (err) {\r\n    logDebugError('submitMultiTransfer', err);\r\n    return { error: resolveTransactionError(err) };\r\n  }\r\n}\r\n\r\nexport async function signTransfers(\r\n  accountId: string,\r\n  messages: TonTransferParams[],\r\n  password?: string,\r\n  expireAt?: number,\r\n  /** Used for specific transactions on vesting.ton.org */\r\n  ledgerVestingAddress?: string,\r\n): Promise<ApiSignedTransfer[] | { error: ApiAnyDisplayError }> {\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n\r\n  // If there is an outgoing transfer in progress, this expression waits for it to finish. This helps to avoid seqno\r\n  // mismatches. This is not fully reliable, because the signed transactions are sent by a separate API method, but it\r\n  // works in most cases.\r\n  await withoutTransferConcurrency(parseAccountId(accountId).network, account.byChain.ton.address, () => {});\r\n\r\n  const seqno = await getWalletSeqno(\r\n    parseAccountId(accountId).network,\r\n    ledgerVestingAddress ?? account.byChain.ton.address,\r\n  );\r\n  const signer = getSigner(\r\n    accountId,\r\n    account,\r\n    password,\r\n    false,\r\n    ledgerVestingAddress ? LEDGER_VESTING_SUBWALLET_ID : undefined,\r\n  );\r\n  const signedTransactions = await signTransactions({ account, expireAt, messages, seqno, signer });\r\n  if ('error' in signedTransactions) return signedTransactions;\r\n\r\n  return signedTransactions.map(({ seqno, transaction }) => ({\r\n    seqno,\r\n    base64: transaction.toBoc().toString('base64'),\r\n  }));\r\n}\r\n\r\ninterface SignTransactionOptions {\r\n  account: ApiAccountWithChain<'ton'>;\r\n  doPayFeeFromAmount?: boolean;\r\n  messages: TonTransferParams[];\r\n  seqno: number;\r\n  signer: Signer;\r\n  /** Unix seconds */\r\n  expireAt?: number;\r\n  /** If true, will sign the transaction as an internal message instead of external. Not supported by Ledger. */\r\n  shouldBeInternal?: boolean;\r\n}\r\n\r\nasync function signTransaction(options: SignTransactionOptions) {\r\n  const result = await signTransactions({ ...options, allowOnlyOneTransaction: true });\r\n  if ('error' in result) return result;\r\n  return result[0];\r\n}\r\n\r\n/**\r\n * A universal function for signing any number of transactions in any account type.\r\n *\r\n * If the account doesn't support signing all the given messages in a single transaction, will produce multiple signed\r\n * transactions. If you need exactly 1 signed transaction, use `allowOnlyOneTransaction` or `signTransaction` (the\r\n * function will throw an error in case of multiple transactions).\r\n *\r\n * The reason for signing multiple transactions (not messages) in a single function call is improving the UX. Each\r\n * transaction requires a manual user action to sign with Ledger. So, all the transactions should be checked before\r\n * actually signing any of them.\r\n */\r\nasync function signTransactions({\r\n  account,\r\n  messages,\r\n  doPayFeeFromAmount,\r\n  seqno,\r\n  signer,\r\n  expireAt = Math.round(Date.now() / 1000) + TRANSFER_TIMEOUT_SEC,\r\n  shouldBeInternal,\r\n  allowOnlyOneTransaction,\r\n}: SignTransactionOptions & { allowOnlyOneTransaction?: boolean }) {\r\n  const messagesPerTransaction = getMaxMessagesInTransaction(account);\r\n  const messagesByTransaction = split(messages, messagesPerTransaction);\r\n\r\n  if (allowOnlyOneTransaction && messagesByTransaction.length !== 1) {\r\n    throw new Error(\r\n      messagesByTransaction.length === 0\r\n        ? 'No messages to sign'\r\n        : `Too many messages for 1 transaction (${messages.length} messages given)`,\r\n    );\r\n  }\r\n\r\n  const transactionsToSign = messagesByTransaction.map((transactionMessages, index) => {\r\n    if (!signer.isMock) {\r\n      logDebug('Signing transaction', {\r\n        seqno,\r\n        messages: transactionMessages.map((msg) => pick(msg, ['toAddress', 'amount'])),\r\n      });\r\n    }\r\n\r\n    return makePreparedTransactionToSign({\r\n      messages: transactionMessages,\r\n      seqno: seqno + index,\r\n      doPayFeeFromAmount,\r\n      expireAt,\r\n      shouldBeInternal,\r\n    });\r\n  });\r\n\r\n  // All the transactions are passed to a single `signer.signTransactions` call, because it checks the transactions\r\n  // before signing. See the `signTransactions` description for more details.\r\n  const signedTransactions = await signer.signTransactions(transactionsToSign);\r\n  if ('error' in signedTransactions) return signedTransactions;\r\n\r\n  return signedTransactions.map((transaction, index) => ({\r\n    seqno: transactionsToSign[index].seqno,\r\n    transaction,\r\n  }));\r\n}\r\n\r\nasync function retrySendBoc(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  boc: string,\r\n  seqno: number,\r\n) {\r\n  const tonClient = getTonClient(network);\r\n  const waitUntil = Date.now() + WAIT_TRANSFER_TIMEOUT;\r\n\r\n  while (Date.now() < waitUntil) {\r\n    const [error, walletInfo] = await Promise.all([\r\n      tonClient.sendFile(boc).catch((err) => String(err)),\r\n      getWalletInfo(network, address).catch(() => undefined),\r\n    ]);\r\n\r\n    // Errors mean that `seqno` was changed or not enough of balance\r\n    if (error?.match(/(exitcode=33|exitcode=133|inbound external message rejected by account)/)) {\r\n      break;\r\n    }\r\n\r\n    // seqno here may change before exit code appears\r\n    if (walletInfo && walletInfo.seqno > seqno) {\r\n      break;\r\n    }\r\n\r\n    await pause(WAIT_PAUSE);\r\n  }\r\n}\r\n\r\nasync function emulateTransactionWithFallback(\r\n  network: ApiNetwork,\r\n  wallet: TonWallet,\r\n  transaction: Cell,\r\n  isInitialized?: boolean,\r\n): Promise<ApiEmulationWithFallbackResult> {\r\n  try {\r\n    const emulation = await emulateTransaction(network, wallet, transaction, isInitialized);\r\n    return { isFallback: false, ...emulation };\r\n  } catch (err) {\r\n    logDebugError('Failed to emulate a transaction', err);\r\n  }\r\n\r\n  // Falling back to the legacy fee estimation method just in case.\r\n  // It doesn't support estimating more than 20 messages (inside the transaction) at once.\r\n  // eslint-disable-next-line no-null/no-null\r\n  const { code = null, data = null } = !isInitialized ? wallet.init : {};\r\n  const { source_fees: fees } = await getTonClient(network).estimateExternalMessageFee(wallet.address, {\r\n    body: transaction,\r\n    initCode: code,\r\n    initData: data,\r\n    ignoreSignature: true,\r\n  });\r\n  const networkFee = BigInt(fees.in_fwd_fee + fees.storage_fee + fees.gas_fee + fees.fwd_fee);\r\n  return { isFallback: true, networkFee };\r\n}\r\n\r\nexport async function sendSignedTransactions(accountId: string, transactions: ApiSignedTransfer[]) {\r\n  const { network } = parseAccountId(accountId);\r\n  const storedWallet = await fetchStoredWallet(accountId, 'ton');\r\n  const { address: fromAddress } = storedWallet;\r\n  const client = getTonClient(network);\r\n  const wallet = getTonWallet(storedWallet);\r\n\r\n  const attempts = ATTEMPTS + transactions.length;\r\n  let index = 0;\r\n  let attempt = 0;\r\n\r\n  const sentTransactions: { boc: string; msgHashNormalized: string }[] = [];\r\n\r\n  return withoutTransferConcurrency(network, fromAddress, async (finalizeInBackground) => {\r\n    while (index < transactions.length && attempt < attempts) {\r\n      const { base64, seqno } = transactions[index];\r\n      try {\r\n        const { boc, msgHashNormalized } = await sendExternal(client, wallet, Cell.fromBase64(base64));\r\n        sentTransactions.push({ boc, msgHashNormalized });\r\n\r\n        const ensureSent = () => retrySendBoc(network, fromAddress, boc, seqno);\r\n        if (index === transactions.length - 1) {\r\n          finalizeInBackground(ensureSent);\r\n        } else {\r\n          await ensureSent();\r\n        }\r\n\r\n        index++;\r\n      } catch (err) {\r\n        if (err instanceof ApiServerError && isSeqnoMismatchError(err.message)) {\r\n          return { error: ApiTransactionError.ConcurrentTransaction };\r\n        }\r\n        logDebugError('sendSignedMessages', err);\r\n      }\r\n      attempt++;\r\n    }\r\n\r\n    return sentTransactions;\r\n  });\r\n}\r\n\r\n/**\r\n * The goal of the function is acting like `checkTransactionDraft` but return only the diesel information\r\n */\r\nexport function fetchEstimateDiesel(\r\n  accountId: string, tokenAddress: string,\r\n): Promise<ApiFetchEstimateDieselResult> {\r\n  return getDiesel({\r\n    accountId,\r\n    tokenAddress,\r\n    // We pass `false` because `fetchEstimateDiesel` assumes that the transfer is gasless anyway\r\n    canTransferGasfully: false,\r\n  });\r\n}\r\n\r\n/**\r\n * Decides whether the transfer must be gasless and fetches the diesel estimate from the backend.\r\n */\r\nasync function getDiesel({\r\n  accountId,\r\n  tokenAddress,\r\n  canTransferGasfully,\r\n  toncoinBalance,\r\n  tokenBalance,\r\n}: {\r\n  accountId: string;\r\n  tokenAddress: string;\r\n  canTransferGasfully: boolean;\r\n  // The below fields allow to avoid network requests if you already have these data\r\n  toncoinBalance?: bigint;\r\n  tokenBalance?: bigint;\r\n}): Promise<ApiFetchEstimateDieselResult> {\r\n  const { network } = parseAccountId(accountId);\r\n  if (network !== 'mainnet') return DIESEL_NOT_AVAILABLE;\r\n\r\n  const storedTonWallet = await fetchStoredWallet(accountId, 'ton');\r\n  const wallet = getTonWallet(storedTonWallet);\r\n\r\n  const token = getTokenByAddress(tokenAddress)!;\r\n  if (!token.isGaslessEnabled && !token.isStarsEnabled) return DIESEL_NOT_AVAILABLE;\r\n\r\n  const { address, version } = storedTonWallet;\r\n  toncoinBalance ??= await getWalletBalance(network, wallet);\r\n  const fee = getDieselToncoinFee(token);\r\n  const toncoinNeeded = fee.amount - toncoinBalance;\r\n\r\n  if (toncoinBalance >= MAX_BALANCE_WITH_CHECK_DIESEL || toncoinNeeded <= 0n) return DIESEL_NOT_AVAILABLE;\r\n\r\n  const rawDiesel = await estimateDiesel(\r\n    address,\r\n    tokenAddress,\r\n    toDecimal(toncoinNeeded),\r\n    version === 'W5',\r\n    fee.isStars,\r\n  );\r\n  const diesel: ApiFetchEstimateDieselResult = {\r\n    status: rawDiesel.status,\r\n    amount: rawDiesel.amount === undefined\r\n      ? undefined\r\n      : fromDecimal(rawDiesel.amount, rawDiesel.status === 'stars-fee' ? 0 : token.decimals),\r\n    nativeAmount: toncoinNeeded,\r\n    remainingFee: toncoinBalance,\r\n    realFee: fee.realFee,\r\n  };\r\n\r\n  const tokenAmount = getDieselTokenAmount(diesel);\r\n  if (tokenAmount === 0n) {\r\n    return diesel;\r\n  }\r\n\r\n  tokenBalance ??= await getTokenBalanceWithMintless(network, address, tokenAddress);\r\n  const canPayDiesel = tokenBalance >= tokenAmount;\r\n  const isAwaitingNotExpiredPrevious = Boolean(\r\n    rawDiesel.pendingCreatedAt\r\n    && Date.now() - new Date(rawDiesel.pendingCreatedAt).getTime() < PENDING_DIESEL_TIMEOUT_SEC * SEC,\r\n  );\r\n\r\n  // When both TON and diesel are insufficient, we want to show the TON fee\r\n  const shouldBeGasless = (!canTransferGasfully && canPayDiesel) || isAwaitingNotExpiredPrevious;\r\n  return shouldBeGasless ? diesel : DIESEL_NOT_AVAILABLE;\r\n}\r\n\r\n/**\r\n * Guesses the total TON fee (including the gas attached to the transaction) that will be spent on a diesel transfer.\r\n *\r\n * `amount` is what will be taken from the wallet;\r\n * `realFee` is approximately what will be actually spent (the rest will return in the excess);\r\n * `isStars` tells whether the fee is estimated considering that the diesel will be paid in stars.\r\n */\r\nfunction getDieselToncoinFee(token: ApiToken) {\r\n  const isStars = !token.isGaslessEnabled && token.isStarsEnabled;\r\n  let { amount, realAmount: realFee } = getToncoinAmountForTransfer(token, false);\r\n\r\n  // Multiplying by 2 because the diesel transfer has 2 transactions:\r\n  // - for the transfer itself,\r\n  // - for sending the diesel to the MTW wallet.\r\n  if (!isStars) {\r\n    amount *= 2n;\r\n    realFee *= 2n;\r\n  }\r\n\r\n  amount += DEFAULT_FEE;\r\n  realFee += DEFAULT_FEE;\r\n\r\n  return { amount, realFee, isStars };\r\n}\r\n\r\nfunction applyFeeFactorToEmulationResult(estimation: ApiEmulationWithFallbackResult): ApiEmulationWithFallbackResult {\r\n  estimation = {\r\n    ...estimation,\r\n    networkFee: bigintMultiplyToNumber(estimation.networkFee, FEE_FACTOR),\r\n  };\r\n\r\n  if ('byTransactionIndex' in estimation) {\r\n    estimation.byTransactionIndex = estimation.byTransactionIndex.map((transaction) => ({\r\n      ...transaction,\r\n      networkFee: bigintMultiplyToNumber(transaction.networkFee, FEE_FACTOR),\r\n    }));\r\n  }\r\n\r\n  return estimation;\r\n}\r\n\r\nfunction makePreparedTransactionToSign(\r\n  options: Pick<SignTransactionOptions, 'messages' | 'doPayFeeFromAmount' | 'expireAt' | 'shouldBeInternal' | 'seqno'>,\r\n): PreparedTransactionToSign {\r\n  const { messages, seqno, doPayFeeFromAmount, expireAt, shouldBeInternal } = options;\r\n\r\n  return {\r\n    authType: shouldBeInternal ? 'internal' : undefined,\r\n    seqno,\r\n    messages: messages.map((message) => {\r\n      const { amount, toAddress, stateInit } = message;\r\n      return internal({\r\n        value: amount,\r\n        to: toAddress,\r\n        body: getPayloadFromTransfer(message),\r\n        bounce: parseAddress(toAddress).isBounceable,\r\n        init: parseStateInitCell(stateInit),\r\n      });\r\n    }),\r\n    sendMode: (doPayFeeFromAmount ? SendMode.CARRY_ALL_REMAINING_BALANCE : SendMode.PAY_GAS_SEPARATELY)\r\n      // It's important to add IGNORE_ERRORS to every transaction. Otherwise, failed transactions may repeat and drain\r\n      // the wallet balance: https://docs.ton.org/v3/documentation/smart-contracts/message-management/sending-messages#behavior-without-2-flag\r\n      + SendMode.IGNORE_ERRORS,\r\n    timeout: expireAt,\r\n    hints: messages[0].hints, // Currently hints are used only by Ledger, which has only 1 message per transaction\r\n  };\r\n}\r\n\r\nfunction getPayloadFromTransfer(\r\n  { payload, isBase64Payload }: Pick<TonTransferParams, 'payload' | 'isBase64Payload'>,\r\n): Cell | undefined {\r\n  if (payload === undefined) {\r\n    return undefined;\r\n  }\r\n\r\n  if (payload instanceof Cell) {\r\n    return payload;\r\n  }\r\n\r\n  if (typeof payload === 'string') {\r\n    if (isBase64Payload) {\r\n      return Cell.fromBase64(payload);\r\n    }\r\n\r\n    // This is what @ton/core does under the hood when a string payload is passed to `internal()`\r\n    return packBytesAsSnakeCell(commentToBytes(payload));\r\n  }\r\n\r\n  if (payload instanceof Uint8Array) {\r\n    return payload.length ? packBytesAsSnakeCell(payload) : undefined;\r\n  }\r\n\r\n  throw new TypeError(`Unexpected payload type ${typeof payload}`);\r\n}\r\n","import type { ApiDomainData, ApiNft } from '../../types';\r\nimport type { TonTransferParams } from './types';\r\n\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { YEAR } from '../../../util/dateFormat';\r\nimport { split } from '../../../util/iteratees';\r\nimport { getMaxMessagesInTransaction } from '../../../util/ton/transfer';\r\nimport { parseTonapiioNft } from './util/metadata';\r\nimport { DnsItem } from './contracts/DnsItem';\r\nimport { fetchStoredChainAccount, fetchStoredWallet } from '../../common/accounts';\r\nimport { getNftSuperCollectionsByCollectionAddress } from '../../common/addresses';\r\nimport { callBackendGet } from '../../common/backend';\r\nimport { TON_GAS } from './constants';\r\nimport { checkMultiTransactionDraft, submitMultiTransfer } from './transfer';\r\n\r\nexport async function checkDnsRenewalDraft(accountId: string, nftAddresses: string[]) {\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n  const maxMessages = getMaxMessagesInTransaction(account);\r\n  const transactionCount = Math.ceil(nftAddresses.length / maxMessages);\r\n\r\n  const messages = nftAddresses\r\n    .slice(0, maxMessages)\r\n    .map(makeRenewMessage);\r\n\r\n  const result = await checkMultiTransactionDraft(accountId, messages);\r\n\r\n  if ('error' in result) {\r\n    return result;\r\n  }\r\n\r\n  const totalAmount = TON_GAS.changeDns * BigInt(nftAddresses.length);\r\n  const realFee = totalAmount + result.emulation.networkFee * BigInt(transactionCount); // Not very correct, but  the actual fee\r\n\r\n  return { realFee };\r\n}\r\n\r\nexport async function* submitDnsRenewal(accountId: string, password: string | undefined, nftAddresses: string[]) {\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n  const maxMessages = getMaxMessagesInTransaction(account);\r\n  const nftBatches = split(nftAddresses, maxMessages);\r\n\r\n  for (const nftBatch of nftBatches) {\r\n    const messages: TonTransferParams[] = nftBatch.map(makeRenewMessage);\r\n\r\n    yield {\r\n      addresses: nftBatch,\r\n      result: await submitMultiTransfer({ accountId, password, messages }),\r\n    };\r\n  }\r\n}\r\n\r\nexport async function checkDnsChangeWalletDraft(accountId: string, nftAddress: string, address: string) {\r\n  const result = await checkMultiTransactionDraft(accountId, [makeChangeMessage(nftAddress, address)]);\r\n\r\n  if ('error' in result) {\r\n    return result;\r\n  }\r\n\r\n  return { realFee: result.emulation.networkFee + TON_GAS.changeDns };\r\n}\r\n\r\nexport function submitDnsChangeWallet(\r\n  accountId: string,\r\n  password: string | undefined,\r\n  nftAddress: string,\r\n  address: string,\r\n) {\r\n  return submitMultiTransfer({\r\n    accountId,\r\n    password,\r\n    messages: [makeChangeMessage(nftAddress, address)],\r\n  });\r\n}\r\n\r\nfunction makeRenewMessage(nftAddress: string) {\r\n  return {\r\n    toAddress: nftAddress,\r\n    payload: DnsItem.buildFillUpMessage(),\r\n    amount: TON_GAS.changeDns,\r\n  };\r\n}\r\n\r\nfunction makeChangeMessage(nftAddress: string, linkedAddress: string) {\r\n  return {\r\n    toAddress: nftAddress,\r\n    payload: DnsItem.buildChangeDnsWalletMessage(linkedAddress),\r\n    amount: TON_GAS.changeDns,\r\n  };\r\n}\r\n\r\nexport async function fetchDomains(accountId: string) {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n  const data = await callBackendGet<Record<string, ApiDomainData>>('/dns/getDomains', { address });\r\n  const nftSuperCollectionsByCollectionAddress = await getNftSuperCollectionsByCollectionAddress();\r\n\r\n  const expirationByAddress: Record<string, number> = {};\r\n  const linkedAddressByAddress: Record<string, string> = {};\r\n  const nfts: Record<string, ApiNft> = {};\r\n\r\n  Object.keys(data).forEach((nftAddress) => {\r\n    const { lastFillUpTime, linkedAddress, nft: rawNft } = data[nftAddress];\r\n    expirationByAddress[nftAddress] = new Date(lastFillUpTime).getTime() + YEAR;\r\n    if (linkedAddress) {\r\n      linkedAddressByAddress[nftAddress] = linkedAddress;\r\n    }\r\n    const nft = parseTonapiioNft(network, rawNft, nftSuperCollectionsByCollectionAddress);\r\n    if (nft) {\r\n      nfts[nftAddress] = nft;\r\n    }\r\n  });\r\n\r\n  return {\r\n    expirationByAddress,\r\n    linkedAddressByAddress,\r\n    nfts,\r\n  };\r\n}\r\n","import type { NftItem } from 'tonapi-sdk-js';\r\nimport type { Cell } from '@ton/core';\r\nimport { Address, Builder } from '@ton/core';\r\n\r\nimport type { ApiNft, ApiNftUpdate } from '../../types';\r\nimport type { ApiCheckTransactionDraftResult } from './types';\r\n\r\nimport {\r\n  BURN_ADDRESS,\r\n  NFT_BATCH_SIZE,\r\n  NOTCOIN_EXCHANGERS,\r\n  NOTCOIN_FORWARD_TON_AMOUNT,\r\n  NOTCOIN_VOUCHERS_ADDRESS,\r\n} from '../../../config';\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { bigintMultiplyToNumber } from '../../../util/bigint';\r\nimport { compact } from '../../../util/iteratees';\r\nimport { generateQueryId } from './util';\r\nimport { parseTonapiioNft } from './util/metadata';\r\nimport {\r\n  fetchAccountEvents, fetchAccountNfts, fetchNftByAddress, fetchNftItems,\r\n} from './util/tonapiio';\r\nimport { commentToBytes, packBytesAsSnake, toBase64Address } from './util/tonCore';\r\nimport { fetchStoredChainAccount, fetchStoredWallet } from '../../common/accounts';\r\nimport { getNftSuperCollectionsByCollectionAddress } from '../../common/addresses';\r\nimport {\r\n  NFT_PAYLOAD_SAFE_MARGIN,\r\n  NFT_TRANSFER_AMOUNT,\r\n  NFT_TRANSFER_FORWARD_AMOUNT,\r\n  NFT_TRANSFER_REAL_AMOUNT,\r\n  NftOpCode,\r\n} from './constants';\r\nimport { checkMultiTransactionDraft, checkToAddress, submitMultiTransfer } from './transfer';\r\nimport { isActiveSmartContract } from './wallet';\r\n\r\nexport async function getAccountNfts(accountId: string, options?: {\r\n  collectionAddress?: string;\r\n  offset?: number;\r\n  limit?: number;\r\n}): Promise<ApiNft[]> {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n  const nftSuperCollectionsByCollectionAddress = await getNftSuperCollectionsByCollectionAddress();\r\n\r\n  const rawNfts = await fetchAccountNfts(network, address, options);\r\n  return compact(rawNfts.map((rawNft) => parseTonapiioNft(network, rawNft, nftSuperCollectionsByCollectionAddress)));\r\n}\r\n\r\nexport async function checkNftOwnership(accountId: string, nftAddress: string) {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n  const rawNft = await fetchNftByAddress(network, nftAddress);\r\n  const nftSuperCollectionsByCollectionAddress = await getNftSuperCollectionsByCollectionAddress();\r\n\r\n  const nft = parseTonapiioNft(network, rawNft, nftSuperCollectionsByCollectionAddress);\r\n\r\n  return address === nft?.ownerAddress;\r\n}\r\n\r\nexport async function getNftUpdates(accountId: string, fromSec: number) {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n  const nftSuperCollectionsByCollectionAddress = await getNftSuperCollectionsByCollectionAddress();\r\n\r\n  const events = await fetchAccountEvents(network, address, fromSec);\r\n  fromSec = events[0]?.timestamp ?? fromSec;\r\n  events.reverse();\r\n  const updates: ApiNftUpdate[] = [];\r\n\r\n  for (const event of events) {\r\n    for (const action of event.actions) {\r\n      let to: string;\r\n      let nftAddress: string;\r\n      let rawNft: NftItem | undefined;\r\n      const isPurchase = !!action.NftPurchase;\r\n\r\n      if (action.NftItemTransfer) {\r\n        const { sender, recipient, nft: rawNftAddress } = action.NftItemTransfer;\r\n        if (!sender || !recipient) continue;\r\n        to = recipient.address;\r\n        nftAddress = toBase64Address(rawNftAddress, true, network);\r\n      } else if (action.NftPurchase) {\r\n        const { buyer } = action.NftPurchase;\r\n        to = buyer.address;\r\n        rawNft = action.NftPurchase.nft;\r\n        if (!rawNft) {\r\n          continue;\r\n        }\r\n        nftAddress = toBase64Address(rawNft.address, true, network);\r\n      } else {\r\n        continue;\r\n      }\r\n\r\n      if (Address.parse(to).equals(Address.parse(address))) {\r\n        if (!rawNft) {\r\n          [rawNft] = await fetchNftItems(network, [nftAddress]);\r\n        }\r\n\r\n        if (rawNft) {\r\n          const nft = parseTonapiioNft(network, rawNft, nftSuperCollectionsByCollectionAddress);\r\n\r\n          if (nft) {\r\n            updates.push({\r\n              type: 'nftReceived',\r\n              accountId,\r\n              nftAddress,\r\n              nft,\r\n            });\r\n          }\r\n        }\r\n      } else if (!isPurchase && await isActiveSmartContract(network, to)) {\r\n        updates.push({\r\n          type: 'nftPutUpForSale',\r\n          accountId,\r\n          nftAddress,\r\n        });\r\n      } else {\r\n        updates.push({\r\n          type: 'nftSent',\r\n          accountId,\r\n          nftAddress,\r\n          newOwnerAddress: to,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  return [fromSec, updates] as [number, ApiNftUpdate[]];\r\n}\r\n\r\nexport async function checkNftTransferDraft(options: {\r\n  accountId: string;\r\n  nfts: ApiNft[];\r\n  toAddress: string;\r\n  comment?: string;\r\n}): Promise<ApiCheckTransactionDraftResult> {\r\n  const { accountId, nfts, comment } = options;\r\n  let { toAddress } = options;\r\n\r\n  const { network } = parseAccountId(accountId);\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n  const { address: fromAddress } = account.byChain.ton;\r\n\r\n  const result: ApiCheckTransactionDraftResult = await checkToAddress(network, toAddress);\r\n  if ('error' in result) {\r\n    return result;\r\n  }\r\n\r\n  toAddress = result.resolvedAddress!;\r\n\r\n  const messages = nfts\r\n    .slice(0, account.type === 'ledger' ? 1 : NFT_BATCH_SIZE) // We only need to check the first batch of a multi-transaction\r\n    .map((nft) => buildNftTransferMessage(nft, fromAddress, toAddress, comment, account.type === 'ledger'));\r\n\r\n  const checkResult = await checkMultiTransactionDraft(accountId, messages);\r\n\r\n  if (checkResult.emulation) {\r\n    // todo: Use `received` from the emulation to calculate the real fee. Check what happens when the receiver is the same wallet.\r\n    const batchFee = checkResult.emulation.networkFee;\r\n    result.fee = calculateNftTransferFee(nfts.length, messages.length, batchFee, NFT_TRANSFER_AMOUNT);\r\n    result.realFee = calculateNftTransferFee(nfts.length, messages.length, batchFee, NFT_TRANSFER_REAL_AMOUNT);\r\n  }\r\n\r\n  if ('error' in checkResult) {\r\n    result.error = checkResult.error;\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nexport async function submitNftTransfers(options: {\r\n  accountId: string;\r\n  password: string | undefined;\r\n  nfts: ApiNft[];\r\n  toAddress: string;\r\n  comment?: string;\r\n}) {\r\n  const {\r\n    accountId, password, nfts, toAddress, comment,\r\n  } = options;\r\n\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n  const { address: fromAddress } = account.byChain.ton;\r\n\r\n  const messages = nfts.map(\r\n    (nft) => buildNftTransferMessage(nft, fromAddress, toAddress, comment, account.type === 'ledger'),\r\n  );\r\n  return submitMultiTransfer({ accountId, password, messages });\r\n}\r\n\r\nfunction buildNftTransferMessage(\r\n  nft: ApiNft,\r\n  fromAddress: string,\r\n  toAddress: string,\r\n  comment?: string,\r\n  isLedger?: boolean,\r\n) {\r\n  const isNotcoinBurn = nft.collectionAddress === NOTCOIN_VOUCHERS_ADDRESS\r\n    && (toAddress === BURN_ADDRESS || NOTCOIN_EXCHANGERS.includes(toAddress as any));\r\n  const payload = isNotcoinBurn\r\n    ? buildNotcoinVoucherExchange(fromAddress, nft.address, nft.index, isLedger)\r\n    : buildNftTransferPayload(fromAddress, toAddress, comment, undefined, isLedger);\r\n\r\n  return {\r\n    payload,\r\n    amount: NFT_TRANSFER_AMOUNT,\r\n    toAddress: nft.address,\r\n  };\r\n}\r\n\r\nfunction buildNotcoinVoucherExchange(\r\n  fromAddress: string,\r\n  nftAddress: string,\r\n  nftIndex: number,\r\n  isLedger?: boolean,\r\n) {\r\n  const first4Bits = Address.parse(nftAddress).hash.readUint8() >> 4;\r\n  const toAddress = NOTCOIN_EXCHANGERS[first4Bits];\r\n\r\n  const payload = new Builder()\r\n    .storeUint(0x5fec6642, 32)\r\n    .storeUint(nftIndex, 64)\r\n    .endCell();\r\n\r\n  return buildNftTransferPayload(fromAddress, toAddress, payload, NOTCOIN_FORWARD_TON_AMOUNT, isLedger);\r\n}\r\n\r\nexport function buildNftTransferPayload(\r\n  fromAddress: string,\r\n  toAddress: string,\r\n  payload?: string | Cell,\r\n  forwardAmount = NFT_TRANSFER_FORWARD_AMOUNT,\r\n  isLedger?: boolean,\r\n) {\r\n  // In ledger-app-ton v2.7.0 a queryId not equal to 0 is handled incorrectly.\r\n  const queryId = isLedger ? 0n : generateQueryId();\r\n\r\n  let builder = new Builder()\r\n    .storeUint(NftOpCode.TransferOwnership, 32)\r\n    .storeUint(queryId, 64)\r\n    .storeAddress(Address.parse(toAddress))\r\n    .storeAddress(Address.parse(fromAddress))\r\n    .storeBit(false) // null custom_payload\r\n    .storeCoins(forwardAmount);\r\n\r\n  let forwardPayload: Cell | Uint8Array | undefined;\r\n\r\n  if (payload) {\r\n    if (typeof payload === 'string') {\r\n      const bytes = commentToBytes(payload);\r\n      const freeBytes = Math.floor((builder.availableBits - NFT_PAYLOAD_SAFE_MARGIN) / 8);\r\n      forwardPayload = packBytesAsSnake(bytes, freeBytes);\r\n    } else {\r\n      forwardPayload = payload;\r\n    }\r\n  }\r\n\r\n  if (forwardPayload instanceof Uint8Array) {\r\n    builder.storeBit(0);\r\n    builder = builder.storeBuffer(Buffer.from(forwardPayload));\r\n  } else {\r\n    builder = builder.storeMaybeRef(forwardPayload);\r\n  }\r\n\r\n  return builder.endCell();\r\n}\r\n\r\nexport function calculateNftTransferFee(\r\n  totalNftCount: number,\r\n  // How many NFTs were added to the multi-transaction before estimating it\r\n  estimatedBatchSize: number,\r\n  // The blockchain fee of the estimated multi-transaction\r\n  estimatedBatchBlockchainFee: bigint,\r\n  // How much TON is attached to each NFT during the transfer\r\n  amountPerNft: bigint,\r\n) {\r\n  const fullBatchCount = Math.floor(totalNftCount / estimatedBatchSize);\r\n  let remainingBatchSize = totalNftCount % estimatedBatchSize;\r\n\r\n  // The blockchain fee for the first NFT in a batch is almost twice higher than the fee for the other NFTs. Therefore,\r\n  // simply using the average NFT fee to calculate the last incomplete batch fee gives an insufficient number. To fix\r\n  // that, we increase the last batch size.\r\n  //\r\n  // A real life example:\r\n  // 1 NFT  in the batch: 0.002939195 TON\r\n  // 2 NFTs in the batch: 0.004470516 TON\r\n  // 3 NFTs in the batch: 0.006001837 TON\r\n  // 4 NFTs in the batch: 0.007533158 TON\r\n  if (remainingBatchSize > 0 && remainingBatchSize < estimatedBatchSize) {\r\n    remainingBatchSize += 1;\r\n  }\r\n\r\n  const totalBlockchainFee = bigintMultiplyToNumber(\r\n    estimatedBatchBlockchainFee,\r\n    (fullBatchCount * estimatedBatchSize + remainingBatchSize) / estimatedBatchSize,\r\n  );\r\n  return totalBlockchainFee + BigInt(totalNftCount) * amountPerNft;\r\n}\r\n","type OnSwitch = (isOn: boolean) => void;\r\n\r\n/**\r\n * A virtual multi-input OR gate (https://en.wikipedia.org/wiki/OR_gate).\r\n * Triggers the callback when the gate output changes.\r\n */\r\nexport class OrGate<T> {\r\n  #enabledItems = new Set<T>();\r\n  #onSwitch: OnSwitch;\r\n\r\n  constructor(onSwitch: OnSwitch) {\r\n    this.#onSwitch = onSwitch;\r\n  }\r\n\r\n  get isOn() {\r\n    return this.#enabledItems.size > 0;\r\n  }\r\n\r\n  on(item: T) {\r\n    this.toggle(item, true);\r\n  }\r\n\r\n  off(item: T) {\r\n    this.toggle(item, false);\r\n  }\r\n\r\n  toggle(item: T, isItemOn: boolean) {\r\n    const prevIsOn = this.isOn;\r\n    this.#enabledItems[isItemOn ? 'add' : 'delete'](item);\r\n    const nextIsOn = this.isOn;\r\n\r\n    if (prevIsOn !== nextIsOn) {\r\n      this.#onSwitch(nextIsOn);\r\n    }\r\n  }\r\n}\r\n","import type { ApiActivity } from '../../types';\r\nimport type { ActivityStream, OnActivityUpdate, OnLoadingChange } from './toncenter';\r\n\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { mergeSortedActivities } from '../../../util/activities/order';\r\nimport { createCallbackManager } from '../../../util/callbacks';\r\nimport { areSortedArraysEqual, extractKey } from '../../../util/iteratees';\r\nimport { OrGate } from '../../../util/orGate';\r\nimport { throttle } from '../../../util/schedulers';\r\nimport { fetchStoredWallet } from '../../common/accounts';\r\nimport { swapReplaceCexActivities } from '../../common/swap';\r\nimport { reloadIncompleteActivities } from './activities';\r\n\r\n/**\r\n * Like `ActivityStream` but applies `enrichActivities` to the confirmed activities.\r\n *\r\n * @see enrichActivities\r\n */\r\nexport class RichActivityStream {\r\n  #accountId: string;\r\n\r\n  /** Sorted by timestamp descending */\r\n  #confirmedActivitiesToReport: ApiActivity[] = [];\r\n\r\n  #pendingActivities = managePendingActivities();\r\n\r\n  #isLoading = new OrGate<'raw' | 'enrich'>((isLoading) => this.#loadingListeners.runCallbacks(isLoading));\r\n\r\n  #updateListeners = createCallbackManager<OnActivityUpdate>();\r\n  #triggerUpdateListeners = deduplicateActivityUpdates(this.#updateListeners.runCallbacks);\r\n  #loadingListeners = createCallbackManager<OnLoadingChange>();\r\n\r\n  #isDestroyed = false;\r\n\r\n  #onDestroy: NoneToVoidFunction[];\r\n\r\n  constructor(\r\n    accountId: string,\r\n    rawActivityStream: ActivityStream,\r\n  ) {\r\n    this.#accountId = accountId;\r\n\r\n    this.#onDestroy = [\r\n      rawActivityStream.onUpdate(this.#handleRawActivitiesUpdate),\r\n      rawActivityStream.onLoadingChange((isLoading) => this.#isLoading.toggle('raw', isLoading)),\r\n    ];\r\n  }\r\n\r\n  /**\r\n   * Registers a callback firing then new activities arrive.\r\n   * The callback is throttled under the hood.\r\n   */\r\n  public onUpdate(callback: OnActivityUpdate) {\r\n    return this.#updateListeners.addCallback(callback);\r\n  }\r\n\r\n  /**\r\n   * Registers a callback firing when the data from HTTP endpoints starts of finishes loading.\r\n   * The \"loading\" state includes the time when `rawActivityStream` is polling.\r\n   */\r\n  public onLoadingChange(callback: OnLoadingChange) {\r\n    return this.#loadingListeners.addCallback(callback);\r\n  }\r\n\r\n  public destroy() {\r\n    this.#isDestroyed = true;\r\n\r\n    for (const unsubscribe of this.#onDestroy) {\r\n      unsubscribe();\r\n    }\r\n  }\r\n\r\n  #handleRawActivitiesUpdate: OnActivityUpdate = (confirmedActivities, pendingActivities) => {\r\n    this.#pendingActivities.updateAfterRawUpdate(confirmedActivities, pendingActivities);\r\n    this.#reportActivities([]);\r\n\r\n    if (confirmedActivities.length) {\r\n      this.#confirmedActivitiesToReport.unshift(...confirmedActivities);\r\n      this.#enrichAndReportActivities();\r\n    }\r\n  };\r\n\r\n  // Using `throttle` to batch the new activities and ensure that they are reported in the order they were received\r\n  #enrichAndReportActivities = throttle(async () => {\r\n    if (this.#isDestroyed) return;\r\n\r\n    try {\r\n      this.#isLoading.on('enrich');\r\n\r\n      const rawConfirmedActivities = this.#confirmedActivitiesToReport;\r\n      this.#confirmedActivitiesToReport = [];\r\n      const richConfirmedActivities = await enrichActivities(this.#accountId, rawConfirmedActivities);\r\n\r\n      this.#pendingActivities.updateAfterEnrichment(rawConfirmedActivities);\r\n      this.#reportActivities(richConfirmedActivities);\r\n    } finally {\r\n      this.#isLoading.off('enrich');\r\n    }\r\n  }, 0);\r\n\r\n  #reportActivities(confirmedActivities: ApiActivity[]) {\r\n    if (!this.#isDestroyed) {\r\n      this.#triggerUpdateListeners(confirmedActivities, this.#pendingActivities.all);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Manages pending activities to ensure that switching activities from pending to confirmed is seamless.\r\n * If not used, the pending activities received from `ActivityStream` will disappear temporarily while the confirmed\r\n * activities are being enriched.\r\n */\r\nfunction managePendingActivities() {\r\n  /** The latest pending activities provided by `rawActivityStream` */\r\n  let pendingActivities: readonly ApiActivity[] = [];\r\n  /** Pending activities that no longer exist but their corresponding confirmed activities are being enriched */\r\n  let zombiePendingActivities: ApiActivity[] = [];\r\n\r\n  const updateAfterRawUpdate: OnActivityUpdate = (confirmedActivities, newPendingActivities) => {\r\n    const confirmedHashes = new Set(extractKey(confirmedActivities, 'externalMsgHashNorm'));\r\n\r\n    zombiePendingActivities = mergeSortedActivities(\r\n      zombiePendingActivities,\r\n      pendingActivities.filter((activity) => confirmedHashes.has(activity.externalMsgHashNorm)),\r\n    );\r\n\r\n    pendingActivities = newPendingActivities;\r\n  };\r\n\r\n  const updateAfterEnrichment = (rawConfirmedActivities: ApiActivity[]) => {\r\n    const confirmedHashes = new Set(extractKey(rawConfirmedActivities, 'externalMsgHashNorm'));\r\n\r\n    zombiePendingActivities = zombiePendingActivities\r\n      .filter((activity) => !confirmedHashes.has(activity.externalMsgHashNorm));\r\n  };\r\n\r\n  return {\r\n    /** Sorted by timestamp descending */\r\n    get all() {\r\n      return mergeSortedActivities(pendingActivities, zombiePendingActivities);\r\n    },\r\n    updateAfterRawUpdate,\r\n    updateAfterEnrichment,\r\n  };\r\n}\r\n\r\n/**\r\n * Makes sure the update callback is not called uselessly. For example, with no confirmed activities and with the\r\n * same pending activities.\r\n */\r\nfunction deduplicateActivityUpdates(onUpdate: OnActivityUpdate): OnActivityUpdate {\r\n  let lastPendingActivities: readonly ApiActivity[] = [];\r\n\r\n  return (newConfirmedActivities, pendingActivities) => {\r\n    if (newConfirmedActivities.length || !areSortedArraysEqual(lastPendingActivities, pendingActivities)) {\r\n      onUpdate(newConfirmedActivities, pendingActivities);\r\n    }\r\n\r\n    lastPendingActivities = pendingActivities;\r\n  };\r\n}\r\n\r\nasync function enrichActivities(accountId: string, activities: ApiActivity[]) {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  activities = await reloadIncompleteActivities(network, address, activities);\r\n  activities = await swapReplaceCexActivities(accountId, activities, undefined, true);\r\n\r\n  return activities;\r\n}\r\n","/*\r\nTo activate dev setting, enter `devSettings.simulateLongUnstaking = true;` in the browser console,\r\neither in the main frame or in the worker (different commands for different frames).\r\n*/\r\n\r\ndeclare const self: (WorkerGlobalScope | Window) & {\r\n  devSettings: {\r\n    simulateLongUnstaking?: boolean;\r\n  };\r\n};\r\n\r\nexport function getDevSettings() {\r\n  return self.devSettings ?? {};\r\n}\r\n\r\nself.devSettings = {};\r\n","import type { Address, Cell, ContractProvider } from '@ton/core';\r\nimport { beginCell } from '@ton/core';\r\n\r\nimport { JettonWallet } from '../JettonWallet';\r\n\r\nenum OpCode {\r\n  transfer_timelocked = 0xd750cec9,\r\n}\r\n\r\nexport class TsUSDeWallet extends JettonWallet {\r\n  constructor(readonly address: Address) {\r\n    super(address);\r\n  }\r\n\r\n  static createFromAddress(address: Address) {\r\n    return new TsUSDeWallet(address);\r\n  }\r\n\r\n  async getTimeLockData(provider: ContractProvider): Promise<{\r\n    lockedUsdeBalance: bigint;\r\n    unlockTime?: number;\r\n  }> {\r\n    try {\r\n      const stack = (await provider.get('get_timelock_data', [])).stack;\r\n      const lockedUsdeBalance = stack.readBigNumber();\r\n      const unlockTime = stack.readNumber();\r\n      return { lockedUsdeBalance, unlockTime };\r\n    } catch (err: any) {\r\n      if (err.message?.includes('exit_code: -13')) {\r\n        return { lockedUsdeBalance: 0n };\r\n      } else {\r\n        throw err;\r\n      }\r\n    }\r\n  }\r\n\r\n  static transferTimelockedMessage(options: {\r\n    jettonAmount: bigint;\r\n    to: Address;\r\n    responseAddress?: Address;\r\n    customPayload?: Cell;\r\n    forwardTonAmount: bigint;\r\n    forwardPayload?: Cell;\r\n  }) {\r\n    return beginCell()\r\n      .storeUint(OpCode.transfer_timelocked, 32)\r\n      .storeUint(0, 64) // op, queryId\r\n      .storeCoins(options.jettonAmount)\r\n      .storeAddress(options.to)\r\n      .storeAddress(options.responseAddress)\r\n      .storeMaybeRef(options.customPayload)\r\n      .storeCoins(options.forwardTonAmount)\r\n      .storeMaybeRef(options.forwardPayload)\r\n      .endCell();\r\n  }\r\n}\r\n","import type {\r\n  Cell, Contract, ContractProvider,\r\n} from '@ton/core';\r\nimport {\r\n  Address, beginCell, contractAddress, TupleReader,\r\n} from '@ton/core';\r\n\r\nexport type NominatorPoolConfig = object;\r\n\r\nexport type Nominator = {\r\n  address: Address;\r\n  amount: bigint;\r\n  pendingDepositAmount: bigint;\r\n  withdrawRequested: boolean;\r\n};\r\n\r\nexport function nominatorPoolConfigToCell(config: NominatorPoolConfig): Cell {\r\n  return beginCell().endCell();\r\n}\r\n\r\nexport class NominatorPool implements Contract {\r\n  constructor(readonly address: Address, readonly init?: { code: Cell; data: Cell }) {}\r\n\r\n  static createFromAddress(address: Address) {\r\n    return new NominatorPool(address);\r\n  }\r\n\r\n  static createFromConfig(config: NominatorPoolConfig, code: Cell, workchain = 0) {\r\n    const data = nominatorPoolConfigToCell(config);\r\n    const init = { code, data };\r\n    return new NominatorPool(contractAddress(workchain, init), init);\r\n  }\r\n\r\n  async getListNominators(provider: ContractProvider): Promise<Nominator[]> {\r\n    const res = await provider.get('list_nominators', []);\r\n    const tupleReader = (res.stack).readTuple();\r\n    const itemsArray = (tupleReader as any).items as bigint[][];\r\n\r\n    return itemsArray.map((items: bigint[]) => {\r\n      const tupleItems = items.map((value) => ({ type: 'int' as const, value }));\r\n      const tuple = new TupleReader(tupleItems);\r\n\r\n      const hash = tuple.readBigNumber().toString(16).padStart(64, '0');\r\n      const address = Address.parse(`0:${hash}`);\r\n      const amount = tuple.readBigNumber();\r\n      const pendingDepositAmount = tuple.readBigNumber();\r\n      const withdrawRequested = Boolean(tuple.readNumber());\r\n\r\n      return {\r\n        address,\r\n        amount,\r\n        pendingDepositAmount,\r\n        withdrawRequested,\r\n      };\r\n    });\r\n  }\r\n}\r\n","import { randomBytes } from '../../util/random';\r\nimport { storage } from '../storages';\r\n\r\nlet clientId: string | undefined;\r\nlet referrer: string | undefined;\r\n\r\nexport async function getClientId() {\r\n  if (!clientId) {\r\n    [clientId, referrer] = await Promise.all([\r\n      storage.getItem('clientId'),\r\n      storage.getItem('referrer'),\r\n    ]);\r\n  }\r\n\r\n  if (clientId) {\r\n    const parts = clientId.split(':', 1);\r\n    if (!parts[1] && referrer) {\r\n      clientId = `${parts[0]}:${referrer}`;\r\n      void storage.setItem('clientId', clientId);\r\n    }\r\n  } else {\r\n    const hex = Buffer.from(randomBytes(10)).toString('hex');\r\n    clientId = `${hex}:${referrer ?? ''}`;\r\n    void storage.setItem('clientId', clientId);\r\n  }\r\n\r\n  return clientId;\r\n}\r\n","import { Address } from '@ton/core';\r\n\r\nimport type {\r\n  ApiBackendStakingState,\r\n  ApiBalanceBySlug,\r\n  ApiEthenaStakingState,\r\n  ApiJettonStakingState,\r\n  ApiLoyaltyType,\r\n  ApiNetwork,\r\n  ApiStakingCommonData,\r\n  ApiStakingJettonPool,\r\n  ApiStakingState,\r\n} from '../../types';\r\nimport type { StakingPoolConfigUnpacked } from './contracts/JettonStaking/StakingPool';\r\nimport type { ApiCheckTransactionDraftResult, ApiSubmitTransferTonResult, TonTransferParams } from './types';\r\nimport { ApiLiquidUnstakeMode, ApiTransactionDraftError } from '../../types';\r\n\r\nimport {\r\n  DEBUG,\r\n  ETHENA_STAKING_VAULT,\r\n  LIQUID_JETTON,\r\n  LIQUID_POOL,   //update our wallet id base64\r\n  TON_TSUSDE,\r\n  TON_USDE,\r\n  TONCOIN,\r\n  UNSTAKE_TON_GRACE_PERIOD,\r\n  VALIDATION_PERIOD_MS,\r\n} from '../../../config';\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { bigintDivideToNumber, bigintMultiplyToNumber } from '../../../util/bigint';\r\nimport { fromDecimal } from '../../../util/decimals';\r\nimport { getDevSettings } from '../../../util/devSettings';\r\nimport { getIsActiveStakingState } from '../../../util/staking';\r\nimport calcJettonStakingApr from '../../../util/ton/calcJettonStakingApr';\r\nimport {\r\n  buildJettonClaimPayload,\r\n  buildJettonUnstakePayload,\r\n  buildLiquidStakingDepositBody,\r\n  buildLiquidStakingWithdrawBody,\r\n  getJettonPoolStakeWallet,\r\n  getTonClient,\r\n  resolveTokenWalletAddress,\r\n  toBase64Address,\r\n  unpackDicts,\r\n} from './util/tonCore';\r\nimport { TsUSDeWallet } from './contracts/Ethena/TsUSDeWallet';\r\nimport { StakeWallet } from './contracts/JettonStaking/StakeWallet';\r\nimport { StakingPool } from './contracts/JettonStaking/StakingPool';\r\nimport { NominatorPool } from './contracts/NominatorPool';\r\nimport { fetchStoredChainAccount, fetchStoredWallet } from '../../common/accounts';\r\nimport { callBackendGet } from '../../common/backend';\r\nimport { getAccountCache, getStakingCommonCache, updateAccountCache } from '../../common/cache';\r\nimport { getClientId } from '../../common/other';\r\nimport { buildTokenSlug, getTokenByAddress, getTokenBySlug } from '../../common/tokens';\r\nimport { isKnownStakingPool } from '../../common/utils';\r\nimport { STAKE_COMMENT, TON_GAS, UNSTAKE_COMMENT } from './constants';\r\nimport { checkTransactionDraft, submitTransfer } from './transfer';\r\n\r\nexport async function checkStakeDraft(accountId: string, amount: bigint, state: ApiStakingState) {\r\n  let result: ApiCheckTransactionDraftResult;\r\n\r\n  switch (state.type) {\r\n    case 'nominators': {\r\n      if (amount < TON_GAS.stakeNominators) {\r\n        return { error: ApiTransactionDraftError.InvalidAmount };\r\n      }\r\n\r\n      result = await checkTransactionDraft({\r\n        accountId,\r\n        toAddress: state.pool,\r\n        amount: amount + TON_GAS.stakeNominators,\r\n        data: STAKE_COMMENT,\r\n      });\r\n      if ('fee' in result && result.fee) {\r\n        result.fee = TON_GAS.stakeNominators + result.fee;\r\n      }\r\n      break;\r\n    }\r\n    case 'liquid': {\r\n      result = await checkTransactionDraft({\r\n        accountId,\r\n        toAddress: LIQUID_POOL,\r\n        amount: amount + TON_GAS.stakeLiquid,\r\n        data: buildLiquidStakingDepositBody(),\r\n      });\r\n      if ('fee' in result && result.fee) {\r\n        result.fee = TON_GAS.stakeLiquid + result.fee;\r\n      }\r\n      break;\r\n    }\r\n    case 'jetton': {\r\n      const { tokenSlug, pool, period } = state;\r\n      const { tokenAddress } = getTokenBySlug(tokenSlug)!;\r\n\r\n      result = await checkTransactionDraft({\r\n        accountId,\r\n        toAddress: pool,\r\n        tokenAddress,\r\n        amount,\r\n        data: StakingPool.stakePayload(period),\r\n        forwardAmount: TON_GAS.stakeJettonsForward,\r\n      });\r\n      break;\r\n    }\r\n    case 'ethena': {\r\n      result = await checkTransactionDraft({\r\n        accountId,\r\n        toAddress: ETHENA_STAKING_VAULT,\r\n        tokenAddress: TON_USDE.tokenAddress,\r\n        amount,\r\n        forwardAmount: TON_GAS.stakeEthenaForward,\r\n      });\r\n      break;\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nexport async function checkUnstakeDraft(accountId: string, amount: bigint, state: ApiStakingState) {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n  const commonData = await getStakingCommonCache();\r\n\r\n  let result: ApiCheckTransactionDraftResult;\r\n  let tokenAmount: bigint | undefined;\r\n\r\n  switch (state.type) {\r\n    case 'nominators': {\r\n      result = await checkTransactionDraft({\r\n        accountId,\r\n        toAddress: state.pool,\r\n        amount: TON_GAS.unstakeNominators,\r\n        data: UNSTAKE_COMMENT,\r\n      });\r\n      break;\r\n    }\r\n    case 'liquid': {\r\n      if (amount > state.balance) {\r\n        return { error: ApiTransactionDraftError.InsufficientBalance };\r\n      } else if (amount === state.balance) {\r\n        tokenAmount = state.tokenBalance;\r\n      } else {\r\n        tokenAmount = bigintDivideToNumber(amount, commonData.liquid.currentRate);\r\n      }\r\n\r\n      const params = await buildLiquidStakingWithdraw(network, address, tokenAmount);\r\n\r\n      result = await checkTransactionDraft({\r\n        accountId,\r\n        toAddress: params.toAddress,\r\n        amount: params.amount,\r\n        data: params.payload,\r\n      });\r\n      break;\r\n    }\r\n    case 'jetton': {\r\n      tokenAmount = amount;\r\n\r\n      result = await checkTransactionDraft({\r\n        accountId,\r\n        toAddress: state.stakeWalletAddress,\r\n        amount: TON_GAS.unstakeJettons,\r\n        data: buildJettonUnstakePayload(amount, true),\r\n      });\r\n      break;\r\n    }\r\n    case 'ethena': {\r\n      if (amount > state.balance) {\r\n        return { error: ApiTransactionDraftError.InsufficientBalance };\r\n      } else if (amount === state.balance) {\r\n        tokenAmount = state.tokenBalance;\r\n      } else {\r\n        const rate = network === 'testnet' ? 1 : commonData.ethena.rate;\r\n        tokenAmount = bigintDivideToNumber(amount, rate);\r\n      }\r\n\r\n      result = await checkTransactionDraft({\r\n        accountId,\r\n        toAddress: TON_TSUSDE.tokenAddress,\r\n        amount: tokenAmount,\r\n        tokenAddress: TON_TSUSDE.tokenAddress,\r\n        forwardAmount: TON_GAS.unstakeEthenaForward,\r\n      });\r\n      break;\r\n    }\r\n  }\r\n\r\n  return {\r\n    ...result,\r\n    type: state.type,\r\n    tokenAmount,\r\n  };\r\n}\r\n\r\nexport async function submitStake(\r\n  accountId: string,\r\n  password: string | undefined,\r\n  amount: bigint,\r\n  state: ApiStakingState,\r\n) {\r\n  let result: ApiSubmitTransferTonResult;\r\n\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  switch (state.type) {\r\n    case 'nominators': {\r\n      result = await submitTransfer({\r\n        accountId,\r\n        password,\r\n        toAddress: toBase64Address(state.pool, true, network),\r\n        amount: amount + TON_GAS.stakeNominators,\r\n        data: STAKE_COMMENT,\r\n      });\r\n      break;\r\n    }\r\n    case 'liquid': {\r\n      result = await submitTransfer({\r\n        accountId,\r\n        password,\r\n        toAddress: LIQUID_POOL,\r\n        amount: amount + TON_GAS.stakeLiquid,\r\n        data: buildLiquidStakingDepositBody(),\r\n      });\r\n      break;\r\n    }\r\n    case 'jetton': {\r\n      const { tokenSlug, pool, period } = state;\r\n      const { tokenAddress } = getTokenBySlug(tokenSlug)!;\r\n\r\n      result = await submitTransfer({\r\n        accountId,\r\n        password,\r\n        toAddress: pool,\r\n        tokenAddress,\r\n        amount,\r\n        data: StakingPool.stakePayload(period),\r\n        forwardAmount: TON_GAS.stakeJettonsForward,\r\n      });\r\n      if (!('error' in result)) {\r\n        result.toAddress = pool;\r\n      }\r\n      break;\r\n    }\r\n    case 'ethena': {\r\n      result = await submitTransfer({\r\n        accountId,\r\n        password,\r\n        toAddress: ETHENA_STAKING_VAULT,\r\n        tokenAddress: TON_USDE.tokenAddress,\r\n        amount,\r\n        forwardAmount: TON_GAS.stakeEthenaForward,\r\n      });\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (!('error' in result)) {\r\n    updateAccountCache(accountId, address, { stakedAt: Date.now() });\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nexport async function submitUnstake(\r\n  accountId: string,\r\n  password: string | undefined,\r\n  amount: bigint,\r\n  state: ApiStakingState,\r\n) {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  let result: ApiSubmitTransferTonResult;\r\n\r\n  switch (state.type) {\r\n    case 'nominators': {\r\n      result = await submitTransfer({\r\n        accountId,\r\n        password,\r\n        toAddress: toBase64Address(state.pool, true, network),\r\n        amount: TON_GAS.unstakeNominators,\r\n        data: UNSTAKE_COMMENT,\r\n      });\r\n      break;\r\n    }\r\n    case 'liquid': {\r\n      const mode = !state.instantAvailable\r\n        ? ApiLiquidUnstakeMode.BestRate\r\n        : ApiLiquidUnstakeMode.Default;\r\n\r\n      const params = await buildLiquidStakingWithdraw(network, address, amount, mode);\r\n\r\n      result = await submitTransfer({\r\n        accountId,\r\n        password,\r\n        toAddress: params.toAddress,\r\n        amount: params.amount,\r\n        data: params.payload,\r\n      });\r\n      break;\r\n    }\r\n    case 'jetton': {\r\n      result = await submitTransfer({\r\n        accountId,\r\n        password,\r\n        toAddress: state.stakeWalletAddress,\r\n        amount: TON_GAS.unstakeJettons,\r\n        data: buildJettonUnstakePayload(amount, true),\r\n      });\r\n      break;\r\n    }\r\n    case 'ethena': {\r\n      result = await submitTransfer({\r\n        accountId,\r\n        password,\r\n        toAddress: TON_TSUSDE.tokenAddress,\r\n        amount,\r\n        tokenAddress: TON_TSUSDE.tokenAddress,\r\n        forwardAmount: TON_GAS.unstakeEthenaForward,\r\n      });\r\n      if (!('error' in result)) {\r\n        result.localActivityParams = {\r\n          slug: TON_TSUSDE.slug,\r\n          amount: 0n,\r\n          toAddress: TON_TSUSDE.tokenAddress,\r\n        };\r\n      }\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nexport async function buildLiquidStakingWithdraw(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  amount: bigint,\r\n  mode: ApiLiquidUnstakeMode = ApiLiquidUnstakeMode.Default,\r\n): Promise<TonTransferParams> {\r\n  const tokenWalletAddress = await resolveTokenWalletAddress(network, address, LIQUID_JETTON);\r\n\r\n  const payload = buildLiquidStakingWithdrawBody({\r\n    amount,\r\n    responseAddress: address,\r\n    fillOrKill: mode === ApiLiquidUnstakeMode.Instant,\r\n    waitTillRoundEnd: mode === ApiLiquidUnstakeMode.BestRate,\r\n  });\r\n\r\n  return {\r\n    amount: TON_GAS.unstakeLiquid,\r\n    toAddress: tokenWalletAddress,\r\n    payload,\r\n  };\r\n}\r\n\r\ntype StakingStateOptions = {\r\n  accountId: string;\r\n  backendState: ApiBackendStakingState;\r\n  commonData: ApiStakingCommonData;\r\n  address: string;\r\n  loyaltyType?: ApiLoyaltyType;\r\n  network: ApiNetwork;\r\n  balances: ApiBalanceBySlug;\r\n};\r\n\r\nexport async function getStakingStates(\r\n  accountId: string,\r\n  commonData: ApiStakingCommonData,\r\n  backendState: ApiBackendStakingState,\r\n  balances: ApiBalanceBySlug,\r\n): Promise<ApiStakingState[]> {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  const {\r\n    loyaltyType,\r\n    shouldUseNominators,\r\n    type: backendType,\r\n  } = backendState;\r\n\r\n  const options: StakingStateOptions = {\r\n    accountId,\r\n    backendState,\r\n    commonData,\r\n    address,\r\n    loyaltyType,\r\n    network,\r\n    balances,\r\n  };\r\n\r\n  const promises: Promise<ApiStakingState>[] = [];\r\n\r\n  for (const poolConfig of commonData.jettonPools) {\r\n    const slug = buildTokenSlug('ton', poolConfig.token);\r\n    if (slug in balances) {\r\n      promises.push(buildJettonState(options, poolConfig));\r\n    }\r\n  }\r\n\r\n  if (shouldUseNominators || backendType === 'nominators') {\r\n    promises.push(buildNominatorsState(options));\r\n  }\r\n\r\n  if (TON_USDE.slug in balances && (!commonData.ethena.isDisabled || DEBUG)) {\r\n    promises.push(buildEthenaState(options));\r\n  }\r\n\r\n  return [buildLiquidState(options), ...await Promise.all(promises)];\r\n}\r\n\r\nfunction buildLiquidState({\r\n  accountId,\r\n  address,\r\n  backendState,\r\n  commonData,\r\n  loyaltyType,\r\n  balances,\r\n}: StakingStateOptions): ApiStakingState {\r\n  const { currentRate } = commonData.liquid;\r\n  const tokenSlug = buildTokenSlug('ton', LIQUID_JETTON);\r\n  const tokenBalance = balances[tokenSlug] ?? 0n;\r\n  const unstakeRequestAmount = fromDecimal(backendState.liquid?.unstakeRequestAmount ?? 0);\r\n\r\n  const accountCache = getAccountCache(accountId, address);\r\n  const stakedAt = Math.max(accountCache.stakedAt ?? 0, backendState.stakedAt ?? 0);\r\n\r\n  const isInstantUnstake = Date.now() - stakedAt > VALIDATION_PERIOD_MS && !getDevSettings().simulateLongUnstaking;\r\n  const liquidAvailable = isInstantUnstake ? commonData.liquid.available : 0n;\r\n  const { start, end } = getLiquidStakingTimeRange(commonData);\r\n\r\n  let liquidApy = commonData.liquid.apy;\r\n  if (loyaltyType && loyaltyType in commonData.liquid.loyaltyApy) {\r\n    liquidApy = commonData.liquid.loyaltyApy[loyaltyType];\r\n  }\r\n\r\n  const balance = bigintMultiplyToNumber(tokenBalance, currentRate) + unstakeRequestAmount;\r\n\r\n  return {\r\n    type: 'liquid',\r\n    id: 'liquid',\r\n    tokenSlug: TONCOIN.slug,\r\n    pool: LIQUID_POOL,\r\n    balance,\r\n    annualYield: liquidApy,\r\n    yieldType: 'APY',\r\n    tokenBalance,\r\n    unstakeRequestAmount,\r\n    instantAvailable: liquidAvailable,\r\n    start,\r\n    end,\r\n  };\r\n}\r\n\r\nasync function buildNominatorsState({\r\n  network,\r\n  address,\r\n  backendState,\r\n}: StakingStateOptions): Promise<ApiStakingState> {\r\n  const { address: pool, apy, start, end } = backendState.nominatorsPool;\r\n\r\n  const nominatorPool = getTonClient(network).open(new NominatorPool(Address.parse(pool)));\r\n  const nominators = await nominatorPool.getListNominators();\r\n  const addressObject = Address.parse(address);\r\n  const nominator = nominators.find((n) => n.address.equals(addressObject));\r\n\r\n  let balance = 0n;\r\n  if (backendState.type === 'nominators') {\r\n    // The backend state includes the loyalty bonus, so it takes priority.\r\n    balance = backendState.balance;\r\n  } else if (nominator) {\r\n    // A rare state when a user has two types of staking or switches between them.\r\n    balance = nominator.amount + nominator.pendingDepositAmount;\r\n  }\r\n\r\n  return {\r\n    type: 'nominators',\r\n    id: 'nominators',\r\n    tokenSlug: TONCOIN.slug,\r\n    balance,\r\n    annualYield: apy,\r\n    yieldType: 'APY',\r\n    pool,\r\n    start,\r\n    end: end + UNSTAKE_TON_GRACE_PERIOD,\r\n    unstakeRequestAmount: nominator?.withdrawRequested ? balance : 0n,\r\n  };\r\n}\r\n\r\nasync function buildJettonState(\r\n  options: StakingStateOptions,\r\n  pool: ApiStakingJettonPool,\r\n): Promise<ApiJettonStakingState> {\r\n  const { network } = options;\r\n\r\n  // common\r\n  const {\r\n    pool: poolAddress,\r\n    token: tokenAddress,\r\n    poolConfig,\r\n  } = pool;\r\n\r\n  const { decimals, slug: tokenSlug } = getTokenByAddress(tokenAddress)!;\r\n\r\n  // pool\r\n  const { tvl, rewardJettons } = unpackDicts(poolConfig) as StakingPoolConfigUnpacked;\r\n  const { rewardsDeposits } = Object.values(rewardJettons!)[0];\r\n  const now = Math.floor(Date.now() / 1000);\r\n\r\n  let dailyReward: bigint = 0n;\r\n  for (const { startTime, endTime, distributionSpeed } of Object.values(rewardsDeposits)) {\r\n    if (startTime < now && endTime > now) {\r\n      dailyReward += distributionSpeed;\r\n    }\r\n  }\r\n\r\n  const apr = calcJettonStakingApr({ tvl, dailyReward, decimals });\r\n\r\n  // wallet\r\n  const { address, balances } = options;\r\n  const periodConfig = pool.periods[0];\r\n  const stakedTokenSlug = buildTokenSlug('ton', periodConfig.token);\r\n\r\n  const stakeWallet = await getJettonPoolStakeWallet(network, poolAddress, periodConfig.period, address);\r\n\r\n  let unclaimedRewards = 0n;\r\n  let balance = 0n;\r\n  let poolWallets: string[] | undefined;\r\n\r\n  if (stakedTokenSlug in balances) { // Avoiding the request when it's unnecessary\r\n    const walletData = await stakeWallet.getStorageData().catch(() => undefined);\r\n\r\n    if (walletData) {\r\n      const poolWalletAddress = await resolveTokenWalletAddress(network, poolAddress, tokenAddress);\r\n      const rewards = StakeWallet.getAvailableRewards(walletData, poolConfig);\r\n      unclaimedRewards = (rewards && rewards[poolWalletAddress]) ?? 0n;\r\n      balance = walletData.jettonBalance;\r\n      poolWallets = Object.keys(rewards);\r\n    }\r\n  }\r\n\r\n  const state: ApiJettonStakingState = {\r\n    type: 'jetton',\r\n    id: poolAddress,\r\n    pool: poolAddress,\r\n    tokenAddress,\r\n    tokenSlug,\r\n    annualYield: apr,\r\n    yieldType: 'APR',\r\n    balance,\r\n    unclaimedRewards,\r\n    poolWallets,\r\n    stakeWalletAddress: toBase64Address(stakeWallet.address, true),\r\n    tokenAmount: 0n,\r\n    tvl,\r\n    dailyReward,\r\n    period: periodConfig.period,\r\n  };\r\n\r\n  return state;\r\n}\r\n\r\nasync function buildEthenaState(options: StakingStateOptions): Promise<ApiEthenaStakingState> {\r\n  const {\r\n    network, balances, address: walletAddress,\r\n    commonData, commonData: { ethena: { apy, apyVerified } },\r\n    backendState: { ethena: { isVerified } },\r\n  } = options;\r\n\r\n  const rate = network === 'testnet' ? 1 : commonData.ethena.rate;\r\n\r\n  const tonClient = getTonClient(network);\r\n  const tsUsdeWalletAddress = await resolveTokenWalletAddress(network, walletAddress, TON_TSUSDE.tokenAddress);\r\n  const tsUsdeWallet = tonClient.open(TsUSDeWallet.createFromAddress(Address.parse(tsUsdeWalletAddress)));\r\n  const { lockedUsdeBalance, unlockTime } = await tsUsdeWallet.getTimeLockData();\r\n\r\n  const tokenBalance = balances[TON_TSUSDE.slug] ?? 0n;\r\n  const balance = bigintMultiplyToNumber(tokenBalance, rate);\r\n\r\n  const state: ApiEthenaStakingState = {\r\n    id: 'ethena',\r\n    type: 'ethena',\r\n    tokenSlug: TON_USDE.slug,\r\n    yieldType: 'APY',\r\n    annualYield: isVerified ? apyVerified : apy,\r\n    annualYieldStandard: apy,\r\n    annualYieldVerified: apyVerified,\r\n    balance,\r\n    pool: ETHENA_STAKING_VAULT,\r\n    tokenBalance,\r\n    unstakeRequestAmount: lockedUsdeBalance,\r\n    unlockTime: unlockTime && lockedUsdeBalance ? unlockTime * 1000 : undefined,\r\n    tsUsdeWalletAddress,\r\n  };\r\n\r\n  // If the user never passed verification and has no active USDe staking, we should optimistically show the high APY.\r\n  if (isVerified === undefined && !getIsActiveStakingState(state)) {\r\n    state.annualYield = apyVerified;\r\n  }\r\n\r\n  return state;\r\n}\r\n\r\nfunction getLiquidStakingTimeRange(commonData: ApiStakingCommonData) {\r\n  const { prevRound, round: currentRound } = commonData;\r\n  const now = Date.now();\r\n  const gracePeriod = UNSTAKE_TON_GRACE_PERIOD;\r\n\r\n  const round = (\r\n    // Show date of next unlock plus few minutes\r\n    // (except when grace period is active and payout has already occurred  i.e. collection has disappeared).\r\n    (now > prevRound.unlock && now < prevRound.unlock + gracePeriod && !commonData.liquid.collection)\r\n    || now >= prevRound.unlock + gracePeriod\r\n  ) ? currentRound : prevRound;\r\n\r\n  return {\r\n    start: round.start,\r\n    end: round.unlock + gracePeriod,\r\n  };\r\n}\r\n\r\nexport async function getBackendStakingState(accountId: string): Promise<ApiBackendStakingState> {\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n  return fetchBackendStakingState(account.byChain.ton.address, account.type === 'view');\r\n}\r\n\r\nexport async function fetchBackendStakingState(address: string, isViewOnly: boolean): Promise<ApiBackendStakingState> {\r\n  const clientId = await getClientId();\r\n  const stakingState = await callBackendGet(`/staking/state/${address}`, {\r\n    isViewMode: isViewOnly ? 1 : undefined,\r\n  }, {\r\n    'X-App-ClientID': clientId,\r\n  });\r\n\r\n  stakingState.balance = fromDecimal(stakingState.balance);\r\n  stakingState.totalProfit = fromDecimal(stakingState.totalProfit);\r\n\r\n  if (!isKnownStakingPool(stakingState.nominatorsPool.address)) {\r\n    throw Error('Unexpected pool address, likely a malicious activity');\r\n  }\r\n\r\n  return stakingState;\r\n}\r\n\r\nexport function submitTokenStakingClaim(\r\n  accountId: string,\r\n  password: string | undefined,\r\n  state: ApiJettonStakingState,\r\n) {\r\n  return submitTransfer({\r\n    accountId,\r\n    password,\r\n    toAddress: state.stakeWalletAddress,\r\n    amount: TON_GAS.claimJettons,\r\n    data: buildJettonClaimPayload(state.poolWallets!),\r\n  });\r\n}\r\n\r\nexport async function submitUnstakeEthenaLocked(\r\n  accountId: string,\r\n  password: string | undefined,\r\n  state: ApiEthenaStakingState,\r\n) {\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  const result = await submitTransfer({\r\n    accountId,\r\n    password,\r\n    toAddress: state.tsUsdeWalletAddress,\r\n    amount: TON_GAS.unstakeEthenaLocked,\r\n    data: TsUSDeWallet.transferTimelockedMessage({\r\n      jettonAmount: state.unstakeRequestAmount,\r\n      to: Address.parse(TON_TSUSDE.tokenAddress),\r\n      responseAddress: Address.parse(address),\r\n      forwardTonAmount: TON_GAS.unstakeEthenaLockedForward,\r\n    }),\r\n  });\r\n\r\n  if (!('error' in result)) {\r\n    result.localActivityParams = {\r\n      type: 'unstake',\r\n      amount: state.unstakeRequestAmount,\r\n      isIncoming: true,\r\n      slug: TON_USDE.slug,\r\n      fromAddress: ETHENA_STAKING_VAULT,\r\n      toAddress: address,\r\n    };\r\n  }\r\n\r\n  return result;\r\n}\r\n","import type { ApiStakingState, ApiStakingType } from '../../api/types';\r\n\r\nimport {\r\n  ETHENA_STAKING_MIN_AMOUNT,\r\n  MIN_ACTIVE_STAKING_REWARDS,\r\n  NOMINATORS_STAKING_MIN_AMOUNT,\r\n  STAKING_MIN_AMOUNT,\r\n} from '../../config';\r\n\r\nexport function getStakingMinAmount(type?: ApiStakingType) {\r\n  switch (type) {\r\n    case 'nominators':\r\n      return NOMINATORS_STAKING_MIN_AMOUNT;\r\n    case 'ethena':\r\n      return ETHENA_STAKING_MIN_AMOUNT;\r\n    default:\r\n      return STAKING_MIN_AMOUNT;\r\n  }\r\n}\r\n\r\nexport function getUnstakeTime(state?: ApiStakingState) {\r\n  switch (state?.type) {\r\n    case 'nominators':\r\n    case 'liquid':\r\n      return state.end;\r\n    case 'ethena':\r\n      return state.unlockTime;\r\n    default:\r\n      return undefined;\r\n  }\r\n}\r\n\r\nexport function getStakingTitle(stakingType?: ApiStakingState['type']) {\r\n  return stakingType === 'ethena' ? 'How does it work?' : 'Why this is safe';\r\n}\r\n\r\nexport type StakingStateStatus = 'inactive' | 'active' | 'unstakeRequested' | 'readyToClaim';\r\n\r\nexport function getStakingStateStatus(state: ApiStakingState): StakingStateStatus {\r\n  if (state.unstakeRequestAmount) {\r\n    if (state.type === 'ethena' && state.unlockTime && state.unlockTime <= Date.now()) {\r\n      return 'readyToClaim';\r\n    }\r\n\r\n    return 'unstakeRequested';\r\n  }\r\n  if (getIsActiveStakingState(state)) {\r\n    return 'active';\r\n  }\r\n  return 'inactive';\r\n}\r\n\r\nexport function getIsActiveStakingState(state: ApiStakingState) {\r\n  return Boolean(\r\n    state.balance\r\n    || state.unstakeRequestAmount\r\n    || ('unclaimedRewards' in state && state.unclaimedRewards > MIN_ACTIVE_STAKING_REWARDS),\r\n  );\r\n}\r\n\r\nexport function getIsLongUnstake(state: ApiStakingState, amount?: bigint): boolean | undefined {\r\n  switch (state.type) {\r\n    case 'nominators': {\r\n      return true;\r\n    }\r\n    case 'liquid': {\r\n      return amount === undefined ? false : amount > state.instantAvailable;\r\n    }\r\n    case 'jetton': {\r\n      return false;\r\n    }\r\n    case 'ethena': {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nexport function getFullStakingBalance(state: ApiStakingState): bigint {\r\n  switch (state.type) {\r\n    case 'jetton': {\r\n      return state.balance + state.unclaimedRewards;\r\n    }\r\n    case 'ethena': {\r\n      return state.balance + state.unstakeRequestAmount;\r\n    }\r\n  }\r\n\r\n  return state.balance;\r\n}\r\n","import { DAYS_IN_YEAR } from '../../api/constants';\r\nimport { toBig } from '../decimals';\r\n\r\nexport default function calcJettonStakingApr({\r\n  tvl, dailyReward, decimals,\r\n}: {\r\n  tvl: bigint;\r\n  dailyReward: bigint;\r\n  decimals: number;\r\n}) {\r\n  if (!tvl) {\r\n    return 0;\r\n  }\r\n\r\n  const apr = toBig(dailyReward, decimals)\r\n    .div(toBig(tvl, decimals))\r\n    .mul(DAYS_IN_YEAR)\r\n    .mul(100)\r\n    .toFixed(2);\r\n\r\n  return Number(apr);\r\n}\r\n","import type {\r\n  ApiAccountWithChain,\r\n  ApiActivity,\r\n  ApiActivityTimestamps,\r\n  ApiBalanceBySlug,\r\n  ApiNftUpdate,\r\n  ApiStakingState,\r\n  ApiTonWallet,\r\n  ApiVestingInfo,\r\n  ApiWalletWithVersionInfo,\r\n  OnApiUpdate,\r\n  OnUpdatingStatusChange,\r\n} from '../../types';\r\n\r\nimport { IS_CORE_WALLET, IS_STAKING_DISABLED, POPULAR_WALLET_VERSIONS, TONCOIN } from '../../../config';\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { getActivityTokenSlugs } from '../../../util/activities';\r\nimport { areDeepEqual } from '../../../util/areDeepEqual';\r\nimport { focusAwareDelay } from '../../../util/focusAwareDelay';\r\nimport { compact, pick } from '../../../util/iteratees';\r\nimport { logDebugError } from '../../../util/logs';\r\nimport { pause, throttle } from '../../../util/schedulers';\r\nimport { fetchStoredAccount, fetchStoredWallet, updateStoredWallet } from '../../common/accounts';\r\nimport { getBackendConfigCache, getStakingCommonCache } from '../../common/cache';\r\nimport { getConcurrencyLimiter } from '../../common/polling/setupInactiveChainPolling';\r\nimport {\r\n  activeWalletTiming,\r\n  inactiveWalletTiming,\r\n  periodToMs,\r\n  pollingLoop,\r\n  withDoubleCheck,\r\n} from '../../common/polling/utils';\r\nimport { swapReplaceCexActivities } from '../../common/swap';\r\nimport { sendUpdateTokens } from '../../common/tokens';\r\nimport { txCallbacks } from '../../common/txCallbacks';\r\nimport { hexToBytes } from '../../common/utils';\r\nimport { FIRST_TRANSACTIONS_LIMIT, MINUTE, SEC } from '../../constants';\r\nimport { fetchActivitySlice } from './activities';\r\nimport { getWalletFromAddress } from './auth';\r\nimport { BalanceStream } from './balanceStream';\r\nimport { LEDGER_WALLET_VERSIONS } from './constants';\r\nimport { fetchDomains } from './domains';\r\nimport { getAccountNfts, getNftUpdates } from './nfts';\r\nimport { RichActivityStream } from './richActivityStream';\r\nimport { getBackendStakingState, getStakingStates } from './staking';\r\nimport { ActivityStream } from './toncenter';\r\nimport { fetchVestings } from './vesting';\r\nimport { getWalletInfo, getWalletVersionInfos, isAddressInitialized } from './wallet';\r\n\r\nconst POLL_DELAY_AFTER_SOCKET = 3 * SEC;\r\nconst POLL_MIN_INTERVAL = { focused: 2 * SEC, notFocused: 10 * SEC };\r\nconst DOMAIN_INTERVAL = { focused: MINUTE, notFocused: 5 * MINUTE };\r\nconst INITIALIZATION_INTERVAL = { focused: MINUTE, notFocused: 5 * MINUTE };\r\nconst STAKING_INTERVAL = { focused: 5 * SEC, notFocused: 20 * SEC };\r\nconst VERSIONS_INTERVAL = { focused: 5 * MINUTE, notFocused: 15 * MINUTE };\r\nconst VESTING_INTERVAL = { focused: 10 * SEC, notFocused: MINUTE };\r\nconst TON_DNS_INTERVAL = { focused: 15 * SEC, notFocused: 2 * MINUTE };\r\n\r\nconst NFT_FULL_INTERVAL = { focused: MINUTE, notFocused: 5 * MINUTE };\r\nconst DOUBLE_CHECK_NFT_PAUSE = 5 * SEC;\r\n\r\nexport function setupActivePolling(\r\n  accountId: string,\r\n  account: ApiAccountWithChain<'ton'>,\r\n  onUpdate: OnApiUpdate,\r\n  onUpdatingStatusChange: OnUpdatingStatusChange,\r\n  newestActivityTimestamps: ApiActivityTimestamps,\r\n): NoneToVoidFunction {\r\n  const balancePolling = setupBalancePolling(\r\n    accountId,\r\n    account.byChain.ton.address,\r\n    true,\r\n    onUpdate,\r\n    onUpdatingStatusChange.bind(undefined, 'balance'),\r\n  );\r\n  const stopActivityPolling = setupActivityPolling(\r\n    accountId,\r\n    account.byChain.ton.address,\r\n    newestActivityTimestamps,\r\n    handleWalletUpdate,\r\n    onUpdate,\r\n    onUpdatingStatusChange.bind(undefined, 'activities'),\r\n  );\r\n  const domainPolling = setupDomainPolling(accountId, account.byChain.ton.address, onUpdate);\r\n  const nftPolling = setupNftPolling(accountId, onUpdate);\r\n  const walletInitializationPolling = setupWalletInitializationPolling(accountId);\r\n  const stopWalletVersionPolling = setupWalletVersionsPolling(accountId, onUpdate);\r\n  const stopTonDnsPolling = setupTonDnsPolling(accountId, onUpdate);\r\n  const stopStakingPolling = setupStakingPolling(accountId, balancePolling.getBalances, onUpdate);\r\n  const stopVestingPolling = setupVestingPolling(accountId, onUpdate);\r\n\r\n  async function handleWalletUpdate() {\r\n    // The TON balance updates in `getWalletInfo` several seconds after an activity arrive from the Toncenter socket.\r\n    // This delay is up to 2 seconds, and 1 second is added as a safety margin.\r\n    // We suppose that the other HTTP API data can be delayed, so we delay all socket-triggerred pollings.\r\n    await pause(POLL_DELAY_AFTER_SOCKET);\r\n\r\n    // These data change only when the wallet gets new activities. The other pollings don't depend on the wallet content.\r\n    domainPolling.poll();\r\n    nftPolling.poll();\r\n    walletInitializationPolling.poll();\r\n  }\r\n\r\n  return () => {\r\n    balancePolling.stop();\r\n    stopActivityPolling();\r\n    domainPolling.stop();\r\n    nftPolling.stop();\r\n    stopWalletVersionPolling();\r\n    stopTonDnsPolling();\r\n    stopStakingPolling();\r\n    stopVestingPolling();\r\n  };\r\n}\r\n\r\nfunction setupBalancePolling(\r\n  accountId: string,\r\n  address: string,\r\n  isActive: boolean,\r\n  onUpdate: OnApiUpdate,\r\n  onUpdatingStatusChange?: (isUpdating: boolean) => void,\r\n) {\r\n  const { network } = parseAccountId(accountId);\r\n\r\n  const balanceStream = new BalanceStream(\r\n    network,\r\n    address,\r\n    () => sendUpdateTokens(onUpdate),\r\n    isActive ? activeWalletTiming : inactiveWalletTiming,\r\n    isActive ? undefined : getConcurrencyLimiter('ton', network),\r\n  );\r\n\r\n  balanceStream.onUpdate((balances) => {\r\n    onUpdate({\r\n      type: 'updateBalances',\r\n      accountId,\r\n      chain: 'ton',\r\n      balances,\r\n    });\r\n  });\r\n\r\n  if (onUpdatingStatusChange) {\r\n    balanceStream.onLoadingChange(onUpdatingStatusChange);\r\n  }\r\n\r\n  return {\r\n    stop() {\r\n      balanceStream.destroy();\r\n    },\r\n    getBalances() {\r\n      return balanceStream.getBalances();\r\n    },\r\n  };\r\n}\r\n\r\n// A good address for testing: UQD5mxRgCuRNLxKxeOjG6r14iSroLF5FtomPnet-sgP5xI-e\r\nfunction setupActivityPolling(\r\n  accountId: string,\r\n  address: string,\r\n  newestConfirmedActivityTimestamps: ApiActivityTimestamps,\r\n  onRawActivity: NoneToVoidFunction,\r\n  onUpdate: OnApiUpdate,\r\n  onUpdatingStatusChange: (isUpdating: boolean) => void,\r\n) {\r\n  let isStopped = false;\r\n  let rawActivityStream: ActivityStream | undefined;\r\n  let richActivityStream: RichActivityStream | undefined;\r\n\r\n  const newestTimestamps = compact(Object.values(newestConfirmedActivityTimestamps));\r\n  let newestConfirmedActivityTimestamp = newestTimestamps.length ? Math.max(...newestTimestamps) : undefined;\r\n\r\n  async function loadInitialActivities() {\r\n    try {\r\n      onUpdatingStatusChange(true);\r\n      return await loadInitialConfirmedActivities(accountId, onUpdate);\r\n    } catch (err) {\r\n      logDebugError('loadInitialConfirmedActivities', err);\r\n      return undefined;\r\n    } finally {\r\n      onUpdatingStatusChange(false);\r\n    }\r\n  }\r\n\r\n  function onRawActivities(confirmedActivities: ApiActivity[]) {\r\n    if (confirmedActivities.length) {\r\n      onRawActivity();\r\n    }\r\n  }\r\n\r\n  function onRichActivities(confirmedActivities: ApiActivity[], pendingActivities: readonly ApiActivity[]) {\r\n    confirmedActivities.slice().reverse().forEach((activity) => {\r\n      txCallbacks.runCallbacks(activity);\r\n    });\r\n\r\n    onUpdate({\r\n      type: 'newActivities',\r\n      chain: 'ton',\r\n      activities: confirmedActivities,\r\n      pendingActivities,\r\n      accountId,\r\n    });\r\n  }\r\n\r\n  void (async () => {\r\n    const doesNeedInitial = newestConfirmedActivityTimestamp === undefined;\r\n    if (doesNeedInitial) {\r\n      newestConfirmedActivityTimestamp = await loadInitialActivities();\r\n      onRawActivity(); // Just in case, because new activities may have arrived while loading the initial ones\r\n    }\r\n\r\n    if (isStopped) return;\r\n\r\n    rawActivityStream = new ActivityStream(\r\n      parseAccountId(accountId).network,\r\n      address,\r\n      newestConfirmedActivityTimestamp,\r\n      {\r\n        ...activeWalletTiming,\r\n        // If the initial activities are loaded, the polling on start is excessive\r\n        pollOnStart: !doesNeedInitial,\r\n      },\r\n    );\r\n\r\n    richActivityStream = new RichActivityStream(accountId, rawActivityStream);\r\n\r\n    rawActivityStream.onUpdate(onRawActivities);\r\n    richActivityStream.onUpdate(onRichActivities);\r\n    richActivityStream.onLoadingChange(onUpdatingStatusChange);\r\n  })();\r\n\r\n  return () => {\r\n    isStopped = true;\r\n    richActivityStream?.destroy();\r\n    rawActivityStream?.destroy();\r\n  };\r\n}\r\n\r\nfunction setupDomainPolling(accountId: string, address: string, onUpdate: OnApiUpdate) {\r\n  const { network } = parseAccountId(accountId);\r\n  let domain: string | false | undefined; // Undefined means unknown, false means no domain\r\n\r\n  return pollingLoop({\r\n    period: DOMAIN_INTERVAL,\r\n    minDelay: POLL_MIN_INTERVAL,\r\n    async poll() {\r\n      try {\r\n        const { domain: newDomain = false } = await getWalletInfo(network, address);\r\n\r\n        if (newDomain !== domain) {\r\n          onUpdate({\r\n            type: 'updateAccount',\r\n            accountId,\r\n            chain: 'ton',\r\n            domain,\r\n          });\r\n          domain = newDomain;\r\n        }\r\n      } catch (err) {\r\n        logDebugError('setupDomainPolling', err);\r\n      }\r\n    },\r\n  });\r\n}\r\n\r\nfunction setupNftPolling(accountId: string, onUpdate: OnApiUpdate) {\r\n  let nftFromSec = Math.round(Date.now() / 1000);\r\n\r\n  // The NFT updates may not become available immediately after the socket message.\r\n  // So we check again in a few seconds.\r\n  const updatePartial = withDoubleCheck(\r\n    [DOUBLE_CHECK_NFT_PAUSE],\r\n    async () => {\r\n      try {\r\n        const nftResult = await getNftUpdates(accountId, nftFromSec).catch(logAndRescue);\r\n\r\n        if (nftResult) {\r\n          let nftUpdates: ApiNftUpdate[];\r\n          [nftFromSec, nftUpdates] = nftResult;\r\n          nftUpdates\r\n            .filter((update) => !(update.type === 'nftReceived' && update.nft.isHidden))\r\n            .forEach(onUpdate);\r\n        }\r\n      } catch (err) {\r\n        logDebugError('setupNftPolling updatePartial', err);\r\n      }\r\n    },\r\n  );\r\n\r\n  const fullPolling = pollingLoop({\r\n    period: NFT_FULL_INTERVAL,\r\n    async poll() {\r\n      updatePartial.cancel();\r\n\r\n      try {\r\n        const nfts = await getAccountNfts(accountId).catch(logAndRescue);\r\n\r\n        if (nfts) {\r\n          nftFromSec = Math.round(Date.now() / 1000);\r\n          onUpdate({\r\n            type: 'updateNfts',\r\n            accountId,\r\n            nfts,\r\n          });\r\n        }\r\n      } catch (err) {\r\n        logDebugError('setupNftPolling updateFull', err);\r\n      }\r\n    },\r\n  });\r\n\r\n  return {\r\n    poll: throttle(\r\n      updatePartial.run,\r\n      () => focusAwareDelay(...periodToMs(POLL_MIN_INTERVAL)),\r\n    ),\r\n    stop() {\r\n      updatePartial.cancel();\r\n      fullPolling.stop();\r\n    },\r\n  };\r\n}\r\n\r\nfunction setupStakingPolling(accountId: string, getBalances: () => Promise<ApiBalanceBySlug>, onUpdate: OnApiUpdate) {\r\n  if (IS_STAKING_DISABLED || parseAccountId(accountId).network !== 'mainnet') {\r\n    return () => {};\r\n  }\r\n\r\n  let lastStates: ApiStakingState[] | undefined;\r\n\r\n  return pollingLoop({\r\n    period: STAKING_INTERVAL,\r\n    async poll() {\r\n      try {\r\n        const [common, balances, backendState] = await Promise.all([\r\n          getStakingCommonCache(),\r\n          getBalances(),\r\n          getBackendStakingState(accountId),\r\n        ]);\r\n        const states = await getStakingStates(accountId, common, backendState, balances);\r\n\r\n        const { shouldUseNominators, totalProfit } = backendState;\r\n\r\n        if (!areDeepEqual(states, lastStates)) {\r\n          lastStates = states;\r\n          onUpdate({\r\n            type: 'updateStaking',\r\n            accountId,\r\n            states,\r\n            totalProfit,\r\n            shouldUseNominators,\r\n          });\r\n        }\r\n      } catch (err) {\r\n        logDebugError('setupStakingPolling', err);\r\n      }\r\n    },\r\n  }).stop;\r\n}\r\n\r\nasync function loadInitialConfirmedActivities(accountId: string, onUpdate: OnApiUpdate) {\r\n  let mainActivities = await fetchActivitySlice({ accountId, limit: FIRST_TRANSACTIONS_LIMIT });\r\n  mainActivities = await swapReplaceCexActivities(accountId, mainActivities, undefined, true);\r\n\r\n  const bySlug = {\r\n    // Loading the TON history is a side effect of loading the main history.\r\n    // Because there is no way to load TON activities without loading activities of other tokens.\r\n    [TONCOIN.slug]: mainActivities.filter((activity) => getActivityTokenSlugs(activity).includes(TONCOIN.slug)),\r\n  };\r\n\r\n  const newestActivityTimestamp = mainActivities[0]?.timestamp;\r\n\r\n  onUpdate({\r\n    type: 'initialActivities',\r\n    chain: 'ton',\r\n    accountId,\r\n    mainActivities,\r\n    bySlug,\r\n  });\r\n\r\n  return newestActivityTimestamp;\r\n}\r\n\r\nfunction logAndRescue(err: Error) {\r\n  logDebugError('Polling error', err);\r\n\r\n  return undefined;\r\n}\r\n\r\nfunction setupWalletVersionsPolling(accountId: string, onUpdate: OnApiUpdate) {\r\n  const { network } = parseAccountId(accountId);\r\n  let lastResult: ApiWalletWithVersionInfo[] | undefined;\r\n\r\n  return pollingLoop({\r\n    period: VERSIONS_INTERVAL,\r\n    async poll() {\r\n      try {\r\n        const { type: accountType, byChain: { ton: tonWallet } } = await fetchStoredAccount(accountId);\r\n        if (accountType === 'bip39' || !tonWallet) {\r\n          return 'stop';\r\n        }\r\n\r\n        const { publicKey, version, isInitialized } = tonWallet;\r\n\r\n        if (!publicKey) {\r\n          if (!isInitialized) {\r\n            // Keep polling because `publicKey` may arrive later (for example, when the view wallet becomes initialized)\r\n            return undefined;\r\n          }\r\n\r\n          // This happens when this address is not a wallet address (for example, a contract address)\r\n          onUpdate({\r\n            type: 'updateWalletVersions',\r\n            accountId,\r\n            currentVersion: version,\r\n            versions: [],\r\n          });\r\n          return 'stop';\r\n        }\r\n\r\n        const publicKeyBytes = hexToBytes(publicKey);\r\n        let versions = (\r\n          accountType === 'ledger'\r\n            ? Object.keys(LEDGER_WALLET_VERSIONS) as (keyof typeof LEDGER_WALLET_VERSIONS)[]\r\n            : POPULAR_WALLET_VERSIONS\r\n        )\r\n          .filter((value) => value !== version);\r\n\r\n        // For W5 wallets, always include W5 to show subwallet ID variants for testnet\r\n        if (version === 'W5') {\r\n          versions = [...versions, 'W5'];\r\n        }\r\n        const versionInfos: ApiWalletWithVersionInfo[] = (await getWalletVersionInfos(\r\n          network, publicKeyBytes, versions,\r\n        )).map(({ wallet, ...rest }) => rest);\r\n\r\n        // Filter out the current wallet (including the current W5 subwallet ID variant)\r\n        const filteredVersions = versionInfos\r\n          .filter((v) => v.address !== tonWallet.address);\r\n\r\n        if (!areDeepEqual(versionInfos, lastResult)) {\r\n          lastResult = versionInfos;\r\n          onUpdate({\r\n            type: 'updateWalletVersions',\r\n            accountId,\r\n            currentVersion: version,\r\n            versions: filteredVersions,\r\n          });\r\n        }\r\n      } catch (err) {\r\n        logDebugError('setupWalletVersionsPolling', err);\r\n      }\r\n\r\n      return undefined;\r\n    },\r\n  }).stop;\r\n}\r\n\r\nfunction setupTonDnsPolling(accountId: string, onUpdate: OnApiUpdate) {\r\n  let lastResult: Awaited<ReturnType<typeof fetchDomains>> | undefined;\r\n\r\n  return pollingLoop({\r\n    period: TON_DNS_INTERVAL,\r\n    async poll() {\r\n      try {\r\n        const result = await fetchDomains(accountId);\r\n\r\n        if (!areDeepEqual(result, lastResult)) {\r\n          lastResult = result;\r\n\r\n          onUpdate({\r\n            type: 'updateAccountDomainData',\r\n            accountId,\r\n            ...pick(result, [\r\n              'expirationByAddress',\r\n              'linkedAddressByAddress',\r\n              'nfts',\r\n            ]),\r\n          });\r\n        }\r\n      } catch (err) {\r\n        logDebugError('setupTonDnsPolling', err);\r\n      }\r\n    },\r\n  }).stop;\r\n}\r\n\r\nfunction setupVestingPolling(accountId: string, onUpdate: OnApiUpdate) {\r\n  if (IS_CORE_WALLET) {\r\n    return () => {};\r\n  }\r\n\r\n  let lastVestingInfo: ApiVestingInfo[] | undefined;\r\n\r\n  return pollingLoop({\r\n    period: VESTING_INTERVAL,\r\n    async prepare() {\r\n      const { isVestingEnabled } = await getBackendConfigCache();\r\n      return isVestingEnabled;\r\n    },\r\n    async poll(isEnabled) {\r\n      if (!isEnabled) {\r\n        return 'stop';\r\n      }\r\n\r\n      try {\r\n        const vestingInfo = await fetchVestings(accountId);\r\n\r\n        if (!areDeepEqual(lastVestingInfo, vestingInfo)) {\r\n          lastVestingInfo = vestingInfo;\r\n          onUpdate({\r\n            type: 'updateVesting',\r\n            accountId,\r\n            vestingInfo,\r\n          });\r\n        }\r\n      } catch (err) {\r\n        logDebugError('setupVestingPolling', err);\r\n      }\r\n\r\n      return undefined;\r\n    },\r\n  }).stop;\r\n}\r\n\r\nexport function setupInactivePolling(\r\n  accountId: string,\r\n  account: ApiAccountWithChain<'ton'>,\r\n  onUpdate: OnApiUpdate,\r\n): NoneToVoidFunction {\r\n  const balancePolling = setupBalancePolling(accountId, account.byChain.ton.address, false, onUpdate);\r\n  return balancePolling.stop;\r\n}\r\n\r\nfunction setupWalletInitializationPolling(accountId: string) {\r\n  return pollingLoop({\r\n    period: INITIALIZATION_INTERVAL,\r\n    minDelay: POLL_MIN_INTERVAL,\r\n    async poll() {\r\n      try {\r\n        const wallet = await fetchStoredWallet(accountId, 'ton');\r\n\r\n        if (wallet.isInitialized) {\r\n          return 'stop';\r\n        }\r\n\r\n        const { network } = parseAccountId(accountId);\r\n        const doesNeedPublicKey = !wallet.publicKey;\r\n        let walletUpdate: Partial<ApiTonWallet> | undefined;\r\n\r\n        if (doesNeedPublicKey) {\r\n          // This branch isn't used always, because it makes more network requests than the other\r\n          const updatedWallet = await getWalletFromAddress(network, wallet.address);\r\n          if (!('error' in updatedWallet) && updatedWallet.wallet.isInitialized) {\r\n            // It's important to load and save `version` along with `publicKey` because the app couldn't get the proper\r\n            // wallet version without knowing the `publicKey`.\r\n            walletUpdate = pick(updatedWallet.wallet, ['isInitialized', 'publicKey', 'version']);\r\n          }\r\n        } else {\r\n          const isInitialized = await isAddressInitialized(network, wallet.address);\r\n          if (isInitialized) {\r\n            walletUpdate = { isInitialized };\r\n          }\r\n        }\r\n\r\n        if (walletUpdate) {\r\n          await updateStoredWallet(accountId, 'ton', walletUpdate);\r\n        }\r\n      } catch (err) {\r\n        logDebugError('checkWalletInitialization', err);\r\n      }\r\n    },\r\n  });\r\n}\r\n","// src/api/chains/ton/swap.ts\r\n\r\nimport type {\r\n  ApiAccountWithChain,\r\n  ApiNetwork,\r\n  ApiSwapBuildRequest,\r\n  ApiTokensTransferPayload,\r\n} from '../../types';\r\nimport type { TonTransferParams } from './types';\r\n\r\nimport { DIESEL_ADDRESS, SWAP_FEE_ADDRESS, TONCOIN } from '../../../config';\r\nimport { assert as originalAssert } from '../../../util/assert';\r\nimport { fromDecimal } from '../../../util/decimals';\r\nimport { getMaxMessagesInTransaction, isTokenTransferPayload } from '../../../util/ton/transfer';\r\nimport { parsePayloadBase64 } from './util/metadata';\r\nimport { resolveTokenWalletAddress, toBase64Address } from './util/tonCore';\r\nimport { getTokenByAddress } from '../../common/tokens';\r\nimport { getContractInfo } from './wallet';\r\n\r\nasync function getContractInfos(network: ApiNetwork, addresses: string[]) {\r\n  // Can't be done via Toncenter `/api/v3/accountStates` endpoint because it serializes code cells\r\n  // differently, resulting in `codeHashOld` mismatch\r\n  const result: Record<string, Awaited<ReturnType<typeof getContractInfo>>> = {};\r\n  const infos = await Promise.all(addresses.map((address) => getContractInfo(network, address)));\r\n  for (let i = 0; i < addresses.length; i++) {\r\n    result[addresses[i]] = infos[i];\r\n  }\r\n  return result;\r\n}\r\n\r\nconst FEE_ADDRESSES = [SWAP_FEE_ADDRESS, DIESEL_ADDRESS];\r\nconst MAX_NETWORK_FEE = 3600000000n; // 3.6 TON = 0.3 TON * 3 * 4 - when 4 splits with 3 hops per split on Stonfi\r\nconst MAX_SPLITS = 4; // Backend configuration\r\n\r\nexport async function validateDexSwapTransfers(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  request: ApiSwapBuildRequest,\r\n  transfers: TonTransferParams[],\r\n  account: ApiAccountWithChain<'ton'>,\r\n) {\r\n  const feeTransfer = (\r\n    toBase64Address(transfers.at(-1)?.toAddress ?? '', false) === SWAP_FEE_ADDRESS\r\n  ) ? transfers.at(-1)! : undefined;\r\n  const mainTransfers = feeTransfer ? transfers.slice(0, -1) : transfers;\r\n  const maxMessages = getMaxMessagesInTransaction(account);\r\n  const maxSplits = Math.min(maxMessages - (feeTransfer ? 1 : 0), MAX_SPLITS);\r\n\r\n  const assert = (condition: boolean, message: string) => {\r\n    originalAssert(condition, message, {\r\n      network, address, request, transfers, maxMessages, maxSplits,\r\n    });\r\n  };\r\n\r\n  assert(transfers.length <= maxSplits, 'Too many main transfers');\r\n\r\n  if (request.from === TONCOIN.symbol) {\r\n    const maxAmount = fromDecimal(request.fromAmount) + fromDecimal(request.ourFee) + MAX_NETWORK_FEE;\r\n    let sumAmount = 0n;\r\n\r\n    const contractInfos = await getContractInfos(network, mainTransfers.map((transfer) => transfer.toAddress));\r\n\r\n    for (let i = 0; i < mainTransfers.length; i++) {\r\n      const mainTransfer = mainTransfers[i];\r\n      sumAmount += mainTransfer.amount;\r\n      const { isSwapAllowed, codeHash } = contractInfos[mainTransfer.toAddress];\r\n      assert(\r\n        !!isSwapAllowed,\r\n        `Main transfer ${i + 1}/${mainTransfers.length} is not to a swap contract: codeHash=${codeHash}`,\r\n      );\r\n    }\r\n\r\n    assert(sumAmount <= maxAmount, 'Main transfers amount is too big');\r\n\r\n    if (feeTransfer) {\r\n      assert(feeTransfer.amount <= sumAmount, 'Fee transfer amount is bigger than main transfers amount');\r\n      assert(feeTransfer.amount <= MAX_NETWORK_FEE, 'Fee transfer amount is bigger than max network fee');\r\n      assert(feeTransfer.amount + sumAmount < maxAmount, 'Total amount is too big');\r\n      assert(FEE_ADDRESSES.includes(toBase64Address(feeTransfer.toAddress, false)), 'Unexpected fee transfer address');\r\n    }\r\n  } else {\r\n    const token = getTokenByAddress(request.from)!;\r\n    assert(!!token, 'Unknown \"from\" token');\r\n\r\n    const maxAmount = fromDecimal(request.fromAmount, token.decimals)\r\n      + fromDecimal(request.ourFee ?? 0, token.decimals)\r\n      + fromDecimal(request.dieselFee ?? 0, token.decimals);\r\n    const maxTonAmount = MAX_NETWORK_FEE;\r\n\r\n    const walletAddress = await resolveTokenWalletAddress(network, address, token.tokenAddress!);\r\n    let sumTokenAmount = 0n;\r\n    let sumTonAmount = 0n;\r\n\r\n    const parsedPayloads = await Promise.all(mainTransfers.map(\r\n      async (transfer) => parsePayloadBase64(network, transfer.toAddress, transfer.payload as string),\r\n    ));\r\n    const contractInfos = await getContractInfos(\r\n      network,\r\n      parsedPayloads.filter(isTokenTransferPayload).map((payload) => payload.destination),\r\n    );\r\n    for (let i = 0; i < mainTransfers.length; i++) {\r\n      const mainTransfer = mainTransfers[i];\r\n      const parsedPayload = parsedPayloads[i];\r\n      assert(\r\n        mainTransfer.toAddress === walletAddress,\r\n        `Main transfer ${i + 1}/${mainTransfers.length} address is not the token wallet address`,\r\n      );\r\n      assert(\r\n        isTokenTransferPayload(parsedPayload),\r\n        `Main transfer ${i + 1}/${mainTransfers.length} payload is not a token transfer`,\r\n      );\r\n\r\n      const { amount: tokenAmount, destination } = parsedPayload as ApiTokensTransferPayload;\r\n      sumTokenAmount += tokenAmount;\r\n      sumTonAmount += mainTransfer.amount;\r\n\r\n      const { isSwapAllowed, codeHash } = contractInfos[destination];\r\n\r\n      assert(\r\n        isSwapAllowed || FEE_ADDRESSES.includes(toBase64Address(destination, false)),\r\n        `Main transfer ${i + 1}/${mainTransfers.length} destination is not a swap smart contract: `\r\n        + `${destination}, codeHash=${codeHash}`,\r\n      );\r\n    }\r\n    assert(sumTokenAmount <= maxAmount, 'Main transfers token amount is too big');\r\n    assert(sumTonAmount <= maxTonAmount, 'Main transfers TON amount is too big');\r\n\r\n    if (feeTransfer) {\r\n      const feePayload = await parsePayloadBase64(network, feeTransfer.toAddress, feeTransfer.payload as string);\r\n\r\n      assert(feeTransfer.amount + sumTonAmount < maxTonAmount, 'Total TON amount is too big');\r\n      assert(feeTransfer.toAddress === walletAddress, 'Fee transfer address is not the token wallet address');\r\n      assert(isTokenTransferPayload(feePayload), 'Fee transfer payload is not a token transfer');\r\n\r\n      const { amount: tokenFeeAmount, destination: feeDestination } = feePayload as ApiTokensTransferPayload;\r\n\r\n      assert(sumTokenAmount + tokenFeeAmount <= maxAmount, 'Total token amount is too big');\r\n      assert(FEE_ADDRESSES.includes(toBase64Address(feeDestination, false)), 'Unexpected fee transfer destination');\r\n    }\r\n  }\r\n}\r\n","import type { ChainSdk } from '../../types/chains';\r\n\r\nimport { decryptComment, fetchActivityDetails, fetchActivitySlice } from './activities';\r\nimport { getWalletFromAddress, getWalletFromBip39Mnemonic, getWalletsFromLedgerAndLoadBalance } from './auth';\r\nimport { getIsLedgerAppOpen } from './other';\r\nimport { setupActivePolling, setupInactivePolling } from './polling';\r\nimport { checkTransactionDraft, submitTransfer } from './transfer';\r\nimport { verifyLedgerWalletAddress } from './wallet';\r\n\r\nconst tonSdk: ChainSdk<'ton'> = {\r\n  fetchActivitySlice,\r\n  fetchActivityDetails,\r\n  decryptComment,\r\n  getWalletFromBip39Mnemonic,\r\n  getWalletFromAddress,\r\n  getWalletsFromLedgerAndLoadBalance,\r\n  setupActivePolling,\r\n  setupInactivePolling,\r\n  checkTransactionDraft,\r\n  submitTransfer,\r\n  verifyLedgerWalletAddress,\r\n  getIsLedgerAppOpen,\r\n};\r\n\r\nexport default tonSdk;\r\n\r\n// The chain methods that haven't been multichain-refactored yet:\r\n\r\n// todo: Remove as a part of the multichain send refactoring\r\nexport { submitTransfer };\r\n\r\nexport {\r\n  generateMnemonic,\r\n  rawSign,\r\n  validateMnemonic,\r\n  fetchPrivateKey,\r\n  getWalletFromMnemonic,\r\n  getWalletFromPrivateKey,\r\n  getOtherVersionWallet,\r\n} from './auth';\r\nexport {\r\n  getAccountNfts,\r\n  checkNftTransferDraft,\r\n  submitNftTransfers,\r\n  checkNftOwnership,\r\n} from './nfts';\r\nexport {\r\n  submitDnsRenewal,\r\n  checkDnsRenewalDraft,\r\n  checkDnsChangeWalletDraft,\r\n  submitDnsChangeWallet,\r\n} from './domains';\r\nexport {\r\n  checkMultiTransactionDraft,\r\n  checkToAddress,\r\n  submitMultiTransfer,\r\n  signTransfers,\r\n  submitTransferWithDiesel,\r\n  fetchEstimateDiesel,\r\n} from './transfer';\r\nexport {\r\n  getWalletBalance,\r\n  pickWalletByAddress,\r\n} from './wallet';\r\nexport {\r\n  checkStakeDraft,\r\n  checkUnstakeDraft,\r\n  submitTokenStakingClaim,\r\n  submitStake,\r\n  submitUnstake,\r\n  getStakingStates,\r\n  getBackendStakingState,\r\n  submitUnstakeEthenaLocked,\r\n} from './staking';\r\nexport {\r\n  fetchToken,\r\n  insertMintlessPayload,\r\n} from './tokens';\r\nexport {\r\n  normalizeAddress,\r\n} from './address';\r\nexport {\r\n  validateDexSwapTransfers,\r\n} from './swap';\r\n","import type { ApiVestingInfo } from '../../types';\r\n\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { fetchStoredWallet } from '../../common/accounts';\r\nimport { callBackendGet } from '../../common/backend';\r\n\r\nexport async function fetchVestings(accountId: string) {\r\n  const { network } = parseAccountId(accountId);\r\n  const isTestnet = network === 'testnet';\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  return callBackendGet<ApiVestingInfo[]>(`/vesting/${address}`, { isTestnet });\r\n}\r\n","import type { ApiAnyDisplayError } from '../../types';\r\n\r\nexport async function getIsLedgerAppOpen(): Promise<boolean | { error: ApiAnyDisplayError }> {\r\n  const { isLedgerTonAppOpen } = await import('./ledger');\r\n  return isLedgerTonAppOpen();\r\n}\r\n","import { logDebugError } from '../util/logs';\r\n\r\ninterface Hooks {\r\n  onFirstLogin: AnyFunction;\r\n  onFullLogout: AnyFunction;\r\n  onWindowNeeded: AnyFunction;\r\n  onDappDisconnected: (accountId: string, url: string) => any;\r\n  onDappsChanged: AnyFunction;\r\n  onSwapCreated: (accountId: string, fromTimestamp: number) => any;\r\n}\r\n\r\nconst hooks: Partial<{\r\n  [K in keyof Hooks]: Hooks[K][];\r\n}> = {};\r\n\r\nexport function addHooks(partial: Partial<Hooks>) {\r\n  for (const [name, hook] of Object.entries(partial) as Entries<Hooks>) {\r\n    hooks[name] = (hooks[name] ?? []).concat([hook]);\r\n  }\r\n}\r\n\r\nexport async function callHook<T extends keyof Hooks>(name: T, ...args: Parameters<Hooks[T]>) {\r\n  for (const hook of hooks[name] ?? []) {\r\n    try {\r\n      // @ts-ignore\r\n      await hook(...args);\r\n    } catch (err) {\r\n      logDebugError(`callHooks:${name}`, err);\r\n    }\r\n  }\r\n}\r\n","import type { ConnectEventError, ConnectEventSuccess } from '@tonconnect/protocol';\r\n\r\nexport interface TransactionPayload {\r\n  valid_until?: number;\r\n  network?: CHAIN;\r\n  from?: string; // https://github.com/ton-blockchain/ton-connect/blob/main/wallet-guidelines.md#multi-accounts\r\n  messages: TransactionPayloadMessage[];\r\n}\r\n\r\nexport interface TransactionPayloadMessage {\r\n  address: string;\r\n  amount: string;\r\n  payload?: string;\r\n  stateInit?: string;\r\n}\r\n\r\n// This and the other enums can be imported from @tonconnect/protocol. We copy the enums instead of importing because\r\n// importing that module increases the compiled code size significantly.\r\n\r\nexport enum CONNECT_EVENT_ERROR_CODES {\r\n  UNKNOWN_ERROR = 0,\r\n  BAD_REQUEST_ERROR = 1,\r\n  MANIFEST_NOT_FOUND_ERROR = 2,\r\n  MANIFEST_CONTENT_ERROR = 3,\r\n  UNKNOWN_APP_ERROR = 100,\r\n  USER_REJECTS_ERROR = 300,\r\n  METHOD_NOT_SUPPORTED = 400,\r\n}\r\n\r\nexport enum SEND_TRANSACTION_ERROR_CODES {\r\n  UNKNOWN_ERROR = 0,\r\n  BAD_REQUEST_ERROR = 1,\r\n  UNKNOWN_APP_ERROR = 100,\r\n  USER_REJECTS_ERROR = 300,\r\n  METHOD_NOT_SUPPORTED = 400,\r\n}\r\n\r\nexport type AllErrorCodes = CONNECT_EVENT_ERROR_CODES | SEND_TRANSACTION_ERROR_CODES;\r\nexport type ConnectEvent = ConnectEventSuccess | ConnectEventError;\r\n\r\nexport interface ApiTonConnectProof {\r\n  timestamp: number;\r\n  domain: string;\r\n  payload: string;\r\n}\r\n\r\nexport enum CHAIN {\r\n  MAINNET = '-239',\r\n  TESTNET = '-3',\r\n}\r\n\r\nexport interface ApiDappRequestConfirmation {\r\n  accountId: string;\r\n  /** Base64. Shall miss when no proof is required. */\r\n  proofSignature?: string;\r\n}\r\n","import type { DeviceInfo, Feature } from '@tonconnect/protocol';\r\n\r\nimport type { ApiAccountWithChain } from '../api/types';\r\n\r\nimport {\r\n  APP_NAME, IS_EXTENSION, IS_TELEGRAM_APP, TONCONNECT_PROTOCOL_VERSION,\r\n} from '../config';\r\nimport packageJson from '../../package.json';\r\nimport { W5_MAX_MESSAGES } from '../api/chains/ton/constants';\r\nimport { getMaxMessagesInTransaction } from './ton/transfer';\r\n\r\ntype DevicePlatform = DeviceInfo['platform'];\r\n\r\n/*\r\n This function is called in TonConnect `connect` method (where we know the wallet version)\r\n and in JS Bridge (where no account is selected, so we show maximum number of messages).\r\n*/\r\nexport function tonConnectGetDeviceInfo(account?: ApiAccountWithChain<'ton'>): DeviceInfo {\r\n  const features: Feature[] = [\r\n    'SendTransaction', // TODO DEPRECATED\r\n    {\r\n      name: 'SendTransaction',\r\n      maxMessages: account ? getMaxMessagesInTransaction(account) : W5_MAX_MESSAGES,\r\n    },\r\n  ];\r\n\r\n  if (!account || account.type !== 'ledger') {\r\n    features.push({\r\n      name: 'SignData',\r\n      types: ['text', 'binary', 'cell'],\r\n    });\r\n  }\r\n\r\n  return {\r\n    platform: getPlatform(),\r\n    appName: APP_NAME,\r\n    appVersion: packageJson.version,\r\n    maxProtocolVersion: TONCONNECT_PROTOCOL_VERSION,\r\n    features,\r\n  };\r\n}\r\n\r\nfunction getPlatform(): DevicePlatform {\r\n  const { userAgent } = navigator;\r\n  const platform = navigator.platform || navigator?.userAgentData?.platform || '';\r\n\r\n  const macosPlatforms = ['macOS', 'Macintosh', 'MacIntel', 'MacPPC', 'Mac68K'];\r\n  const windowsPlatforms = ['Win32', 'Win64', 'Windows', 'WinCE'];\r\n  const iphonePlatforms = ['iPhone'];\r\n  const ipadPlatforms = ['iPad', 'iPod'];\r\n\r\n  let devicePlatform: DevicePlatform | undefined;\r\n\r\n  if (IS_EXTENSION || IS_TELEGRAM_APP) {\r\n    devicePlatform = 'browser';\r\n  } else if (/Android/.test(userAgent)) {\r\n    devicePlatform = 'android';\r\n  } else if (iphonePlatforms.indexOf(platform) !== -1) {\r\n    devicePlatform = 'iphone';\r\n  } else if (ipadPlatforms.indexOf(platform) !== -1) {\r\n    devicePlatform = 'ipad';\r\n  } else if (macosPlatforms.indexOf(platform) !== -1) {\r\n    devicePlatform = 'mac';\r\n  } else if (windowsPlatforms.indexOf(platform) !== -1) {\r\n    devicePlatform = 'windows';\r\n  } else if (/Linux/.test(platform)) {\r\n    devicePlatform = 'linux';\r\n  } else {\r\n    devicePlatform = 'browser';\r\n  }\r\n\r\n  return devicePlatform;\r\n}\r\n","import generateUniqueId from '../../util/generateUniqueId';\r\nimport { ApiUserRejectsError } from '../errors';\r\n\r\nconst deferreds = new Map<string, Deferred>();\r\n\r\nclass Deferred<T = any> {\r\n  resolve!: AnyToVoidFunction;\r\n\r\n  reject!: AnyToVoidFunction;\r\n\r\n  promise = new Promise<T>((resolve, reject) => {\r\n    this.resolve = resolve;\r\n    this.reject = reject;\r\n  });\r\n}\r\n\r\nexport function createDappPromise(promiseId = generateUniqueId()) {\r\n  const deferred = new Deferred();\r\n\r\n  deferreds.set(promiseId, deferred);\r\n\r\n  const { promise } = deferred;\r\n\r\n  return { promiseId, promise };\r\n}\r\n\r\nexport function resolveDappPromise(promiseId: string, value?: any) {\r\n  const deferred = deferreds.get(promiseId);\r\n  if (!deferred) {\r\n    return;\r\n  }\r\n\r\n  deferred.resolve(value);\r\n  deferreds.delete(promiseId);\r\n}\r\n\r\nexport function rejectDappPromise(promiseId: string, reason: string = 'Unknown rejection reason') {\r\n  const deferred = deferreds.get(promiseId);\r\n  if (!deferred) {\r\n    return;\r\n  }\r\n\r\n  deferred.reject(new ApiUserRejectsError(reason));\r\n  deferreds.delete(promiseId);\r\n}\r\n\r\nexport function rejectAllDappPromises(message: string) {\r\n  Array.from(deferreds.keys()).forEach((id) => {\r\n    rejectDappPromise(id, message);\r\n  });\r\n}\r\n","import type {\r\n  ApiDapp, ApiDappsByUrl, ApiDappsState, ApiNetwork, ApiSite, ApiSiteCategory, OnApiUpdate,\r\n} from '../types';\r\n\r\nimport { parseAccountId } from '../../util/account';\r\nimport isEmptyObject from '../../util/isEmptyObject';\r\nimport {\r\n  getAccountValue,\r\n  removeAccountValue,\r\n  removeNetworkAccountsValue,\r\n  setAccountValue,\r\n} from '../common/accounts';\r\nimport { callBackendGet } from '../common/backend';\r\nimport { isUpdaterAlive } from '../common/helpers';\r\nimport { callHook } from '../hooks';\r\nimport { storage } from '../storages';\r\n\r\nlet onUpdate: OnApiUpdate;\r\n\r\nexport function initDapps(_onUpdate: OnApiUpdate) {\r\n  onUpdate = _onUpdate;\r\n}\r\n\r\nexport async function updateDapp(\r\n  accountId: string,\r\n  url: string,\r\n  uniqueId: string,\r\n  update: Partial<ApiDapp>,\r\n) {\r\n  const dapp = await getDapp(accountId, url, uniqueId);\r\n  if (!dapp) return;\r\n  await addDapp(accountId, { ...dapp, ...update }, uniqueId);\r\n}\r\n\r\nexport async function getDapp(\r\n  accountId: string,\r\n  url: string,\r\n  uniqueId: string,\r\n): Promise<ApiDapp | undefined> {\r\n  const byUrl = (\r\n    await getAccountValue(accountId, 'dapps') as ApiDappsByUrl | undefined\r\n  )?.[url];\r\n  if (!byUrl) return undefined;\r\n\r\n  return byUrl[uniqueId];\r\n}\r\n\r\nexport async function addDapp(accountId: string, dapp: ApiDapp, uniqueId: string) {\r\n  const dapps = await getDappsByUrl(accountId);\r\n\r\n  if (!dapps[dapp.url]) {\r\n    dapps[dapp.url] = {};\r\n  }\r\n\r\n  dapps[dapp.url][uniqueId] = dapp;\r\n  await setAccountValue(accountId, 'dapps', dapps);\r\n}\r\n\r\nexport async function deleteDapp(\r\n  accountId: string,\r\n  url: string,\r\n  uniqueId: string,\r\n  dontNotifyDapp?: boolean,\r\n) {\r\n  const dapps = await getDappsByUrl(accountId);\r\n  if (!(url in dapps)) {\r\n    return false;\r\n  }\r\n\r\n  delete dapps[url][uniqueId];\r\n  if (isEmptyObject(dapps[url])) {\r\n    delete dapps[url];\r\n  }\r\n\r\n  await setAccountValue(accountId, 'dapps', dapps);\r\n\r\n  if (onUpdate && isUpdaterAlive(onUpdate)) {\r\n    onUpdate({\r\n      type: 'dappDisconnect',\r\n      accountId,\r\n      url,\r\n    });\r\n  }\r\n\r\n  if (!dontNotifyDapp) {\r\n    await callHook('onDappDisconnected', accountId, url);\r\n  }\r\n\r\n  await callHook('onDappsChanged');\r\n\r\n  return true;\r\n}\r\n\r\nexport async function deleteAllDapps(accountId: string) {\r\n  const urls = Object.keys(await getDappsByUrl(accountId));\r\n  await setAccountValue(accountId, 'dapps', {});\r\n\r\n  urls.forEach((url) => {\r\n    onUpdate({\r\n      type: 'dappDisconnect',\r\n      accountId,\r\n      url,\r\n    });\r\n    void callHook('onDappDisconnected', accountId, url);\r\n  });\r\n\r\n  await callHook('onDappsChanged');\r\n}\r\n\r\nexport async function getDapps(accountId: string): Promise<ApiDapp[]> {\r\n  const byUrl = await getDappsByUrl(accountId);\r\n  return Object.values(byUrl).flatMap((byId) => Object.values(byId));\r\n}\r\n\r\nexport async function getDappsByUrl(accountId: string): Promise<ApiDappsByUrl> {\r\n  return (await getAccountValue(accountId, 'dapps')) || {};\r\n}\r\n\r\nexport async function findLastConnectedAccount(network: ApiNetwork, url: string) {\r\n  const dapps = await getDappsState() || {};\r\n\r\n  let connectedAt = 0;\r\n  let lastConnectedAccountId: string | undefined;\r\n\r\n  Object.entries(dapps).forEach(([accountId, byUrl]) => {\r\n    const connections = byUrl[url];\r\n    if (!connections) return;\r\n    if (parseAccountId(accountId).network !== network) return;\r\n\r\n    Object.values(connections).forEach((conn) => {\r\n      if (conn.connectedAt > connectedAt) {\r\n        connectedAt = conn.connectedAt;\r\n        lastConnectedAccountId = accountId;\r\n      }\r\n    });\r\n  });\r\n\r\n  return lastConnectedAccountId;\r\n}\r\n\r\nexport function getDappsState(): Promise<ApiDappsState | undefined> {\r\n  return storage.getItem('dapps');\r\n}\r\n\r\nexport async function removeAccountDapps(accountId: string) {\r\n  await removeAccountValue(accountId, 'dapps');\r\n\r\n  void callHook('onDappsChanged');\r\n}\r\n\r\nexport async function removeAllDapps() {\r\n  await storage.removeItem('dapps');\r\n\r\n  await callHook('onDappsChanged');\r\n}\r\n\r\nexport function removeNetworkDapps(network: ApiNetwork) {\r\n  return removeNetworkAccountsValue(network, 'dapps');\r\n}\r\n\r\nexport function getSseLastEventId(): Promise<string | undefined> {\r\n  return storage.getItem('sseLastEventId');\r\n}\r\n\r\nexport function setSseLastEventId(lastEventId: string) {\r\n  return storage.setItem('sseLastEventId', lastEventId);\r\n}\r\n\r\nexport function loadExploreSites(\r\n  { isLandscape }: { isLandscape: boolean },\r\n): Promise<{ categories: ApiSiteCategory[]; sites: ApiSite[] }> {\r\n  return callBackendGet('/v2/dapp/catalog', { isLandscape });\r\n}\r\n","import { TRON_MAINNET_API_URL, TRON_TESTNET_API_URL } from '../../../config';\r\n\r\nexport const TRON_GAS = {\r\n  transferTrc20Estimated: 28_214_970n,\r\n};\r\n\r\nexport const ONE_TRX = 1_000_000n;\r\n\r\nexport const NETWORK_CONFIG = {\r\n  mainnet: {\r\n    apiUrl: TRON_MAINNET_API_URL,\r\n    usdtAddress: 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t',\r\n  },\r\n  testnet: {\r\n    apiUrl: TRON_TESTNET_API_URL,\r\n    usdtAddress: 'TG3XXyExBkPp9nzdajDZsozEu4BkaSJozs',\r\n  },\r\n};\r\n","import type { ApiNetwork } from '../../../types';\r\n\r\nimport { TRX } from '../../../../config';\r\nimport { buildTokenSlug } from '../../../common/tokens';\r\nimport { NETWORK_CONFIG } from '../constants';\r\n\r\nexport function getTokenSlugs(network: ApiNetwork) {\r\n  const { usdtAddress } = NETWORK_CONFIG[network];\r\n  const usdtSlug = buildTokenSlug('tron', usdtAddress);\r\n  return [TRX.slug, usdtSlug];\r\n}\r\n","import { TronWeb } from 'tronweb';\r\n\r\nimport type { ApiActivity, ApiFetchActivitySliceOptions, ApiNetwork, ApiTransactionActivity } from '../../types';\r\n\r\nimport { TRX } from '../../../config';\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { mergeSortedActivities, sortActivities } from '../../../util/activities/order';\r\nimport { fetchJson } from '../../../util/fetch';\r\nimport isEmptyObject from '../../../util/isEmptyObject';\r\nimport { buildCollectionByKey } from '../../../util/iteratees';\r\nimport { getTokenSlugs } from './util/tokens';\r\nimport { fetchStoredWallet } from '../../common/accounts';\r\nimport { buildTokenSlug, getTokenBySlug } from '../../common/tokens';\r\nimport { NETWORK_CONFIG } from './constants';\r\n\r\nexport async function fetchActivitySlice({\r\n  accountId,\r\n  tokenSlug,\r\n  toTimestamp,\r\n  fromTimestamp,\r\n  limit,\r\n}: ApiFetchActivitySliceOptions): Promise<ApiActivity[]> {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'tron');\r\n\r\n  if (tokenSlug) {\r\n    return getTokenActivitySlice(\r\n      network,\r\n      address,\r\n      tokenSlug,\r\n      toTimestamp,\r\n      fromTimestamp,\r\n      limit,\r\n    );\r\n  } else {\r\n    return getAllActivitySlice(\r\n      network,\r\n      address,\r\n      toTimestamp,\r\n      fromTimestamp,\r\n      limit,\r\n    );\r\n  }\r\n}\r\n\r\nexport async function getTokenActivitySlice(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  slug: string,\r\n  toTimestamp?: number,\r\n  fromTimestamp?: number,\r\n  limit?: number,\r\n) {\r\n  let activities: ApiActivity[];\r\n\r\n  if (slug === TRX.slug) {\r\n    const rawTransactions = await getTrxTransactions(network, address, {\r\n      min_timestamp: fromTimestamp ? fromTimestamp + 1000 : undefined,\r\n      max_timestamp: toTimestamp ? toTimestamp - 1000 : undefined,\r\n      limit,\r\n      search_internal: false, // The parsing is not supported and not needed currently\r\n    });\r\n    activities = rawTransactions.map((rawTx) => parseRawTrxTransaction(address, rawTx));\r\n  } else {\r\n    const { tokenAddress } = getTokenBySlug(slug) || {};\r\n    const rawTransactions = await getTrc20Transactions(network, address, {\r\n      contract_address: tokenAddress,\r\n      min_timestamp: fromTimestamp ? fromTimestamp + 1000 : undefined,\r\n      max_timestamp: toTimestamp ? toTimestamp - 1000 : undefined,\r\n      limit,\r\n    });\r\n    activities = rawTransactions.map((rawTx) => parseRawTrc20Transaction(address, rawTx));\r\n  }\r\n\r\n  // Even though the activities returned by the Tron API are sorted by timestamp, our sorting may differ.\r\n  // It's important to enforce our sorting, because otherwise `mergeSortedActivities` may leave duplicates.\r\n  return sortActivities(activities);\r\n}\r\n\r\nasync function getAllActivitySlice(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  toTimestamp?: number,\r\n  fromTimestamp?: number,\r\n  limit?: number,\r\n) {\r\n  const tokenSlugs = getTokenSlugs(network);\r\n  const txsBySlug: Record<string, ApiActivity[]> = {};\r\n\r\n  await Promise.all(tokenSlugs.map(async (slug) => {\r\n    const txs = await getTokenActivitySlice(\r\n      network, address, slug, toTimestamp, fromTimestamp, limit,\r\n    );\r\n\r\n    if (txs.length) {\r\n      txsBySlug[slug] = txs;\r\n    }\r\n  }));\r\n\r\n  if (isEmptyObject(txsBySlug)) {\r\n    return [];\r\n  }\r\n\r\n  // TODO ,     \" \",          .\r\n  //         .\r\n  const mainChunk = Object.values(txsBySlug).reduce((prevChunk, chunk) => {\r\n    if (prevChunk.length > chunk.length) return prevChunk;\r\n    if (prevChunk.length < chunk.length) return chunk;\r\n    if (prevChunk[prevChunk.length - 1].timestamp < chunk[chunk.length - 1].timestamp) return chunk;\r\n    return prevChunk;\r\n  }, [] as ApiTransactionActivity[]);\r\n\r\n  const oldestTimestamp = mainChunk[mainChunk.length - 1].timestamp;\r\n\r\n  return mergeActivities(txsBySlug)\r\n    .filter(({ timestamp }) => timestamp >= oldestTimestamp);\r\n}\r\n\r\nasync function getTrxTransactions(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  queryParams: {\r\n    only_confirmed?: boolean;\r\n    only_unconfirmed?: boolean;\r\n    only_to?: boolean;\r\n    only_from?: boolean;\r\n    limit?: number;\r\n    fingerprint?: string;\r\n    order_by?: 'block_timestamp,asc' | 'block_timestamp,desc';\r\n    min_timestamp?: number;\r\n    max_timestamp?: number;\r\n    search_internal?: boolean;\r\n  } = {},\r\n): Promise<any[]> {\r\n  const baseUrl = NETWORK_CONFIG[network].apiUrl;\r\n  const url = new URL(`${baseUrl}/v1/accounts/${address}/transactions`);\r\n\r\n  const result = await fetchJson(url.toString(), queryParams);\r\n\r\n  return result.data;\r\n}\r\n\r\nfunction parseRawTrxTransaction(address: string, rawTx: any): ApiTransactionActivity {\r\n  const {\r\n    raw_data: rawData,\r\n    txID: txId,\r\n    energy_fee: energyFee,\r\n    net_fee: netFee,\r\n    block_timestamp: timestamp,\r\n  } = rawTx;\r\n\r\n  const parameters = rawData.contract[0].parameter.value;\r\n  const amount = BigInt(parameters.amount ?? 0);\r\n  const fromAddress = TronWeb.address.fromHex(parameters.owner_address);\r\n  const toAddress = TronWeb.address.fromHex(\r\n    parameters.to_address || parameters.receiver_address || parameters.contract_address,\r\n  );\r\n\r\n  const slug = TRX.slug;\r\n  const isIncoming = toAddress === address;\r\n  const normalizedAddress = isIncoming ? fromAddress : toAddress;\r\n  const fee = BigInt(energyFee + netFee);\r\n  const type = rawData.contract[0].type === 'TriggerSmartContract' ? 'callContract' : undefined;\r\n  const shouldHide = rawData.contract[0].type === 'TransferAssetContract';\r\n\r\n  return {\r\n    id: txId,\r\n    kind: 'transaction',\r\n    timestamp,\r\n    fromAddress,\r\n    toAddress,\r\n    amount: isIncoming ? amount : -amount,\r\n    slug,\r\n    isIncoming,\r\n    normalizedAddress,\r\n    fee,\r\n    type,\r\n    shouldHide,\r\n    status: 'completed',\r\n  };\r\n}\r\n\r\nasync function getTrc20Transactions(\r\n  network: ApiNetwork,\r\n  address: string,\r\n  queryParams: {\r\n    only_confirmed?: boolean;\r\n    only_unconfirmed?: boolean;\r\n    limit?: number;\r\n    fingerprint?: string;\r\n    order_by?: 'block_timestamp,asc' | 'block_timestamp,desc';\r\n    min_timestamp?: number;\r\n    max_timestamp?: number;\r\n    contract_address?: string;\r\n    only_to?: boolean;\r\n    only_from?: boolean;\r\n  } = {},\r\n): Promise<any[]> {\r\n  const baseUrl = NETWORK_CONFIG[network].apiUrl;\r\n  const url = new URL(`${baseUrl}/v1/accounts/${address}/transactions/trc20`);\r\n\r\n  const result = await fetchJson(url.toString(), queryParams);\r\n\r\n  return result.data;\r\n}\r\n\r\nfunction parseRawTrc20Transaction(address: string, rawTx: any): ApiTransactionActivity {\r\n  const {\r\n    transaction_id: txId,\r\n    block_timestamp: timestamp,\r\n    from: fromAddress,\r\n    to: toAddress,\r\n    value,\r\n    token_info: tokenInfo,\r\n  } = rawTx;\r\n\r\n  const amount = BigInt(value);\r\n  const slug = buildTokenSlug(TRX.chain, tokenInfo.address);\r\n  const isIncoming = toAddress === address;\r\n  const normalizedAddress = isIncoming ? fromAddress : toAddress;\r\n  const fee = 0n;\r\n\r\n  return {\r\n    id: txId,\r\n    kind: 'transaction',\r\n    timestamp,\r\n    fromAddress,\r\n    toAddress,\r\n    amount: isIncoming ? amount : -amount,\r\n    slug,\r\n    isIncoming,\r\n    normalizedAddress,\r\n    fee,\r\n    status: 'completed',\r\n  };\r\n}\r\n\r\nexport function mergeActivities(txsBySlug: Record<string, ApiActivity[]>): ApiActivity[] {\r\n  const seenTxIds = new Set<string>();\r\n  const isSeenTxId = (id: string) => {\r\n    if (seenTxIds.has(id)) return true;\r\n    seenTxIds.add(id);\r\n    return false;\r\n  };\r\n\r\n  const {\r\n    [TRX.slug]: trxTxs = [],\r\n    ...tokenTxs\r\n  } = txsBySlug;\r\n\r\n  const trxTxById = buildCollectionByKey(trxTxs, 'id');\r\n\r\n  return mergeSortedActivities(\r\n    ...Object.values(tokenTxs).map((tokenTxList) =>\r\n      tokenTxList\r\n        // Different tokens have the same transaction id if they share the same backend swap.\r\n        // The duplicates need to removed.\r\n        .filter((tokenTx) => !isSeenTxId(tokenTx.id))\r\n        .map((tokenTx) => {\r\n          const trxTx = trxTxById[tokenTx.id];\r\n          if (tokenTx.kind === 'transaction' && trxTx?.kind === 'transaction') {\r\n            tokenTx.fee = trxTx.fee;\r\n          }\r\n          return tokenTx;\r\n        }),\r\n    ),\r\n    // Because of `isSeenTxId`, it's necessary to filter the TRX transactions after the token transactions\r\n    trxTxs.filter((trxTx) => !isSeenTxId(trxTx.id) && (trxTx.kind !== 'transaction' || trxTx.toAddress)),\r\n  );\r\n}\r\n\r\nexport function fetchActivityDetails() {\r\n  return undefined;\r\n}\r\n","import { TronWeb } from 'tronweb';\r\n\r\nimport type { ApiNetwork } from '../../../types';\r\n\r\nimport withCache from '../../../../util/withCache';\r\nimport withCacheAsync from '../../../../util/withCacheAsync';\r\nimport { NETWORK_CONFIG } from '../constants';\r\n\r\nexport const getTronClient = withCache((network: ApiNetwork) => {\r\n  return new TronWeb({\r\n    fullHost: NETWORK_CONFIG[network].apiUrl,\r\n  });\r\n});\r\n\r\nexport const getChainParameters = withCacheAsync(async (network: ApiNetwork) => {\r\n  const chainParameters = await getTronClient(network).trx.getChainParameters();\r\n  const energyUnitFee = chainParameters.find((param) => param.key === 'getEnergyFee')!.value;\r\n  const bandwidthUnitFee = chainParameters.find((param) => param.key === 'getTransactionFee')!.value;\r\n  return { energyUnitFee, bandwidthUnitFee };\r\n});\r\n","import type { TronWeb } from 'tronweb';\r\n\r\nimport type { ApiNetwork } from '../../types';\r\n\r\nimport isEmptyObject from '../../../util/isEmptyObject';\r\nimport { logDebugError } from '../../../util/logs';\r\nimport { getTronClient } from './util/tronweb';\r\n\r\n/*\r\n* We display unconfirmed balance and transactions to user.\r\n* /wallet/* - endpoints with unconfirmed data\r\n* /walletsolidity/* - endpoints with confirmed data\r\n*/\r\n\r\nexport async function getWalletBalance(network: ApiNetwork, address: string) {\r\n  const tronWeb = getTronClient(network);\r\n  return BigInt(await tronWeb.trx.getUnconfirmedBalance(address));\r\n}\r\n\r\nexport async function getTrc20Balance(network: ApiNetwork, tokenAddress: string, address: string) {\r\n  const result = await callContract(getTronClient(network), tokenAddress, 'balanceOf(address)', [\r\n    { type: 'address', value: address },\r\n  ], address);\r\n\r\n  if (!result.length) {\r\n    return 0n;\r\n  }\r\n\r\n  return BigInt(`0x${result[0]}`);\r\n}\r\n\r\nexport async function callContract(\r\n  tronWeb: TronWeb,\r\n  address: string,\r\n  functions: string,\r\n  parameters: any[] = [],\r\n  issuerAddress: string,\r\n) {\r\n  try {\r\n    const result = await tronWeb.transactionBuilder.triggerSmartContract(\r\n      address,\r\n      functions,\r\n      { _isConstant: true },\r\n      parameters,\r\n      issuerAddress,\r\n    );\r\n    return result && result.result ? result.constant_result : [];\r\n  } catch (err: any) {\r\n    logDebugError('callContract', err);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport async function isTronAccountMultisig(network: ApiNetwork, address: string) {\r\n  try {\r\n    const tronWeb = getTronClient(network);\r\n    const account = await tronWeb.trx.getAccount(address);\r\n    if (!account || isEmptyObject(account)) {\r\n      return false;\r\n    }\r\n    const managerAddresses = new Set<string>();\r\n    if (account.owner_permission.threshold > 1) {\r\n      return true;\r\n    }\r\n    for (const permKey of account.owner_permission.keys) {\r\n      managerAddresses.add(tronWeb.address.fromHex(permKey.address));\r\n    }\r\n    for (const perm of account.active_permission) {\r\n      if (perm.threshold > 1) {\r\n        return true;\r\n      }\r\n      for (const permKey of perm.keys) {\r\n        managerAddresses.add(tronWeb.address.fromHex(permKey.address));\r\n      }\r\n    }\r\n\r\n    if (managerAddresses.size > 1) {\r\n      return true;\r\n    }\r\n\r\n    for (const managerAddress of managerAddresses) {\r\n      if (managerAddress !== address) {\r\n        return true;\r\n      }\r\n    }\r\n\r\n    return false;\r\n  } catch (e) {\r\n    logDebugError('isTronAccountMultisig', e);\r\n    return false;\r\n  }\r\n}\r\n","import type {\r\n  ApiAccountWithChain,\r\n  ApiActivity,\r\n  ApiActivityTimestamps,\r\n  ApiBalanceBySlug,\r\n  OnApiUpdate,\r\n  OnUpdatingStatusChange,\r\n} from '../../types';\r\n\r\nimport { TRX } from '../../../config';\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { areDeepEqual } from '../../../util/areDeepEqual';\r\nimport isEmptyObject from '../../../util/isEmptyObject';\r\nimport { logDebugError } from '../../../util/logs';\r\nimport { getTokenSlugs } from './util/tokens';\r\nimport { fetchStoredWallet } from '../../common/accounts';\r\nimport { setupInactiveChainPolling } from '../../common/polling/setupInactiveChainPolling';\r\nimport { activeWalletTiming } from '../../common/polling/utils';\r\nimport { WalletPolling } from '../../common/polling/walletPolling';\r\nimport { swapReplaceCexActivities } from '../../common/swap';\r\nimport { buildTokenSlug } from '../../common/tokens';\r\nimport { txCallbacks } from '../../common/txCallbacks';\r\nimport { FIRST_TRANSACTIONS_LIMIT } from '../../constants';\r\nimport { getTokenActivitySlice, mergeActivities } from './activities';\r\nimport { NETWORK_CONFIG } from './constants';\r\nimport { getTrc20Balance, getWalletBalance, isTronAccountMultisig } from './wallet';\r\n\r\nexport function setupActivePolling(\r\n  accountId: string,\r\n  account: ApiAccountWithChain<'tron'>,\r\n  onUpdate: OnApiUpdate,\r\n  onUpdatingStatusChange: OnUpdatingStatusChange,\r\n  newestActivityTimestamps: ApiActivityTimestamps,\r\n): NoneToVoidFunction {\r\n  const { address } = account.byChain.tron;\r\n\r\n  const balancePolling = setupBalancePolling(\r\n    accountId,\r\n    address,\r\n    onUpdate,\r\n    onUpdatingStatusChange.bind(undefined, 'balance'),\r\n  );\r\n  const activityPolling = setupActivityPolling(\r\n    accountId,\r\n    newestActivityTimestamps,\r\n    onUpdate,\r\n    onUpdatingStatusChange.bind(undefined, 'activities'),\r\n  );\r\n  const multisigPolling = setupMultisigPolling(\r\n    accountId,\r\n    address,\r\n    onUpdate,\r\n  );\r\n\r\n  let isFirstUpdate = true;\r\n\r\n  async function handleUpdate(isConfident: boolean) {\r\n    if (isConfident || isFirstUpdate) {\r\n      await Promise.all([\r\n        balancePolling.update(),\r\n        activityPolling.update(),\r\n        multisigPolling.update(),\r\n      ]);\r\n    } else {\r\n      // Legacy (timer) polling mode.\r\n      // The balance is checked before the activities, because the backend throttling for balance is much looser.\r\n      const hasBalanceChanged = await balancePolling.update();\r\n      if (hasBalanceChanged) {\r\n        await Promise.all([\r\n          activityPolling.update(),\r\n          multisigPolling.update(),\r\n        ]);\r\n      }\r\n    }\r\n\r\n    isFirstUpdate = false;\r\n  }\r\n\r\n  const walletPolling = new WalletPolling({\r\n    chain: 'tron',\r\n    network: parseAccountId(accountId).network,\r\n    address,\r\n    pollingOptions: activeWalletTiming,\r\n    onUpdate: handleUpdate,\r\n  });\r\n\r\n  return () => {\r\n    walletPolling.destroy();\r\n  };\r\n}\r\n\r\nfunction setupBalancePolling(\r\n  accountId: string,\r\n  address: string,\r\n  onUpdate: OnApiUpdate,\r\n  onUpdatingStatusChange?: (isUpdating: boolean) => void,\r\n) {\r\n  const { network } = parseAccountId(accountId);\r\n  const { usdtAddress } = NETWORK_CONFIG[network];\r\n  const usdtSlug = buildTokenSlug('tron', usdtAddress);\r\n\r\n  let balances: ApiBalanceBySlug | undefined;\r\n\r\n  /** Returns `true` if the balances have changed since the last update */\r\n  async function update() {\r\n    onUpdatingStatusChange?.(true);\r\n\r\n    try {\r\n      const [trxBalance, usdtBalance] = await Promise.all([\r\n        getWalletBalance(network, address),\r\n        getTrc20Balance(network, usdtAddress, address),\r\n      ]);\r\n      const newBalances = {\r\n        [TRX.slug]: trxBalance,\r\n        [usdtSlug]: usdtBalance,\r\n      };\r\n      const hasChanged = !areDeepEqual(balances, newBalances);\r\n      balances = newBalances;\r\n\r\n      if (hasChanged) {\r\n        onUpdate({\r\n          type: 'updateBalances',\r\n          accountId,\r\n          chain: 'tron',\r\n          balances,\r\n        });\r\n      }\r\n\r\n      return hasChanged;\r\n    } catch (err) {\r\n      logDebugError('setupBalancePolling update', err);\r\n    } finally {\r\n      onUpdatingStatusChange?.(false);\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  return { update };\r\n}\r\n\r\nfunction setupMultisigPolling(\r\n  accountId: string,\r\n  address: string,\r\n  onUpdate: OnApiUpdate,\r\n) {\r\n  const { network } = parseAccountId(accountId);\r\n  let isMultisig: boolean | undefined;\r\n\r\n  async function update() {\r\n    try {\r\n      const multisigStatus = await isTronAccountMultisig(network, address);\r\n      const hasChanged = isMultisig !== multisigStatus;\r\n      isMultisig = multisigStatus;\r\n\r\n      if (hasChanged) {\r\n        onUpdate({\r\n          type: 'updateAccount',\r\n          accountId,\r\n          chain: 'tron',\r\n          isMultisig: multisigStatus,\r\n        });\r\n      }\r\n\r\n      return hasChanged;\r\n    } catch (err) {\r\n      logDebugError('setupMultisigPolling update', err);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  return { update };\r\n}\r\n\r\nfunction setupActivityPolling(\r\n  accountId: string,\r\n  newestActivityTimestamps: ApiActivityTimestamps,\r\n  onUpdate: OnApiUpdate,\r\n  onUpdatingStatusChange: (isUpdating: boolean) => void,\r\n) {\r\n  const { network } = parseAccountId(accountId);\r\n  const slugs = getTokenSlugs(network);\r\n\r\n  async function update() {\r\n    onUpdatingStatusChange(true);\r\n\r\n    try {\r\n      if (isEmptyObject(newestActivityTimestamps)) {\r\n        newestActivityTimestamps = await loadInitialActivities(accountId, slugs, onUpdate);\r\n      } else {\r\n        newestActivityTimestamps = await loadNewActivities(accountId, newestActivityTimestamps, slugs, onUpdate);\r\n      }\r\n    } catch (err) {\r\n      logDebugError('setupActivityPolling update', err);\r\n    } finally {\r\n      onUpdatingStatusChange(false);\r\n    }\r\n  }\r\n\r\n  return { update };\r\n}\r\n\r\nexport function setupInactivePolling(\r\n  accountId: string,\r\n  account: ApiAccountWithChain<'tron'>,\r\n  onUpdate: OnApiUpdate,\r\n): NoneToVoidFunction {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = account.byChain.tron;\r\n\r\n  const balancePolling = setupBalancePolling(accountId, address, onUpdate);\r\n\r\n  return setupInactiveChainPolling('tron', network, address, balancePolling.update);\r\n}\r\n\r\nasync function loadInitialActivities(\r\n  accountId: string,\r\n  tokenSlugs: string[],\r\n  onUpdate: OnApiUpdate,\r\n) {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'tron');\r\n  const result: ApiActivityTimestamps = {};\r\n  const bySlug: Record<string, ApiActivity[]> = {};\r\n\r\n  await Promise.all(tokenSlugs.map(async (slug) => {\r\n    let activities: ApiActivity[] = await getTokenActivitySlice(\r\n      network, address, slug, undefined, undefined, FIRST_TRANSACTIONS_LIMIT,\r\n    );\r\n\r\n    activities = await swapReplaceCexActivities(accountId, activities, slug, true);\r\n\r\n    result[slug] = activities[0]?.timestamp;\r\n    bySlug[slug] = activities;\r\n  }));\r\n\r\n  const mainActivities = mergeActivities(bySlug);\r\n\r\n  mainActivities.slice().reverse().forEach((transaction) => {\r\n    txCallbacks.runCallbacks(transaction);\r\n  });\r\n\r\n  onUpdate({\r\n    type: 'initialActivities',\r\n    chain: 'tron',\r\n    accountId,\r\n    mainActivities,\r\n    bySlug,\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\nasync function loadNewActivities(\r\n  accountId: string,\r\n  newestActivityTimestamps: ApiActivityTimestamps,\r\n  tokenSlugs: string[],\r\n  onUpdate: OnApiUpdate,\r\n) {\r\n  const { network } = parseAccountId(accountId);\r\n  const { address } = await fetchStoredWallet(accountId, 'tron');\r\n  const result: ApiActivityTimestamps = {};\r\n  const bySlug: Record<string, ApiActivity[]> = {};\r\n\r\n  await Promise.all(tokenSlugs.map(async (slug) => {\r\n    let newestActivityTimestamp = newestActivityTimestamps[slug];\r\n    const activities: ApiActivity[] = await getTokenActivitySlice(\r\n      network, address, slug, undefined, newestActivityTimestamp, FIRST_TRANSACTIONS_LIMIT,\r\n    );\r\n\r\n    newestActivityTimestamp = activities[0]?.timestamp ?? newestActivityTimestamp;\r\n    result[slug] = newestActivityTimestamp;\r\n    bySlug[slug] = activities;\r\n  }));\r\n\r\n  let activities = mergeActivities(bySlug);\r\n\r\n  activities = await swapReplaceCexActivities(accountId, activities, undefined, true);\r\n\r\n  activities.slice().reverse().forEach((activity) => {\r\n    txCallbacks.runCallbacks(activity);\r\n  });\r\n\r\n  if (activities.length > 0) {\r\n    onUpdate({\r\n      type: 'newActivities',\r\n      chain: 'tron',\r\n      activities,\r\n      pendingActivities: [],\r\n      accountId,\r\n    });\r\n  }\r\n\r\n  return result;\r\n}\r\n","import type { ChainSdk } from '../../types/chains';\r\n\r\nimport { fetchActivityDetails, fetchActivitySlice } from './activities';\r\nimport { getWalletFromAddress, getWalletFromBip39Mnemonic } from './auth';\r\nimport { setupActivePolling, setupInactivePolling } from './polling';\r\nimport { checkTransactionDraft, submitTransfer } from './transfer';\r\n\r\nfunction notSupported(): never {\r\n  throw new Error('Not supported in Tron');\r\n}\r\n\r\nconst tronSdk: ChainSdk<'tron'> = {\r\n  fetchActivitySlice,\r\n  fetchActivityDetails,\r\n  decryptComment: notSupported,\r\n  getWalletFromBip39Mnemonic,\r\n  getWalletFromAddress,\r\n  // A note for the future implementation:\r\n  // In contrast to TON, Tron doesn't allow loading balances of multiple wallets in 1 request. Loading a wallet from\r\n  // Ledger is relatively slow. So, to parallelize and speed up the loading, each balance should be loaded as soon as\r\n  // the corresponding wallet is loaded from Ledger.\r\n  getWalletsFromLedgerAndLoadBalance: notSupported,\r\n  setupActivePolling,\r\n  setupInactivePolling,\r\n  checkTransactionDraft,\r\n  submitTransfer,\r\n  verifyLedgerWalletAddress: notSupported,\r\n  getIsLedgerAppOpen: notSupported,\r\n};\r\n\r\nexport default tronSdk;\r\n","import type { ApiNetwork, ApiTronWallet } from '../../types';\r\nimport { ApiAuthError } from '../../types';\r\n\r\nimport { getChainConfig } from '../../../util/chain';\r\nimport { getTronClient } from './util/tronweb';\r\n\r\nexport function getWalletFromBip39Mnemonic(network: ApiNetwork, mnemonic: string[]): ApiTronWallet {\r\n  const { address, publicKey } = getTronClient(network).fromMnemonic(mnemonic.join(' '));\r\n  return {\r\n    address,\r\n    publicKey,\r\n    index: 0,\r\n  };\r\n}\r\n\r\nexport function getWalletFromAddress(\r\n  network: ApiNetwork,\r\n  addressOrDomain: string,\r\n): { title?: string; wallet: ApiTronWallet } | { error: ApiAuthError } {\r\n  const { addressRegex } = getChainConfig('tron');\r\n\r\n  if (!addressRegex.test(addressOrDomain)) {\r\n    return { error: ApiAuthError.InvalidAddress };\r\n  }\r\n\r\n  return {\r\n    wallet: {\r\n      address: addressOrDomain,\r\n      index: 0,\r\n    },\r\n  };\r\n}\r\n","// Importing from `tronweb/lib/commonjs/types` breaks eslint (eslint doesn't like any of import placement options)\r\n// eslint-disable-next-line simple-import-sort/imports\r\nimport type { TronWeb } from 'tronweb';\r\n\r\nimport type { ApiSubmitTransferOptions, CheckTransactionDraftOptions } from '../../methods/types';\r\nimport type { ApiCheckTransactionDraftResult } from '../ton/types';\r\nimport { ApiTransactionDraftError, ApiTransactionError } from '../../types';\r\nimport type { ApiNetwork } from '../../types';\r\n\r\nimport { parseAccountId } from '../../../util/account';\r\nimport { logDebugError } from '../../../util/logs';\r\nimport { getChainParameters, getTronClient } from './util/tronweb';\r\nimport { fetchStoredChainAccount, fetchStoredWallet } from '../../common/accounts';\r\nimport { getMnemonic } from '../../common/mnemonic';\r\nimport { handleServerError } from '../../errors';\r\nimport { getTrc20Balance, getWalletBalance } from './wallet';\r\nimport type { ApiSubmitTransferTronResult } from './types';\r\nimport { hexToString } from '../../../util/stringFormat';\r\nimport { ONE_TRX, TRON_GAS } from './constants';\r\n\r\nconst SIGNATURE_SIZE = 65;\r\n\r\nexport async function checkTransactionDraft(\r\n  options: CheckTransactionDraftOptions,\r\n): Promise<ApiCheckTransactionDraftResult> {\r\n  const {\r\n    accountId, amount, toAddress, tokenAddress,\r\n  } = options;\r\n  const { network } = parseAccountId(accountId);\r\n\r\n  const tronWeb = getTronClient(network);\r\n  const result: ApiCheckTransactionDraftResult = {};\r\n\r\n  try {\r\n    if (!tronWeb.isAddress(toAddress)) {\r\n      return { error: ApiTransactionDraftError.InvalidToAddress };\r\n    }\r\n\r\n    result.resolvedAddress = toAddress;\r\n\r\n    const { address } = await fetchStoredWallet(accountId, 'tron');\r\n    const [trxBalance, bandwidth, { energyUnitFee, bandwidthUnitFee }] = await Promise.all([\r\n      getWalletBalance(network, address),\r\n      tronWeb.trx.getBandwidth(address),\r\n      getChainParameters(network),\r\n    ]);\r\n\r\n    let fee: bigint;\r\n\r\n    if (tokenAddress) {\r\n      fee = await estimateTrc20TransferFee(tronWeb, {\r\n        network,\r\n        toAddress,\r\n        tokenAddress,\r\n        amount,\r\n        energyUnitFee,\r\n        fromAddress: address,\r\n      });\r\n    } else {\r\n      // This call throws \"Error: Invalid amount provided\" when the amount is 0.\r\n      // It doesn't throw when the amount is > than the balance.\r\n      const [transaction, account] = await Promise.all([\r\n        tronWeb.transactionBuilder.sendTrx(toAddress, Number(amount ?? 1), address),\r\n        tronWeb.trx.getAccount(toAddress),\r\n      ]);\r\n\r\n      const size = 9 + 60 + Buffer.from(transaction.raw_data_hex, 'hex').byteLength + SIGNATURE_SIZE;\r\n      fee = bandwidth > size ? 0n : BigInt(size) * BigInt(bandwidthUnitFee);\r\n\r\n      // If the account is not activated, we pay an extra 1 TRX for activation\r\n      if (account.balance === undefined) {\r\n        fee += ONE_TRX;\r\n      }\r\n    }\r\n\r\n    result.fee = fee;\r\n    result.realFee = fee;\r\n\r\n    const trxAmount = tokenAddress ? fee : (amount ?? 0n) + fee;\r\n    const isEnoughTrx = trxBalance >= trxAmount;\r\n\r\n    if (!isEnoughTrx) {\r\n      result.error = ApiTransactionDraftError.InsufficientBalance;\r\n    }\r\n\r\n    // todo: Check that the amount  the token balance (in case of a token transfer)\r\n\r\n    return result;\r\n  } catch (err) {\r\n    logDebugError('tron:checkTransactionDraft', err);\r\n    return {\r\n      ...handleServerError(err),\r\n      ...result,\r\n    };\r\n  }\r\n}\r\n\r\nexport async function submitTransfer(options: ApiSubmitTransferOptions): Promise<ApiSubmitTransferTronResult> {\r\n  const {\r\n    accountId, password = '', toAddress, amount, fee = 0n, tokenAddress,\r\n  } = options;\r\n\r\n  const { network } = parseAccountId(accountId);\r\n\r\n  try {\r\n    const tronWeb = getTronClient(network);\r\n\r\n    const account = await fetchStoredChainAccount(accountId, 'tron');\r\n    if (account.type === 'ledger') throw new Error('Not supported by Ledger accounts');\r\n    if (account.type === 'view') throw new Error('Not supported by View accounts');\r\n\r\n    const { address } = account.byChain.tron;\r\n    const trxBalance = await getWalletBalance(network, address);\r\n\r\n    const trxAmount = tokenAddress ? fee : fee + amount;\r\n    const isEnoughTrx = trxBalance >= trxAmount;\r\n\r\n    if (!isEnoughTrx) {\r\n      return { error: ApiTransactionError.InsufficientBalance };\r\n    }\r\n\r\n    // todo: Check that the amount  the token balance (in case of a token transfer)\r\n\r\n    const mnemonic = await getMnemonic(accountId, password, account);\r\n    const privateKey = tronWeb.fromMnemonic(mnemonic!.join(' ')).privateKey.slice(2);\r\n\r\n    if (tokenAddress) {\r\n      const { transaction } = await buildTrc20Transfer(tronWeb, {\r\n        toAddress, tokenAddress, amount, feeLimit: fee, fromAddress: address,\r\n      });\r\n\r\n      const signedTx = await tronWeb.trx.sign(transaction, privateKey);\r\n      const result = await tronWeb.trx.sendRawTransaction(signedTx);\r\n\r\n      return { amount, toAddress, txId: result.transaction.txID };\r\n    } else {\r\n      const result = await tronWeb.trx.sendTransaction(toAddress, Number(amount), {\r\n        privateKey,\r\n      });\r\n\r\n      if ('code' in result && !('result' in result && result.result)) {\r\n        const error = 'message' in result && result.message\r\n          ? hexToString(result.message)\r\n          : result.code.toString();\r\n\r\n        logDebugError('submitTransfer', { error, result });\r\n\r\n        return { error };\r\n      }\r\n\r\n      return { amount, toAddress, txId: result.transaction.txID };\r\n    }\r\n  } catch (err: any) {\r\n    logDebugError('submitTransfer', err);\r\n    return { error: ApiTransactionError.UnsuccesfulTransfer };\r\n  }\r\n}\r\n\r\nasync function estimateTrc20TransferFee(tronWeb: TronWeb, options: {\r\n  network: ApiNetwork;\r\n  tokenAddress: string;\r\n  toAddress: string;\r\n  amount?: bigint;\r\n  energyUnitFee: number;\r\n  fromAddress: string;\r\n}) {\r\n  const {\r\n    network, tokenAddress, toAddress, energyUnitFee, fromAddress,\r\n  } = options;\r\n\r\n  let { amount } = options;\r\n  const tokenBalance = await getTrc20Balance(network, tokenAddress, fromAddress);\r\n\r\n  if (!tokenBalance) {\r\n    return TRON_GAS.transferTrc20Estimated;\r\n  }\r\n\r\n  if (amount === undefined || amount > tokenBalance) {\r\n    amount = 1n;\r\n  }\r\n\r\n  // This call throws \"Error: REVERT opcode executed\" when the given amount is more than the token balance.\r\n  // It doesn't throw when the amount is 0.\r\n  const { energy_required: energyRequired } = await tronWeb.transactionBuilder.estimateEnergy(\r\n    tokenAddress,\r\n    'transfer(address,uint256)',\r\n    {},\r\n    [\r\n      { type: 'address', value: toAddress },\r\n      { type: 'uint256', value: Number(amount) },\r\n    ],\r\n    fromAddress,\r\n  );\r\n\r\n  return BigInt(energyUnitFee * energyRequired);\r\n}\r\n\r\nasync function buildTrc20Transfer(tronWeb: TronWeb, options: {\r\n  tokenAddress: string;\r\n  toAddress: string;\r\n  amount: bigint;\r\n  feeLimit: bigint;\r\n  fromAddress: string;\r\n}) {\r\n  const {\r\n    amount, tokenAddress, toAddress, feeLimit, fromAddress,\r\n  } = options;\r\n\r\n  const { transaction } = await tronWeb.transactionBuilder.triggerSmartContract(\r\n    tokenAddress,\r\n    'transfer(address,uint256)',\r\n    { feeLimit: Number(feeLimit) },\r\n    [\r\n      { type: 'address', value: toAddress },\r\n      { type: 'uint256', value: Number(amount) },\r\n    ],\r\n    fromAddress,\r\n  );\r\n\r\n  return { transaction };\r\n}\r\n","export function isAscii(str: string) {\r\n  for (let i = 0; i < str.length; i++) {\r\n    if (str.charCodeAt(i) > 127) {\r\n      return false;\r\n    }\r\n  }\r\n  return true;\r\n}\r\n\r\nexport function insertSubstring(str: string, start: number, newSubStr: string) {\r\n  if (start < 0) {\r\n    start = str.length - start;\r\n  }\r\n  return str.slice(0, start) + newSubStr + str.slice(start);\r\n}\r\n\r\nexport function hexToString(hex: string): string {\r\n  let result = '';\r\n  for (let i = 0; i < hex.length; i += 2) {\r\n    result += String.fromCharCode(parseInt(hex.slice(i, i + 2), 16));\r\n  }\r\n\r\n  return result;\r\n}\r\n","import type { ApiChain } from '../types';\r\nimport type { ChainSdk } from '../types/chains';\r\n\r\nimport ton from './ton';\r\nimport tron from './tron';\r\n\r\n/**\r\n * This dictionary contains only universal chain methods, i.e. the methods having the same interface in all the chains.\r\n *\r\n * If you need chain-specific methods, import them directly from the corresponding chain module. This is deprecated \r\n * all chain methods should be universal. If a chain doesn't support some functionality yet, the corresponding methods\r\n * should simply throw an error.\r\n */\r\nexport const chains: { [K in ApiChain]: ChainSdk<K> } = {\r\n  ton,\r\n  tron,\r\n};\r\n\r\nexport default chains;\r\n","import { parseAccountId } from '../../util/account';\r\nimport * as ton from '../chains/ton';\r\n\r\nexport { getTokenBySlug, buildTokenSlug } from '../common/tokens';\r\n\r\nexport function fetchToken(accountId: string, address: string) {\r\n  const { network } = parseAccountId(accountId);\r\n  return ton.fetchToken(network, address);\r\n}\r\n","import { Cell } from '@ton/core';\r\n\r\nimport type { ApiSubmitTransferTonResult, ApiSubmitTransferWithDieselResult } from '../chains/ton/types';\r\nimport type { ApiSubmitTransferTronResult } from '../chains/tron/types';\r\nimport type { ApiActivity, ApiChain, ApiLocalTransactionParams, ApiTransactionActivity, OnApiUpdate } from '../types';\r\nimport type { ApiSubmitTransferOptions, ApiSubmitTransferResult, CheckTransactionDraftOptions } from './types';\r\n\r\nimport { parseAccountId } from '../../util/account';\r\nimport { buildLocalTxId } from '../../util/activities';\r\nimport { getNativeToken } from '../../util/tokens';\r\nimport chains from '../chains';\r\nimport * as ton from '../chains/ton';\r\nimport { fetchStoredAddress } from '../common/accounts';\r\nimport { buildLocalTransaction } from '../common/helpers';\r\nimport { FAKE_TX_ID } from '../constants';\r\nimport { buildTokenSlug } from './tokens';\r\n\r\nlet onUpdate: OnApiUpdate;\r\n\r\nexport function initTransfer(_onUpdate: OnApiUpdate) {\r\n  onUpdate = _onUpdate;\r\n}\r\n\r\nexport function checkTransactionDraft(chain: ApiChain, options: CheckTransactionDraftOptions) {\r\n  return chains[chain].checkTransactionDraft(options);\r\n}\r\n\r\nexport async function submitTransfer(\r\n  chain: ApiChain,\r\n  options: ApiSubmitTransferOptions,\r\n  shouldCreateLocalActivity = true,\r\n): Promise<ApiSubmitTransferResult> {\r\n  const {\r\n    accountId,\r\n    password,\r\n    toAddress,\r\n    amount,\r\n    tokenAddress,\r\n    comment,\r\n    fee,\r\n    realFee,\r\n    shouldEncrypt,\r\n    isBase64Data,\r\n    withDiesel,\r\n    dieselAmount,\r\n    isGaslessWithStars,\r\n    noFeeCheck,\r\n  } = options;\r\n  const stateInit = typeof options.stateInit === 'string' ? Cell.fromBase64(options.stateInit) : options.stateInit;\r\n\r\n  const fromAddress = await fetchStoredAddress(accountId, chain);\r\n\r\n  let result: ApiSubmitTransferTonResult | ApiSubmitTransferTronResult | ApiSubmitTransferWithDieselResult;\r\n\r\n  if (withDiesel && chain === 'ton') {\r\n    result = await ton.submitTransferWithDiesel({\r\n      accountId,\r\n      password,\r\n      toAddress,\r\n      amount,\r\n      tokenAddress: tokenAddress!,\r\n      data: comment,\r\n      shouldEncrypt,\r\n      dieselAmount: dieselAmount!,\r\n      isGaslessWithStars,\r\n    });\r\n  } else {\r\n    result = await chains[chain].submitTransfer({\r\n      accountId,\r\n      password,\r\n      toAddress,\r\n      amount,\r\n      tokenAddress,\r\n      data: comment,\r\n      shouldEncrypt,\r\n      isBase64Data,\r\n      stateInit,\r\n      fee,\r\n      noFeeCheck,\r\n    });\r\n  }\r\n\r\n  if ('error' in result) {\r\n    return result;\r\n  }\r\n\r\n  if (!shouldCreateLocalActivity) {\r\n    return result;\r\n  }\r\n\r\n  const slug = tokenAddress\r\n    ? buildTokenSlug(chain, tokenAddress)\r\n    : getNativeToken(chain).slug;\r\n\r\n  let localActivity: ApiTransactionActivity;\r\n\r\n  if ('msgHash' in result) {\r\n    const { encryptedComment, msgHashNormalized } = result;\r\n    [localActivity] = createLocalTransactions(accountId, chain, [{\r\n      id: msgHashNormalized,\r\n      amount,\r\n      fromAddress,\r\n      toAddress,\r\n      comment: shouldEncrypt ? undefined : comment,\r\n      encryptedComment,\r\n      fee: realFee ?? 0n,\r\n      slug,\r\n      externalMsgHashNorm: msgHashNormalized,\r\n      extra: {\r\n        ...('withW5Gasless' in result && { withW5Gasless: result.withW5Gasless }),\r\n      },\r\n    }]);\r\n    if ('paymentLink' in result && result.paymentLink) {\r\n      onUpdate({ type: 'openUrl', url: result.paymentLink, isExternal: true });\r\n    }\r\n  } else {\r\n    const { txId } = result;\r\n    [localActivity] = createLocalTransactions(accountId, chain, [{\r\n      id: txId,\r\n      amount,\r\n      fromAddress,\r\n      toAddress,\r\n      comment,\r\n      fee: realFee ?? 0n,\r\n      slug,\r\n    }]);\r\n  }\r\n\r\n  return {\r\n    ...result,\r\n    activityId: localActivity.id,\r\n  };\r\n}\r\n\r\nexport function createLocalTransactions(\r\n  accountId: string,\r\n  chain: ApiChain,\r\n  params: ApiLocalTransactionParams[],\r\n) {\r\n  const { network } = parseAccountId(accountId);\r\n\r\n  const localTransactions = params.map((subParams, index) => {\r\n    const { toAddress } = subParams;\r\n\r\n    let normalizedAddress: string;\r\n    if (subParams.normalizedAddress) {\r\n      normalizedAddress = subParams.normalizedAddress;\r\n    } else if (chain === 'ton') {\r\n      normalizedAddress = ton.normalizeAddress(toAddress, network);\r\n    } else {\r\n      normalizedAddress = toAddress;\r\n    }\r\n\r\n    return buildLocalTransaction(subParams, normalizedAddress, index);\r\n  });\r\n\r\n  if (localTransactions.length) {\r\n    onUpdate({\r\n      type: 'newLocalActivities',\r\n      activities: localTransactions,\r\n      accountId,\r\n    });\r\n  }\r\n\r\n  return localTransactions;\r\n}\r\n\r\nexport function fetchEstimateDiesel(accountId: string, tokenAddress: string) {\r\n  return ton.fetchEstimateDiesel(accountId, tokenAddress);\r\n}\r\n\r\n/**\r\n * Creates local activities from emulation results instead of basic transaction parameters.\r\n * This provides richer, parsed transaction details like \"liquidity withdrawal\" instead of \"send TON\".\r\n */\r\nexport function createLocalActivitiesFromEmulation(\r\n  accountId: string,\r\n  chain: ApiChain,\r\n  msgHashNormalized: string,\r\n  emulationActivities: ApiActivity[],\r\n): ApiActivity[] {\r\n  const localActivities: ApiActivity[] = [];\r\n  let localActivityIndex = 0;\r\n\r\n  emulationActivities.forEach((activity) => {\r\n    if (activity.shouldHide || activity.id === FAKE_TX_ID) {\r\n      return;\r\n    }\r\n\r\n    const localActivity = convertEmulationActivityToLocal(\r\n      activity,\r\n      msgHashNormalized,\r\n      localActivityIndex,\r\n      chain,\r\n      accountId,\r\n    );\r\n\r\n    localActivities.push(localActivity);\r\n\r\n    localActivityIndex++; // Increment only for visible activities\r\n  });\r\n\r\n  if (localActivities.length) {\r\n    onUpdate({\r\n      type: 'newLocalActivities',\r\n      activities: localActivities,\r\n      accountId,\r\n    });\r\n  }\r\n\r\n  return localActivities;\r\n}\r\n\r\n/**\r\n * Converts an emulation activity to a local activity with proper ID and timestamp\r\n */\r\nfunction convertEmulationActivityToLocal(\r\n  activity: ApiActivity,\r\n  msgHashNormalized: string,\r\n  index: number,\r\n  chain: ApiChain,\r\n  accountId?: string,\r\n): ApiActivity {\r\n  const localTxId = buildLocalTxId(msgHashNormalized, index);\r\n  const commonFields = {\r\n    id: localTxId,\r\n    timestamp: Date.now(),\r\n    externalMsgHashNorm: msgHashNormalized,\r\n    // Emulation activities are not trusted\r\n    status: 'pending',\r\n  } satisfies Partial<ApiActivity>;\r\n\r\n  if (activity.kind === 'transaction') {\r\n    let normalizedAddress = activity.normalizedAddress;\r\n    if (!normalizedAddress && chain === 'ton' && accountId) {\r\n      const { network } = parseAccountId(accountId);\r\n      normalizedAddress = ton.normalizeAddress(activity.toAddress, network);\r\n    }\r\n\r\n    return {\r\n      ...activity,\r\n      ...commonFields,\r\n      normalizedAddress: normalizedAddress || activity.normalizedAddress,\r\n    };\r\n  } else {\r\n    return {\r\n      ...activity,\r\n      ...commonFields,\r\n    };\r\n  }\r\n}\r\n","import type { ApiAnyDisplayError } from '../types';\r\nimport type { AllErrorCodes } from './types';\r\nimport { ApiTransactionError } from '../types';\r\nimport { CONNECT_EVENT_ERROR_CODES, SEND_TRANSACTION_ERROR_CODES } from './types';\r\n\r\nimport { ApiBaseError } from '../errors';\r\n\r\nexport class TonConnectError extends ApiBaseError {\r\n  code: number;\r\n\r\n  constructor(message: string, code: AllErrorCodes = 0, displayError?: ApiAnyDisplayError) {\r\n    super(message);\r\n    this.code = code;\r\n    this.displayError = displayError;\r\n  }\r\n}\r\n\r\nexport class ManifestContentError extends TonConnectError {\r\n  constructor(message = 'Manifest content error') {\r\n    super(message, CONNECT_EVENT_ERROR_CODES.MANIFEST_CONTENT_ERROR);\r\n  }\r\n}\r\n\r\nexport class UnknownError extends TonConnectError {\r\n  constructor(message = 'Unknown error.', displayError?: ApiAnyDisplayError) {\r\n    super(message, SEND_TRANSACTION_ERROR_CODES.UNKNOWN_ERROR, displayError);\r\n  }\r\n}\r\n\r\nexport class BadRequestError extends TonConnectError {\r\n  constructor(message = 'Bad request', displayError?: ApiAnyDisplayError) {\r\n    super(message, SEND_TRANSACTION_ERROR_CODES.BAD_REQUEST_ERROR, displayError);\r\n  }\r\n}\r\n\r\nexport class UnknownAppError extends TonConnectError {\r\n  constructor(message = 'Unknown app error') {\r\n    super(message, SEND_TRANSACTION_ERROR_CODES.UNKNOWN_APP_ERROR);\r\n  }\r\n}\r\n\r\nexport class UserRejectsError extends TonConnectError {\r\n  constructor(message = 'The user rejected the action') {\r\n    super(message, SEND_TRANSACTION_ERROR_CODES.USER_REJECTS_ERROR);\r\n  }\r\n}\r\n\r\nexport class MethodNotSupportedError extends TonConnectError {\r\n  constructor(message = 'The method is not supported') {\r\n    super(message, SEND_TRANSACTION_ERROR_CODES.METHOD_NOT_SUPPORTED);\r\n  }\r\n}\r\n\r\nexport class InsufficientBalance extends BadRequestError {\r\n  constructor(message = 'Insufficient balance') {\r\n    super(message, ApiTransactionError.InsufficientBalance);\r\n  }\r\n}\r\n","import type { ApiParsedPayload } from '../types';\r\n\r\nimport { isNftTransferPayload, isTokenTransferPayload } from '../../util/ton/transfer';\r\n\r\n// https://stackoverflow.com/a/417184\r\nconst URL_MAX_LENGTH = 2000;\r\n\r\nexport function isValidString(value: any, maxLength = 100) {\r\n  return typeof value === 'string' && value.length <= maxLength;\r\n}\r\n\r\nexport function isValidUrl(url: string) {\r\n  const isString = isValidString(url, URL_MAX_LENGTH);\r\n  if (!isString) return false;\r\n\r\n  try {\r\n    new URL(url);\r\n    return true;\r\n  } catch (err) {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function getTransferActualToAddress(toAddress: string, payload: ApiParsedPayload | undefined) {\r\n  // This function implementation is not complete. That is, other transfer types may have another actual \"to\" address.\r\n  if (isNftTransferPayload(payload)) {\r\n    return payload.newOwner;\r\n  }\r\n  if (isTokenTransferPayload(payload)) {\r\n    return payload.destination;\r\n  }\r\n  return toAddress;\r\n}\r\n\r\nexport function isTransferPayloadDangerous(payload: ApiParsedPayload | undefined) {\r\n  return payload?.type === 'unknown';\r\n}\r\n","/* TonConnect specification https://github.com/ton-blockchain/ton-connect */\r\n\r\nimport { Cell } from '@ton/core';\r\nimport type {\r\n  ConnectEventError,\r\n  ConnectItemReply,\r\n  ConnectRequest,\r\n  DisconnectRpcRequest,\r\n  DisconnectRpcResponse,\r\n  SendTransactionRpcRequest,\r\n  SendTransactionRpcResponse,\r\n  SignDataPayload,\r\n  SignDataRpcRequest,\r\n  SignDataRpcResponse,\r\n  TonProofItem,\r\n  TonProofItemReplySuccess,\r\n  WalletResponseTemplateError,\r\n} from '@tonconnect/protocol';\r\n\r\nimport type {\r\n  ApiCheckMultiTransactionDraftResult,\r\n  ApiEmulationWithFallbackResult,\r\n  TonTransferParams,\r\n} from '../chains/ton/types';\r\nimport type {\r\n  confirmDappRequestConnect,\r\n  confirmDappRequestSendTransaction,\r\n  confirmDappRequestSignData,\r\n} from '../methods';\r\nimport type {\r\n  ApiAnyDisplayError,\r\n  ApiDapp,\r\n  ApiDappConnectionType,\r\n  ApiDappMetadata,\r\n  ApiDappRequest,\r\n  ApiDappTransfer,\r\n  ApiNetwork,\r\n  ApiParsedPayload,\r\n  ApiTonWallet,\r\n  OnApiUpdate,\r\n} from '../types';\r\nimport type { ApiTonConnectProof, ConnectEvent, TransactionPayload, TransactionPayloadMessage } from './types';\r\nimport { ApiCommonError, ApiTransactionDraftError, ApiTransactionError } from '../types';\r\nimport { CHAIN, CONNECT_EVENT_ERROR_CODES, SEND_TRANSACTION_ERROR_CODES } from './types';\r\n\r\nimport { IS_EXTENSION, TONCOIN } from '../../config';\r\nimport { parseAccountId } from '../../util/account';\r\nimport { areDeepEqual } from '../../util/areDeepEqual';\r\nimport { bigintDivideToNumber } from '../../util/bigint';\r\nimport { fetchJsonWithProxy } from '../../util/fetch';\r\nimport { getDappConnectionUniqueId } from '../../util/getDappConnectionUniqueId';\r\nimport { pick } from '../../util/iteratees';\r\nimport { logDebugError } from '../../util/logs';\r\nimport safeExec from '../../util/safeExec';\r\nimport { getMaxMessagesInTransaction } from '../../util/ton/transfer';\r\nimport { tonConnectGetDeviceInfo } from '../../util/tonConnectEnvironment';\r\nimport { checkMultiTransactionDraft, sendSignedTransactions } from '../chains/ton/transfer';\r\nimport { parsePayloadBase64 } from '../chains/ton/util/metadata';\r\nimport { getIsRawAddress, getWalletPublicKey, toBase64Address, toRawAddress } from '../chains/ton/util/tonCore';\r\nimport { getContractInfo, getWalletStateInit } from '../chains/ton/wallet';\r\nimport { fetchStoredChainAccount, getCurrentAccountId, getCurrentAccountIdOrFail } from '../common/accounts';\r\nimport { getKnownAddressInfo } from '../common/addresses';\r\nimport { createDappPromise } from '../common/dappPromises';\r\nimport { isUpdaterAlive } from '../common/helpers';\r\nimport { hexToBytes } from '../common/utils';\r\nimport * as apiErrors from '../errors';\r\nimport { ApiServerError } from '../errors';\r\nimport { callHook } from '../hooks';\r\nimport {\r\n  addDapp,\r\n  deleteDapp,\r\n  findLastConnectedAccount,\r\n  getDapp,\r\n  updateDapp,\r\n} from '../methods/dapps';\r\nimport { createLocalActivitiesFromEmulation, createLocalTransactions } from '../methods/transfer';\r\nimport * as errors from './errors';\r\nimport { UnknownAppError } from './errors';\r\nimport { getTransferActualToAddress, isTransferPayloadDangerous, isValidString, isValidUrl } from './utils';\r\n\r\nconst BLANK_GIF_DATA_URL = 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';\r\n\r\nlet resolveInit: AnyFunction;\r\nconst initPromise = new Promise((resolve) => {\r\n  resolveInit = resolve;\r\n});\r\n\r\nlet onUpdate: OnApiUpdate;\r\n\r\nexport function initTonConnect(_onUpdate: OnApiUpdate) {\r\n  onUpdate = _onUpdate;\r\n  resolveInit();\r\n}\r\n\r\nexport async function connect(request: ApiDappRequest, message: ConnectRequest, id: number): Promise<ConnectEvent> {\r\n  try {\r\n    await openExtensionPopup(true);\r\n\r\n    onUpdate({\r\n      type: 'dappLoading',\r\n      connectionType: 'connect',\r\n      isSse: request && 'sseOptions' in request,\r\n    });\r\n\r\n    const dappMetadata = await fetchDappMetadata(message.manifestUrl);\r\n    const url = request.url || dappMetadata.url;\r\n    const addressItem = message.items.find(({ name }) => name === 'ton_addr');\r\n    const proofItem = message.items.find(({ name }) => name === 'ton_proof') as TonProofItem | undefined;\r\n    const proof = proofItem ? {\r\n      timestamp: Math.round(Date.now() / 1000),\r\n      domain: new URL(url).host,\r\n      payload: proofItem.payload,\r\n    } : undefined;\r\n\r\n    if (!addressItem) {\r\n      throw new errors.BadRequestError('Missing \\'ton_addr\\'');\r\n    }\r\n\r\n    if (proof && !proof.domain.includes('.')) {\r\n      throw new errors.BadRequestError('Invalid domain');\r\n    }\r\n\r\n    let accountId = await getCurrentAccountOrFail();\r\n\r\n    const { promiseId, promise } = createDappPromise();\r\n\r\n    const dapp: ApiDapp = {\r\n      ...dappMetadata,\r\n      url,\r\n      connectedAt: Date.now(),\r\n      ...(request.isUrlEnsured && { isUrlEnsured: true }),\r\n      ...('sseOptions' in request && {\r\n        sse: request.sseOptions,\r\n      }),\r\n    };\r\n\r\n    const uniqueId = getDappConnectionUniqueId(request);\r\n\r\n    onUpdate({\r\n      type: 'dappConnect',\r\n      identifier: 'identifier' in request ? request.identifier : undefined,\r\n      promiseId,\r\n      accountId,\r\n      dapp,\r\n      permissions: {\r\n        address: true,\r\n        proof: !!proof,\r\n      },\r\n      proof,\r\n    });\r\n\r\n    const promiseResult: Parameters<typeof confirmDappRequestConnect>[1] = await promise;\r\n\r\n    accountId = promiseResult.accountId;\r\n    request.accountId = accountId;\r\n    await addDapp(accountId, dapp, uniqueId);\r\n\r\n    const account = await fetchStoredChainAccount(accountId, 'ton');\r\n\r\n    const deviceInfo = tonConnectGetDeviceInfo(account);\r\n    const items: ConnectItemReply[] = [\r\n      buildTonAddressReplyItem(accountId, account.byChain.ton),\r\n    ];\r\n\r\n    if (proof) {\r\n      items.push(buildTonProofReplyItem(proof, promiseResult.proofSignature!));\r\n    }\r\n\r\n    onUpdate({ type: 'updateDapps' });\r\n    onUpdate({ type: 'dappConnectComplete' });\r\n\r\n    return {\r\n      event: 'connect',\r\n      id,\r\n      payload: {\r\n        items,\r\n        device: deviceInfo,\r\n      },\r\n    };\r\n  } catch (err) {\r\n    logDebugError('tonConnect:connect', err);\r\n\r\n    safeExec(() => {\r\n      onUpdate({\r\n        type: 'dappCloseLoading',\r\n        connectionType: 'connect',\r\n      });\r\n    });\r\n\r\n    return formatConnectError(id, err as Error);\r\n  }\r\n}\r\n\r\nexport async function reconnect(request: ApiDappRequest, id: number): Promise<ConnectEvent> {\r\n  try {\r\n    const { url, accountId } = await ensureRequestParams(request);\r\n\r\n    const uniqueId = getDappConnectionUniqueId(request);\r\n    const currentDapp = await getDapp(accountId, url, uniqueId);\r\n    if (!currentDapp) {\r\n      throw new UnknownAppError();\r\n    }\r\n\r\n    await updateDapp(accountId, url, uniqueId, { connectedAt: Date.now() });\r\n\r\n    const account = await fetchStoredChainAccount(accountId, 'ton');\r\n\r\n    const deviceInfo = tonConnectGetDeviceInfo(account);\r\n    const items: ConnectItemReply[] = [\r\n      buildTonAddressReplyItem(accountId, account.byChain.ton),\r\n    ];\r\n\r\n    return {\r\n      event: 'connect',\r\n      id,\r\n      payload: {\r\n        items,\r\n        device: deviceInfo,\r\n      },\r\n    };\r\n  } catch (e) {\r\n    logDebugError('tonConnect:reconnect', e);\r\n    return formatConnectError(id, e as Error);\r\n  }\r\n}\r\n\r\nexport async function disconnect(\r\n  request: ApiDappRequest,\r\n  message: DisconnectRpcRequest,\r\n): Promise<DisconnectRpcResponse> {\r\n  try {\r\n    const { url, accountId } = await ensureRequestParams(request);\r\n\r\n    const uniqueId = getDappConnectionUniqueId(request);\r\n    await deleteDapp(accountId, url, uniqueId, true);\r\n    onUpdate({ type: 'updateDapps' });\r\n  } catch (err) {\r\n    logDebugError('tonConnect:disconnect', err);\r\n  }\r\n  return {\r\n    id: message.id,\r\n    result: {},\r\n  };\r\n}\r\n\r\nexport async function sendTransaction(\r\n  request: ApiDappRequest,\r\n  message: SendTransactionRpcRequest,\r\n): Promise<SendTransactionRpcResponse> {\r\n  try {\r\n    const { url, accountId } = await ensureRequestParams(request);\r\n    const { network } = parseAccountId(accountId);\r\n\r\n    const txPayload = JSON.parse(message.params[0]) as TransactionPayload;\r\n    const { messages, network: dappNetworkRaw } = txPayload;\r\n\r\n    const account = await fetchStoredChainAccount(accountId, 'ton');\r\n    const {\r\n      type,\r\n      byChain: {\r\n        ton: {\r\n          address,\r\n          publicKey: publicKeyHex,\r\n        },\r\n      },\r\n    } = account;\r\n\r\n    const maxMessages = getMaxMessagesInTransaction(account);\r\n\r\n    if (messages.length > maxMessages) {\r\n      throw new errors.BadRequestError(`Payload contains more than ${maxMessages} messages, which exceeds limit`);\r\n    }\r\n\r\n    const dappNetwork = dappNetworkRaw\r\n      ? (dappNetworkRaw === CHAIN.MAINNET ? 'mainnet' : 'testnet')\r\n      : undefined;\r\n    let validUntil = txPayload.valid_until;\r\n    if (validUntil && validUntil > 10 ** 10) {\r\n      // If milliseconds were passed instead of seconds\r\n      validUntil = Math.round(validUntil / 1000);\r\n    }\r\n\r\n    const isLedger = type === 'ledger';\r\n\r\n    let vestingAddress: string | undefined;\r\n\r\n    if (txPayload.from && toBase64Address(txPayload.from) !== toBase64Address(address)) {\r\n      const publicKey = hexToBytes(publicKeyHex!);\r\n      if (isLedger && await checkIsHisVestingWallet(network, publicKey, txPayload.from)) {\r\n        vestingAddress = txPayload.from;\r\n      } else {\r\n        throw new errors.BadRequestError(undefined, ApiTransactionError.WrongAddress);\r\n      }\r\n    }\r\n\r\n    if (dappNetwork && network !== dappNetwork) {\r\n      throw new errors.BadRequestError(undefined, ApiTransactionError.WrongNetwork);\r\n    }\r\n\r\n    await openExtensionPopup(true);\r\n\r\n    onUpdate({\r\n      type: 'dappLoading',\r\n      connectionType: 'sendTransaction',\r\n      accountId,\r\n      isSse: Boolean('sseOptions' in request && request.sseOptions),\r\n    });\r\n\r\n    const checkResult = await checkTransactionMessages(accountId, messages, network);\r\n\r\n    if ('error' in checkResult) {\r\n      throw new errors.BadRequestError(checkResult.error, checkResult.error);\r\n    }\r\n\r\n    const uniqueId = getDappConnectionUniqueId(request);\r\n    const dapp = (await getDapp(accountId, url, uniqueId))!;\r\n    const transactionsForRequest = await prepareTransactionForRequest(\r\n      network,\r\n      messages,\r\n      checkResult.emulation,\r\n      checkResult.parsedPayloads,\r\n    );\r\n\r\n    const { promiseId, promise } = createDappPromise();\r\n\r\n    onUpdate({\r\n      type: 'dappSendTransactions',\r\n      promiseId,\r\n      accountId,\r\n      dapp,\r\n      transactions: transactionsForRequest,\r\n      emulation: checkResult.emulation.isFallback ? undefined : pick(checkResult.emulation, ['activities', 'realFee']),\r\n      validUntil,\r\n      vestingAddress,\r\n    });\r\n\r\n    const signedTransactions: Parameters<typeof confirmDappRequestSendTransaction>[1] = await promise;\r\n\r\n    if (validUntil && validUntil < (Date.now() / 1000)) {\r\n      throw new errors.BadRequestError('The confirmation timeout has expired');\r\n    }\r\n\r\n    const sentTransactions = await sendSignedTransactions(accountId, signedTransactions);\r\n\r\n    if ('error' in sentTransactions) {\r\n      throw new errors.UnknownError(sentTransactions.error, sentTransactions.error);\r\n    }\r\n\r\n    if (sentTransactions.length === 0) {\r\n      throw new errors.UnknownError('Failed transfers');\r\n    }\r\n\r\n    if (sentTransactions.length < signedTransactions.length) {\r\n      onUpdate({\r\n        type: 'showError',\r\n        error: ApiTransactionError.PartialTransactionFailure,\r\n      });\r\n    }\r\n\r\n    const externalMsgHashNorm = sentTransactions[0].msgHashNormalized;\r\n\r\n    if (!checkResult.emulation.isFallback && checkResult.emulation.activities?.length > 0) {\r\n      // Use rich emulation activities for optimistic UI\r\n      createLocalActivitiesFromEmulation(\r\n        accountId,\r\n        'ton',\r\n        externalMsgHashNorm, // This is not always correct for Ledger, because in that case the messages are split into individual transactions which have different message hashes. Though, this appears not to cause problems.\r\n        checkResult.emulation.activities,\r\n      );\r\n    } else {\r\n      // Fallback to basic local transactions when emulation is not available\r\n      createLocalTransactions(accountId, 'ton', transactionsForRequest.map((transaction) => {\r\n        const { amount, normalizedAddress, payload, networkFee } = transaction;\r\n        const comment = payload?.type === 'comment' ? payload.comment : undefined;\r\n        return {\r\n          id: externalMsgHashNorm,\r\n          amount,\r\n          fromAddress: address,\r\n          toAddress: normalizedAddress,\r\n          comment,\r\n          fee: networkFee,\r\n          slug: TONCOIN.slug,\r\n          externalMsgHashNorm, // This is not always correct for Ledger, because in that case the messages are split into individual transactions which have different message hashes. Though, this appears not to cause problems.\r\n        };\r\n      }));\r\n    }\r\n\r\n    // Notify that dapp transfer is complete after successful blockchain submission\r\n    onUpdate({\r\n      type: 'dappTransferComplete',\r\n      accountId,\r\n    });\r\n\r\n    return {\r\n      result: sentTransactions[0].boc,\r\n      id: message.id,\r\n    };\r\n  } catch (err) {\r\n    logDebugError('tonConnect:sendTransaction', err);\r\n    return handleMethodError(err, message.id, 'sendTransaction');\r\n  }\r\n}\r\n\r\nfunction handleMethodError(\r\n  err: unknown,\r\n  messageId: string,\r\n  connectionType: ApiDappConnectionType,\r\n): WalletResponseTemplateError {\r\n  safeExec(() => {\r\n    onUpdate({\r\n      type: 'dappCloseLoading',\r\n      connectionType,\r\n    });\r\n  });\r\n\r\n  let code = SEND_TRANSACTION_ERROR_CODES.UNKNOWN_ERROR;\r\n  let errorMessage = 'Unhandled error';\r\n  let displayError: ApiAnyDisplayError | undefined;\r\n\r\n  if (err instanceof apiErrors.ApiUserRejectsError) {\r\n    code = SEND_TRANSACTION_ERROR_CODES.USER_REJECTS_ERROR;\r\n    errorMessage = err.message;\r\n  } else if (err instanceof errors.TonConnectError) {\r\n    code = err.code;\r\n    errorMessage = err.message;\r\n    displayError = err.displayError;\r\n  } else if (err instanceof ApiServerError) {\r\n    displayError = err.displayError;\r\n  } else {\r\n    displayError = ApiCommonError.Unexpected;\r\n  }\r\n\r\n  if (onUpdate && isUpdaterAlive(onUpdate) && displayError) {\r\n    onUpdate({\r\n      type: 'showError',\r\n      error: displayError,\r\n    });\r\n  }\r\n  return {\r\n    error: {\r\n      code,\r\n      message: errorMessage,\r\n    },\r\n    id: messageId,\r\n  };\r\n}\r\n\r\nasync function checkIsHisVestingWallet(network: ApiNetwork, ownerPublicKey: Uint8Array, address: string) {\r\n  const [info, publicKey] = await Promise.all([\r\n    getContractInfo(network, address),\r\n    getWalletPublicKey(network, address),\r\n  ]);\r\n\r\n  return info.contractInfo?.name === 'vesting' && areDeepEqual(ownerPublicKey, publicKey);\r\n}\r\n\r\n/**\r\n * See https://docs.tonconsole.com/academy/sign-data for more details\r\n */\r\nexport async function signData(\r\n  request: ApiDappRequest,\r\n  message: SignDataRpcRequest,\r\n): Promise<SignDataRpcResponse> {\r\n  try {\r\n    const { url, accountId } = await ensureRequestParams(request);\r\n\r\n    await openExtensionPopup(true);\r\n\r\n    onUpdate({\r\n      type: 'dappLoading',\r\n      connectionType: 'signData',\r\n      accountId,\r\n      isSse: Boolean('sseOptions' in request && request.sseOptions),\r\n    });\r\n\r\n    const { promiseId, promise } = createDappPromise();\r\n    const uniqueId = getDappConnectionUniqueId(request);\r\n    const dapp = (await getDapp(accountId, url, uniqueId))!;\r\n    const payloadToSign = JSON.parse(message.params[0]) as SignDataPayload;\r\n\r\n    onUpdate({\r\n      type: 'dappSignData',\r\n      promiseId,\r\n      accountId,\r\n      dapp,\r\n      payloadToSign,\r\n    });\r\n\r\n    const result: Parameters<typeof confirmDappRequestSignData>[1] = await promise;\r\n\r\n    onUpdate({\r\n      type: 'dappSignDataComplete',\r\n      accountId,\r\n    });\r\n\r\n    return {\r\n      result,\r\n      id: message.id,\r\n    };\r\n  } catch (err) {\r\n    logDebugError('tonConnect:signData', err);\r\n    return handleMethodError(err, message.id, 'signData');\r\n  }\r\n}\r\n\r\nasync function checkTransactionMessages(\r\n  accountId: string,\r\n  messages: TransactionPayloadMessage[],\r\n  network: ApiNetwork,\r\n) {\r\n  const preparedMessages: TonTransferParams[] = messages.map((msg) => {\r\n    const {\r\n      address: toAddress,\r\n      amount,\r\n      payload,\r\n      stateInit,\r\n    } = msg;\r\n\r\n    return {\r\n      toAddress: getIsRawAddress(toAddress)\r\n        ? toBase64Address(toAddress, true, network)\r\n        : toAddress,\r\n      amount: BigInt(amount),\r\n      payload: payload ? Cell.fromBase64(payload) : undefined,\r\n      stateInit: stateInit ? Cell.fromBase64(stateInit) : undefined,\r\n    };\r\n  });\r\n\r\n  const checkResult = await checkMultiTransactionDraft(accountId, preparedMessages);\r\n\r\n  // Handle insufficient balance error specifically for TON Connect by converting to fallback emulation\r\n  if ('error' in checkResult\r\n    && checkResult.error === ApiTransactionDraftError.InsufficientBalance\r\n    && checkResult.emulation\r\n  ) {\r\n    const fallbackCheckResult: ApiCheckMultiTransactionDraftResult = {\r\n      emulation: {\r\n        isFallback: true,\r\n        networkFee: checkResult.emulation.networkFee,\r\n      },\r\n      parsedPayloads: checkResult.parsedPayloads,\r\n    };\r\n    return fallbackCheckResult;\r\n  }\r\n\r\n  return checkResult;\r\n}\r\n\r\nfunction prepareTransactionForRequest(\r\n  network: ApiNetwork,\r\n  messages: TransactionPayloadMessage[],\r\n  emulation: ApiEmulationWithFallbackResult,\r\n  parsedPayloads?: (ApiParsedPayload | undefined)[],\r\n) {\r\n  return Promise.all(messages.map(\r\n    async ({\r\n      address,\r\n      amount: rawAmount,\r\n      payload: rawPayload,\r\n      stateInit,\r\n    }, index): Promise<ApiDappTransfer> => {\r\n      const amount = BigInt(rawAmount);\r\n      const toAddress = getIsRawAddress(address) ? toBase64Address(address, true, network) : address;\r\n      // Fix address format for `waitTxComplete` to work properly\r\n      const normalizedAddress = toBase64Address(address, undefined, network);\r\n      const payload = parsedPayloads?.[index]\r\n        ?? (rawPayload ? await parsePayloadBase64(network, toAddress, rawPayload) : undefined);\r\n      const { isScam } = getKnownAddressInfo(normalizedAddress) || {};\r\n\r\n      return {\r\n        toAddress,\r\n        amount,\r\n        rawPayload,\r\n        payload,\r\n        stateInit,\r\n        normalizedAddress,\r\n        isScam,\r\n        isDangerous: isTransferPayloadDangerous(payload),\r\n        displayedToAddress: getTransferActualToAddress(toAddress, payload),\r\n        networkFee: emulation.isFallback\r\n          ? bigintDivideToNumber(emulation.networkFee, messages.length)\r\n          : emulation.byTransactionIndex[index]?.networkFee ?? 0n,\r\n      };\r\n    },\r\n  ));\r\n}\r\n\r\nfunction formatConnectError(id: number, error: Error): ConnectEventError {\r\n  let code = CONNECT_EVENT_ERROR_CODES.UNKNOWN_ERROR;\r\n  let message = 'Unhandled error';\r\n\r\n  if (error instanceof apiErrors.ApiUserRejectsError) {\r\n    code = CONNECT_EVENT_ERROR_CODES.USER_REJECTS_ERROR;\r\n    message = error.message;\r\n  } else if (error instanceof errors.TonConnectError) {\r\n    code = error.code;\r\n    message = error.message;\r\n  }\r\n\r\n  return {\r\n    id,\r\n    event: 'connect_error',\r\n    payload: {\r\n      code,\r\n      message,\r\n    },\r\n  };\r\n}\r\n\r\nfunction buildTonAddressReplyItem(accountId: string, wallet: ApiTonWallet): ConnectItemReply {\r\n  const { network } = parseAccountId(accountId);\r\n  const { publicKey, address } = wallet;\r\n\r\n  const stateInit = getWalletStateInit(wallet);\r\n\r\n  return {\r\n    name: 'ton_addr',\r\n    address: toRawAddress(address),\r\n    network: network === 'mainnet' ? CHAIN.MAINNET : CHAIN.TESTNET,\r\n    publicKey: publicKey!,\r\n    walletStateInit: stateInit\r\n      .toBoc({ idx: true, crc32: true })\r\n      .toString('base64'),\r\n  };\r\n}\r\n\r\nfunction buildTonProofReplyItem(proof: ApiTonConnectProof, signature: string): TonProofItemReplySuccess {\r\n  const { timestamp, domain, payload } = proof;\r\n  const domainBuffer = Buffer.from(domain);\r\n\r\n  return {\r\n    name: 'ton_proof',\r\n    proof: {\r\n      timestamp,\r\n      domain: {\r\n        lengthBytes: domainBuffer.byteLength,\r\n        value: domainBuffer.toString('utf8'),\r\n      },\r\n      signature,\r\n      payload,\r\n    },\r\n  };\r\n}\r\n\r\nexport async function fetchDappMetadata(manifestUrl: string): Promise<ApiDappMetadata> {\r\n  try {\r\n    const { url, name, iconUrl } = await fetchJsonWithProxy(manifestUrl);\r\n    const safeIconUrl = (iconUrl.startsWith('data:') || iconUrl === '') ? BLANK_GIF_DATA_URL : iconUrl;\r\n    if (!isValidUrl(url) || !isValidString(name) || !isValidUrl(safeIconUrl)) {\r\n      throw new Error('Invalid data');\r\n    }\r\n\r\n    return {\r\n      url,\r\n      name,\r\n      iconUrl: safeIconUrl,\r\n      manifestUrl,\r\n    };\r\n  } catch (err) {\r\n    logDebugError('fetchDapp', err);\r\n    throw new errors.ManifestContentError();\r\n  }\r\n}\r\n\r\nasync function ensureRequestParams(\r\n  request: ApiDappRequest,\r\n): Promise<ApiDappRequest & { url: string; accountId: string }> {\r\n  if (!request.url) {\r\n    throw new errors.BadRequestError('Missing `url` in request');\r\n  }\r\n\r\n  if (request.accountId) {\r\n    return request as ApiDappRequest & { url: string; accountId: string };\r\n  }\r\n\r\n  const { network } = parseAccountId(await getCurrentAccountIdOrFail());\r\n  const lastAccountId = await findLastConnectedAccount(network, request.url);\r\n  if (!lastAccountId) {\r\n    throw new errors.BadRequestError('The connection is outdated, try relogin');\r\n  }\r\n\r\n  return {\r\n    ...request,\r\n    accountId: lastAccountId,\r\n  } as ApiDappRequest & { url: string; accountId: string };\r\n}\r\n\r\nasync function openExtensionPopup(force?: boolean) {\r\n  if (!IS_EXTENSION || (!force && onUpdate && isUpdaterAlive(onUpdate))) {\r\n    return false;\r\n  }\r\n\r\n  await callHook('onWindowNeeded');\r\n  await initPromise;\r\n\r\n  return true;\r\n}\r\n\r\nasync function getCurrentAccountOrFail() {\r\n  const accountId = await getCurrentAccountId();\r\n  if (!accountId) {\r\n    throw new errors.BadRequestError('The user is not authorized in the wallet');\r\n  }\r\n  return accountId;\r\n}\r\n","import type {\r\n  AppRequest,\r\n  ConnectRequest,\r\n  DisconnectEvent,\r\n  RpcRequests,\r\n} from '@tonconnect/protocol';\r\nimport nacl, { randomBytes } from 'tweetnacl';\r\n\r\nimport type { ApiDappRequest, ApiSseOptions, OnApiUpdate } from '../types';\r\nimport { CONNECT_EVENT_ERROR_CODES } from './types';\r\n\r\nimport { IS_CAPACITOR, SSE_BRIDGE_URL } from '../../config';\r\nimport { parseAccountId } from '../../util/account';\r\nimport { handleFetchErrors } from '../../util/fetch';\r\nimport { extractKey } from '../../util/iteratees';\r\nimport { logDebug, logDebugError } from '../../util/logs';\r\nimport safeExec from '../../util/safeExec';\r\nimport { getCurrentNetwork, waitLogin } from '../common/accounts';\r\nimport { bytesToHex } from '../common/utils';\r\nimport { getDappsState, getSseLastEventId, setSseLastEventId } from '../methods/dapps';\r\nimport * as tonConnect from './index';\r\n\r\ntype SseDapp = {\r\n  accountId: string;\r\n  url: string;\r\n} & ApiSseOptions;\r\n\r\n// The `empty` strategy - a trick to solve the problem of long network connection initialization\r\n// in the Capacitor version of the app when it resumes from the background.\r\n// In this case, the client should show a loader, and once the real SSE connection starts,\r\n// the loader will be hidden.\r\ntype ReturnStrategy = 'back' | 'none' | 'empty' | (string & {});\r\n\r\nconst TTL_SEC = 300;\r\nconst NONCE_SIZE = 24;\r\nconst MAX_CONFIRM_DURATION = 60 * 1000;\r\nconst SHOULD_SHOW_LOADER_ON_SSE_START = IS_CAPACITOR;\r\n\r\nlet sseEventSource: EventSource | undefined;\r\nlet sseDapps: SseDapp[] = [];\r\nlet delayedReturnParams: {\r\n  validUntil: number;\r\n  url: string;\r\n  isFromInAppBrowser?: boolean;\r\n} | undefined;\r\n\r\nlet onUpdate: OnApiUpdate;\r\n\r\nexport function initSse(_onUpdate: OnApiUpdate) {\r\n  onUpdate = _onUpdate;\r\n}\r\n\r\nexport async function startSseConnection({\r\n  url, isFromInAppBrowser, identifier,\r\n}: {\r\n  url: string;\r\n  isFromInAppBrowser?: boolean;\r\n  identifier?: string;\r\n}): Promise<ReturnStrategy | undefined> {\r\n  const { searchParams: params, origin: connectionOrigin } = new URL(url);\r\n\r\n  const ret: ReturnStrategy = params.get('ret') || 'back';\r\n  const version = Number(params.get('v') as string);\r\n  const appClientId = params.get('id') as string;\r\n  // `back` strategy cannot be implemented\r\n  const shouldOpenUrl = ret !== 'back' && ret !== 'none';\r\n  const r = params.get('r');\r\n\r\n  if (!r) {\r\n    if (shouldOpenUrl) {\r\n      delayedReturnParams = {\r\n        validUntil: Date.now() + MAX_CONFIRM_DURATION,\r\n        url: ret,\r\n        isFromInAppBrowser,\r\n      };\r\n    }\r\n\r\n    return SHOULD_SHOW_LOADER_ON_SSE_START ? 'empty' : undefined;\r\n  }\r\n\r\n  const connectRequest: ConnectRequest | null = safeExec(() => JSON.parse(r)) || JSON.parse(decodeURIComponent(r));\r\n\r\n  logDebug('SSE Start connection:', {\r\n    version, appClientId, connectRequest, ret, connectionOrigin, identifier,\r\n  });\r\n\r\n  const { secretKey: secretKeyArray, publicKey: publicKeyArray } = nacl.box.keyPair();\r\n  const secretKey = bytesToHex(secretKeyArray);\r\n  const clientId = bytesToHex(publicKeyArray);\r\n\r\n  const lastOutputId = 0;\r\n  const request: ApiDappRequest = {\r\n    url: undefined,\r\n    identifier,\r\n    sseOptions: {\r\n      clientId,\r\n      appClientId,\r\n      secretKey,\r\n      lastOutputId,\r\n    },\r\n  };\r\n\r\n  await waitLogin();\r\n\r\n  if (!connectRequest) {\r\n    onUpdate({\r\n      type: 'showError',\r\n      error: 'Invalid TON Connect link',\r\n    });\r\n\r\n    return undefined;\r\n  }\r\n\r\n  const result = await tonConnect.connect(request, connectRequest, lastOutputId);\r\n\r\n  if (result.event === 'connect_error') {\r\n    const { code } = result.payload;\r\n\r\n    if ([\r\n      CONNECT_EVENT_ERROR_CODES.MANIFEST_CONTENT_ERROR,\r\n      CONNECT_EVENT_ERROR_CODES.MANIFEST_NOT_FOUND_ERROR,\r\n      CONNECT_EVENT_ERROR_CODES.BAD_REQUEST_ERROR,\r\n      CONNECT_EVENT_ERROR_CODES.UNKNOWN_APP_ERROR,\r\n      CONNECT_EVENT_ERROR_CODES.METHOD_NOT_SUPPORTED,\r\n    ].includes(code)) {\r\n      onUpdate({\r\n        type: 'showError',\r\n        error: result.payload.message,\r\n      });\r\n    }\r\n  }\r\n\r\n  await sendMessage(result, secretKey, clientId, appClientId);\r\n\r\n  if (result.event !== 'connect_error') {\r\n    await resetupSseConnection();\r\n  }\r\n\r\n  if (!shouldOpenUrl) {\r\n    return undefined;\r\n  }\r\n\r\n  return ret;\r\n}\r\n\r\nexport async function resetupSseConnection() {\r\n  const [lastEventId, dappsState, network] = await Promise.all([\r\n    getSseLastEventId(),\r\n    getDappsState(),\r\n    getCurrentNetwork(),\r\n  ]);\r\n\r\n  if (!dappsState || !network) {\r\n    return;\r\n  }\r\n\r\n  sseDapps = Object.entries(dappsState).reduce((result, [accountId, dappsByUrl]) => {\r\n    if (parseAccountId(accountId).network !== network) {\r\n      return result;\r\n    }\r\n\r\n    for (const byUniqueId of Object.values(dappsByUrl)) {\r\n      for (const dapp of Object.values(byUniqueId)) {\r\n        if (dapp.sse?.clientId) {\r\n          result.push({\r\n            ...dapp.sse,\r\n            accountId,\r\n            url: dapp.url,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }, [] as SseDapp[]);\r\n\r\n  const clientIds = extractKey(sseDapps, 'clientId').filter(Boolean);\r\n  if (!clientIds.length) {\r\n    return;\r\n  }\r\n\r\n  closeEventSource();\r\n  sseEventSource = openEventSource(clientIds, lastEventId);\r\n\r\n  sseEventSource.onopen = () => {\r\n    if (SHOULD_SHOW_LOADER_ON_SSE_START) {\r\n      onUpdate({\r\n        type: 'tonConnectOnline',\r\n      });\r\n    }\r\n    logDebug('EventSource opened');\r\n  };\r\n\r\n  sseEventSource.onerror = (e) => {\r\n    logDebugError('EventSource', e.type);\r\n  };\r\n\r\n  sseEventSource.onmessage = async (event) => {\r\n    const { from, message: encryptedMessage } = JSON.parse(event.data);\r\n\r\n    const sseDapp = sseDapps.find(({ appClientId }) => appClientId === from);\r\n    if (!sseDapp) {\r\n      logDebug(`Dapp with clientId ${from} not found`);\r\n      return;\r\n    }\r\n\r\n    const {\r\n      accountId, clientId, appClientId, secretKey, url, lastOutputId,\r\n    } = sseDapp;\r\n    const message = decryptMessage(encryptedMessage, appClientId, secretKey) as AppRequest<keyof RpcRequests>;\r\n\r\n    logDebug('SSE Event:', message);\r\n\r\n    await setSseLastEventId(event.lastEventId);\r\n    const sseOptions = {\r\n      clientId,\r\n      appClientId,\r\n      secretKey,\r\n      lastOutputId,\r\n    };\r\n\r\n    // @ts-ignore\r\n    const result = await tonConnect[message.method]({ url, accountId, sseOptions }, message);\r\n\r\n    await sendMessage(result, secretKey, clientId, appClientId);\r\n\r\n    if (delayedReturnParams) {\r\n      const { validUntil, url, isFromInAppBrowser } = delayedReturnParams;\r\n      if (validUntil > Date.now()) {\r\n        onUpdate({ type: 'openUrl', url, isExternal: !isFromInAppBrowser });\r\n      }\r\n      delayedReturnParams = undefined;\r\n    }\r\n  };\r\n}\r\n\r\nexport async function sendSseDisconnect(accountId: string, url: string) {\r\n  const sseDapp = sseDapps.find((d) => d.url === url && d.accountId === accountId);\r\n  if (!sseDapp) return;\r\n\r\n  const { secretKey, clientId, appClientId } = sseDapp;\r\n  const lastOutputId = sseDapp.lastOutputId + 1;\r\n\r\n  const response: DisconnectEvent = {\r\n    event: 'disconnect',\r\n    id: lastOutputId,\r\n    payload: {},\r\n  };\r\n\r\n  await sendMessage(response, secretKey, clientId, appClientId);\r\n}\r\n\r\nfunction sendMessage(\r\n  message: AnyLiteral, secretKey: string, clientId: string, toId: string, topic?: 'signTransaction' | 'signData',\r\n) {\r\n  const buffer = Buffer.from(JSON.stringify(message));\r\n  const encryptedMessage = encryptMessage(buffer, toId, secretKey);\r\n  return sendRawMessage(encryptedMessage, clientId, toId, topic);\r\n}\r\n\r\nasync function sendRawMessage(body: string, clientId: string, toId: string, topic?: 'signTransaction' | 'signData') {\r\n  const url = new URL(`${SSE_BRIDGE_URL}message`);\r\n  url.searchParams.set('client_id', clientId);\r\n  url.searchParams.set('to', toId);\r\n  url.searchParams.set('ttl', TTL_SEC.toString());\r\n  if (topic) {\r\n    url.searchParams.set('topic', topic);\r\n  }\r\n\r\n  const response = await fetch(url, { method: 'POST', body });\r\n  await handleFetchErrors(response);\r\n}\r\n\r\nfunction closeEventSource() {\r\n  if (!sseEventSource) return;\r\n\r\n  safeExec(() => {\r\n    sseEventSource!.close();\r\n  });\r\n  sseEventSource = undefined;\r\n}\r\n\r\nfunction openEventSource(clientIds: string[], lastEventId?: string) {\r\n  const url = new URL(`${SSE_BRIDGE_URL}events`);\r\n  url.searchParams.set('client_id', clientIds.join(','));\r\n  if (lastEventId) {\r\n    url.searchParams.set('last_event_id', lastEventId);\r\n  }\r\n  return new EventSource(url);\r\n}\r\n\r\nfunction encryptMessage(message: Uint8Array, publicKey: string, secretKey: string) {\r\n  const nonce = randomBytes(NONCE_SIZE);\r\n  const encrypted = nacl.box(\r\n    message, nonce, Buffer.from(publicKey, 'hex'), Buffer.from(secretKey, 'hex'),\r\n  );\r\n  return Buffer.concat([nonce, encrypted]).toString('base64');\r\n}\r\n\r\nfunction decryptMessage(message: string, publicKey: string, secretKey: string) {\r\n  const fullBuffer = Buffer.from(message, 'base64');\r\n  const nonce = fullBuffer.subarray(0, NONCE_SIZE);\r\n  const encrypted = fullBuffer.subarray(NONCE_SIZE);\r\n  const decrypted = nacl.box.open(\r\n    encrypted,\r\n    nonce,\r\n    Buffer.from(publicKey, 'hex'),\r\n    Buffer.from(secretKey, 'hex'),\r\n  );\r\n  const jsonText = new TextDecoder('utf-8').decode(decrypted!);\r\n  return JSON.parse(jsonText);\r\n}\r\n","let resolvePromise: NoneToVoidFunction;\r\nconst preloadPromise = new Promise<void>((resolve) => {\r\n  resolvePromise = resolve;\r\n});\r\n\r\nexport function resolveDataPreloadPromise() {\r\n  resolvePromise();\r\n}\r\n\r\nexport async function waitDataPreload() {\r\n  await preloadPromise;\r\n}\r\n","import { Address } from '@ton/core';\r\n\r\nimport type { ApiSubmitTransferTonResult } from '../chains/ton/types';\r\nimport type {\r\n  ApiEthenaStakingState,\r\n  ApiJettonStakingState,\r\n  ApiStakingCommonData,\r\n  ApiStakingCommonResponse,\r\n  ApiStakingHistory,\r\n  ApiStakingState,\r\n  ApiTransactionActivity,\r\n} from '../types';\r\n\r\nimport { TONCOIN } from '../../config';\r\nimport { fromDecimal } from '../../util/decimals';\r\nimport { logDebugError } from '../../util/logs';\r\nimport * as ton from '../chains/ton';\r\nimport { getTonClient } from '../chains/ton/util/tonCore';\r\nimport { fetchStoredAccount, fetchStoredWallet } from '../common/accounts';\r\nimport { callBackendGet } from '../common/backend';\r\nimport { setStakingCommonCache } from '../common/cache';\r\nimport { createLocalTransactions } from './transfer';\r\n\r\nimport { StakingPool } from '../chains/ton/contracts/JettonStaking/StakingPool';\r\n\r\nexport function initStaking() {\r\n}\r\n\r\nexport function checkStakeDraft(accountId: string, amount: bigint, state: ApiStakingState) {\r\n  return ton.checkStakeDraft(accountId, amount, state);\r\n}\r\n\r\nexport function checkUnstakeDraft(accountId: string, amount: bigint, state: ApiStakingState) {\r\n  return ton.checkUnstakeDraft(accountId, amount, state);\r\n}\r\n\r\nexport async function submitStake(\r\n  accountId: string,\r\n  password: string | undefined,\r\n  amount: bigint,\r\n  state: ApiStakingState,\r\n  realFee?: bigint,\r\n) {\r\n  const { address: fromAddress } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  const result = await ton.submitStake(\r\n    accountId, password, amount, state,\r\n  );\r\n\r\n  if ('error' in result) {\r\n    return result;\r\n  }\r\n\r\n  let localActivity: ApiTransactionActivity;\r\n\r\n  if (state.tokenSlug === TONCOIN.slug) {\r\n    [localActivity] = createLocalTransactions(accountId, 'ton', [{\r\n      id: result.msgHashNormalized,\r\n      amount,\r\n      fromAddress,\r\n      toAddress: result.toAddress,\r\n      fee: realFee ?? 0n,\r\n      type: 'stake',\r\n      slug: state.tokenSlug,\r\n      externalMsgHashNorm: result.msgHashNormalized,\r\n    }]);\r\n  } else {\r\n    [localActivity] = createLocalTransactions(accountId, 'ton', [{\r\n      id: result.msgHashNormalized,\r\n      amount,\r\n      fromAddress,\r\n      toAddress: result.toAddress,\r\n      fee: realFee ?? 0n,\r\n      type: 'stake',\r\n      slug: state.tokenSlug,\r\n      externalMsgHashNorm: result.msgHashNormalized,\r\n    }]);\r\n  }\r\n\r\n  return {\r\n    ...result,\r\n    txId: localActivity.id,\r\n  };\r\n}\r\n\r\nexport async function submitUnstake(\r\n  accountId: string,\r\n  password: string | undefined,\r\n  amount: bigint,\r\n  state: ApiStakingState,\r\n  realFee?: bigint,\r\n) {\r\n  const { address: fromAddress } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  const result = await ton.submitUnstake(accountId, password, amount, state);\r\n  if ('error' in result) {\r\n    return result;\r\n  }\r\n\r\n  const [localActivity] = createLocalTransactions(accountId, 'ton', [{\r\n    id: result.msgHashNormalized,\r\n    amount: result.toncoinAmount,\r\n    fromAddress,\r\n    toAddress: result.toAddress,\r\n    fee: realFee ?? 0n,\r\n    type: 'unstakeRequest',\r\n    slug: TONCOIN.slug,\r\n    externalMsgHashNorm: result.msgHashNormalized,\r\n    ...result.localActivityParams,\r\n  }]);\r\n\r\n  return {\r\n    ...result,\r\n    txId: localActivity.id,\r\n  };\r\n}\r\n\r\nexport async function getStakingHistory(accountId: string): Promise<ApiStakingHistory> {\r\n  const { byChain: { ton: tonWallet } } = await fetchStoredAccount(accountId);\r\n  if (!tonWallet) return [];\r\n  return callBackendGet(`/staking/profits/${tonWallet.address}`);\r\n}\r\n\r\nexport async function tryUpdateStakingCommonData() {\r\n  try {\r\n    const tonClient = getTonClient('mainnet');\r\n    const response = await callBackendGet<ApiStakingCommonResponse>('/staking/common');\r\n\r\n    const data: ApiStakingCommonData = {\r\n      ...response,\r\n      liquid: {\r\n        ...response.liquid,\r\n        available: fromDecimal(response.liquid.available),\r\n      },\r\n      jettonPools: await Promise.all(response.jettonPools.map(async (pool) => {\r\n        const poolContract = tonClient.open(StakingPool.createFromAddress(Address.parse(pool.pool)));\r\n        const poolConfig = await poolContract.getStorageData();\r\n        return {\r\n          ...pool,\r\n          poolConfig,\r\n        };\r\n      })),\r\n    };\r\n    data.round.start *= 1000;\r\n    data.round.end *= 1000;\r\n    data.round.unlock *= 1000;\r\n    data.prevRound.start *= 1000;\r\n    data.prevRound.end *= 1000;\r\n    data.prevRound.unlock *= 1000;\r\n\r\n    setStakingCommonCache(data);\r\n  } catch (err) {\r\n    logDebugError('tryUpdateLiquidStakingState', err);\r\n  }\r\n}\r\n\r\nexport async function submitStakingClaimOrUnlock(\r\n  accountId: string,\r\n  password: string | undefined,\r\n  state: ApiJettonStakingState | ApiEthenaStakingState,\r\n  realFee?: bigint,\r\n) {\r\n  const { address: walletAddress } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  let result: ApiSubmitTransferTonResult;\r\n\r\n  switch (state.type) {\r\n    case 'jetton': {\r\n      result = await ton.submitTokenStakingClaim(accountId, password, state);\r\n      break;\r\n    }\r\n    case 'ethena': {\r\n      result = await ton.submitUnstakeEthenaLocked(accountId, password, state);\r\n      break;\r\n    }\r\n  }\r\n\r\n  if ('error' in result) {\r\n    return result;\r\n  }\r\n\r\n  const [localActivity] = createLocalTransactions(accountId, 'ton', [{\r\n    id: result.msgHashNormalized,\r\n    amount: result.amount,\r\n    fromAddress: walletAddress,\r\n    toAddress: result.toAddress,\r\n    fee: realFee ?? 0n,\r\n    slug: TONCOIN.slug,\r\n    externalMsgHashNorm: result.msgHashNormalized,\r\n    ...result.localActivityParams,\r\n  }]);\r\n\r\n  return {\r\n    ...result,\r\n    txId: localActivity.id,\r\n  };\r\n}\r\n","import nacl from 'tweetnacl';\r\n\r\nimport type { Theme } from '../../global/types';\r\nimport type { StorageKey } from '../storages/types';\r\nimport type { ApiAnyDisplayError, ApiBaseCurrency, ApiChain } from '../types';\r\n\r\nimport { setIsAppFocused } from '../../util/focusAwareDelay';\r\nimport { getLogs, logDebugError } from '../../util/logs';\r\nimport { pause } from '../../util/schedulers';\r\nimport chains from '../chains';\r\nimport * as ton from '../chains/ton';\r\nimport { fetchStoredAccounts, fetchStoredWallet, updateStoredWallet } from '../common/accounts';\r\nimport { callBackendGet } from '../common/backend';\r\nimport { SEC } from '../constants';\r\nimport { handleServerError } from '../errors';\r\nimport { storage } from '../storages';\r\n\r\nconst SIGN_MESSAGE = Buffer.from('MyTonWallet_AuthToken_n6i0k4w8pb');\r\n\r\nexport async function getBackendAuthToken(accountId: string, password: string) {\r\n  const accountWallet = await fetchStoredWallet(accountId, 'ton');\r\n  let { authToken } = accountWallet;\r\n  const { publicKey, isInitialized } = accountWallet;\r\n\r\n  if (!authToken) {\r\n    const privateKey = await ton.fetchPrivateKey(accountId, password);\r\n    const signature = nacl.sign.detached(SIGN_MESSAGE, privateKey!);\r\n    authToken = Buffer.from(signature).toString('base64');\r\n\r\n    await updateStoredWallet(accountId, 'ton', {\r\n      authToken,\r\n    });\r\n  }\r\n\r\n  if (!isInitialized) {\r\n    authToken += `:${publicKey}`;\r\n  }\r\n\r\n  return authToken;\r\n}\r\n\r\nexport async function fetchAccountConfigForDebugPurposesOnly() {\r\n  try {\r\n    const [accounts, stateVersion, mnemonicsEncrypted] = await Promise.all([\r\n      fetchStoredAccounts(),\r\n      storage.getItem('stateVersion'),\r\n      storage.getItem('mnemonicsEncrypted' as StorageKey),\r\n    ]);\r\n\r\n    return JSON.stringify({ accounts, stateVersion, mnemonicsEncrypted });\r\n  } catch (err) {\r\n    logDebugError('fetchAccountConfigForDebugPurposesOnly', err);\r\n\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport function ping() {\r\n  return true;\r\n}\r\n\r\nexport { setIsAppFocused, getLogs };\r\n\r\nexport async function getMoonpayOnrampUrl(chain: ApiChain, address: string, theme: Theme, currency: ApiBaseCurrency) {\r\n  try {\r\n    return await callBackendGet<{ url: string }>('/onramp-url', {\r\n      chain,\r\n      address,\r\n      theme,\r\n      currency: currency.toLowerCase(),\r\n    });\r\n  } catch (err) {\r\n    logDebugError('getMoonpayOnrampUrl', err);\r\n\r\n    return handleServerError(err);\r\n  }\r\n}\r\n\r\nexport function waitForLedgerApp(chain: ApiChain, options: {\r\n  timeout?: number;\r\n  attemptPause?: number;\r\n} = {}): Promise<boolean | { error: ApiAnyDisplayError }> {\r\n  const {\r\n    timeout = 1.25 * SEC,\r\n    attemptPause = 0.125 * SEC,\r\n  } = options;\r\n\r\n  let hasTimedOut = false;\r\n\r\n  const waitForDeadline = async () => {\r\n    await pause(timeout);\r\n    hasTimedOut = true;\r\n    return false;\r\n  };\r\n\r\n  const checkApp = async () => {\r\n    while (!hasTimedOut) {\r\n      try {\r\n        const result = await chains[chain].getIsLedgerAppOpen();\r\n        if (typeof result === 'object' && 'error' in result) return result;\r\n\r\n        if (result) {\r\n          return true;\r\n        }\r\n      } catch (err) {\r\n        logDebugError('waitForLedgerApp', chain, err);\r\n      }\r\n\r\n      await pause(attemptPause);\r\n    }\r\n\r\n    return false;\r\n  };\r\n\r\n  return Promise.race([waitForDeadline(), checkApp()]);\r\n}\r\n","import type { TonTransferParams } from '../chains/ton/types';\r\nimport type {\r\n  ApiChain,\r\n  ApiSwapActivity,\r\n  ApiSwapAsset,\r\n  ApiSwapBuildRequest,\r\n  ApiSwapBuildResponse,\r\n  ApiSwapCexCreateTransactionRequest,\r\n  ApiSwapCexCreateTransactionResponse,\r\n  ApiSwapCexEstimateRequest,\r\n  ApiSwapCexEstimateResponse,\r\n  ApiSwapEstimateRequest,\r\n  ApiSwapEstimateResponse,\r\n  ApiSwapHistoryItem,\r\n  ApiSwapPairAsset,\r\n  ApiSwapTransfer,\r\n  OnApiUpdate,\r\n} from '../types';\r\nimport type { ApiSubmitTransferOptions } from './types';\r\n\r\nimport { SWAP_API_VERSION, TONCOIN } from '../../config';\r\nimport { parseAccountId } from '../../util/account';\r\nimport { buildLocalTxId } from '../../util/activities';\r\nimport { omitUndefined } from '../../util/iteratees';\r\nimport * as ton from '../chains/ton';\r\nimport { fetchStoredChainAccount, fetchStoredWallet } from '../common/accounts';\r\nimport { callBackendGet, callBackendPost } from '../common/backend';\r\nimport { getBackendConfigCache } from '../common/cache';\r\nimport {\r\n  convertSwapItemToTrusted,\r\n  getSwapItemSlug,\r\n  patchSwapItem,\r\n  swapGetHistoryItem,\r\n  swapItemToActivity,\r\n} from '../common/swap';\r\nimport { ApiServerError } from '../errors';\r\nimport { callHook } from '../hooks';\r\nimport { getBackendAuthToken } from './other';\r\nimport { submitTransfer } from './transfer';\r\n\r\nlet onUpdate: OnApiUpdate;\r\n\r\nexport function initSwap(_onUpdate: OnApiUpdate) {\r\n  onUpdate = _onUpdate;\r\n}\r\n\r\nexport async function swapBuildTransfer(\r\n  accountId: string,\r\n  password: string,\r\n  request: ApiSwapBuildRequest,\r\n) {\r\n  const { network } = parseAccountId(accountId);\r\n  const authToken = await getBackendAuthToken(accountId, password);\r\n\r\n  const { address, version } = await fetchStoredWallet(accountId, 'ton');\r\n  request.walletVersion = version;\r\n\r\n  const { id, transfers } = await swapBuild(authToken, request);\r\n\r\n  const transferList = transfers.map((transfer) => ({\r\n    ...transfer,\r\n    amount: BigInt(transfer.amount),\r\n    isBase64Payload: true,\r\n  }));\r\n\r\n  try {\r\n    const account = await fetchStoredChainAccount(accountId, 'ton');\r\n    await ton.validateDexSwapTransfers(network, address, request, transferList, account);\r\n\r\n    const result = await ton.checkMultiTransactionDraft(accountId, transferList, request.shouldTryDiesel);\r\n\r\n    if ('error' in result) {\r\n      await patchSwapItem({\r\n        address, swapId: id, authToken, error: result.error,\r\n      });\r\n      return result;\r\n    }\r\n\r\n    return { ...result, id, transfers };\r\n  } catch (err: any) {\r\n    await patchSwapItem({\r\n      address, swapId: id, authToken, error: errorToString(err),\r\n    });\r\n    throw err;\r\n  }\r\n}\r\n\r\nexport async function swapSubmit(\r\n  accountId: string,\r\n  password: string,\r\n  transfers: ApiSwapTransfer[],\r\n  historyItem: ApiSwapHistoryItem,\r\n  isGasless?: boolean,\r\n) {\r\n  const swapId = historyItem.id;\r\n  const tonWallet = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  const { address } = tonWallet;\r\n  const authToken = tonWallet.authToken ?? await getBackendAuthToken(accountId, password);\r\n\r\n  try {\r\n    const transferList: TonTransferParams[] = transfers.map((transfer) => ({\r\n      ...transfer,\r\n      amount: BigInt(transfer.amount),\r\n      isBase64Payload: true,\r\n    }));\r\n\r\n    if (historyItem.from !== TONCOIN.symbol) {\r\n      transferList[0] = await ton.insertMintlessPayload('mainnet', address, historyItem.from, transferList[0]);\r\n    }\r\n\r\n    const result = await ton.submitMultiTransfer({\r\n      accountId,\r\n      password,\r\n      messages: transferList,\r\n      isGasless,\r\n    });\r\n\r\n    if ('error' in result) {\r\n      await patchSwapItem({\r\n        address, swapId, authToken, error: result.error,\r\n      });\r\n      return result;\r\n    }\r\n\r\n    delete result.messages[0].stateInit;\r\n\r\n    const from = getSwapItemSlug(historyItem, historyItem.from);\r\n    const to = getSwapItemSlug(historyItem, historyItem.to);\r\n\r\n    const swap: ApiSwapActivity = {\r\n      ...historyItem,\r\n      id: buildLocalTxId(result.msgHashNormalized),\r\n      from,\r\n      to,\r\n      kind: 'swap',\r\n      externalMsgHashNorm: result.msgHashNormalized,\r\n      extra: omitUndefined({\r\n        withW5Gasless: result.withW5Gasless,\r\n      }),\r\n    };\r\n\r\n    onUpdate({\r\n      type: 'newLocalActivities',\r\n      accountId,\r\n      activities: [swap],\r\n    });\r\n\r\n    await patchSwapItem({\r\n      address, swapId, authToken, msgHash: result.msgHash,\r\n    });\r\n\r\n    void callHook('onSwapCreated', accountId, swap.timestamp - 1);\r\n\r\n    return { activityId: swap.id };\r\n  } catch (err: any) {\r\n    await patchSwapItem({\r\n      address, swapId, authToken, error: errorToString(err),\r\n    });\r\n    throw err;\r\n  }\r\n}\r\n\r\nfunction errorToString(err: Error | string) {\r\n  return typeof err === 'string' ? err : err.stack;\r\n}\r\n\r\nexport async function fetchSwaps(accountId: string, ids: string[]) {\r\n  const { address } = await fetchStoredWallet(accountId, 'ton');\r\n  const results = await Promise.allSettled(\r\n    ids.map((id) => swapGetHistoryItem(address, id.replace('swap:', ''))),\r\n  );\r\n\r\n  const nonExistentIds: string[] = [];\r\n\r\n  const swaps = results\r\n    .map((result, i) => {\r\n      if (result.status === 'rejected') {\r\n        if (result.reason instanceof ApiServerError && result.reason.statusCode === 404) {\r\n          nonExistentIds.push(ids[i]);\r\n        }\r\n        return undefined;\r\n      }\r\n\r\n      return swapItemToActivity(result.value);\r\n    })\r\n    .filter(Boolean);\r\n\r\n  return { nonExistentIds, swaps };\r\n}\r\n\r\nexport async function swapEstimate(\r\n  accountId: string,\r\n  request: ApiSwapEstimateRequest,\r\n): Promise<ApiSwapEstimateResponse | { error: string }> {\r\n  const walletVersion = (await fetchStoredWallet(accountId, 'ton')).version;\r\n  const { swapVersion } = await getBackendConfigCache();\r\n\r\n  return callBackendPost('/swap/ton/estimate', {\r\n    ...request,\r\n    swapVersion: swapVersion ?? SWAP_API_VERSION,\r\n    walletVersion,\r\n  }, {\r\n    isAllowBadRequest: true,\r\n  });\r\n}\r\n\r\nexport async function swapBuild(authToken: string, request: ApiSwapBuildRequest): Promise<ApiSwapBuildResponse> {\r\n  const { swapVersion } = await getBackendConfigCache();\r\n\r\n  return callBackendPost('/swap/ton/build', {\r\n    ...request,\r\n    swapVersion: swapVersion ?? SWAP_API_VERSION,\r\n    isMsgHashMode: true,\r\n  }, {\r\n    authToken,\r\n  });\r\n}\r\n\r\nexport function swapGetAssets(): Promise<ApiSwapAsset[]> {\r\n  return callBackendGet('/swap/assets');\r\n}\r\n\r\nexport function swapGetPairs(symbolOrTokenAddress: string): Promise<ApiSwapPairAsset[]> {\r\n  return callBackendGet('/swap/pairs', { asset: symbolOrTokenAddress });\r\n}\r\n\r\nexport function swapCexEstimate(\r\n  request: ApiSwapCexEstimateRequest,\r\n): Promise<ApiSwapCexEstimateResponse | { error: string }> {\r\n  return callBackendPost<ApiSwapCexEstimateResponse | { error: string }>(\r\n    '/swap/cex/estimate',\r\n    request,\r\n    { isAllowBadRequest: true },\r\n  );\r\n}\r\n\r\nexport function swapCexValidateAddress(params: { slug: string; address: string }): Promise<{\r\n  result: boolean;\r\n  message?: string;\r\n}> {\r\n  return callBackendGet('/swap/cex/validate-address', params);\r\n}\r\n\r\nexport async function swapCexCreateTransaction(\r\n  accountId: string,\r\n  password: string,\r\n  request: ApiSwapCexCreateTransactionRequest,\r\n): Promise<{\r\n    swap: ApiSwapHistoryItem;\r\n    activity: ApiSwapActivity;\r\n  }> {\r\n  const authToken = await getBackendAuthToken(accountId, password);\r\n  const { swapVersion } = await getBackendConfigCache();\r\n\r\n  const { swap: rawSwap } = await callBackendPost<ApiSwapCexCreateTransactionResponse>('/swap/cex/createTransaction', {\r\n    ...request,\r\n    swapVersion: swapVersion ?? SWAP_API_VERSION,\r\n  }, {\r\n    authToken,\r\n  });\r\n\r\n  const swap = convertSwapItemToTrusted(rawSwap);\r\n  const activity = swapItemToActivity(swap);\r\n\r\n  onUpdate({\r\n    type: 'newActivities',\r\n    accountId,\r\n    activities: [activity],\r\n  });\r\n\r\n  void callHook('onSwapCreated', accountId, swap.timestamp - 1);\r\n\r\n  return { swap, activity };\r\n}\r\n\r\nexport async function swapCexSubmit(chain: ApiChain, transferOptions: ApiSubmitTransferOptions, swapId: string) {\r\n  const result = await submitTransfer(chain, transferOptions, false);\r\n\r\n  if (chain === 'ton' && 'msgHash' in result) {\r\n    const { accountId, password } = transferOptions;\r\n    const { address } = await fetchStoredWallet(accountId, 'ton');\r\n    const authToken = await getBackendAuthToken(accountId, password ?? '');\r\n    await patchSwapItem({ address, authToken, msgHash: result.msgHash, swapId });\r\n  }\r\n\r\n  return result;\r\n}\r\n","import type {\r\n  ApiAccountAny,\r\n  ApiAccountConfig,\r\n  ApiAccountWithMnemonic,\r\n  ApiActivityTimestamps,\r\n  ApiBackendConfig,\r\n  ApiChain,\r\n  ApiCurrencyRates,\r\n  ApiNetwork,\r\n  ApiSwapAsset,\r\n  ApiTokenDetails,\r\n  ApiTokenWithPrice,\r\n  ApiUpdatingStatus,\r\n  OnApiUpdate,\r\n} from '../types';\r\n\r\nimport { IS_AIR_APP, IS_CORE_WALLET, IS_STAKING_DISABLED, TONCOIN } from '../../config';\r\nimport { parseAccountId } from '../../util/account';\r\nimport { areDeepEqual } from '../../util/areDeepEqual';\r\nimport { omit } from '../../util/iteratees';\r\nimport { logDebugError } from '../../util/logs';\r\nimport { OrGate } from '../../util/orGate';\r\nimport { forbidConcurrency } from '../../util/schedulers';\r\nimport { getNativeToken } from '../../util/tokens';\r\nimport chains from '../chains';\r\nimport {\r\n  doesAccountHaveChain,\r\n  fetchMaybeStoredAccount,\r\n  fetchStoredAccount,\r\n  fetchStoredAccounts,\r\n} from '../common/accounts';\r\nimport { tryUpdateKnownAddresses } from '../common/addresses';\r\nimport { callBackendGet, callBackendPost } from '../common/backend';\r\nimport { setBackendConfigCache } from '../common/cache';\r\nimport { pollingLoop } from '../common/polling/utils';\r\nimport { getTokensCache, loadTokensCache, sendUpdateTokens, tokensPreload, updateTokens } from '../common/tokens';\r\nimport { MINUTE, SEC } from '../constants';\r\nimport { resolveDataPreloadPromise } from './preload';\r\nimport { tryUpdateStakingCommonData } from './staking';\r\nimport { swapGetAssets } from './swap';\r\n\r\nconst BACKEND_INTERVAL = 30 * SEC;\r\nconst LONG_BACKEND_INTERVAL = MINUTE;\r\nconst INCORRECT_TIME_DIFF = 30 * SEC;\r\n\r\nconst ACCOUNT_CONFIG_INTERVAL = { focused: MINUTE, notFocused: 10 * MINUTE };\r\n\r\nconst MAX_POST_TOKENS = 1000;\r\n\r\nlet onUpdate: OnApiUpdate;\r\nlet stopCommonBackendPolling: NoneToVoidFunction | undefined;\r\nlet stopActiveAccountPolling: NoneToVoidFunction | undefined;\r\nconst inactiveAccountPolling = IS_AIR_APP ? createInactiveAccountsPollingManager() : undefined;\r\nconst setUpdatingStatus = createUpdatingStatusManager();\r\n\r\nexport function initPolling(_onUpdate: OnApiUpdate) {\r\n  onUpdate = _onUpdate;\r\n\r\n  void loadTokensCache();\r\n\r\n  void Promise.allSettled([\r\n    tryUpdateKnownAddresses(),\r\n    tryUpdateTokens(),\r\n    tryUpdateCurrencyRates(),\r\n    !IS_STAKING_DISABLED && tryUpdateSwapTokens(),\r\n    tryUpdateStakingCommonData(),\r\n  ]).then(() => resolveDataPreloadPromise());\r\n\r\n  void tryUpdateConfig();\r\n\r\n  stopCommonBackendPolling?.();\r\n  stopCommonBackendPolling = setupCommonBackendPolling();\r\n}\r\n\r\nexport async function destroyPolling() {\r\n  stopCommonBackendPolling?.();\r\n  stopCommonBackendPolling = undefined;\r\n  removeAllPollingAccounts();\r\n  await setActivePollingAccount(undefined, {});\r\n}\r\n\r\nfunction setupCommonBackendPolling() {\r\n  const stopFns = [\r\n    pollingLoop({\r\n      period: BACKEND_INTERVAL,\r\n      skipInitialPoll: true,\r\n      poll: tryUpdateCurrencyRates,\r\n    }).stop,\r\n    pollingLoop({\r\n      period: LONG_BACKEND_INTERVAL,\r\n      skipInitialPoll: true,\r\n      async poll() {\r\n        await Promise.all([\r\n          tryUpdateTokens(),\r\n          tryUpdateKnownAddresses(),\r\n          !IS_STAKING_DISABLED && tryUpdateStakingCommonData(),\r\n          tryUpdateConfig(),\r\n          tryUpdateSwapTokens(),\r\n        ]);\r\n      },\r\n    }).stop,\r\n  ];\r\n\r\n  return () => {\r\n    for (const stopFn of stopFns) {\r\n      stopFn();\r\n    }\r\n  };\r\n}\r\n\r\nasync function tryUpdateTokens() {\r\n  try {\r\n    const tokens = await callBackendGet<ApiTokenWithPrice[]>('/assets');\r\n\r\n    for (const token of tokens) {\r\n      token.isFromBackend = true;\r\n    }\r\n\r\n    await tokensPreload.promise;\r\n    const tokensCache = getTokensCache();\r\n\r\n    const nonBackendTokenAddresses = Object.values(tokensCache.bySlug).reduce((result, token) => {\r\n      if (!token.isFromBackend && token.tokenAddress) {\r\n        result.push(token.tokenAddress);\r\n      }\r\n      return result;\r\n    }, [] as string[]);\r\n\r\n    // POST is used to retrieve data due to the potentially large number of addresses\r\n    const nonBackendTokenDetails = nonBackendTokenAddresses.length\r\n      ? await callBackendPost<ApiTokenDetails[]>('/assets', {\r\n        assets: nonBackendTokenAddresses.slice(0, MAX_POST_TOKENS),\r\n      }) : undefined;\r\n\r\n    await updateTokens(tokens, () => sendUpdateTokens(onUpdate), nonBackendTokenDetails, true);\r\n  } catch (err) {\r\n    logDebugError('tryUpdateTokens', err);\r\n  }\r\n}\r\n\r\nasync function tryUpdateCurrencyRates() {\r\n  try {\r\n    const currencyRates = await callBackendGet<{ rates: ApiCurrencyRates }>('/currency-rates');\r\n    onUpdate({\r\n      type: 'updateCurrencyRates',\r\n      rates: currencyRates.rates,\r\n    });\r\n  } catch (err) {\r\n    logDebugError('tryUpdateCurrencyRates', err);\r\n  }\r\n}\r\n\r\nasync function tryUpdateSwapTokens() {\r\n  try {\r\n    const assets = await swapGetAssets();\r\n\r\n    await tokensPreload.promise;\r\n\r\n    const tokens = assets.reduce((acc: Record<string, ApiSwapAsset>, asset) => {\r\n      acc[asset.slug] = {\r\n        // Fix legacy variable names\r\n        ...omit(asset as any, ['blockchain']) as ApiSwapAsset,\r\n        chain: 'blockchain' in asset ? asset.blockchain as string : asset.chain,\r\n        tokenAddress: 'contract' in asset && asset.contract !== TONCOIN.symbol\r\n          ? asset.contract as string\r\n          : asset.tokenAddress,\r\n      };\r\n      return acc;\r\n    }, {});\r\n\r\n    onUpdate({\r\n      type: 'updateSwapTokens',\r\n      tokens,\r\n    });\r\n  } catch (err) {\r\n    logDebugError('tryUpdateSwapTokens', err);\r\n  }\r\n}\r\n\r\nexport async function tryUpdateConfig() {\r\n  try {\r\n    const config = await callBackendGet<ApiBackendConfig>('/utils/get-config');\r\n    setBackendConfigCache(config);\r\n\r\n    const {\r\n      isLimited,\r\n      isCopyStorageEnabled = false,\r\n      supportAccountsCount = 1,\r\n      now: serverUtc,\r\n      country: countryCode,\r\n      swapVersion,\r\n      isUpdateRequired: isAppUpdateRequired,\r\n    } = config;\r\n\r\n    onUpdate({\r\n      type: 'updateConfig',\r\n      isLimited,\r\n      isCopyStorageEnabled,\r\n      supportAccountsCount,\r\n      countryCode,\r\n      isAppUpdateRequired,\r\n      swapVersion,\r\n    });\r\n\r\n    const localUtc = (new Date()).getTime();\r\n    if (Math.abs(serverUtc - localUtc) > INCORRECT_TIME_DIFF) {\r\n      onUpdate({\r\n        type: 'incorrectTime',\r\n      });\r\n    }\r\n  } catch (err) {\r\n    logDebugError('tryUpdateConfig', err);\r\n  }\r\n}\r\n\r\n/** Call it every time the active account changes */\r\nexport async function setActivePollingAccount(\r\n  accountId: string | undefined,\r\n  newestActivityTimestamps: ApiActivityTimestamps,\r\n) {\r\n  stopActiveAccountPolling?.();\r\n  stopActiveAccountPolling = undefined;\r\n\r\n  if (accountId) {\r\n    const account = await fetchStoredAccount(accountId);\r\n\r\n    const stopPollingFns = [\r\n      !IS_CORE_WALLET && setupAccountConfigPolling(accountId, account).stop,\r\n\r\n      ...(Object.keys(chains) as (keyof typeof chains)[]).map((chain) => {\r\n        if (doesAccountHaveChain(account, chain)) {\r\n          return chains[chain].setupActivePolling(\r\n            accountId,\r\n            account,\r\n            onUpdate,\r\n            setUpdatingStatus.bind(undefined, accountId, chain),\r\n            pickChainTimestamps(newestActivityTimestamps, chain),\r\n          );\r\n        }\r\n      }),\r\n    ];\r\n\r\n    stopActiveAccountPolling = () => {\r\n      for (const stopFn of stopPollingFns) {\r\n        if (stopFn) {\r\n          stopFn();\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  // Setting up inactive account polling at the end in order to give the active account polling a higher priority in the connection queue\r\n  inactiveAccountPolling?.setActiveAccount(accountId);\r\n}\r\n\r\n/** Call it every time a new account is created */\r\nexport function addPollingAccount(accountId: string, account: ApiAccountAny) {\r\n  inactiveAccountPolling?.addAccount(accountId, account);\r\n}\r\n\r\n/** Call it every time an account is removed (except for cases in the other remove...account functions) */\r\nexport function removePollingAccount(accountId: string) {\r\n  inactiveAccountPolling?.removeAccount(accountId);\r\n}\r\n\r\n/** Call it every time all accounts of a network are removed */\r\nexport function removeNetworkPollingAccounts(network: ApiNetwork) {\r\n  inactiveAccountPolling?.removeNetworkAccounts(network);\r\n}\r\n\r\n/** Call it every time all accounts are removed */\r\nexport function removeAllPollingAccounts() {\r\n  inactiveAccountPolling?.removeAllAccounts();\r\n}\r\n\r\nfunction setupAccountConfigPolling(accountId: string, account: ApiAccountAny) {\r\n  let lastResult: ApiAccountConfig | undefined;\r\n\r\n  const partialAccount = omit(account as ApiAccountWithMnemonic, ['mnemonicEncrypted']);\r\n\r\n  return pollingLoop({\r\n    period: ACCOUNT_CONFIG_INTERVAL,\r\n    async poll() {\r\n      try {\r\n        const accountConfig = await callBackendPost<ApiAccountConfig>('/account-config', partialAccount);\r\n\r\n        if (!areDeepEqual(accountConfig, lastResult)) {\r\n          lastResult = accountConfig;\r\n          onUpdate({\r\n            type: 'updateAccountConfig',\r\n            accountId,\r\n            accountConfig,\r\n          });\r\n        }\r\n      } catch (err) {\r\n        logDebugError('setupBackendAccountPolling', err);\r\n      }\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Returns a stateful function that receives updating statuses from multiple chains and merges them together into a\r\n * single set of consistent 'updatingStatus' events for the UI.\r\n */\r\nfunction createUpdatingStatusManager() {\r\n  const updatingStatuses = new Map<string, OrGate<ApiChain>>();\r\n\r\n  return (accountId: string, chain: ApiChain, kind: ApiUpdatingStatus['kind'], isUpdating: boolean) => {\r\n    const key = `${accountId} ${kind}`;\r\n    let chainsBeingUpdated = updatingStatuses.get(key);\r\n    if (!chainsBeingUpdated) {\r\n      chainsBeingUpdated = new OrGate<ApiChain>((isUpdating) => {\r\n        onUpdate({ type: 'updatingStatus', kind, accountId, isUpdating });\r\n      });\r\n      updatingStatuses.set(key, chainsBeingUpdated);\r\n    }\r\n\r\n    chainsBeingUpdated.toggle(chain, isUpdating);\r\n  };\r\n}\r\n\r\n/**\r\n * Manages polling for the inactive accounts.\r\n * The goal is polling the accounts from the network of the current active account, but not the active account itself.\r\n *\r\n * @todo: Deduplicate polling the same addresses, if multiple accounts have it\r\n */\r\nfunction createInactiveAccountsPollingManager() {\r\n  const stopByAccount: Record<string, NoneToVoidFunction> = {};\r\n  let activeAccountId: string | undefined;\r\n\r\n  async function setActiveAccount(accountId: string | undefined) {\r\n    if (accountId === activeAccountId) {\r\n      return;\r\n    }\r\n\r\n    if (accountId === undefined) {\r\n      stopAllPollings();\r\n      return;\r\n    }\r\n\r\n    if (!activeAccountId || parseAccountId(accountId).network !== parseAccountId(activeAccountId).network) {\r\n      await switchNetwork(accountId);\r\n      return;\r\n    }\r\n\r\n    const previousActiveAccountId = activeAccountId;\r\n    activeAccountId = accountId;\r\n\r\n    // Stop polling the now active account\r\n    stopByAccount[activeAccountId]?.();\r\n    delete stopByAccount[activeAccountId];\r\n\r\n    // Start polling the previous active account\r\n    const previousActiveAccount = await fetchMaybeStoredAccount(previousActiveAccountId);\r\n    if (previousActiveAccount) { // The previously active account may get removed at this moment\r\n      startAccountPolling(previousActiveAccountId, previousActiveAccount);\r\n    }\r\n  }\r\n\r\n  function addAccount(accountId: string, account: ApiAccountAny) {\r\n    const isActiveAccount = accountId === activeAccountId;\r\n    const isCurrentNetwork = activeAccountId\r\n      && parseAccountId(accountId).network === parseAccountId(activeAccountId).network;\r\n\r\n    if (!isActiveAccount && isCurrentNetwork) {\r\n      startAccountPolling(accountId, account);\r\n    }\r\n  }\r\n\r\n  function removeAccount(accountId: string) {\r\n    stopByAccount[accountId]?.();\r\n    delete stopByAccount[accountId];\r\n  }\r\n\r\n  function removeNetworkAccounts(network: ApiNetwork) {\r\n    if (activeAccountId && parseAccountId(activeAccountId).network === network) {\r\n      // Inactive account polling must poll only the network of the active account, so removing the network means removing all account\r\n      stopAllPollings();\r\n    }\r\n  }\r\n\r\n  function removeAllAccounts() {\r\n    stopAllPollings();\r\n  }\r\n\r\n  async function switchNetwork(newActiveAccountId: string) {\r\n    stopAllPollings();\r\n    activeAccountId = newActiveAccountId;\r\n    const { network } = parseAccountId(activeAccountId);\r\n    const accounts = await fetchStoredAccounts();\r\n    const otherAccountIds = Object.keys(accounts).filter((accountId) => (\r\n      accountId !== activeAccountId\r\n      && parseAccountId(accountId).network === network\r\n    ));\r\n    otherAccountIds.map((accountId) => startAccountPolling(accountId, accounts[accountId]));\r\n  }\r\n\r\n  function startAccountPolling(accountId: string, account: ApiAccountAny) {\r\n    if (stopByAccount[accountId]) return;\r\n\r\n    const stopFns = (Object.keys(chains) as (keyof typeof chains)[]).map((chain) => {\r\n      if (doesAccountHaveChain(account, chain)) {\r\n        return chains[chain].setupInactivePolling(accountId, account, onUpdate);\r\n      }\r\n    });\r\n\r\n    stopByAccount[accountId] = () => {\r\n      for (const stopChain of stopFns) {\r\n        stopChain?.();\r\n      }\r\n    };\r\n  }\r\n\r\n  function stopAllPollings() {\r\n    for (const [accountId, stopAccountPolling] of Object.entries(stopByAccount)) {\r\n      stopAccountPolling();\r\n      delete stopByAccount[accountId];\r\n    }\r\n  }\r\n\r\n  const preventRaceCondition = forbidConcurrency as\r\n    <Args extends unknown[]>(task: (...args: Args) => unknown) => (...args: Args) => void;\r\n\r\n  return {\r\n    setActiveAccount: preventRaceCondition(setActiveAccount),\r\n    addAccount: preventRaceCondition(addAccount),\r\n    removeAccount: preventRaceCondition(removeAccount),\r\n    removeNetworkAccounts: preventRaceCondition(removeNetworkAccounts),\r\n    removeAllAccounts: preventRaceCondition(removeAllAccounts),\r\n  };\r\n}\r\n\r\nfunction pickChainTimestamps(bySlug: ApiActivityTimestamps, chain: ApiChain) {\r\n  const { slug: nativeSlug } = getNativeToken(chain);\r\n  return Object.entries(bySlug).reduce((newBySlug, [slug, timestamp]) => {\r\n    if (slug === nativeSlug || slug.startsWith(`${chain}-`)) {\r\n      newBySlug[slug] = timestamp;\r\n    }\r\n    return newBySlug;\r\n  }, {} as ApiActivityTimestamps);\r\n}\r\n","import type { ApiInitArgs, OnApiUpdate } from '../types';\r\n\r\nimport { initWindowConnector } from '../../util/windowProvider/connector';\r\nimport * as ton from '../chains/ton';\r\nimport { fetchBackendReferrer } from '../common/backend';\r\nimport { connectUpdater, disconnectUpdater, startStorageMigration } from '../common/helpers';\r\nimport { setEnvironment } from '../environment';\r\nimport { addHooks } from '../hooks';\r\nimport { storage } from '../storages';\r\nimport * as tonConnect from '../tonConnect';\r\nimport * as tonConnectSse from '../tonConnect/sse';\r\nimport { destroyPolling } from './polling';\r\nimport * as methods from '.';\r\n\r\naddHooks({\r\n  onDappDisconnected: tonConnectSse.sendSseDisconnect,\r\n  onDappsChanged: tonConnectSse.resetupSseConnection,\r\n});\r\n\r\nexport default async function init(onUpdate: OnApiUpdate, args: ApiInitArgs) {\r\n  connectUpdater(onUpdate);\r\n  const environment = setEnvironment(args);\r\n\r\n  initWindowConnector();\r\n\r\n  methods.initAccounts(onUpdate);\r\n  methods.initPolling(onUpdate);\r\n  methods.initTransfer(onUpdate);\r\n  methods.initStaking();\r\n  methods.initSwap(onUpdate);\r\n  methods.initNfts(onUpdate);\r\n\r\n  if (environment.isDappSupported) {\r\n    methods.initDapps(onUpdate);\r\n    tonConnect.initTonConnect(onUpdate);\r\n  }\r\n\r\n  if (environment.isSseSupported) {\r\n    tonConnectSse.initSse(onUpdate);\r\n  }\r\n\r\n  await startStorageMigration(onUpdate, ton, args.accountIds);\r\n\r\n  if (environment.isSseSupported) {\r\n    void tonConnectSse.resetupSseConnection();\r\n  }\r\n\r\n  void saveReferrer(args);\r\n}\r\n\r\nexport function destroy() {\r\n  void destroyPolling();\r\n  disconnectUpdater();\r\n}\r\n\r\nasync function saveReferrer(args: ApiInitArgs) {\r\n  let referrer = await storage.getItem('referrer');\r\n\r\n  if (referrer) {\r\n    return;\r\n  }\r\n\r\n  referrer = args.referrer ?? await fetchBackendReferrer();\r\n\r\n  if (referrer) {\r\n    await storage.setItem('referrer', referrer);\r\n  }\r\n}\r\n","import type { StorageKey } from '../storages/types';\r\n\r\nimport { storage } from '../storages';\r\n\r\ntype OldAccount = {\r\n  address: string;\r\n  publicKey: string;\r\n  version: string;\r\n  ledger?: {\r\n    index: number;\r\n    driver: string;\r\n    deviceId?: string;\r\n    deviceName?: string;\r\n  };\r\n  authToken?: string;\r\n  isInitialized?: boolean;\r\n};\r\n\r\nexport async function start() {\r\n  const oldAccountById: Record<string, OldAccount> | undefined = await storage.getItem('accounts');\r\n\r\n  if (!oldAccountById) return;\r\n\r\n  const mnemonicById: Record<string, string> = await storage.getItem('mnemonicsEncrypted' as StorageKey);\r\n  const newAccountById: Record<string, any> = {};\r\n\r\n  for (const [accountId, oldAccount] of Object.entries(oldAccountById)) {\r\n    const {\r\n      address, version, publicKey, authToken, ledger, isInitialized,\r\n    } = oldAccount;\r\n\r\n    const tonWallet = {\r\n      type: 'ton',\r\n      address,\r\n      version,\r\n      publicKey,\r\n      authToken,\r\n      isInitialized,\r\n      index: ledger?.index ?? 0,\r\n    };\r\n\r\n    newAccountById[accountId] = ledger ? {\r\n      type: 'ledger',\r\n      ton: tonWallet,\r\n      driver: ledger.driver,\r\n      deviceId: ledger.deviceId,\r\n      deviceName: ledger.deviceName,\r\n    } : {\r\n      type: 'ton',\r\n      mnemonicEncrypted: mnemonicById[accountId],\r\n      ton: tonWallet,\r\n    };\r\n  }\r\n\r\n  await storage.setItem('accounts', newAccountById);\r\n}\r\n","import type { ApiDapp } from '../types';\r\n\r\nimport { getDappConnectionUniqueId } from '../../util/getDappConnectionUniqueId';\r\nimport { storage } from '../storages';\r\n\r\nexport async function start() {\r\n  // Previous schema: Record<accountId, Record<url, ApiDapp>>\r\n  // New schema:     Record<accountId, Record<url, Record<uniqueId, ApiDapp>>>\r\n  const oldState: Record<string, Record<string, ApiDapp>> | undefined = await storage.getItem('dapps');\r\n\r\n  if (!oldState) return;\r\n\r\n  const newState: Record<string, Record<string, Record<string, ApiDapp>>> = {};\r\n\r\n  for (const [accountId, byUrl] of Object.entries(oldState)) {\r\n    newState[accountId] = {};\r\n\r\n    for (const [url, dapp] of Object.entries(byUrl)) {\r\n      const uniqueId = getDappConnectionUniqueId(dapp);\r\n      newState[accountId][url] = { [uniqueId]: dapp };\r\n    }\r\n  }\r\n\r\n  await storage.setItem('dapps', newState);\r\n}\r\n","import { pick } from '../../util/iteratees';\r\nimport { storage } from '../storages';\r\n\r\nexport async function start(activeAccountIds?: string[]) {\r\n  if (!activeAccountIds || activeAccountIds.length === 0) {\r\n    return;\r\n  }\r\n\r\n  const accounts: Record<string, any> | undefined = await storage.getItem('accounts');\r\n\r\n  if (!accounts) {\r\n    return;\r\n  }\r\n\r\n  await storage.setItem('accounts', pick(accounts, activeAccountIds));\r\n}\r\n","import type { ApiAccountAny, ApiTonWallet, ApiTronWallet } from '../types';\r\n\r\nimport { mapValues, omitUndefined } from '../../util/iteratees';\r\nimport { storage } from '../storages';\r\n\r\ntype OldAccount = Omit<ApiAccountAny, 'byChain'> & {\r\n  ton?: ApiTonWallet & { type?: 'ton' };\r\n  tron?: ApiTronWallet & { type?: 'tron' };\r\n};\r\n\r\nexport async function start() {\r\n  const oldAccounts: Record<string, OldAccount> | undefined = await storage.getItem('accounts');\r\n  if (!oldAccounts) {\r\n    return;\r\n  }\r\n\r\n  const newAccounts = mapValues(oldAccounts, (oldAccount) => {\r\n    const { ton, tron, ...account } = oldAccount;\r\n    if (ton) delete ton.type;\r\n    if (tron) delete tron.type;\r\n    return {\r\n      ...account,\r\n      byChain: omitUndefined({ ton, tron }),\r\n    };\r\n  });\r\n\r\n  await storage.setItem('accounts' as any, newAccounts);\r\n}\r\n","import { storage } from '../storages';\r\n\r\nexport async function start() {\r\n  // Remove baseCurrency from storage as it's now handled in global state only\r\n  try {\r\n    await storage.removeItem('baseCurrency' as any);\r\n  } catch {\r\n    // The key doesn't exist\r\n  }\r\n}\r\n","import type { ApiActivity, ApiChain, ApiFetchActivitySliceOptions, ApiTransactionActivity } from '../types';\r\n\r\nimport { DEBUG } from '../../config';\r\nimport { getActivityChains } from '../../util/activities';\r\nimport { areActivitiesSortedAndUnique, mergeSortedActivitiesToMaxTime } from '../../util/activities/order';\r\nimport { logDebugError } from '../../util/logs';\r\nimport { getChainBySlug } from '../../util/tokens';\r\nimport chains from '../chains';\r\nimport { fetchStoredAccount } from '../common/accounts';\r\nimport { swapReplaceCexActivities } from '../common/swap';\r\n\r\nexport async function fetchPastActivities(\r\n  accountId: string,\r\n  limit: number,\r\n  tokenSlug?: string,\r\n  toTimestamp?: number,\r\n): Promise<ApiActivity[] | undefined> {\r\n  try {\r\n    let activities = tokenSlug\r\n      ? await fetchTokenActivitySlice(accountId, limit, tokenSlug, toTimestamp)\r\n      : await fetchAllActivitySlice(accountId, limit, toTimestamp);\r\n\r\n    activities = await swapReplaceCexActivities(accountId, activities, tokenSlug);\r\n\r\n    return activities;\r\n  } catch (err) {\r\n    logDebugError('fetchPastActivities', tokenSlug, err);\r\n    return undefined;\r\n  }\r\n}\r\n\r\nfunction fetchTokenActivitySlice(\r\n  accountId: string,\r\n  limit: number,\r\n  tokenSlug: string,\r\n  toTimestamp?: number,\r\n) {\r\n  const chain = getChainBySlug(tokenSlug);\r\n  return fetchAndCheckActivitySlice(chain, { accountId, tokenSlug, toTimestamp, limit });\r\n}\r\n\r\nasync function fetchAllActivitySlice(\r\n  accountId: string,\r\n  limit: number,\r\n  toTimestamp?: number,\r\n): Promise<ApiActivity[]> {\r\n  const account = await fetchStoredAccount(accountId);\r\n  const accountChains = Object.keys(account.byChain) as (keyof typeof account.byChain)[];\r\n\r\n  const activityChunks = await Promise.all(\r\n    // The `fetchActivitySlice` method of all chains must return sorted activities\r\n    accountChains.map((chain) => fetchAndCheckActivitySlice(chain, { accountId, toTimestamp, limit })),\r\n  );\r\n\r\n  return mergeSortedActivitiesToMaxTime(...activityChunks);\r\n}\r\n\r\nexport function decryptComment(accountId: string, activity: ApiTransactionActivity, password?: string) {\r\n  const { encryptedComment } = activity;\r\n  if (!encryptedComment) {\r\n    return activity.comment ?? '';\r\n  }\r\n\r\n  const chain = getActivityChains(activity)[0];\r\n  if (chain) {\r\n    return chains[chain].decryptComment({ accountId, activity: { ...activity, encryptedComment }, password });\r\n  }\r\n\r\n  return '';\r\n}\r\n\r\nexport async function fetchActivityDetails(accountId: string, activity: ApiActivity) {\r\n  for (const chain of getActivityChains(activity)) {\r\n    const newActivity = await chains[chain].fetchActivityDetails(accountId, activity);\r\n    if (newActivity) {\r\n      return newActivity;\r\n    }\r\n  }\r\n\r\n  return activity;\r\n}\r\n\r\nasync function fetchAndCheckActivitySlice(chain: ApiChain, options: ApiFetchActivitySliceOptions) {\r\n  const activities = await chains[chain].fetchActivitySlice(options);\r\n\r\n  // Sorting is important for `mergeSortedActivities`, so it's checked in the debug mode\r\n  if (DEBUG && !areActivitiesSortedAndUnique(activities)) {\r\n    logDebugError(`The all activity slice of ${chain} is not sorted properly or has duplicates`, options);\r\n  }\r\n\r\n  return activities;\r\n}\r\n","import type { ApiActivityTimestamps, OnApiUpdate } from '../types';\r\n\r\nimport { IS_EXTENSION } from '../../config';\r\nimport { getCurrentAccountId, loginResolve } from '../common/accounts';\r\nimport { waitStorageMigration } from '../common/helpers';\r\nimport { sendUpdateTokens } from '../common/tokens';\r\nimport { callHook } from '../hooks';\r\nimport { storage } from '../storages';\r\nimport { setActivePollingAccount } from './polling';\r\n\r\nlet onUpdate: OnApiUpdate;\r\n\r\nexport function initAccounts(_onUpdate: OnApiUpdate) {\r\n  onUpdate = _onUpdate;\r\n}\r\n\r\nexport async function activateAccount(accountId: string, newestActivityTimestamps: ApiActivityTimestamps = {}) {\r\n  await waitStorageMigration();\r\n\r\n  const prevAccountId = await getCurrentAccountId();\r\n  const isFirstLogin = !prevAccountId;\r\n\r\n  await storage.setItem('currentAccountId', accountId);\r\n  loginResolve();\r\n\r\n  if (IS_EXTENSION) {\r\n    void callHook('onFirstLogin');\r\n  }\r\n\r\n  if (isFirstLogin) {\r\n    sendUpdateTokens(onUpdate);\r\n  }\r\n\r\n  void setActivePollingAccount(accountId, newestActivityTimestamps);\r\n}\r\n\r\nexport async function deactivateAllAccounts() {\r\n  void setActivePollingAccount(undefined, {});\r\n  await storage.removeItem('currentAccountId');\r\n\r\n  if (IS_EXTENSION) {\r\n    void callHook('onFullLogout');\r\n  }\r\n}\r\n","import type { GlobalState } from '../../global/types';\r\nimport type { ApiTonWalletVersion } from '../chains/ton/types';\r\nimport type {\r\n  ApiAccountAny,\r\n  ApiAccountWithChain,\r\n  ApiAccountWithMnemonic,\r\n  ApiActivityTimestamps,\r\n  ApiAnyDisplayError,\r\n  ApiChain,\r\n  ApiImportAddressByChain,\r\n  ApiLedgerAccount,\r\n  ApiLedgerAccountInfo,\r\n  ApiLedgerDriver,\r\n  ApiLedgerWalletInfo,\r\n  ApiNetwork,\r\n  ApiTonAccount,\r\n  ApiTonWallet,\r\n  ApiViewAccount,\r\n  ApiWalletByChain,\r\n} from '../types';\r\nimport { ApiCommonError } from '../types';\r\n\r\nimport { DEFAULT_WALLET_VERSION, IS_BIP39_MNEMONIC_ENABLED, IS_CORE_WALLET } from '../../config';\r\nimport { parseAccountId } from '../../util/account';\r\nimport isMnemonicPrivateKey from '../../util/isMnemonicPrivateKey';\r\nimport { range } from '../../util/iteratees';\r\nimport { createTaskQueue } from '../../util/schedulers';\r\nimport chains from '../chains';\r\nimport * as ton from '../chains/ton';\r\nimport { toBase64Address } from '../chains/ton/util/tonCore';\r\nimport {\r\n  fetchStoredAccounts,\r\n  fetchStoredChainAccount,\r\n  getAccountChains,\r\n  getNewAccountId,\r\n  removeAccountValue,\r\n  removeNetworkAccountsValue,\r\n  setAccountValue,\r\n  updateStoredAccount,\r\n} from '../common/accounts';\r\nimport {\r\n  decryptMnemonic,\r\n  encryptMnemonic,\r\n  generateBip39Mnemonic,\r\n  validateBip39Mnemonic,\r\n} from '../common/mnemonic';\r\nimport { tokenRepository } from '../db';\r\nimport { getEnvironment } from '../environment';\r\nimport { handleServerError } from '../errors';\r\nimport { storage } from '../storages';\r\nimport { activateAccount, deactivateAllAccounts } from './accounts';\r\nimport { removeAccountDapps, removeAllDapps, removeNetworkDapps } from './dapps';\r\nimport {\r\n  addPollingAccount,\r\n  removeAllPollingAccounts,\r\n  removeNetworkPollingAccounts,\r\n  removePollingAccount,\r\n} from './polling';\r\n\r\nexport function generateMnemonic(isBip39: boolean) {\r\n  if (isBip39) return generateBip39Mnemonic();\r\n  return ton.generateMnemonic();\r\n}\r\n\r\nexport function createWallet(\r\n  network: ApiNetwork,\r\n  mnemonic: string[],\r\n  password: string,\r\n  version?: ApiTonWalletVersion,\r\n) {\r\n  if (!version) version = DEFAULT_WALLET_VERSION;\r\n\r\n  return importMnemonic(network, mnemonic, password, version);\r\n}\r\n\r\nexport function validateMnemonic(mnemonic: string[]) {\r\n  return (validateBip39Mnemonic(mnemonic) && IS_BIP39_MNEMONIC_ENABLED) || ton.validateMnemonic(mnemonic);\r\n}\r\n\r\nexport async function importMnemonic(\r\n  network: ApiNetwork,\r\n  mnemonic: string[],\r\n  password: string,\r\n  version?: ApiTonWalletVersion,\r\n) {\r\n  const isPrivateKey = isMnemonicPrivateKey(mnemonic);\r\n  let isBip39Mnemonic = validateBip39Mnemonic(mnemonic);\r\n  const isTonMnemonic = await ton.validateMnemonic(mnemonic);\r\n\r\n  if (!isPrivateKey && !isTonMnemonic && (!isBip39Mnemonic || !IS_BIP39_MNEMONIC_ENABLED)) {\r\n    throw new Error('Invalid mnemonic');\r\n  }\r\n\r\n  const mnemonicEncrypted = await encryptMnemonic(mnemonic, password);\r\n\r\n  // This is a defensive approach against potential corrupted encryption reported by some users\r\n  const decryptedMnemonic = await decryptMnemonic(mnemonicEncrypted, password)\r\n    .catch(() => undefined);\r\n\r\n  if (!password || !decryptedMnemonic) {\r\n    return { error: ApiCommonError.DebugError };\r\n  }\r\n\r\n  let account: ApiAccountAny;\r\n  let tonWallet: ApiTonWallet & { lastTxId?: string } | undefined;\r\n\r\n  try {\r\n    if (isBip39Mnemonic && isTonMnemonic) {\r\n      tonWallet = await ton.getWalletFromMnemonic(mnemonic, network, version);\r\n      if (tonWallet.lastTxId) {\r\n        isBip39Mnemonic = false;\r\n      }\r\n    }\r\n\r\n    if (isBip39Mnemonic) {\r\n      account = {\r\n        type: 'bip39',\r\n        mnemonicEncrypted,\r\n        byChain: {},\r\n      };\r\n\r\n      await Promise.all((Object.keys(chains) as (keyof typeof chains)[]).map(async (chain) => {\r\n        const wallet = await chains[chain].getWalletFromBip39Mnemonic(network, mnemonic);\r\n        account.byChain[chain as 'ton'] = wallet as ApiWalletByChain['ton'];\r\n      }));\r\n    } else {\r\n      if (!tonWallet) {\r\n        tonWallet = isPrivateKey\r\n          ? await ton.getWalletFromPrivateKey(mnemonic[0], network, version)\r\n          : await ton.getWalletFromMnemonic(mnemonic, network, version);\r\n      }\r\n      account = {\r\n        type: 'ton',\r\n        mnemonicEncrypted,\r\n        byChain: {\r\n          ton: tonWallet,\r\n        },\r\n      };\r\n    }\r\n\r\n    const accountId = await addAccount(network, account);\r\n    const secondNetworkAccount = IS_CORE_WALLET ? await createAccountWithSecondNetwork({\r\n      accountId, network, mnemonic, mnemonicEncrypted, version,\r\n    }) : undefined;\r\n    void activateAccount(accountId);\r\n\r\n    return {\r\n      accountId,\r\n      byChain: getAccountChains(account),\r\n      secondNetworkAccount,\r\n    };\r\n  } catch (err) {\r\n    return handleServerError(err);\r\n  }\r\n}\r\n\r\nexport async function createAccountWithSecondNetwork(options: {\r\n  accountId: string;\r\n  network: ApiNetwork;\r\n  mnemonic: string[];\r\n  mnemonicEncrypted: string;\r\n  version?: ApiTonWalletVersion;\r\n}): Promise<GlobalState['auth']['secondNetworkAccount']> {\r\n  const {\r\n    mnemonic, version, mnemonicEncrypted,\r\n  } = options;\r\n  const { network, accountId } = options;\r\n  const tonWallet = await ton.getWalletFromMnemonic(mnemonic, network, version);\r\n\r\n  const secondNetwork = network === 'testnet' ? 'mainnet' : 'testnet';\r\n  tonWallet.address = toBase64Address(tonWallet.address, false, secondNetwork);\r\n  const account: ApiTonAccount = {\r\n    type: 'ton',\r\n    mnemonicEncrypted,\r\n    byChain: {\r\n      ton: tonWallet,\r\n    },\r\n  };\r\n  const secondAccountId = await addAccount(secondNetwork, account, parseAccountId(accountId).id);\r\n\r\n  return {\r\n    accountId: secondAccountId,\r\n    byChain: getAccountChains(account),\r\n    network: secondNetwork,\r\n  };\r\n}\r\n\r\nexport async function importLedgerAccount(network: ApiNetwork, accountInfo: ApiLedgerAccountInfo) {\r\n  const { byChain, driver, deviceId, deviceName } = accountInfo;\r\n\r\n  const account: ApiLedgerAccount = {\r\n    type: 'ledger',\r\n    byChain,\r\n    driver,\r\n    deviceId,\r\n    deviceName,\r\n  };\r\n\r\n  const accountId = await addAccount(network, account);\r\n\r\n  return { accountId, byChain: getAccountChains(account) };\r\n}\r\n\r\nexport async function getLedgerWallets(\r\n  chain: ApiChain,\r\n  network: ApiNetwork,\r\n  startWalletIndex: number,\r\n  count: number,\r\n): Promise<ApiLedgerWalletInfo[] | { error: ApiAnyDisplayError }> {\r\n  const { getLedgerDeviceInfo } = await import('../common/ledger');\r\n  const { driver, deviceId, deviceName } = await getLedgerDeviceInfo();\r\n\r\n  const walletInfos = await chains[chain].getWalletsFromLedgerAndLoadBalance(\r\n    network,\r\n    range(startWalletIndex, startWalletIndex + count),\r\n  );\r\n  if ('error' in walletInfos) return walletInfos;\r\n\r\n  return walletInfos.map((walletInfo) => ({\r\n    ...walletInfo,\r\n    driver,\r\n    deviceId,\r\n    deviceName,\r\n  }));\r\n}\r\n\r\n// When multiple Ledger accounts are imported, they all are created simultaneously. This causes a race condition causing\r\n// multiple accounts having the same id. `createTaskQueue(1)` forces the accounts to be imported sequentially.\r\nconst addAccountMutex = createTaskQueue(1);\r\n\r\nasync function addAccount(network: ApiNetwork, account: ApiAccountAny, preferredId?: number) {\r\n  const accountId = await addAccountMutex.run(async () => {\r\n    const accountId = await getNewAccountId(network, preferredId);\r\n    await setAccountValue(accountId, 'accounts', account);\r\n    return accountId;\r\n  });\r\n\r\n  addPollingAccount(accountId, account);\r\n\r\n  return accountId;\r\n}\r\n\r\nexport async function removeNetworkAccounts(network: ApiNetwork) {\r\n  removeNetworkPollingAccounts(network);\r\n\r\n  await Promise.all([\r\n    deactivateAllAccounts(),\r\n    removeNetworkAccountsValue(network, 'accounts'),\r\n    getEnvironment().isDappSupported && removeNetworkDapps(network),\r\n  ]);\r\n}\r\n\r\nexport async function resetAccounts() {\r\n  removeAllPollingAccounts();\r\n\r\n  await Promise.all([\r\n    deactivateAllAccounts(),\r\n    storage.removeItem('accounts'),\r\n    getEnvironment().isDappSupported && removeAllDapps(),\r\n    tokenRepository.clear(),\r\n  ]);\r\n}\r\n\r\nexport async function removeAccount(\r\n  accountId: string,\r\n  nextAccountId: string,\r\n  newestActivityTimestamps?: ApiActivityTimestamps,\r\n) {\r\n  removePollingAccount(accountId);\r\n\r\n  await Promise.all([\r\n    removeAccountValue(accountId, 'accounts'),\r\n    getEnvironment().isDappSupported && removeAccountDapps(accountId),\r\n  ]);\r\n\r\n  await activateAccount(nextAccountId, newestActivityTimestamps);\r\n}\r\n\r\nexport async function changePassword(oldPassword: string, password: string) {\r\n  for (const [accountId, account] of Object.entries(await fetchStoredAccounts())) {\r\n    if (!('mnemonicEncrypted' in account)) continue;\r\n\r\n    const mnemonic = await decryptMnemonic(account.mnemonicEncrypted, oldPassword);\r\n    const encryptedMnemonic = await encryptMnemonic(mnemonic, password);\r\n\r\n    await updateStoredAccount<ApiAccountWithMnemonic>(accountId, {\r\n      mnemonicEncrypted: encryptedMnemonic,\r\n    });\r\n  }\r\n}\r\n\r\nexport async function importViewAccount(network: ApiNetwork, addressByChain: ApiImportAddressByChain) {\r\n  try {\r\n    const account: ApiViewAccount = {\r\n      type: 'view',\r\n      byChain: {},\r\n    };\r\n    let title: string | undefined;\r\n    let error: { error: string; chain: ApiChain } | undefined;\r\n\r\n    await Promise.all(Object.entries(addressByChain).map(async ([_chain, address]) => {\r\n      const chain = _chain as ApiChain;\r\n      const wallet = await chains[chain].getWalletFromAddress(network, address);\r\n      if ('error' in wallet) {\r\n        error = { ...wallet, chain };\r\n        return;\r\n      }\r\n\r\n      account.byChain[chain as 'ton'] = wallet.wallet as ApiWalletByChain['ton'];\r\n      if (wallet.title) title = wallet.title;\r\n    }));\r\n\r\n    if (error) return error;\r\n\r\n    const accountId = await addAccount(network, account);\r\n    void activateAccount(accountId);\r\n\r\n    return {\r\n      accountId,\r\n      title,\r\n      byChain: getAccountChains(account),\r\n    };\r\n  } catch (err) {\r\n    return handleServerError(err);\r\n  }\r\n}\r\n\r\nexport async function importNewWalletVersion(\r\n  accountId: string,\r\n  version: ApiTonWalletVersion,\r\n  isTestnetSubwalletId?: boolean,\r\n): Promise<{\r\n  isNew: true;\r\n  accountId: string;\r\n  address: string;\r\n  ledger?: { index: number; driver: ApiLedgerDriver };\r\n} | {\r\n  isNew: false;\r\n  accountId: string;\r\n}> {\r\n  const { network } = parseAccountId(accountId);\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n  const newAccount: ApiAccountWithChain<'ton'> = {\r\n    ...account,\r\n    byChain: {\r\n      ton: ton.getOtherVersionWallet(network, account.byChain.ton, version, isTestnetSubwalletId),\r\n    },\r\n  };\r\n\r\n  const accounts = await fetchStoredAccounts();\r\n  const existingAccount = Object.entries(accounts).find(([, account]) => {\r\n    return account.byChain.ton?.address === newAccount.byChain.ton.address && account.type === newAccount.type;\r\n  });\r\n\r\n  if (existingAccount) {\r\n    return {\r\n      isNew: false,\r\n      accountId: existingAccount[0],\r\n    };\r\n  }\r\n\r\n  const ledger = account.type === 'ledger'\r\n    ? { index: account.byChain.ton.index, driver: account.driver }\r\n    : undefined;\r\n\r\n  const newAccountId = await addAccount(network, newAccount);\r\n\r\n  return {\r\n    isNew: true,\r\n    accountId: newAccountId,\r\n    address: newAccount.byChain.ton.address,\r\n    ledger,\r\n  };\r\n}\r\n","import * as tonWebMnemonic from 'tonweb-mnemonic';\r\nimport type { SignDataRpcResponseSuccess } from '@tonconnect/protocol';\r\n\r\nimport type { ApiDappRequestConfirmation } from '../tonConnect/types';\r\nimport type { ApiAccountWithMnemonic, ApiAnyDisplayError, ApiChain, ApiNetwork, ApiSignedTransfer } from '../types';\r\n\r\nimport chains from '../chains';\r\nimport * as ton from '../chains/ton';\r\nimport {\r\n  fetchStoredAccount,\r\n  fetchStoredAccounts,\r\n  fetchStoredAddress,\r\n  getAccountWithMnemonic,\r\n} from '../common/accounts';\r\nimport * as dappPromises from '../common/dappPromises';\r\nimport { getMnemonic } from '../common/mnemonic';\r\nimport { handleServerError } from '../errors';\r\n\r\nexport async function fetchPrivateKey(accountId: string, password: string) {\r\n  const account = await fetchStoredAccount<ApiAccountWithMnemonic>(accountId);\r\n  const privateKey = await ton.fetchPrivateKey(accountId, password, account);\r\n\r\n  return Buffer.from(privateKey!).toString('hex');\r\n}\r\n\r\nexport async function fetchMnemonic(accountId: string, password: string) {\r\n  const account = await fetchStoredAccount<ApiAccountWithMnemonic>(accountId);\r\n  return getMnemonic(accountId, password, account);\r\n}\r\n\r\nexport function getMnemonicWordList() {\r\n  return tonWebMnemonic.wordlists.default;\r\n}\r\n\r\nexport async function checkWorkerStorageIntegrity(): Promise<boolean> {\r\n  /*\r\n    This method is intended to check if the worker storage is corrupted due to known\r\n    behavior of browsers (at least Chromium-based ones).\r\n    Several users reported that their storage was corrupted on Android too.\r\n  */\r\n  try {\r\n    const accounts = await fetchStoredAccounts();\r\n    return !!accounts && typeof accounts === 'object' && Object.keys(accounts).length > 0;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function verifyPassword(password: string): Promise<boolean> {\r\n  try {\r\n    const [accountId, account] = (await getAccountWithMnemonic()) ?? [];\r\n    if (!accountId || !account) {\r\n      return false;\r\n    }\r\n\r\n    const mnemonic = await getMnemonic(accountId, password, account);\r\n    return Boolean(mnemonic);\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function confirmDappRequest(promiseId: string, password?: string) {\r\n  dappPromises.resolveDappPromise(promiseId, password);\r\n}\r\n\r\nexport function confirmDappRequestConnect(promiseId: string, data: ApiDappRequestConfirmation) {\r\n  dappPromises.resolveDappPromise(promiseId, data);\r\n}\r\n\r\nexport function confirmDappRequestSendTransaction(promiseId: string, data: ApiSignedTransfer[]) {\r\n  dappPromises.resolveDappPromise(promiseId, data);\r\n}\r\n\r\nexport function confirmDappRequestSignData(promiseId: string, signedData: SignDataRpcResponseSuccess['result']) {\r\n  dappPromises.resolveDappPromise(promiseId, signedData);\r\n}\r\n\r\nexport function cancelDappRequest(promiseId: string, reason?: string) {\r\n  dappPromises.rejectDappPromise(promiseId, reason);\r\n}\r\n\r\nexport function fetchAddress(accountId: string, chain: ApiChain) {\r\n  return fetchStoredAddress(accountId, chain);\r\n}\r\n\r\nexport async function getAddressInfo(network: ApiNetwork, toAddress: string): Promise<{\r\n  addressName?: string;\r\n  isScam?: boolean;\r\n  resolvedAddress?: string;\r\n  isToAddressNew?: boolean;\r\n  isBounceable?: boolean;\r\n  isMemoRequired?: boolean;\r\n} | { error: string }> {\r\n  try {\r\n    return await ton.checkToAddress(network, toAddress);\r\n  } catch (err: any) {\r\n    return handleServerError(err);\r\n  }\r\n}\r\n\r\n/**\r\n * Shows the wallet address on the Ledger screen.\r\n * Returns the address if the user accepts the verification.\r\n */\r\nexport function verifyLedgerWalletAddress(\r\n  accountId: string,\r\n  chain: ApiChain,\r\n): Promise<string | { error: ApiAnyDisplayError }> {\r\n  return chains[chain].verifyLedgerWalletAddress(accountId);\r\n}\r\n","import type { ApiNft, OnApiUpdate } from '../types';\r\nimport type { ApiSubmitNftTransferResult } from './types';\r\n\r\nimport { TONCOIN } from '../../config';\r\nimport { bigintDivideToNumber } from '../../util/bigint';\r\nimport { extractKey } from '../../util/iteratees';\r\nimport * as ton from '../chains/ton';\r\nimport { fetchStoredAccount, fetchStoredWallet } from '../common/accounts';\r\nimport { createLocalTransactions } from './transfer';\r\n\r\nlet onUpdate: OnApiUpdate;\r\n\r\nexport function initNfts(_onUpdate: OnApiUpdate) {\r\n  onUpdate = _onUpdate;\r\n}\r\n\r\nexport async function fetchNftsFromCollection(accountId: string, collectionAddress: string) {\r\n  const account = await fetchStoredAccount(accountId);\r\n  if (!account.byChain.ton) return;\r\n\r\n  const nfts = await ton.getAccountNfts(accountId, { collectionAddress });\r\n\r\n  onUpdate({ type: 'updateNfts', accountId, nfts, shouldAppend: true });\r\n}\r\n\r\nexport function checkNftTransferDraft(options: {\r\n  accountId: string;\r\n  nfts: ApiNft[];\r\n  toAddress: string;\r\n  comment?: string;\r\n}) {\r\n  return ton.checkNftTransferDraft(options);\r\n}\r\n\r\nexport async function submitNftTransfers(\r\n  accountId: string,\r\n  password: string | undefined,\r\n  nfts: ApiNft[],\r\n  toAddress: string,\r\n  comment?: string,\r\n  totalRealFee = 0n,\r\n): Promise<ApiSubmitNftTransferResult> {\r\n  const { address: fromAddress } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  const result = await ton.submitNftTransfers({\r\n    accountId, password, nfts, toAddress, comment,\r\n  });\r\n\r\n  if ('error' in result) {\r\n    return result;\r\n  }\r\n\r\n  const realFeePerNft = bigintDivideToNumber(totalRealFee, Object.keys(result.messages).length);\r\n\r\n  const localActivities = createLocalTransactions(accountId, 'ton', result.messages.map((message, index) => ({\r\n    id: result.msgHashNormalized,\r\n    amount: 0n, // Regular NFT transfers should have no amount in the activity list\r\n    fromAddress,\r\n    toAddress,\r\n    comment,\r\n    fee: realFeePerNft,\r\n    normalizedAddress: message.toAddress,\r\n    slug: TONCOIN.slug,\r\n    externalMsgHashNorm: result.msgHashNormalized,\r\n    nft: nfts?.[index],\r\n  })));\r\n\r\n  return {\r\n    ...result,\r\n    activityIds: extractKey(localActivities, 'id'),\r\n  };\r\n}\r\n\r\nexport async function checkNftOwnership(accountId: string, nftAddress: string) {\r\n  const account = await fetchStoredAccount(accountId);\r\n  return account.byChain.ton && ton.checkNftOwnership(accountId, nftAddress);\r\n}\r\n","import type { ApiNft } from '../types';\r\n\r\nimport { TONCOIN } from '../../config';\r\nimport { buildCollectionByKey, extractKey } from '../../util/iteratees';\r\nimport * as ton from '../chains/ton';\r\nimport { fetchStoredWallet } from '../common/accounts';\r\nimport { createLocalTransactions } from './transfer';\r\n\r\nexport function checkDnsRenewalDraft(accountId: string, nfts: ApiNft[]) {\r\n  const nftAddresses = extractKey(nfts, 'address');\r\n  return ton.checkDnsRenewalDraft(accountId, nftAddresses);\r\n}\r\n\r\nexport async function submitDnsRenewal(accountId: string, password: string | undefined, nfts: ApiNft[], realFee = 0n) {\r\n  const { address: fromAddress } = await fetchStoredWallet(accountId, 'ton');\r\n\r\n  const nftByAddress = buildCollectionByKey(nfts, 'address');\r\n  const results: ({ activityIds: string[] } | { error: string })[] = [];\r\n\r\n  for await (const { addresses, result } of ton.submitDnsRenewal(accountId, password, Object.keys(nftByAddress))) {\r\n    if ('error' in result) {\r\n      results.push(result);\r\n      continue;\r\n    }\r\n\r\n    const localActivities = createLocalTransactions(accountId, 'ton', addresses.map((address) => {\r\n      const nft = nftByAddress[address];\r\n      return {\r\n        id: result.msgHashNormalized,\r\n        amount: 0n,\r\n        fromAddress,\r\n        toAddress: nft.address,\r\n        fee: realFee / BigInt(nfts.length),\r\n        normalizedAddress: nft.address,\r\n        slug: TONCOIN.slug,\r\n        externalMsgHashNorm: result.msgHashNormalized,\r\n        nft,\r\n        type: 'dnsRenew',\r\n      };\r\n    }));\r\n\r\n    results.push({\r\n      activityIds: extractKey(localActivities, 'id'),\r\n    });\r\n  }\r\n\r\n  return results;\r\n}\r\n\r\nexport function checkDnsChangeWalletDraft(accountId: string, nft: ApiNft, address: string) {\r\n  return ton.checkDnsChangeWalletDraft(accountId, nft.address, address);\r\n}\r\n\r\nexport async function submitDnsChangeWallet(\r\n  accountId: string,\r\n  password: string | undefined,\r\n  nft: ApiNft,\r\n  address: string,\r\n  realFee = 0n,\r\n) {\r\n  const { address: walletAddress } = await fetchStoredWallet(accountId, 'ton');\r\n  const result = await ton.submitDnsChangeWallet(accountId, password, nft.address, address);\r\n\r\n  if ('error' in result) {\r\n    return result;\r\n  }\r\n\r\n  const [activity] = createLocalTransactions(accountId, 'ton', [{\r\n    id: result.msgHashNormalized,\r\n    amount: 0n,\r\n    fromAddress: walletAddress,\r\n    toAddress: nft.address,\r\n    fee: realFee,\r\n    normalizedAddress: nft.address,\r\n    slug: TONCOIN.slug,\r\n    externalMsgHashNorm: result.msgHashNormalized,\r\n    nft,\r\n    type: 'dnsChangeAddress',\r\n  }]);\r\n\r\n  return { activityId: activity.id };\r\n}\r\n","import { Cell } from '@ton/core';\r\nimport type { SignDataPayload, SignDataRpcResponseSuccess } from '@tonconnect/protocol';\r\n\r\nimport type { TonTransferParams } from '../chains/ton/types';\r\nimport type { ApiTonConnectProof } from '../tonConnect/types';\r\nimport type { ApiTransferToSign } from '../types';\r\n\r\nimport * as ton from '../chains/ton';\r\nimport { getSigner } from '../chains/ton/util/signer';\r\nimport { fetchStoredChainAccount } from '../common/accounts';\r\nimport { getTokenBySlug } from '../common/tokens';\r\n\r\nexport { startSseConnection } from '../tonConnect/sse';\r\n\r\nexport async function signTonProof(accountId: string, proof: ApiTonConnectProof, password?: string) {\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n  const signer = getSigner(accountId, account, password);\r\n  const signature = await signer.signTonProof(proof);\r\n  if ('error' in signature) return signature;\r\n\r\n  return { signature: signature.toString('base64') };\r\n}\r\n\r\nexport async function signTransfers(accountId: string, messages: ApiTransferToSign[], options: {\r\n  password?: string;\r\n  vestingAddress?: string;\r\n  /** Unix seconds */\r\n  validUntil?: number;\r\n} = {}) {\r\n  const { password, validUntil, vestingAddress } = options;\r\n\r\n  const preparedMessages = messages.map(({\r\n    toAddress,\r\n    amount,\r\n    stateInit: stateInitBase64,\r\n    rawPayload,\r\n    payload,\r\n  }): TonTransferParams => ({\r\n    toAddress,\r\n    amount,\r\n    payload: rawPayload ? Cell.fromBase64(rawPayload) : undefined,\r\n    stateInit: stateInitBase64 ? Cell.fromBase64(stateInitBase64) : undefined,\r\n    hints: {\r\n      tokenAddress: payload?.type === 'tokens:transfer'\r\n        ? getTokenBySlug(payload.slug)?.tokenAddress\r\n        : undefined,\r\n    },\r\n  }));\r\n\r\n  return ton.signTransfers(\r\n    accountId,\r\n    preparedMessages,\r\n    password,\r\n    validUntil,\r\n    vestingAddress,\r\n  );\r\n}\r\n\r\n/**\r\n * See https://docs.tonconsole.com/academy/sign-data for more details\r\n */\r\nexport async function signData(accountId: string, dappUrl: string, payloadToSign: SignDataPayload, password?: string) {\r\n  const timestamp = Math.floor(Date.now() / 1000);\r\n  const domain = new URL(dappUrl).host;\r\n\r\n  const account = await fetchStoredChainAccount(accountId, 'ton');\r\n  const signer = getSigner(accountId, account, password);\r\n  const signature = await signer.signData(timestamp, domain, payloadToSign);\r\n  if ('error' in signature) return signature;\r\n\r\n  const result: SignDataRpcResponseSuccess['result'] = {\r\n    signature: signature.toString('base64'),\r\n    address: account.byChain.ton.address,\r\n    timestamp,\r\n    domain,\r\n    payload: payloadToSign,\r\n  };\r\n  return result;\r\n}\r\n","import type { ApiBaseCurrency, ApiHistoryList, ApiPriceHistoryPeriod } from '../types';\r\n\r\nimport { DEFAULT_PRICE_CURRENCY, TONCOIN } from '../../config';\r\nimport { callBackendGet } from '../common/backend';\r\nimport { tokensPreload } from '../common/tokens';\r\nimport { getTokenBySlug } from './tokens';\r\n\r\nexport async function fetchPriceHistory(\r\n  slug: string,\r\n  period: ApiPriceHistoryPeriod,\r\n  baseCurrency: ApiBaseCurrency = DEFAULT_PRICE_CURRENCY,\r\n): Promise<ApiHistoryList | undefined> {\r\n  await tokensPreload.promise;\r\n  const token = getTokenBySlug(slug);\r\n\r\n  if (!token) {\r\n    return [];\r\n  }\r\n\r\n  const assetId = token.chain === TONCOIN.chain && token.tokenAddress ? token.tokenAddress : token.symbol;\r\n\r\n  return callBackendGet(`/prices/chart/${assetId}`, {\r\n    base: baseCurrency,\r\n    period,\r\n  });\r\n}\r\n","import type {\r\n  ApiSubscribeNotificationsProps, ApiSubscribeNotificationsResult, ApiUnsubscribeNotificationsProps,\r\n} from '../types';\r\n\r\nimport { logDebugError } from '../../util/logs';\r\nimport { callBackendPost } from '../common/backend';\r\nimport { handleServerError } from '../errors';\r\n\r\nexport async function subscribeNotifications(props: ApiSubscribeNotificationsProps) {\r\n  try {\r\n    return await callBackendPost<ApiSubscribeNotificationsResult>(\r\n      '/notifications/subscribe', props, { shouldRetry: true },\r\n    );\r\n  } catch (err) {\r\n    logDebugError('subscribeNotifications', err);\r\n    return handleServerError(err);\r\n  }\r\n}\r\n\r\nexport async function unsubscribeNotifications(props: ApiUnsubscribeNotificationsProps) {\r\n  try {\r\n    return await callBackendPost<{ ok: true }>(\r\n      '/notifications/unsubscribe', props, { shouldRetry: true },\r\n    );\r\n  } catch (err) {\r\n    logDebugError('unsubscribeNotifications', err);\r\n    return handleServerError(err);\r\n  }\r\n}\r\n","import type {\r\n  MethodArgs, Methods,\r\n} from '../../methods/types';\r\nimport type { TonConnectMethodArgs, TonConnectMethods } from '../../tonConnect/types/misc';\r\nimport type {\r\n  ApiInitArgs, OnApiUpdate,\r\n} from '../../types';\r\n\r\nimport { createPostMessageInterface } from '../../../util/createPostMessageInterface';\r\nimport * as methods from '../../methods';\r\nimport init from '../../methods/init';\r\nimport * as tonConnectApi from '../../tonConnect';\r\n\r\ncreatePostMessageInterface((name: string, origin?: string, ...args: any[]) => {\r\n  if (name === 'init') {\r\n    return init(args[0] as OnApiUpdate, args[1] as ApiInitArgs);\r\n  } else {\r\n    if (name.startsWith('tonConnect_')) {\r\n      name = name.replace('tonConnect_', '');\r\n      const method = tonConnectApi[name as keyof TonConnectMethods];\r\n      // @ts-ignore\r\n      return method(...args as TonConnectMethodArgs<keyof TonConnectMethods>);\r\n    }\r\n\r\n    const method = methods[name as keyof Methods];\r\n\r\n    // @ts-ignore\r\n    return method(...args as MethodArgs<keyof Methods>);\r\n  }\r\n});\r\n","import type { ApiTonWalletVersion } from './api/chains/ton/types';\r\nimport type {\r\n  ApiBaseCurrency,\r\n  ApiChain,\r\n  ApiCurrencyRates,\r\n  ApiLiquidStakingState,\r\n  ApiNftMarketplace,\r\n  ApiNominatorsStakingState,\r\n  ApiSwapAsset,\r\n  ApiSwapDexLabel,\r\n  ApiTokenWithPrice,\r\n} from './api/types';\r\nimport type { AutolockValueType, LangCode, LangItem, TokenPeriod } from './global/types';\r\n\r\nexport const APP_ENV = process.env.APP_ENV;\r\n\r\nexport const IS_CORE_WALLET = false; // core wallet disable\r\n\r\nexport const APP_NAME = 'Dps Wallet'; // single name constant\r\n\r\nexport const APP_VERSION = process.env.APP_VERSION!;\r\nexport const APP_COMMIT_HASH = process.env.APP_COMMIT_HASH!;\r\nexport const APP_ENV_MARKER = APP_ENV === 'staging' ? 'Beta' : APP_ENV === 'development' ? 'Dev' : undefined;\r\nexport const EXTENSION_NAME = IS_CORE_WALLET ? 'TON Wallet' : 'MyTonWallet  My Wallet';\r\nexport const EXTENSION_DESCRIPTION = IS_CORE_WALLET\r\n  ? 'Set up your own multiple Wallet account on The Open Network'\r\n  : // eslint-disable-next-line @stylistic/max-len\r\n    'The most feature-rich TON+TRON wallet: multi-accounts, multi-send, Telegram Gifts and other collectibles, TON DNS+Proxy, and more.';\r\n\r\nexport const DEBUG = APP_ENV !== 'production' && APP_ENV !== 'perf' && APP_ENV !== 'test';\r\nexport const DEBUG_MORE = false;\r\nexport const DEBUG_API = false;\r\nexport const DEBUG_VIEW_ACCOUNTS = false;\r\n\r\nexport const IS_PRODUCTION = APP_ENV === 'production';\r\nexport const IS_TEST = APP_ENV === 'test';\r\nexport const IS_PERF = APP_ENV === 'perf';\r\nexport const IS_EXTENSION = process.env.IS_EXTENSION === '1';\r\nexport const IS_FIREFOX_EXTENSION = process.env.IS_FIREFOX_EXTENSION === '1';\r\nexport const IS_OPERA_EXTENSION = process.env.IS_OPERA_EXTENSION === '1';\r\nexport const IS_PACKAGED_ELECTRON = process.env.IS_PACKAGED_ELECTRON === '1';\r\nexport const IS_CAPACITOR = process.env.IS_CAPACITOR === '1';\r\nexport const IS_ANDROID_DIRECT = process.env.IS_ANDROID_DIRECT === '1';\r\nexport const IS_AIR_APP = process.env.IS_AIR_APP === '1';\r\nexport const IS_TELEGRAM_APP = process.env.IS_TELEGRAM_APP === '1';\r\n\r\nexport const ELECTRON_HOST_URL = 'https://dumb-host';\r\nexport const INACTIVE_MARKER = '[Inactive]';\r\nexport const PRODUCTION_URL = 'https://walletdps.netlify.app';\r\nexport const BETA_URL = IS_CORE_WALLET ? 'https://beta.wallet.ton.org' : 'https://beta.mytonwallet.app';\r\nexport const APP_INSTALL_URL = 'https://walletdps.netlify.app';\r\nexport const APP_REPO_URL = 'https://github.com/mytonwallet-org';\r\nexport const BASE_URL = process.env.BASE_URL;\r\nexport const BOT_USERNAME = process.env.BOT_USERNAME || 'DPStoken_bot';\r\n\r\nexport const SWAP_FEE_ADDRESS = process.env.SWAP_FEE_ADDRESS || 'UQAJ3_21reITe-puJuEyRotn0PWlLDcbuTKF65JxhvjTBtuI'; // updated  wallet ID\r\nexport const DIESEL_ADDRESS = process.env.DIESEL_ADDRESS || 'UQAJ3_21reITe-puJuEyRotn0PWlLDcbuTKF65JxhvjTBtuI'; // updated wallet ID\r\n//export const DIESEL_ADDRESS = process.env.DIESEL_ADDRESS || 'UQC9lQOaEHC6YASiJJ2NrKEOlITMMQmc8j0_iZEHy-4sl3tG';\r\n\r\nexport const STRICTERDOM_ENABLED = DEBUG && !IS_PACKAGED_ELECTRON;\r\n\r\nexport const DEBUG_ALERT_MSG = 'Shoot!\\nSomething went wrong, please see the error details in Dev Tools Console.';\r\n\r\nexport const PIN_LENGTH = 4;\r\nexport const NATIVE_BIOMETRICS_USERNAME = IS_CORE_WALLET ? 'TonWallet' : 'MyTonWallet';\r\nexport const NATIVE_BIOMETRICS_SERVER = IS_CORE_WALLET ? 'https://wallet.ton.org' : 'https://mytonwallet.app';\r\n\r\nexport const IS_BIP39_MNEMONIC_ENABLED = !IS_CORE_WALLET;\r\nexport const MNEMONIC_COUNT = 24;\r\nexport const MNEMONIC_COUNTS = IS_BIP39_MNEMONIC_ENABLED ? [12, 24] : [24];\r\n\r\nexport const PRIVATE_KEY_HEX_LENGTH = 64;\r\nexport const MNEMONIC_CHECK_COUNT = 3;\r\n\r\nexport const MOBILE_SCREEN_MAX_WIDTH = 700; // px\r\n\r\nexport const VIEW_TRANSITION_CLASS_NAME = 'active-view-transition';\r\n\r\nexport const ANIMATION_END_DELAY = 50;\r\n\r\nexport const ANIMATED_STICKER_TINY_ICON_PX = 16;\r\nexport const ANIMATED_STICKER_ICON_PX = 30;\r\nexport const ANIMATED_STICKER_TINY_SIZE_PX = 70;\r\nexport const ANIMATED_STICKER_SMALL_SIZE_PX = 110;\r\nexport const ANIMATED_STICKER_MIDDLE_SIZE_PX = 120;\r\nexport const ANIMATED_STICKER_DEFAULT_PX = 150;\r\nexport const ANIMATED_STICKER_BIG_SIZE_PX = 156;\r\nexport const ANIMATED_STICKER_HUGE_SIZE_PX = 192;\r\n\r\nexport const DEFAULT_PORTRAIT_WINDOW_SIZE = { width: 368, height: 770 };\r\nexport const DEFAULT_LANDSCAPE_WINDOW_SIZE = { width: 980, height: 788 };\r\nexport const DEFAULT_LANDSCAPE_ACTION_TAB_ID = 0;\r\nexport const TRANSACTION_ADDRESS_SHIFT = 2;\r\n\r\nexport const WHOLE_PART_DELIMITER = ''; // https://www.compart.com/en/unicode/U+202F\r\n\r\nexport const DEFAULT_SLIPPAGE_VALUE = 1;\r\n\r\nexport const GLOBAL_STATE_CACHE_DISABLED = false;\r\nexport const GLOBAL_STATE_CACHE_KEY = IS_CORE_WALLET ? 'tonwallet-global-state' : 'mytonwallet-global-state';\r\n\r\nexport const ANIMATION_LEVEL_MIN = 0;\r\nexport const ANIMATION_LEVEL_MED = 1;\r\nexport const ANIMATION_LEVEL_MAX = 2;\r\nexport const ANIMATION_LEVEL_DEFAULT = ANIMATION_LEVEL_MAX;\r\nexport const THEME_DEFAULT = 'system';\r\n\r\nexport const MAIN_ACCOUNT_ID = '0-ton-mainnet';\r\n\r\nexport const TONCENTER_MAINNET_URL = process.env.TONCENTER_MAINNET_URL || 'https://toncenter.com';\r\nexport const TONCENTER_MAINNET_KEY = process.env.TONCENTER_MAINNET_KEY;\r\nexport const ELECTRON_TONCENTER_MAINNET_KEY = process.env.ELECTRON_TONCENTER_MAINNET_KEY;\r\nexport const TONAPIIO_MAINNET_URL = process.env.TONAPIIO_MAINNET_URL || 'https://tonapi.io';\r\n\r\nexport const TONCENTER_TESTNET_URL = process.env.TONCENTER_TESTNET_URL || 'https://testnet.toncenter.com';\r\nexport const TONCENTER_TESTNET_KEY = process.env.TONCENTER_TESTNET_KEY;\r\nexport const ELECTRON_TONCENTER_TESTNET_KEY = process.env.ELECTRON_TONCENTER_TESTNET_KEY;\r\nexport const TONAPIIO_TESTNET_URL = process.env.TONAPIIO_TESTNET_URL || 'https://testnet.tonapi.io';\r\n\r\nexport const BRILLIANT_API_BASE_URL =process.env.BRILLIANT_API_BASE_URL || 'https://walletdps.netlify.app/.netlify/functions/proxy';\r\n\r\nexport const PROXY_API_BASE_URL = process.env.PROXY_API_BASE_URL || 'https://walletdps.netlify.app';\r\n\r\nexport const IPFS_GATEWAY_BASE_URL = 'https://ipfs.io/ipfs/';\r\n\r\nexport const SSE_BRIDGE_URL = 'https://tonconnectbridge.mytonwallet.org/bridge/';\r\n\r\nexport const TRON_MAINNET_API_URL = process.env.TRON_MAINNET_API_URL || 'https://api.trongrid.io';\r\n\r\nexport const TRON_TESTNET_API_URL = process.env.TRON_TESTNET_API_URL || 'https://api.shasta.trongrid.io';\r\n\r\nexport const FRACTION_DIGITS = 9;\r\nexport const SHORT_FRACTION_DIGITS = 4;\r\n\r\nexport const MAX_PUSH_NOTIFICATIONS_ACCOUNT_COUNT = 3;\r\n\r\nexport const SUPPORT_USERNAME = 'Zyflex';\r\nexport const MTW_TIPS_CHANNEL_NAME: Partial<Record<LangCode, string>> = {\r\n  en: 'dps_wallets',\r\n  ru: '@dps_wallets',\r\n};\r\nexport const NFT_MARKETPLACE_TITLES: Record<ApiNftMarketplace, string> = {\r\n  getgems: 'Getgems',\r\n  fragment: 'Fragment',\r\n};\r\nexport const MTW_STATIC_BASE_URL = 'https://static.mytonwallet.org';\r\nexport const MTW_CARDS_BASE_URL = `${MTW_STATIC_BASE_URL}/cards/`;\r\nexport const MTW_CARDS_MINT_BASE_URL = `${MTW_STATIC_BASE_URL}/mint-cards/`;\r\n\r\nexport const MYTONWALLET_PROMO_URL = 'https://dpsmult.netlify.app';\r\n\r\nexport const MYTONWALLET_MULTISEND_DAPP_URL = 'https://dpsmult.netlify.app';\r\n\r\nexport const MYTONWALLET_BLOG: Partial<Record<LangCode, string>> = {\r\n  en: 'https://mytonwallet.io/en/blog/',\r\n  ru: 'https://mytonwallet.io/ru/blog/',\r\n};\r\nexport const MYTONWALLET_TERMS_OF_USE_URL = 'https://mytonwallet.io/terms-of-use';\r\nexport const MYTONWALLET_PRIVACY_POLICY_URL = 'https://mytonwallet.io/privacy-policy';\r\nexport const TELEGRAM_WEB_URL = 'https://web.telegram.org/a/';\r\nexport const NFT_MARKETPLACE_URL = 'https://getgems.io/nft/EQDCUj2OLyLazbeh648aO2Sj5yQGS0_VsxDFOdoGfoQCBN63';\r\nexport const NFT_MARKETPLACE_TITLE = NFT_MARKETPLACE_TITLES.getgems;\r\nexport const GETGEMS_BASE_MAINNET_URL = 'https://getgems.io/';\r\nexport const GETGEMS_BASE_TESTNET_URL = 'https://testnet.getgems.io/';\r\nexport const EMPTY_HASH_VALUE = 'NOHASH';\r\n\r\nexport const IFRAME_WHITELIST = ['http://localhost:*', 'https://tonscan.org'];\r\nexport const SUBPROJECT_URL_MASK = 'https://*.netlify.app';\r\n\r\nexport const CHANGELLY_SUPPORT_EMAIL = 'zyflexhub@gmail.com';\r\nexport const CHANGELLY_LIVE_CHAT_URL = 'https://changelly.com/';\r\nexport const CHANGELLY_SECURITY_EMAIL = 'security@changelly.com';\r\nexport const CHANGELLY_TERMS_OF_USE = 'https://changelly.com/terms-of-use';\r\nexport const CHANGELLY_PRIVACY_POLICY = 'https://changelly.com/privacy-policy';\r\nexport const CHANGELLY_AML_KYC = 'https://changelly.com/aml-kyc';\r\nexport const CHANGELLY_WAITING_DEADLINE = 3 * 60 * 60 * 1000; // 3 hours\r\n\r\nexport const PROXY_HOSTS = process.env.PROXY_HOSTS;\r\n\r\nexport const TINY_TRANSFER_MAX_COST = 0.01;\r\n\r\nexport const IMAGE_CACHE_NAME = 'mtw-image';\r\nexport const LANG_CACHE_NAME = 'mtw-lang-240';\r\n\r\nexport const LANG_LIST: LangItem[] = [\r\n  {\r\n    langCode: 'en',\r\n    name: 'English',\r\n    nativeName: 'English',\r\n    rtl: false,\r\n  },\r\n  {\r\n    langCode: 'es',\r\n    name: 'Spanish',\r\n    nativeName: 'Espaol',\r\n    rtl: false,\r\n  },\r\n  {\r\n    langCode: 'ru',\r\n    name: 'Russian',\r\n    nativeName: '',\r\n    rtl: false,\r\n  },\r\n  {\r\n    langCode: 'zh-Hans',\r\n    name: 'Chinese (Simplified)',\r\n    nativeName: '',\r\n    rtl: false,\r\n  },\r\n  {\r\n    langCode: 'zh-Hant',\r\n    name: 'Chinese (Traditional)',\r\n    nativeName: '',\r\n    rtl: false,\r\n  },\r\n  {\r\n    langCode: 'tr',\r\n    name: 'Turkish',\r\n    nativeName: 'Trke',\r\n    rtl: false,\r\n  },\r\n  {\r\n    langCode: 'de',\r\n    name: 'German',\r\n    nativeName: 'Deutsch',\r\n    rtl: false,\r\n  },\r\n  {\r\n    langCode: 'th',\r\n    name: 'Thai',\r\n    nativeName: '',\r\n    rtl: false,\r\n  },\r\n  {\r\n    langCode: 'uk',\r\n    name: 'Ukrainian',\r\n    nativeName: '',\r\n    rtl: false,\r\n  },\r\n  {\r\n    langCode: 'pl',\r\n    name: 'Polish',\r\n    nativeName: 'Polski',\r\n    rtl: false,\r\n  },\r\n];\r\n\r\n//export const IS_STAKING_DISABLED = IS_CORE_WALLET;\r\nexport const IS_STAKING_DISABLED = false;\r\n\r\n\r\nexport const VALIDATION_PERIOD_MS = 65_536_000; // 18.2 h.\r\nexport const ONE_TON = 1_000_000_000n;\r\nexport const DEFAULT_FEE = 15_000_000n; // 0.015 TON\r\nexport const UNSTAKE_TON_GRACE_PERIOD = 20 * 60 * 1000; // 20 m.\r\n\r\nexport const STAKING_POOLS = process.env.STAKING_POOLS ? process.env.STAKING_POOLS.split(' ') : [];\r\nexport const LIQUID_POOL = process.env.LIQUID_POOL || 'EQB4ugVrUUV7ySLfQFgvohiMHKE3i5ma_U6CixUd3aAk3U1A';  //  updated wallet ID\r\nexport const LIQUID_JETTON = process.env.LIQUID_JETTON || 'EQCqC6EhRJ_tpWngKxL6dV0k6DSnRUrs9GSVkLbfdCqsj6TE';\r\nexport const STAKING_MIN_AMOUNT = ONE_TON;\r\nexport const NOMINATORS_STAKING_MIN_AMOUNT = 10_000n * ONE_TON;\r\nexport const MIN_ACTIVE_STAKING_REWARDS = 100_000_000n; // 0.1 MYCOIN\r\n\r\nexport const TONCONNECT_PROTOCOL_VERSION = 2;\r\nexport const TONCONNECT_WALLET_JSBRIDGE_KEY = IS_CORE_WALLET ? 'tonwallet' : 'mytonwallet';\r\nexport const EMBEDDED_DAPP_BRIDGE_CHANNEL = 'embedded-dapp-bridge';\r\n\r\nexport const NFT_FRAGMENT_COLLECTIONS = [\r\n  '0:0e41dc1dc3c9067ed24248580e12b3359818d83dee0304fabcf80845eafafdb2', // Anonymous Telegram Numbers\r\n  '0:80d78a35f955a14b679faa887ff4cd5bfc0f43b4a4eea2a7e6927f3701b273c2', // Telegram Usernames\r\n];\r\nexport const NFT_FRAGMENT_GIFT_IMAGE_TO_URL_REGEX = /^https?:\\/\\/nft\\.(fragment\\.com\\/gift\\/[\\w-]+-\\d+)\\.\\w+$/i;\r\nexport const TELEGRAM_GIFTS_SUPER_COLLECTION = 'super:telegram-gifts';\r\n\r\nexport const MTW_CARDS_WEBSITE = 'https://cards.mytonwallet.io';\r\nexport const MTW_CARDS_COLLECTION = 'EQCQE2L9hfwx1V8sgmF9keraHx1rNK9VmgR1ctVvINBGykyM';\r\nexport const TON_DNS_COLLECTION = 'EQC3dNlesgVD8YbAazcauIrXBPfiVhMMr5YYk2in0Mtsz0Bz';\r\nexport const TON_DNS_RENEWAL_WARNING_DAYS = 14;\r\nexport const TON_DNS_RENEWAL_NFT_WARNING_DAYS = 30;\r\n\r\nexport const TONCOIN = {\r\n  name: 'Toncoin',\r\n  symbol: 'TON',\r\n  slug: 'toncoin',\r\n  decimals: 9,\r\n  chain: 'ton',\r\n  cmcSlug: 'toncoin',\r\n} as const;\r\n\r\nexport const TRX = {\r\n  name: 'TRON',\r\n  symbol: 'TRX',\r\n  slug: 'trx',\r\n  decimals: 6,\r\n  chain: 'tron',\r\n  cmcSlug: 'tron',\r\n} as const;\r\n\r\nexport const MYCOIN = {\r\n  name: 'MyTonWallet Coin',\r\n  symbol: 'MY',\r\n  slug: 'ton-eqcfvnlrbn',\r\n  decimals: 9,\r\n  chain: 'ton',\r\n  minterAddress: 'EQCFVNlRb-NHHDQfv3Q9xvDXBLJlay855_xREsq5ZDX6KN-w',\r\n} as const;\r\n\r\nexport const MYCOIN_TESTNET = {\r\n  ...MYCOIN,\r\n  slug: 'ton-kqawlxpebw',\r\n  minterAddress: 'kQAWlxpEbwhCDFX9gp824ee2xVBhAh5VRSGWfbNFDddAbQoQ',\r\n} as const;\r\n\r\nexport const TOKEN_FONT_ICONS = {\r\n  [TONCOIN.slug]: 'icon-chain-ton',\r\n  [TRX.slug]: 'icon-chain-tron',\r\n};\r\n\r\nexport const TRC20_USDT_MAINNET_SLUG = 'tron-tr7nhqjekq';\r\nexport const TRC20_USDT_TESTNET_SLUG = 'tron-tg3xxyexbk';\r\nexport const TON_USDT_MAINNET_SLUG = 'ton-eqcxe6mutq';\r\nexport const TON_USDT_TESTNET_SLUG = 'ton-kqd0gkbm8z'; // Where to get this token: https://t.me/testgiver_ton_usdt_bot\r\nexport const STAKED_TON_SLUG = 'ton-eqcqc6ehrj';\r\nexport const STAKED_MYCOIN_SLUG = 'ton-eqcbzvsfwq';\r\nexport const TRX_SWAP_COUNT_FEE_ADDRESS = 'TGfgtSZJjXaYpCfGtB4Khuii1HR9bHP56M';\r\nexport const MYCOIN_STAKING_POOL = 'EQC3roTiRRsoLzfYVK7yVVoIZjTEqAjQU3ju7aQ7HWTVL5o5';\r\n\r\nexport const ETHENA_STAKING_VAULT = 'EQChGuD1u0e7KUWHH5FaYh_ygcLXhsdG2nSHPXHW8qqnpZXW';\r\nexport const ETHENA_STAKING_MIN_AMOUNT = 1_000_000; // 1 USDe\r\n// eslint-disable-next-line @stylistic/max-len\r\nexport const ETHENA_ELIGIBILITY_CHECK_URL = 'https://t.me/DPSwallet_bot/?startapp';\r\n\r\n// In cross-chain swaps, only a few TON/TRON tokens are available.\r\n// Its not optimal to request swap history for all the others.\r\nexport const SWAP_CROSSCHAIN_SLUGS = new Set([TONCOIN.slug, TON_USDT_MAINNET_SLUG, TRX.slug, TRC20_USDT_MAINNET_SLUG]);\r\n\r\nexport const STON_PTON_ADDRESS = 'EQCM3B12QK1e4yZSf8GtBRT0aLMNyEsBc_DhVfRRtOEffLez';\r\nexport const STON_PTON_SLUG = 'ton-eqcm3b12qk';\r\n\r\nexport const DNS_IMAGE_GEN_URL = 'https://dns-image.mytonwallet.org/img?d=';\r\n\r\nconst TRC20_USDT = {\r\n  name: 'Tether USD',\r\n  symbol: 'USDT',\r\n  decimals: 6,\r\n  chain: 'tron',\r\n} as const;\r\n\r\nexport const TON_USDT = {\r\n  name: 'Tether USD',\r\n  symbol: 'USD',\r\n  chain: 'ton',\r\n  slug: TON_USDT_MAINNET_SLUG,\r\n  decimals: 6,\r\n  tokenAddress: 'EQCxE6mUtQJKFnGfaROTKOt1lZbDiiX1kCixRv7Nw2Id_sDs',\r\n} as const;\r\n\r\nexport const TON_USDE = {\r\n  name: 'Ethena USDe',\r\n  symbol: 'USDe',\r\n  chain: 'ton',\r\n  tokenAddress: 'EQAIb6KmdfdDR7CN1GBqVJuP25iCnLKCvBlJ07Evuu2dzP5f',\r\n  slug: 'ton-eqaib6kmdf',\r\n  decimals: 6,\r\n  // eslint-disable-next-line @stylistic/max-len\r\n  image:\r\n    'https://imgproxy.toncenter.com/binMwUmcnFtjvgjp4wSEbsECXwfXUwbPkhVvsvpubNw/pr:small/aHR0cHM6Ly9tZXRhZGF0YS5sYXllcnplcm8tYXBpLmNvbS9hc3NldHMvVVNEZS5wbmc',\r\n} as const;\r\n\r\nexport const TON_TSUSDE = {\r\n  name: 'Ethena tsUSDe',\r\n  symbol: 'tsUSDe',\r\n  chain: 'ton',\r\n  tokenAddress: 'EQDQ5UUyPHrLcQJlPAczd_fjxn8SLrlNQwolBznxCdSlfQwr',\r\n  slug: 'ton-eqdq5uuyph',\r\n  decimals: 6,\r\n  // eslint-disable-next-line @stylistic/max-len\r\n  image:\r\n    'https://cache.tonapi.io/imgproxy/vGZJ7erwsWPo7DpVG_V7ygNn7VGs0szZXcNLHB_l0ms/rs:fill:200:200:1/g:no/aHR0cHM6Ly9tZXRhZGF0YS5sYXllcnplcm8tYXBpLmNvbS9hc3NldHMvdHNVU0RlLnBuZw.webp',\r\n} as const;\r\n\r\nexport const ALL_STAKING_POOLS = [LIQUID_POOL, MYCOIN_STAKING_POOL, ETHENA_STAKING_VAULT, TON_TSUSDE.tokenAddress];\r\n\r\nexport const DEFAULT_ENABLED_TOKEN_SLUGS = {\r\n  mainnet: [TONCOIN.slug, TON_USDT_MAINNET_SLUG, TRX.slug, TRC20_USDT_MAINNET_SLUG],\r\n  testnet: [TONCOIN.slug, TON_USDT_TESTNET_SLUG, TRX.slug, TRC20_USDT_TESTNET_SLUG],\r\n};\r\n\r\n// Toncoin, USDT TON, TRX, USDT TRC20\r\nexport const DEFAULT_ENABLED_TOKEN_COUNT = DEFAULT_ENABLED_TOKEN_SLUGS.mainnet.length;\r\n\r\nexport const PRIORITY_TOKEN_SLUGS = [TONCOIN.slug, TON_USDT_MAINNET_SLUG, TRX.slug] as string[];\r\n\r\nconst COMMON_TOKEN = {\r\n  isFromBackend: true,\r\n  priceUsd: 0,\r\n  percentChange24h: 0,\r\n};\r\n\r\nexport const TOKEN_INFO: Record<string, ApiTokenWithPrice> = {\r\n  toncoin: {\r\n    ...TONCOIN,\r\n    isFromBackend: true,\r\n    priceUsd: 5.8,\r\n    percentChange24h: 0,\r\n  },\r\n  trx: {\r\n    ...TRX,\r\n    ...COMMON_TOKEN,\r\n  },\r\n  [TRC20_USDT_MAINNET_SLUG]: {\r\n    // mainnet\r\n    ...TRC20_USDT,\r\n    slug: TRC20_USDT_MAINNET_SLUG,\r\n    tokenAddress: 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t',\r\n    ...COMMON_TOKEN,\r\n  },\r\n  [TRC20_USDT_TESTNET_SLUG]: {\r\n    // testnet\r\n    ...TRC20_USDT,\r\n    slug: TRC20_USDT_TESTNET_SLUG,\r\n    tokenAddress: 'TG3XXyExBkPp9nzdajDZsozEu4BkaSJozs',\r\n    ...COMMON_TOKEN,\r\n  },\r\n  [TON_USDT_MAINNET_SLUG]: {\r\n    ...TON_USDT,\r\n    // eslint-disable-next-line @stylistic/max-len\r\n    image:\r\n      'https://cache.tonapi.io/imgproxy/T3PB4s7oprNVaJkwqbGg54nexKE0zzKhcrPv8jcWYzU/rs:fill:200:200:1/g:no/aHR0cHM6Ly90ZXRoZXIudG8vaW1hZ2VzL2xvZ29DaXJjbGUucG5n.webp',\r\n    slug: TON_USDT_MAINNET_SLUG,\r\n    ...COMMON_TOKEN,\r\n  },\r\n  [MYCOIN.slug]: {\r\n    ...MYCOIN,\r\n    // eslint-disable-next-line @stylistic/max-len\r\n    image:\r\n      'https://cache.tonapi.io/imgproxy/Qy038wCBKISofJ0hYMlj6COWma330cx3Ju1ZSPM2LRU/rs:fill:200:200:1/g:no/aHR0cHM6Ly9teXRvbndhbGxldC5pby9sb2dvLTI1Ni1ibHVlLnBuZw.webp',\r\n    ...COMMON_TOKEN,\r\n  },\r\n  [TON_USDE.slug]: {\r\n    ...TON_USDE,\r\n    ...COMMON_TOKEN,\r\n  },\r\n  [TON_TSUSDE.slug]: {\r\n    ...TON_TSUSDE,\r\n    ...COMMON_TOKEN,\r\n  },\r\n};\r\n\r\nexport const TOKEN_WITH_LABEL: Record<string, string> = {\r\n  [TRC20_USDT_MAINNET_SLUG]: 'TRC-20',\r\n  [TRC20_USDT_TESTNET_SLUG]: 'TRC-20',\r\n  [TON_USDT_MAINNET_SLUG]: 'TON',\r\n};\r\n\r\nexport const INIT_SWAP_ASSETS: Record<string, ApiSwapAsset> = {\r\n  toncoin: {\r\n    name: 'Toncoin',\r\n    symbol: TONCOIN.symbol,\r\n    chain: TONCOIN.chain,\r\n    slug: TONCOIN.slug,\r\n    decimals: TONCOIN.decimals,\r\n    priceUsd: 0,\r\n    isPopular: true,\r\n  },\r\n  [TON_USDT_MAINNET_SLUG]: {\r\n    name: 'Tether USD',\r\n    symbol: 'USD',\r\n    chain: 'ton',\r\n    slug: TON_USDT_MAINNET_SLUG,\r\n    decimals: 9,\r\n    // eslint-disable-next-line @stylistic/max-len\r\n    image:\r\n      'https://cache.tonapi.io/imgproxy/T3PB4s7oprNVaJkwqbGg54nexKE0zzKhcrPv8jcWYzU/rs:fill:200:200:1/g:no/aHR0cHM6Ly90ZXRoZXIudG8vaW1hZ2VzL2xvZ29DaXJjbGUucG5n.webp',\r\n    tokenAddress: 'EQCxE6mUtQJKFnGfaROTKOt1lZbDiiX1kCixRv7Nw2Id_sDs',\r\n    priceUsd: 0,\r\n    isPopular: true,\r\n  },\r\n};\r\n\r\nexport const DEFAULT_TRX_SWAP_FIRST_TOKEN_SLUG = TONCOIN.slug;\r\nexport const DEFAULT_SWAP_FIRST_TOKEN_SLUG = TONCOIN.slug;\r\nexport const DEFAULT_SWAP_SECOND_TOKEN_SLUG = TON_USDT_MAINNET_SLUG;\r\nexport const DEFAULT_TRANSFER_TOKEN_SLUG = TONCOIN.slug;\r\nexport const DEFAULT_CEX_SWAP_SECOND_TOKEN_SLUG = TRC20_USDT_MAINNET_SLUG;\r\nexport const SWAP_DEX_LABELS: Record<ApiSwapDexLabel, string> = {\r\n  dedust: 'DeDust',\r\n  ston: 'STON.fi',\r\n};\r\n\r\nexport const MULTITAB_DATA_CHANNEL_NAME = IS_CORE_WALLET ? 'tw-multitab' : 'mtw-multitab';\r\nexport const ACTIVE_TAB_STORAGE_KEY = IS_CORE_WALLET ? 'tw-active-tab' : 'mtw-active-tab';\r\n\r\nexport const INDEXED_DB_NAME = 'keyval-store';\r\nexport const INDEXED_DB_STORE_NAME = 'keyval';\r\n\r\nexport const WINDOW_PROVIDER_CHANNEL = 'windowProvider';\r\nexport const WINDOW_PROVIDER_PORT = `${IS_CORE_WALLET ? 'TonWallet' : 'MyTonWallet'}_popup_reversed`;\r\n\r\nexport const SHOULD_SHOW_ALL_ASSETS_AND_ACTIVITY = IS_CORE_WALLET;\r\nexport const PORTRAIT_MIN_ASSETS_TAB_VIEW = 4;\r\nexport const LANDSCAPE_MIN_ASSETS_TAB_VIEW = 6;\r\n\r\nexport const DEFAULT_PRICE_CURRENCY = 'USD';\r\nexport const CURRENCIES: Record<ApiBaseCurrency, { name: string; decimals: number; shortSymbol?: string }> = {\r\n  USD: { name: 'US Dollar', decimals: 2, shortSymbol: '$' },\r\n  EUR: { name: 'Euro', decimals: 2, shortSymbol: '' },\r\n  RUB: { name: 'Russian Ruble', decimals: 2, shortSymbol: '' },\r\n  CNY: { name: 'Chinese Yuan', decimals: 2, shortSymbol: '' },\r\n  BTC: { name: 'Bitcoin', decimals: 9 },\r\n  [TONCOIN.symbol]: { name: 'Toncoin', decimals: 9 },\r\n};\r\n\r\nexport const BURN_ADDRESS = 'UQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJKZ';\r\n\r\nexport const DEFAULT_WALLET_VERSION: ApiTonWalletVersion = 'W5';\r\nexport const POPULAR_WALLET_VERSIONS: readonly ApiTonWalletVersion[] = ['v3R1', 'v3R2', 'v4R2', 'W5'];\r\n\r\nexport const DEFAULT_TIMEOUT = 10000;\r\nexport const DEFAULT_RETRIES = 3;\r\nexport const DEFAULT_ERROR_PAUSE = 500;\r\n\r\nexport const HISTORY_PERIODS: TokenPeriod[] = ['1D', '7D', '1M', '3M', '1Y', 'ALL'];\r\n\r\nexport const BROWSER_HISTORY_LIMIT = 10;\r\n\r\nexport const NFT_BATCH_SIZE = 4;\r\nexport const NOTCOIN_VOUCHERS_ADDRESS = 'EQDmkj65Ab_m0aZaW8IpKw4kYqIgITw_HRstYEkVQ6NIYCyW';\r\nexport const BURN_CHUNK_DURATION_APPROX_SEC = 30;\r\nexport const NOTCOIN_FORWARD_TON_AMOUNT = 30000000n; // 0.03 TON\r\nexport const NOTCOIN_EXCHANGERS = [\r\n  'EQAPZauWVPUcm2hUJT9n36pxznEhl46rEn1bzBXN0RY_yiy2',\r\n  'EQASgm0Qv3h2H2mF0W06ikPqYq2ctT3dyXMJH_svbEKKB3iZ',\r\n  'EQArlmP-RhVIG2yAFGZyPZfM3m0YccxmpvoRi6sgRzWnAA0s',\r\n  'EQA6pL-spYqZp1Ck6o3rpY45Cl-bvLMW_j3qdVejOkUWpLnm',\r\n  'EQBJ_ehYjumQKbXfWUue1KHKXdTm1GuYJB0Fj2ST_DwORvpd',\r\n  'EQBRmYSjxh9xlZpUqEmGjF5UjukI9v_Cm2kCTu4CoBn3XkOD',\r\n  'EQBkiqncd7AFT5_23H-RoA2Vynk-Nzq_dLoeMVRthAU9RF0p',\r\n  'EQB_OzTHXbztABe0QHgr4PtAV8T64LR6aDunXgaAoihOdxwO',\r\n  'EQCL-x5kLg6tKVNGryItTuj6tG3FH5mhUEu0xRqQc-kbEmbe',\r\n  'EQCZh2yJ46RaQH3AYmjEA8SMMXi77Oein4-3lvqkHseIAhD-',\r\n  'EQChKo5IK3iNqUHUGDB9gtzjCjMTPtmsFqekuCA2MdreVEyu',\r\n  'EQC6DNCBv076TIliRMfOt20RpbS7rNKDfSky3WrFEapFt8AH',\r\n  'EQDE_XFZOYae_rl3ZMsgBCtRSmYhl8B4y2BZEP7oiGBDhlgy',\r\n  'EQDddqpGA2ePXQF47A2DSL3GF6ZzIVmimfM2d16cdymy2noT',\r\n  'EQDv0hNNAamhYltCh3pTJrq3oRB9RW2ZhEYkTP6fhj5BtZNu',\r\n  'EQD2mP7zgO7-imUJhqYry3i07aJ_SR53DaokMupfAAobt0Xw',\r\n] as const;\r\n\r\nexport const CLAIM_ADDRESS = 'EQB3zOTvPi1PmwdcTpqSfFKZnhi1GNKEVJM-LdoAirdLtash';\r\nexport const CLAIM_AMOUNT = 30000000n; // 0.03 TON\r\nexport const CLAIM_COMMENT = 'claim';\r\n\r\nexport const MINT_CARD_ADDRESS = 'EQBpst3ZWJ9Dqq5gE2YH-yPsFK_BqMOmgi7Z_qK6v7WbrPWv';\r\nexport const MINT_CARD_COMMENT = 'Mint card';\r\nexport const MINT_CARD_REFUND_COMMENT = 'Refund';\r\n\r\n// eslint-disable-next-line @stylistic/max-len\r\nexport const RE_LINK_TEMPLATE =\r\n  /((ftp|https?):\\/\\/)?(?<host>(www\\\\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\\.[a-zA-Z][-a-zA-Z0-9]{1,62})\\b([-a-zA-Z0-9()@:%_+.,~#?&/=]*)/g;\r\n// eslint-disable-next-line @stylistic/max-len\r\nexport const RE_TG_BOT_MENTION =\r\n  /telegram[:\\s-]*((@[a-z0-9_]+)|(https:\\/\\/)?(t\\.me|telegram\\.me|telegram\\.dog)\\/[a-z0-9_]+)/gim;\r\n\r\nexport const STARS_SYMBOL = '';\r\n\r\nexport const GIVEAWAY_CHECKIN_URL = process.env.GIVEAWAY_CHECKIN_URL || 'https://giveaway.mytonwallet.io';\r\n\r\nexport const AUTOLOCK_OPTIONS_LIST = [\r\n  {\r\n    value: 'never',\r\n    name: 'Disabled',\r\n    selectedName: 'Disabled',\r\n    period: 0,\r\n  },\r\n  {\r\n    value: '1',\r\n    name: '30 seconds',\r\n    selectedName: 'If away for 30 sec',\r\n    period: 30_000,\r\n  },\r\n  {\r\n    value: '2',\r\n    name: '3 minutes',\r\n    selectedName: 'If away for 3 min',\r\n    period: 60_000 * 3,\r\n  },\r\n  {\r\n    value: '3',\r\n    name: '10 minutes',\r\n    selectedName: 'If away for 10 min',\r\n    period: 60_000 * 10,\r\n  },\r\n] as const;\r\n\r\nexport const AUTO_CONFIRM_DURATION_MINUTES = 5;\r\n\r\nexport const PRICELESS_TOKEN_HASHES = new Set([\r\n  '173e31eee054cb0c76f77edc7956bed766bf48a1f63bd062d87040dcd3df700f', // FIVA SY tsTON EQAxGi9Al7hamLAORroxGkvfap6knGyzI50ThkP3CLPLTtOZ\r\n  '5226dd4e6db9af26b24d5ca822bc4053b7e08152f923932abf25030c7e38bb42', // FIVA PT tsTON EQAkxIRGXgs2vD2zjt334MBjD3mXg2GsyEZHfzuYX_trQkFL\r\n  'fea2c08a704e5192b7f37434927170440d445b87aab865c3ea2a68abe7168204', // FIVA YT tsTON EQAcy60qg22RCq87A_qgYK8hooEgjCZ44yxhdnKYdlWIfKXL\r\n  'e691cf9081a8aeb22ed4d94829f6626c9d822752e035800b5543c43f83d134b5', // FIVA LP tsTON EQD3BjCjxuf8mu5kvxajVbe-Ila1ScZZlAi03oS7lMmAJjM3\r\n  '301ce25925830d713b326824e552e962925c4ff45b1e3ea21fc363a459a49b43', // FIVA SY eUSDT EQDi9blCcyT-k8iMpFMYY0t7mHVyiCB50ZsRgyUECJDuGvIl\r\n  '02250f83fbb8624d859c2c045ac70ee2b3b959688c3d843aec773be9b36dbfc3', // FIVA PT eUSDT EQBzVrYkYPHx8D_HPfQacm1xONa4XSRxl826vHkx_laP2HOe\r\n  'dba3adb2c917db80fd71a6a68c1fc9e12976491a8309d5910f9722efc084ce4d', // FIVA YT eUSDT EQCwUSc2qrY5rn9BfFBG9ARAHePTUvITDl97UD0zOreWzLru\r\n  '7da9223b90984d6a144e71611a8d7c65a6298cad734faed79438dc0f7a8e53d1', // FIVA LP eUSDT EQBNlIZxIbQGQ78cXgG3VRcyl8A0kLn_6BM9kabiHHhWC4qY\r\n  'ddf80de336d580ab3c11d194f189c362e2ca1225cae224ea921deeaba7eca818', // tsUSDe EQDQ5UUyPHrLcQJlPAczd_fjxn8SLrlNQwolBznxCdSlfQwr\r\n  'eb9d9891a32ec94425c09735f6ade73f4c171da0091f874d6e9d25247d583990', // Affluent TON Lending Vault EQADQ6JcK0NMuNM5uwCcS9bjcn2RTvcxYIZjNlhIhywUrfBN\r\n  'f66c149de251ffd031bdb34b79abe43a062ba16b815433691e3ec40a77f01d71', // Affluent Ethena Multiply Vault EQDXmtbt1-WSP00tSh6N6FH-4lX7LbnrjORClmtmuZqg4Ymm\r\n  'bca42dbdcbc0d885aaffb1eeeb027d9f338c2dd68701a05641c1d1c3171a7400', // Affluent TON Multiply Vault EQDtxQqkgIRQQR5hWlrQxiJMtLwjR3rEYNUBbEcvPDwCs1Ng\r\n]);\r\n\r\nexport const STAKED_TOKEN_SLUGS = new Set([STAKED_TON_SLUG, STAKED_MYCOIN_SLUG, TON_TSUSDE.slug]);\r\n\r\nexport const DEFAULT_OUR_SWAP_FEE = 0.875; \r\n\r\nexport const DEFAULT_STAKING_STATE: ApiLiquidStakingState = {\r\n  type: 'liquid',\r\n  id: 'liquid',\r\n  tokenSlug: TONCOIN.slug,\r\n  annualYield: 5.5,\r\n  yieldType: 'APY',\r\n  balance: 0n,\r\n  pool: LIQUID_POOL,\r\n  tokenBalance: 0n,\r\n  unstakeRequestAmount: 0n,\r\n  instantAvailable: 0n,\r\n  start: 0,\r\n  end: 0,\r\n};\r\n\r\nexport const DEFAULT_NOMINATORS_STAKING_STATE: ApiNominatorsStakingState = {\r\n  type: 'nominators',\r\n  id: 'nominators',\r\n  tokenSlug: TONCOIN.slug,\r\n  annualYield: 7.5,\r\n  yieldType: 'APY',\r\n  balance: 0n,\r\n  pool: 'Ef8dgIOIRyCLU0NEvF8TD6Me3wrbrkS1z3Gpjk3ppd8m8-s_',\r\n  start: 0,\r\n  end: 0,\r\n};\r\n\r\nexport const SWAP_API_VERSION = 3;\r\nexport const TONCENTER_ACTIONS_VERSION = 'v1';\r\n\r\nexport const JVAULT_URL = 'https://jvault.xyz';\r\n\r\nexport const HELP_CENTER_URL = {\r\n  home: {\r\n    en: 'https://t.me/dps_wallets',\r\n    ru: 'https://t.me/dps_wallets',\r\n  },\r\n  domainScam: {\r\n    en: 'https://help.mytonwallet.io/intro/scams/.ton-domain-scams',\r\n    // eslint-disable-next-line @stylistic/max-len\r\n    ru: 'https://help.mytonwallet.io/ru/baza-znanii/moshennichestvo-i-skamy/moshennichestvo-s-ispolzovaniem-domenov-.ton',\r\n  },\r\n  seedScam: {\r\n    en: 'https://help.mytonwallet.io/intro/scams/leaked-seed-phrases',\r\n    ru: 'https://help.mytonwallet.io/ru/baza-znanii/moshennichestvo-i-skamy/slitye-sid-frazy',\r\n  },\r\n  ethenaStaking: {\r\n    en: 'https://help.mytonwallet.io/intro/staking/what-is-usde-how-does-usde-staking-work',\r\n    ru: 'https://help.mytonwallet.io/ru/baza-znanii/steiking/chto-takoe-usde-kak-rabotaet-steiking-usde',\r\n  },\r\n};\r\n\r\nconst ALL_TON_DNS_ZONES = [\r\n  {\r\n    suffixes: ['ton'],\r\n    baseFormat: /^([-\\da-z]+\\.){0,2}[-\\da-z]{4,126}$/i,\r\n    resolver: 'EQC3dNlesgVD8YbAazcauIrXBPfiVhMMr5YYk2in0Mtsz0Bz',\r\n    collectionName: 'TON DNS Domains',\r\n  },\r\n  {\r\n    suffixes: ['t.me'],\r\n    baseFormat: /^([-\\da-z]+\\.){0,2}[-_\\da-z]{4,32}$/i,\r\n    resolver: 'EQCA14o1-VWhS2efqoh_9M1b_A9DtKTuoqfmkn83AbJzwnPi',\r\n    isTelemint: true,\r\n    collectionName: 'Telegram Usernames',\r\n  },\r\n  {\r\n    suffixes: ['vip', 'ton.vip', 'vip.ton'],\r\n    baseFormat: /^([-\\da-z]+\\.){0,2}?[\\da-z]{1,24}$/i,\r\n    resolver: 'EQBWG4EBbPDv4Xj7xlPwzxd7hSyHMzwwLB5O6rY-0BBeaixS',\r\n    collectionName: 'VIP DNS Domains',\r\n    isUnofficial: true,\r\n  },\r\n  {\r\n    suffixes: ['gram'],\r\n    baseFormat: /^([-\\da-z]+\\.){0,2}[\\da-z]{1,127}$/i,\r\n    resolver: 'EQAic3zPce496ukFDhbco28FVsKKl2WUX_iJwaL87CBxSiLQ',\r\n    collectionName: 'GRAM DNS Domains',\r\n    isUnofficial: true,\r\n  },\r\n];\r\n\r\nexport const TON_DNS_ZONES = IS_CORE_WALLET\r\n  ? ALL_TON_DNS_ZONES.filter(({ isUnofficial }) => !isUnofficial)\r\n  : ALL_TON_DNS_ZONES;\r\n\r\nexport const DEFAULT_AUTOLOCK_OPTION: AutolockValueType = '3';\r\nexport const WRONG_ATTEMPTS_BEFORE_LOG_OUT_SUGGESTION = 2;\r\n\r\nexport const UNKNOWN_TOKEN = {\r\n  symbol: '[Unknown]',\r\n  decimals: 6,\r\n} as const;\r\n\r\nexport const PUSH_ADDRESS = 'EQBNl2Hnxgc-olNY_Qq9iB3Rd3P7GGrW2oUzLc47BW3EjHNy';\r\n\r\n// https://api.mytonwallet.org/currency-rates\r\nexport const FALLBACK_BASE_CURRENCY_RATES: ApiCurrencyRates = {\r\n  USD: '1',\r\n  EUR: '0.85233500',\r\n  RUB: '84.49824600',\r\n  CNY: '7.11865000',\r\n  BTC: '0.00000866',\r\n  TON: '0.31360000',\r\n};\r\n\r\nexport const DEFAULT_CHAIN: ApiChain = 'ton';\r\n","import Deferred from './Deferred';\r\n\r\nexport type Scheduler = typeof requestAnimationFrame | typeof onTickEnd;\r\n\r\nexport const pause = (ms: number) => new Promise<void>((resolve) => {\r\n  setTimeout(() => resolve(), ms);\r\n});\r\n\r\nexport function debounce<F extends AnyToVoidFunction>(\r\n  fn: F,\r\n  ms: number,\r\n  shouldRunFirst = true,\r\n  shouldRunLast = true,\r\n) {\r\n  let waitingTimeout: number | undefined;\r\n\r\n  return (...args: Parameters<F>) => {\r\n    if (waitingTimeout) {\r\n      clearTimeout(waitingTimeout);\r\n      waitingTimeout = undefined;\r\n    } else if (shouldRunFirst) {\r\n      fn(...args);\r\n    }\r\n\r\n    waitingTimeout = self.setTimeout(() => {\r\n      if (shouldRunLast) {\r\n        fn(...args);\r\n      }\r\n\r\n      waitingTimeout = undefined;\r\n    }, ms);\r\n  };\r\n}\r\n\r\n/**\r\n * An important feature of this throttle implementation is that it waits for `fn` to finish before scheduling the new\r\n * execution. That is, `fn` never gets executed in parallel with itself.\r\n */\r\nexport function throttle<F extends AnyFunction>(\r\n  fn: F,\r\n  ms: number | (() => Promise<void>),\r\n  shouldRunFirst = true,\r\n) {\r\n  let args: Parameters<F> | undefined;\r\n  let isRunning = false;\r\n\r\n  async function scheduleFn() {\r\n    await (typeof ms === 'function' ? ms() : pause(ms));\r\n    void runFn();\r\n  }\r\n\r\n  async function runFn() {\r\n    if (!args) {\r\n      isRunning = false;\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const localArgs = args;\r\n      args = undefined;\r\n      await fn(...localArgs);\r\n    } finally {\r\n      // Voiding the promise to let the error produced by `fn` be thrown immediately\r\n      void scheduleFn();\r\n    }\r\n  }\r\n\r\n  return (..._args: Parameters<F>) => {\r\n    args = _args;\r\n\r\n    if (!isRunning) {\r\n      isRunning = true;\r\n\r\n      if (shouldRunFirst) {\r\n        void runFn();\r\n      } else {\r\n        void scheduleFn();\r\n      }\r\n    }\r\n  };\r\n}\r\n\r\nexport function throttleWithTickEnd<F extends AnyToVoidFunction>(fn: F) {\r\n  return throttleWith(onTickEnd, fn);\r\n}\r\n\r\nexport function throttleWith<F extends AnyToVoidFunction>(schedulerFn: Scheduler, fn: F) {\r\n  let waiting = false;\r\n  let args: Parameters<F>;\r\n\r\n  return (..._args: Parameters<F>) => {\r\n    args = _args;\r\n\r\n    if (!waiting) {\r\n      waiting = true;\r\n\r\n      schedulerFn(() => {\r\n        waiting = false;\r\n        fn(...args);\r\n      });\r\n    }\r\n  };\r\n}\r\n\r\nexport function rafPromise() {\r\n  return new Promise<void>((resolve) => {\r\n    fastRaf(resolve);\r\n  });\r\n}\r\n\r\nconst FAST_RAF_TIMEOUT_FALLBACK_MS = 35; // < 30 FPS\r\n\r\nlet fastRafCallbacks: Set<NoneToVoidFunction> | undefined;\r\nlet fastRafFallbackCallbacks: Set<NoneToVoidFunction> | undefined;\r\nlet fastRafFallbackTimeout: number | undefined;\r\n\r\n// May result in an immediate execution if called from another RAF callback which was scheduled\r\n// (and therefore is executed) earlier than RAF callback scheduled by `fastRaf`\r\nexport function fastRaf(callback: NoneToVoidFunction, withTimeoutFallback = false) {\r\n  if (!fastRafCallbacks) {\r\n    fastRafCallbacks = new Set([callback]);\r\n\r\n    requestAnimationFrame(() => {\r\n      const currentCallbacks = fastRafCallbacks!;\r\n\r\n      fastRafCallbacks = undefined;\r\n      fastRafFallbackCallbacks = undefined;\r\n\r\n      if (fastRafFallbackTimeout) {\r\n        clearTimeout(fastRafFallbackTimeout);\r\n        fastRafFallbackTimeout = undefined;\r\n      }\r\n\r\n      currentCallbacks.forEach((cb) => cb());\r\n    });\r\n  } else {\r\n    fastRafCallbacks.add(callback);\r\n  }\r\n\r\n  if (withTimeoutFallback) {\r\n    if (!fastRafFallbackCallbacks) {\r\n      fastRafFallbackCallbacks = new Set([callback]);\r\n    } else {\r\n      fastRafFallbackCallbacks.add(callback);\r\n    }\r\n\r\n    if (!fastRafFallbackTimeout) {\r\n      fastRafFallbackTimeout = window.setTimeout(() => {\r\n        const currentTimeoutCallbacks = fastRafFallbackCallbacks!;\r\n\r\n        if (fastRafCallbacks) {\r\n          currentTimeoutCallbacks.forEach(fastRafCallbacks.delete, fastRafCallbacks);\r\n        }\r\n        fastRafFallbackCallbacks = undefined;\r\n\r\n        if (fastRafFallbackTimeout) {\r\n          clearTimeout(fastRafFallbackTimeout);\r\n          fastRafFallbackTimeout = undefined;\r\n        }\r\n\r\n        currentTimeoutCallbacks.forEach((cb) => cb());\r\n      }, FAST_RAF_TIMEOUT_FALLBACK_MS);\r\n    }\r\n  }\r\n}\r\n\r\nlet onTickEndCallbacks: NoneToVoidFunction[] | undefined;\r\n\r\nexport function onTickEnd(callback: NoneToVoidFunction) {\r\n  if (!onTickEndCallbacks) {\r\n    onTickEndCallbacks = [callback];\r\n\r\n    void Promise.resolve().then(() => {\r\n      const currentCallbacks = onTickEndCallbacks!;\r\n      onTickEndCallbacks = undefined;\r\n      currentCallbacks.forEach((cb) => cb());\r\n    });\r\n  } else {\r\n    onTickEndCallbacks.push(callback);\r\n  }\r\n}\r\n\r\nconst IDLE_TIMEOUT = 500;\r\n\r\nlet onIdleCallbacks: NoneToVoidFunction[] | undefined;\r\n\r\nexport function onIdle(callback: NoneToVoidFunction) {\r\n  if (!self.requestIdleCallback) {\r\n    onTickEnd(callback);\r\n    return;\r\n  }\r\n\r\n  if (!onIdleCallbacks) {\r\n    onIdleCallbacks = [callback];\r\n\r\n    requestIdleCallback((deadline) => {\r\n      const currentCallbacks = onIdleCallbacks!;\r\n      onIdleCallbacks = undefined;\r\n\r\n      while (currentCallbacks.length) {\r\n        const cb = currentCallbacks.shift()!;\r\n        cb();\r\n\r\n        if (!deadline.timeRemaining()) break;\r\n      }\r\n\r\n      if (currentCallbacks.length) {\r\n        if (onIdleCallbacks) {\r\n          // Prepend the remaining callbacks if the next pass is already planned\r\n          onIdleCallbacks = currentCallbacks.concat(onIdleCallbacks);\r\n        } else {\r\n          currentCallbacks.forEach(onIdle);\r\n        }\r\n      }\r\n    }, { timeout: IDLE_TIMEOUT });\r\n  } else {\r\n    onIdleCallbacks.push(callback);\r\n  }\r\n}\r\n\r\nlet beforeUnloadCallbacks: NoneToVoidFunction[] | undefined;\r\n\r\nexport function onBeforeUnload(callback: NoneToVoidFunction, isLast = false) {\r\n  if (!beforeUnloadCallbacks) {\r\n    beforeUnloadCallbacks = [];\r\n\r\n    self.addEventListener('beforeunload', () => {\r\n      beforeUnloadCallbacks!.forEach((cb) => cb());\r\n    });\r\n  }\r\n\r\n  if (isLast) {\r\n    beforeUnloadCallbacks.push(callback);\r\n  } else {\r\n    beforeUnloadCallbacks.unshift(callback);\r\n  }\r\n\r\n  return () => {\r\n    beforeUnloadCallbacks = beforeUnloadCallbacks!.filter((cb) => cb !== callback);\r\n  };\r\n}\r\n\r\nexport async function waitFor(cb: () => boolean, interval: number, attempts: number) {\r\n  let i = 0;\r\n  let result = cb();\r\n\r\n  while (!result && i < attempts) {\r\n    await pause(interval);\r\n\r\n    i++;\r\n    result = cb();\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nexport function setCancellableTimeout(ms: number, cb: NoneToVoidFunction) {\r\n  const timeoutId = setTimeout(cb, ms);\r\n  return () => clearTimeout(timeoutId);\r\n}\r\n\r\n/**\r\n * Returns a function that executes every given functions (tasks) with limited concurrency (not more than\r\n * `maxConcurrency` at a time). The tasks are executed in the same order that they are given. Unlike throttle, executes\r\n * every given task.\r\n */\r\nexport function createTaskQueue(maxConcurrency = 1) {\r\n  const queue: AnyAsyncFunction[] = [];\r\n  let concurrency = 0;\r\n\r\n  const runTasks = async () => {\r\n    concurrency++;\r\n    while (queue.length) {\r\n      const task = queue.shift()!;\r\n      await task(); // Expected never to throw, because the errors are caught below\r\n    }\r\n    concurrency--;\r\n  };\r\n\r\n  /** Schedules execution of the given function right now. The returned promise settles with the task result. */\r\n  const run = <T>(task: () => MaybePromise<T>): Promise<T> => {\r\n    const deferred = new Deferred<T>();\r\n    queue.push(async () => {\r\n      try {\r\n        deferred.resolve(await task());\r\n      } catch (err) {\r\n        deferred.reject(err);\r\n      }\r\n    });\r\n\r\n    if (concurrency < maxConcurrency) {\r\n      void runTasks();\r\n    }\r\n\r\n    return deferred.promise;\r\n  };\r\n\r\n  /** Returns the same task function, but with limited concurrency */\r\n  const wrap = <Args extends unknown[], Return>(\r\n    task: (...args: Args) => MaybePromise<Return>,\r\n  ): (...args: Args) => Promise<Return> => {\r\n    return (...args: Args) => run(() => task(...args));\r\n  };\r\n\r\n  return { run, wrap };\r\n}\r\n\r\n/**\r\n * Returns a function that prevents `actions` from running in parallel with itself. If the `action` is already running,\r\n * queues, the next call will be queued. Unlike `throttle`, never skips the calls.\r\n */\r\nexport function forbidConcurrency<Args extends unknown[], Return>(\r\n  action: (...args: Args) => MaybePromise<Return>,\r\n): (...args: Args) => Promise<Return> {\r\n  return createTaskQueue(1).wrap(action);\r\n}\r\n","import type { ApiAnyDisplayError } from './types';\r\nimport { ApiCommonError } from './types';\r\n\r\nexport class ApiBaseError extends Error {\r\n  constructor(message?: string, public displayError?: ApiAnyDisplayError) {\r\n    super(message);\r\n    this.name = this.constructor.name;\r\n  }\r\n}\r\n\r\nexport class ApiUserRejectsError extends ApiBaseError {\r\n  constructor(message: string = 'Canceled by the user') {\r\n    super(message);\r\n  }\r\n}\r\n\r\nexport class ApiServerError extends ApiBaseError {\r\n  constructor(message: string, public statusCode?: number) {\r\n    super(message, ApiCommonError.ServerError);\r\n  }\r\n}\r\n\r\nexport class AbortOperationError extends ApiBaseError {\r\n  constructor(message: string = 'Abort operation') {\r\n    super(message);\r\n  }\r\n}\r\n\r\nexport class NotImplemented extends ApiBaseError {\r\n  constructor(message: string = 'Not implemented') {\r\n    super(message);\r\n  }\r\n}\r\n\r\nexport function maybeApiErrors(fn: AnyAsyncFunction) {\r\n  return async (...args: any) => {\r\n    try {\r\n      return await fn(...args);\r\n    } catch (err) {\r\n      return handleServerError(err);\r\n    }\r\n  };\r\n}\r\n\r\nexport function handleServerError(err: any) {\r\n  if (err instanceof ApiServerError) {\r\n    return { error: err.displayError! };\r\n  }\r\n  throw err;\r\n}\r\n","import { bigintRandom, bigintReviver } from '../../../../util/bigint';\r\n\r\nexport function cloneDeep<T>(value: T): T {\r\n  return JSON.parse(JSON.stringify(value), bigintReviver);\r\n}\r\n\r\nexport function generateQueryId() {\r\n  return bigintRandom(8);\r\n}\r\n","import {\r\n  DEFAULT_ERROR_PAUSE,\r\n  DEFAULT_RETRIES,\r\n  DEFAULT_TIMEOUT,\r\n  IPFS_GATEWAY_BASE_URL,\r\n  PROXY_API_BASE_URL,\r\n} from '../config';\r\nimport { ApiServerError } from '../api/errors';\r\nimport { logDebug } from './logs';\r\nimport { pause } from './schedulers';\r\n\r\ntype QueryParams = Record<string, string | number | boolean | string[]>;\r\n\r\nconst MAX_TIMEOUT = 30000; // 30 sec\r\n\r\nexport function fetchJsonWithProxy(url: string | URL, data?: QueryParams, init?: RequestInit) {\r\n  return fetchJson(getProxiedJsonUrl(url.toString()), data, init);\r\n}\r\n\r\nexport async function fetchJson(url: string | URL, data?: QueryParams, init?: RequestInit) {\r\n  const urlObject = new URL(url);\r\n  if (data) {\r\n    Object.entries(data).forEach(([key, value]) => {\r\n      if (value === undefined) {\r\n        return;\r\n      }\r\n\r\n      if (Array.isArray(value)) {\r\n        value.forEach((item) => {\r\n          urlObject.searchParams.append(key, item.toString());\r\n        });\r\n      } else {\r\n        urlObject.searchParams.set(key, value.toString());\r\n      }\r\n    });\r\n  }\r\n\r\n  const response = await fetchWithRetry(urlObject, init);\r\n\r\n  return response.json();\r\n}\r\n\r\nexport async function fetchWithRetry(url: string | URL, init?: RequestInit, options?: {\r\n  retries?: number;\r\n  timeouts?: number | number[];\r\n  shouldSkipRetryFn?: (message?: string, statusCode?: number) => boolean;\r\n}) {\r\n  const {\r\n    retries = DEFAULT_RETRIES,\r\n    timeouts = DEFAULT_TIMEOUT,\r\n    shouldSkipRetryFn = isNotTemporaryError,\r\n  } = options ?? {};\r\n\r\n  let message = 'Unknown error.';\r\n  let statusCode: number | undefined;\r\n\r\n  for (let i = 1; i <= retries; i++) {\r\n    try {\r\n      if (i > 1) {\r\n        logDebug(`Retry request #${i}:`, url.toString(), statusCode);\r\n      }\r\n\r\n      const timeout = Array.isArray(timeouts)\r\n        ? timeouts[i - 1] ?? timeouts[timeouts.length - 1]\r\n        : Math.min(timeouts * i, MAX_TIMEOUT);\r\n      const response = await fetchWithTimeout(url, init, timeout);\r\n      statusCode = response.status;\r\n\r\n      if (statusCode >= 400) {\r\n        const { error } = await response.json().catch(() => {});\r\n        throw new Error(error ?? `HTTP Error ${statusCode}`);\r\n      }\r\n\r\n      return response;\r\n    } catch (err: any) {\r\n      message = typeof err === 'string' ? err : err.message ?? message;\r\n\r\n      const shouldSkipRetry = shouldSkipRetryFn(message, statusCode);\r\n\r\n      if (shouldSkipRetry) {\r\n        throw new ApiServerError(message, statusCode);\r\n      }\r\n\r\n      if (i < retries) {\r\n        await pause(DEFAULT_ERROR_PAUSE * i);\r\n      }\r\n    }\r\n  }\r\n\r\n  throw new ApiServerError(message);\r\n}\r\n\r\nexport async function fetchWithTimeout(url: string | URL, init?: RequestInit, timeout = DEFAULT_TIMEOUT) {\r\n  const controller = new AbortController();\r\n  const id = setTimeout(() => {\r\n    controller.abort();\r\n  }, timeout);\r\n\r\n  try {\r\n    return await fetch(url, {\r\n      ...init,\r\n      signal: controller.signal,\r\n    });\r\n  } finally {\r\n    clearTimeout(id);\r\n  }\r\n}\r\n\r\nexport async function handleFetchErrors(response: Response, ignoreHttpCodes?: number[]) {\r\n  if (!response.ok && (!ignoreHttpCodes?.includes(response.status))) {\r\n    // eslint-disable-next-line prefer-const\r\n    let { error, errors } = await response.json().catch(() => undefined);\r\n    if (!error && errors && errors.length) {\r\n      error = errors[0]?.msg;\r\n    }\r\n\r\n    throw new ApiServerError(error ?? `HTTP Error ${response.status}`, response.status);\r\n  }\r\n  return response;\r\n}\r\n\r\nfunction isNotTemporaryError(message?: string, statusCode?: number) {\r\n  return statusCode && [400, 404].includes(statusCode);\r\n}\r\n\r\nexport function getProxiedJsonUrl(url: string) {\r\n  return `${PROXY_API_BASE_URL}/download-json?url=${encodeURIComponent(url)}`;\r\n}\r\n\r\nexport function getProxiedLottieUrl(url: string) {\r\n  return `${PROXY_API_BASE_URL}/download-lottie?url=${encodeURIComponent(url)}`;\r\n}\r\n\r\nexport function fixIpfsUrl(url: string) {\r\n  return url.replace('ipfs://', IPFS_GATEWAY_BASE_URL);\r\n}\r\n","import { IS_EXTENSION } from '../config';\r\n\r\nexport const IS_EXTENSION_PAGE_SCRIPT = IS_EXTENSION\r\n  && !['chrome-extension:', 'moz-extension:'].includes(self.location.protocol);\r\n","import { APP_ENV, DEBUG_ALERT_MSG } from '../config';\r\nimport { SECOND } from './dateFormat';\r\nimport { IS_EXTENSION_PAGE_SCRIPT } from './environment';\r\nimport { logDebugError } from './logs';\r\nimport { throttle } from './schedulers';\r\n\r\nconst shouldShowAlert = (APP_ENV === 'development' || APP_ENV === 'staging')\r\n  && typeof window === 'object'\r\n  && !IS_EXTENSION_PAGE_SCRIPT;\r\n\r\nconst throttledAlert = throttle((message) => window.alert(message), 10 * SECOND);\r\n\r\nself.addEventListener('error', handleErrorEvent);\r\nself.addEventListener('unhandledrejection', handleErrorEvent);\r\n\r\nfunction handleErrorEvent(e: ErrorEvent | PromiseRejectionEvent) {\r\n  // https://stackoverflow.com/questions/49384120/resizeobserver-loop-limit-exceeded\r\n  if (e instanceof ErrorEvent && e.message === 'ResizeObserver loop limit exceeded') {\r\n    return;\r\n  }\r\n\r\n  e.preventDefault();\r\n\r\n  handleError(e instanceof ErrorEvent ? (e.error || e.message) : e.reason);\r\n}\r\n\r\nexport function handleError(err: Error | string) {\r\n  logDebugError('handleError', err);\r\n\r\n  const message = typeof err === 'string' ? err : err.message;\r\n  const stack = typeof err === 'object' ? err.stack : undefined;\r\n\r\n  if (message.endsWith('Failed to import rlottie-wasm.js')) {\r\n    return;\r\n  }\r\n\r\n  if (shouldShowAlert) {\r\n    throttledAlert(`${DEBUG_ALERT_MSG}\\n\\n${(message) || err}\\n${stack}`);\r\n  }\r\n}\r\n","/*\r\n *  big.js v6.2.1\r\n *  A small, fast, easy-to-use library for arbitrary-precision decimal arithmetic.\r\n *  Copyright (c) 2022 Michael Mclaughlin\r\n *  https://github.com/MikeMcl/big.js/LICENCE.md\r\n */\r\n\r\n\r\n/************************************** EDITABLE DEFAULTS *****************************************/\r\n\r\n\r\n  // The default values below must be integers within the stated ranges.\r\n\r\n  /*\r\n   * The maximum number of decimal places (DP) of the results of operations involving division:\r\n   * div and sqrt, and pow with negative exponents.\r\n   */\r\nvar DP = 20,          // 0 to MAX_DP\r\n\r\n  /*\r\n   * The rounding mode (RM) used when rounding to the above decimal places.\r\n   *\r\n   *  0  Towards zero (i.e. truncate, no rounding).       (ROUND_DOWN)\r\n   *  1  To nearest neighbour. If equidistant, round up.  (ROUND_HALF_UP)\r\n   *  2  To nearest neighbour. If equidistant, to even.   (ROUND_HALF_EVEN)\r\n   *  3  Away from zero.                                  (ROUND_UP)\r\n   */\r\n  RM = 1,             // 0, 1, 2 or 3\r\n\r\n  // The maximum value of DP and Big.DP.\r\n  MAX_DP = 1E6,       // 0 to 1000000\r\n\r\n  // The maximum magnitude of the exponent argument to the pow method.\r\n  MAX_POWER = 1E6,    // 1 to 1000000\r\n\r\n  /*\r\n   * The negative exponent (NE) at and beneath which toString returns exponential notation.\r\n   * (JavaScript numbers: -7)\r\n   * -1000000 is the minimum recommended exponent value of a Big.\r\n   */\r\n  NE = -7,            // 0 to -1000000\r\n\r\n  /*\r\n   * The positive exponent (PE) at and above which toString returns exponential notation.\r\n   * (JavaScript numbers: 21)\r\n   * 1000000 is the maximum recommended exponent value of a Big, but this limit is not enforced.\r\n   */\r\n  PE = 21,            // 0 to 1000000\r\n\r\n  /*\r\n   * When true, an error will be thrown if a primitive number is passed to the Big constructor,\r\n   * or if valueOf is called, or if toNumber is called on a Big which cannot be converted to a\r\n   * primitive number without a loss of precision.\r\n   */\r\n  STRICT = false,     // true or false\r\n\r\n\r\n/**************************************************************************************************/\r\n\r\n\r\n  // Error messages.\r\n  NAME = '[big.js] ',\r\n  INVALID = NAME + 'Invalid ',\r\n  INVALID_DP = INVALID + 'decimal places',\r\n  INVALID_RM = INVALID + 'rounding mode',\r\n  DIV_BY_ZERO = NAME + 'Division by zero',\r\n\r\n  // The shared prototype object.\r\n  P = {},\r\n  UNDEFINED = void 0,\r\n  NUMERIC = /^-?(\\d+(\\.\\d*)?|\\.\\d+)(e[+-]?\\d+)?$/i;\r\n\r\n\r\n/*\r\n * Create and return a Big constructor.\r\n */\r\nfunction _Big_() {\r\n\r\n  /*\r\n   * The Big constructor and exported function.\r\n   * Create and return a new instance of a Big number object.\r\n   *\r\n   * n {number|string|Big} A numeric value.\r\n   */\r\n  function Big(n) {\r\n    var x = this;\r\n\r\n    // Enable constructor usage without new.\r\n    if (!(x instanceof Big)) return n === UNDEFINED ? _Big_() : new Big(n);\r\n\r\n    // Duplicate.\r\n    if (n instanceof Big) {\r\n      x.s = n.s;\r\n      x.e = n.e;\r\n      x.c = n.c.slice();\r\n    } else {\r\n      if (typeof n !== 'string') {\r\n        if (Big.strict === true && typeof n !== 'bigint') {\r\n          throw TypeError(INVALID + 'value');\r\n        }\r\n\r\n        // Minus zero?\r\n        n = n === 0 && 1 / n < 0 ? '-0' : String(n);\r\n      }\r\n\r\n      parse(x, n);\r\n    }\r\n\r\n    // Retain a reference to this Big constructor.\r\n    // Shadow Big.prototype.constructor which points to Object.\r\n    x.constructor = Big;\r\n  }\r\n\r\n  Big.prototype = P;\r\n  Big.DP = DP;\r\n  Big.RM = RM;\r\n  Big.NE = NE;\r\n  Big.PE = PE;\r\n  Big.strict = STRICT;\r\n  Big.roundDown = 0;\r\n  Big.roundHalfUp = 1;\r\n  Big.roundHalfEven = 2;\r\n  Big.roundUp = 3;\r\n\r\n  return Big;\r\n}\r\n\r\n\r\n/*\r\n * Parse the number or string value passed to a Big constructor.\r\n *\r\n * x {Big} A Big number instance.\r\n * n {number|string} A numeric value.\r\n */\r\nfunction parse(x, n) {\r\n  var e, i, nl;\r\n\r\n  if (!NUMERIC.test(n)) {\r\n    throw Error(INVALID + 'number');\r\n  }\r\n\r\n  // Determine sign.\r\n  x.s = n.charAt(0) == '-' ? (n = n.slice(1), -1) : 1;\r\n\r\n  // Decimal point?\r\n  if ((e = n.indexOf('.')) > -1) n = n.replace('.', '');\r\n\r\n  // Exponential form?\r\n  if ((i = n.search(/e/i)) > 0) {\r\n\r\n    // Determine exponent.\r\n    if (e < 0) e = i;\r\n    e += +n.slice(i + 1);\r\n    n = n.substring(0, i);\r\n  } else if (e < 0) {\r\n\r\n    // Integer.\r\n    e = n.length;\r\n  }\r\n\r\n  nl = n.length;\r\n\r\n  // Determine leading zeros.\r\n  for (i = 0; i < nl && n.charAt(i) == '0';) ++i;\r\n\r\n  if (i == nl) {\r\n\r\n    // Zero.\r\n    x.c = [x.e = 0];\r\n  } else {\r\n\r\n    // Determine trailing zeros.\r\n    for (; nl > 0 && n.charAt(--nl) == '0';);\r\n    x.e = e - i - 1;\r\n    x.c = [];\r\n\r\n    // Convert string to array of digits without leading/trailing zeros.\r\n    for (e = 0; i <= nl;) x.c[e++] = +n.charAt(i++);\r\n  }\r\n\r\n  return x;\r\n}\r\n\r\n\r\n/*\r\n * Round Big x to a maximum of sd significant digits using rounding mode rm.\r\n *\r\n * x {Big} The Big to round.\r\n * sd {number} Significant digits: integer, 0 to MAX_DP inclusive.\r\n * rm {number} Rounding mode: 0 (down), 1 (half-up), 2 (half-even) or 3 (up).\r\n * [more] {boolean} Whether the result of division was truncated.\r\n */\r\nfunction round(x, sd, rm, more) {\r\n  var xc = x.c;\r\n\r\n  if (rm === UNDEFINED) rm = x.constructor.RM;\r\n  if (rm !== 0 && rm !== 1 && rm !== 2 && rm !== 3) {\r\n    throw Error(INVALID_RM);\r\n  }\r\n\r\n  if (sd < 1) {\r\n    more =\r\n      rm === 3 && (more || !!xc[0]) || sd === 0 && (\r\n      rm === 1 && xc[0] >= 5 ||\r\n      rm === 2 && (xc[0] > 5 || xc[0] === 5 && (more || xc[1] !== UNDEFINED))\r\n    );\r\n\r\n    xc.length = 1;\r\n\r\n    if (more) {\r\n\r\n      // 1, 0.1, 0.01, 0.001, 0.0001 etc.\r\n      x.e = x.e - sd + 1;\r\n      xc[0] = 1;\r\n    } else {\r\n\r\n      // Zero.\r\n      xc[0] = x.e = 0;\r\n    }\r\n  } else if (sd < xc.length) {\r\n\r\n    // xc[sd] is the digit after the digit that may be rounded up.\r\n    more =\r\n      rm === 1 && xc[sd] >= 5 ||\r\n      rm === 2 && (xc[sd] > 5 || xc[sd] === 5 &&\r\n        (more || xc[sd + 1] !== UNDEFINED || xc[sd - 1] & 1)) ||\r\n      rm === 3 && (more || !!xc[0]);\r\n\r\n    // Remove any digits after the required precision.\r\n    xc.length = sd;\r\n\r\n    // Round up?\r\n    if (more) {\r\n\r\n      // Rounding up may mean the previous digit has to be rounded up.\r\n      for (; ++xc[--sd] > 9;) {\r\n        xc[sd] = 0;\r\n        if (sd === 0) {\r\n          ++x.e;\r\n          xc.unshift(1);\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Remove trailing zeros.\r\n    for (sd = xc.length; !xc[--sd];) xc.pop();\r\n  }\r\n\r\n  return x;\r\n}\r\n\r\n\r\n/*\r\n * Return a string representing the value of Big x in normal or exponential notation.\r\n * Handles P.toExponential, P.toFixed, P.toJSON, P.toPrecision, P.toString and P.valueOf.\r\n */\r\nfunction stringify(x, doExponential, isNonzero) {\r\n  var e = x.e,\r\n    s = x.c.join(''),\r\n    n = s.length;\r\n\r\n  // Exponential notation?\r\n  if (doExponential) {\r\n    s = s.charAt(0) + (n > 1 ? '.' + s.slice(1) : '') + (e < 0 ? 'e' : 'e+') + e;\r\n\r\n  // Normal notation.\r\n  } else if (e < 0) {\r\n    for (; ++e;) s = '0' + s;\r\n    s = '0.' + s;\r\n  } else if (e > 0) {\r\n    if (++e > n) {\r\n      for (e -= n; e--;) s += '0';\r\n    } else if (e < n) {\r\n      s = s.slice(0, e) + '.' + s.slice(e);\r\n    }\r\n  } else if (n > 1) {\r\n    s = s.charAt(0) + '.' + s.slice(1);\r\n  }\r\n\r\n  return x.s < 0 && isNonzero ? '-' + s : s;\r\n}\r\n\r\n\r\n// Prototype/instance methods\r\n\r\n\r\n/*\r\n * Return a new Big whose value is the absolute value of this Big.\r\n */\r\nP.abs = function () {\r\n  var x = new this.constructor(this);\r\n  x.s = 1;\r\n  return x;\r\n};\r\n\r\n\r\n/*\r\n * Return 1 if the value of this Big is greater than the value of Big y,\r\n *       -1 if the value of this Big is less than the value of Big y, or\r\n *        0 if they have the same value.\r\n */\r\nP.cmp = function (y) {\r\n  var isneg,\r\n    x = this,\r\n    xc = x.c,\r\n    yc = (y = new x.constructor(y)).c,\r\n    i = x.s,\r\n    j = y.s,\r\n    k = x.e,\r\n    l = y.e;\r\n\r\n  // Either zero?\r\n  if (!xc[0] || !yc[0]) return !xc[0] ? !yc[0] ? 0 : -j : i;\r\n\r\n  // Signs differ?\r\n  if (i != j) return i;\r\n\r\n  isneg = i < 0;\r\n\r\n  // Compare exponents.\r\n  if (k != l) return k > l ^ isneg ? 1 : -1;\r\n\r\n  j = (k = xc.length) < (l = yc.length) ? k : l;\r\n\r\n  // Compare digit by digit.\r\n  for (i = -1; ++i < j;) {\r\n    if (xc[i] != yc[i]) return xc[i] > yc[i] ^ isneg ? 1 : -1;\r\n  }\r\n\r\n  // Compare lengths.\r\n  return k == l ? 0 : k > l ^ isneg ? 1 : -1;\r\n};\r\n\r\n\r\n/*\r\n * Return a new Big whose value is the value of this Big divided by the value of Big y, rounded,\r\n * if necessary, to a maximum of Big.DP decimal places using rounding mode Big.RM.\r\n */\r\nP.div = function (y) {\r\n  var x = this,\r\n    Big = x.constructor,\r\n    a = x.c,                  // dividend\r\n    b = (y = new Big(y)).c,   // divisor\r\n    k = x.s == y.s ? 1 : -1,\r\n    dp = Big.DP;\r\n\r\n  if (dp !== ~~dp || dp < 0 || dp > MAX_DP) {\r\n    throw Error(INVALID_DP);\r\n  }\r\n\r\n  // Divisor is zero?\r\n  if (!b[0]) {\r\n    throw Error(DIV_BY_ZERO);\r\n  }\r\n\r\n  // Dividend is 0? Return +-0.\r\n  if (!a[0]) {\r\n    y.s = k;\r\n    y.c = [y.e = 0];\r\n    return y;\r\n  }\r\n\r\n  var bl, bt, n, cmp, ri,\r\n    bz = b.slice(),\r\n    ai = bl = b.length,\r\n    al = a.length,\r\n    r = a.slice(0, bl),   // remainder\r\n    rl = r.length,\r\n    q = y,                // quotient\r\n    qc = q.c = [],\r\n    qi = 0,\r\n    p = dp + (q.e = x.e - y.e) + 1;    // precision of the result\r\n\r\n  q.s = k;\r\n  k = p < 0 ? 0 : p;\r\n\r\n  // Create version of divisor with leading zero.\r\n  bz.unshift(0);\r\n\r\n  // Add zeros to make remainder as long as divisor.\r\n  for (; rl++ < bl;) r.push(0);\r\n\r\n  do {\r\n\r\n    // n is how many times the divisor goes into current remainder.\r\n    for (n = 0; n < 10; n++) {\r\n\r\n      // Compare divisor and remainder.\r\n      if (bl != (rl = r.length)) {\r\n        cmp = bl > rl ? 1 : -1;\r\n      } else {\r\n        for (ri = -1, cmp = 0; ++ri < bl;) {\r\n          if (b[ri] != r[ri]) {\r\n            cmp = b[ri] > r[ri] ? 1 : -1;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      // If divisor < remainder, subtract divisor from remainder.\r\n      if (cmp < 0) {\r\n\r\n        // Remainder can't be more than 1 digit longer than divisor.\r\n        // Equalise lengths using divisor with extra leading zero?\r\n        for (bt = rl == bl ? b : bz; rl;) {\r\n          if (r[--rl] < bt[rl]) {\r\n            ri = rl;\r\n            for (; ri && !r[--ri];) r[ri] = 9;\r\n            --r[ri];\r\n            r[rl] += 10;\r\n          }\r\n          r[rl] -= bt[rl];\r\n        }\r\n\r\n        for (; !r[0];) r.shift();\r\n      } else {\r\n        break;\r\n      }\r\n    }\r\n\r\n    // Add the digit n to the result array.\r\n    qc[qi++] = cmp ? n : ++n;\r\n\r\n    // Update the remainder.\r\n    if (r[0] && cmp) r[rl] = a[ai] || 0;\r\n    else r = [a[ai]];\r\n\r\n  } while ((ai++ < al || r[0] !== UNDEFINED) && k--);\r\n\r\n  // Leading zero? Do not remove if result is simply zero (qi == 1).\r\n  if (!qc[0] && qi != 1) {\r\n\r\n    // There can't be more than one zero.\r\n    qc.shift();\r\n    q.e--;\r\n    p--;\r\n  }\r\n\r\n  // Round?\r\n  if (qi > p) round(q, p, Big.RM, r[0] !== UNDEFINED);\r\n\r\n  return q;\r\n};\r\n\r\n\r\n/*\r\n * Return true if the value of this Big is equal to the value of Big y, otherwise return false.\r\n */\r\nP.eq = function (y) {\r\n  return this.cmp(y) === 0;\r\n};\r\n\r\n\r\n/*\r\n * Return true if the value of this Big is greater than the value of Big y, otherwise return\r\n * false.\r\n */\r\nP.gt = function (y) {\r\n  return this.cmp(y) > 0;\r\n};\r\n\r\n\r\n/*\r\n * Return true if the value of this Big is greater than or equal to the value of Big y, otherwise\r\n * return false.\r\n */\r\nP.gte = function (y) {\r\n  return this.cmp(y) > -1;\r\n};\r\n\r\n\r\n/*\r\n * Return true if the value of this Big is less than the value of Big y, otherwise return false.\r\n */\r\nP.lt = function (y) {\r\n  return this.cmp(y) < 0;\r\n};\r\n\r\n\r\n/*\r\n * Return true if the value of this Big is less than or equal to the value of Big y, otherwise\r\n * return false.\r\n */\r\nP.lte = function (y) {\r\n  return this.cmp(y) < 1;\r\n};\r\n\r\n\r\n/*\r\n * Return a new Big whose value is the value of this Big minus the value of Big y.\r\n */\r\nP.minus = P.sub = function (y) {\r\n  var i, j, t, xlty,\r\n    x = this,\r\n    Big = x.constructor,\r\n    a = x.s,\r\n    b = (y = new Big(y)).s;\r\n\r\n  // Signs differ?\r\n  if (a != b) {\r\n    y.s = -b;\r\n    return x.plus(y);\r\n  }\r\n\r\n  var xc = x.c.slice(),\r\n    xe = x.e,\r\n    yc = y.c,\r\n    ye = y.e;\r\n\r\n  // Either zero?\r\n  if (!xc[0] || !yc[0]) {\r\n    if (yc[0]) {\r\n      y.s = -b;\r\n    } else if (xc[0]) {\r\n      y = new Big(x);\r\n    } else {\r\n      y.s = 1;\r\n    }\r\n    return y;\r\n  }\r\n\r\n  // Determine which is the bigger number. Prepend zeros to equalise exponents.\r\n  if (a = xe - ye) {\r\n\r\n    if (xlty = a < 0) {\r\n      a = -a;\r\n      t = xc;\r\n    } else {\r\n      ye = xe;\r\n      t = yc;\r\n    }\r\n\r\n    t.reverse();\r\n    for (b = a; b--;) t.push(0);\r\n    t.reverse();\r\n  } else {\r\n\r\n    // Exponents equal. Check digit by digit.\r\n    j = ((xlty = xc.length < yc.length) ? xc : yc).length;\r\n\r\n    for (a = b = 0; b < j; b++) {\r\n      if (xc[b] != yc[b]) {\r\n        xlty = xc[b] < yc[b];\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  // x < y? Point xc to the array of the bigger number.\r\n  if (xlty) {\r\n    t = xc;\r\n    xc = yc;\r\n    yc = t;\r\n    y.s = -y.s;\r\n  }\r\n\r\n  /*\r\n   * Append zeros to xc if shorter. No need to add zeros to yc if shorter as subtraction only\r\n   * needs to start at yc.length.\r\n   */\r\n  if ((b = (j = yc.length) - (i = xc.length)) > 0) for (; b--;) xc[i++] = 0;\r\n\r\n  // Subtract yc from xc.\r\n  for (b = i; j > a;) {\r\n    if (xc[--j] < yc[j]) {\r\n      for (i = j; i && !xc[--i];) xc[i] = 9;\r\n      --xc[i];\r\n      xc[j] += 10;\r\n    }\r\n\r\n    xc[j] -= yc[j];\r\n  }\r\n\r\n  // Remove trailing zeros.\r\n  for (; xc[--b] === 0;) xc.pop();\r\n\r\n  // Remove leading zeros and adjust exponent accordingly.\r\n  for (; xc[0] === 0;) {\r\n    xc.shift();\r\n    --ye;\r\n  }\r\n\r\n  if (!xc[0]) {\r\n\r\n    // n - n = +0\r\n    y.s = 1;\r\n\r\n    // Result must be zero.\r\n    xc = [ye = 0];\r\n  }\r\n\r\n  y.c = xc;\r\n  y.e = ye;\r\n\r\n  return y;\r\n};\r\n\r\n\r\n/*\r\n * Return a new Big whose value is the value of this Big modulo the value of Big y.\r\n */\r\nP.mod = function (y) {\r\n  var ygtx,\r\n    x = this,\r\n    Big = x.constructor,\r\n    a = x.s,\r\n    b = (y = new Big(y)).s;\r\n\r\n  if (!y.c[0]) {\r\n    throw Error(DIV_BY_ZERO);\r\n  }\r\n\r\n  x.s = y.s = 1;\r\n  ygtx = y.cmp(x) == 1;\r\n  x.s = a;\r\n  y.s = b;\r\n\r\n  if (ygtx) return new Big(x);\r\n\r\n  a = Big.DP;\r\n  b = Big.RM;\r\n  Big.DP = Big.RM = 0;\r\n  x = x.div(y);\r\n  Big.DP = a;\r\n  Big.RM = b;\r\n\r\n  return this.minus(x.times(y));\r\n};\r\n\r\n\r\n/*\r\n * Return a new Big whose value is the value of this Big negated.\r\n */\r\nP.neg = function () {\r\n  var x = new this.constructor(this);\r\n  x.s = -x.s;\r\n  return x;\r\n};\r\n\r\n\r\n/*\r\n * Return a new Big whose value is the value of this Big plus the value of Big y.\r\n */\r\nP.plus = P.add = function (y) {\r\n  var e, k, t,\r\n    x = this,\r\n    Big = x.constructor;\r\n\r\n  y = new Big(y);\r\n\r\n  // Signs differ?\r\n  if (x.s != y.s) {\r\n    y.s = -y.s;\r\n    return x.minus(y);\r\n  }\r\n\r\n  var xe = x.e,\r\n    xc = x.c,\r\n    ye = y.e,\r\n    yc = y.c;\r\n\r\n  // Either zero?\r\n  if (!xc[0] || !yc[0]) {\r\n    if (!yc[0]) {\r\n      if (xc[0]) {\r\n        y = new Big(x);\r\n      } else {\r\n        y.s = x.s;\r\n      }\r\n    }\r\n    return y;\r\n  }\r\n\r\n  xc = xc.slice();\r\n\r\n  // Prepend zeros to equalise exponents.\r\n  // Note: reverse faster than unshifts.\r\n  if (e = xe - ye) {\r\n    if (e > 0) {\r\n      ye = xe;\r\n      t = yc;\r\n    } else {\r\n      e = -e;\r\n      t = xc;\r\n    }\r\n\r\n    t.reverse();\r\n    for (; e--;) t.push(0);\r\n    t.reverse();\r\n  }\r\n\r\n  // Point xc to the longer array.\r\n  if (xc.length - yc.length < 0) {\r\n    t = yc;\r\n    yc = xc;\r\n    xc = t;\r\n  }\r\n\r\n  e = yc.length;\r\n\r\n  // Only start adding at yc.length - 1 as the further digits of xc can be left as they are.\r\n  for (k = 0; e; xc[e] %= 10) k = (xc[--e] = xc[e] + yc[e] + k) / 10 | 0;\r\n\r\n  // No need to check for zero, as +x + +y != 0 && -x + -y != 0\r\n\r\n  if (k) {\r\n    xc.unshift(k);\r\n    ++ye;\r\n  }\r\n\r\n  // Remove trailing zeros.\r\n  for (e = xc.length; xc[--e] === 0;) xc.pop();\r\n\r\n  y.c = xc;\r\n  y.e = ye;\r\n\r\n  return y;\r\n};\r\n\r\n\r\n/*\r\n * Return a Big whose value is the value of this Big raised to the power n.\r\n * If n is negative, round to a maximum of Big.DP decimal places using rounding\r\n * mode Big.RM.\r\n *\r\n * n {number} Integer, -MAX_POWER to MAX_POWER inclusive.\r\n */\r\nP.pow = function (n) {\r\n  var x = this,\r\n    one = new x.constructor('1'),\r\n    y = one,\r\n    isneg = n < 0;\r\n\r\n  if (n !== ~~n || n < -MAX_POWER || n > MAX_POWER) {\r\n    throw Error(INVALID + 'exponent');\r\n  }\r\n\r\n  if (isneg) n = -n;\r\n\r\n  for (;;) {\r\n    if (n & 1) y = y.times(x);\r\n    n >>= 1;\r\n    if (!n) break;\r\n    x = x.times(x);\r\n  }\r\n\r\n  return isneg ? one.div(y) : y;\r\n};\r\n\r\n\r\n/*\r\n * Return a new Big whose value is the value of this Big rounded to a maximum precision of sd\r\n * significant digits using rounding mode rm, or Big.RM if rm is not specified.\r\n *\r\n * sd {number} Significant digits: integer, 1 to MAX_DP inclusive.\r\n * rm? {number} Rounding mode: 0 (down), 1 (half-up), 2 (half-even) or 3 (up).\r\n */\r\nP.prec = function (sd, rm) {\r\n  if (sd !== ~~sd || sd < 1 || sd > MAX_DP) {\r\n    throw Error(INVALID + 'precision');\r\n  }\r\n  return round(new this.constructor(this), sd, rm);\r\n};\r\n\r\n\r\n/*\r\n * Return a new Big whose value is the value of this Big rounded to a maximum of dp decimal places\r\n * using rounding mode rm, or Big.RM if rm is not specified.\r\n * If dp is negative, round to an integer which is a multiple of 10**-dp.\r\n * If dp is not specified, round to 0 decimal places.\r\n *\r\n * dp? {number} Integer, -MAX_DP to MAX_DP inclusive.\r\n * rm? {number} Rounding mode: 0 (down), 1 (half-up), 2 (half-even) or 3 (up).\r\n */\r\nP.round = function (dp, rm) {\r\n  if (dp === UNDEFINED) dp = 0;\r\n  else if (dp !== ~~dp || dp < -MAX_DP || dp > MAX_DP) {\r\n    throw Error(INVALID_DP);\r\n  }\r\n  return round(new this.constructor(this), dp + this.e + 1, rm);\r\n};\r\n\r\n\r\n/*\r\n * Return a new Big whose value is the square root of the value of this Big, rounded, if\r\n * necessary, to a maximum of Big.DP decimal places using rounding mode Big.RM.\r\n */\r\nP.sqrt = function () {\r\n  var r, c, t,\r\n    x = this,\r\n    Big = x.constructor,\r\n    s = x.s,\r\n    e = x.e,\r\n    half = new Big('0.5');\r\n\r\n  // Zero?\r\n  if (!x.c[0]) return new Big(x);\r\n\r\n  // Negative?\r\n  if (s < 0) {\r\n    throw Error(NAME + 'No square root');\r\n  }\r\n\r\n  // Estimate.\r\n  s = Math.sqrt(x + '');\r\n\r\n  // Math.sqrt underflow/overflow?\r\n  // Re-estimate: pass x coefficient to Math.sqrt as integer, then adjust the result exponent.\r\n  if (s === 0 || s === 1 / 0) {\r\n    c = x.c.join('');\r\n    if (!(c.length + e & 1)) c += '0';\r\n    s = Math.sqrt(c);\r\n    e = ((e + 1) / 2 | 0) - (e < 0 || e & 1);\r\n    r = new Big((s == 1 / 0 ? '5e' : (s = s.toExponential()).slice(0, s.indexOf('e') + 1)) + e);\r\n  } else {\r\n    r = new Big(s + '');\r\n  }\r\n\r\n  e = r.e + (Big.DP += 4);\r\n\r\n  // Newton-Raphson iteration.\r\n  do {\r\n    t = r;\r\n    r = half.times(t.plus(x.div(t)));\r\n  } while (t.c.slice(0, e).join('') !== r.c.slice(0, e).join(''));\r\n\r\n  return round(r, (Big.DP -= 4) + r.e + 1, Big.RM);\r\n};\r\n\r\n\r\n/*\r\n * Return a new Big whose value is the value of this Big times the value of Big y.\r\n */\r\nP.times = P.mul = function (y) {\r\n  var c,\r\n    x = this,\r\n    Big = x.constructor,\r\n    xc = x.c,\r\n    yc = (y = new Big(y)).c,\r\n    a = xc.length,\r\n    b = yc.length,\r\n    i = x.e,\r\n    j = y.e;\r\n\r\n  // Determine sign of result.\r\n  y.s = x.s == y.s ? 1 : -1;\r\n\r\n  // Return signed 0 if either 0.\r\n  if (!xc[0] || !yc[0]) {\r\n    y.c = [y.e = 0];\r\n    return y;\r\n  }\r\n\r\n  // Initialise exponent of result as x.e + y.e.\r\n  y.e = i + j;\r\n\r\n  // If array xc has fewer digits than yc, swap xc and yc, and lengths.\r\n  if (a < b) {\r\n    c = xc;\r\n    xc = yc;\r\n    yc = c;\r\n    j = a;\r\n    a = b;\r\n    b = j;\r\n  }\r\n\r\n  // Initialise coefficient array of result with zeros.\r\n  for (c = new Array(j = a + b); j--;) c[j] = 0;\r\n\r\n  // Multiply.\r\n\r\n  // i is initially xc.length.\r\n  for (i = b; i--;) {\r\n    b = 0;\r\n\r\n    // a is yc.length.\r\n    for (j = a + i; j > i;) {\r\n\r\n      // Current sum of products at this digit position, plus carry.\r\n      b = c[j] + yc[i] * xc[j - i - 1] + b;\r\n      c[j--] = b % 10;\r\n\r\n      // carry\r\n      b = b / 10 | 0;\r\n    }\r\n\r\n    c[j] = b;\r\n  }\r\n\r\n  // Increment result exponent if there is a final carry, otherwise remove leading zero.\r\n  if (b) ++y.e;\r\n  else c.shift();\r\n\r\n  // Remove trailing zeros.\r\n  for (i = c.length; !c[--i];) c.pop();\r\n  y.c = c;\r\n\r\n  return y;\r\n};\r\n\r\n\r\n/*\r\n * Return a string representing the value of this Big in exponential notation rounded to dp fixed\r\n * decimal places using rounding mode rm, or Big.RM if rm is not specified.\r\n *\r\n * dp? {number} Decimal places: integer, 0 to MAX_DP inclusive.\r\n * rm? {number} Rounding mode: 0 (down), 1 (half-up), 2 (half-even) or 3 (up).\r\n */\r\nP.toExponential = function (dp, rm) {\r\n  var x = this,\r\n    n = x.c[0];\r\n\r\n  if (dp !== UNDEFINED) {\r\n    if (dp !== ~~dp || dp < 0 || dp > MAX_DP) {\r\n      throw Error(INVALID_DP);\r\n    }\r\n    x = round(new x.constructor(x), ++dp, rm);\r\n    for (; x.c.length < dp;) x.c.push(0);\r\n  }\r\n\r\n  return stringify(x, true, !!n);\r\n};\r\n\r\n\r\n/*\r\n * Return a string representing the value of this Big in normal notation rounded to dp fixed\r\n * decimal places using rounding mode rm, or Big.RM if rm is not specified.\r\n *\r\n * dp? {number} Decimal places: integer, 0 to MAX_DP inclusive.\r\n * rm? {number} Rounding mode: 0 (down), 1 (half-up), 2 (half-even) or 3 (up).\r\n *\r\n * (-0).toFixed(0) is '0', but (-0.1).toFixed(0) is '-0'.\r\n * (-0).toFixed(1) is '0.0', but (-0.01).toFixed(1) is '-0.0'.\r\n */\r\nP.toFixed = function (dp, rm) {\r\n  var x = this,\r\n    n = x.c[0];\r\n\r\n  if (dp !== UNDEFINED) {\r\n    if (dp !== ~~dp || dp < 0 || dp > MAX_DP) {\r\n      throw Error(INVALID_DP);\r\n    }\r\n    x = round(new x.constructor(x), dp + x.e + 1, rm);\r\n\r\n    // x.e may have changed if the value is rounded up.\r\n    for (dp = dp + x.e + 1; x.c.length < dp;) x.c.push(0);\r\n  }\r\n\r\n  return stringify(x, false, !!n);\r\n};\r\n\r\n\r\n/*\r\n * Return a string representing the value of this Big.\r\n * Return exponential notation if this Big has a positive exponent equal to or greater than\r\n * Big.PE, or a negative exponent equal to or less than Big.NE.\r\n * Omit the sign for negative zero.\r\n */\r\nP[Symbol.for('nodejs.util.inspect.custom')] = P.toJSON = P.toString = function () {\r\n  var x = this,\r\n    Big = x.constructor;\r\n  return stringify(x, x.e <= Big.NE || x.e >= Big.PE, !!x.c[0]);\r\n};\r\n\r\n\r\n/*\r\n * Return the value of this Big as a primitve number.\r\n */\r\nP.toNumber = function () {\r\n  var n = Number(stringify(this, true, true));\r\n  if (this.constructor.strict === true && !this.eq(n.toString())) {\r\n    throw Error(NAME + 'Imprecise conversion');\r\n  }\r\n  return n;\r\n};\r\n\r\n\r\n/*\r\n * Return a string representing the value of this Big rounded to sd significant digits using\r\n * rounding mode rm, or Big.RM if rm is not specified.\r\n * Use exponential notation if sd is less than the number of digits necessary to represent\r\n * the integer part of the value in normal notation.\r\n *\r\n * sd {number} Significant digits: integer, 1 to MAX_DP inclusive.\r\n * rm? {number} Rounding mode: 0 (down), 1 (half-up), 2 (half-even) or 3 (up).\r\n */\r\nP.toPrecision = function (sd, rm) {\r\n  var x = this,\r\n    Big = x.constructor,\r\n    n = x.c[0];\r\n\r\n  if (sd !== UNDEFINED) {\r\n    if (sd !== ~~sd || sd < 1 || sd > MAX_DP) {\r\n      throw Error(INVALID + 'precision');\r\n    }\r\n    x = round(new Big(x), sd, rm);\r\n    for (; x.c.length < sd;) x.c.push(0);\r\n  }\r\n\r\n  return stringify(x, sd <= x.e || x.e <= Big.NE || x.e >= Big.PE, !!n);\r\n};\r\n\r\n\r\n/*\r\n * Return a string representing the value of this Big.\r\n * Return exponential notation if this Big has a positive exponent equal to or greater than\r\n * Big.PE, or a negative exponent equal to or less than Big.NE.\r\n * Include the sign for negative zero.\r\n */\r\nP.valueOf = function () {\r\n  var x = this,\r\n    Big = x.constructor;\r\n  if (Big.strict === true) {\r\n    throw Error(NAME + 'valueOf disallowed');\r\n  }\r\n  return stringify(x, x.e <= Big.NE || x.e >= Big.PE, true);\r\n};\r\n\r\n\r\n// Export\r\n\r\n\r\nexport var Big = _Big_();\r\n\r\n/// <reference types=\"https://raw.githubusercontent.com/DefinitelyTyped/DefinitelyTyped/master/types/big.js/index.d.ts\" />\r\nexport default Big;\r\n","import { DEBUG_MORE } from '../config';\r\nimport { handleError } from './handleError';\r\n\r\nconst SAFE_EXEC_ENABLED = !DEBUG_MORE;\r\n\r\ntype SafeExecOptions = {\r\n  rescue?: (err: Error) => void;\r\n  always?: NoneToVoidFunction;\r\n  shouldIgnoreError?: boolean;\r\n};\r\n\r\nexport async function safeExecAsync<T extends AnyAsyncFunction>(\r\n  cb: T,\r\n  options?: SafeExecOptions,\r\n): Promise<ReturnType<T> | undefined> {\r\n  if (!SAFE_EXEC_ENABLED) {\r\n    return cb();\r\n  }\r\n\r\n  const { rescue, always, shouldIgnoreError } = options ?? {};\r\n\r\n  try {\r\n    return await cb();\r\n  } catch (err: any) {\r\n    rescue?.(err);\r\n    if (!shouldIgnoreError) {\r\n      handleError(err);\r\n    }\r\n    return undefined;\r\n  } finally {\r\n    always?.();\r\n  }\r\n}\r\n\r\nexport default function safeExec<T extends AnyFunction>(cb: T, options?: SafeExecOptions): ReturnType<T> | undefined {\r\n  if (!SAFE_EXEC_ENABLED) {\r\n    return cb();\r\n  }\r\n\r\n  const { rescue, always, shouldIgnoreError } = options ?? {};\r\n\r\n  try {\r\n    return cb();\r\n  } catch (err: any) {\r\n    rescue?.(err);\r\n    if (!shouldIgnoreError) {\r\n      handleError(err);\r\n    }\r\n    return undefined;\r\n  } finally {\r\n    always?.();\r\n  }\r\n}\r\n","const denyList = new Set([\r\n  'ENOTFOUND',\r\n  'ENETUNREACH',\r\n\r\n  // SSL errors from https://github.com/nodejs/node/blob/fc8e3e2cdc521978351de257030db0076d79e0ab/src/crypto/crypto_common.cc#L301-L328\r\n  'UNABLE_TO_GET_ISSUER_CERT',\r\n  'UNABLE_TO_GET_CRL',\r\n  'UNABLE_TO_DECRYPT_CERT_SIGNATURE',\r\n  'UNABLE_TO_DECRYPT_CRL_SIGNATURE',\r\n  'UNABLE_TO_DECODE_ISSUER_PUBLIC_KEY',\r\n  'CERT_SIGNATURE_FAILURE',\r\n  'CRL_SIGNATURE_FAILURE',\r\n  'CERT_NOT_YET_VALID',\r\n  'CERT_HAS_EXPIRED',\r\n  'CRL_NOT_YET_VALID',\r\n  'CRL_HAS_EXPIRED',\r\n  'ERROR_IN_CERT_NOT_BEFORE_FIELD',\r\n  'ERROR_IN_CERT_NOT_AFTER_FIELD',\r\n  'ERROR_IN_CRL_LAST_UPDATE_FIELD',\r\n  'ERROR_IN_CRL_NEXT_UPDATE_FIELD',\r\n  'OUT_OF_MEM',\r\n  'DEPTH_ZERO_SELF_SIGNED_CERT',\r\n  'SELF_SIGNED_CERT_IN_CHAIN',\r\n  'UNABLE_TO_GET_ISSUER_CERT_LOCALLY',\r\n  'UNABLE_TO_VERIFY_LEAF_SIGNATURE',\r\n  'CERT_CHAIN_TOO_LONG',\r\n  'CERT_REVOKED',\r\n  'INVALID_CA',\r\n  'PATH_LENGTH_EXCEEDED',\r\n  'INVALID_PURPOSE',\r\n  'CERT_UNTRUSTED',\r\n  'CERT_REJECTED',\r\n  'HOSTNAME_MISMATCH'\r\n]);\r\n\r\n// TODO: Use `error?.code` when targeting Node.js 14\r\nexport default function isRetryAllowed(error) {\r\n  return !denyList.has(error && error.code);\r\n}\r\n","// Version 1.7.3\r\n(function (global, factory) {\r\n  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\r\n    typeof define === 'function' && define.amd ? define(['exports'], factory) :\r\n      (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.nobleEd25519 = {}));\r\n})(this, (function (exports) { 'use strict';\r\n\r\n  const _nodeResolve_empty = {};\r\n\r\n  const nodeCrypto = /*#__PURE__*/Object.freeze({\r\n    __proto__: null,\r\n    'default': _nodeResolve_empty\r\n  });\r\n\r\n  /*! noble-ed25519 - MIT License (c) 2019 Paul Miller (paulmillr.com) */\r\n  const _0n = BigInt(0);\r\n  const _1n = BigInt(1);\r\n  const _2n = BigInt(2);\r\n  const _8n = BigInt(8);\r\n  const CU_O = BigInt('7237005577332262213973186563042994240857116359379907606001950938285454250989');\r\n  const CURVE = Object.freeze({\r\n    a: BigInt(-1),\r\n    d: BigInt('37095705934669439343138083508754565189542113879843219016388785533085940283555'),\r\n    P: BigInt('57896044618658097711785492504343953926634992332820282019728792003956564819949'),\r\n    l: CU_O,\r\n    n: CU_O,\r\n    h: BigInt(8),\r\n    Gx: BigInt('15112221349535400772501151409588531511454012693041857206046113283949847762202'),\r\n    Gy: BigInt('46316835694926478169428394003475163141307993866256225615783033603165251855960'),\r\n  });\r\n  const POW_2_256 = BigInt('0x10000000000000000000000000000000000000000000000000000000000000000');\r\n  const SQRT_M1 = BigInt('19681161376707505956807079304988542015446066515923890162744021073123829784752');\r\n  BigInt('6853475219497561581579357271197624642482790079785650197046958215289687604742');\r\n  const SQRT_AD_MINUS_ONE = BigInt('25063068953384623474111414158702152701244531502492656460079210482610430750235');\r\n  const INVSQRT_A_MINUS_D = BigInt('54469307008909316920995813868745141605393597292927456921205312896311721017578');\r\n  const ONE_MINUS_D_SQ = BigInt('1159843021668779879193775521855586647937357759715417654439879720876111806838');\r\n  const D_MINUS_ONE_SQ = BigInt('40440834346308536858101042469323190826248399146238708352240133220865137265952');\r\n  class ExtendedPoint {\r\n    constructor(x, y, z, t) {\r\n      this.x = x;\r\n      this.y = y;\r\n      this.z = z;\r\n      this.t = t;\r\n    }\r\n    static fromAffine(p) {\r\n      if (!(p instanceof Point)) {\r\n        throw new TypeError('ExtendedPoint#fromAffine: expected Point');\r\n      }\r\n      if (p.equals(Point.ZERO))\r\n        return ExtendedPoint.ZERO;\r\n      return new ExtendedPoint(p.x, p.y, _1n, mod(p.x * p.y));\r\n    }\r\n    static toAffineBatch(points) {\r\n      const toInv = invertBatch(points.map((p) => p.z));\r\n      return points.map((p, i) => p.toAffine(toInv[i]));\r\n    }\r\n    static normalizeZ(points) {\r\n      return this.toAffineBatch(points).map(this.fromAffine);\r\n    }\r\n    equals(other) {\r\n      assertExtPoint(other);\r\n      const { x: X1, y: Y1, z: Z1 } = this;\r\n      const { x: X2, y: Y2, z: Z2 } = other;\r\n      const X1Z2 = mod(X1 * Z2);\r\n      const X2Z1 = mod(X2 * Z1);\r\n      const Y1Z2 = mod(Y1 * Z2);\r\n      const Y2Z1 = mod(Y2 * Z1);\r\n      return X1Z2 === X2Z1 && Y1Z2 === Y2Z1;\r\n    }\r\n    negate() {\r\n      return new ExtendedPoint(mod(-this.x), this.y, this.z, mod(-this.t));\r\n    }\r\n    double() {\r\n      const { x: X1, y: Y1, z: Z1 } = this;\r\n      const { a } = CURVE;\r\n      const A = mod(X1 * X1);\r\n      const B = mod(Y1 * Y1);\r\n      const C = mod(_2n * mod(Z1 * Z1));\r\n      const D = mod(a * A);\r\n      const x1y1 = X1 + Y1;\r\n      const E = mod(mod(x1y1 * x1y1) - A - B);\r\n      const G = D + B;\r\n      const F = G - C;\r\n      const H = D - B;\r\n      const X3 = mod(E * F);\r\n      const Y3 = mod(G * H);\r\n      const T3 = mod(E * H);\r\n      const Z3 = mod(F * G);\r\n      return new ExtendedPoint(X3, Y3, Z3, T3);\r\n    }\r\n    add(other) {\r\n      assertExtPoint(other);\r\n      const { x: X1, y: Y1, z: Z1, t: T1 } = this;\r\n      const { x: X2, y: Y2, z: Z2, t: T2 } = other;\r\n      const A = mod((Y1 - X1) * (Y2 + X2));\r\n      const B = mod((Y1 + X1) * (Y2 - X2));\r\n      const F = mod(B - A);\r\n      if (F === _0n)\r\n        return this.double();\r\n      const C = mod(Z1 * _2n * T2);\r\n      const D = mod(T1 * _2n * Z2);\r\n      const E = D + C;\r\n      const G = B + A;\r\n      const H = D - C;\r\n      const X3 = mod(E * F);\r\n      const Y3 = mod(G * H);\r\n      const T3 = mod(E * H);\r\n      const Z3 = mod(F * G);\r\n      return new ExtendedPoint(X3, Y3, Z3, T3);\r\n    }\r\n    subtract(other) {\r\n      return this.add(other.negate());\r\n    }\r\n    precomputeWindow(W) {\r\n      const windows = 1 + 256 / W;\r\n      const points = [];\r\n      let p = this;\r\n      let base = p;\r\n      for (let window = 0; window < windows; window++) {\r\n        base = p;\r\n        points.push(base);\r\n        for (let i = 1; i < 2 ** (W - 1); i++) {\r\n          base = base.add(p);\r\n          points.push(base);\r\n        }\r\n        p = base.double();\r\n      }\r\n      return points;\r\n    }\r\n    wNAF(n, affinePoint) {\r\n      if (!affinePoint && this.equals(ExtendedPoint.BASE))\r\n        affinePoint = Point.BASE;\r\n      const W = (affinePoint && affinePoint._WINDOW_SIZE) || 1;\r\n      if (256 % W) {\r\n        throw new Error('Point#wNAF: Invalid precomputation window, must be power of 2');\r\n      }\r\n      let precomputes = affinePoint && pointPrecomputes.get(affinePoint);\r\n      if (!precomputes) {\r\n        precomputes = this.precomputeWindow(W);\r\n        if (affinePoint && W !== 1) {\r\n          precomputes = ExtendedPoint.normalizeZ(precomputes);\r\n          pointPrecomputes.set(affinePoint, precomputes);\r\n        }\r\n      }\r\n      let p = ExtendedPoint.ZERO;\r\n      let f = ExtendedPoint.BASE;\r\n      const windows = 1 + 256 / W;\r\n      const windowSize = 2 ** (W - 1);\r\n      const mask = BigInt(2 ** W - 1);\r\n      const maxNumber = 2 ** W;\r\n      const shiftBy = BigInt(W);\r\n      for (let window = 0; window < windows; window++) {\r\n        const offset = window * windowSize;\r\n        let wbits = Number(n & mask);\r\n        n >>= shiftBy;\r\n        if (wbits > windowSize) {\r\n          wbits -= maxNumber;\r\n          n += _1n;\r\n        }\r\n        const offset1 = offset;\r\n        const offset2 = offset + Math.abs(wbits) - 1;\r\n        const cond1 = window % 2 !== 0;\r\n        const cond2 = wbits < 0;\r\n        if (wbits === 0) {\r\n          f = f.add(constTimeNegate(cond1, precomputes[offset1]));\r\n        }\r\n        else {\r\n          p = p.add(constTimeNegate(cond2, precomputes[offset2]));\r\n        }\r\n      }\r\n      return ExtendedPoint.normalizeZ([p, f])[0];\r\n    }\r\n    multiply(scalar, affinePoint) {\r\n      return this.wNAF(normalizeScalar(scalar, CURVE.l), affinePoint);\r\n    }\r\n    multiplyUnsafe(scalar) {\r\n      let n = normalizeScalar(scalar, CURVE.l, false);\r\n      const G = ExtendedPoint.BASE;\r\n      const P0 = ExtendedPoint.ZERO;\r\n      if (n === _0n)\r\n        return P0;\r\n      if (this.equals(P0) || n === _1n)\r\n        return this;\r\n      if (this.equals(G))\r\n        return this.wNAF(n);\r\n      let p = P0;\r\n      let d = this;\r\n      while (n > _0n) {\r\n        if (n & _1n)\r\n          p = p.add(d);\r\n        d = d.double();\r\n        n >>= _1n;\r\n      }\r\n      return p;\r\n    }\r\n    isSmallOrder() {\r\n      return this.multiplyUnsafe(CURVE.h).equals(ExtendedPoint.ZERO);\r\n    }\r\n    isTorsionFree() {\r\n      let p = this.multiplyUnsafe(CURVE.l / _2n).double();\r\n      if (CURVE.l % _2n)\r\n        p = p.add(this);\r\n      return p.equals(ExtendedPoint.ZERO);\r\n    }\r\n    toAffine(invZ) {\r\n      const { x, y, z } = this;\r\n      const is0 = this.equals(ExtendedPoint.ZERO);\r\n      if (invZ == null)\r\n        invZ = is0 ? _8n : invert(z);\r\n      const ax = mod(x * invZ);\r\n      const ay = mod(y * invZ);\r\n      const zz = mod(z * invZ);\r\n      if (is0)\r\n        return Point.ZERO;\r\n      if (zz !== _1n)\r\n        throw new Error('invZ was invalid');\r\n      return new Point(ax, ay);\r\n    }\r\n    fromRistrettoBytes() {\r\n      legacyRist();\r\n    }\r\n    toRistrettoBytes() {\r\n      legacyRist();\r\n    }\r\n    fromRistrettoHash() {\r\n      legacyRist();\r\n    }\r\n  }\r\n  ExtendedPoint.BASE = new ExtendedPoint(CURVE.Gx, CURVE.Gy, _1n, mod(CURVE.Gx * CURVE.Gy));\r\n  ExtendedPoint.ZERO = new ExtendedPoint(_0n, _1n, _1n, _0n);\r\n  function constTimeNegate(condition, item) {\r\n    const neg = item.negate();\r\n    return condition ? neg : item;\r\n  }\r\n  function assertExtPoint(other) {\r\n    if (!(other instanceof ExtendedPoint))\r\n      throw new TypeError('ExtendedPoint expected');\r\n  }\r\n  function assertRstPoint(other) {\r\n    if (!(other instanceof RistrettoPoint))\r\n      throw new TypeError('RistrettoPoint expected');\r\n  }\r\n  function legacyRist() {\r\n    throw new Error('Legacy method: switch to RistrettoPoint');\r\n  }\r\n  class RistrettoPoint {\r\n    constructor(ep) {\r\n      this.ep = ep;\r\n    }\r\n    static calcElligatorRistrettoMap(r0) {\r\n      const { d } = CURVE;\r\n      const r = mod(SQRT_M1 * r0 * r0);\r\n      const Ns = mod((r + _1n) * ONE_MINUS_D_SQ);\r\n      let c = BigInt(-1);\r\n      const D = mod((c - d * r) * mod(r + d));\r\n      let { isValid: Ns_D_is_sq, value: s } = uvRatio(Ns, D);\r\n      let s_ = mod(s * r0);\r\n      if (!edIsNegative(s_))\r\n        s_ = mod(-s_);\r\n      if (!Ns_D_is_sq)\r\n        s = s_;\r\n      if (!Ns_D_is_sq)\r\n        c = r;\r\n      const Nt = mod(c * (r - _1n) * D_MINUS_ONE_SQ - D);\r\n      const s2 = s * s;\r\n      const W0 = mod((s + s) * D);\r\n      const W1 = mod(Nt * SQRT_AD_MINUS_ONE);\r\n      const W2 = mod(_1n - s2);\r\n      const W3 = mod(_1n + s2);\r\n      return new ExtendedPoint(mod(W0 * W3), mod(W2 * W1), mod(W1 * W3), mod(W0 * W2));\r\n    }\r\n    static hashToCurve(hex) {\r\n      hex = ensureBytes(hex, 64);\r\n      const r1 = bytes255ToNumberLE(hex.slice(0, 32));\r\n      const R1 = this.calcElligatorRistrettoMap(r1);\r\n      const r2 = bytes255ToNumberLE(hex.slice(32, 64));\r\n      const R2 = this.calcElligatorRistrettoMap(r2);\r\n      return new RistrettoPoint(R1.add(R2));\r\n    }\r\n    static fromHex(hex) {\r\n      hex = ensureBytes(hex, 32);\r\n      const { a, d } = CURVE;\r\n      const emsg = 'RistrettoPoint.fromHex: the hex is not valid encoding of RistrettoPoint';\r\n      const s = bytes255ToNumberLE(hex);\r\n      if (!equalBytes(numberTo32BytesLE(s), hex) || edIsNegative(s))\r\n        throw new Error(emsg);\r\n      const s2 = mod(s * s);\r\n      const u1 = mod(_1n + a * s2);\r\n      const u2 = mod(_1n - a * s2);\r\n      const u1_2 = mod(u1 * u1);\r\n      const u2_2 = mod(u2 * u2);\r\n      const v = mod(a * d * u1_2 - u2_2);\r\n      const { isValid, value: I } = invertSqrt(mod(v * u2_2));\r\n      const Dx = mod(I * u2);\r\n      const Dy = mod(I * Dx * v);\r\n      let x = mod((s + s) * Dx);\r\n      if (edIsNegative(x))\r\n        x = mod(-x);\r\n      const y = mod(u1 * Dy);\r\n      const t = mod(x * y);\r\n      if (!isValid || edIsNegative(t) || y === _0n)\r\n        throw new Error(emsg);\r\n      return new RistrettoPoint(new ExtendedPoint(x, y, _1n, t));\r\n    }\r\n    toRawBytes() {\r\n      let { x, y, z, t } = this.ep;\r\n      const u1 = mod(mod(z + y) * mod(z - y));\r\n      const u2 = mod(x * y);\r\n      const u2sq = mod(u2 * u2);\r\n      const { value: invsqrt } = invertSqrt(mod(u1 * u2sq));\r\n      const D1 = mod(invsqrt * u1);\r\n      const D2 = mod(invsqrt * u2);\r\n      const zInv = mod(D1 * D2 * t);\r\n      let D;\r\n      if (edIsNegative(t * zInv)) {\r\n        let _x = mod(y * SQRT_M1);\r\n        let _y = mod(x * SQRT_M1);\r\n        x = _x;\r\n        y = _y;\r\n        D = mod(D1 * INVSQRT_A_MINUS_D);\r\n      }\r\n      else {\r\n        D = D2;\r\n      }\r\n      if (edIsNegative(x * zInv))\r\n        y = mod(-y);\r\n      let s = mod((z - y) * D);\r\n      if (edIsNegative(s))\r\n        s = mod(-s);\r\n      return numberTo32BytesLE(s);\r\n    }\r\n    toHex() {\r\n      return bytesToHex(this.toRawBytes());\r\n    }\r\n    toString() {\r\n      return this.toHex();\r\n    }\r\n    equals(other) {\r\n      assertRstPoint(other);\r\n      const a = this.ep;\r\n      const b = other.ep;\r\n      const one = mod(a.x * b.y) === mod(a.y * b.x);\r\n      const two = mod(a.y * b.y) === mod(a.x * b.x);\r\n      return one || two;\r\n    }\r\n    add(other) {\r\n      assertRstPoint(other);\r\n      return new RistrettoPoint(this.ep.add(other.ep));\r\n    }\r\n    subtract(other) {\r\n      assertRstPoint(other);\r\n      return new RistrettoPoint(this.ep.subtract(other.ep));\r\n    }\r\n    multiply(scalar) {\r\n      return new RistrettoPoint(this.ep.multiply(scalar));\r\n    }\r\n    multiplyUnsafe(scalar) {\r\n      return new RistrettoPoint(this.ep.multiplyUnsafe(scalar));\r\n    }\r\n  }\r\n  RistrettoPoint.BASE = new RistrettoPoint(ExtendedPoint.BASE);\r\n  RistrettoPoint.ZERO = new RistrettoPoint(ExtendedPoint.ZERO);\r\n  const pointPrecomputes = new WeakMap();\r\n  class Point {\r\n    constructor(x, y) {\r\n      this.x = x;\r\n      this.y = y;\r\n    }\r\n    _setWindowSize(windowSize) {\r\n      this._WINDOW_SIZE = windowSize;\r\n      pointPrecomputes.delete(this);\r\n    }\r\n    static fromHex(hex, strict = true) {\r\n      const { d, P } = CURVE;\r\n      hex = ensureBytes(hex, 32);\r\n      const normed = hex.slice();\r\n      normed[31] = hex[31] & ~0x80;\r\n      const y = bytesToNumberLE(normed);\r\n      if (strict && y >= P)\r\n        throw new Error('Expected 0 < hex < P');\r\n      if (!strict && y >= POW_2_256)\r\n        throw new Error('Expected 0 < hex < 2**256');\r\n      const y2 = mod(y * y);\r\n      const u = mod(y2 - _1n);\r\n      const v = mod(d * y2 + _1n);\r\n      let { isValid, value: x } = uvRatio(u, v);\r\n      if (!isValid)\r\n        throw new Error('Point.fromHex: invalid y coordinate');\r\n      const isXOdd = (x & _1n) === _1n;\r\n      const isLastByteOdd = (hex[31] & 0x80) !== 0;\r\n      if (isLastByteOdd !== isXOdd) {\r\n        x = mod(-x);\r\n      }\r\n      return new Point(x, y);\r\n    }\r\n    static async fromPrivateKey(privateKey) {\r\n      return (await getExtendedPublicKey(privateKey)).point;\r\n    }\r\n    toRawBytes() {\r\n      const bytes = numberTo32BytesLE(this.y);\r\n      bytes[31] |= this.x & _1n ? 0x80 : 0;\r\n      return bytes;\r\n    }\r\n    toHex() {\r\n      return bytesToHex(this.toRawBytes());\r\n    }\r\n    toX25519() {\r\n      const { y } = this;\r\n      const u = mod((_1n + y) * invert(_1n - y));\r\n      return numberTo32BytesLE(u);\r\n    }\r\n    isTorsionFree() {\r\n      return ExtendedPoint.fromAffine(this).isTorsionFree();\r\n    }\r\n    equals(other) {\r\n      return this.x === other.x && this.y === other.y;\r\n    }\r\n    negate() {\r\n      return new Point(mod(-this.x), this.y);\r\n    }\r\n    add(other) {\r\n      return ExtendedPoint.fromAffine(this).add(ExtendedPoint.fromAffine(other)).toAffine();\r\n    }\r\n    subtract(other) {\r\n      return this.add(other.negate());\r\n    }\r\n    multiply(scalar) {\r\n      return ExtendedPoint.fromAffine(this).multiply(scalar, this).toAffine();\r\n    }\r\n  }\r\n  Point.BASE = new Point(CURVE.Gx, CURVE.Gy);\r\n  Point.ZERO = new Point(_0n, _1n);\r\n  class Signature {\r\n    constructor(r, s) {\r\n      this.r = r;\r\n      this.s = s;\r\n      this.assertValidity();\r\n    }\r\n    static fromHex(hex) {\r\n      const bytes = ensureBytes(hex, 64);\r\n      const r = Point.fromHex(bytes.slice(0, 32), false);\r\n      const s = bytesToNumberLE(bytes.slice(32, 64));\r\n      return new Signature(r, s);\r\n    }\r\n    assertValidity() {\r\n      const { r, s } = this;\r\n      if (!(r instanceof Point))\r\n        throw new Error('Expected Point instance');\r\n      normalizeScalar(s, CURVE.l, false);\r\n      return this;\r\n    }\r\n    toRawBytes() {\r\n      const u8 = new Uint8Array(64);\r\n      u8.set(this.r.toRawBytes());\r\n      u8.set(numberTo32BytesLE(this.s), 32);\r\n      return u8;\r\n    }\r\n    toHex() {\r\n      return bytesToHex(this.toRawBytes());\r\n    }\r\n  }\r\n  function concatBytes(...arrays) {\r\n    if (!arrays.every((a) => a instanceof Uint8Array))\r\n      throw new Error('Expected Uint8Array list');\r\n    if (arrays.length === 1)\r\n      return arrays[0];\r\n    const length = arrays.reduce((a, arr) => a + arr.length, 0);\r\n    const result = new Uint8Array(length);\r\n    for (let i = 0, pad = 0; i < arrays.length; i++) {\r\n      const arr = arrays[i];\r\n      result.set(arr, pad);\r\n      pad += arr.length;\r\n    }\r\n    return result;\r\n  }\r\n  const hexes = Array.from({ length: 256 }, (v, i) => i.toString(16).padStart(2, '0'));\r\n  function bytesToHex(uint8a) {\r\n    if (!(uint8a instanceof Uint8Array))\r\n      throw new Error('Uint8Array expected');\r\n    let hex = '';\r\n    for (let i = 0; i < uint8a.length; i++) {\r\n      hex += hexes[uint8a[i]];\r\n    }\r\n    return hex;\r\n  }\r\n  function hexToBytes(hex) {\r\n    if (typeof hex !== 'string') {\r\n      throw new TypeError('hexToBytes: expected string, got ' + typeof hex);\r\n    }\r\n    if (hex.length % 2)\r\n      throw new Error('hexToBytes: received invalid unpadded hex');\r\n    const array = new Uint8Array(hex.length / 2);\r\n    for (let i = 0; i < array.length; i++) {\r\n      const j = i * 2;\r\n      const hexByte = hex.slice(j, j + 2);\r\n      const byte = Number.parseInt(hexByte, 16);\r\n      if (Number.isNaN(byte) || byte < 0)\r\n        throw new Error('Invalid byte sequence');\r\n      array[i] = byte;\r\n    }\r\n    return array;\r\n  }\r\n  function numberTo32BytesBE(num) {\r\n    const length = 32;\r\n    const hex = num.toString(16).padStart(length * 2, '0');\r\n    return hexToBytes(hex);\r\n  }\r\n  function numberTo32BytesLE(num) {\r\n    return numberTo32BytesBE(num).reverse();\r\n  }\r\n  function edIsNegative(num) {\r\n    return (mod(num) & _1n) === _1n;\r\n  }\r\n  function bytesToNumberLE(uint8a) {\r\n    if (!(uint8a instanceof Uint8Array))\r\n      throw new Error('Expected Uint8Array');\r\n    return BigInt('0x' + bytesToHex(Uint8Array.from(uint8a).reverse()));\r\n  }\r\n  const MAX_255B = BigInt('0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff');\r\n  function bytes255ToNumberLE(bytes) {\r\n    return mod(bytesToNumberLE(bytes) & MAX_255B);\r\n  }\r\n  function mod(a, b = CURVE.P) {\r\n    const res = a % b;\r\n    return res >= _0n ? res : b + res;\r\n  }\r\n  function invert(number, modulo = CURVE.P) {\r\n    if (number === _0n || modulo <= _0n) {\r\n      throw new Error(`invert: expected positive integers, got n=${number} mod=${modulo}`);\r\n    }\r\n    let a = mod(number, modulo);\r\n    let b = modulo;\r\n    let x = _0n, u = _1n;\r\n    while (a !== _0n) {\r\n      const q = b / a;\r\n      const r = b % a;\r\n      const m = x - u * q;\r\n      b = a, a = r, x = u, u = m;\r\n    }\r\n    const gcd = b;\r\n    if (gcd !== _1n)\r\n      throw new Error('invert: does not exist');\r\n    return mod(x, modulo);\r\n  }\r\n  function invertBatch(nums, p = CURVE.P) {\r\n    const tmp = new Array(nums.length);\r\n    const lastMultiplied = nums.reduce((acc, num, i) => {\r\n      if (num === _0n)\r\n        return acc;\r\n      tmp[i] = acc;\r\n      return mod(acc * num, p);\r\n    }, _1n);\r\n    const inverted = invert(lastMultiplied, p);\r\n    nums.reduceRight((acc, num, i) => {\r\n      if (num === _0n)\r\n        return acc;\r\n      tmp[i] = mod(acc * tmp[i], p);\r\n      return mod(acc * num, p);\r\n    }, inverted);\r\n    return tmp;\r\n  }\r\n  function pow2(x, power) {\r\n    const { P } = CURVE;\r\n    let res = x;\r\n    while (power-- > _0n) {\r\n      res *= res;\r\n      res %= P;\r\n    }\r\n    return res;\r\n  }\r\n  function pow_2_252_3(x) {\r\n    const { P } = CURVE;\r\n    const _5n = BigInt(5);\r\n    const _10n = BigInt(10);\r\n    const _20n = BigInt(20);\r\n    const _40n = BigInt(40);\r\n    const _80n = BigInt(80);\r\n    const x2 = (x * x) % P;\r\n    const b2 = (x2 * x) % P;\r\n    const b4 = (pow2(b2, _2n) * b2) % P;\r\n    const b5 = (pow2(b4, _1n) * x) % P;\r\n    const b10 = (pow2(b5, _5n) * b5) % P;\r\n    const b20 = (pow2(b10, _10n) * b10) % P;\r\n    const b40 = (pow2(b20, _20n) * b20) % P;\r\n    const b80 = (pow2(b40, _40n) * b40) % P;\r\n    const b160 = (pow2(b80, _80n) * b80) % P;\r\n    const b240 = (pow2(b160, _80n) * b80) % P;\r\n    const b250 = (pow2(b240, _10n) * b10) % P;\r\n    const pow_p_5_8 = (pow2(b250, _2n) * x) % P;\r\n    return { pow_p_5_8, b2 };\r\n  }\r\n  function uvRatio(u, v) {\r\n    const v3 = mod(v * v * v);\r\n    const v7 = mod(v3 * v3 * v);\r\n    const pow = pow_2_252_3(u * v7).pow_p_5_8;\r\n    let x = mod(u * v3 * pow);\r\n    const vx2 = mod(v * x * x);\r\n    const root1 = x;\r\n    const root2 = mod(x * SQRT_M1);\r\n    const useRoot1 = vx2 === u;\r\n    const useRoot2 = vx2 === mod(-u);\r\n    const noRoot = vx2 === mod(-u * SQRT_M1);\r\n    if (useRoot1)\r\n      x = root1;\r\n    if (useRoot2 || noRoot)\r\n      x = root2;\r\n    if (edIsNegative(x))\r\n      x = mod(-x);\r\n    return { isValid: useRoot1 || useRoot2, value: x };\r\n  }\r\n  function invertSqrt(number) {\r\n    return uvRatio(_1n, number);\r\n  }\r\n  function modlLE(hash) {\r\n    return mod(bytesToNumberLE(hash), CURVE.l);\r\n  }\r\n  function equalBytes(b1, b2) {\r\n    if (b1.length !== b2.length) {\r\n      return false;\r\n    }\r\n    for (let i = 0; i < b1.length; i++) {\r\n      if (b1[i] !== b2[i]) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n  function ensureBytes(hex, expectedLength) {\r\n    const bytes = hex instanceof Uint8Array ? Uint8Array.from(hex) : hexToBytes(hex);\r\n    if (typeof expectedLength === 'number' && bytes.length !== expectedLength)\r\n      throw new Error(`Expected ${expectedLength} bytes`);\r\n    return bytes;\r\n  }\r\n  function normalizeScalar(num, max, strict = true) {\r\n    if (!max)\r\n      throw new TypeError('Specify max value');\r\n    if (typeof num === 'number' && Number.isSafeInteger(num))\r\n      num = BigInt(num);\r\n    if (typeof num === 'bigint' && num < max) {\r\n      if (strict) {\r\n        if (_0n < num)\r\n          return num;\r\n      }\r\n      else {\r\n        if (_0n <= num)\r\n          return num;\r\n      }\r\n    }\r\n    throw new TypeError('Expected valid scalar: 0 < scalar < max');\r\n  }\r\n  function adjustBytes25519(bytes) {\r\n    bytes[0] &= 248;\r\n    bytes[31] &= 127;\r\n    bytes[31] |= 64;\r\n    return bytes;\r\n  }\r\n  function decodeScalar25519(n) {\r\n    return bytesToNumberLE(adjustBytes25519(ensureBytes(n, 32)));\r\n  }\r\n  function checkPrivateKey(key) {\r\n    key =\r\n      typeof key === 'bigint' || typeof key === 'number'\r\n        ? numberTo32BytesBE(normalizeScalar(key, POW_2_256))\r\n        : ensureBytes(key);\r\n    if (key.length !== 32)\r\n      throw new Error(`Expected 32 bytes`);\r\n    return key;\r\n  }\r\n  function getKeyFromHash(hashed) {\r\n    const head = adjustBytes25519(hashed.slice(0, 32));\r\n    const prefix = hashed.slice(32, 64);\r\n    const scalar = modlLE(head);\r\n    const point = Point.BASE.multiply(scalar);\r\n    const pointBytes = point.toRawBytes();\r\n    return { head, prefix, scalar, point, pointBytes };\r\n  }\r\n  let _sha512Sync;\r\n  function sha512s(...m) {\r\n    if (typeof _sha512Sync !== 'function')\r\n      throw new Error('utils.sha512Sync must be set to use sync methods');\r\n    return _sha512Sync(...m);\r\n  }\r\n  async function getExtendedPublicKey(key) {\r\n    return getKeyFromHash(await utils.sha512(checkPrivateKey(key)));\r\n  }\r\n  function getExtendedPublicKeySync(key) {\r\n    return getKeyFromHash(sha512s(checkPrivateKey(key)));\r\n  }\r\n  async function getPublicKey(privateKey) {\r\n    return (await getExtendedPublicKey(privateKey)).pointBytes;\r\n  }\r\n  function getPublicKeySync(privateKey) {\r\n    return getExtendedPublicKeySync(privateKey).pointBytes;\r\n  }\r\n  async function sign(message, privateKey) {\r\n    message = ensureBytes(message);\r\n    const { prefix, scalar, pointBytes } = await getExtendedPublicKey(privateKey);\r\n    const r = modlLE(await utils.sha512(prefix, message));\r\n    const R = Point.BASE.multiply(r);\r\n    const k = modlLE(await utils.sha512(R.toRawBytes(), pointBytes, message));\r\n    const s = mod(r + k * scalar, CURVE.l);\r\n    return new Signature(R, s).toRawBytes();\r\n  }\r\n  function signSync(message, privateKey) {\r\n    message = ensureBytes(message);\r\n    const { prefix, scalar, pointBytes } = getExtendedPublicKeySync(privateKey);\r\n    const r = modlLE(sha512s(prefix, message));\r\n    const R = Point.BASE.multiply(r);\r\n    const k = modlLE(sha512s(R.toRawBytes(), pointBytes, message));\r\n    const s = mod(r + k * scalar, CURVE.l);\r\n    return new Signature(R, s).toRawBytes();\r\n  }\r\n  function prepareVerification(sig, message, publicKey) {\r\n    message = ensureBytes(message);\r\n    if (!(publicKey instanceof Point))\r\n      publicKey = Point.fromHex(publicKey, false);\r\n    const { r, s } = sig instanceof Signature ? sig.assertValidity() : Signature.fromHex(sig);\r\n    const SB = ExtendedPoint.BASE.multiplyUnsafe(s);\r\n    return { r, s, SB, pub: publicKey, msg: message };\r\n  }\r\n  function finishVerification(publicKey, r, SB, hashed) {\r\n    const k = modlLE(hashed);\r\n    const kA = ExtendedPoint.fromAffine(publicKey).multiplyUnsafe(k);\r\n    const RkA = ExtendedPoint.fromAffine(r).add(kA);\r\n    return RkA.subtract(SB).multiplyUnsafe(CURVE.h).equals(ExtendedPoint.ZERO);\r\n  }\r\n  async function verify(sig, message, publicKey) {\r\n    const { r, SB, msg, pub } = prepareVerification(sig, message, publicKey);\r\n    const hashed = await utils.sha512(r.toRawBytes(), pub.toRawBytes(), msg);\r\n    return finishVerification(pub, r, SB, hashed);\r\n  }\r\n  function verifySync(sig, message, publicKey) {\r\n    const { r, SB, msg, pub } = prepareVerification(sig, message, publicKey);\r\n    const hashed = sha512s(r.toRawBytes(), pub.toRawBytes(), msg);\r\n    return finishVerification(pub, r, SB, hashed);\r\n  }\r\n  const sync = {\r\n    getExtendedPublicKey: getExtendedPublicKeySync,\r\n    getPublicKey: getPublicKeySync,\r\n    sign: signSync,\r\n    verify: verifySync,\r\n  };\r\n  async function getSharedSecret(privateKey, publicKey) {\r\n    const { head } = await getExtendedPublicKey(privateKey);\r\n    const u = Point.fromHex(publicKey).toX25519();\r\n    return curve25519.scalarMult(head, u);\r\n  }\r\n  Point.BASE._setWindowSize(8);\r\n  function cswap(swap, x_2, x_3) {\r\n    const dummy = mod(swap * (x_2 - x_3));\r\n    x_2 = mod(x_2 - dummy);\r\n    x_3 = mod(x_3 + dummy);\r\n    return [x_2, x_3];\r\n  }\r\n  function montgomeryLadder(pointU, scalar) {\r\n    const { P } = CURVE;\r\n    const u = normalizeScalar(pointU, P);\r\n    const k = normalizeScalar(scalar, P);\r\n    const a24 = BigInt(121665);\r\n    const x_1 = u;\r\n    let x_2 = _1n;\r\n    let z_2 = _0n;\r\n    let x_3 = u;\r\n    let z_3 = _1n;\r\n    let swap = _0n;\r\n    let sw;\r\n    for (let t = BigInt(255 - 1); t >= _0n; t--) {\r\n      const k_t = (k >> t) & _1n;\r\n      swap ^= k_t;\r\n      sw = cswap(swap, x_2, x_3);\r\n      x_2 = sw[0];\r\n      x_3 = sw[1];\r\n      sw = cswap(swap, z_2, z_3);\r\n      z_2 = sw[0];\r\n      z_3 = sw[1];\r\n      swap = k_t;\r\n      const A = x_2 + z_2;\r\n      const AA = mod(A * A);\r\n      const B = x_2 - z_2;\r\n      const BB = mod(B * B);\r\n      const E = AA - BB;\r\n      const C = x_3 + z_3;\r\n      const D = x_3 - z_3;\r\n      const DA = mod(D * A);\r\n      const CB = mod(C * B);\r\n      const dacb = DA + CB;\r\n      const da_cb = DA - CB;\r\n      x_3 = mod(dacb * dacb);\r\n      z_3 = mod(x_1 * mod(da_cb * da_cb));\r\n      x_2 = mod(AA * BB);\r\n      z_2 = mod(E * (AA + mod(a24 * E)));\r\n    }\r\n    sw = cswap(swap, x_2, x_3);\r\n    x_2 = sw[0];\r\n    x_3 = sw[1];\r\n    sw = cswap(swap, z_2, z_3);\r\n    z_2 = sw[0];\r\n    z_3 = sw[1];\r\n    const { pow_p_5_8, b2 } = pow_2_252_3(z_2);\r\n    const xp2 = mod(pow2(pow_p_5_8, BigInt(3)) * b2);\r\n    return mod(x_2 * xp2);\r\n  }\r\n  function encodeUCoordinate(u) {\r\n    return numberTo32BytesLE(mod(u, CURVE.P));\r\n  }\r\n  function decodeUCoordinate(uEnc) {\r\n    const u = ensureBytes(uEnc, 32);\r\n    u[31] &= 127;\r\n    return bytesToNumberLE(u);\r\n  }\r\n  const curve25519 = {\r\n    BASE_POINT_U: '0900000000000000000000000000000000000000000000000000000000000000',\r\n    scalarMult(privateKey, publicKey) {\r\n      const u = decodeUCoordinate(publicKey);\r\n      const p = decodeScalar25519(privateKey);\r\n      const pu = montgomeryLadder(u, p);\r\n      if (pu === _0n)\r\n        throw new Error('Invalid private or public key received');\r\n      return encodeUCoordinate(pu);\r\n    },\r\n    scalarMultBase(privateKey) {\r\n      return curve25519.scalarMult(privateKey, curve25519.BASE_POINT_U);\r\n    },\r\n  };\r\n  const crypto = {\r\n    node: nodeCrypto,\r\n    web: typeof self === 'object' && 'crypto' in self ? self.crypto : undefined,\r\n  };\r\n  const utils = {\r\n    bytesToHex,\r\n    hexToBytes,\r\n    concatBytes,\r\n    getExtendedPublicKey,\r\n    mod,\r\n    invert,\r\n    TORSION_SUBGROUP: [\r\n      '0100000000000000000000000000000000000000000000000000000000000000',\r\n      'c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac037a',\r\n      '0000000000000000000000000000000000000000000000000000000000000080',\r\n      '26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc05',\r\n      'ecffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7f',\r\n      '26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc85',\r\n      '0000000000000000000000000000000000000000000000000000000000000000',\r\n      'c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac03fa',\r\n    ],\r\n    hashToPrivateScalar: (hash) => {\r\n      hash = ensureBytes(hash);\r\n      if (hash.length < 40 || hash.length > 1024)\r\n        throw new Error('Expected 40-1024 bytes of private key as per FIPS 186');\r\n      return mod(bytesToNumberLE(hash), CURVE.l - _1n) + _1n;\r\n    },\r\n    randomBytes: (bytesLength = 32) => {\r\n      if (crypto.web) {\r\n        return crypto.web.getRandomValues(new Uint8Array(bytesLength));\r\n      }\r\n      else if (crypto.node) {\r\n        const { randomBytes } = crypto.node;\r\n        return new Uint8Array(randomBytes(bytesLength).buffer);\r\n      }\r\n      else {\r\n        throw new Error(\"The environment doesn't have randomBytes function\");\r\n      }\r\n    },\r\n    randomPrivateKey: () => {\r\n      return utils.randomBytes(32);\r\n    },\r\n    sha512: async (...messages) => {\r\n      const message = concatBytes(...messages);\r\n      if (crypto.web) {\r\n        const buffer = await crypto.web.subtle.digest('SHA-512', message.buffer);\r\n        return new Uint8Array(buffer);\r\n      }\r\n      else if (crypto.node) {\r\n        return Uint8Array.from(crypto.node.createHash('sha512').update(message).digest());\r\n      }\r\n      else {\r\n        throw new Error(\"The environment doesn't have sha512 function\");\r\n      }\r\n    },\r\n    precompute(windowSize = 8, point = Point.BASE) {\r\n      const cached = point.equals(Point.BASE) ? point : new Point(point.x, point.y);\r\n      cached._setWindowSize(windowSize);\r\n      cached.multiply(_2n);\r\n      return cached;\r\n    },\r\n    sha512Sync: undefined,\r\n  };\r\n  Object.defineProperties(utils, {\r\n    sha512Sync: {\r\n      configurable: false,\r\n      get() {\r\n        return _sha512Sync;\r\n      },\r\n      set(val) {\r\n        if (!_sha512Sync)\r\n          _sha512Sync = val;\r\n      },\r\n    },\r\n  });\r\n\r\n  exports.CURVE = CURVE;\r\n  exports.ExtendedPoint = ExtendedPoint;\r\n  exports.Point = Point;\r\n  exports.RistrettoPoint = RistrettoPoint;\r\n  exports.Signature = Signature;\r\n  exports.curve25519 = curve25519;\r\n  exports.getPublicKey = getPublicKey;\r\n  exports.getSharedSecret = getSharedSecret;\r\n  exports.sign = sign;\r\n  exports.sync = sync;\r\n  exports.utils = utils;\r\n  exports.verify = verify;\r\n\r\n  Object.defineProperty(exports, '__esModule', { value: true });\r\n\r\n}));\r\n","import type { Cell, TupleReader } from '@ton/core';\r\n\r\nimport safeExec from '../../../../util/safeExec';\r\n\r\nexport function readCellOpt(stack: TupleReader): Cell | undefined {\r\n  return safeExec(() => stack.readCellOpt(), {\r\n    shouldIgnoreError: true,\r\n  }) ?? undefined;\r\n}\r\n","import { DEBUG, DEBUG_API } from '../config';\r\nimport { AssertionError } from './assert';\r\n\r\nexport interface Log {\r\n  message: string;\r\n  args: any[];\r\n  time: number; // Passing data from the worker to the application as a date object is not supported\r\n  level: 'debug' | 'debugError';\r\n}\r\n\r\nconst MAX_LOG_LENGTH = 999;\r\nconst logs: Log[] = [];\r\n\r\nexport function errorReplacer(_: string, value: any) {\r\n  if (value instanceof Error) {\r\n    return {\r\n      name: value.name,\r\n      message: value.message,\r\n      stack: value.stack,\r\n      metadata: value instanceof AssertionError ? value.metadata : undefined,\r\n    };\r\n  }\r\n  return value;\r\n}\r\n\r\nexport function addLog(log: Omit<Log, 'time'>) {\r\n  if (logs.length > MAX_LOG_LENGTH) {\r\n    logs.shift();\r\n  }\r\n\r\n  logs.push({\r\n    ...log,\r\n    args: log.args.map((arg) => JSON.stringify(arg, errorReplacer)),\r\n    time: Date.now(),\r\n  });\r\n}\r\n\r\nexport function getLogs() {\r\n  return logs;\r\n}\r\n\r\nexport function logDebugError(message: string, ...args: any[]) {\r\n  addLog({ message, level: 'debugError', args });\r\n  if (DEBUG) {\r\n    // eslint-disable-next-line no-console\r\n    console.error(`[DEBUG][${message}]`, ...args);\r\n  }\r\n}\r\n\r\nexport function logDebug(message: any, ...args: any[]) {\r\n  addLog({ message, level: 'debug', args });\r\n  if (DEBUG) {\r\n    // eslint-disable-next-line no-console\r\n    console.log(`[DEBUG] ${message}`, ...args);\r\n  }\r\n}\r\n\r\nexport function logDebugApi(message: any, obj1: any, obj2?: any) {\r\n  if (DEBUG_API) {\r\n    // eslint-disable-next-line no-console\r\n    console.debug(`[DEBUG] ${message}`);\r\n    // eslint-disable-next-line no-console\r\n    if (obj1) console.dir(obj1);\r\n    // eslint-disable-next-line no-console\r\n    if (obj2) console.dir(obj2);\r\n  }\r\n}\r\n\r\nexport function logSelfXssWarnings() {\r\n  const selfXssWarnings: AnyLiteral = {\r\n    en: 'WARNING! This console can be a way for bad people to take over your crypto wallet through something called '\r\n      + 'a Self-XSS attack. So, don\\'t put in or paste code you don\\'t understand. Stay safe!',\r\n    ru: '!             '\r\n      + '  Self-XSS.       ,    .  !',\r\n    es: 'ADVERTENCIA! Esta consola puede ser una forma en que las personas malintencionadas se apoderen de su '\r\n      + 'billetera de criptomonedas mediante un ataque llamado Self-XSS. Por lo tanto, '\r\n      + 'no introduzca ni pegue cdigo que no comprenda. Cudese!',\r\n    zh: 'Self-XSS',\r\n  };\r\n\r\n  const langCode = navigator.language.split('-')[0];\r\n  const text = selfXssWarnings[langCode] || selfXssWarnings.en;\r\n\r\n  // eslint-disable-next-line no-console\r\n  console.log('%c%s', 'color: red; background: yellow; font-size: 18px;', text);\r\n}\r\n","export enum ApiCommonError {\r\n  Unexpected = 'Unexpected',\r\n  ServerError = 'ServerError',\r\n  DebugError = 'DebugError',\r\n  UnsupportedVersion = 'UnsupportedVersion',\r\n  InvalidPassword = 'InvalidPassword',\r\n}\r\n\r\nexport enum ApiAuthError {\r\n  InvalidMnemonic = 'InvalidMnemonic',\r\n  InvalidAddress = 'InvalidAddress',\r\n  DomainNotResolved = 'DomainNotResolved',\r\n}\r\n\r\nexport enum ApiTransactionDraftError {\r\n  InvalidAmount = 'InvalidAmount',\r\n  InvalidToAddress = 'InvalidToAddress',\r\n  InsufficientBalance = 'InsufficientBalance',\r\n  InvalidStateInit = 'InvalidStateInit',\r\n  DomainNotResolved = 'DomainNotResolved',\r\n  WalletNotInitialized = 'WalletNotInitialized',\r\n  InvalidAddressFormat = 'InvalidAddressFormat',\r\n  InactiveContract = 'InactiveContract',\r\n}\r\n\r\nexport enum ApiTransactionError {\r\n  PartialTransactionFailure = 'PartialTransactionFailure',\r\n  IncorrectDeviceTime = 'IncorrectDeviceTime',\r\n  InsufficientBalance = 'InsufficientBalance',\r\n  UnsuccesfulTransfer = 'UnsuccesfulTransfer',\r\n  WrongAddress = 'WrongAddress',\r\n  WrongNetwork = 'WrongNetwork',\r\n  ConcurrentTransaction = 'ConcurrentTransaction',\r\n}\r\n\r\nexport enum ApiHardwareError {\r\n  /** Used when the chain's Ledger app needs to be updated to support this transaction */\r\n  HardwareOutdated = 'HardwareOutdated',\r\n  BlindSigningNotEnabled = 'BlindSigningNotEnabled',\r\n  RejectedByUser = 'RejectedByUser',\r\n  ProofTooLarge = 'ProofTooLarge',\r\n  ConnectionBroken = 'ConnectionBroken',\r\n  WrongDevice = 'WrongDevice',\r\n}\r\n\r\nexport type ApiAnyDisplayError =\r\n  | ApiCommonError\r\n  | ApiAuthError\r\n  | ApiTransactionDraftError\r\n  | ApiTransactionError\r\n  | ApiHardwareError;\r\n","export function random(min: number, max: number) {\r\n  return Math.floor(Math.random() * (max - min + 1) + min);\r\n}\r\n\r\nexport function sample<T>(arr: T[]) {\r\n  return arr[random(0, arr.length - 1)];\r\n}\r\n\r\nexport function randomBytes(size: number) {\r\n  return self.crypto.getRandomValues(new Uint8Array(size));\r\n}\r\n\r\nexport function randomBase64(byteSize: number) {\r\n  return Buffer.from(randomBytes(byteSize)).toString('base64');\r\n}\r\n","export class AssertionError extends Error {\r\n  constructor(\r\n    message: string,\r\n    // Any additional information for the error to help debug it. Don't put sensitive information here.\r\n    public metadata?: unknown,\r\n  ) {\r\n    super(message);\r\n  }\r\n}\r\n\r\nexport function assert(condition: boolean, message: string, metadata?: unknown) {\r\n  if (!condition) {\r\n    throw new AssertionError(message, metadata);\r\n  }\r\n}\r\n","import { STAKING_POOLS } from '../../config';\r\n\r\nexport function sha256(bytes: Uint8Array) {\r\n  return crypto.subtle.digest('SHA-256', bytes);\r\n}\r\n\r\nexport function bytesToHex(bytes: Uint8Array) {\r\n  return Buffer.from(bytes).toString('hex');\r\n}\r\n\r\nexport function hexToBytes(hex: string) {\r\n  return Uint8Array.from(Buffer.from(hex, 'hex'));\r\n}\r\n\r\nexport function bytesToBase64(bytes: Uint8Array) {\r\n  return Buffer.from(bytes).toString('base64');\r\n}\r\n\r\nexport function base64ToBytes(base64: string) {\r\n  return Uint8Array.from(Buffer.from(base64, 'base64'));\r\n}\r\n\r\nexport function base64ToString(base64: string) {\r\n  return Buffer.from(base64, 'base64').toString('utf-8');\r\n}\r\n\r\nexport function isKnownStakingPool(address: string) {\r\n  return STAKING_POOLS.some((poolPart) => address.endsWith(poolPart));\r\n}\r\n","import type { Address, Dictionary } from '@ton/core';\r\n\r\nexport type AddrList = Dictionary<Address, boolean>;\r\n\r\nexport const JettonStakingOpCodes = {\r\n  GET_STATIC_DATA: 0X2FCB26A2,\r\n  REPORT_STATIC_DATA: 0X8B771735,\r\n  GET_STORAGE_DATA: 0X5B88E5CC,\r\n  REPORT_STORAGE_DATA: 0XAAB4A8EF,\r\n  EXCESSES: 0XD53276DB,\r\n\r\n  // Jettons,\r\n  TRANSFER_JETTON: 0X0F8A7EA5,\r\n  INTERNAL_TRANSFER: 0X178D4519,\r\n  TRANSFER_NOTIFICATION: 0X7362D09C,\r\n  PROVIDE_WALLET_ADDRESS: 0X2C76B973,\r\n  TAKE_WALLET_ADDRESS: 0XD1735400,\r\n  BURN_JETTON: 0X595F07BC,\r\n\r\n  // Staking pool,\r\n  STAKE_JETTONS: 0XE3A06989,\r\n  ADD_REWARDS: 0XDB16AC95,\r\n  SEND_CLAIMED_REWARDS: 0X44BC1FE3,\r\n  SEND_UNSTAKED_JETTONS: 0XFB232BC3,\r\n  APPROVE_STAKE: 0X919DE781,\r\n  CANCEL_STAKE: 0X9EADA1D9,\r\n  ADD_REWARD_JETTONS: 0X10676AE7,\r\n  CLAIM_COMMISSIONS: 0XBCA8F067,\r\n  REQUEST_UPDATE_REWARDS: 0XF5C5BAA3,\r\n\r\n  // Staked jetton wallet,\r\n  CLAIM_REWARDS: 0X78D9F109,\r\n  RECEIVE_JETTONS: 0XD68A4AC1,\r\n  UNSTAKE_JETTONS: 0X499A9262,\r\n  UNSTAKE_REQUEST: 0X0168D4B7,\r\n  CANCEL_UNSTAKE_REQUEST: 0XA4910F1A,\r\n  UPDATE_REWARDS: 0XAE9307CE,\r\n  CONFIRM_TRANSFER: 0XBC85EB11,\r\n\r\n  // Pools admin,\r\n  DEPLOY_NEW_POOL: 0XDA861F17,\r\n  SEND_COMMISSIONS: 0XB96ADAEA,\r\n  SET_CODE: 0xe2d2d211,\r\n  CHANGE_CREATION_FEE: 0x66D5528B,\r\n  CHANGE_CONTENT: 0x0ec29200,\r\n  UPDATE_CODES: 0x85c923cf,\r\n};\r\n\r\nexport const JettonStakingGas = {\r\n  MIN_RESERVE: 20_000_000n,\r\n  DEPLOY_POOL: 340_000_000n,\r\n  NOTIFICATION: 340_000_000n,\r\n  JETTON_TRANSFER: 55_000_000n,\r\n  BURN_JETTONS: 340_000_000n,\r\n  STAKE_JETTONS: 300_000_000n, // It was 340000000n\r\n  UNSTAKE_JETTONS: 340_000_000n,\r\n  CANCEL_UNSTAKE: 340_000_000n,\r\n  SEND_COMMISSIONS: 340_000_000n,\r\n  SIMPLE_UPDATE_REQUEST: 340_000_000n,\r\n  ADD_REWARDS: 340_000_000n,\r\n  APPROVE_TRANSFER: 340_000_000n,\r\n  SAVE_UPDATED_REWARDS: 340_000_000n,\r\n  MIN_EXCESS: 10_000_000n,\r\n  SEND_STAKED_JETTONS: 630_000_000n,\r\n};\r\n\r\nexport const Dividers = {\r\n  COMMISSION_DIVIDER: 10000n,\r\n  REWARDS_DIVIDER: 1000,\r\n  DISTRIBUTION_SPEED_DIVIDER: BigInt(24 * 60 * 60),\r\n  DISTRIBUTED_REWARDS_DIVIDER: 100000000000000000000000000000000000000n,\r\n};\r\n","import type {\r\n  Address, Cell, Contract, ContractProvider, Sender,\r\n} from '@ton/core';\r\nimport {\r\n  beginCell, contractAddress, SendMode, toNano,\r\n} from '@ton/core';\r\n\r\nexport type JettonWalletConfig = object;\r\n\r\nexport function jettonWalletConfigToCell(config: JettonWalletConfig): Cell {\r\n  return beginCell().endCell();\r\n}\r\n\r\nexport class JettonWallet implements Contract {\r\n  constructor(readonly address: Address, readonly init?: { code: Cell; data: Cell }) {}\r\n\r\n  static createFromAddress(address: Address) {\r\n    return new JettonWallet(address);\r\n  }\r\n\r\n  static createFromConfig(config: JettonWalletConfig, code: Cell, workchain = 0) {\r\n    const data = jettonWalletConfigToCell(config);\r\n    const init = { code, data };\r\n    return new JettonWallet(contractAddress(workchain, init), init);\r\n  }\r\n\r\n  async sendDeploy(provider: ContractProvider, via: Sender, value: bigint) {\r\n    await provider.internal(via, {\r\n      value,\r\n      sendMode: SendMode.PAY_GAS_SEPARATELY,\r\n      body: beginCell().endCell(),\r\n    });\r\n  }\r\n\r\n  async getJettonBalance(provider: ContractProvider) {\r\n    const state = await provider.getState();\r\n    if (state.state.type !== 'active') {\r\n      return 0n;\r\n    }\r\n    const res = await provider.get('get_wallet_data', []);\r\n    return res.stack.readBigNumber();\r\n  }\r\n\r\n  static transferMessage(\r\n    jetton_amount: bigint,\r\n    to: Address,\r\n    responseAddress: Address,\r\n    customPayload: Cell | null,\r\n    forward_ton_amount: bigint,\r\n    forwardPayload: Cell | null,\r\n  ) {\r\n    return beginCell().storeUint(0xf8a7ea5, 32).storeUint(0, 64) // op, queryId\r\n      .storeCoins(jetton_amount)\r\n      .storeAddress(to)\r\n      .storeAddress(responseAddress)\r\n      .storeMaybeRef(customPayload)\r\n      .storeCoins(forward_ton_amount)\r\n      .storeMaybeRef(forwardPayload)\r\n      .endCell();\r\n  }\r\n\r\n  async sendTransfer(\r\n    provider: ContractProvider,\r\n    via: Sender,\r\n    value: bigint,\r\n    jetton_amount: bigint, to: Address,\r\n    responseAddress: Address,\r\n    customPayload: Cell,\r\n    forward_ton_amount: bigint,\r\n    forwardPayload: Cell,\r\n  ) {\r\n    await provider.internal(via, {\r\n      sendMode: SendMode.PAY_GAS_SEPARATELY,\r\n      body: JettonWallet.transferMessage(\r\n        jetton_amount, to, responseAddress, customPayload, forward_ton_amount, forwardPayload,\r\n      ),\r\n      value,\r\n    });\r\n  }\r\n\r\n  /*\r\n    burn#595f07bc query_id:uint64 amount:(VarUInteger 16)\r\n                  response_destination:MsgAddress custom_payload:(Maybe ^Cell)\r\n                  = InternalMsgBody;\r\n  */\r\n  static burnMessage(jetton_amount: bigint,\r\n    responseAddress: Address,\r\n    customPayload: Cell | null) {\r\n    return beginCell().storeUint(0x595f07bc, 32).storeUint(0, 64) // op, queryId\r\n      .storeCoins(jetton_amount)\r\n      .storeAddress(responseAddress)\r\n      .storeMaybeRef(customPayload)\r\n      .endCell();\r\n  }\r\n\r\n  async sendBurn(provider: ContractProvider, via: Sender, value: bigint,\r\n    jetton_amount: bigint,\r\n    responseAddress: Address,\r\n    customPayload: Cell) {\r\n    await provider.internal(via, {\r\n      sendMode: SendMode.PAY_GAS_SEPARATELY,\r\n      body: JettonWallet.burnMessage(jetton_amount, responseAddress, customPayload),\r\n      value,\r\n    });\r\n  }\r\n\r\n  /*\r\n    withdraw_tons#107c49ef query_id:uint64 = InternalMsgBody;\r\n  */\r\n  static withdrawTonsMessage() {\r\n    return beginCell().storeUint(0x6d8e5e3c, 32).storeUint(0, 64) // op, queryId\r\n      .endCell();\r\n  }\r\n\r\n  async sendWithdrawTons(provider: ContractProvider, via: Sender) {\r\n    await provider.internal(via, {\r\n      sendMode: SendMode.PAY_GAS_SEPARATELY,\r\n      body: JettonWallet.withdrawTonsMessage(),\r\n      value: toNano('0.1'),\r\n    });\r\n  }\r\n\r\n  /*\r\n    withdraw_jettons#10 query_id:uint64 wallet:MsgAddressInt amount:Coins = InternalMsgBody;\r\n  */\r\n  static withdrawJettonsMessage(from: Address, amount: bigint) {\r\n    return beginCell().storeUint(0x768a50b2, 32).storeUint(0, 64) // op, queryId\r\n      .storeAddress(from)\r\n      .storeCoins(amount)\r\n      .storeMaybeRef(undefined)\r\n      .endCell();\r\n  }\r\n\r\n  async sendWithdrawJettons(provider: ContractProvider, via: Sender, from: Address, amount: bigint) {\r\n    await provider.internal(via, {\r\n      sendMode: SendMode.PAY_GAS_SEPARATELY,\r\n      body: JettonWallet.withdrawJettonsMessage(from, amount),\r\n      value: toNano('0.1'),\r\n    });\r\n  }\r\n\r\n  async getWalletData(provider: ContractProvider) {\r\n    const res = await provider.get('get_wallet_data', []);\r\n    const balance = res.stack.readBigNumber();\r\n    const owner = res.stack.readAddress();\r\n    const minter = res.stack.readAddress();\r\n    const code = res.stack.readCell();\r\n\r\n    return {\r\n      balance, owner, minter, code,\r\n    };\r\n  }\r\n}\r\n","import type { ApiNft } from '../api/types';\r\n\r\nimport { TON_DNS_COLLECTION, TON_DNS_RENEWAL_WARNING_DAYS, TON_DNS_ZONES } from '../config';\r\nimport { getCountDaysToDate } from './dateFormat';\r\n\r\nexport function isDnsDomain(value: string) {\r\n  return getDnsDomainZone(value) !== undefined;\r\n}\r\n\r\nexport function getDnsDomainZone(domain: string) {\r\n  for (const zone of TON_DNS_ZONES) {\r\n    const { suffixes, baseFormat } = zone;\r\n\r\n    // Iterating the zones in reverse to prioritize longer zones when multiple zones match (assuming the zones go from\r\n    // the shortest to the longest). For example, `test.ton.vip` matches both `vip` and `ton.vip`, and `ton.vip` must be\r\n    // used.\r\n    for (let i = suffixes.length - 1; i >= 0; i--) {\r\n      const suffix = suffixes[i];\r\n      if (!domain.endsWith(`.${suffix}`)) {\r\n        continue;\r\n      }\r\n\r\n      const base = domain.slice(0, -suffix.length - 1);\r\n      if (!baseFormat.test(base)) {\r\n        continue;\r\n      }\r\n\r\n      return { base, zone };\r\n    }\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nexport function getDnsZoneByCollection(collectionAddress: string) {\r\n  return TON_DNS_ZONES.find((zone) => zone.resolver === collectionAddress);\r\n}\r\n\r\nexport function isTonDnsNft(nft: ApiNft | undefined): nft is ApiNft {\r\n  return nft?.collectionAddress === TON_DNS_COLLECTION;\r\n}\r\n\r\nexport function getTonDnsExpirationDate(nft: ApiNft | undefined, dnsExpiration: Record<string, number> | undefined) {\r\n  return isTonDnsNft(nft) ? dnsExpiration?.[nft.address] : undefined;\r\n}\r\n\r\nexport function filterExpiringDomains(\r\n  nftAddresses: string[],\r\n  nftByAddress?: Record<string, ApiNft>,\r\n  dnsExpiration?: Record<string, number>,\r\n) {\r\n  const expiringDomains: ApiNft[] = [];\r\n\r\n  if (nftByAddress && dnsExpiration) {\r\n    for (const address of nftAddresses) {\r\n      const nft = nftByAddress[address];\r\n      if (getCountDaysToDate(getTonDnsExpirationDate(nft, dnsExpiration) ?? Infinity) <= TON_DNS_RENEWAL_WARNING_DAYS) {\r\n        expiringDomains.push(nft);\r\n      }\r\n    }\r\n  }\r\n\r\n  return expiringDomains;\r\n}\r\n\r\nexport function getDomainsExpirationDate(\r\n  nfts: (string | ApiNft)[],\r\n  nftByAddress?: Record<string, ApiNft>,\r\n  dnsExpiration?: Record<string, number>,\r\n) {\r\n  if (!dnsExpiration) {\r\n    return undefined;\r\n  }\r\n\r\n  return nfts.reduce<number | undefined>(\r\n    (minDate, nftOrAddress) => {\r\n      const nft = typeof nftOrAddress === 'string' ? nftByAddress?.[nftOrAddress] : nftOrAddress;\r\n      const expirationDate = getTonDnsExpirationDate(nft, dnsExpiration);\r\n      return expirationDate\r\n        ? Math.min(expirationDate, minDate ?? Infinity)\r\n        : minDate;\r\n    },\r\n    undefined,\r\n  );\r\n}\r\n","/*\r\n * This module is to be used instead of /src/util/environment.ts\r\n * when `window` is not available (e.g. in a web worker).\r\n */\r\nimport type { ApiInitArgs, ApiNetwork } from './types';\r\n\r\nimport {\r\n  ELECTRON_TONCENTER_MAINNET_KEY,\r\n  ELECTRON_TONCENTER_TESTNET_KEY,\r\n  IS_CAPACITOR,\r\n  IS_EXTENSION,\r\n  TONCENTER_MAINNET_KEY,\r\n  TONCENTER_TESTNET_KEY,\r\n} from '../config';\r\n\r\nconst ELECTRON_ORIGIN = 'file://';\r\n\r\nlet environment: ApiInitArgs & {\r\n  isDappSupported?: boolean;\r\n  isSseSupported?: boolean;\r\n  apiHeaders?: AnyLiteral;\r\n  byNetwork: Record<ApiNetwork, { toncenterKey?: string }>;\r\n};\r\n\r\nfunction getAppOrigin(args: ApiInitArgs): string | undefined {\r\n  if (args.isElectron) {\r\n    return ELECTRON_ORIGIN;\r\n  } else if (IS_CAPACITOR || IS_EXTENSION) {\r\n    return self?.origin;\r\n  } else {\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport function setEnvironment(args: ApiInitArgs) {\r\n  const appOrigin = getAppOrigin(args);\r\n  environment = {\r\n    ...args,\r\n    isDappSupported: true,\r\n    isSseSupported: args.isElectron || (IS_CAPACITOR && !args.isNativeBottomSheet),\r\n    apiHeaders: appOrigin ? { 'X-App-Origin': appOrigin } : {},\r\n    byNetwork: {\r\n      mainnet: {\r\n        toncenterKey: args.isElectron ? ELECTRON_TONCENTER_MAINNET_KEY : TONCENTER_MAINNET_KEY,\r\n      },\r\n      testnet: {\r\n        toncenterKey: args.isElectron ? ELECTRON_TONCENTER_TESTNET_KEY : TONCENTER_TESTNET_KEY,\r\n      },\r\n    },\r\n  };\r\n  return environment;\r\n}\r\n\r\nexport function getEnvironment() {\r\n  return environment;\r\n}\r\n","const cache = new WeakMap<AnyFunction, Map<string, any>>();\r\n\r\nexport default function withCacheAsync<T extends AnyAsyncFunction>(\r\n  fn: T, canBeCached: (value: Awaited<ReturnType<T>>) => boolean = (value) => !!value,\r\n) {\r\n  return async (...args: Parameters<T>): Promise<Awaited<ReturnType<T>>> => {\r\n    let fnCache = cache.get(fn);\r\n    const cacheKey = buildCacheKey(args);\r\n\r\n    if (fnCache) {\r\n      if (fnCache.has(cacheKey)) {\r\n        return fnCache.get(cacheKey);\r\n      }\r\n    } else {\r\n      fnCache = new Map();\r\n      cache.set(fn, fnCache);\r\n    }\r\n\r\n    const resultPromise = fn(...args);\r\n    fnCache.set(cacheKey, resultPromise); // Putting into the cache early to prevent concurrent `fn` calls\r\n\r\n    try {\r\n      const result = await resultPromise;\r\n      if (!canBeCached(result)) {\r\n        fnCache.delete(cacheKey);\r\n      }\r\n      return result;\r\n    } catch (err) {\r\n      fnCache.delete(cacheKey);\r\n      throw err;\r\n    }\r\n  };\r\n}\r\n\r\nfunction buildCacheKey(args: any[]) {\r\n  return args.reduce((cacheKey, arg) => {\r\n    return `${cacheKey}_${typeof arg === 'object' ? JSON.stringify(args) : arg}`;\r\n  }, '');\r\n}\r\n","import type {\r\n  Address, Cell, Contract, ContractProvider, DictionaryValue,\r\n} from '@ton/core';\r\nimport { beginCell, contractAddress, Dictionary } from '@ton/core';\r\n\r\nimport type { StakingPoolConfig } from './StakingPool';\r\n\r\nimport { readCellOpt } from '../util';\r\nimport { Dividers } from './imports/constants';\r\n\r\nexport type UserRewardsDictValue = {\r\n  distributedRewards: bigint;\r\n  unclaimedRewards: bigint;\r\n};\r\n\r\nexport type StakeWalletConfig = {\r\n  stakingPoolAddress: Address;\r\n  ownerAddress: Address;\r\n  minterAddress: Address;\r\n  lockPeriod: bigint;\r\n  jettonBalance: bigint;\r\n  rewardsDict: Dictionary<Address, UserRewardsDictValue>;\r\n  unstakeRequests: Dictionary<number, bigint>;\r\n  requestsCount: bigint;\r\n  totalRequestedJettons: bigint;\r\n  isActive: boolean;\r\n  unstakeCommission: bigint;\r\n  unstakeFee: bigint;\r\n  minDeposit: bigint;\r\n  maxDeposit: bigint;\r\n  whitelist: Dictionary<Address, boolean>;\r\n};\r\n\r\nexport type StakeWalletUninitedConfig = {\r\n  stakingPoolAddress: Address;\r\n  ownerAddress: Address;\r\n  minterAddress: Address;\r\n  lockPeriod: bigint;\r\n};\r\n\r\nexport function userRewardsDictValueParser(): DictionaryValue<UserRewardsDictValue> {\r\n  return {\r\n    serialize: (src, buidler) => {\r\n      buidler.storeUint(src.distributedRewards, 256).storeCoins(src.unclaimedRewards).endCell();\r\n    },\r\n    parse: (src) => {\r\n      return { distributedRewards: src.loadUintBig(256), unclaimedRewards: src.loadCoins() };\r\n    },\r\n  };\r\n}\r\n\r\nexport function stakeWalletConfigToCell(config: StakeWalletUninitedConfig | StakeWalletConfig): Cell {\r\n  return beginCell()\r\n    .storeAddress(config.stakingPoolAddress)\r\n    .storeAddress(config.minterAddress)\r\n    .storeAddress(config.ownerAddress)\r\n    .storeRef(\r\n      beginCell()\r\n        .storeUint(config.lockPeriod, 32)\r\n        .storeUint(1, 19)\r\n        .endCell(),\r\n    )\r\n    .endCell();\r\n}\r\n\r\nexport class StakeWallet implements Contract {\r\n  constructor(readonly address: Address, readonly init?: { code: Cell; data: Cell }) {}\r\n\r\n  static createFromAddress(address: Address) {\r\n    return new StakeWallet(address);\r\n  }\r\n\r\n  static createFromConfig(config: StakeWalletUninitedConfig | StakeWalletConfig, code: Cell, workchain = 0) {\r\n    const data = stakeWalletConfigToCell(config);\r\n    const init = { code, data };\r\n    return new StakeWallet(contractAddress(workchain, init), init);\r\n  }\r\n\r\n  static getAvailableRewards(stakeWalletConfig: StakeWalletConfig, poolConfig: StakingPoolConfig) {\r\n    if (!poolConfig.rewardJettons) {\r\n      return {};\r\n    }\r\n\r\n    const timeNow = Math.floor(Date.now() / 1000);\r\n    const rewardMultiplier = poolConfig.lockPeriods.get(Number(stakeWalletConfig.lockPeriod))!.rewardMultiplier;\r\n\r\n    const res: Record<string, bigint> = {};\r\n    for (const rewardJettonWallet of poolConfig.rewardJettons.keys()) {\r\n      const poolRewardsInfo = poolConfig.rewardJettons.get(rewardJettonWallet)!;\r\n      const userRewardsInfo = stakeWalletConfig.rewardsDict.get(rewardJettonWallet);\r\n      let unclaimedRewards = userRewardsInfo ? userRewardsInfo.unclaimedRewards : 0n;\r\n      const userDistributedRewards = userRewardsInfo ? userRewardsInfo.distributedRewards : 0n;\r\n      let poolDistributedRewards = poolRewardsInfo.distributedRewards;\r\n      for (const i of poolRewardsInfo.rewardsDeposits.keys()) {\r\n        const rewardDeposit = poolRewardsInfo.rewardsDeposits.get(i)!;\r\n        if (rewardDeposit.startTime < timeNow && poolConfig.tvlWithMultipliers) {\r\n          poolDistributedRewards += (\r\n            rewardDeposit.distributionSpeed\r\n            * BigInt(Math.min(timeNow, rewardDeposit.endTime) - rewardDeposit.startTime)\r\n            * Dividers.DISTRIBUTED_REWARDS_DIVIDER\r\n          ) / (Dividers.DISTRIBUTION_SPEED_DIVIDER * poolConfig.tvlWithMultipliers);\r\n        }\r\n      }\r\n      unclaimedRewards += (\r\n        (poolDistributedRewards - userDistributedRewards)\r\n        * stakeWalletConfig.jettonBalance\r\n        * BigInt(rewardMultiplier)\r\n      ) / (Dividers.DISTRIBUTED_REWARDS_DIVIDER * BigInt(Dividers.REWARDS_DIVIDER));\r\n      res[rewardJettonWallet.toString()] = unclaimedRewards;\r\n    }\r\n    return res;\r\n  }\r\n\r\n  async getStorageData(provider: ContractProvider): Promise<StakeWalletConfig> {\r\n    const { stack } = await provider.get('get_storage_data', []);\r\n\r\n    const res: any = {\r\n      stakingPoolAddress: stack.readAddress(),\r\n      ownerAddress: stack.readAddress(),\r\n      lockPeriod: stack.readBigNumber(),\r\n      jettonBalance: stack.readBigNumber(),\r\n      rewardsDict: readCellOpt(stack),\r\n      unstakeRequests: readCellOpt(stack),\r\n      requestsCount: stack.readBigNumber(),\r\n      totalRequestedJettons: stack.readBigNumber(),\r\n      isActive: Boolean(stack.readNumber()),\r\n      unstakeCommission: stack.readBigNumber(),\r\n      unstakeFee: stack.readBigNumber(),\r\n      minDeposit: stack.readBigNumber(),\r\n      maxDeposit: stack.readBigNumber(),\r\n      whitelist: readCellOpt(stack),\r\n      minterAddress: stack.readAddress(),\r\n    };\r\n\r\n    if (res.rewardsDict) {\r\n      res.rewardsDict = res.rewardsDict.beginParse()\r\n        .loadDictDirect(Dictionary.Keys.Address(), userRewardsDictValueParser());\r\n    }\r\n    if (res.unstakeRequests) {\r\n      res.unstakeRequests = res.unstakeRequests.beginParse()\r\n        .loadDictDirect(Dictionary.Keys.Uint(32), Dictionary.Values.BigVarUint(4));\r\n    }\r\n    if (res.whitelist) {\r\n      res.whitelist = res.whitelist.beginParse()\r\n        .loadDictDirect(Dictionary.Keys.Address(), Dictionary.Values.Bool());\r\n    }\r\n\r\n    return res as StakeWalletConfig;\r\n  }\r\n}\r\n","import type {\r\n  Address, Cell, Contract, ContractProvider, DictionaryValue,\r\n} from '@ton/core';\r\nimport { beginCell, contractAddress, Dictionary } from '@ton/core';\r\nimport type { Maybe } from '@ton/core/dist/utils/maybe';\r\n\r\nimport type { AddrList } from './imports/constants';\r\n\r\nimport { readCellOpt } from '../util';\r\nimport { JettonStakingOpCodes } from './imports/constants';\r\n\r\nexport type LockPeriodsValue = {\r\n  curTvl: bigint;\r\n  tvlLimit: bigint;\r\n  rewardMultiplier: number;\r\n  depositCommission: number;\r\n  unstakeCommission: number;\r\n  minterAddress: Address;\r\n};\r\n\r\nfunction lockPeriodsValueParser(): DictionaryValue<LockPeriodsValue> {\r\n  return {\r\n    serialize: (src, buidler) => {\r\n      buidler\r\n        .storeCoins(src.curTvl)\r\n        .storeCoins(src.tvlLimit)\r\n        .storeUint(src.rewardMultiplier, 16)\r\n        .storeUint(src.depositCommission, 16)\r\n        .storeUint(src.unstakeCommission, 16)\r\n        .storeAddress(src.minterAddress)\r\n        .endCell();\r\n    },\r\n    parse: (src) => {\r\n      return {\r\n        curTvl: src.loadCoins(),\r\n        tvlLimit: src.loadCoins(),\r\n        rewardMultiplier: src.loadUint(16),\r\n        depositCommission: src.loadUint(16),\r\n        unstakeCommission: src.loadUint(16),\r\n        minterAddress: src.loadAddress(),\r\n      };\r\n    },\r\n  };\r\n}\r\n\r\nexport type RewardsDepositsValue = {\r\n  distributionSpeed: bigint;\r\n  startTime: number;\r\n  endTime: number;\r\n};\r\n\r\nfunction rewardsDepositsValueParser(): DictionaryValue<RewardsDepositsValue> {\r\n  return {\r\n    serialize: (src, buidler) => {\r\n      buidler.storeCoins(src.distributionSpeed).storeUint(src.startTime, 32).storeUint(src.endTime, 32).endCell();\r\n    },\r\n    parse: (src) => {\r\n      return { distributionSpeed: src.loadCoins(), startTime: src.loadUint(32), endTime: src.loadUint(32) };\r\n    },\r\n  };\r\n}\r\n\r\nexport type RewardJettonsValue = {\r\n  distributedRewards: bigint;\r\n  rewardsDeposits: Dictionary<number, RewardsDepositsValue>;\r\n};\r\n\r\nfunction rewardJettonsValueParser(): DictionaryValue<RewardJettonsValue> {\r\n  return {\r\n    serialize: (src, buidler) => {\r\n      buidler\r\n        .storeUint(src.distributedRewards, 256)\r\n        .storeDict(src.rewardsDeposits, Dictionary.Keys.Uint(32), rewardsDepositsValueParser())\r\n        .endCell();\r\n    },\r\n    parse: (src) => {\r\n      return {\r\n        distributedRewards: src.loadUintBig(256),\r\n        rewardsDeposits: src.loadDict(Dictionary.Keys.Uint(32), rewardsDepositsValueParser()),\r\n      };\r\n    },\r\n  };\r\n}\r\n\r\nexport type StakingPoolConfig = {\r\n  inited: boolean;\r\n  content?: Cell;\r\n  poolId: bigint;\r\n  factoryAddress: Address;\r\n  adminAddress: Address;\r\n  creatorAddress: Address;\r\n  stakeWalletCode: Cell;\r\n  lockWalletAddress: Address;\r\n  minDeposit: bigint;\r\n  maxDeposit: bigint;\r\n  tvl: bigint;\r\n  tvlWithMultipliers: bigint;\r\n  rewardJettons: Dictionary<Address, RewardJettonsValue> | null;\r\n  rewardJettonsCount?: bigint;\r\n  rewardsDepositsCount?: bigint;\r\n  lockPeriods: Dictionary<number, LockPeriodsValue>;\r\n  whitelist: AddrList | null;\r\n  unstakeFee: bigint;\r\n  collectedCommissions: bigint;\r\n  rewardsCommission: bigint;\r\n  version?: bigint;\r\n};\r\n\r\nexport type StakingPoolConfigUnpacked = Omit<StakingPoolConfig, 'rewardJettons' | 'lockPeriods'> & {\r\n  rewardJettons: Record<string, {\r\n    distributedRewards: bigint;\r\n    rewardsDeposits: Record<number, RewardsDepositsValue>;\r\n  }> | null;\r\n  lockPeriods: Record<number, LockPeriodsValue>;\r\n  whitelist: Record<string, boolean> | null;\r\n};\r\n\r\nexport type StakingPoolUninitedConfig = {\r\n  poolId: bigint;\r\n  factoryAddress: Address;\r\n};\r\n\r\nexport function stakingPoolConfigToCell(config: StakingPoolUninitedConfig | StakingPoolConfig): Cell {\r\n  return beginCell().storeAddress(config.factoryAddress).storeUint(config.poolId, 32).endCell();\r\n}\r\n\r\nexport function stakingPoolInitedData(config: StakingPoolConfig): Cell {\r\n  return beginCell()\r\n    .storeBit(config.inited)\r\n    .storeUint(config.poolId, 32)\r\n    .storeAddress(config.adminAddress)\r\n    .storeAddress(config.creatorAddress)\r\n    .storeAddress(config.lockWalletAddress)\r\n    .storeMaybeRef(config.content)\r\n    .storeRef(config.stakeWalletCode)\r\n    .storeRef(\r\n      beginCell()\r\n        .storeCoins(config.tvl)\r\n        .storeCoins(config.tvlWithMultipliers)\r\n        .storeCoins(config.minDeposit)\r\n        .storeCoins(config.maxDeposit)\r\n        .storeDict(config.rewardJettons, Dictionary.Keys.Address(), rewardJettonsValueParser())\r\n        .storeUint(config.rewardJettonsCount ?? 0, 8)\r\n        .storeUint(config.rewardsDepositsCount ?? 0, 8)\r\n        .storeDict(config.lockPeriods, Dictionary.Keys.Uint(32), lockPeriodsValueParser())\r\n        .storeDict(config.whitelist, Dictionary.Keys.Address(), Dictionary.Values.Bool())\r\n        .storeCoins(config.unstakeFee)\r\n        .storeCoins(config.collectedCommissions)\r\n        .storeUint(config.rewardsCommission, 16)\r\n        .storeUint(config.version ?? 0, 16)\r\n        .endCell(),\r\n    )\r\n    .endCell();\r\n}\r\n\r\nexport class StakingPool implements Contract {\r\n  constructor(readonly address: Address, readonly init?: { code: Cell; data: Cell }) {}\r\n\r\n  static createFromAddress(address: Address) {\r\n    return new StakingPool(address);\r\n  }\r\n\r\n  static createFromConfig(config: StakingPoolUninitedConfig | StakingPoolConfig, code: Cell, workchain = 0) {\r\n    const data = stakingPoolConfigToCell(config);\r\n    const init = { code, data };\r\n    return new StakingPool(contractAddress(workchain, init), init);\r\n  }\r\n\r\n  static stakePayload(lockPeriod: number | bigint): Cell {\r\n    return beginCell().storeUint(JettonStakingOpCodes.STAKE_JETTONS, 32).storeUint(lockPeriod, 32).endCell();\r\n  }\r\n\r\n  async getData(provider: ContractProvider) {\r\n    const { stack } = await provider.get('get_nft_data', []);\r\n    return {\r\n      init: stack.readBoolean(),\r\n      index: stack.readBigNumber(),\r\n      collection: stack.readAddressOpt(),\r\n      owner: stack.readAddressOpt(),\r\n      content: stack.readCell(),\r\n    };\r\n  }\r\n\r\n  async getStorageData(provider: ContractProvider): Promise<StakingPoolConfig> {\r\n    const { stack } = await provider.get('get_storage_data', []);\r\n    const res: any = {\r\n      inited: stack.readBoolean(),\r\n      poolId: stack.readBigNumber(),\r\n      adminAddress: stack.readAddress(),\r\n      creatorAddress: stack.readAddress(),\r\n      stakeWalletCode: stack.readCell(),\r\n      lockWalletAddress: stack.readAddress(),\r\n      tvl: stack.readBigNumber(),\r\n      tvlWithMultipliers: stack.readBigNumber(),\r\n      minDeposit: stack.readBigNumber(),\r\n      maxDeposit: stack.readBigNumber(),\r\n      rewardJettons: readCellOpt(stack),\r\n      rewardJettonsCount: stack.readBigNumber(),\r\n      rewardsDepositsCount: stack.readBigNumber(),\r\n      lockPeriods: stack.readCellOpt(),\r\n      whitelist: readCellOpt(stack),\r\n      unstakeFee: stack.readBigNumber(),\r\n      collectedCommissions: stack.readBigNumber(),\r\n      rewardsCommission: stack.readBigNumber(),\r\n      version: stack.readBigNumber(),\r\n    };\r\n\r\n    if (res.rewardJettons) {\r\n      res.rewardJettons = res.rewardJettons.beginParse()\r\n        .loadDictDirect(Dictionary.Keys.Address(), rewardJettonsValueParser());\r\n    }\r\n    if (res.lockPeriods) {\r\n      res.lockPeriods = res.lockPeriods.beginParse()\r\n        .loadDictDirect(Dictionary.Keys.Uint(32), lockPeriodsValueParser());\r\n    }\r\n    if (res.whitelist) {\r\n      res.whitelist = res.whitelist.beginParse()\r\n        .loadDictDirect(Dictionary.Keys.Address(), Dictionary.Values.Bool());\r\n    }\r\n    return res as StakingPoolConfig;\r\n  }\r\n\r\n  async getWalletAddress(\r\n    provider: ContractProvider,\r\n    ownerAddress: Address,\r\n    lockPeriod: number,\r\n  ): Promise<Maybe<Address>> {\r\n    const { stack } = await provider.get('get_stake_wallet_address', [\r\n      { type: 'slice', cell: beginCell().storeAddress(ownerAddress).endCell() },\r\n      { type: 'int', value: BigInt(lockPeriod) },\r\n    ]);\r\n    return stack.readAddressOpt();\r\n  }\r\n}\r\n","type CollectionByKey<Member> = Record<number | string, Member>;\r\ntype GroupedByKey<Member> = Record<number | string, Member[]>;\r\n\r\ntype OrderDirection =\r\n  'asc'\r\n  | 'desc';\r\n\r\ntype OrderCallback<T> = (member: T) => unknown;\r\n\r\nexport function buildCollectionByKey<T extends AnyLiteral>(collection: readonly T[], key: keyof T): CollectionByKey<T> {\r\n  return collection.reduce((byKey: CollectionByKey<T>, member: T) => {\r\n    byKey[member[key]] = member;\r\n\r\n    return byKey;\r\n  }, {});\r\n}\r\n\r\nexport function buildArrayCollectionByKey<T extends AnyLiteral>(collection: T[], key: keyof T) {\r\n  return collection.reduce((byKey: CollectionByKey<Array<T>>, member: T) => {\r\n    const collectionKey = member[key];\r\n    if (!byKey[collectionKey]) {\r\n      byKey[collectionKey] = [];\r\n    }\r\n    byKey[collectionKey].push(member);\r\n\r\n    return byKey;\r\n  }, {});\r\n}\r\n\r\nexport function groupBy<T extends AnyLiteral>(collection: readonly T[], key: keyof T): GroupedByKey<T> {\r\n  return collection.reduce((byKey: GroupedByKey<T>, member: T) => {\r\n    const groupKey = member[key];\r\n\r\n    if (!byKey[groupKey]) {\r\n      byKey[groupKey] = [member];\r\n    } else {\r\n      byKey[groupKey].push(member);\r\n    }\r\n\r\n    return byKey;\r\n  }, {});\r\n}\r\n\r\nexport function mapValues<R, M>(\r\n  byKey: CollectionByKey<M>,\r\n  callback: (member: M, key: string, index: number, originalByKey: CollectionByKey<M>) => R,\r\n): CollectionByKey<R> {\r\n  return Object.keys(byKey).reduce((newByKey: CollectionByKey<R>, key, index) => {\r\n    newByKey[key] = callback(byKey[key], key, index, byKey);\r\n    return newByKey;\r\n  }, {});\r\n}\r\n\r\nexport function pick<T, K extends keyof T>(object: T, keys: K[]) {\r\n  return keys.reduce((result, key) => {\r\n    result[key] = object[key];\r\n    return result;\r\n  }, {} as Pick<T, K>);\r\n}\r\n\r\nexport function pickTruthy<T, K extends keyof T>(object: T, keys: K[]) {\r\n  return keys.reduce((result, key) => {\r\n    if (object[key]) {\r\n      result[key] = object[key];\r\n    }\r\n\r\n    return result;\r\n  }, {} as Pick<T, K>);\r\n}\r\n\r\nexport function omit<T extends object, K extends keyof T>(object: T, keys: K[]): Omit<T, K> {\r\n  const stringKeys = new Set(keys.map(String));\r\n  const savedKeys = Object.keys(object)\r\n    .filter((key) => !stringKeys.has(key)) as Array<Exclude<keyof T, K>>;\r\n\r\n  return pick(object, savedKeys);\r\n}\r\n\r\nexport function omitUndefined<T extends object>(object: T): T {\r\n  return Object.keys(object).reduce((result, stringKey) => {\r\n    const key = stringKey as keyof T;\r\n    if (object[key] !== undefined) {\r\n      result[key] = object[key];\r\n    }\r\n    return result;\r\n  }, {} as T);\r\n}\r\n\r\nexport function orderBy<T>(\r\n  collection: T[],\r\n  orderRule: (keyof T) | OrderCallback<T> | ((keyof T) | OrderCallback<T>)[],\r\n  mode: OrderDirection | [OrderDirection, OrderDirection] = 'asc',\r\n): T[] {\r\n  function compareValues(a: T, b: T, currentOrderRule: (keyof T) | OrderCallback<T>, isAsc: boolean) {\r\n    const aValue = (typeof currentOrderRule === 'function' ? currentOrderRule(a) : a[currentOrderRule]) || 0;\r\n    const bValue = (typeof currentOrderRule === 'function' ? currentOrderRule(b) : b[currentOrderRule]) || 0;\r\n\r\n    if (aValue === bValue) return 0;\r\n\r\n    const condition = isAsc ? aValue > bValue : aValue < bValue;\r\n    return condition ? 1 : -1;\r\n  }\r\n\r\n  if (Array.isArray(orderRule)) {\r\n    const [mode1, mode2] = Array.isArray(mode) ? mode : [mode, mode];\r\n    const [orderRule1, orderRule2] = orderRule;\r\n    const isAsc1 = mode1 === 'asc';\r\n    const isAsc2 = mode2 === 'asc';\r\n\r\n    return collection.sort((a, b) => {\r\n      return compareValues(a, b, orderRule1, isAsc1) || compareValues(a, b, orderRule2, isAsc2);\r\n    });\r\n  }\r\n\r\n  const isAsc = mode === 'asc';\r\n  return collection.sort((a, b) => {\r\n    return compareValues(a, b, orderRule, isAsc);\r\n  });\r\n}\r\n\r\nexport function unique<T>(array: readonly T[]): T[] {\r\n  return Array.from(new Set(array));\r\n}\r\n\r\nexport function compact<T>(array: T[]) {\r\n  return array.filter(Boolean);\r\n}\r\n\r\nexport function areSortedArraysEqual<T>(array1: readonly T[], array2: readonly T[]) {\r\n  if (array1.length !== array2.length) {\r\n    return false;\r\n  }\r\n\r\n  return array1.every((item, i) => item === array2[i]);\r\n}\r\n\r\nexport function split<T>(array: T[], chunkSize: number) {\r\n  const result: T[][] = [];\r\n  for (let i = 0; i < array.length; i += chunkSize) {\r\n    result.push(array.slice(i, i + chunkSize));\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nexport function cloneDeep<T>(value: T): T {\r\n  if (!isObject(value)) {\r\n    return value;\r\n  }\r\n\r\n  if (Array.isArray(value)) {\r\n    return value.map(cloneDeep) as typeof value;\r\n  }\r\n\r\n  return Object.keys(value).reduce((acc, key) => {\r\n    acc[key as keyof T] = cloneDeep(value[key as keyof T]);\r\n    return acc;\r\n  }, {} as T);\r\n}\r\n\r\nexport function isLiteralObject(value: any): value is AnyLiteral {\r\n  return isObject(value) && !Array.isArray(value);\r\n}\r\n\r\nfunction isObject(value: any): value is object {\r\n  // eslint-disable-next-line no-null/no-null\r\n  return typeof value === 'object' && value !== null;\r\n}\r\n\r\nexport function findLast<T>(array: Array<T>, predicate: (value: T, index: number, obj: T[]) => boolean): T | undefined {\r\n  let cursor = array.length;\r\n\r\n  while (cursor--) {\r\n    if (predicate(array[cursor], cursor, array)) {\r\n      return array[cursor];\r\n    }\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nexport function range(start: number, end: number) {\r\n  const arr: number[] = [];\r\n  for (let i = start; i < end;) {\r\n    arr.push(i++);\r\n  }\r\n  return arr;\r\n}\r\n\r\nexport function fromKeyValueArrays<T>(keys: string[], values: T[] | T) {\r\n  return keys.reduce((acc, key, index) => {\r\n    acc[key] = Array.isArray(values) ? values[index] : values;\r\n    return acc;\r\n  }, {} as Record<string, T>);\r\n}\r\n\r\nexport function extractKey<T, K extends keyof T>(array: readonly T[], key: K): T[K][] {\r\n  return array.map((value) => value[key]);\r\n}\r\n\r\nexport function findDifference<T>(array1: Iterable<T>, array2: Iterable<T>): T[] {\r\n  const set2 = new Set(array2);\r\n  const diff: T[] = [];\r\n\r\n  for (const element of array1) {\r\n    if (!set2.has(element)) {\r\n      diff.push(element);\r\n    }\r\n  }\r\n\r\n  return diff;\r\n}\r\n\r\nexport function filterValues<M>(\r\n  byKey: CollectionByKey<M>,\r\n  callback: (member: M, key: string, index: number, originalByKey: CollectionByKey<M>) => boolean,\r\n): CollectionByKey<M> {\r\n  return Object.keys(byKey).reduce((newByKey: CollectionByKey<M>, key, index) => {\r\n    if (callback(byKey[key], key, index, byKey)) {\r\n      newByKey[key] = byKey[key];\r\n    }\r\n\r\n    return newByKey;\r\n  }, {});\r\n}\r\n\r\nexport function uniqueByKey<T>(array: readonly T[], key: keyof T, shouldKeepFirst?: boolean) {\r\n  if (shouldKeepFirst) {\r\n    array = [...array].reverse();\r\n  }\r\n\r\n  const result = [...new Map(array.map((item) => [item[key], item])).values()];\r\n\r\n  if (shouldKeepFirst) {\r\n    result.reverse();\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nexport function intersection<T>(x: Set<T>, y: Set<T>): Set<T> {\r\n  const result = new Set<T>();\r\n  for (const elem of y) {\r\n    if (x.has(elem)) {\r\n      result.add(elem);\r\n    }\r\n  }\r\n  return result;\r\n}\r\n\r\nexport function swapKeysAndValues<\r\n  K extends string | number,\r\n  V extends keyof any,\r\n>(object: Record<K, V>): Record<V, `${K}`> {\r\n  const result = {} as any;\r\n  for (const [key, value] of Object.entries(object)) {\r\n    result[value as any] = key;\r\n  }\r\n  return result;\r\n}\r\n\r\n/**\r\n * The arrays inside `arrays` must be sorted according to `compareFn`, otherwise the result is not guaranteed.\r\n * `deduplicateEqual` doesn't remove duplicates if the individual input arrays contain duplicates.\r\n * Always returns a new array (not any of the input arrays).\r\n */\r\nexport function mergeSortedArrays<T>(\r\n  arrays: readonly (readonly T[])[],\r\n  compareFn: (item1: T, item2: T) => number,\r\n  deduplicateEqual?: boolean,\r\n): T[] {\r\n  // This is a divide-and-conquer algorithm combined with a 2-pointers algorithm. Its time complexity is O(n*log(n)*m),\r\n  // where n is the number of arrays and m is the average array size. The heap algorithm is slightly faster, but it has\r\n  // the same time complexity and its implementation in JS is too bulky.\r\n  // This problem on LeetCode: https://leetcode.com/problems/merge-k-sorted-lists/\r\n\r\n  if (arrays.length === 1) return [...arrays[0]];\r\n\r\n  let toMerge = arrays as T[][];\r\n\r\n  while (toMerge.length > 1) {\r\n    const nextToMerge: T[][] = [];\r\n\r\n    for (let i = 0; i < toMerge.length; i += 2) {\r\n      nextToMerge.push(\r\n        i + 1 < toMerge.length\r\n          ? merge2(toMerge[i], toMerge[i + 1])\r\n          : toMerge[i], // If toMerge.length is odd, the last iteration has only 1 subarray to merge\r\n      );\r\n    }\r\n\r\n    toMerge = nextToMerge;\r\n  }\r\n\r\n  return toMerge[0] ?? [];\r\n\r\n  function merge2(arr1: readonly T[], arr2: readonly T[]) {\r\n    let index1 = 0;\r\n    let index2 = 0;\r\n    const result: T[] = [];\r\n\r\n    while (index1 < arr1.length && index2 < arr2.length) {\r\n      const compareResult = compareFn(arr1[index1], arr2[index2]);\r\n\r\n      if (compareResult === 0) {\r\n        result.push(arr1[index1]);\r\n        if (!deduplicateEqual) {\r\n          result.push(arr2[index2]);\r\n        }\r\n        index1++;\r\n        index2++;\r\n      } else if (compareResult < 0) {\r\n        result.push(arr1[index1++]);\r\n      } else {\r\n        result.push(arr2[index2++]);\r\n      }\r\n    }\r\n\r\n    result.push(...arr1.slice(index1));\r\n    result.push(...arr2.slice(index2));\r\n\r\n    return result;\r\n  }\r\n}\r\n\r\nexport function shuffle<T>(array: T[]): T[] {\r\n  let currentIndex = array.length;\r\n  let randomIndex;\r\n\r\n  while (currentIndex !== 0) {\r\n    randomIndex = Math.floor(Math.random() * currentIndex);\r\n    currentIndex--;\r\n\r\n    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];\r\n  }\r\n\r\n  return array;\r\n}\r\n","// Version 3.1.2\r\n/*! MIT License. Copyright 2015-2018 Richard Moore <me@ricmoo.com>. See LICENSE.txt. */\r\n(function(root) {\r\n  \"use strict\";\r\n\r\n  function checkInt(value) {\r\n    return (parseInt(value) === value);\r\n  }\r\n\r\n  function checkInts(arrayish) {\r\n    if (!checkInt(arrayish.length)) { return false; }\r\n\r\n    for (var i = 0; i < arrayish.length; i++) {\r\n      if (!checkInt(arrayish[i]) || arrayish[i] < 0 || arrayish[i] > 255) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  function coerceArray(arg, copy) {\r\n\r\n    // ArrayBuffer view\r\n    if (arg.buffer && arg.name === 'Uint8Array') {\r\n\r\n      if (copy) {\r\n        if (arg.slice) {\r\n          arg = arg.slice();\r\n        } else {\r\n          arg = Array.prototype.slice.call(arg);\r\n        }\r\n      }\r\n\r\n      return arg;\r\n    }\r\n\r\n    // It's an array; check it is a valid representation of a byte\r\n    if (Array.isArray(arg)) {\r\n      if (!checkInts(arg)) {\r\n        throw new Error('Array contains invalid value: ' + arg);\r\n      }\r\n\r\n      return new Uint8Array(arg);\r\n    }\r\n\r\n    // Something else, but behaves like an array (maybe a Buffer? Arguments?)\r\n    if (checkInt(arg.length) && checkInts(arg)) {\r\n      return new Uint8Array(arg);\r\n    }\r\n\r\n    throw new Error('unsupported array-like object');\r\n  }\r\n\r\n  function createArray(length) {\r\n    return new Uint8Array(length);\r\n  }\r\n\r\n  function copyArray(sourceArray, targetArray, targetStart, sourceStart, sourceEnd) {\r\n    if (sourceStart != null || sourceEnd != null) {\r\n      if (sourceArray.slice) {\r\n        sourceArray = sourceArray.slice(sourceStart, sourceEnd);\r\n      } else {\r\n        sourceArray = Array.prototype.slice.call(sourceArray, sourceStart, sourceEnd);\r\n      }\r\n    }\r\n    targetArray.set(sourceArray, targetStart);\r\n  }\r\n\r\n\r\n\r\n  var convertUtf8 = (function() {\r\n    function toBytes(text) {\r\n      var result = [], i = 0;\r\n      text = encodeURI(text);\r\n      while (i < text.length) {\r\n        var c = text.charCodeAt(i++);\r\n\r\n        // if it is a % sign, encode the following 2 bytes as a hex value\r\n        if (c === 37) {\r\n          result.push(parseInt(text.substr(i, 2), 16))\r\n          i += 2;\r\n\r\n          // otherwise, just the actual byte\r\n        } else {\r\n          result.push(c)\r\n        }\r\n      }\r\n\r\n      return coerceArray(result);\r\n    }\r\n\r\n    function fromBytes(bytes) {\r\n      var result = [], i = 0;\r\n\r\n      while (i < bytes.length) {\r\n        var c = bytes[i];\r\n\r\n        if (c < 128) {\r\n          result.push(String.fromCharCode(c));\r\n          i++;\r\n        } else if (c > 191 && c < 224) {\r\n          result.push(String.fromCharCode(((c & 0x1f) << 6) | (bytes[i + 1] & 0x3f)));\r\n          i += 2;\r\n        } else {\r\n          result.push(String.fromCharCode(((c & 0x0f) << 12) | ((bytes[i + 1] & 0x3f) << 6) | (bytes[i + 2] & 0x3f)));\r\n          i += 3;\r\n        }\r\n      }\r\n\r\n      return result.join('');\r\n    }\r\n\r\n    return {\r\n      toBytes: toBytes,\r\n      fromBytes: fromBytes,\r\n    }\r\n  })();\r\n\r\n  var convertHex = (function() {\r\n    function toBytes(text) {\r\n      var result = [];\r\n      for (var i = 0; i < text.length; i += 2) {\r\n        result.push(parseInt(text.substr(i, 2), 16));\r\n      }\r\n\r\n      return result;\r\n    }\r\n\r\n    // http://ixti.net/development/javascript/2011/11/11/base64-encodedecode-of-utf8-in-browser-with-js.html\r\n    var Hex = '0123456789abcdef';\r\n\r\n    function fromBytes(bytes) {\r\n      var result = [];\r\n      for (var i = 0; i < bytes.length; i++) {\r\n        var v = bytes[i];\r\n        result.push(Hex[(v & 0xf0) >> 4] + Hex[v & 0x0f]);\r\n      }\r\n      return result.join('');\r\n    }\r\n\r\n    return {\r\n      toBytes: toBytes,\r\n      fromBytes: fromBytes,\r\n    }\r\n  })();\r\n\r\n\r\n  // Number of rounds by keysize\r\n  var numberOfRounds = {16: 10, 24: 12, 32: 14}\r\n\r\n  // Round constant words\r\n  var rcon = [0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x1b, 0x36, 0x6c, 0xd8, 0xab, 0x4d, 0x9a, 0x2f, 0x5e, 0xbc, 0x63, 0xc6, 0x97, 0x35, 0x6a, 0xd4, 0xb3, 0x7d, 0xfa, 0xef, 0xc5, 0x91];\r\n\r\n  // S-box and Inverse S-box (S is for Substitution)\r\n  var S = [0x63, 0x7c, 0x77, 0x7b, 0xf2, 0x6b, 0x6f, 0xc5, 0x30, 0x01, 0x67, 0x2b, 0xfe, 0xd7, 0xab, 0x76, 0xca, 0x82, 0xc9, 0x7d, 0xfa, 0x59, 0x47, 0xf0, 0xad, 0xd4, 0xa2, 0xaf, 0x9c, 0xa4, 0x72, 0xc0, 0xb7, 0xfd, 0x93, 0x26, 0x36, 0x3f, 0xf7, 0xcc, 0x34, 0xa5, 0xe5, 0xf1, 0x71, 0xd8, 0x31, 0x15, 0x04, 0xc7, 0x23, 0xc3, 0x18, 0x96, 0x05, 0x9a, 0x07, 0x12, 0x80, 0xe2, 0xeb, 0x27, 0xb2, 0x75, 0x09, 0x83, 0x2c, 0x1a, 0x1b, 0x6e, 0x5a, 0xa0, 0x52, 0x3b, 0xd6, 0xb3, 0x29, 0xe3, 0x2f, 0x84, 0x53, 0xd1, 0x00, 0xed, 0x20, 0xfc, 0xb1, 0x5b, 0x6a, 0xcb, 0xbe, 0x39, 0x4a, 0x4c, 0x58, 0xcf, 0xd0, 0xef, 0xaa, 0xfb, 0x43, 0x4d, 0x33, 0x85, 0x45, 0xf9, 0x02, 0x7f, 0x50, 0x3c, 0x9f, 0xa8, 0x51, 0xa3, 0x40, 0x8f, 0x92, 0x9d, 0x38, 0xf5, 0xbc, 0xb6, 0xda, 0x21, 0x10, 0xff, 0xf3, 0xd2, 0xcd, 0x0c, 0x13, 0xec, 0x5f, 0x97, 0x44, 0x17, 0xc4, 0xa7, 0x7e, 0x3d, 0x64, 0x5d, 0x19, 0x73, 0x60, 0x81, 0x4f, 0xdc, 0x22, 0x2a, 0x90, 0x88, 0x46, 0xee, 0xb8, 0x14, 0xde, 0x5e, 0x0b, 0xdb, 0xe0, 0x32, 0x3a, 0x0a, 0x49, 0x06, 0x24, 0x5c, 0xc2, 0xd3, 0xac, 0x62, 0x91, 0x95, 0xe4, 0x79, 0xe7, 0xc8, 0x37, 0x6d, 0x8d, 0xd5, 0x4e, 0xa9, 0x6c, 0x56, 0xf4, 0xea, 0x65, 0x7a, 0xae, 0x08, 0xba, 0x78, 0x25, 0x2e, 0x1c, 0xa6, 0xb4, 0xc6, 0xe8, 0xdd, 0x74, 0x1f, 0x4b, 0xbd, 0x8b, 0x8a, 0x70, 0x3e, 0xb5, 0x66, 0x48, 0x03, 0xf6, 0x0e, 0x61, 0x35, 0x57, 0xb9, 0x86, 0xc1, 0x1d, 0x9e, 0xe1, 0xf8, 0x98, 0x11, 0x69, 0xd9, 0x8e, 0x94, 0x9b, 0x1e, 0x87, 0xe9, 0xce, 0x55, 0x28, 0xdf, 0x8c, 0xa1, 0x89, 0x0d, 0xbf, 0xe6, 0x42, 0x68, 0x41, 0x99, 0x2d, 0x0f, 0xb0, 0x54, 0xbb, 0x16];\r\n  var Si =[0x52, 0x09, 0x6a, 0xd5, 0x30, 0x36, 0xa5, 0x38, 0xbf, 0x40, 0xa3, 0x9e, 0x81, 0xf3, 0xd7, 0xfb, 0x7c, 0xe3, 0x39, 0x82, 0x9b, 0x2f, 0xff, 0x87, 0x34, 0x8e, 0x43, 0x44, 0xc4, 0xde, 0xe9, 0xcb, 0x54, 0x7b, 0x94, 0x32, 0xa6, 0xc2, 0x23, 0x3d, 0xee, 0x4c, 0x95, 0x0b, 0x42, 0xfa, 0xc3, 0x4e, 0x08, 0x2e, 0xa1, 0x66, 0x28, 0xd9, 0x24, 0xb2, 0x76, 0x5b, 0xa2, 0x49, 0x6d, 0x8b, 0xd1, 0x25, 0x72, 0xf8, 0xf6, 0x64, 0x86, 0x68, 0x98, 0x16, 0xd4, 0xa4, 0x5c, 0xcc, 0x5d, 0x65, 0xb6, 0x92, 0x6c, 0x70, 0x48, 0x50, 0xfd, 0xed, 0xb9, 0xda, 0x5e, 0x15, 0x46, 0x57, 0xa7, 0x8d, 0x9d, 0x84, 0x90, 0xd8, 0xab, 0x00, 0x8c, 0xbc, 0xd3, 0x0a, 0xf7, 0xe4, 0x58, 0x05, 0xb8, 0xb3, 0x45, 0x06, 0xd0, 0x2c, 0x1e, 0x8f, 0xca, 0x3f, 0x0f, 0x02, 0xc1, 0xaf, 0xbd, 0x03, 0x01, 0x13, 0x8a, 0x6b, 0x3a, 0x91, 0x11, 0x41, 0x4f, 0x67, 0xdc, 0xea, 0x97, 0xf2, 0xcf, 0xce, 0xf0, 0xb4, 0xe6, 0x73, 0x96, 0xac, 0x74, 0x22, 0xe7, 0xad, 0x35, 0x85, 0xe2, 0xf9, 0x37, 0xe8, 0x1c, 0x75, 0xdf, 0x6e, 0x47, 0xf1, 0x1a, 0x71, 0x1d, 0x29, 0xc5, 0x89, 0x6f, 0xb7, 0x62, 0x0e, 0xaa, 0x18, 0xbe, 0x1b, 0xfc, 0x56, 0x3e, 0x4b, 0xc6, 0xd2, 0x79, 0x20, 0x9a, 0xdb, 0xc0, 0xfe, 0x78, 0xcd, 0x5a, 0xf4, 0x1f, 0xdd, 0xa8, 0x33, 0x88, 0x07, 0xc7, 0x31, 0xb1, 0x12, 0x10, 0x59, 0x27, 0x80, 0xec, 0x5f, 0x60, 0x51, 0x7f, 0xa9, 0x19, 0xb5, 0x4a, 0x0d, 0x2d, 0xe5, 0x7a, 0x9f, 0x93, 0xc9, 0x9c, 0xef, 0xa0, 0xe0, 0x3b, 0x4d, 0xae, 0x2a, 0xf5, 0xb0, 0xc8, 0xeb, 0xbb, 0x3c, 0x83, 0x53, 0x99, 0x61, 0x17, 0x2b, 0x04, 0x7e, 0xba, 0x77, 0xd6, 0x26, 0xe1, 0x69, 0x14, 0x63, 0x55, 0x21, 0x0c, 0x7d];\r\n\r\n  // Transformations for encryption\r\n  var T1 = [0xc66363a5, 0xf87c7c84, 0xee777799, 0xf67b7b8d, 0xfff2f20d, 0xd66b6bbd, 0xde6f6fb1, 0x91c5c554, 0x60303050, 0x02010103, 0xce6767a9, 0x562b2b7d, 0xe7fefe19, 0xb5d7d762, 0x4dababe6, 0xec76769a, 0x8fcaca45, 0x1f82829d, 0x89c9c940, 0xfa7d7d87, 0xeffafa15, 0xb25959eb, 0x8e4747c9, 0xfbf0f00b, 0x41adadec, 0xb3d4d467, 0x5fa2a2fd, 0x45afafea, 0x239c9cbf, 0x53a4a4f7, 0xe4727296, 0x9bc0c05b, 0x75b7b7c2, 0xe1fdfd1c, 0x3d9393ae, 0x4c26266a, 0x6c36365a, 0x7e3f3f41, 0xf5f7f702, 0x83cccc4f, 0x6834345c, 0x51a5a5f4, 0xd1e5e534, 0xf9f1f108, 0xe2717193, 0xabd8d873, 0x62313153, 0x2a15153f, 0x0804040c, 0x95c7c752, 0x46232365, 0x9dc3c35e, 0x30181828, 0x379696a1, 0x0a05050f, 0x2f9a9ab5, 0x0e070709, 0x24121236, 0x1b80809b, 0xdfe2e23d, 0xcdebeb26, 0x4e272769, 0x7fb2b2cd, 0xea75759f, 0x1209091b, 0x1d83839e, 0x582c2c74, 0x341a1a2e, 0x361b1b2d, 0xdc6e6eb2, 0xb45a5aee, 0x5ba0a0fb, 0xa45252f6, 0x763b3b4d, 0xb7d6d661, 0x7db3b3ce, 0x5229297b, 0xdde3e33e, 0x5e2f2f71, 0x13848497, 0xa65353f5, 0xb9d1d168, 0x00000000, 0xc1eded2c, 0x40202060, 0xe3fcfc1f, 0x79b1b1c8, 0xb65b5bed, 0xd46a6abe, 0x8dcbcb46, 0x67bebed9, 0x7239394b, 0x944a4ade, 0x984c4cd4, 0xb05858e8, 0x85cfcf4a, 0xbbd0d06b, 0xc5efef2a, 0x4faaaae5, 0xedfbfb16, 0x864343c5, 0x9a4d4dd7, 0x66333355, 0x11858594, 0x8a4545cf, 0xe9f9f910, 0x04020206, 0xfe7f7f81, 0xa05050f0, 0x783c3c44, 0x259f9fba, 0x4ba8a8e3, 0xa25151f3, 0x5da3a3fe, 0x804040c0, 0x058f8f8a, 0x3f9292ad, 0x219d9dbc, 0x70383848, 0xf1f5f504, 0x63bcbcdf, 0x77b6b6c1, 0xafdada75, 0x42212163, 0x20101030, 0xe5ffff1a, 0xfdf3f30e, 0xbfd2d26d, 0x81cdcd4c, 0x180c0c14, 0x26131335, 0xc3ecec2f, 0xbe5f5fe1, 0x359797a2, 0x884444cc, 0x2e171739, 0x93c4c457, 0x55a7a7f2, 0xfc7e7e82, 0x7a3d3d47, 0xc86464ac, 0xba5d5de7, 0x3219192b, 0xe6737395, 0xc06060a0, 0x19818198, 0x9e4f4fd1, 0xa3dcdc7f, 0x44222266, 0x542a2a7e, 0x3b9090ab, 0x0b888883, 0x8c4646ca, 0xc7eeee29, 0x6bb8b8d3, 0x2814143c, 0xa7dede79, 0xbc5e5ee2, 0x160b0b1d, 0xaddbdb76, 0xdbe0e03b, 0x64323256, 0x743a3a4e, 0x140a0a1e, 0x924949db, 0x0c06060a, 0x4824246c, 0xb85c5ce4, 0x9fc2c25d, 0xbdd3d36e, 0x43acacef, 0xc46262a6, 0x399191a8, 0x319595a4, 0xd3e4e437, 0xf279798b, 0xd5e7e732, 0x8bc8c843, 0x6e373759, 0xda6d6db7, 0x018d8d8c, 0xb1d5d564, 0x9c4e4ed2, 0x49a9a9e0, 0xd86c6cb4, 0xac5656fa, 0xf3f4f407, 0xcfeaea25, 0xca6565af, 0xf47a7a8e, 0x47aeaee9, 0x10080818, 0x6fbabad5, 0xf0787888, 0x4a25256f, 0x5c2e2e72, 0x381c1c24, 0x57a6a6f1, 0x73b4b4c7, 0x97c6c651, 0xcbe8e823, 0xa1dddd7c, 0xe874749c, 0x3e1f1f21, 0x964b4bdd, 0x61bdbddc, 0x0d8b8b86, 0x0f8a8a85, 0xe0707090, 0x7c3e3e42, 0x71b5b5c4, 0xcc6666aa, 0x904848d8, 0x06030305, 0xf7f6f601, 0x1c0e0e12, 0xc26161a3, 0x6a35355f, 0xae5757f9, 0x69b9b9d0, 0x17868691, 0x99c1c158, 0x3a1d1d27, 0x279e9eb9, 0xd9e1e138, 0xebf8f813, 0x2b9898b3, 0x22111133, 0xd26969bb, 0xa9d9d970, 0x078e8e89, 0x339494a7, 0x2d9b9bb6, 0x3c1e1e22, 0x15878792, 0xc9e9e920, 0x87cece49, 0xaa5555ff, 0x50282878, 0xa5dfdf7a, 0x038c8c8f, 0x59a1a1f8, 0x09898980, 0x1a0d0d17, 0x65bfbfda, 0xd7e6e631, 0x844242c6, 0xd06868b8, 0x824141c3, 0x299999b0, 0x5a2d2d77, 0x1e0f0f11, 0x7bb0b0cb, 0xa85454fc, 0x6dbbbbd6, 0x2c16163a];\r\n  var T2 = [0xa5c66363, 0x84f87c7c, 0x99ee7777, 0x8df67b7b, 0x0dfff2f2, 0xbdd66b6b, 0xb1de6f6f, 0x5491c5c5, 0x50603030, 0x03020101, 0xa9ce6767, 0x7d562b2b, 0x19e7fefe, 0x62b5d7d7, 0xe64dabab, 0x9aec7676, 0x458fcaca, 0x9d1f8282, 0x4089c9c9, 0x87fa7d7d, 0x15effafa, 0xebb25959, 0xc98e4747, 0x0bfbf0f0, 0xec41adad, 0x67b3d4d4, 0xfd5fa2a2, 0xea45afaf, 0xbf239c9c, 0xf753a4a4, 0x96e47272, 0x5b9bc0c0, 0xc275b7b7, 0x1ce1fdfd, 0xae3d9393, 0x6a4c2626, 0x5a6c3636, 0x417e3f3f, 0x02f5f7f7, 0x4f83cccc, 0x5c683434, 0xf451a5a5, 0x34d1e5e5, 0x08f9f1f1, 0x93e27171, 0x73abd8d8, 0x53623131, 0x3f2a1515, 0x0c080404, 0x5295c7c7, 0x65462323, 0x5e9dc3c3, 0x28301818, 0xa1379696, 0x0f0a0505, 0xb52f9a9a, 0x090e0707, 0x36241212, 0x9b1b8080, 0x3ddfe2e2, 0x26cdebeb, 0x694e2727, 0xcd7fb2b2, 0x9fea7575, 0x1b120909, 0x9e1d8383, 0x74582c2c, 0x2e341a1a, 0x2d361b1b, 0xb2dc6e6e, 0xeeb45a5a, 0xfb5ba0a0, 0xf6a45252, 0x4d763b3b, 0x61b7d6d6, 0xce7db3b3, 0x7b522929, 0x3edde3e3, 0x715e2f2f, 0x97138484, 0xf5a65353, 0x68b9d1d1, 0x00000000, 0x2cc1eded, 0x60402020, 0x1fe3fcfc, 0xc879b1b1, 0xedb65b5b, 0xbed46a6a, 0x468dcbcb, 0xd967bebe, 0x4b723939, 0xde944a4a, 0xd4984c4c, 0xe8b05858, 0x4a85cfcf, 0x6bbbd0d0, 0x2ac5efef, 0xe54faaaa, 0x16edfbfb, 0xc5864343, 0xd79a4d4d, 0x55663333, 0x94118585, 0xcf8a4545, 0x10e9f9f9, 0x06040202, 0x81fe7f7f, 0xf0a05050, 0x44783c3c, 0xba259f9f, 0xe34ba8a8, 0xf3a25151, 0xfe5da3a3, 0xc0804040, 0x8a058f8f, 0xad3f9292, 0xbc219d9d, 0x48703838, 0x04f1f5f5, 0xdf63bcbc, 0xc177b6b6, 0x75afdada, 0x63422121, 0x30201010, 0x1ae5ffff, 0x0efdf3f3, 0x6dbfd2d2, 0x4c81cdcd, 0x14180c0c, 0x35261313, 0x2fc3ecec, 0xe1be5f5f, 0xa2359797, 0xcc884444, 0x392e1717, 0x5793c4c4, 0xf255a7a7, 0x82fc7e7e, 0x477a3d3d, 0xacc86464, 0xe7ba5d5d, 0x2b321919, 0x95e67373, 0xa0c06060, 0x98198181, 0xd19e4f4f, 0x7fa3dcdc, 0x66442222, 0x7e542a2a, 0xab3b9090, 0x830b8888, 0xca8c4646, 0x29c7eeee, 0xd36bb8b8, 0x3c281414, 0x79a7dede, 0xe2bc5e5e, 0x1d160b0b, 0x76addbdb, 0x3bdbe0e0, 0x56643232, 0x4e743a3a, 0x1e140a0a, 0xdb924949, 0x0a0c0606, 0x6c482424, 0xe4b85c5c, 0x5d9fc2c2, 0x6ebdd3d3, 0xef43acac, 0xa6c46262, 0xa8399191, 0xa4319595, 0x37d3e4e4, 0x8bf27979, 0x32d5e7e7, 0x438bc8c8, 0x596e3737, 0xb7da6d6d, 0x8c018d8d, 0x64b1d5d5, 0xd29c4e4e, 0xe049a9a9, 0xb4d86c6c, 0xfaac5656, 0x07f3f4f4, 0x25cfeaea, 0xafca6565, 0x8ef47a7a, 0xe947aeae, 0x18100808, 0xd56fbaba, 0x88f07878, 0x6f4a2525, 0x725c2e2e, 0x24381c1c, 0xf157a6a6, 0xc773b4b4, 0x5197c6c6, 0x23cbe8e8, 0x7ca1dddd, 0x9ce87474, 0x213e1f1f, 0xdd964b4b, 0xdc61bdbd, 0x860d8b8b, 0x850f8a8a, 0x90e07070, 0x427c3e3e, 0xc471b5b5, 0xaacc6666, 0xd8904848, 0x05060303, 0x01f7f6f6, 0x121c0e0e, 0xa3c26161, 0x5f6a3535, 0xf9ae5757, 0xd069b9b9, 0x91178686, 0x5899c1c1, 0x273a1d1d, 0xb9279e9e, 0x38d9e1e1, 0x13ebf8f8, 0xb32b9898, 0x33221111, 0xbbd26969, 0x70a9d9d9, 0x89078e8e, 0xa7339494, 0xb62d9b9b, 0x223c1e1e, 0x92158787, 0x20c9e9e9, 0x4987cece, 0xffaa5555, 0x78502828, 0x7aa5dfdf, 0x8f038c8c, 0xf859a1a1, 0x80098989, 0x171a0d0d, 0xda65bfbf, 0x31d7e6e6, 0xc6844242, 0xb8d06868, 0xc3824141, 0xb0299999, 0x775a2d2d, 0x111e0f0f, 0xcb7bb0b0, 0xfca85454, 0xd66dbbbb, 0x3a2c1616];\r\n  var T3 = [0x63a5c663, 0x7c84f87c, 0x7799ee77, 0x7b8df67b, 0xf20dfff2, 0x6bbdd66b, 0x6fb1de6f, 0xc55491c5, 0x30506030, 0x01030201, 0x67a9ce67, 0x2b7d562b, 0xfe19e7fe, 0xd762b5d7, 0xabe64dab, 0x769aec76, 0xca458fca, 0x829d1f82, 0xc94089c9, 0x7d87fa7d, 0xfa15effa, 0x59ebb259, 0x47c98e47, 0xf00bfbf0, 0xadec41ad, 0xd467b3d4, 0xa2fd5fa2, 0xafea45af, 0x9cbf239c, 0xa4f753a4, 0x7296e472, 0xc05b9bc0, 0xb7c275b7, 0xfd1ce1fd, 0x93ae3d93, 0x266a4c26, 0x365a6c36, 0x3f417e3f, 0xf702f5f7, 0xcc4f83cc, 0x345c6834, 0xa5f451a5, 0xe534d1e5, 0xf108f9f1, 0x7193e271, 0xd873abd8, 0x31536231, 0x153f2a15, 0x040c0804, 0xc75295c7, 0x23654623, 0xc35e9dc3, 0x18283018, 0x96a13796, 0x050f0a05, 0x9ab52f9a, 0x07090e07, 0x12362412, 0x809b1b80, 0xe23ddfe2, 0xeb26cdeb, 0x27694e27, 0xb2cd7fb2, 0x759fea75, 0x091b1209, 0x839e1d83, 0x2c74582c, 0x1a2e341a, 0x1b2d361b, 0x6eb2dc6e, 0x5aeeb45a, 0xa0fb5ba0, 0x52f6a452, 0x3b4d763b, 0xd661b7d6, 0xb3ce7db3, 0x297b5229, 0xe33edde3, 0x2f715e2f, 0x84971384, 0x53f5a653, 0xd168b9d1, 0x00000000, 0xed2cc1ed, 0x20604020, 0xfc1fe3fc, 0xb1c879b1, 0x5bedb65b, 0x6abed46a, 0xcb468dcb, 0xbed967be, 0x394b7239, 0x4ade944a, 0x4cd4984c, 0x58e8b058, 0xcf4a85cf, 0xd06bbbd0, 0xef2ac5ef, 0xaae54faa, 0xfb16edfb, 0x43c58643, 0x4dd79a4d, 0x33556633, 0x85941185, 0x45cf8a45, 0xf910e9f9, 0x02060402, 0x7f81fe7f, 0x50f0a050, 0x3c44783c, 0x9fba259f, 0xa8e34ba8, 0x51f3a251, 0xa3fe5da3, 0x40c08040, 0x8f8a058f, 0x92ad3f92, 0x9dbc219d, 0x38487038, 0xf504f1f5, 0xbcdf63bc, 0xb6c177b6, 0xda75afda, 0x21634221, 0x10302010, 0xff1ae5ff, 0xf30efdf3, 0xd26dbfd2, 0xcd4c81cd, 0x0c14180c, 0x13352613, 0xec2fc3ec, 0x5fe1be5f, 0x97a23597, 0x44cc8844, 0x17392e17, 0xc45793c4, 0xa7f255a7, 0x7e82fc7e, 0x3d477a3d, 0x64acc864, 0x5de7ba5d, 0x192b3219, 0x7395e673, 0x60a0c060, 0x81981981, 0x4fd19e4f, 0xdc7fa3dc, 0x22664422, 0x2a7e542a, 0x90ab3b90, 0x88830b88, 0x46ca8c46, 0xee29c7ee, 0xb8d36bb8, 0x143c2814, 0xde79a7de, 0x5ee2bc5e, 0x0b1d160b, 0xdb76addb, 0xe03bdbe0, 0x32566432, 0x3a4e743a, 0x0a1e140a, 0x49db9249, 0x060a0c06, 0x246c4824, 0x5ce4b85c, 0xc25d9fc2, 0xd36ebdd3, 0xacef43ac, 0x62a6c462, 0x91a83991, 0x95a43195, 0xe437d3e4, 0x798bf279, 0xe732d5e7, 0xc8438bc8, 0x37596e37, 0x6db7da6d, 0x8d8c018d, 0xd564b1d5, 0x4ed29c4e, 0xa9e049a9, 0x6cb4d86c, 0x56faac56, 0xf407f3f4, 0xea25cfea, 0x65afca65, 0x7a8ef47a, 0xaee947ae, 0x08181008, 0xbad56fba, 0x7888f078, 0x256f4a25, 0x2e725c2e, 0x1c24381c, 0xa6f157a6, 0xb4c773b4, 0xc65197c6, 0xe823cbe8, 0xdd7ca1dd, 0x749ce874, 0x1f213e1f, 0x4bdd964b, 0xbddc61bd, 0x8b860d8b, 0x8a850f8a, 0x7090e070, 0x3e427c3e, 0xb5c471b5, 0x66aacc66, 0x48d89048, 0x03050603, 0xf601f7f6, 0x0e121c0e, 0x61a3c261, 0x355f6a35, 0x57f9ae57, 0xb9d069b9, 0x86911786, 0xc15899c1, 0x1d273a1d, 0x9eb9279e, 0xe138d9e1, 0xf813ebf8, 0x98b32b98, 0x11332211, 0x69bbd269, 0xd970a9d9, 0x8e89078e, 0x94a73394, 0x9bb62d9b, 0x1e223c1e, 0x87921587, 0xe920c9e9, 0xce4987ce, 0x55ffaa55, 0x28785028, 0xdf7aa5df, 0x8c8f038c, 0xa1f859a1, 0x89800989, 0x0d171a0d, 0xbfda65bf, 0xe631d7e6, 0x42c68442, 0x68b8d068, 0x41c38241, 0x99b02999, 0x2d775a2d, 0x0f111e0f, 0xb0cb7bb0, 0x54fca854, 0xbbd66dbb, 0x163a2c16];\r\n  var T4 = [0x6363a5c6, 0x7c7c84f8, 0x777799ee, 0x7b7b8df6, 0xf2f20dff, 0x6b6bbdd6, 0x6f6fb1de, 0xc5c55491, 0x30305060, 0x01010302, 0x6767a9ce, 0x2b2b7d56, 0xfefe19e7, 0xd7d762b5, 0xababe64d, 0x76769aec, 0xcaca458f, 0x82829d1f, 0xc9c94089, 0x7d7d87fa, 0xfafa15ef, 0x5959ebb2, 0x4747c98e, 0xf0f00bfb, 0xadadec41, 0xd4d467b3, 0xa2a2fd5f, 0xafafea45, 0x9c9cbf23, 0xa4a4f753, 0x727296e4, 0xc0c05b9b, 0xb7b7c275, 0xfdfd1ce1, 0x9393ae3d, 0x26266a4c, 0x36365a6c, 0x3f3f417e, 0xf7f702f5, 0xcccc4f83, 0x34345c68, 0xa5a5f451, 0xe5e534d1, 0xf1f108f9, 0x717193e2, 0xd8d873ab, 0x31315362, 0x15153f2a, 0x04040c08, 0xc7c75295, 0x23236546, 0xc3c35e9d, 0x18182830, 0x9696a137, 0x05050f0a, 0x9a9ab52f, 0x0707090e, 0x12123624, 0x80809b1b, 0xe2e23ddf, 0xebeb26cd, 0x2727694e, 0xb2b2cd7f, 0x75759fea, 0x09091b12, 0x83839e1d, 0x2c2c7458, 0x1a1a2e34, 0x1b1b2d36, 0x6e6eb2dc, 0x5a5aeeb4, 0xa0a0fb5b, 0x5252f6a4, 0x3b3b4d76, 0xd6d661b7, 0xb3b3ce7d, 0x29297b52, 0xe3e33edd, 0x2f2f715e, 0x84849713, 0x5353f5a6, 0xd1d168b9, 0x00000000, 0xeded2cc1, 0x20206040, 0xfcfc1fe3, 0xb1b1c879, 0x5b5bedb6, 0x6a6abed4, 0xcbcb468d, 0xbebed967, 0x39394b72, 0x4a4ade94, 0x4c4cd498, 0x5858e8b0, 0xcfcf4a85, 0xd0d06bbb, 0xefef2ac5, 0xaaaae54f, 0xfbfb16ed, 0x4343c586, 0x4d4dd79a, 0x33335566, 0x85859411, 0x4545cf8a, 0xf9f910e9, 0x02020604, 0x7f7f81fe, 0x5050f0a0, 0x3c3c4478, 0x9f9fba25, 0xa8a8e34b, 0x5151f3a2, 0xa3a3fe5d, 0x4040c080, 0x8f8f8a05, 0x9292ad3f, 0x9d9dbc21, 0x38384870, 0xf5f504f1, 0xbcbcdf63, 0xb6b6c177, 0xdada75af, 0x21216342, 0x10103020, 0xffff1ae5, 0xf3f30efd, 0xd2d26dbf, 0xcdcd4c81, 0x0c0c1418, 0x13133526, 0xecec2fc3, 0x5f5fe1be, 0x9797a235, 0x4444cc88, 0x1717392e, 0xc4c45793, 0xa7a7f255, 0x7e7e82fc, 0x3d3d477a, 0x6464acc8, 0x5d5de7ba, 0x19192b32, 0x737395e6, 0x6060a0c0, 0x81819819, 0x4f4fd19e, 0xdcdc7fa3, 0x22226644, 0x2a2a7e54, 0x9090ab3b, 0x8888830b, 0x4646ca8c, 0xeeee29c7, 0xb8b8d36b, 0x14143c28, 0xdede79a7, 0x5e5ee2bc, 0x0b0b1d16, 0xdbdb76ad, 0xe0e03bdb, 0x32325664, 0x3a3a4e74, 0x0a0a1e14, 0x4949db92, 0x06060a0c, 0x24246c48, 0x5c5ce4b8, 0xc2c25d9f, 0xd3d36ebd, 0xacacef43, 0x6262a6c4, 0x9191a839, 0x9595a431, 0xe4e437d3, 0x79798bf2, 0xe7e732d5, 0xc8c8438b, 0x3737596e, 0x6d6db7da, 0x8d8d8c01, 0xd5d564b1, 0x4e4ed29c, 0xa9a9e049, 0x6c6cb4d8, 0x5656faac, 0xf4f407f3, 0xeaea25cf, 0x6565afca, 0x7a7a8ef4, 0xaeaee947, 0x08081810, 0xbabad56f, 0x787888f0, 0x25256f4a, 0x2e2e725c, 0x1c1c2438, 0xa6a6f157, 0xb4b4c773, 0xc6c65197, 0xe8e823cb, 0xdddd7ca1, 0x74749ce8, 0x1f1f213e, 0x4b4bdd96, 0xbdbddc61, 0x8b8b860d, 0x8a8a850f, 0x707090e0, 0x3e3e427c, 0xb5b5c471, 0x6666aacc, 0x4848d890, 0x03030506, 0xf6f601f7, 0x0e0e121c, 0x6161a3c2, 0x35355f6a, 0x5757f9ae, 0xb9b9d069, 0x86869117, 0xc1c15899, 0x1d1d273a, 0x9e9eb927, 0xe1e138d9, 0xf8f813eb, 0x9898b32b, 0x11113322, 0x6969bbd2, 0xd9d970a9, 0x8e8e8907, 0x9494a733, 0x9b9bb62d, 0x1e1e223c, 0x87879215, 0xe9e920c9, 0xcece4987, 0x5555ffaa, 0x28287850, 0xdfdf7aa5, 0x8c8c8f03, 0xa1a1f859, 0x89898009, 0x0d0d171a, 0xbfbfda65, 0xe6e631d7, 0x4242c684, 0x6868b8d0, 0x4141c382, 0x9999b029, 0x2d2d775a, 0x0f0f111e, 0xb0b0cb7b, 0x5454fca8, 0xbbbbd66d, 0x16163a2c];\r\n\r\n  // Transformations for decryption\r\n  var T5 = [0x51f4a750, 0x7e416553, 0x1a17a4c3, 0x3a275e96, 0x3bab6bcb, 0x1f9d45f1, 0xacfa58ab, 0x4be30393, 0x2030fa55, 0xad766df6, 0x88cc7691, 0xf5024c25, 0x4fe5d7fc, 0xc52acbd7, 0x26354480, 0xb562a38f, 0xdeb15a49, 0x25ba1b67, 0x45ea0e98, 0x5dfec0e1, 0xc32f7502, 0x814cf012, 0x8d4697a3, 0x6bd3f9c6, 0x038f5fe7, 0x15929c95, 0xbf6d7aeb, 0x955259da, 0xd4be832d, 0x587421d3, 0x49e06929, 0x8ec9c844, 0x75c2896a, 0xf48e7978, 0x99583e6b, 0x27b971dd, 0xbee14fb6, 0xf088ad17, 0xc920ac66, 0x7dce3ab4, 0x63df4a18, 0xe51a3182, 0x97513360, 0x62537f45, 0xb16477e0, 0xbb6bae84, 0xfe81a01c, 0xf9082b94, 0x70486858, 0x8f45fd19, 0x94de6c87, 0x527bf8b7, 0xab73d323, 0x724b02e2, 0xe31f8f57, 0x6655ab2a, 0xb2eb2807, 0x2fb5c203, 0x86c57b9a, 0xd33708a5, 0x302887f2, 0x23bfa5b2, 0x02036aba, 0xed16825c, 0x8acf1c2b, 0xa779b492, 0xf307f2f0, 0x4e69e2a1, 0x65daf4cd, 0x0605bed5, 0xd134621f, 0xc4a6fe8a, 0x342e539d, 0xa2f355a0, 0x058ae132, 0xa4f6eb75, 0x0b83ec39, 0x4060efaa, 0x5e719f06, 0xbd6e1051, 0x3e218af9, 0x96dd063d, 0xdd3e05ae, 0x4de6bd46, 0x91548db5, 0x71c45d05, 0x0406d46f, 0x605015ff, 0x1998fb24, 0xd6bde997, 0x894043cc, 0x67d99e77, 0xb0e842bd, 0x07898b88, 0xe7195b38, 0x79c8eedb, 0xa17c0a47, 0x7c420fe9, 0xf8841ec9, 0x00000000, 0x09808683, 0x322bed48, 0x1e1170ac, 0x6c5a724e, 0xfd0efffb, 0x0f853856, 0x3daed51e, 0x362d3927, 0x0a0fd964, 0x685ca621, 0x9b5b54d1, 0x24362e3a, 0x0c0a67b1, 0x9357e70f, 0xb4ee96d2, 0x1b9b919e, 0x80c0c54f, 0x61dc20a2, 0x5a774b69, 0x1c121a16, 0xe293ba0a, 0xc0a02ae5, 0x3c22e043, 0x121b171d, 0x0e090d0b, 0xf28bc7ad, 0x2db6a8b9, 0x141ea9c8, 0x57f11985, 0xaf75074c, 0xee99ddbb, 0xa37f60fd, 0xf701269f, 0x5c72f5bc, 0x44663bc5, 0x5bfb7e34, 0x8b432976, 0xcb23c6dc, 0xb6edfc68, 0xb8e4f163, 0xd731dcca, 0x42638510, 0x13972240, 0x84c61120, 0x854a247d, 0xd2bb3df8, 0xaef93211, 0xc729a16d, 0x1d9e2f4b, 0xdcb230f3, 0x0d8652ec, 0x77c1e3d0, 0x2bb3166c, 0xa970b999, 0x119448fa, 0x47e96422, 0xa8fc8cc4, 0xa0f03f1a, 0x567d2cd8, 0x223390ef, 0x87494ec7, 0xd938d1c1, 0x8ccaa2fe, 0x98d40b36, 0xa6f581cf, 0xa57ade28, 0xdab78e26, 0x3fadbfa4, 0x2c3a9de4, 0x5078920d, 0x6a5fcc9b, 0x547e4662, 0xf68d13c2, 0x90d8b8e8, 0x2e39f75e, 0x82c3aff5, 0x9f5d80be, 0x69d0937c, 0x6fd52da9, 0xcf2512b3, 0xc8ac993b, 0x10187da7, 0xe89c636e, 0xdb3bbb7b, 0xcd267809, 0x6e5918f4, 0xec9ab701, 0x834f9aa8, 0xe6956e65, 0xaaffe67e, 0x21bccf08, 0xef15e8e6, 0xbae79bd9, 0x4a6f36ce, 0xea9f09d4, 0x29b07cd6, 0x31a4b2af, 0x2a3f2331, 0xc6a59430, 0x35a266c0, 0x744ebc37, 0xfc82caa6, 0xe090d0b0, 0x33a7d815, 0xf104984a, 0x41ecdaf7, 0x7fcd500e, 0x1791f62f, 0x764dd68d, 0x43efb04d, 0xccaa4d54, 0xe49604df, 0x9ed1b5e3, 0x4c6a881b, 0xc12c1fb8, 0x4665517f, 0x9d5eea04, 0x018c355d, 0xfa877473, 0xfb0b412e, 0xb3671d5a, 0x92dbd252, 0xe9105633, 0x6dd64713, 0x9ad7618c, 0x37a10c7a, 0x59f8148e, 0xeb133c89, 0xcea927ee, 0xb761c935, 0xe11ce5ed, 0x7a47b13c, 0x9cd2df59, 0x55f2733f, 0x1814ce79, 0x73c737bf, 0x53f7cdea, 0x5ffdaa5b, 0xdf3d6f14, 0x7844db86, 0xcaaff381, 0xb968c43e, 0x3824342c, 0xc2a3405f, 0x161dc372, 0xbce2250c, 0x283c498b, 0xff0d9541, 0x39a80171, 0x080cb3de, 0xd8b4e49c, 0x6456c190, 0x7bcb8461, 0xd532b670, 0x486c5c74, 0xd0b85742];\r\n  var T6 = [0x5051f4a7, 0x537e4165, 0xc31a17a4, 0x963a275e, 0xcb3bab6b, 0xf11f9d45, 0xabacfa58, 0x934be303, 0x552030fa, 0xf6ad766d, 0x9188cc76, 0x25f5024c, 0xfc4fe5d7, 0xd7c52acb, 0x80263544, 0x8fb562a3, 0x49deb15a, 0x6725ba1b, 0x9845ea0e, 0xe15dfec0, 0x02c32f75, 0x12814cf0, 0xa38d4697, 0xc66bd3f9, 0xe7038f5f, 0x9515929c, 0xebbf6d7a, 0xda955259, 0x2dd4be83, 0xd3587421, 0x2949e069, 0x448ec9c8, 0x6a75c289, 0x78f48e79, 0x6b99583e, 0xdd27b971, 0xb6bee14f, 0x17f088ad, 0x66c920ac, 0xb47dce3a, 0x1863df4a, 0x82e51a31, 0x60975133, 0x4562537f, 0xe0b16477, 0x84bb6bae, 0x1cfe81a0, 0x94f9082b, 0x58704868, 0x198f45fd, 0x8794de6c, 0xb7527bf8, 0x23ab73d3, 0xe2724b02, 0x57e31f8f, 0x2a6655ab, 0x07b2eb28, 0x032fb5c2, 0x9a86c57b, 0xa5d33708, 0xf2302887, 0xb223bfa5, 0xba02036a, 0x5ced1682, 0x2b8acf1c, 0x92a779b4, 0xf0f307f2, 0xa14e69e2, 0xcd65daf4, 0xd50605be, 0x1fd13462, 0x8ac4a6fe, 0x9d342e53, 0xa0a2f355, 0x32058ae1, 0x75a4f6eb, 0x390b83ec, 0xaa4060ef, 0x065e719f, 0x51bd6e10, 0xf93e218a, 0x3d96dd06, 0xaedd3e05, 0x464de6bd, 0xb591548d, 0x0571c45d, 0x6f0406d4, 0xff605015, 0x241998fb, 0x97d6bde9, 0xcc894043, 0x7767d99e, 0xbdb0e842, 0x8807898b, 0x38e7195b, 0xdb79c8ee, 0x47a17c0a, 0xe97c420f, 0xc9f8841e, 0x00000000, 0x83098086, 0x48322bed, 0xac1e1170, 0x4e6c5a72, 0xfbfd0eff, 0x560f8538, 0x1e3daed5, 0x27362d39, 0x640a0fd9, 0x21685ca6, 0xd19b5b54, 0x3a24362e, 0xb10c0a67, 0x0f9357e7, 0xd2b4ee96, 0x9e1b9b91, 0x4f80c0c5, 0xa261dc20, 0x695a774b, 0x161c121a, 0x0ae293ba, 0xe5c0a02a, 0x433c22e0, 0x1d121b17, 0x0b0e090d, 0xadf28bc7, 0xb92db6a8, 0xc8141ea9, 0x8557f119, 0x4caf7507, 0xbbee99dd, 0xfda37f60, 0x9ff70126, 0xbc5c72f5, 0xc544663b, 0x345bfb7e, 0x768b4329, 0xdccb23c6, 0x68b6edfc, 0x63b8e4f1, 0xcad731dc, 0x10426385, 0x40139722, 0x2084c611, 0x7d854a24, 0xf8d2bb3d, 0x11aef932, 0x6dc729a1, 0x4b1d9e2f, 0xf3dcb230, 0xec0d8652, 0xd077c1e3, 0x6c2bb316, 0x99a970b9, 0xfa119448, 0x2247e964, 0xc4a8fc8c, 0x1aa0f03f, 0xd8567d2c, 0xef223390, 0xc787494e, 0xc1d938d1, 0xfe8ccaa2, 0x3698d40b, 0xcfa6f581, 0x28a57ade, 0x26dab78e, 0xa43fadbf, 0xe42c3a9d, 0x0d507892, 0x9b6a5fcc, 0x62547e46, 0xc2f68d13, 0xe890d8b8, 0x5e2e39f7, 0xf582c3af, 0xbe9f5d80, 0x7c69d093, 0xa96fd52d, 0xb3cf2512, 0x3bc8ac99, 0xa710187d, 0x6ee89c63, 0x7bdb3bbb, 0x09cd2678, 0xf46e5918, 0x01ec9ab7, 0xa8834f9a, 0x65e6956e, 0x7eaaffe6, 0x0821bccf, 0xe6ef15e8, 0xd9bae79b, 0xce4a6f36, 0xd4ea9f09, 0xd629b07c, 0xaf31a4b2, 0x312a3f23, 0x30c6a594, 0xc035a266, 0x37744ebc, 0xa6fc82ca, 0xb0e090d0, 0x1533a7d8, 0x4af10498, 0xf741ecda, 0x0e7fcd50, 0x2f1791f6, 0x8d764dd6, 0x4d43efb0, 0x54ccaa4d, 0xdfe49604, 0xe39ed1b5, 0x1b4c6a88, 0xb8c12c1f, 0x7f466551, 0x049d5eea, 0x5d018c35, 0x73fa8774, 0x2efb0b41, 0x5ab3671d, 0x5292dbd2, 0x33e91056, 0x136dd647, 0x8c9ad761, 0x7a37a10c, 0x8e59f814, 0x89eb133c, 0xeecea927, 0x35b761c9, 0xede11ce5, 0x3c7a47b1, 0x599cd2df, 0x3f55f273, 0x791814ce, 0xbf73c737, 0xea53f7cd, 0x5b5ffdaa, 0x14df3d6f, 0x867844db, 0x81caaff3, 0x3eb968c4, 0x2c382434, 0x5fc2a340, 0x72161dc3, 0x0cbce225, 0x8b283c49, 0x41ff0d95, 0x7139a801, 0xde080cb3, 0x9cd8b4e4, 0x906456c1, 0x617bcb84, 0x70d532b6, 0x74486c5c, 0x42d0b857];\r\n  var T7 = [0xa75051f4, 0x65537e41, 0xa4c31a17, 0x5e963a27, 0x6bcb3bab, 0x45f11f9d, 0x58abacfa, 0x03934be3, 0xfa552030, 0x6df6ad76, 0x769188cc, 0x4c25f502, 0xd7fc4fe5, 0xcbd7c52a, 0x44802635, 0xa38fb562, 0x5a49deb1, 0x1b6725ba, 0x0e9845ea, 0xc0e15dfe, 0x7502c32f, 0xf012814c, 0x97a38d46, 0xf9c66bd3, 0x5fe7038f, 0x9c951592, 0x7aebbf6d, 0x59da9552, 0x832dd4be, 0x21d35874, 0x692949e0, 0xc8448ec9, 0x896a75c2, 0x7978f48e, 0x3e6b9958, 0x71dd27b9, 0x4fb6bee1, 0xad17f088, 0xac66c920, 0x3ab47dce, 0x4a1863df, 0x3182e51a, 0x33609751, 0x7f456253, 0x77e0b164, 0xae84bb6b, 0xa01cfe81, 0x2b94f908, 0x68587048, 0xfd198f45, 0x6c8794de, 0xf8b7527b, 0xd323ab73, 0x02e2724b, 0x8f57e31f, 0xab2a6655, 0x2807b2eb, 0xc2032fb5, 0x7b9a86c5, 0x08a5d337, 0x87f23028, 0xa5b223bf, 0x6aba0203, 0x825ced16, 0x1c2b8acf, 0xb492a779, 0xf2f0f307, 0xe2a14e69, 0xf4cd65da, 0xbed50605, 0x621fd134, 0xfe8ac4a6, 0x539d342e, 0x55a0a2f3, 0xe132058a, 0xeb75a4f6, 0xec390b83, 0xefaa4060, 0x9f065e71, 0x1051bd6e, 0x8af93e21, 0x063d96dd, 0x05aedd3e, 0xbd464de6, 0x8db59154, 0x5d0571c4, 0xd46f0406, 0x15ff6050, 0xfb241998, 0xe997d6bd, 0x43cc8940, 0x9e7767d9, 0x42bdb0e8, 0x8b880789, 0x5b38e719, 0xeedb79c8, 0x0a47a17c, 0x0fe97c42, 0x1ec9f884, 0x00000000, 0x86830980, 0xed48322b, 0x70ac1e11, 0x724e6c5a, 0xfffbfd0e, 0x38560f85, 0xd51e3dae, 0x3927362d, 0xd9640a0f, 0xa621685c, 0x54d19b5b, 0x2e3a2436, 0x67b10c0a, 0xe70f9357, 0x96d2b4ee, 0x919e1b9b, 0xc54f80c0, 0x20a261dc, 0x4b695a77, 0x1a161c12, 0xba0ae293, 0x2ae5c0a0, 0xe0433c22, 0x171d121b, 0x0d0b0e09, 0xc7adf28b, 0xa8b92db6, 0xa9c8141e, 0x198557f1, 0x074caf75, 0xddbbee99, 0x60fda37f, 0x269ff701, 0xf5bc5c72, 0x3bc54466, 0x7e345bfb, 0x29768b43, 0xc6dccb23, 0xfc68b6ed, 0xf163b8e4, 0xdccad731, 0x85104263, 0x22401397, 0x112084c6, 0x247d854a, 0x3df8d2bb, 0x3211aef9, 0xa16dc729, 0x2f4b1d9e, 0x30f3dcb2, 0x52ec0d86, 0xe3d077c1, 0x166c2bb3, 0xb999a970, 0x48fa1194, 0x642247e9, 0x8cc4a8fc, 0x3f1aa0f0, 0x2cd8567d, 0x90ef2233, 0x4ec78749, 0xd1c1d938, 0xa2fe8cca, 0x0b3698d4, 0x81cfa6f5, 0xde28a57a, 0x8e26dab7, 0xbfa43fad, 0x9de42c3a, 0x920d5078, 0xcc9b6a5f, 0x4662547e, 0x13c2f68d, 0xb8e890d8, 0xf75e2e39, 0xaff582c3, 0x80be9f5d, 0x937c69d0, 0x2da96fd5, 0x12b3cf25, 0x993bc8ac, 0x7da71018, 0x636ee89c, 0xbb7bdb3b, 0x7809cd26, 0x18f46e59, 0xb701ec9a, 0x9aa8834f, 0x6e65e695, 0xe67eaaff, 0xcf0821bc, 0xe8e6ef15, 0x9bd9bae7, 0x36ce4a6f, 0x09d4ea9f, 0x7cd629b0, 0xb2af31a4, 0x23312a3f, 0x9430c6a5, 0x66c035a2, 0xbc37744e, 0xcaa6fc82, 0xd0b0e090, 0xd81533a7, 0x984af104, 0xdaf741ec, 0x500e7fcd, 0xf62f1791, 0xd68d764d, 0xb04d43ef, 0x4d54ccaa, 0x04dfe496, 0xb5e39ed1, 0x881b4c6a, 0x1fb8c12c, 0x517f4665, 0xea049d5e, 0x355d018c, 0x7473fa87, 0x412efb0b, 0x1d5ab367, 0xd25292db, 0x5633e910, 0x47136dd6, 0x618c9ad7, 0x0c7a37a1, 0x148e59f8, 0x3c89eb13, 0x27eecea9, 0xc935b761, 0xe5ede11c, 0xb13c7a47, 0xdf599cd2, 0x733f55f2, 0xce791814, 0x37bf73c7, 0xcdea53f7, 0xaa5b5ffd, 0x6f14df3d, 0xdb867844, 0xf381caaf, 0xc43eb968, 0x342c3824, 0x405fc2a3, 0xc372161d, 0x250cbce2, 0x498b283c, 0x9541ff0d, 0x017139a8, 0xb3de080c, 0xe49cd8b4, 0xc1906456, 0x84617bcb, 0xb670d532, 0x5c74486c, 0x5742d0b8];\r\n  var T8 = [0xf4a75051, 0x4165537e, 0x17a4c31a, 0x275e963a, 0xab6bcb3b, 0x9d45f11f, 0xfa58abac, 0xe303934b, 0x30fa5520, 0x766df6ad, 0xcc769188, 0x024c25f5, 0xe5d7fc4f, 0x2acbd7c5, 0x35448026, 0x62a38fb5, 0xb15a49de, 0xba1b6725, 0xea0e9845, 0xfec0e15d, 0x2f7502c3, 0x4cf01281, 0x4697a38d, 0xd3f9c66b, 0x8f5fe703, 0x929c9515, 0x6d7aebbf, 0x5259da95, 0xbe832dd4, 0x7421d358, 0xe0692949, 0xc9c8448e, 0xc2896a75, 0x8e7978f4, 0x583e6b99, 0xb971dd27, 0xe14fb6be, 0x88ad17f0, 0x20ac66c9, 0xce3ab47d, 0xdf4a1863, 0x1a3182e5, 0x51336097, 0x537f4562, 0x6477e0b1, 0x6bae84bb, 0x81a01cfe, 0x082b94f9, 0x48685870, 0x45fd198f, 0xde6c8794, 0x7bf8b752, 0x73d323ab, 0x4b02e272, 0x1f8f57e3, 0x55ab2a66, 0xeb2807b2, 0xb5c2032f, 0xc57b9a86, 0x3708a5d3, 0x2887f230, 0xbfa5b223, 0x036aba02, 0x16825ced, 0xcf1c2b8a, 0x79b492a7, 0x07f2f0f3, 0x69e2a14e, 0xdaf4cd65, 0x05bed506, 0x34621fd1, 0xa6fe8ac4, 0x2e539d34, 0xf355a0a2, 0x8ae13205, 0xf6eb75a4, 0x83ec390b, 0x60efaa40, 0x719f065e, 0x6e1051bd, 0x218af93e, 0xdd063d96, 0x3e05aedd, 0xe6bd464d, 0x548db591, 0xc45d0571, 0x06d46f04, 0x5015ff60, 0x98fb2419, 0xbde997d6, 0x4043cc89, 0xd99e7767, 0xe842bdb0, 0x898b8807, 0x195b38e7, 0xc8eedb79, 0x7c0a47a1, 0x420fe97c, 0x841ec9f8, 0x00000000, 0x80868309, 0x2bed4832, 0x1170ac1e, 0x5a724e6c, 0x0efffbfd, 0x8538560f, 0xaed51e3d, 0x2d392736, 0x0fd9640a, 0x5ca62168, 0x5b54d19b, 0x362e3a24, 0x0a67b10c, 0x57e70f93, 0xee96d2b4, 0x9b919e1b, 0xc0c54f80, 0xdc20a261, 0x774b695a, 0x121a161c, 0x93ba0ae2, 0xa02ae5c0, 0x22e0433c, 0x1b171d12, 0x090d0b0e, 0x8bc7adf2, 0xb6a8b92d, 0x1ea9c814, 0xf1198557, 0x75074caf, 0x99ddbbee, 0x7f60fda3, 0x01269ff7, 0x72f5bc5c, 0x663bc544, 0xfb7e345b, 0x4329768b, 0x23c6dccb, 0xedfc68b6, 0xe4f163b8, 0x31dccad7, 0x63851042, 0x97224013, 0xc6112084, 0x4a247d85, 0xbb3df8d2, 0xf93211ae, 0x29a16dc7, 0x9e2f4b1d, 0xb230f3dc, 0x8652ec0d, 0xc1e3d077, 0xb3166c2b, 0x70b999a9, 0x9448fa11, 0xe9642247, 0xfc8cc4a8, 0xf03f1aa0, 0x7d2cd856, 0x3390ef22, 0x494ec787, 0x38d1c1d9, 0xcaa2fe8c, 0xd40b3698, 0xf581cfa6, 0x7ade28a5, 0xb78e26da, 0xadbfa43f, 0x3a9de42c, 0x78920d50, 0x5fcc9b6a, 0x7e466254, 0x8d13c2f6, 0xd8b8e890, 0x39f75e2e, 0xc3aff582, 0x5d80be9f, 0xd0937c69, 0xd52da96f, 0x2512b3cf, 0xac993bc8, 0x187da710, 0x9c636ee8, 0x3bbb7bdb, 0x267809cd, 0x5918f46e, 0x9ab701ec, 0x4f9aa883, 0x956e65e6, 0xffe67eaa, 0xbccf0821, 0x15e8e6ef, 0xe79bd9ba, 0x6f36ce4a, 0x9f09d4ea, 0xb07cd629, 0xa4b2af31, 0x3f23312a, 0xa59430c6, 0xa266c035, 0x4ebc3774, 0x82caa6fc, 0x90d0b0e0, 0xa7d81533, 0x04984af1, 0xecdaf741, 0xcd500e7f, 0x91f62f17, 0x4dd68d76, 0xefb04d43, 0xaa4d54cc, 0x9604dfe4, 0xd1b5e39e, 0x6a881b4c, 0x2c1fb8c1, 0x65517f46, 0x5eea049d, 0x8c355d01, 0x877473fa, 0x0b412efb, 0x671d5ab3, 0xdbd25292, 0x105633e9, 0xd647136d, 0xd7618c9a, 0xa10c7a37, 0xf8148e59, 0x133c89eb, 0xa927eece, 0x61c935b7, 0x1ce5ede1, 0x47b13c7a, 0xd2df599c, 0xf2733f55, 0x14ce7918, 0xc737bf73, 0xf7cdea53, 0xfdaa5b5f, 0x3d6f14df, 0x44db8678, 0xaff381ca, 0x68c43eb9, 0x24342c38, 0xa3405fc2, 0x1dc37216, 0xe2250cbc, 0x3c498b28, 0x0d9541ff, 0xa8017139, 0x0cb3de08, 0xb4e49cd8, 0x56c19064, 0xcb84617b, 0x32b670d5, 0x6c5c7448, 0xb85742d0];\r\n\r\n  // Transformations for decryption key expansion\r\n  var U1 = [0x00000000, 0x0e090d0b, 0x1c121a16, 0x121b171d, 0x3824342c, 0x362d3927, 0x24362e3a, 0x2a3f2331, 0x70486858, 0x7e416553, 0x6c5a724e, 0x62537f45, 0x486c5c74, 0x4665517f, 0x547e4662, 0x5a774b69, 0xe090d0b0, 0xee99ddbb, 0xfc82caa6, 0xf28bc7ad, 0xd8b4e49c, 0xd6bde997, 0xc4a6fe8a, 0xcaaff381, 0x90d8b8e8, 0x9ed1b5e3, 0x8ccaa2fe, 0x82c3aff5, 0xa8fc8cc4, 0xa6f581cf, 0xb4ee96d2, 0xbae79bd9, 0xdb3bbb7b, 0xd532b670, 0xc729a16d, 0xc920ac66, 0xe31f8f57, 0xed16825c, 0xff0d9541, 0xf104984a, 0xab73d323, 0xa57ade28, 0xb761c935, 0xb968c43e, 0x9357e70f, 0x9d5eea04, 0x8f45fd19, 0x814cf012, 0x3bab6bcb, 0x35a266c0, 0x27b971dd, 0x29b07cd6, 0x038f5fe7, 0x0d8652ec, 0x1f9d45f1, 0x119448fa, 0x4be30393, 0x45ea0e98, 0x57f11985, 0x59f8148e, 0x73c737bf, 0x7dce3ab4, 0x6fd52da9, 0x61dc20a2, 0xad766df6, 0xa37f60fd, 0xb16477e0, 0xbf6d7aeb, 0x955259da, 0x9b5b54d1, 0x894043cc, 0x87494ec7, 0xdd3e05ae, 0xd33708a5, 0xc12c1fb8, 0xcf2512b3, 0xe51a3182, 0xeb133c89, 0xf9082b94, 0xf701269f, 0x4de6bd46, 0x43efb04d, 0x51f4a750, 0x5ffdaa5b, 0x75c2896a, 0x7bcb8461, 0x69d0937c, 0x67d99e77, 0x3daed51e, 0x33a7d815, 0x21bccf08, 0x2fb5c203, 0x058ae132, 0x0b83ec39, 0x1998fb24, 0x1791f62f, 0x764dd68d, 0x7844db86, 0x6a5fcc9b, 0x6456c190, 0x4e69e2a1, 0x4060efaa, 0x527bf8b7, 0x5c72f5bc, 0x0605bed5, 0x080cb3de, 0x1a17a4c3, 0x141ea9c8, 0x3e218af9, 0x302887f2, 0x223390ef, 0x2c3a9de4, 0x96dd063d, 0x98d40b36, 0x8acf1c2b, 0x84c61120, 0xaef93211, 0xa0f03f1a, 0xb2eb2807, 0xbce2250c, 0xe6956e65, 0xe89c636e, 0xfa877473, 0xf48e7978, 0xdeb15a49, 0xd0b85742, 0xc2a3405f, 0xccaa4d54, 0x41ecdaf7, 0x4fe5d7fc, 0x5dfec0e1, 0x53f7cdea, 0x79c8eedb, 0x77c1e3d0, 0x65daf4cd, 0x6bd3f9c6, 0x31a4b2af, 0x3fadbfa4, 0x2db6a8b9, 0x23bfa5b2, 0x09808683, 0x07898b88, 0x15929c95, 0x1b9b919e, 0xa17c0a47, 0xaf75074c, 0xbd6e1051, 0xb3671d5a, 0x99583e6b, 0x97513360, 0x854a247d, 0x8b432976, 0xd134621f, 0xdf3d6f14, 0xcd267809, 0xc32f7502, 0xe9105633, 0xe7195b38, 0xf5024c25, 0xfb0b412e, 0x9ad7618c, 0x94de6c87, 0x86c57b9a, 0x88cc7691, 0xa2f355a0, 0xacfa58ab, 0xbee14fb6, 0xb0e842bd, 0xea9f09d4, 0xe49604df, 0xf68d13c2, 0xf8841ec9, 0xd2bb3df8, 0xdcb230f3, 0xcea927ee, 0xc0a02ae5, 0x7a47b13c, 0x744ebc37, 0x6655ab2a, 0x685ca621, 0x42638510, 0x4c6a881b, 0x5e719f06, 0x5078920d, 0x0a0fd964, 0x0406d46f, 0x161dc372, 0x1814ce79, 0x322bed48, 0x3c22e043, 0x2e39f75e, 0x2030fa55, 0xec9ab701, 0xe293ba0a, 0xf088ad17, 0xfe81a01c, 0xd4be832d, 0xdab78e26, 0xc8ac993b, 0xc6a59430, 0x9cd2df59, 0x92dbd252, 0x80c0c54f, 0x8ec9c844, 0xa4f6eb75, 0xaaffe67e, 0xb8e4f163, 0xb6edfc68, 0x0c0a67b1, 0x02036aba, 0x10187da7, 0x1e1170ac, 0x342e539d, 0x3a275e96, 0x283c498b, 0x26354480, 0x7c420fe9, 0x724b02e2, 0x605015ff, 0x6e5918f4, 0x44663bc5, 0x4a6f36ce, 0x587421d3, 0x567d2cd8, 0x37a10c7a, 0x39a80171, 0x2bb3166c, 0x25ba1b67, 0x0f853856, 0x018c355d, 0x13972240, 0x1d9e2f4b, 0x47e96422, 0x49e06929, 0x5bfb7e34, 0x55f2733f, 0x7fcd500e, 0x71c45d05, 0x63df4a18, 0x6dd64713, 0xd731dcca, 0xd938d1c1, 0xcb23c6dc, 0xc52acbd7, 0xef15e8e6, 0xe11ce5ed, 0xf307f2f0, 0xfd0efffb, 0xa779b492, 0xa970b999, 0xbb6bae84, 0xb562a38f, 0x9f5d80be, 0x91548db5, 0x834f9aa8, 0x8d4697a3];\r\n  var U2 = [0x00000000, 0x0b0e090d, 0x161c121a, 0x1d121b17, 0x2c382434, 0x27362d39, 0x3a24362e, 0x312a3f23, 0x58704868, 0x537e4165, 0x4e6c5a72, 0x4562537f, 0x74486c5c, 0x7f466551, 0x62547e46, 0x695a774b, 0xb0e090d0, 0xbbee99dd, 0xa6fc82ca, 0xadf28bc7, 0x9cd8b4e4, 0x97d6bde9, 0x8ac4a6fe, 0x81caaff3, 0xe890d8b8, 0xe39ed1b5, 0xfe8ccaa2, 0xf582c3af, 0xc4a8fc8c, 0xcfa6f581, 0xd2b4ee96, 0xd9bae79b, 0x7bdb3bbb, 0x70d532b6, 0x6dc729a1, 0x66c920ac, 0x57e31f8f, 0x5ced1682, 0x41ff0d95, 0x4af10498, 0x23ab73d3, 0x28a57ade, 0x35b761c9, 0x3eb968c4, 0x0f9357e7, 0x049d5eea, 0x198f45fd, 0x12814cf0, 0xcb3bab6b, 0xc035a266, 0xdd27b971, 0xd629b07c, 0xe7038f5f, 0xec0d8652, 0xf11f9d45, 0xfa119448, 0x934be303, 0x9845ea0e, 0x8557f119, 0x8e59f814, 0xbf73c737, 0xb47dce3a, 0xa96fd52d, 0xa261dc20, 0xf6ad766d, 0xfda37f60, 0xe0b16477, 0xebbf6d7a, 0xda955259, 0xd19b5b54, 0xcc894043, 0xc787494e, 0xaedd3e05, 0xa5d33708, 0xb8c12c1f, 0xb3cf2512, 0x82e51a31, 0x89eb133c, 0x94f9082b, 0x9ff70126, 0x464de6bd, 0x4d43efb0, 0x5051f4a7, 0x5b5ffdaa, 0x6a75c289, 0x617bcb84, 0x7c69d093, 0x7767d99e, 0x1e3daed5, 0x1533a7d8, 0x0821bccf, 0x032fb5c2, 0x32058ae1, 0x390b83ec, 0x241998fb, 0x2f1791f6, 0x8d764dd6, 0x867844db, 0x9b6a5fcc, 0x906456c1, 0xa14e69e2, 0xaa4060ef, 0xb7527bf8, 0xbc5c72f5, 0xd50605be, 0xde080cb3, 0xc31a17a4, 0xc8141ea9, 0xf93e218a, 0xf2302887, 0xef223390, 0xe42c3a9d, 0x3d96dd06, 0x3698d40b, 0x2b8acf1c, 0x2084c611, 0x11aef932, 0x1aa0f03f, 0x07b2eb28, 0x0cbce225, 0x65e6956e, 0x6ee89c63, 0x73fa8774, 0x78f48e79, 0x49deb15a, 0x42d0b857, 0x5fc2a340, 0x54ccaa4d, 0xf741ecda, 0xfc4fe5d7, 0xe15dfec0, 0xea53f7cd, 0xdb79c8ee, 0xd077c1e3, 0xcd65daf4, 0xc66bd3f9, 0xaf31a4b2, 0xa43fadbf, 0xb92db6a8, 0xb223bfa5, 0x83098086, 0x8807898b, 0x9515929c, 0x9e1b9b91, 0x47a17c0a, 0x4caf7507, 0x51bd6e10, 0x5ab3671d, 0x6b99583e, 0x60975133, 0x7d854a24, 0x768b4329, 0x1fd13462, 0x14df3d6f, 0x09cd2678, 0x02c32f75, 0x33e91056, 0x38e7195b, 0x25f5024c, 0x2efb0b41, 0x8c9ad761, 0x8794de6c, 0x9a86c57b, 0x9188cc76, 0xa0a2f355, 0xabacfa58, 0xb6bee14f, 0xbdb0e842, 0xd4ea9f09, 0xdfe49604, 0xc2f68d13, 0xc9f8841e, 0xf8d2bb3d, 0xf3dcb230, 0xeecea927, 0xe5c0a02a, 0x3c7a47b1, 0x37744ebc, 0x2a6655ab, 0x21685ca6, 0x10426385, 0x1b4c6a88, 0x065e719f, 0x0d507892, 0x640a0fd9, 0x6f0406d4, 0x72161dc3, 0x791814ce, 0x48322bed, 0x433c22e0, 0x5e2e39f7, 0x552030fa, 0x01ec9ab7, 0x0ae293ba, 0x17f088ad, 0x1cfe81a0, 0x2dd4be83, 0x26dab78e, 0x3bc8ac99, 0x30c6a594, 0x599cd2df, 0x5292dbd2, 0x4f80c0c5, 0x448ec9c8, 0x75a4f6eb, 0x7eaaffe6, 0x63b8e4f1, 0x68b6edfc, 0xb10c0a67, 0xba02036a, 0xa710187d, 0xac1e1170, 0x9d342e53, 0x963a275e, 0x8b283c49, 0x80263544, 0xe97c420f, 0xe2724b02, 0xff605015, 0xf46e5918, 0xc544663b, 0xce4a6f36, 0xd3587421, 0xd8567d2c, 0x7a37a10c, 0x7139a801, 0x6c2bb316, 0x6725ba1b, 0x560f8538, 0x5d018c35, 0x40139722, 0x4b1d9e2f, 0x2247e964, 0x2949e069, 0x345bfb7e, 0x3f55f273, 0x0e7fcd50, 0x0571c45d, 0x1863df4a, 0x136dd647, 0xcad731dc, 0xc1d938d1, 0xdccb23c6, 0xd7c52acb, 0xe6ef15e8, 0xede11ce5, 0xf0f307f2, 0xfbfd0eff, 0x92a779b4, 0x99a970b9, 0x84bb6bae, 0x8fb562a3, 0xbe9f5d80, 0xb591548d, 0xa8834f9a, 0xa38d4697];\r\n  var U3 = [0x00000000, 0x0d0b0e09, 0x1a161c12, 0x171d121b, 0x342c3824, 0x3927362d, 0x2e3a2436, 0x23312a3f, 0x68587048, 0x65537e41, 0x724e6c5a, 0x7f456253, 0x5c74486c, 0x517f4665, 0x4662547e, 0x4b695a77, 0xd0b0e090, 0xddbbee99, 0xcaa6fc82, 0xc7adf28b, 0xe49cd8b4, 0xe997d6bd, 0xfe8ac4a6, 0xf381caaf, 0xb8e890d8, 0xb5e39ed1, 0xa2fe8cca, 0xaff582c3, 0x8cc4a8fc, 0x81cfa6f5, 0x96d2b4ee, 0x9bd9bae7, 0xbb7bdb3b, 0xb670d532, 0xa16dc729, 0xac66c920, 0x8f57e31f, 0x825ced16, 0x9541ff0d, 0x984af104, 0xd323ab73, 0xde28a57a, 0xc935b761, 0xc43eb968, 0xe70f9357, 0xea049d5e, 0xfd198f45, 0xf012814c, 0x6bcb3bab, 0x66c035a2, 0x71dd27b9, 0x7cd629b0, 0x5fe7038f, 0x52ec0d86, 0x45f11f9d, 0x48fa1194, 0x03934be3, 0x0e9845ea, 0x198557f1, 0x148e59f8, 0x37bf73c7, 0x3ab47dce, 0x2da96fd5, 0x20a261dc, 0x6df6ad76, 0x60fda37f, 0x77e0b164, 0x7aebbf6d, 0x59da9552, 0x54d19b5b, 0x43cc8940, 0x4ec78749, 0x05aedd3e, 0x08a5d337, 0x1fb8c12c, 0x12b3cf25, 0x3182e51a, 0x3c89eb13, 0x2b94f908, 0x269ff701, 0xbd464de6, 0xb04d43ef, 0xa75051f4, 0xaa5b5ffd, 0x896a75c2, 0x84617bcb, 0x937c69d0, 0x9e7767d9, 0xd51e3dae, 0xd81533a7, 0xcf0821bc, 0xc2032fb5, 0xe132058a, 0xec390b83, 0xfb241998, 0xf62f1791, 0xd68d764d, 0xdb867844, 0xcc9b6a5f, 0xc1906456, 0xe2a14e69, 0xefaa4060, 0xf8b7527b, 0xf5bc5c72, 0xbed50605, 0xb3de080c, 0xa4c31a17, 0xa9c8141e, 0x8af93e21, 0x87f23028, 0x90ef2233, 0x9de42c3a, 0x063d96dd, 0x0b3698d4, 0x1c2b8acf, 0x112084c6, 0x3211aef9, 0x3f1aa0f0, 0x2807b2eb, 0x250cbce2, 0x6e65e695, 0x636ee89c, 0x7473fa87, 0x7978f48e, 0x5a49deb1, 0x5742d0b8, 0x405fc2a3, 0x4d54ccaa, 0xdaf741ec, 0xd7fc4fe5, 0xc0e15dfe, 0xcdea53f7, 0xeedb79c8, 0xe3d077c1, 0xf4cd65da, 0xf9c66bd3, 0xb2af31a4, 0xbfa43fad, 0xa8b92db6, 0xa5b223bf, 0x86830980, 0x8b880789, 0x9c951592, 0x919e1b9b, 0x0a47a17c, 0x074caf75, 0x1051bd6e, 0x1d5ab367, 0x3e6b9958, 0x33609751, 0x247d854a, 0x29768b43, 0x621fd134, 0x6f14df3d, 0x7809cd26, 0x7502c32f, 0x5633e910, 0x5b38e719, 0x4c25f502, 0x412efb0b, 0x618c9ad7, 0x6c8794de, 0x7b9a86c5, 0x769188cc, 0x55a0a2f3, 0x58abacfa, 0x4fb6bee1, 0x42bdb0e8, 0x09d4ea9f, 0x04dfe496, 0x13c2f68d, 0x1ec9f884, 0x3df8d2bb, 0x30f3dcb2, 0x27eecea9, 0x2ae5c0a0, 0xb13c7a47, 0xbc37744e, 0xab2a6655, 0xa621685c, 0x85104263, 0x881b4c6a, 0x9f065e71, 0x920d5078, 0xd9640a0f, 0xd46f0406, 0xc372161d, 0xce791814, 0xed48322b, 0xe0433c22, 0xf75e2e39, 0xfa552030, 0xb701ec9a, 0xba0ae293, 0xad17f088, 0xa01cfe81, 0x832dd4be, 0x8e26dab7, 0x993bc8ac, 0x9430c6a5, 0xdf599cd2, 0xd25292db, 0xc54f80c0, 0xc8448ec9, 0xeb75a4f6, 0xe67eaaff, 0xf163b8e4, 0xfc68b6ed, 0x67b10c0a, 0x6aba0203, 0x7da71018, 0x70ac1e11, 0x539d342e, 0x5e963a27, 0x498b283c, 0x44802635, 0x0fe97c42, 0x02e2724b, 0x15ff6050, 0x18f46e59, 0x3bc54466, 0x36ce4a6f, 0x21d35874, 0x2cd8567d, 0x0c7a37a1, 0x017139a8, 0x166c2bb3, 0x1b6725ba, 0x38560f85, 0x355d018c, 0x22401397, 0x2f4b1d9e, 0x642247e9, 0x692949e0, 0x7e345bfb, 0x733f55f2, 0x500e7fcd, 0x5d0571c4, 0x4a1863df, 0x47136dd6, 0xdccad731, 0xd1c1d938, 0xc6dccb23, 0xcbd7c52a, 0xe8e6ef15, 0xe5ede11c, 0xf2f0f307, 0xfffbfd0e, 0xb492a779, 0xb999a970, 0xae84bb6b, 0xa38fb562, 0x80be9f5d, 0x8db59154, 0x9aa8834f, 0x97a38d46];\r\n  var U4 = [0x00000000, 0x090d0b0e, 0x121a161c, 0x1b171d12, 0x24342c38, 0x2d392736, 0x362e3a24, 0x3f23312a, 0x48685870, 0x4165537e, 0x5a724e6c, 0x537f4562, 0x6c5c7448, 0x65517f46, 0x7e466254, 0x774b695a, 0x90d0b0e0, 0x99ddbbee, 0x82caa6fc, 0x8bc7adf2, 0xb4e49cd8, 0xbde997d6, 0xa6fe8ac4, 0xaff381ca, 0xd8b8e890, 0xd1b5e39e, 0xcaa2fe8c, 0xc3aff582, 0xfc8cc4a8, 0xf581cfa6, 0xee96d2b4, 0xe79bd9ba, 0x3bbb7bdb, 0x32b670d5, 0x29a16dc7, 0x20ac66c9, 0x1f8f57e3, 0x16825ced, 0x0d9541ff, 0x04984af1, 0x73d323ab, 0x7ade28a5, 0x61c935b7, 0x68c43eb9, 0x57e70f93, 0x5eea049d, 0x45fd198f, 0x4cf01281, 0xab6bcb3b, 0xa266c035, 0xb971dd27, 0xb07cd629, 0x8f5fe703, 0x8652ec0d, 0x9d45f11f, 0x9448fa11, 0xe303934b, 0xea0e9845, 0xf1198557, 0xf8148e59, 0xc737bf73, 0xce3ab47d, 0xd52da96f, 0xdc20a261, 0x766df6ad, 0x7f60fda3, 0x6477e0b1, 0x6d7aebbf, 0x5259da95, 0x5b54d19b, 0x4043cc89, 0x494ec787, 0x3e05aedd, 0x3708a5d3, 0x2c1fb8c1, 0x2512b3cf, 0x1a3182e5, 0x133c89eb, 0x082b94f9, 0x01269ff7, 0xe6bd464d, 0xefb04d43, 0xf4a75051, 0xfdaa5b5f, 0xc2896a75, 0xcb84617b, 0xd0937c69, 0xd99e7767, 0xaed51e3d, 0xa7d81533, 0xbccf0821, 0xb5c2032f, 0x8ae13205, 0x83ec390b, 0x98fb2419, 0x91f62f17, 0x4dd68d76, 0x44db8678, 0x5fcc9b6a, 0x56c19064, 0x69e2a14e, 0x60efaa40, 0x7bf8b752, 0x72f5bc5c, 0x05bed506, 0x0cb3de08, 0x17a4c31a, 0x1ea9c814, 0x218af93e, 0x2887f230, 0x3390ef22, 0x3a9de42c, 0xdd063d96, 0xd40b3698, 0xcf1c2b8a, 0xc6112084, 0xf93211ae, 0xf03f1aa0, 0xeb2807b2, 0xe2250cbc, 0x956e65e6, 0x9c636ee8, 0x877473fa, 0x8e7978f4, 0xb15a49de, 0xb85742d0, 0xa3405fc2, 0xaa4d54cc, 0xecdaf741, 0xe5d7fc4f, 0xfec0e15d, 0xf7cdea53, 0xc8eedb79, 0xc1e3d077, 0xdaf4cd65, 0xd3f9c66b, 0xa4b2af31, 0xadbfa43f, 0xb6a8b92d, 0xbfa5b223, 0x80868309, 0x898b8807, 0x929c9515, 0x9b919e1b, 0x7c0a47a1, 0x75074caf, 0x6e1051bd, 0x671d5ab3, 0x583e6b99, 0x51336097, 0x4a247d85, 0x4329768b, 0x34621fd1, 0x3d6f14df, 0x267809cd, 0x2f7502c3, 0x105633e9, 0x195b38e7, 0x024c25f5, 0x0b412efb, 0xd7618c9a, 0xde6c8794, 0xc57b9a86, 0xcc769188, 0xf355a0a2, 0xfa58abac, 0xe14fb6be, 0xe842bdb0, 0x9f09d4ea, 0x9604dfe4, 0x8d13c2f6, 0x841ec9f8, 0xbb3df8d2, 0xb230f3dc, 0xa927eece, 0xa02ae5c0, 0x47b13c7a, 0x4ebc3774, 0x55ab2a66, 0x5ca62168, 0x63851042, 0x6a881b4c, 0x719f065e, 0x78920d50, 0x0fd9640a, 0x06d46f04, 0x1dc37216, 0x14ce7918, 0x2bed4832, 0x22e0433c, 0x39f75e2e, 0x30fa5520, 0x9ab701ec, 0x93ba0ae2, 0x88ad17f0, 0x81a01cfe, 0xbe832dd4, 0xb78e26da, 0xac993bc8, 0xa59430c6, 0xd2df599c, 0xdbd25292, 0xc0c54f80, 0xc9c8448e, 0xf6eb75a4, 0xffe67eaa, 0xe4f163b8, 0xedfc68b6, 0x0a67b10c, 0x036aba02, 0x187da710, 0x1170ac1e, 0x2e539d34, 0x275e963a, 0x3c498b28, 0x35448026, 0x420fe97c, 0x4b02e272, 0x5015ff60, 0x5918f46e, 0x663bc544, 0x6f36ce4a, 0x7421d358, 0x7d2cd856, 0xa10c7a37, 0xa8017139, 0xb3166c2b, 0xba1b6725, 0x8538560f, 0x8c355d01, 0x97224013, 0x9e2f4b1d, 0xe9642247, 0xe0692949, 0xfb7e345b, 0xf2733f55, 0xcd500e7f, 0xc45d0571, 0xdf4a1863, 0xd647136d, 0x31dccad7, 0x38d1c1d9, 0x23c6dccb, 0x2acbd7c5, 0x15e8e6ef, 0x1ce5ede1, 0x07f2f0f3, 0x0efffbfd, 0x79b492a7, 0x70b999a9, 0x6bae84bb, 0x62a38fb5, 0x5d80be9f, 0x548db591, 0x4f9aa883, 0x4697a38d];\r\n\r\n  function convertToInt32(bytes) {\r\n    var result = [];\r\n    for (var i = 0; i < bytes.length; i += 4) {\r\n      result.push(\r\n        (bytes[i    ] << 24) |\r\n        (bytes[i + 1] << 16) |\r\n        (bytes[i + 2] <<  8) |\r\n        bytes[i + 3]\r\n      );\r\n    }\r\n    return result;\r\n  }\r\n\r\n  var AES = function(key) {\r\n    if (!(this instanceof AES)) {\r\n      throw Error('AES must be instanitated with `new`');\r\n    }\r\n\r\n    Object.defineProperty(this, 'key', {\r\n      value: coerceArray(key, true)\r\n    });\r\n\r\n    this._prepare();\r\n  }\r\n\r\n\r\n  AES.prototype._prepare = function() {\r\n\r\n    var rounds = numberOfRounds[this.key.length];\r\n    if (rounds == null) {\r\n      throw new Error('invalid key size (must be 16, 24 or 32 bytes)');\r\n    }\r\n\r\n    // encryption round keys\r\n    this._Ke = [];\r\n\r\n    // decryption round keys\r\n    this._Kd = [];\r\n\r\n    for (var i = 0; i <= rounds; i++) {\r\n      this._Ke.push([0, 0, 0, 0]);\r\n      this._Kd.push([0, 0, 0, 0]);\r\n    }\r\n\r\n    var roundKeyCount = (rounds + 1) * 4;\r\n    var KC = this.key.length / 4;\r\n\r\n    // convert the key into ints\r\n    var tk = convertToInt32(this.key);\r\n\r\n    // copy values into round key arrays\r\n    var index;\r\n    for (var i = 0; i < KC; i++) {\r\n      index = i >> 2;\r\n      this._Ke[index][i % 4] = tk[i];\r\n      this._Kd[rounds - index][i % 4] = tk[i];\r\n    }\r\n\r\n    // key expansion (fips-197 section 5.2)\r\n    var rconpointer = 0;\r\n    var t = KC, tt;\r\n    while (t < roundKeyCount) {\r\n      tt = tk[KC - 1];\r\n      tk[0] ^= ((S[(tt >> 16) & 0xFF] << 24) ^\r\n        (S[(tt >>  8) & 0xFF] << 16) ^\r\n        (S[ tt        & 0xFF] <<  8) ^\r\n        S[(tt >> 24) & 0xFF]        ^\r\n        (rcon[rconpointer] << 24));\r\n      rconpointer += 1;\r\n\r\n      // key expansion (for non-256 bit)\r\n      if (KC != 8) {\r\n        for (var i = 1; i < KC; i++) {\r\n          tk[i] ^= tk[i - 1];\r\n        }\r\n\r\n        // key expansion for 256-bit keys is \"slightly different\" (fips-197)\r\n      } else {\r\n        for (var i = 1; i < (KC / 2); i++) {\r\n          tk[i] ^= tk[i - 1];\r\n        }\r\n        tt = tk[(KC / 2) - 1];\r\n\r\n        tk[KC / 2] ^= (S[ tt        & 0xFF]        ^\r\n          (S[(tt >>  8) & 0xFF] <<  8) ^\r\n          (S[(tt >> 16) & 0xFF] << 16) ^\r\n          (S[(tt >> 24) & 0xFF] << 24));\r\n\r\n        for (var i = (KC / 2) + 1; i < KC; i++) {\r\n          tk[i] ^= tk[i - 1];\r\n        }\r\n      }\r\n\r\n      // copy values into round key arrays\r\n      var i = 0, r, c;\r\n      while (i < KC && t < roundKeyCount) {\r\n        r = t >> 2;\r\n        c = t % 4;\r\n        this._Ke[r][c] = tk[i];\r\n        this._Kd[rounds - r][c] = tk[i++];\r\n        t++;\r\n      }\r\n    }\r\n\r\n    // inverse-cipher-ify the decryption round key (fips-197 section 5.3)\r\n    for (var r = 1; r < rounds; r++) {\r\n      for (var c = 0; c < 4; c++) {\r\n        tt = this._Kd[r][c];\r\n        this._Kd[r][c] = (U1[(tt >> 24) & 0xFF] ^\r\n          U2[(tt >> 16) & 0xFF] ^\r\n          U3[(tt >>  8) & 0xFF] ^\r\n          U4[ tt        & 0xFF]);\r\n      }\r\n    }\r\n  }\r\n\r\n  AES.prototype.encrypt = function(plaintext) {\r\n    if (plaintext.length != 16) {\r\n      throw new Error('invalid plaintext size (must be 16 bytes)');\r\n    }\r\n\r\n    var rounds = this._Ke.length - 1;\r\n    var a = [0, 0, 0, 0];\r\n\r\n    // convert plaintext to (ints ^ key)\r\n    var t = convertToInt32(plaintext);\r\n    for (var i = 0; i < 4; i++) {\r\n      t[i] ^= this._Ke[0][i];\r\n    }\r\n\r\n    // apply round transforms\r\n    for (var r = 1; r < rounds; r++) {\r\n      for (var i = 0; i < 4; i++) {\r\n        a[i] = (T1[(t[ i         ] >> 24) & 0xff] ^\r\n          T2[(t[(i + 1) % 4] >> 16) & 0xff] ^\r\n          T3[(t[(i + 2) % 4] >>  8) & 0xff] ^\r\n          T4[ t[(i + 3) % 4]        & 0xff] ^\r\n          this._Ke[r][i]);\r\n      }\r\n      t = a.slice();\r\n    }\r\n\r\n    // the last round is special\r\n    var result = createArray(16), tt;\r\n    for (var i = 0; i < 4; i++) {\r\n      tt = this._Ke[rounds][i];\r\n      result[4 * i    ] = (S[(t[ i         ] >> 24) & 0xff] ^ (tt >> 24)) & 0xff;\r\n      result[4 * i + 1] = (S[(t[(i + 1) % 4] >> 16) & 0xff] ^ (tt >> 16)) & 0xff;\r\n      result[4 * i + 2] = (S[(t[(i + 2) % 4] >>  8) & 0xff] ^ (tt >>  8)) & 0xff;\r\n      result[4 * i + 3] = (S[ t[(i + 3) % 4]        & 0xff] ^  tt       ) & 0xff;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  AES.prototype.decrypt = function(ciphertext) {\r\n    if (ciphertext.length != 16) {\r\n      throw new Error('invalid ciphertext size (must be 16 bytes)');\r\n    }\r\n\r\n    var rounds = this._Kd.length - 1;\r\n    var a = [0, 0, 0, 0];\r\n\r\n    // convert plaintext to (ints ^ key)\r\n    var t = convertToInt32(ciphertext);\r\n    for (var i = 0; i < 4; i++) {\r\n      t[i] ^= this._Kd[0][i];\r\n    }\r\n\r\n    // apply round transforms\r\n    for (var r = 1; r < rounds; r++) {\r\n      for (var i = 0; i < 4; i++) {\r\n        a[i] = (T5[(t[ i          ] >> 24) & 0xff] ^\r\n          T6[(t[(i + 3) % 4] >> 16) & 0xff] ^\r\n          T7[(t[(i + 2) % 4] >>  8) & 0xff] ^\r\n          T8[ t[(i + 1) % 4]        & 0xff] ^\r\n          this._Kd[r][i]);\r\n      }\r\n      t = a.slice();\r\n    }\r\n\r\n    // the last round is special\r\n    var result = createArray(16), tt;\r\n    for (var i = 0; i < 4; i++) {\r\n      tt = this._Kd[rounds][i];\r\n      result[4 * i    ] = (Si[(t[ i         ] >> 24) & 0xff] ^ (tt >> 24)) & 0xff;\r\n      result[4 * i + 1] = (Si[(t[(i + 3) % 4] >> 16) & 0xff] ^ (tt >> 16)) & 0xff;\r\n      result[4 * i + 2] = (Si[(t[(i + 2) % 4] >>  8) & 0xff] ^ (tt >>  8)) & 0xff;\r\n      result[4 * i + 3] = (Si[ t[(i + 1) % 4]        & 0xff] ^  tt       ) & 0xff;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n\r\n  /**\r\n   *  Mode Of Operation - Electonic Codebook (ECB)\r\n   */\r\n  var ModeOfOperationECB = function(key) {\r\n    if (!(this instanceof ModeOfOperationECB)) {\r\n      throw Error('AES must be instanitated with `new`');\r\n    }\r\n\r\n    this.description = \"Electronic Code Block\";\r\n    this.name = \"ecb\";\r\n\r\n    this._aes = new AES(key);\r\n  }\r\n\r\n  ModeOfOperationECB.prototype.encrypt = function(plaintext) {\r\n    plaintext = coerceArray(plaintext);\r\n\r\n    if ((plaintext.length % 16) !== 0) {\r\n      throw new Error('invalid plaintext size (must be multiple of 16 bytes)');\r\n    }\r\n\r\n    var ciphertext = createArray(plaintext.length);\r\n    var block = createArray(16);\r\n\r\n    for (var i = 0; i < plaintext.length; i += 16) {\r\n      copyArray(plaintext, block, 0, i, i + 16);\r\n      block = this._aes.encrypt(block);\r\n      copyArray(block, ciphertext, i);\r\n    }\r\n\r\n    return ciphertext;\r\n  }\r\n\r\n  ModeOfOperationECB.prototype.decrypt = function(ciphertext) {\r\n    ciphertext = coerceArray(ciphertext);\r\n\r\n    if ((ciphertext.length % 16) !== 0) {\r\n      throw new Error('invalid ciphertext size (must be multiple of 16 bytes)');\r\n    }\r\n\r\n    var plaintext = createArray(ciphertext.length);\r\n    var block = createArray(16);\r\n\r\n    for (var i = 0; i < ciphertext.length; i += 16) {\r\n      copyArray(ciphertext, block, 0, i, i + 16);\r\n      block = this._aes.decrypt(block);\r\n      copyArray(block, plaintext, i);\r\n    }\r\n\r\n    return plaintext;\r\n  }\r\n\r\n\r\n  /**\r\n   *  Mode Of Operation - Cipher Block Chaining (CBC)\r\n   */\r\n  var ModeOfOperationCBC = function(key, iv) {\r\n    if (!(this instanceof ModeOfOperationCBC)) {\r\n      throw Error('AES must be instanitated with `new`');\r\n    }\r\n\r\n    this.description = \"Cipher Block Chaining\";\r\n    this.name = \"cbc\";\r\n\r\n    if (!iv) {\r\n      iv = createArray(16);\r\n\r\n    } else if (iv.length != 16) {\r\n      throw new Error('invalid initialation vector size (must be 16 bytes)');\r\n    }\r\n\r\n    this._lastCipherblock = coerceArray(iv, true);\r\n\r\n    this._aes = new AES(key);\r\n  }\r\n\r\n  ModeOfOperationCBC.prototype.encrypt = function(plaintext) {\r\n    plaintext = coerceArray(plaintext);\r\n\r\n    if ((plaintext.length % 16) !== 0) {\r\n      throw new Error('invalid plaintext size (must be multiple of 16 bytes)');\r\n    }\r\n\r\n    var ciphertext = createArray(plaintext.length);\r\n    var block = createArray(16);\r\n\r\n    for (var i = 0; i < plaintext.length; i += 16) {\r\n      copyArray(plaintext, block, 0, i, i + 16);\r\n\r\n      for (var j = 0; j < 16; j++) {\r\n        block[j] ^= this._lastCipherblock[j];\r\n      }\r\n\r\n      this._lastCipherblock = this._aes.encrypt(block);\r\n      copyArray(this._lastCipherblock, ciphertext, i);\r\n    }\r\n\r\n    return ciphertext;\r\n  }\r\n\r\n  ModeOfOperationCBC.prototype.decrypt = function(ciphertext) {\r\n    ciphertext = coerceArray(ciphertext);\r\n\r\n    if ((ciphertext.length % 16) !== 0) {\r\n      throw new Error('invalid ciphertext size (must be multiple of 16 bytes)');\r\n    }\r\n\r\n    var plaintext = createArray(ciphertext.length);\r\n    var block = createArray(16);\r\n\r\n    for (var i = 0; i < ciphertext.length; i += 16) {\r\n      copyArray(ciphertext, block, 0, i, i + 16);\r\n      block = this._aes.decrypt(block);\r\n\r\n      for (var j = 0; j < 16; j++) {\r\n        plaintext[i + j] = block[j] ^ this._lastCipherblock[j];\r\n      }\r\n\r\n      copyArray(ciphertext, this._lastCipherblock, 0, i, i + 16);\r\n    }\r\n\r\n    return plaintext;\r\n  }\r\n\r\n\r\n  /**\r\n   *  Mode Of Operation - Cipher Feedback (CFB)\r\n   */\r\n  var ModeOfOperationCFB = function(key, iv, segmentSize) {\r\n    if (!(this instanceof ModeOfOperationCFB)) {\r\n      throw Error('AES must be instanitated with `new`');\r\n    }\r\n\r\n    this.description = \"Cipher Feedback\";\r\n    this.name = \"cfb\";\r\n\r\n    if (!iv) {\r\n      iv = createArray(16);\r\n\r\n    } else if (iv.length != 16) {\r\n      throw new Error('invalid initialation vector size (must be 16 size)');\r\n    }\r\n\r\n    if (!segmentSize) { segmentSize = 1; }\r\n\r\n    this.segmentSize = segmentSize;\r\n\r\n    this._shiftRegister = coerceArray(iv, true);\r\n\r\n    this._aes = new AES(key);\r\n  }\r\n\r\n  ModeOfOperationCFB.prototype.encrypt = function(plaintext) {\r\n    if ((plaintext.length % this.segmentSize) != 0) {\r\n      throw new Error('invalid plaintext size (must be segmentSize bytes)');\r\n    }\r\n\r\n    var encrypted = coerceArray(plaintext, true);\r\n\r\n    var xorSegment;\r\n    for (var i = 0; i < encrypted.length; i += this.segmentSize) {\r\n      xorSegment = this._aes.encrypt(this._shiftRegister);\r\n      for (var j = 0; j < this.segmentSize; j++) {\r\n        encrypted[i + j] ^= xorSegment[j];\r\n      }\r\n\r\n      // Shift the register\r\n      copyArray(this._shiftRegister, this._shiftRegister, 0, this.segmentSize);\r\n      copyArray(encrypted, this._shiftRegister, 16 - this.segmentSize, i, i + this.segmentSize);\r\n    }\r\n\r\n    return encrypted;\r\n  }\r\n\r\n  ModeOfOperationCFB.prototype.decrypt = function(ciphertext) {\r\n    if ((ciphertext.length % this.segmentSize) != 0) {\r\n      throw new Error('invalid ciphertext size (must be segmentSize bytes)');\r\n    }\r\n\r\n    var plaintext = coerceArray(ciphertext, true);\r\n\r\n    var xorSegment;\r\n    for (var i = 0; i < plaintext.length; i += this.segmentSize) {\r\n      xorSegment = this._aes.encrypt(this._shiftRegister);\r\n\r\n      for (var j = 0; j < this.segmentSize; j++) {\r\n        plaintext[i + j] ^= xorSegment[j];\r\n      }\r\n\r\n      // Shift the register\r\n      copyArray(this._shiftRegister, this._shiftRegister, 0, this.segmentSize);\r\n      copyArray(ciphertext, this._shiftRegister, 16 - this.segmentSize, i, i + this.segmentSize);\r\n    }\r\n\r\n    return plaintext;\r\n  }\r\n\r\n  /**\r\n   *  Mode Of Operation - Output Feedback (OFB)\r\n   */\r\n  var ModeOfOperationOFB = function(key, iv) {\r\n    if (!(this instanceof ModeOfOperationOFB)) {\r\n      throw Error('AES must be instanitated with `new`');\r\n    }\r\n\r\n    this.description = \"Output Feedback\";\r\n    this.name = \"ofb\";\r\n\r\n    if (!iv) {\r\n      iv = createArray(16);\r\n\r\n    } else if (iv.length != 16) {\r\n      throw new Error('invalid initialation vector size (must be 16 bytes)');\r\n    }\r\n\r\n    this._lastPrecipher = coerceArray(iv, true);\r\n    this._lastPrecipherIndex = 16;\r\n\r\n    this._aes = new AES(key);\r\n  }\r\n\r\n  ModeOfOperationOFB.prototype.encrypt = function(plaintext) {\r\n    var encrypted = coerceArray(plaintext, true);\r\n\r\n    for (var i = 0; i < encrypted.length; i++) {\r\n      if (this._lastPrecipherIndex === 16) {\r\n        this._lastPrecipher = this._aes.encrypt(this._lastPrecipher);\r\n        this._lastPrecipherIndex = 0;\r\n      }\r\n      encrypted[i] ^= this._lastPrecipher[this._lastPrecipherIndex++];\r\n    }\r\n\r\n    return encrypted;\r\n  }\r\n\r\n  // Decryption is symetric\r\n  ModeOfOperationOFB.prototype.decrypt = ModeOfOperationOFB.prototype.encrypt;\r\n\r\n\r\n  /**\r\n   *  Counter object for CTR common mode of operation\r\n   */\r\n  var Counter = function(initialValue) {\r\n    if (!(this instanceof Counter)) {\r\n      throw Error('Counter must be instanitated with `new`');\r\n    }\r\n\r\n    // We allow 0, but anything false-ish uses the default 1\r\n    if (initialValue !== 0 && !initialValue) { initialValue = 1; }\r\n\r\n    if (typeof(initialValue) === 'number') {\r\n      this._counter = createArray(16);\r\n      this.setValue(initialValue);\r\n\r\n    } else {\r\n      this.setBytes(initialValue);\r\n    }\r\n  }\r\n\r\n  Counter.prototype.setValue = function(value) {\r\n    if (typeof(value) !== 'number' || parseInt(value) != value) {\r\n      throw new Error('invalid counter value (must be an integer)');\r\n    }\r\n\r\n    // We cannot safely handle numbers beyond the safe range for integers\r\n    if (value > Number.MAX_SAFE_INTEGER) {\r\n      throw new Error('integer value out of safe range');\r\n    }\r\n\r\n    for (var index = 15; index >= 0; --index) {\r\n      this._counter[index] = value % 256;\r\n      value = parseInt(value / 256);\r\n    }\r\n  }\r\n\r\n  Counter.prototype.setBytes = function(bytes) {\r\n    bytes = coerceArray(bytes, true);\r\n\r\n    if (bytes.length != 16) {\r\n      throw new Error('invalid counter bytes size (must be 16 bytes)');\r\n    }\r\n\r\n    this._counter = bytes;\r\n  };\r\n\r\n  Counter.prototype.increment = function() {\r\n    for (var i = 15; i >= 0; i--) {\r\n      if (this._counter[i] === 255) {\r\n        this._counter[i] = 0;\r\n      } else {\r\n        this._counter[i]++;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   *  Mode Of Operation - Counter (CTR)\r\n   */\r\n  var ModeOfOperationCTR = function(key, counter) {\r\n    if (!(this instanceof ModeOfOperationCTR)) {\r\n      throw Error('AES must be instanitated with `new`');\r\n    }\r\n\r\n    this.description = \"Counter\";\r\n    this.name = \"ctr\";\r\n\r\n    if (!(counter instanceof Counter)) {\r\n      counter = new Counter(counter)\r\n    }\r\n\r\n    this._counter = counter;\r\n\r\n    this._remainingCounter = null;\r\n    this._remainingCounterIndex = 16;\r\n\r\n    this._aes = new AES(key);\r\n  }\r\n\r\n  ModeOfOperationCTR.prototype.encrypt = function(plaintext) {\r\n    var encrypted = coerceArray(plaintext, true);\r\n\r\n    for (var i = 0; i < encrypted.length; i++) {\r\n      if (this._remainingCounterIndex === 16) {\r\n        this._remainingCounter = this._aes.encrypt(this._counter._counter);\r\n        this._remainingCounterIndex = 0;\r\n        this._counter.increment();\r\n      }\r\n      encrypted[i] ^= this._remainingCounter[this._remainingCounterIndex++];\r\n    }\r\n\r\n    return encrypted;\r\n  }\r\n\r\n  // Decryption is symetric\r\n  ModeOfOperationCTR.prototype.decrypt = ModeOfOperationCTR.prototype.encrypt;\r\n\r\n\r\n  ///////////////////////\r\n  // Padding\r\n\r\n  // See:https://tools.ietf.org/html/rfc2315\r\n  function pkcs7pad(data) {\r\n    data = coerceArray(data, true);\r\n    var padder = 16 - (data.length % 16);\r\n    var result = createArray(data.length + padder);\r\n    copyArray(data, result);\r\n    for (var i = data.length; i < result.length; i++) {\r\n      result[i] = padder;\r\n    }\r\n    return result;\r\n  }\r\n\r\n  function pkcs7strip(data) {\r\n    data = coerceArray(data, true);\r\n    if (data.length < 16) { throw new Error('PKCS#7 invalid length'); }\r\n\r\n    var padder = data[data.length - 1];\r\n    if (padder > 16) { throw new Error('PKCS#7 padding byte out of range'); }\r\n\r\n    var length = data.length - padder;\r\n    for (var i = 0; i < padder; i++) {\r\n      if (data[length + i] !== padder) {\r\n        throw new Error('PKCS#7 invalid padding byte');\r\n      }\r\n    }\r\n\r\n    var result = createArray(length);\r\n    copyArray(data, result, 0, 0, length);\r\n    return result;\r\n  }\r\n\r\n  ///////////////////////\r\n  // Exporting\r\n\r\n\r\n  // The block cipher\r\n  var aesjs = {\r\n    AES: AES,\r\n    Counter: Counter,\r\n\r\n    ModeOfOperation: {\r\n      ecb: ModeOfOperationECB,\r\n      cbc: ModeOfOperationCBC,\r\n      cfb: ModeOfOperationCFB,\r\n      ofb: ModeOfOperationOFB,\r\n      ctr: ModeOfOperationCTR\r\n    },\r\n\r\n    utils: {\r\n      hex: convertHex,\r\n      utf8: convertUtf8\r\n    },\r\n\r\n    padding: {\r\n      pkcs7: {\r\n        pad: pkcs7pad,\r\n        strip: pkcs7strip\r\n      }\r\n    },\r\n\r\n    _arrayTest: {\r\n      coerceArray: coerceArray,\r\n      createArray: createArray,\r\n      copyArray: copyArray,\r\n    }\r\n  };\r\n\r\n\r\n  // node.js\r\n  if (typeof exports !== 'undefined') {\r\n    module.exports = aesjs\r\n\r\n    // RequireJS/AMD\r\n    // http://www.requirejs.org/docs/api.html\r\n    // https://github.com/amdjs/amdjs-api/wiki/AMD\r\n  } else if (typeof(define) === 'function' && define.amd) {\r\n    define([], function() { return aesjs; });\r\n\r\n    // Web Browsers\r\n  } else {\r\n\r\n    // If there was an existing library at \"aesjs\" make sure it's still available\r\n    if (root.aesjs) {\r\n      aesjs._aesjs = root.aesjs;\r\n    }\r\n\r\n    root.aesjs = aesjs;\r\n  }\r\n\r\n\r\n})(this);\r\n","export abstract class Op {\r\n  static transfer = 0xf8a7ea5;\r\n\r\n  static transfer_notification = 0x7362d09c;\r\n\r\n  static internal_transfer = 0x178d4519;\r\n\r\n  static excesses = 0xd53276db;\r\n\r\n  static burn = 0x595f07bc;\r\n\r\n  static burn_notification = 0x7bdd97de;\r\n\r\n  static provide_wallet_address = 0x2c76b973;\r\n\r\n  static take_wallet_address = 0xd1735400;\r\n\r\n  static mint = 21;\r\n\r\n  static change_admin = 3;\r\n\r\n  static change_content = 4;\r\n}\r\n\r\nexport abstract class Errors {\r\n  static invalid_op = 709;\r\n\r\n  static not_admin = 73;\r\n\r\n  static unouthorized_burn = 74;\r\n\r\n  static discovery_fee_not_matched = 75;\r\n\r\n  static wrong_op = 0xffff;\r\n\r\n  static not_owner = 705;\r\n\r\n  static not_enough_ton = 709;\r\n\r\n  static not_enough_gas = 707;\r\n\r\n  static not_valid_wallet = 707;\r\n\r\n  static wrong_workchain = 333;\r\n\r\n  static balance_error = 706;\r\n}\r\n","import type {\r\n  Address, Cell, Contract, ContractProvider, Sender,\r\n} from '@ton/core';\r\nimport {\r\n  beginCell, contractAddress, SendMode, toNano,\r\n} from '@ton/core';\r\n\r\nimport { Op } from './JettonConstants';\r\n\r\nexport type JettonMinterContent = {\r\n  type: 0 | 1;\r\n  uri: string;\r\n};\r\n\r\nexport type JettonMinterConfig = { admin: Address; content: Cell; wallet_code: Cell };\r\n\r\nexport function jettonMinterConfigToCell(config: JettonMinterConfig): Cell {\r\n  return beginCell()\r\n    .storeCoins(0)\r\n    .storeAddress(config.admin)\r\n    .storeRef(config.content)\r\n    .storeRef(config.wallet_code)\r\n    .endCell();\r\n}\r\n\r\nexport function jettonContentToCell(content: JettonMinterContent) {\r\n  return beginCell()\r\n    .storeUint(content.type, 8)\r\n    .storeStringTail(content.uri) // Snake logic under the hood\r\n    .endCell();\r\n}\r\n\r\nexport class JettonMinter implements Contract {\r\n  constructor(readonly address: Address, readonly init?: { code: Cell; data: Cell }) {}\r\n\r\n  static createFromAddress(address: Address) {\r\n    return new JettonMinter(address);\r\n  }\r\n\r\n  static createFromConfig(config: JettonMinterConfig, code: Cell, workchain = 0) {\r\n    const data = jettonMinterConfigToCell(config);\r\n    const init = { code, data };\r\n    return new JettonMinter(contractAddress(workchain, init), init);\r\n  }\r\n\r\n  async sendDeploy(provider: ContractProvider, via: Sender, value: bigint) {\r\n    await provider.internal(via, {\r\n      value,\r\n      sendMode: SendMode.PAY_GAS_SEPARATELY,\r\n      body: beginCell().endCell(),\r\n    });\r\n  }\r\n\r\n  protected static jettonInternalTransfer(jetton_amount: bigint,\r\n    forward_ton_amount: bigint,\r\n    response_addr?: Address,\r\n    query_id: number | bigint = 0) {\r\n    return beginCell()\r\n      .storeUint(Op.internal_transfer, 32)\r\n      .storeUint(query_id, 64)\r\n      .storeCoins(jetton_amount)\r\n      .storeAddress(undefined)\r\n      .storeAddress(response_addr)\r\n      .storeCoins(forward_ton_amount)\r\n      .storeBit(false)\r\n      .endCell();\r\n  }\r\n\r\n  static mintMessage(\r\n    from: Address,\r\n    to: Address,\r\n    jetton_amount: bigint,\r\n    forward_ton_amount: bigint,\r\n    total_ton_amount: bigint,\r\n    query_id: number | bigint = 0,\r\n  ) {\r\n    const mintMsg = beginCell().storeUint(Op.internal_transfer, 32)\r\n      .storeUint(0, 64)\r\n      .storeCoins(jetton_amount)\r\n      .storeAddress(undefined)\r\n      .storeAddress(from) // Response addr\r\n      .storeCoins(forward_ton_amount)\r\n      .storeMaybeRef(undefined)\r\n      .endCell();\r\n\r\n    return beginCell().storeUint(Op.mint, 32).storeUint(query_id, 64) // op, queryId\r\n      .storeAddress(to)\r\n      .storeCoins(total_ton_amount)\r\n      .storeCoins(jetton_amount)\r\n      .storeRef(mintMsg)\r\n      .endCell();\r\n  }\r\n\r\n  async sendMint(\r\n    provider: ContractProvider,\r\n    via: Sender,\r\n    to: Address,\r\n    jetton_amount: bigint,\r\n    forward_ton_amount: bigint,\r\n    total_ton_amount: bigint,\r\n  ) {\r\n    if (total_ton_amount <= forward_ton_amount) {\r\n      throw new Error('Total ton amount should be > forward amount');\r\n    }\r\n    await provider.internal(via, {\r\n      sendMode: SendMode.PAY_GAS_SEPARATELY,\r\n      body: JettonMinter.mintMessage(this.address, to, jetton_amount, forward_ton_amount, total_ton_amount),\r\n      value: total_ton_amount + toNano('0.015'),\r\n    });\r\n  }\r\n\r\n  /* provide_wallet_address#2c76b973 query_id:uint64 owner_address:MsgAddress include_address:Bool = InternalMsgBody;\r\n  */\r\n  static discoveryMessage(owner: Address, include_address: boolean) {\r\n    return beginCell().storeUint(0x2c76b973, 32).storeUint(0, 64) // op, queryId\r\n      .storeAddress(owner)\r\n      .storeBit(include_address)\r\n      .endCell();\r\n  }\r\n\r\n  async sendDiscovery(\r\n    provider: ContractProvider,\r\n    via: Sender,\r\n    owner: Address,\r\n    include_address: boolean,\r\n    value: bigint = toNano('0.1'),\r\n  ) {\r\n    await provider.internal(via, {\r\n      sendMode: SendMode.PAY_GAS_SEPARATELY,\r\n      body: JettonMinter.discoveryMessage(owner, include_address),\r\n      value,\r\n    });\r\n  }\r\n\r\n  static changeAdminMessage(newOwner: Address) {\r\n    return beginCell().storeUint(Op.change_admin, 32).storeUint(0, 64) // op, queryId\r\n      .storeAddress(newOwner)\r\n      .endCell();\r\n  }\r\n\r\n  async sendChangeAdmin(provider: ContractProvider, via: Sender, newOwner: Address) {\r\n    await provider.internal(via, {\r\n      sendMode: SendMode.PAY_GAS_SEPARATELY,\r\n      body: JettonMinter.changeAdminMessage(newOwner),\r\n      value: toNano('0.05'),\r\n    });\r\n  }\r\n\r\n  static changeContentMessage(content: Cell) {\r\n    return beginCell().storeUint(Op.change_content, 32).storeUint(0, 64) // op, queryId\r\n      .storeRef(content)\r\n      .endCell();\r\n  }\r\n\r\n  async sendChangeContent(provider: ContractProvider, via: Sender, content: Cell) {\r\n    await provider.internal(via, {\r\n      sendMode: SendMode.PAY_GAS_SEPARATELY,\r\n      body: JettonMinter.changeContentMessage(content),\r\n      value: toNano('0.05'),\r\n    });\r\n  }\r\n\r\n  async getWalletAddress(provider: ContractProvider, owner: Address): Promise<Address> {\r\n    const res = await provider.get('get_wallet_address', [{\r\n      type: 'slice', cell: beginCell().storeAddress(owner).endCell(),\r\n    }]);\r\n    return res.stack.readAddress();\r\n  }\r\n\r\n  async getJettonData(provider: ContractProvider) {\r\n    const res = await provider.get('get_jetton_data', []);\r\n    const totalSupply = res.stack.readBigNumber();\r\n    const mintable = res.stack.readBoolean();\r\n    const adminAddress = res.stack.readCellOpt();\r\n    const content = res.stack.readCell();\r\n    const walletCode = res.stack.readCell();\r\n    return {\r\n      totalSupply,\r\n      mintable,\r\n      adminAddress,\r\n      content,\r\n      walletCode,\r\n    };\r\n  }\r\n\r\n  async getTotalSupply(provider: ContractProvider) {\r\n    const res = await this.getJettonData(provider);\r\n    return res.totalSupply;\r\n  }\r\n\r\n  async getAdminAddress(provider: ContractProvider) {\r\n    const res = await this.getJettonData(provider);\r\n    return res.adminAddress;\r\n  }\r\n\r\n  async getContent(provider: ContractProvider) {\r\n    const res = await this.getJettonData(provider);\r\n    return res.content;\r\n  }\r\n}\r\n","import axios from 'axios';\r\nimport buildFullPath from 'axios/unsafe/core/buildFullPath';\r\nimport settle from 'axios/unsafe/core/settle';\r\nimport buildURL from 'axios/unsafe/helpers/buildURL';\r\nimport utils from 'axios/unsafe/utils';\r\n\r\nconst { isFormData, isStandardBrowserEnv, isUndefined } = utils;\r\n\r\n/**\r\n * - Create a request object\r\n * - Get response body\r\n * - Check if timeout\r\n */\r\nexport default async function fetchAdapter(config) {\r\n  const request = createRequest(config);\r\n  const promiseChain = [getResponse(request, config)];\r\n\r\n  if (config.timeout && config.timeout > 0) {\r\n    promiseChain.push(\r\n      new Promise((res) => {\r\n        setTimeout(() => {\r\n          const message = config.timeoutErrorMessage\r\n            ? config.timeoutErrorMessage\r\n            : `timeout of ${config.timeout}ms exceeded`;\r\n          res(createError(message, config, 'ECONNABORTED', request));\r\n        }, config.timeout);\r\n      }),\r\n    );\r\n  }\r\n\r\n  const data = await Promise.race(promiseChain);\r\n  return new Promise((resolve, reject) => {\r\n    if (data instanceof Error) {\r\n      reject(data);\r\n    } else {\r\n      // eslint-disable-next-line @typescript-eslint/no-unused-expressions\r\n      Object.prototype.toString.call(config.settle) === '[object Function]'\r\n        ? config.settle(resolve, reject, data)\r\n        : settle(resolve, reject, data);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Fetch API stage two is to get response body. This funtion tries to retrieve\r\n * response body based on response's type\r\n */\r\nasync function getResponse(request, config) {\r\n  let stageOne;\r\n  try {\r\n    stageOne = await fetch(request);\r\n  } catch (e) {\r\n    return createError('Network Error', config, 'ERR_NETWORK', request);\r\n  }\r\n\r\n  const response = {\r\n    ok: stageOne.ok,\r\n    status: stageOne.status,\r\n    statusText: stageOne.statusText,\r\n    headers: new Headers(stageOne.headers), // Make a copy of headers\r\n    config,\r\n    request,\r\n  };\r\n\r\n  if (stageOne.status >= 200 && stageOne.status !== 204) {\r\n    switch (config.responseType) {\r\n      case 'arraybuffer':\r\n        response.data = await stageOne.arrayBuffer();\r\n        break;\r\n      case 'blob':\r\n        response.data = await stageOne.blob();\r\n        break;\r\n      case 'json':\r\n        response.data = await stageOne.json();\r\n        break;\r\n      case 'formData':\r\n        response.data = await stageOne.formData();\r\n        break;\r\n      default:\r\n        response.data = await stageOne.text();\r\n        break;\r\n    }\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\n/**\r\n * This function will create a Request object based on configuration's axios\r\n */\r\nfunction createRequest(config) {\r\n  const headers = new Headers(config.headers);\r\n\r\n  // HTTP basic authentication\r\n  if (config.auth) {\r\n    const username = config.auth.username || '';\r\n    const password = config.auth.password ? decodeURI(encodeURIComponent(config.auth.password)) : '';\r\n    headers.set('Authorization', `Basic ${btoa(`${username}:${password}`)}`);\r\n  }\r\n\r\n  const method = config.method.toUpperCase();\r\n  const options = {\r\n    headers,\r\n    method,\r\n  };\r\n  if (method !== 'GET' && method !== 'HEAD') {\r\n    options.body = config.data;\r\n\r\n    // In these cases the browser will automatically set the correct Content-Type,\r\n    // but only if that header hasn't been set yet. So that's why we're deleting it.\r\n    if (isFormData(options.body) && isStandardBrowserEnv()) {\r\n      headers.delete('Content-Type');\r\n    }\r\n  }\r\n  if (config.mode) {\r\n    options.mode = config.mode;\r\n  }\r\n  if (config.cache) {\r\n    options.cache = config.cache;\r\n  }\r\n  if (config.integrity) {\r\n    options.integrity = config.integrity;\r\n  }\r\n  if (config.redirect) {\r\n    options.redirect = config.redirect;\r\n  }\r\n  if (config.referrer) {\r\n    options.referrer = config.referrer;\r\n  }\r\n  // This config is similar to XHRs withCredentials flag, but with three available values instead of two.\r\n  // So if withCredentials is not set, default value 'same-origin' will be used\r\n  if (!isUndefined(config.withCredentials)) {\r\n    options.credentials = config.withCredentials ? 'include' : 'omit';\r\n  }\r\n\r\n  const fullPath = buildFullPath(config.baseURL, config.url);\r\n  const url = buildURL(fullPath, config.params, config.paramsSerializer);\r\n\r\n  // Expected browser to throw error if there is any wrong configuration value\r\n  return new Request(url, options);\r\n}\r\n\r\n/**\r\n * Note:\r\n *\r\n *   From version >= 0.27.0, createError function is replaced by AxiosError class.\r\n *   So I copy the old createError function here for backward compatible.\r\n *\r\n *\r\n *\r\n * Create an Error with the specified message, config, error code, request and response.\r\n *\r\n * @param {string} message The error message.\r\n * @param {Object} config The config.\r\n * @param {string} [code] The error code (for example, 'ECONNABORTED').\r\n * @param {Object} [request] The request.\r\n * @param {Object} [response] The response.\r\n * @returns {Error} The created error.\r\n */\r\nfunction createError(message, config, code, request, response) {\r\n  if (axios.AxiosError && typeof axios.AxiosError === 'function') {\r\n    return new axios.AxiosError(message, axios.AxiosError[code], config, request, response);\r\n  }\r\n\r\n  const error = new Error(message);\r\n  return enhanceError(error, config, code, request, response);\r\n}\r\n\r\n/**\r\n *\r\n * Note:\r\n *\r\n *   This function is for backward compatible.\r\n *\r\n *\r\n * Update an Error with the specified config, error code, and response.\r\n *\r\n * @param {Error} error The error to update.\r\n * @param {Object} config The config.\r\n * @param {string} [code] The error code (for example, 'ECONNABORTED').\r\n * @param {Object} [request] The request.\r\n * @param {Object} [response] The response.\r\n * @returns {Error} The error.\r\n */\r\nfunction enhanceError(error, config, code, request, response) {\r\n  error.config = config;\r\n  if (code) {\r\n    error.code = code;\r\n  }\r\n\r\n  error.request = request;\r\n  error.response = response;\r\n  error.isAxiosError = true;\r\n\r\n  error.toJSON = function toJSON() {\r\n    return {\r\n      // Standard\r\n      message: this.message,\r\n      name: this.name,\r\n      // Microsoft\r\n      description: this.description,\r\n      number: this.number,\r\n      // Mozilla\r\n      fileName: this.fileName,\r\n      lineNumber: this.lineNumber,\r\n      columnNumber: this.columnNumber,\r\n      stack: this.stack,\r\n      // Axios\r\n      config: this.config,\r\n      code: this.code,\r\n      // eslint-disable-next-line no-null/no-null\r\n      status: this.response && this.response.status ? this.response.status : null,\r\n    };\r\n  };\r\n  return error;\r\n}\r\n","import axios from 'axios';\r\nimport type { TonClientParameters } from '@ton/ton/dist/client/TonClient';\r\nimport { TonClient as TonCoreClient } from '@ton/ton/dist/client/TonClient';\r\n\r\nimport type { GetAddressInfoResponse } from '../types';\r\n\r\nimport { DEFAULT_ERROR_PAUSE, DEFAULT_RETRIES } from '../../../../config';\r\nimport axiosFetchAdapter from '../../../../lib/axios-fetch-adapter';\r\nimport axiosRetry from '../../../../lib/axios-retry';\r\nimport { fetchWithRetry } from '../../../../util/fetch';\r\nimport { logDebug } from '../../../../util/logs';\r\n\r\naxiosRetry(axios, {\r\n  retries: DEFAULT_RETRIES,\r\n  shouldResetTimeout: true,\r\n  retryDelay: (retryCount) => {\r\n    return retryCount * DEFAULT_ERROR_PAUSE;\r\n  },\r\n  onRetry: (retryNumber, error, requestConfig) => {\r\n    logDebug(`Retry request #${retryNumber}:`, requestConfig.url, error.response?.status);\r\n  },\r\n});\r\n\r\naxios.defaults.adapter = axiosFetchAdapter;\r\n\r\ntype Parameters = TonClientParameters & {\r\n  headers?: AnyLiteral;\r\n};\r\n\r\nexport class TonClient extends TonCoreClient {\r\n  private initParameters: Parameters;\r\n\r\n  constructor(parameters: Parameters) {\r\n    super(parameters);\r\n    this.initParameters = parameters;\r\n  }\r\n\r\n  getAddressInfo(address: string): Promise<GetAddressInfoResponse> {\r\n    return this.callRpc('getAddressInformation', { address });\r\n  }\r\n\r\n  callRpc(method: string, params: any): Promise<any> {\r\n    return this.sendRequest(this.parameters.endpoint, {\r\n      id: 1, jsonrpc: '2.0', method, params,\r\n    });\r\n  }\r\n\r\n  async sendFile(src: Buffer | string): Promise<void> {\r\n    const boc = typeof src === 'object' ? src.toString('base64') : src;\r\n    await this.callRpc('sendBocReturnHashNoError', { boc });\r\n  }\r\n\r\n  async sendRequest(apiUrl: string, request: any) {\r\n    const method: string = request.method;\r\n\r\n    const headers: AnyLiteral = {\r\n      ...this.initParameters.headers,\r\n      'Content-Type': 'application/json',\r\n    };\r\n    if (this.parameters.apiKey) {\r\n      headers['X-API-Key'] = this.parameters.apiKey;\r\n    }\r\n    const body = JSON.stringify(request);\r\n\r\n    const response = await fetchWithRetry(apiUrl, {\r\n      method: 'POST',\r\n      body,\r\n      headers,\r\n    }, {\r\n      shouldSkipRetryFn: (message, statusCode) => isNotTemporaryError(method, message, statusCode),\r\n    });\r\n\r\n    const data = await response.json();\r\n\r\n    return data.result;\r\n  }\r\n}\r\n\r\nfunction isNotTemporaryError(method: string, message?: string, statusCode?: number) {\r\n  return Boolean(statusCode === 422 || message?.match(/(exit code|exitcode=|duplicate message)/));\r\n}\r\n","import type { OpenedContract, StateInit } from '@ton/core';\r\nimport {\r\n  Address, beginCell, Builder, Cell, Dictionary, loadStateInit,\r\n} from '@ton/core';\r\nimport { WalletContractV1R1 } from '@ton/ton/dist/wallets/WalletContractV1R1';\r\nimport { WalletContractV1R2 } from '@ton/ton/dist/wallets/WalletContractV1R2';\r\nimport { WalletContractV1R3 } from '@ton/ton/dist/wallets/WalletContractV1R3';\r\nimport { WalletContractV2R1 } from '@ton/ton/dist/wallets/WalletContractV2R1';\r\nimport { WalletContractV2R2 } from '@ton/ton/dist/wallets/WalletContractV2R2';\r\nimport { WalletContractV3R1 } from '@ton/ton/dist/wallets/WalletContractV3R1';\r\nimport { WalletContractV3R2 } from '@ton/ton/dist/wallets/WalletContractV3R2';\r\nimport { WalletContractV4 } from '@ton/ton/dist/wallets/WalletContractV4';\r\nimport { WalletContractV5R1 } from '@ton/ton/dist/wallets/WalletContractV5R1';\r\n\r\nimport type { ApiNetwork } from '../../../types';\r\nimport type { ApiTonWalletVersion, TokenTransferBodyParams } from '../types';\r\n\r\nimport { DEFAULT_TIMEOUT } from '../../../../config';\r\nimport { getDnsZoneByCollection } from '../../../../util/dns';\r\nimport { fromKeyValueArrays, mapValues } from '../../../../util/iteratees';\r\nimport { logDebugError } from '../../../../util/logs';\r\nimport withCache from '../../../../util/withCache';\r\nimport withCacheAsync from '../../../../util/withCacheAsync';\r\nimport { DnsItem } from '../contracts/DnsItem';\r\nimport { JettonMinter } from '../contracts/JettonMaster';\r\nimport { JettonStakingOpCodes } from '../contracts/JettonStaking/imports/constants';\r\nimport { StakeWallet } from '../contracts/JettonStaking/StakeWallet';\r\nimport { StakingPool } from '../contracts/JettonStaking/StakingPool';\r\nimport { JettonWallet } from '../contracts/JettonWallet';\r\nimport { hexToBytes } from '../../../common/utils';\r\nimport { getEnvironment } from '../../../environment';\r\nimport { DEFAULT_IS_BOUNCEABLE, JettonOpCode, LiquidStakingOpCode, NETWORK_CONFIG, OpCode } from '../constants';\r\nimport { generateQueryId } from './index';\r\n\r\nimport { TonClient } from './TonClient';\r\n\r\ntype TonWalletType = typeof WalletContractV1R1\r\n  | typeof WalletContractV1R2\r\n  | typeof WalletContractV1R3\r\n  | typeof WalletContractV2R1\r\n  | typeof WalletContractV2R2\r\n  | typeof WalletContractV3R1\r\n  | typeof WalletContractV3R2\r\n  | typeof WalletContractV4\r\n  | typeof WalletContractV5R1;\r\n\r\nexport type TonWallet = WalletContractV1R1\r\n  | WalletContractV1R2\r\n  | WalletContractV1R3\r\n  | WalletContractV2R1\r\n  | WalletContractV2R2\r\n  | WalletContractV3R1\r\n  | WalletContractV3R2\r\n  | WalletContractV4\r\n  | WalletContractV5R1;\r\n\r\nconst TON_MAX_COMMENT_BYTES = 127;\r\n\r\nexport const walletClassMap: Record<ApiTonWalletVersion, TonWalletType> = {\r\n  simpleR1: WalletContractV1R1,\r\n  simpleR2: WalletContractV1R2,\r\n  simpleR3: WalletContractV1R3,\r\n  v2R1: WalletContractV2R1,\r\n  v2R2: WalletContractV2R2,\r\n  v3R1: WalletContractV3R1,\r\n  v3R2: WalletContractV3R2,\r\n  v4R2: WalletContractV4,\r\n  W5: WalletContractV5R1,\r\n};\r\n\r\nexport const getTonClient = withCache((network: ApiNetwork) => {\r\n  const { apiHeaders, byNetwork } = getEnvironment();\r\n\r\n  return new TonClient({\r\n    endpoint: `${NETWORK_CONFIG[network].toncenterUrl}/api/v2/jsonRPC`,\r\n    timeout: DEFAULT_TIMEOUT,\r\n    apiKey: byNetwork[network].toncenterKey,\r\n    headers: apiHeaders,\r\n  });\r\n});\r\n\r\nexport const resolveTokenWalletAddress = withCacheAsync(\r\n  async (network: ApiNetwork, address: string, tokenAddress: string) => {\r\n    const minter = getTonClient(network).open(new JettonMinter(Address.parse(tokenAddress)));\r\n    const walletAddress = await minter.getWalletAddress(Address.parse(address));\r\n    return toBase64Address(walletAddress, true, network);\r\n  },\r\n);\r\n\r\nexport const resolveTokenAddress = withCacheAsync(async (network: ApiNetwork, tokenWalletAddress: string) => {\r\n  const tokenWallet = getTonClient(network).open(new JettonWallet(Address.parse(tokenWalletAddress)));\r\n  const data = await tokenWallet.getWalletData();\r\n  return toBase64Address(data.minter, true, network);\r\n});\r\n\r\nexport const getWalletPublicKey = withCacheAsync(async (network: ApiNetwork, address: string) => {\r\n  const res = await getTonClient(network).runMethodWithError(Address.parse(address), 'get_public_key');\r\n  if (res.exit_code !== 0) {\r\n    return undefined;\r\n  }\r\n\r\n  const bigintKey = res.stack.readBigNumber();\r\n  const hex = bigintKey.toString(16).padStart(64, '0');\r\n  return hexToBytes(hex);\r\n});\r\n\r\nexport const getJettonPoolStakeWallet = withCacheAsync(async (\r\n  network: ApiNetwork,\r\n  poolAddress: string,\r\n  period: number,\r\n  address: string,\r\n): Promise<OpenedContract<StakeWallet>> => {\r\n  const tonClient = getTonClient(network);\r\n  const pool = tonClient.open(StakingPool.createFromAddress(Address.parse(poolAddress)));\r\n  const walletAddress = (await pool.getWalletAddress(Address.parse(address), period))!;\r\n  return tonClient.open(StakeWallet.createFromAddress(walletAddress));\r\n});\r\n\r\nexport function getJettonMinterData(network: ApiNetwork, address: string) {\r\n  const contract = getTonClient(network).open(new JettonMinter(Address.parse(address)));\r\n  return contract.getJettonData();\r\n}\r\n\r\nexport function toBase64Address(address: Address | string, isBounceable = DEFAULT_IS_BOUNCEABLE, network?: ApiNetwork) {\r\n  if (typeof address === 'string') {\r\n    address = Address.parse(address);\r\n  }\r\n  return address.toString({\r\n    urlSafe: true,\r\n    bounceable: isBounceable,\r\n    testOnly: network === 'testnet',\r\n  });\r\n}\r\n\r\nexport function toRawAddress(address: Address | string) {\r\n  if (typeof address === 'string') {\r\n    address = Address.parse(address);\r\n  }\r\n  return address.toRawString();\r\n}\r\n\r\nexport function areAddressesEqual(address1: Address | string, address2: Address | string) {\r\n  if (address1 === address2) {\r\n    return true;\r\n  }\r\n\r\n  if (typeof address1 === 'string') address1 = Address.parse(address1);\r\n  if (typeof address2 === 'string') address2 = Address.parse(address2);\r\n\r\n  return address1.equals(address2);\r\n}\r\n\r\nexport function buildTokenTransferBody(params: TokenTransferBodyParams) {\r\n  const {\r\n    queryId,\r\n    tokenAmount,\r\n    toAddress,\r\n    responseAddress,\r\n    forwardAmount,\r\n    customPayload,\r\n  } = params;\r\n  let forwardPayload = params.forwardPayload;\r\n\r\n  let builder = new Builder()\r\n    .storeUint(JettonOpCode.Transfer, 32)\r\n    .storeUint(queryId ?? generateQueryId(), 64)\r\n    .storeCoins(tokenAmount)\r\n    .storeAddress(Address.parse(toAddress))\r\n    .storeAddress(Address.parse(responseAddress))\r\n    .storeMaybeRef(customPayload)\r\n    .storeCoins(forwardAmount ?? 0n);\r\n\r\n  if (forwardPayload instanceof Uint8Array) {\r\n    const freeBytes = Math.round(builder.availableBits / 8);\r\n    forwardPayload = packBytesAsSnake(forwardPayload, freeBytes);\r\n  }\r\n\r\n  if (!forwardPayload) {\r\n    builder.storeBit(false);\r\n  } else if (typeof forwardPayload === 'string') {\r\n    builder = builder.storeBit(false)\r\n      .storeUint(0, 32)\r\n      .storeBuffer(Buffer.from(forwardPayload));\r\n  } else if (forwardPayload instanceof Uint8Array) {\r\n    builder = builder.storeBit(false)\r\n      .storeBuffer(Buffer.from(forwardPayload));\r\n  } else {\r\n    builder = builder.storeBit(true)\r\n      .storeRef(forwardPayload);\r\n  }\r\n\r\n  return builder.endCell();\r\n}\r\n\r\nexport function parseBase64(base64: string) {\r\n  try {\r\n    return Cell.fromBase64(base64);\r\n  } catch (err) {\r\n    logDebugError('parseBase64', err);\r\n    return Uint8Array.from(Buffer.from(base64, 'base64'));\r\n  }\r\n}\r\n\r\nexport function commentToBytes(comment: string): Uint8Array {\r\n  const buffer = Buffer.from(comment);\r\n  const bytes = new Uint8Array(buffer.length + 4);\r\n\r\n  const startBuffer = Buffer.alloc(4);\r\n  startBuffer.writeUInt32BE(OpCode.Comment);\r\n  bytes.set(startBuffer, 0);\r\n  bytes.set(buffer, 4);\r\n\r\n  return bytes;\r\n}\r\n\r\nexport function packBytesAsSnake(bytes: Uint8Array, maxBytes = TON_MAX_COMMENT_BYTES): Uint8Array | Cell {\r\n  const buffer = Buffer.from(bytes);\r\n  if (buffer.length <= maxBytes) {\r\n    return bytes;\r\n  }\r\n\r\n  return packBytesAsSnakeCell(bytes);\r\n}\r\n\r\nexport function packBytesAsSnakeCell(bytes: Uint8Array): Cell {\r\n  const bytesPerCell = TON_MAX_COMMENT_BYTES;\r\n  const cellCount = Math.ceil(bytes.length / bytesPerCell);\r\n  let headCell: Cell | undefined;\r\n\r\n  for (let i = cellCount - 1; i >= 0; i--) {\r\n    const cellOffset = i * bytesPerCell;\r\n    const cellLength = Math.min(bytesPerCell, bytes.length - cellOffset);\r\n    const cellBuffer = Buffer.from(bytes.buffer, bytes.byteOffset + cellOffset, cellLength); // This creates a buffer that references the input bytes instead of copying them\r\n\r\n    const nextHeadCell = new Builder().storeBuffer(cellBuffer);\r\n    if (headCell) {\r\n      nextHeadCell.storeRef(headCell);\r\n    }\r\n    headCell = nextHeadCell.endCell();\r\n  }\r\n\r\n  return headCell ?? Cell.EMPTY;\r\n}\r\n\r\nexport function packBytesAsSnakeForEncryptedData(data: Uint8Array): Cell {\r\n  const ROOT_BUILDER_BYTES = 39;\r\n  const MAX_CELLS_AMOUNT = 16;\r\n\r\n  if (data.length > ROOT_BUILDER_BYTES + MAX_CELLS_AMOUNT * TON_MAX_COMMENT_BYTES) {\r\n    throw new Error('Input text is too long');\r\n  }\r\n\r\n  return new Builder()\r\n    .storeBuffer(Buffer.from(data.subarray(0, ROOT_BUILDER_BYTES)))\r\n    .storeRef(packBytesAsSnakeCell(data.subarray(ROOT_BUILDER_BYTES)))\r\n    .endCell();\r\n}\r\n\r\nexport function buildLiquidStakingDepositBody(queryId?: number) {\r\n  return new Builder()\r\n    .storeUint(LiquidStakingOpCode.Deposit, 32)\r\n    .storeUint(queryId || 0, 64)\r\n    .asCell();\r\n}\r\n\r\nexport function buildLiquidStakingWithdrawBody(options: {\r\n  queryId?: number;\r\n  amount: bigint;\r\n  responseAddress: string;\r\n  waitTillRoundEnd?: boolean; // opposite of request_immediate_withdrawal\r\n  fillOrKill?: boolean;\r\n}) {\r\n  const {\r\n    queryId, amount, responseAddress, waitTillRoundEnd, fillOrKill,\r\n  } = options;\r\n\r\n  const customPayload = buildLiquidStakingWithdrawCustomPayload(waitTillRoundEnd, fillOrKill);\r\n\r\n  return new Builder()\r\n    .storeUint(JettonOpCode.Burn, 32)\r\n    .storeUint(queryId ?? 0, 64)\r\n    .storeCoins(amount)\r\n    .storeAddress(Address.parse(responseAddress))\r\n    .storeBit(1)\r\n    .storeRef(customPayload)\r\n    .asCell();\r\n}\r\n\r\nexport function buildLiquidStakingWithdrawCustomPayload(waitTillRoundEnd?: boolean, fillOrKill?: boolean) {\r\n  return new Builder()\r\n    .storeUint(Number(waitTillRoundEnd), 1)\r\n    .storeUint(Number(fillOrKill), 1)\r\n    .asCell();\r\n}\r\n\r\nexport function getTokenBalance(network: ApiNetwork, walletAddress: string) {\r\n  const tokenWallet = getTonClient(network).open(new JettonWallet(Address.parse(walletAddress)));\r\n  return tokenWallet.getJettonBalance();\r\n}\r\n\r\nexport function parseAddress(address: string): {\r\n  isValid: boolean;\r\n  isRaw?: boolean;\r\n  isUserFriendly?: boolean;\r\n  isBounceable?: boolean;\r\n  isTestOnly?: boolean;\r\n  address?: Address;\r\n} {\r\n  try {\r\n    if (Address.isRaw(address)) {\r\n      return {\r\n        address: Address.parseRaw(address),\r\n        isRaw: true,\r\n        isValid: true,\r\n      };\r\n    } else if (Address.isFriendly(address)) {\r\n      return {\r\n        ...Address.parseFriendly(address),\r\n        isUserFriendly: true,\r\n        isValid: true,\r\n      };\r\n    }\r\n  } catch (err) {\r\n    // Do nothing\r\n  }\r\n\r\n  return { isValid: false };\r\n}\r\n\r\nexport function getIsRawAddress(address: string) {\r\n  return Boolean(parseAddress(address).isRaw);\r\n}\r\n\r\nexport async function getDnsItemDomain(network: ApiNetwork, address: Address | string) {\r\n  if (typeof address === 'string') address = Address.parse(address);\r\n\r\n  const contract = getTonClient(network)\r\n    .open(new DnsItem(address));\r\n  const nftData = await contract.getNftData();\r\n  const collectionAddress = toBase64Address(nftData.collectionAddress, true);\r\n\r\n  const zone = getDnsZoneByCollection(collectionAddress);\r\n\r\n  const base = zone?.isTelemint\r\n    ? await contract.getTelemintDomain()\r\n    : await contract.getDomain();\r\n\r\n  return `${base}.${zone?.suffixes[0]}`;\r\n}\r\n\r\nexport function buildJettonUnstakePayload(jettonsToUnstake: bigint, forceUnstake?: boolean, queryId?: bigint) {\r\n  return beginCell()\r\n    .storeUint(JettonStakingOpCodes.UNSTAKE_JETTONS, 32)\r\n    .storeUint(queryId ?? 0, 64)\r\n    .storeCoins(jettonsToUnstake)\r\n    .storeBit(forceUnstake ?? false)\r\n    .endCell();\r\n}\r\n\r\nexport function buildJettonClaimPayload(poolWallets: string[], queryId?: bigint) {\r\n  const rewardsToClaim = Dictionary.empty(Dictionary.Keys.Address(), Dictionary.Values.Bool());\r\n\r\n  for (const poolWallet of poolWallets) {\r\n    rewardsToClaim.set(Address.parse(poolWallet), true);\r\n  }\r\n\r\n  return beginCell()\r\n    .storeUint(JettonStakingOpCodes.CLAIM_REWARDS, 32)\r\n    .storeUint(queryId ?? 0, 64)\r\n    .storeDict(rewardsToClaim, Dictionary.Keys.Address(), Dictionary.Values.Bool())\r\n    .endCell();\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-redundant-type-constituents\r\nexport function unpackDicts(obj: Record<string, any | Dictionary<any, any>>): AnyLiteral {\r\n  if (!isSimpleObject(obj)) {\r\n    return obj;\r\n  }\r\n\r\n  return mapValues(obj, (value) => {\r\n    if (value instanceof Dictionary) {\r\n      return unpackDicts(fromKeyValueArrays(value.keys(), value.values()));\r\n    }\r\n    if (isSimpleObject(value)) {\r\n      return unpackDicts(value);\r\n    }\r\n    return value;\r\n  });\r\n}\r\n\r\nfunction isSimpleObject(obj: any) {\r\n  // eslint-disable-next-line no-null/no-null\r\n  return obj !== null\r\n    && typeof obj === 'object'\r\n    && Object.getPrototypeOf(obj) === Object.prototype;\r\n}\r\n\r\nexport function getOurFeePayload() {\r\n  return new Builder()\r\n    .storeUint(OpCode.OurFee, 32)\r\n    .endCell();\r\n}\r\n\r\nexport function parseStateInitCell(stateInit: Cell | undefined): StateInit | undefined {\r\n  return stateInit && loadStateInit(stateInit.asSlice());\r\n}\r\n\r\nexport function isSeqnoMismatchError(error: string) {\r\n  return error.match(/exitcode=(33|133)\\D/);\r\n}\r\n\r\nexport function isExpiredTransactionError(error: string) {\r\n  return error.match(/exitcode=(35|136)\\D/);\r\n}\r\n","\"use strict\";\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n  function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n  return new (P || (P = Promise))(function (resolve, reject) {\r\n    function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n    function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n    function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n  });\r\n};\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n  return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.DEFAULT_OPTIONS = exports.exponentialDelay = exports.isNetworkOrIdempotentRequestError = exports.isIdempotentRequestError = exports.isSafeRequestError = exports.isRetryableError = exports.isNetworkError = exports.namespace = void 0;\r\nconst is_retry_allowed_1 = __importDefault(require(\"../is-retry-allowed\"));\r\nexports.namespace = 'axios-retry';\r\nfunction isNetworkError(error) {\r\n  const CODE_EXCLUDE_LIST = ['ERR_CANCELED', 'ECONNABORTED'];\r\n  if (error.response) {\r\n    return false;\r\n  }\r\n  if (!error.code) {\r\n    return false;\r\n  }\r\n  // Prevents retrying timed out & cancelled requests\r\n  if (CODE_EXCLUDE_LIST.includes(error.code)) {\r\n    return false;\r\n  }\r\n  // Prevents retrying unsafe errors\r\n  return (0, is_retry_allowed_1.default)(error);\r\n}\r\nexports.isNetworkError = isNetworkError;\r\nconst SAFE_HTTP_METHODS = ['get', 'head', 'options'];\r\nconst IDEMPOTENT_HTTP_METHODS = SAFE_HTTP_METHODS.concat(['put', 'delete']);\r\nfunction isRetryableError(error) {\r\n  return (error.code !== 'ECONNABORTED' &&\r\n    (!error.response || (error.response.status >= 500 && error.response.status <= 599)));\r\n}\r\nexports.isRetryableError = isRetryableError;\r\nfunction isSafeRequestError(error) {\r\n  var _a;\r\n  if (!((_a = error.config) === null || _a === void 0 ? void 0 : _a.method)) {\r\n    // Cannot determine if the request can be retried\r\n    return false;\r\n  }\r\n  return isRetryableError(error) && SAFE_HTTP_METHODS.indexOf(error.config.method) !== -1;\r\n}\r\nexports.isSafeRequestError = isSafeRequestError;\r\nfunction isIdempotentRequestError(error) {\r\n  var _a;\r\n  if (!((_a = error.config) === null || _a === void 0 ? void 0 : _a.method)) {\r\n    // Cannot determine if the request can be retried\r\n    return false;\r\n  }\r\n  return isRetryableError(error) && IDEMPOTENT_HTTP_METHODS.indexOf(error.config.method) !== -1;\r\n}\r\nexports.isIdempotentRequestError = isIdempotentRequestError;\r\nfunction isNetworkOrIdempotentRequestError(error) {\r\n  return isNetworkError(error) || isIdempotentRequestError(error);\r\n}\r\nexports.isNetworkOrIdempotentRequestError = isNetworkOrIdempotentRequestError;\r\nfunction noDelay() {\r\n  return 0;\r\n}\r\nfunction exponentialDelay(retryNumber = 0, _error = undefined, delayFactor = 100) {\r\n  const delay = Math.pow(2, retryNumber) * delayFactor;\r\n  const randomSum = delay * 0.2 * Math.random(); // 0-20% of the delay\r\n  return delay + randomSum;\r\n}\r\nexports.exponentialDelay = exponentialDelay;\r\nexports.DEFAULT_OPTIONS = {\r\n  retries: 3,\r\n  retryCondition: isNetworkOrIdempotentRequestError,\r\n  retryDelay: noDelay,\r\n  shouldResetTimeout: false,\r\n  onRetry: () => { }\r\n};\r\nfunction getRequestOptions(config, defaultOptions) {\r\n  return Object.assign(Object.assign(Object.assign({}, exports.DEFAULT_OPTIONS), defaultOptions), config[exports.namespace]);\r\n}\r\nfunction setCurrentState(config, defaultOptions) {\r\n  const currentState = getRequestOptions(config, defaultOptions || {});\r\n  currentState.retryCount = currentState.retryCount || 0;\r\n  currentState.lastRequestTime = currentState.lastRequestTime || Date.now();\r\n  config[exports.namespace] = currentState;\r\n  return currentState;\r\n}\r\nfunction fixConfig(axiosInstance, config) {\r\n  // @ts-ignore\r\n  if (axiosInstance.defaults.agent === config.agent) {\r\n    // @ts-ignore\r\n    delete config.agent;\r\n  }\r\n  if (axiosInstance.defaults.httpAgent === config.httpAgent) {\r\n    delete config.httpAgent;\r\n  }\r\n  if (axiosInstance.defaults.httpsAgent === config.httpsAgent) {\r\n    delete config.httpsAgent;\r\n  }\r\n}\r\nfunction shouldRetry(currentState, error) {\r\n  return __awaiter(this, void 0, void 0, function* () {\r\n    const { retries, retryCondition } = currentState;\r\n    const shouldRetryOrPromise = (currentState.retryCount || 0) < retries && retryCondition(error);\r\n    // This could be a promise\r\n    if (typeof shouldRetryOrPromise === 'object') {\r\n      try {\r\n        const shouldRetryPromiseResult = yield shouldRetryOrPromise;\r\n        // keep return true unless shouldRetryPromiseResult return false for compatibility\r\n        return shouldRetryPromiseResult !== false;\r\n      }\r\n      catch (_err) {\r\n        return false;\r\n      }\r\n    }\r\n    return shouldRetryOrPromise;\r\n  });\r\n}\r\nconst axiosRetry = (axiosInstance, defaultOptions) => {\r\n  const requestInterceptorId = axiosInstance.interceptors.request.use((config) => {\r\n    setCurrentState(config, defaultOptions);\r\n    return config;\r\n  });\r\n  const responseInterceptorId = axiosInstance.interceptors.response.use(null, (error) => __awaiter(void 0, void 0, void 0, function* () {\r\n    const { config } = error;\r\n    // If we have no information to retry the request\r\n    if (!config) {\r\n      return Promise.reject(error);\r\n    }\r\n    const currentState = setCurrentState(config, defaultOptions);\r\n    if (yield shouldRetry(currentState, error)) {\r\n      currentState.retryCount += 1;\r\n      const { retryDelay, shouldResetTimeout, onRetry } = currentState;\r\n      const delay = retryDelay(currentState.retryCount, error);\r\n      // Axios fails merging this configuration to the default configuration because it has an issue\r\n      // with circular structures: https://github.com/mzabriskie/axios/issues/370\r\n      fixConfig(axiosInstance, config);\r\n      if (!shouldResetTimeout && config.timeout && currentState.lastRequestTime) {\r\n        const lastRequestDuration = Date.now() - currentState.lastRequestTime;\r\n        const timeout = config.timeout - lastRequestDuration - delay;\r\n        if (timeout <= 0) {\r\n          return Promise.reject(error);\r\n        }\r\n        config.timeout = timeout;\r\n      }\r\n      config.transformRequest = [(data) => data];\r\n      yield onRetry(currentState.retryCount, error, config);\r\n      return new Promise((resolve) => {\r\n        setTimeout(() => resolve(axiosInstance(config)), delay);\r\n      });\r\n    }\r\n    return Promise.reject(error);\r\n  }));\r\n  return { requestInterceptorId, responseInterceptorId };\r\n};\r\n// Compatibility with CommonJS\r\naxiosRetry.isNetworkError = isNetworkError;\r\naxiosRetry.isSafeRequestError = isSafeRequestError;\r\naxiosRetry.isIdempotentRequestError = isIdempotentRequestError;\r\naxiosRetry.isNetworkOrIdempotentRequestError = isNetworkOrIdempotentRequestError;\r\naxiosRetry.exponentialDelay = exponentialDelay;\r\naxiosRetry.isRetryableError = isRetryableError;\r\nexports.default = axiosRetry;\r\n","import type {\r\n  Cell,\r\n  Contract,\r\n  ContractProvider,\r\n} from '@ton/core';\r\nimport {\r\n  Address,\r\n  beginCell,\r\n  contractAddress,\r\n} from '@ton/core';\r\n\r\nimport { dnsCategoryToBigInt } from '../util/dns';\r\nimport { DnsCategory, DnsOpCode } from '../constants';\r\n\r\nexport type DnsItemConfig = object;\r\n\r\nexport function dnsItemConfigToCell(config: DnsItemConfig): Cell {\r\n  return beginCell().endCell();\r\n}\r\n\r\nexport class DnsItem implements Contract {\r\n  constructor(\r\n    readonly address: Address,\r\n    readonly init?: { code: Cell; data: Cell },\r\n  ) {}\r\n\r\n  static createFromAddress(address: Address) {\r\n    return new DnsItem(address);\r\n  }\r\n\r\n  static createFromConfig(config: DnsItemConfig, code: Cell, workchain = 0) {\r\n    const data = dnsItemConfigToCell(config);\r\n    const init = { code, data };\r\n    return new DnsItem(contractAddress(workchain, init), init);\r\n  }\r\n\r\n  async getDomain(provider: ContractProvider) {\r\n    const res = await provider.get('get_domain', []);\r\n    const domain = res.stack.readString();\r\n    return domain;\r\n  }\r\n\r\n  async getTelemintDomain(provider: ContractProvider) {\r\n    const res = await provider.get('get_domain_full', []);\r\n    const domain = res.stack.readString();\r\n    const parts = domain.replace(/\\\\u0000/g, '.').replace(/\\.$/, '').split('.');\r\n    parts.reverse();\r\n    return parts.join('.');\r\n  }\r\n\r\n  async getNftData(provider: ContractProvider) {\r\n    const res = await provider.get('get_nft_data', []);\r\n    const index = res.stack.readBigNumber();\r\n    const collectionAddress = res.stack.readAddress();\r\n    const owner = res.stack.readAddressOpt();\r\n\r\n    return {\r\n      index,\r\n      collectionAddress,\r\n      owner,\r\n    };\r\n  }\r\n\r\n  async getLastFillUpTime(provider: ContractProvider): Promise<bigint> {\r\n    const result = await provider.get('get_last_fill_up_time', []);\r\n    return result.stack.readBigNumber();\r\n  }\r\n\r\n  static buildFillUpMessage(queryId?: bigint) {\r\n    return DnsItem.buildDeleteDnsRecordMessage(queryId);\r\n  }\r\n\r\n  static buildDeleteDnsRecordMessage(queryId?: bigint, category?: string) {\r\n    return beginCell()\r\n      .storeUint(DnsOpCode.ChangeRecord, 32)\r\n      .storeUint(queryId ?? 0n, 64)\r\n      .storeUint(dnsCategoryToBigInt(category), 256)\r\n      .endCell();\r\n  }\r\n\r\n  static buildChangeDnsWalletMessage(address: string, queryId?: bigint) {\r\n    return beginCell()\r\n      .storeUint(DnsOpCode.ChangeRecord, 32)\r\n      .storeUint(queryId ?? 0n, 64)\r\n      .storeUint(dnsCategoryToBigInt(DnsCategory.Wallet), 256)\r\n      .storeRef(\r\n        beginCell()\r\n          .storeUint(0x9fd3, 16)\r\n          .storeAddress(Address.parse(address))\r\n          .storeUint(0, 8)\r\n          .endCell(),\r\n      )\r\n      .endCell();\r\n  }\r\n}\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n// expose the modules object (__webpack_modules__)\n__webpack_require__.m = __webpack_modules__;\n\n// the startup function\n__webpack_require__.x = () => {\n\t// Load entry module and return exports\n\t// This entry module depends on other loaded chunks and execution need to be delayed\n\tvar __webpack_exports__ = __webpack_require__.O(undefined, [487], () => (__webpack_require__(27215)))\n\t__webpack_exports__ = __webpack_require__.O(__webpack_exports__);\n\treturn __webpack_exports__;\n};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.f = {};\n// This file contains only the entry chunk.\n// The chunk loading function for additional chunks\n__webpack_require__.e = (chunkId) => {\n\treturn Promise.all(Object.keys(__webpack_require__.f).reduce((promises, key) => {\n\t\t__webpack_require__.f[key](chunkId, promises);\n\t\treturn promises;\n\t}, []));\n};","// This function allow to reference async chunks and chunks that the entrypoint depends on\n__webpack_require__.u = (chunkId) => {\n\t// return url for filenames based on template\n\treturn \"\" + chunkId + \".\" + {\"35\":\"3cf98a839d1a7cf2f5d8\",\"316\":\"e7fb80cc2ba617d81496\",\"487\":\"3dc0c6bf5bc1e954a4ba\",\"557\":\"73c8c81c54275740bbe9\",\"983\":\"801be74aee0fe487e3a4\"}[chunkId] + \".js\";\n};","// This function allow to reference async chunks and chunks that the entrypoint depends on\n__webpack_require__.miniCssF = (chunkId) => {\n\t// return url for filenames based on template\n\treturn undefined;\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","var scriptUrl;\nif (__webpack_require__.g.importScripts) scriptUrl = __webpack_require__.g.location + \"\";\nvar document = __webpack_require__.g.document;\nif (!scriptUrl && document) {\n\tif (document.currentScript && document.currentScript.tagName.toUpperCase() === 'SCRIPT')\n\t\tscriptUrl = document.currentScript.src;\n\tif (!scriptUrl) {\n\t\tvar scripts = document.getElementsByTagName(\"script\");\n\t\tif(scripts.length) {\n\t\t\tvar i = scripts.length - 1;\n\t\t\twhile (i > -1 && (!scriptUrl || !/^http(s?):/.test(scriptUrl))) scriptUrl = scripts[i--].src;\n\t\t}\n\t}\n}\n// When supporting browsers where an automatic publicPath is not supported you must specify an output.publicPath manually via configuration\n// or pass an empty string (\"\") and set the __webpack_public_path__ variable from your code to use your own logic.\nif (!scriptUrl) throw new Error(\"Automatic publicPath is not supported in this browser\");\nscriptUrl = scriptUrl.replace(/^blob:/, \"\").replace(/#.*$/, \"\").replace(/\\?.*$/, \"\").replace(/\\/[^\\/]+$/, \"/\");\n__webpack_require__.p = scriptUrl;","// no baseURI\n\n// object to store loaded chunks\n// \"1\" means \"already loaded\"\nvar installedChunks = {\n\t941: 1\n};\n\n// importScripts chunk loading\nvar installChunk = (data) => {\n\tvar [chunkIds, moreModules, runtime] = data;\n\tfor(var moduleId in moreModules) {\n\t\tif(__webpack_require__.o(moreModules, moduleId)) {\n\t\t\t__webpack_require__.m[moduleId] = moreModules[moduleId];\n\t\t}\n\t}\n\tif(runtime) runtime(__webpack_require__);\n\twhile(chunkIds.length)\n\t\tinstalledChunks[chunkIds.pop()] = 1;\n\tparentChunkLoadingFunction(data);\n};\n__webpack_require__.f.i = (chunkId, promises) => {\n\t// \"1\" is the signal for \"already loaded\"\n\tif(!installedChunks[chunkId]) {\n\t\tif(true) { // all chunks have JS\n\t\t\timportScripts(__webpack_require__.p + __webpack_require__.u(chunkId));\n\t\t}\n\t}\n};\n\nvar chunkLoadingGlobal = self[\"webpackChunkmytonwallet\"] = self[\"webpackChunkmytonwallet\"] || [];\nvar parentChunkLoadingFunction = chunkLoadingGlobal.push.bind(chunkLoadingGlobal);\nchunkLoadingGlobal.push = installChunk;\n\n// no HMR\n\n// no HMR manifest","// run startup\nvar __webpack_exports__ = __webpack_require__.x();\n"],"names":["deferred","next","Big","RM","NE","PE","ten","fromDecimal","value","decimals","BigInt","mul","pow","TONCOIN","round","toString","toDecimal","noFloor","arguments","length","undefined","toBig","div","roundHalfUp","BIGINT_PREFIX","bigintReviver","key","startsWith","slice","bigintAbs","bigintDivideToNumber","num","ONE_TON","bigintMultiplyToNumber","bigintRandom","bytes","randomNumber","randomBytes","randomBigInt","TON_BIP39_PATH","NETWORK_CONFIG","mainnet","toncenterUrl","TONCENTER_MAINNET_URL","tonApiIoUrl","TONAPIIO_MAINNET_URL","chainId","testnet","TONCENTER_TESTNET_URL","TONAPIIO_TESTNET_URL","TOKEN_TRANSFER_AMOUNT","TINY_TOKEN_TRANSFER_AMOUNT","TOKEN_TRANSFER_REAL_AMOUNT","TINY_TOKEN_TRANSFER_REAL_AMOUNT","TINIEST_TOKEN_TRANSFER_REAL_AMOUNT","TOKEN_TRANSFER_FORWARD_AMOUNT","CLAIM_MINTLESS_AMOUNT","NFT_TRANSFER_AMOUNT","NFT_TRANSFER_REAL_AMOUNT","NFT_TRANSFER_FORWARD_AMOUNT","NFT_PAYLOAD_SAFE_MARGIN","TON_GAS","stakeNominators","unstakeNominators","stakeLiquid","unstakeLiquid","stakeJettonsForward","JettonStakingGas","STAKE_JETTONS","stakeJettons","unstakeJettons","UNSTAKE_JETTONS","claimJettons","JETTON_TRANSFER","SIMPLE_UPDATE_REQUEST","changeDns","stakeEthena","stakeEthenaForward","unstakeEthena","unstakeEthenaForward","unstakeEthenaLocked","unstakeEthenaLockedForward","STAKE_COMMENT","UNSTAKE_COMMENT","ATTEMPTS","DEFAULT_DECIMALS","DEFAULT_IS_BOUNCEABLE","WALLET_IS_BOUNCEABLE","FEE_FACTOR","ALL_WALLET_VERSIONS","OUR_FEE_PAYLOAD_BOC","Workchain","WORKCHAIN","BaseChain","TRANSFER_TIMEOUT_SEC","DEFAULT_MAX_MESSAGES","LEDGER_MAX_MESSAGES","W5_MAX_MESSAGES","LEDGER_WALLET_VERSIONS","v3R2","v4R2","LEDGER_DEFAULT_WALLET_VERSION","LEDGER_VESTING_SUBWALLET_ID","OpCode","JettonOpCode","NftOpCode","LiquidStakingOpCode","JettonStakingOpCode","VestingV1OpCode","SingleNominatorOpCode","DnsOpCode","TeleitemOpCode","OtherOpCode","ContractType","DnsCategory","EXCESS_OP_CODES","Excesses","Ok","DNS_CATEGORY_HASH_MAP","dns_next_resolver","wallet","site","storage","KnownContracts","simpleR1","name","oldHash","type","Wallet","simpleR2","simpleR3","v2R1","v2R2","v3R1","v4R1","W5","highloadV2","nominatorPool","Staking","multisig","multisigV2","vesting","multisigNew","dedustPool","isSwapAllowed","dedustVaultNative","dedustVaultJetton","stonPtonWallet","stonRouter","stonRouterV2_1","stonPoolV2_1","stonRouterV2_2","stonRouterV2_2_alt","stonPoolV2_2","stonPtonWalletV2","toncoRouter","hash","nativeCallNumber","airAppCallWindow","methodName","_len","args","Array","_key","airWindow","window","bridge","airBridge","Promise","resolve","reject","requestNumber","_airWindow$webkit","nativeCallCallbacks","response","ok","result","Error","ApiCommonError","Unexpected","webkit","messageHandlers","nativeCall","postMessage","arg0","arg1","androidApp","ConnectorClass","requestStates","Map","requestStatesByCallback","constructor","target","onUpdate","channel","shouldUseJson","targetOrigin","destroy","init","this","request","messageData","messageId","generateUniqueId","payload","requestState","promise","Object","assign","withCallback","callback","pop","set","catch","finally","delete","cancelCallback","progressCallback","isCanceled","get","onMessage","data","decodeExtensionMessage","err","logDebugError","update","error","decodeError","_requestState$callbac","call","callbackArgs","rawData","encodeExtensionMessage","connector","initWindowConnector","worker","createConnector","handleMessage","_ref","addEventListener","removeEventListener","self","WINDOW_PROVIDER_CHANNEL","callWindow","IS_AIR_APP","Deferred","resolved","SECOND","YEAR","withCache","langCode","dayStartAt","noYear","monthFormat","noDay","withTime","Date","toLocaleString","year","month","day","hour","minute","hourCycle","ApiLiquidUnstakeMode","now","Math","random","cache","WeakMap","fn","fnCache","cacheKey","map","String","join","cached","newValue","UNDEFINED_PREFIX","extensionMessageReplacer","extensionMessageReviver","JSON","stringify","parse","encodeError","message","stack","dnsCategoryToBigInt","category","s","sha256_sync","parseSmartContractAddressImpl","cell","prefix0","prefix1","asSlice","byte0","loadUint","byte1","n","loadUintBig","hashPart","padStart","Address","parseAddress","parseNextResolverRecord","parseStorageBagIdRecord","loadBuffer","async","dnsResolveImpl","client","dnsAddress","rawDomainBytes","oneStep","len","domainCell","Builder","storeBuffer","asCell","categoryBigInt","callGetMethod","resultLen","readNumber","readCell","DnsNextResolver","parseSmartContractAddressRecord","Site","parseAdnlAddressRecord","parseSiteRecord","BagId","nextAddress","encodeDomain","domain","toLowerCase","i","charCodeAt","substring","c","fromCharCode","arr","split","forEach","part","reverse","dnsResolve","rootDnsAddress","rawDomain","Buffer","from","callbackState","prototype","toJSON","parseAccountId","accountId","parts","id","network","Number","address","shift","fromRight","FILLER","CHAIN_CONFIG","ton","title","isDnsSupported","canBuyWithCardInRussia","isTransferCommentSupported","isLedgerSupported","addressRegex","addressPrefixRegex","nativeToken","doesBackendSocketSupport","buySwap","tokenInSlug","DEFAULT_CEX_SWAP_SECOND_TOKEN_SLUG","amountIn","explorer","baseUrl","token","transaction","doConvertHashFromBase64","formatTransferUrl","amount","text","jettonAddress","url","params","push","encodeURIComponent","tron","TRX","DEFAULT_TRX_SWAP_FIRST_TOKEN_SLUG","getChainConfig","chain","chainByNativeSlug","fromEntries","keys","getNativeToken","slug","getChainBySlug","items","Set","PENDING_STATUSES","parseTxId","txId","subId","buildLocalTxId","buildTxId","getActivityTokenSlugs","activity","kind","nft","to","getActivityChains","unique","getIsActivityPending","has","status","getIsActivityPendingForUser","endsWith","compareActivities","a","b","isAsc","timestamp","sortActivities","activities","uniqueByKey","sort","a1","a2","mergeSortedActivities","lists","areActivitiesSortedAndUnique","mergeSortedArrays","crc32Table","makeCrc32Table","Uint32Array","k","signDataWithPrivateKey","walletAddress","privateKey","beginCell","storeUint","schema","crc","crc32FromBytes","storeAddress","storeStringRefTail","storeRef","Cell","fromBase64","endCell","hashBuffer","Uint8Array","buffer","byteOffset","byteLength","createCellDataHash","concat","makeAddressBuffer","makeBytesWithLengthBuffer","makeTimestampBuffer","sha256","createTextDataHash","nacl","detached","addressBuffer","allocUnsafe","writeInt32BE","workChain","copy","isBigEndian","writeInt32LE","unixSeconds","timestampBuffer","writeBigInt64BE","writeBigInt64LE","pathRegex","replaceDerive","val","replace","derivePath","path","seed","offset","test","some","isNaN","isValidPath","chainCode","I","createHmac","digest","getMasterKeyFromSeed","el","parseInt","reduce","parentKeys","segment","CKDPriv","index","indexBuffer","writeUInt32BE","alloc","isMnemonicPrivateKey","mnemonic","PRIVATE_KEY_HEX_LENGTH","StorageType","getItem","force","getEnvironment","isAndroidApp","setItem","removeItem","clear","getKeys","IS_EXTENSION","chrome","local","_await$storage$get","remove","bind","getAll","setMany","getMany","store","idb","INDEXED_DB_NAME","INDEXED_DB_STORE_NAME","values","fromKeyValueArrays","entries","withPromise","localStorage","pick","extensionStorage","IS_CAPACITOR","capacitorStorage","MIN_ACCOUNT_NUMBER","IndexedDb","LocalStorage","ExtensionLocal","CapacitorStorage","loginResolve","loginPromise","fetchStoredAddress","fetchStoredChainAccount","byChain","fetchStoredWallet","fetchMaybeStoredAccount","getAccountValue","fetchStoredAccount","account","fetchStoredAccounts","updateStoredAccount","partial","setAccountValue","updateStoredWallet","_await$storage$getIte","removeAccountValue","removedValue","restData","removeNetworkAccountsValue","getCurrentNetwork","getCurrentAccountId","getAccountChains","mapValues","ledgerIndex","doesAccountHaveChain","PBKDF2_IMPORT_KEY_ARGS","PBKDF2_DERIVE_KEY_ARGS","iterations","PBKDF2_DERIVE_KEY_TYPE","validateBip39Mnemonic","bip39","encryptMnemonic","password","plaintext","salt","crypto","getRandomValues","keyMaterial","subtle","importKey","TextEncoder","encode","deriveKey","iv","ptUint8","ctBuffer","encrypt","ctArray","ctBase64","btoa","ivHex","decryptMnemonic","encrypted","includes","pwUtf8","pwHash","match","byte","alg","ctStr","atob","ctUint8","ch","plainBuffer","decrypt","TextDecoder","decode","decryptMnemonicLegacy","saltHex","encryptedData","getMnemonic","sensitiveData","mnemonicEncrypted","decryptedMnemonic","DebugError","removeSensitiveDataFromError","tryMigratingMnemonicEncryption","removeFromString","toRemove","replaceAll","_error$stack","RE_SYMBOL_WITH_COMBINING_MARKS","RE_LINEBREAK_COMBINING_MARKS","RE_SPACE_CHARS","RE_FAKE_DOTS","RE_EMPTY_CHARS","checkLNPRegex","characters","alphabetMap","confusablesMap","base","alts","char","cleanText","str","checkLNP","newStr","clean","BAD_REQUEST_CODE","PROXY_BASE_URL","callBackendPost","options","authToken","isAllowBadRequest","method","shouldRetry","retries","timeouts","URL","headers","getBackendHeaders","body","fetchWithRetry","shouldSkipRetryFn","fetch","handleFetchErrors","json","callBackendGet","fetchJson","apiHeaders","APP_VERSION","APP_ENV","addBackendHeadersToSocketUrl","exec","searchParams","append","knownAddresses","scamMarkers","trustedSites","trustedCollections","tonNftSuperCollectionsByCollectionAddress","nftSuperCollectionsDeferred","tryUpdateKnownAddresses","x","RegExp","tonNftSuperCollections","acc","superCollection","collections","rest","getKnownAddresses","getNftSuperCollectionsByCollectionAddress","getKnownAddressInfo","checkIsTrustedSite","checkIsTrustedCollection","checkHasScamLink","matches","matchAll","RE_LINK_TEMPLATE","_match$groups","host","groups","toMilliseconds","seconds","toSeconds","ms","floor","isEmptyObject","obj","keyCount","hasOwnProperty","isKeyCountGreater","IGNORED_DEXIE_ERRORS","tryDbQuery","cb","ApiDb","Dexie","nfts","tokens","super","version","stores","sseConnections","upgrade","tx","table","toCollection","modify","price","apiDb","tokenRepository","all","toArray","find","where","put","item","bulkPut","deleteWhere","tokensPreload","tokensCache","bySlug","TOKEN_INFO","updateTokens","sendUpdate","tokenDetails","shouldSendUpdate","tokensForDb","detailsBySlug","buildCollectionByKey","details","cachedToken","mergedToken","mergeTokenWithCache","tokenAddress","omitUndefined","isFromBackend","priceUsd","percentChange24h","getTokensCache","getTokenBySlug","getTokenByAddress","buildTokenSlug","sendUpdateTokens","ADDRESS_BOOK_CHUNK_SIZE","VERSION_MAP","fixAddressFormat","callToncenterV3","address_book","getWalletInfos","addresses","wallets","states","addressBook","walletInfoByRawAddress","state","buildWalletInfo","inputAddress","rawAddress","toRawAddress","balance","isInitialized","seqno","user_friendly","wallet_type","lastTxId","last_transaction_hash","getToncenterHeaders","byNetwork","apiKey","toncenterKey","MAX_LIMIT","getApi","Api","HttpClient","baseApiParams","customFetch","fetchJettonBalances","accounts","getAccountJettonsBalances","supported_extensions","balances","fetchNftItems","getNftItemsByAddresses","account_ids","nft_items","OFFCHAIN_CONTENT_PREFIX","dictSnakeBufferValue","sliceToVal","v","isFirst","remainingBits","remainingRefs","loadRef","beginParse","serialize","jettonOnChainMetadataSpec","uri","description","image","symbol","custom_payload_api_uri","fetchJettonOffchainMetadata","metadata","fetchJsonWithProxy","parsePayloadBase64","base64","fromBoc","Slice","BitReader","BitString","dataToSlice","shouldLoadItems","transactionDebug","opCode","Comment","comment","readSnakeBytes","Encrypted","encryptedComment","queryId","Transfer","_forwardPayload","resolveTokenAddress","loadCoins","destination","loadAddress","responseDestination","loadMaybeAddress","toBase64Address","customPayload","loadMaybeRef","forwardAmount","forwardPayloadOpCode","forwardPayload","builder","storeBits","loadBits","range","forwardPayloadSlice","toBoc","TransferOwnership","_nft","newOwner","readForwardPayloadCell","readComment","nftSuperCollectionsByCollectionAddress","rawNft","parseTonapiioNft","nftAddress","nftName","OwnershipAssigned","prevOwner","Burn","addressObj","isLiquidUnstakeRequest","LIQUID_JETTON","DistributedAsset","Withdrawal","Deposit","appId","AddWhitelist","toAddress","toRawString","Withdraw","ChangeValidator","Vote","votingAddress","expirationDate","vote","loadBit","needConfirmation","ChangeRecord","_Object$entries$find","getDnsItemDomain","dataSlice","endParse","dataAddress","flags","record","Unknown","TokenBridgePaySwap","swapId","UnstakeRequest","isForce","loadBoolean","DEBUG","_opCode","debugTxString","opCodeHex","parsePayloadSlice","buildMtwCardsNftMetadata","attributes","mtwCardType","mtwCardTextType","_attributes$find","_attributes$find2","_attributes$find3","imageUrl","mtwCardId","isArray","attribute","trait_type","trim","mtwCardBorderShineType","collection","rawMetadata","previews","sale","trust","owner","render_type","renderType","lottie","collectionAddress","hasScamLink","filter","Boolean","isWhitelisted","isScam","isHidden","imageFromPreview","resolution","isFragmentGift","getIsFragmentGift","getProxiedLottieUrl","MTW_CARDS_COLLECTION","fragmentUrl","NFT_FRAGMENT_GIFT_IMAGE_TO_URL_REGEX","ownerAddress","fixIpfsUrl","thumbnail","isOnSale","collectionName","isOnFragment","NFT_FRAGMENT_COLLECTIONS","isTelegramGift","_nftSuperCollectionsB","TELEGRAM_GIFTS_SUPER_COLLECTION","areDeepEqual","value1","value2","type1","isArray1","array1","array2","every","member1","object1","object2","keys1","keys2","key1","key2","getDappConnectionUniqueId","_sseOptions","_sse","sseOptions","appClientId","sse","migrationEnsurePromise","currentOnUpdate","updateActivityMetadata","normalizedAddress","isIncoming","isNftTransfer","hasScamMarkers","sm","hasScamInComment","RE_TG_BOT_MENTION","isUpdaterAlive","buildOldAccountId","iosBackupAndMigrateKeychainMode","backupKey","assert","backupValue","shouldRewrite","RAW_LIQUID_POOL_ADDRESS","TME_RENEW_HASH_SUFFIX","RAW_NFT_COLLECTIONS_TO_RELOAD_METADATA","fetchActions","limit","toTimestamp","fromTimestamp","shouldIncludeFrom","shouldIncludeTo","includeTypes","excludeTypes","action_id","actionId","start_utime","end_utime","action_type","exclude_action_type","actions","rawActions","parseActions","isPending","action","parseAction","parseTonTransfer","parseCallContract","parseContractDeploy","parseNftTransfer","parseNftMint","parseJettonTransfer","parseJettonMint","parseJettonBurn","parseStakeDeposit","parseStakeWithdrawal","parseStakeWithdrawalRequest","parseJettonSwap","parseDns","parseAuctionBid","parseLiquidityDeposit","source","pool","dex","partialExtended","parseCommonFields","shouldLoadDetails","extra","convertDexId","additionalId","buildActionActivityId","amount_1","getAssetSlug","asset_1","amount_2","asset_2","parseLiquidityWithdraw","_activity$nft","shouldHide","isEncrypted","common","opcode","OurFee","Bounced","ClaimRewards","fee","is_encrypted_comment","forward_payload","sender","receiver","fromAddress","asset","BURN_ADDRESS","MYCOIN_STAKING_POOL","TON_USDE","ETHENA_STAKING_VAULT","receiver_jetton_wallet","jettonWalletRaw","commonFields","TON_TSUSDE","end_lt","trace_end_lt","owner_jetton_wallet","jettonWallet","nft_item_index","nft_item","rawNftAddress","nft_collection","rawCollectionAddress","new_owner","old_owner","oldOwner","is_purchase","isPurchase","response_destination","marketplace","isMetadataMissing","parseToncenterNft","_metadata$rawCollecti","_collectionMetadata$n","collectionMetadata","token_info","isHiddenCollection","_addressBook$oldOwner","_addressBook$newOwner","oldOwnerAddress","newOwnerAddress","payloadBase64","safeExec","isExotic","shouldReload","_addressBook$newOwner2","isBuying","stake_holder","holder","LIQUID_POOL","provider","payout_nft","_parseToncenterJetton","_parseToncenterJetton2","endUtime","success","isSuccess","dex_incoming_transfer","fromAmount","fromAsset","dex_outgoing_transfer","toAmount","toAsset","decimalsFrom","parseToncenterJetton","decimalsTo","fromTokenAddress","toTokenAddress","STON_PTON_ADDRESS","networkFee","swapFee","ourFee","hashes","externalMsgHashNorm","trace_external_hash_norm","trace_external_hash","sum_type","sumType","bidder","auction","destination_liquidity","destinationAddress","rawFromAddress","rawToAddress","amountString","metadataMap","nftMetadata","extractMetadata","zone","domainZone","domainBase","getDnsDomainZone","suffixes","DNS_IMAGE_GEN_URL","_image_medium","resolver","isMtwCard","fixedImage","jettonMetadata","_data$token_info","is_indexed","tokenInfo","start_lt","trace_id","parseActionActivityId","traceId","startLt","toncenterDex","createCallbackManager","callbacks","removeCallback","runCallbacks","addCallback","add","hasCallbacks","size","focusListeners","isFocused","onFocusAwareDelay","forceMs","cleanup","callCb","setCancellableTimeout","unsubscribeFocus","cancelSecondTimeout","focusAwareDelay","msWhenNotFocused","setIsAppFocused","_isFocused","SEC","MINUTE","DAYS_IN_YEAR","FAKE_TX_ID","activeWalletTiming","pollOnStart","minPollDelay","focused","notFocused","pollingStartDelay","pollingPeriod","forcedPollingPeriod","inactiveWalletTiming","pollingLoop","cancelPause","period","minDelay","skipInitialPoll","prepare","poll","isStopped","dependenciesDeferred","iteration","throttle","_cancelPause","dependencies","scheduleIteration","periodToMs","_cancelPause2","then","stop","_cancelPause3","withDoubleCheck","pauses","cancelDoubleCheck","makeAttempt","attemptNumber","_cancelDoubleCheck","_cancelDoubleCheck2","run","cancel","_cancelDoubleCheck3","FallbackPollingScheduler","isSocketConnected","onSocketConnect","onSocketDisconnect","onSocketMessage","_this$cancelScheduled","handleError","_this$cancelScheduled2","firstPause","nextPause","schedule","ReconnectingWebSocket","send","isConnected","reconnect","close","onConnect","onDisconnect","WebSocket","binaryType","onerror","onopen","onclose","onmessage","DEFAULT_TIMEOUT","_this$cancelTimeout","#handleSocketOpen","_this$cancelTimeout2","logDebug","event","code","reason","wasClean","reconnectDelay","min","ArrayBuffer","PING_INTERVAL","PONG_TIMEOUT","ToncenterSocket","watchWallets","onNewActivities","onBalanceUpdate","watcher","watcherId","findIndex","splice","_this$socket","protocol","pathname","getSocketUrl","socket","_this$cancelReconnect","#handleSocketConnect","_this$socket2","operation","include_address_book","include_metadata","supported_action_types","TONCENTER_ACTIONS_VERSION","#handleSocketDisconnect","_this$stopPing","forbidConcurrency","arePending","messageHashNormalized","activitiesByAddress","addressWhitelist","actionsByAddress","byAddress","_addressBook$rawAddre","groupActionsByAddress","parseSocketActions","addressesToNotify","isWatcherReadyForNewActivities","jetton","tokenBase64Address","isWatcherReady","watchedAddress","areAddressesEqual","subscriptions","requestId","preparedSubscriptions","events","watchedAddresses","_this$stopPing2","pingIntervalId","setInterval","_this$socket3","_this$cancelReconnect2","_this$socket4","clearInterval","newActionAddresses","areNewActionsPending","prevSavedAddresses","nextSavedAddresses","getToncenterSocket","isActivityUpdateFinal","throttleToncenterSocketActions","delayMs","onUpdates","updatesByHash","scheduleReport","cancelReport","toReport","_updatesByHash$hash","_updatesByHash$hash$c","ActivityStream","pendingActivities","finishedHashes","rememberFinishedHashes","messageHashNorms","releaseFinishedHashesMemory","confirmedActivities","allPendingActivities","pendingUpdates","extractKey","currentPendingActivities","socketUpdates","hashesToRemove","flatMap","mergePendingActivities","managePendingActivities","newestConfirmedActivityTimestamp","fallbackPollingOptions","onLoadingChange","updates","instantConfirmedActivities","stashedConfirmedActivities","unshift","newConfirmedActivities","loadPendingActivities","fetchPendingActions","parseRawTransaction","rawTx","total_fees","totalFees","compute_ph","exit_code","exitCode","in_msg","out_msgs","inMsgHashNorm","hash_norm","msgs","oneMsgFee","transactions","msg","fwd_fee","fwdFee","msgHash","bounced","resolveAddress","skipFormatSelection","isDnsDomain","resolvedAddress","zoneMatch","getTonClient","_err$message","resolveAddressByDomain","chunks","chunk","fetchAddressBook","normalizeAddress","known","isAddressInitialized","withCacheAsync","walletOrAddress","getWalletInfo","isActiveSmartContract","publicKeyToAddress","publicKey","walletVersion","isTestnetSubwalletId","buildWallet","hexToBytes","WalletClass","walletClassMap","create","workchain","walletId","networkGlobalId","getContractInfo","getAddressInfo","codeHashOld","base64ToBytes","codeHash","contractInfo","info","isWallet","getWalletBalance","getWalletVersionInfos","getWalletVersions","walletInfos","testnetWallet","testnetAddress","mainnetWallet","pickWalletByAddress","w","getTonWallet","tonWallet","checkIsTestnetSubwalletId","generateMnemonic","tonWebMnemonic","validateMnemonic","privateKeyHexToKeyPair","privateKeyHex","keyPair","fromSeed","fetchPrivateKey","secretKey","bip39MnemonicToKeyPair","fetchKeyPair","console","rawSign","dataHex","signature","bytesToHex","getWalletFromMnemonic","getWalletFromKeys","getWalletFromPrivateKey","allWallets","defaultWallets","DEFAULT_WALLET_VERSION","defaultWallet","_ref2","withBiggestBalance","best","current","withLastTx","findLast","_ref3","v4Wallet","_ref4","pickBestWallet","hexSeed","HDKey","getOtherVersionWallet","otherVersion","getWalletFromAddress","addressOrDomain","ApiAuthError","DomainNotResolved","InvalidAddress","walletInfo","getWalletPublicKey","getAesCbcState","aesjs","cbc","combineSecrets","hmacAlgo","hmacKey","sign","hmacSha512","encryptMessageComment","myPublicKey","theirPublicKey","myPrivateKey","senderAddress","commentBytes","encryptedBytes","sharedSecret","getSharedSecret","prefix","dataLength","prefixLength","minPadding","getRandomPrefix","combined","msgKey","res","encryptDataWithPrefix","encryptDataImpl","prefixedEncrypted","encryptData","decryptMessageComment","decryptedBytes","cbcStateSecret","decryptedData","gotMsgKey","doDecrypt","decryptDataImpl","decryptData","getSigner","isMockSigning","ledgerSubwalletId","MockSigner","LedgerSigner","MnemonicSigner","PrivateKeySigner","signTonProof","proof","getPrivateKey","messageBuffer","bufferToSign","signTonProofWithPrivateKey","signTransactions","storedWallet","secretKeyUint8Array","WalletContractV5R1","createTransfer","messages","authType","signTransactionsWithPrivateKey","signData","encryptComment","recipientPublicKey","getPublicKey","decryptComment","publicKeyHex","isMock","InvalidPassword","subwalletId","signTonProofWithLedger","signTonTransactionsWithLedger","fetchAndParseTrace","msgHashNormalized","isActionPending","trace","include_actions","traces","fetchTrace","parseTrace","traceDetail","byTransactionIndex","children","traceDetails","rawTransactions","txHash","tx_hash","sent","received","parseFailedTransactions","flat","byHash","groupBy","isWalletTransactionFound","processTrace","_traceDetail","_index","txs","child","_ref5","in_msg_hash","parseCompletedTransactions","totalSent","total","totalReceived","totalNetworkFee","GET_TRANSACTIONS_LIMIT","RELOAD_ACTIVITIES_PAUSE","TRACE_RETRY_DELAY","checkHasTransaction","fetchTransactions","fetchActivitySlice","tokenSlug","tokenWalletAddress","resolveTokenWalletAddress","reloadIncompleteActivities","actionIdsToReload","attempt","pause","tryReloadIncompleteActivities","actionIdBatches","reloadedActivities","actionIds","replacedIds","reloadedActionIds","findDifference","calculateActivityDetails","parsedTrace","isEmulation","actionHashes","tracePart","intersection","sentForFee","excess","isToncoinIn","asset_in","isToncoinOut","asset_out","realFee","ourFeeAction","_action","tokenIn","setSwapDetails","isExcessAccounted","otherAction","_parsedTrace$addressB","isActivityExcessAccounted","isPush","PUSH_ADDRESS","activitiesPerAction","setTransactionDetails","activityStatus","getActivityRealFee","stakingCommonCache","stakingCommonCacheDeferred","accountCache","backendConfig","configDeferred","getAccountCache","getStakingCommonCache","getBackendConfigCache","BackendSocket","onNewActivity","isWebSocketEnabled","BRILLIANT_API_BASE_URL","messageAddresses","getBackendSocket","WalletPolling","_this$walletWatcher","pollingOptions","doesSupportSocket","_this$walletWatcher2","#handleSocketNewActivity","#triggerBackupNotifications","isConfident","concurrencyLimiters","getConcurrencyLimiter","createTaskQueue","swapItemToActivity","swap","backendId","getSwapItemSlug","cex","_getTokenByAddress","patchSwapItem","swapVersion","SWAP_API_VERSION","swapReplaceCexActivities","isToNow","SWAP_CROSSCHAIN_SLUGS","canHaveCexSwap","_getTokenBySlug","firstTimestamp","lastTimestamp","fromTime","toTime","swaps","convertSwapItemToTrusted","swapGetHistory","isCex","swapActivities","allSwapHashes","otherActivities","txCallbacks","updateTokenHashes","tokenSlugs","cachedTokens","tokensToFetch","option","toUpperCase","tokensByAddress","addressByRaw","getAccountStates","code_hash","insertMintlessPayload","transfer","customPayloadApiUrl","parsedPayload","mintlessTokenBalance","isMintlessClaimed","stateInit","getMintlessParams","newPayload","buildTokenTransferBody","tokenAmount","responseAddress","isBase64Payload","buildTokenTransfer","shouldSkipMintless","isLedger","isTokenWalletDeployed","toncoinAmount","realAmount","getToncoinAmountForTransfer","getTokenBalanceWithMintless","accountAddress","calculateTokenBalanceWithMintless","getTokenBalance","runMethod","readBoolean","checkMintlessTokenWalletIsClaimed","fetchMintlessTokenWalletData","isExpired","compressed_info","expired_at","getTime","custom_payload","state_init","fetchToken","buildTokenByMetadata","content","getJettonMinterData","contentUri","dict","loadDict","Dictionary","Keys","_dict$get","sha256Key","parseJettonOnchainMetadata","fetchJettonMetadata","image_data","imageData","base64ToString","willClaimMintless","TON_USDT_MAINNET_SLUG","TON_USDT_TESTNET_SLUG","isTiny","loadTokenBalances","tokenBalances","balanceRaw","wallet_address","parseTokenBalance","getTokenBalances","TON_VIRTUAL_ADDRESS","BalanceStream","loadingConcurrencyLimiter","throttleSocketBalanceUpdates","getBalances","tokenAddresses","unknown","splitKnownAndUnknownTokens","newBalances","importUnknownToken","importUnknownTokens","_this$loadingConcurre","throttledFetchBalances","wrap","fetchBalances","newBySlug","balanceByTokeyAddressToBySlug","notifyThrottled","tonBalance","isTokenTransferPayload","getMaxMessagesInTransaction","getDieselTokenAmount","diesel","DIESEL_URL","sendExternal","gaslessType","neededInit","isContractDeployed","ext","external","storeMessage","isW5Gasless","dest","storeBit","getExternalMsgHashNormalized","bodyMessageHash","boc","paymentLink","isAddition","dieselW5SendRequest","dieselSendBoc","sendFile","queues","withoutTransferConcurrency","task","queueKey","foregroundDeferred","backgroundPromises","finalizeInBackground","backgroundTask","emulateTransaction","externalMessage","buildExternalBoc","emulation","ignore_chksig","include_code_data","with_actions","fetchEmulateTrace","allActivities","walletActivities","totalRealFee","totalExcess","excessActivity","addExcessActivity","parseEmulation","WAIT_TRANSFER_TIMEOUT","WAIT_PAUSE","MAX_BALANCE_WITH_CHECK_DIESEL","PENDING_DIESEL_TIMEOUT_SEC","DIESEL_NOT_AVAILABLE","nativeAmount","remainingFee","checkTransactionDraft","shouldEncrypt","isBase64Data","stateInitString","allowGasless","checkToAddress","ApiTransactionDraftError","InvalidStateInit","isBounceable","isToAddressNew","InactiveContract","InvalidAmount","WalletNotInitialized","isWalletInitialized","commentToBytes","toncoinBalance","tokenTransfer","realToncoinAmount","packBytesAsSnakeForEncryptedData","packBytesAsSnake","isFullTonTransfer","signer","signingResult","signTransaction","hints","doPayFeeFromAmount","applyFeeFactorToEmulationResult","emulateTransactionWithFallback","isEnoughBalance","canTransferGasfully","getDiesel","tokenBalance","InsufficientBalance","handleServerError","InvalidToAddress","addressName","isMemoRequired","isUserFriendly","isTestOnly","isUrlSafe","InvalidAddressFormat","submitTransfer","noFeeCheck","stringToPayload","ApiTransactionError","retrySendBoc","resolveTransactionError","submitTransferWithDiesel","dieselAmount","isGaslessWithStars","DIESEL_ADDRESS","getOurFeePayload","submitMultiTransfer","isGasless","withW5Gasless","parseBase64","toPublicKey","subarray","ApiServerError","isExpiredTransactionError","IncorrectDeviceTime","isSeqnoMismatchError","ConcurrentTransaction","statusCode","displayError","UnsuccesfulTransfer","checkMultiTransactionDraft","withDiesel","totalAmount","isMainnet","isValid","hasInsufficientTokenBalance","parsedPayloads","payloadParsingResults","tokenResult","payloadAsString","getPayloadFromTransfer","e","tokenAmountsByAddress","hasUnknownToken","requiredAmount","availableBalance","isTokenBalanceInsufficient","hasInsufficientTonBalance","expireAt","shouldBeInternal","clearedMessages","omit","signTransfers","ledgerVestingAddress","getWalletSeqno","signedTransactions","allowOnlyOneTransaction","messagesPerTransaction","messagesByTransaction","transactionsToSign","transactionMessages","internal","bounce","parseStateInitCell","sendMode","SendMode","CARRY_ALL_REMAINING_BALANCE","PAY_GAS_SEPARATELY","IGNORE_ERRORS","timeout","makePreparedTransactionToSign","tonClient","waitUntil","isFallback","source_fees","fees","estimateExternalMessageFee","initCode","initData","ignoreSignature","in_fwd_fee","storage_fee","gas_fee","fetchEstimateDiesel","_ref6","storedTonWallet","isGaslessEnabled","isStarsEnabled","isStars","DEFAULT_FEE","getDieselToncoinFee","toncoinNeeded","rawDiesel","isW5","estimateDiesel","canPayDiesel","isAwaitingNotExpiredPrevious","pendingCreatedAt","estimation","_ref7","packBytesAsSnakeCell","TypeError","checkDnsRenewalDraft","nftAddresses","maxMessages","transactionCount","ceil","makeRenewMessage","submitDnsRenewal","nftBatches","nftBatch","checkDnsChangeWalletDraft","makeChangeMessage","submitDnsChangeWallet","DnsItem","buildFillUpMessage","linkedAddress","buildChangeDnsWalletMessage","getAccountNfts","rawNfts","getAccountNftItems","indirect_ownership","fetchAccountNfts","compact","checkNftOwnership","getNftItemByAddress","fetchNftByAddress","checkNftTransferDraft","NFT_BATCH_SIZE","buildNftTransferMessage","checkResult","batchFee","calculateNftTransferFee","submitNftTransfers","NOTCOIN_VOUCHERS_ADDRESS","NOTCOIN_EXCHANGERS","buildNftTransferPayload","nftIndex","first4Bits","readUint8","NOTCOIN_FORWARD_TON_AMOUNT","buildNotcoinVoucherExchange","generateQueryId","storeCoins","freeBytes","availableBits","storeMaybeRef","totalNftCount","estimatedBatchSize","estimatedBatchBlockchainFee","amountPerNft","fullBatchCount","remainingBatchSize","OrGate","onSwitch","isOn","on","toggle","off","isItemOn","prevIsOn","nextIsOn","RichActivityStream","zombiePendingActivities","updateAfterRawUpdate","newPendingActivities","confirmedHashes","updateAfterEnrichment","rawConfirmedActivities","isLoading","lastPendingActivities","areSortedArraysEqual","deduplicateActivityUpdates","rawActivityStream","unsubscribe","#handleRawActivitiesUpdate","richConfirmedActivities","enrichActivities","devSettings","TsUSDeWallet","JettonWallet","createFromAddress","getTimeLockData","lockedUsdeBalance","readBigNumber","unlockTime","transferTimelockedMessage","transfer_timelocked","jettonAmount","forwardTonAmount","NominatorPool","createFromConfig","config","contractAddress","getListNominators","readTuple","tupleItems","tuple","TupleReader","pendingDepositAmount","withdrawRequested","clientId","referrer","getClientId","hex","checkStakeDraft","buildLiquidStakingDepositBody","StakingPool","stakePayload","checkUnstakeDraft","commonData","liquid","currentRate","buildLiquidStakingWithdraw","stakeWalletAddress","buildJettonUnstakePayload","rate","ethena","submitStake","updateAccountCache","stakedAt","submitUnstake","mode","instantAvailable","Default","BestRate","localActivityParams","buildLiquidStakingWithdrawBody","fillOrKill","Instant","waitTillRoundEnd","getStakingStates","backendState","loyaltyType","shouldUseNominators","backendType","promises","poolConfig","jettonPools","buildJettonState","apy","start","end","nominatorsPool","open","nominators","addressObject","nominator","equals","annualYield","yieldType","UNSTAKE_TON_GRACE_PERIOD","unstakeRequestAmount","buildNominatorsState","isDisabled","apyVerified","isVerified","tsUsdeWalletAddress","tsUsdeWallet","annualYieldStandard","annualYieldVerified","unclaimedRewards","MIN_ACTIVE_STAKING_REWARDS","getIsActiveStakingState","buildEthenaState","buildLiquidState","_backendState$liquid","max","liquidAvailable","VALIDATION_PERIOD_MS","simulateLongUnstaking","available","prevRound","currentRound","gracePeriod","unlock","getLiquidStakingTimeRange","liquidApy","loyaltyApy","poolAddress","tvl","rewardJettons","unpackDicts","rewardsDeposits","dailyReward","startTime","endTime","distributionSpeed","apr","toFixed","calcJettonStakingApr","periodConfig","periods","stakedTokenSlug","stakeWallet","getJettonPoolStakeWallet","poolWallets","walletData","getStorageData","poolWalletAddress","rewards","StakeWallet","getAvailableRewards","jettonBalance","getBackendStakingState","isViewOnly","stakingState","isViewMode","totalProfit","isKnownStakingPool","fetchBackendStakingState","submitTokenStakingClaim","buildJettonClaimPayload","submitUnstakeEthenaLocked","POLL_DELAY_AFTER_SOCKET","POLL_MIN_INTERVAL","DOMAIN_INTERVAL","INITIALIZATION_INTERVAL","STAKING_INTERVAL","VERSIONS_INTERVAL","VESTING_INTERVAL","TON_DNS_INTERVAL","NFT_FULL_INTERVAL","DOUBLE_CHECK_NFT_PAUSE","setupBalancePolling","isActive","onUpdatingStatusChange","balanceStream","logAndRescue","getContractInfos","infos","FEE_ADDRESSES","SWAP_FEE_ADDRESS","MAX_NETWORK_FEE","MAX_SPLITS","validateDexSwapTransfers","transfers","_transfers$at","feeTransfer","at","mainTransfers","maxSplits","condition","originalAssert","maxAmount","sumAmount","contractInfos","mainTransfer","dieselFee","maxTonAmount","sumTokenAmount","sumTonAmount","feePayload","tokenFeeAmount","feeDestination","tonSdk","fetchActivityDetails","_result","getWalletFromBip39Mnemonic","getWalletsFromLedgerAndLoadBalance","accountIndices","getLedgerTonWallet","accountIndex","setupActivePolling","newestActivityTimestamps","balancePolling","stopActivityPolling","newestConfirmedActivityTimestamps","onRawActivity","richActivityStream","newestTimestamps","onRawActivities","onRichActivities","doesNeedInitial","_mainActivities$","mainActivities","newestActivityTimestamp","loadInitialConfirmedActivities","loadInitialActivities","_richActivityStream","_rawActivityStream","setupActivityPolling","domainPolling","nftPolling","walletInitializationPolling","newDomain","setupDomainPolling","nftFromSec","updatePartial","nftResult","fromSec","_events$","getAccountEvents","start_date","fetchAccountEvents","NftPurchase","NftItemTransfer","recipient","buyer","getNftUpdates","nftUpdates","fullPolling","setupNftPolling","walletUpdate","updatedWallet","setupWalletInitializationPolling","stopWalletVersionPolling","lastResult","accountType","currentVersion","versions","publicKeyBytes","POPULAR_WALLET_VERSIONS","versionInfos","filteredVersions","setupWalletVersionsPolling","stopTonDnsPolling","expirationByAddress","linkedAddressByAddress","lastFillUpTime","fetchDomains","setupTonDnsPolling","stopStakingPolling","IS_STAKING_DISABLED","lastStates","setupStakingPolling","stopVestingPolling","IS_CORE_WALLET","lastVestingInfo","isVestingEnabled","isEnabled","vestingInfo","isTestnet","fetchVestings","setupVestingPolling","setupInactivePolling","verifyLedgerWalletAddress","verifyLedgerTonAddress","getIsLedgerAppOpen","isLedgerTonAppOpen","hooks","callHook","hook","CONNECT_EVENT_ERROR_CODES","SEND_TRANSACTION_ERROR_CODES","CHAIN","tonConnectGetDeviceInfo","features","types","platform","getPlatform","appName","APP_NAME","appVersion","packageJson","maxProtocolVersion","TONCONNECT_PROTOCOL_VERSION","_navigator","userAgent","navigator","userAgentData","devicePlatform","IS_TELEGRAM_APP","indexOf","deferreds","createDappPromise","promiseId","resolveDappPromise","initDapps","_onUpdate","getDapp","uniqueId","_await$getAccountValu","byUrl","addDapp","dapp","dapps","getDappsByUrl","deleteDapp","dontNotifyDapp","deleteAllDapps","urls","getDapps","byId","getDappsState","removeAccountDapps","removeAllDapps","removeNetworkDapps","loadExploreSites","isLandscape","apiUrl","TRON_MAINNET_API_URL","usdtAddress","TRON_TESTNET_API_URL","getTokenSlugs","usdtSlug","getTokenActivitySlice","queryParams","getTrxTransactions","min_timestamp","max_timestamp","search_internal","raw_data","txID","energy_fee","energyFee","net_fee","netFee","block_timestamp","parameters","contract","parameter","TronWeb","fromHex","owner_address","to_address","receiver_address","contract_address","parseRawTrxTransaction","getTrc20Transactions","transaction_id","parseRawTrc20Transaction","mergeActivities","txsBySlug","seenTxIds","isSeenTxId","trxTxs","tokenTxs","trxTxById","tokenTxList","tokenTx","trxTx","getTronClient","fullHost","getChainParameters","chainParameters","trx","energyUnitFee","param","bandwidthUnitFee","tronWeb","getUnconfirmedBalance","getTrc20Balance","functions","issuerAddress","transactionBuilder","triggerSmartContract","_isConstant","constant_result","callContract","trxBalance","usdtBalance","hasChanged","notSupported","tronSdk","mainChunk","prevChunk","oldestTimestamp","getAllActivitySlice","fromMnemonic","activityPolling","slugs","_activities$","_activities$2","loadNewActivities","multisigPolling","isMultisig","multisigStatus","getAccount","managerAddresses","owner_permission","threshold","permKey","perm","active_permission","managerAddress","isTronAccountMultisig","setupMultisigPolling","isFirstUpdate","walletPolling","updateBalance","concurrencyLimiter","setupInactiveChainPolling","isAddress","bandwidth","getBandwidth","energy_required","energyRequired","estimateEnergy","estimateTrc20TransferFee","sendTrx","raw_data_hex","feeLimit","buildTrc20Transfer","signedTx","sendRawTransaction","sendTransaction","hexToString","initTransfer","chains","shouldCreateLocalActivity","localActivity","createLocalTransactions","isExternal","activityId","localTransactions","subParams","buildLocalTransaction","createLocalActivitiesFromEmulation","emulationActivities","localActivities","localActivityIndex","convertEmulationActivityToLocal","TonConnectError","ApiBaseError","ManifestContentError","MANIFEST_CONTENT_ERROR","UnknownError","UNKNOWN_ERROR","BadRequestError","BAD_REQUEST_ERROR","UnknownAppError","UNKNOWN_APP_ERROR","URL_MAX_LENGTH","isValidString","maxLength","isValidUrl","getTransferActualToAddress","isNftTransferPayload","isTransferPayloadDangerous","BLANK_GIF_DATA_URL","resolveInit","initPromise","initTonConnect","connect","openExtensionPopup","connectionType","isSse","dappMetadata","fetchDappMetadata","manifestUrl","addressItem","proofItem","errors","getCurrentAccountOrFail","connectedAt","isUrlEnsured","identifier","permissions","promiseResult","deviceInfo","buildTonAddressReplyItem","domainBuffer","lengthBytes","buildTonProofReplyItem","proofSignature","device","formatConnectError","ensureRequestParams","updateDapp","disconnect","_checkResult$emulatio","txPayload","dappNetworkRaw","dappNetwork","MAINNET","validUntil","valid_until","vestingAddress","ownerPublicKey","_info$contractInfo","checkIsHisVestingWallet","WrongAddress","WrongNetwork","preparedMessages","getIsRawAddress","checkTransactionMessages","transactionsForRequest","_emulation$byTransact","rawAmount","rawPayload","isDangerous","displayedToAddress","prepareTransactionForRequest","sentTransactions","attempts","ensureSent","sendSignedTransactions","PartialTransactionFailure","handleMethodError","errorMessage","apiErrors","USER_REJECTS_ERROR","payloadToSign","storeWritable","storeStateInit","getWalletStateInit","TESTNET","walletStateInit","idx","crc32","iconUrl","safeIconUrl","getCurrentAccountIdOrFail","lastAccountId","lastConnectedAccountId","connections","conn","findLastConnectedAccount","TTL_SEC","NONCE_SIZE","MAX_CONFIRM_DURATION","SHOULD_SHOW_LOADER_ON_SSE_START","sseEventSource","delayedReturnParams","resolvePromise","sseDapps","startSseConnection","isFromInAppBrowser","origin","connectionOrigin","ret","shouldOpenUrl","r","connectRequest","decodeURIComponent","secretKeyArray","publicKeyArray","lastOutputId","tonConnect","MANIFEST_NOT_FOUND_ERROR","METHOD_NOT_SUPPORTED","sendMessage","resetupSseConnection","lastEventId","dappsState","dappsByUrl","byUniqueId","_dapp$sse","clientIds","SSE_BRIDGE_URL","EventSource","openEventSource","encryptedMessage","sseDapp","fullBuffer","nonce","decrypted","jsonText","decryptMessage","setSseLastEventId","toId","topic","encryptMessage","sendRawMessage","preloadPromise","resolveDataPreloadPromise","waitDataPreload","initStaking","getStakingHistory","tryUpdateStakingCommonData","poolContract","setStakingCommonCache","submitStakingClaimOrUnlock","SIGN_MESSAGE","getBackendAuthToken","accountWallet","fetchAccountConfigForDebugPurposesOnly","stateVersion","mnemonicsEncrypted","ping","getMoonpayOnrampUrl","theme","currency","waitForLedgerApp","attemptPause","hasTimedOut","race","waitForDeadline","checkApp","initSwap","swapBuildTransfer","swapBuild","transferList","shouldTryDiesel","errorToString","swapSubmit","historyItem","fetchSwaps","ids","results","allSettled","swapGetHistoryItem","nonExistentIds","swapEstimate","isMsgHashMode","swapGetAssets","swapGetPairs","symbolOrTokenAddress","swapCexEstimate","swapCexValidateAddress","swapCexCreateTransaction","rawSwap","swapCexSubmit","transferOptions","BACKEND_INTERVAL","LONG_BACKEND_INTERVAL","INCORRECT_TIME_DIFF","ACCOUNT_CONFIG_INTERVAL","MAX_POST_TOKENS","stopCommonBackendPolling","stopActiveAccountPolling","inactiveAccountPolling","stopByAccount","activeAccountId","startAccountPolling","stopFns","stopChain","stopAllPollings","stopAccountPolling","preventRaceCondition","setActiveAccount","_stopByAccount$active","newActiveAccountId","otherAccountIds","switchNetwork","previousActiveAccountId","previousActiveAccount","addAccount","isActiveAccount","isCurrentNetwork","removeAccount","_stopByAccount$accoun","removeNetworkAccounts","removeAllAccounts","createInactiveAccountsPollingManager","setUpdatingStatus","updatingStatuses","isUpdating","chainsBeingUpdated","createUpdatingStatusManager","initPolling","_stopCommonBackendPol","loadTokensCache","tryUpdateTokens","tryUpdateCurrencyRates","tryUpdateSwapTokens","tryUpdateConfig","stopFn","setupCommonBackendPolling","nonBackendTokenAddresses","nonBackendTokenDetails","assets","currencyRates","rates","blockchain","setBackendConfigCache","isLimited","isCopyStorageEnabled","supportAccountsCount","serverUtc","country","countryCode","isUpdateRequired","isAppUpdateRequired","localUtc","abs","setActivePollingAccount","_stopActiveAccountPol","stopPollingFns","setupAccountConfigPolling","nativeSlug","pickChainTimestamps","removeAllPollingAccounts","partialAccount","accountConfig","connectUpdater","environment","setEnvironment","methods","isDappSupported","isSseSupported","accountIds","currentStorage","words","isTonProxyEnabled","isTonMagicEnabled","settings","secondNetwork","secondAccountId","secondAddress","newAccountById","migrateCoreWallet","idbVersion","idbStorage","idbData","MAIN_ACCOUNT_ID","field","raw","oldItem","newItem","prevValue","accountDapps","byAccountId","internalAccountId","accountData","parsed","mainnetAccountId","testnetAccountId","publicKeys","oldAddress","newAddress","_dapp$sse2","isIosKeychainModeMigrated","isIosApp","oldAccountById","mnemonicById","oldAccount","ledger","driver","deviceId","deviceName","migrations","oldState","newState","activeAccountIds","oldAccounts","newAccounts","migrateStorage","_currentOnUpdate","startStorageMigration","tonConnectSse","fetchBackendReferrer","saveReferrer","_stopCommonBackendPol2","destroyPolling","fetchPastActivities","fetchAndCheckActivitySlice","fetchTokenActivitySlice","accountChains","_len3","_key3","filterPredicate","mergeSortedActivitiesToMaxTime","fetchAllActivitySlice","newActivity","initAccounts","activateAccount","isFirstLogin","deactivateAllAccounts","isBip39","createWallet","importMnemonic","IS_BIP39_MNEMONIC_ENABLED","isPrivateKey","isBip39Mnemonic","isTonMnemonic","secondNetworkAccount","createAccountWithSecondNetwork","importLedgerAccount","accountInfo","getLedgerWallets","startWalletIndex","count","getLedgerDeviceInfo","addHooks","onDappDisconnected","d","onDappsChanged","addAccountMutex","preferredId","getAccountIds","buildAccountId","getNewAccountId","addPollingAccount","removeNetworkPollingAccounts","resetAccounts","nextAccountId","removePollingAccount","changePassword","oldPassword","encryptedMnemonic","importViewAccount","addressByChain","_chain","importNewWalletVersion","newAccount","existingAccount","_account$byChain$ton","isNew","fetchMnemonic","getMnemonicWordList","default","checkWorkerStorageIntegrity","verifyPassword","getAccountWithMnemonic","confirmDappRequest","dappPromises","confirmDappRequestConnect","confirmDappRequestSendTransaction","confirmDappRequestSignData","signedData","cancelDappRequest","ApiUserRejectsError","fetchAddress","initNfts","fetchNftsFromCollection","shouldAppend","realFeePerNft","activityIds","nftByAddress","stateInitBase64","dappUrl","fetchPriceHistory","baseCurrency","DEFAULT_PRICE_CURRENCY","subscribeNotifications","props","unsubscribeNotifications","api","sendToOrigin","transferables","handleErrors","_e$data","_api$init","lastArg","ImageBitmap","arrayBuffer","createPostMessageInterface","tonConnectApi","process","DEBUG_MORE","env","IS_OPERA_EXTENSION","DEBUG_ALERT_MSG","TONCENTER_MAINNET_KEY","ELECTRON_TONCENTER_MAINNET_KEY","TONCENTER_TESTNET_KEY","ELECTRON_TONCENTER_TESTNET_KEY","PROXY_API_BASE_URL","IPFS_GATEWAY_BASE_URL","STAKING_POOLS","cmcSlug","MYCOIN","minterAddress","TRC20_USDT_MAINNET_SLUG","TRC20_USDT_TESTNET_SLUG","TRC20_USDT","TON_USDT","COMMON_TOKEN","toncoin","DEFAULT_RETRIES","DEFAULT_ERROR_PAUSE","ALL_TON_DNS_ZONES","baseFormat","isTelemint","isUnofficial","TON_DNS_ZONES","setTimeout","shouldRunFirst","isRunning","scheduleFn","runFn","localArgs","_len2","_args","_key2","timeoutId","clearTimeout","maxConcurrency","queue","concurrency","runTasks","_len4","_key4","ServerError","MAX_TIMEOUT","getProxiedJsonUrl","urlObject","isNotTemporaryError","fetchWithTimeout","controller","AbortController","abort","signal","ignoreHttpCodes","_errors$","IS_EXTENSION_PAGE_SCRIPT","location","shouldShowAlert","throttledAlert","alert","handleErrorEvent","ErrorEvent","preventDefault","MAX_DP","NAME","INVALID","INVALID_DP","INVALID_RM","DIV_BY_ZERO","P","UNDEFINED","NUMERIC","sd","rm","more","xc","doExponential","isNonzero","charAt","cmp","y","isneg","yc","j","l","dp","DP","bl","bt","ri","bz","ai","al","rl","q","qc","qi","p","eq","gt","gte","lt","lte","minus","sub","t","xlty","plus","xe","ye","mod","ygtx","times","neg","one","prec","sqrt","half","toExponential","Symbol","for","toNumber","strict","toPrecision","valueOf","_Big_","nl","search","roundDown","roundHalfEven","roundUp","SAFE_EXEC_ENABLED","rescue","always","shouldIgnoreError","denyList","isRetryAllowed","exports","nodeCrypto","freeze","__proto__","_0n","_1n","_2n","_8n","CU_O","CURVE","h","Gx","Gy","POW_2_256","SQRT_M1","SQRT_AD_MINUS_ONE","INVSQRT_A_MINUS_D","ONE_MINUS_D_SQ","D_MINUS_ONE_SQ","ExtendedPoint","z","fromAffine","Point","ZERO","toAffineBatch","points","toInv","nums","tmp","inverted","invert","reduceRight","invertBatch","toAffine","normalizeZ","other","assertExtPoint","X1","Y1","Z1","X2","Y2","Z2","X1Z2","X2Z1","Y1Z2","Y2Z1","negate","double","A","B","C","D","x1y1","E","G","F","H","X3","Y3","T3","Z3","T1","T2","subtract","precomputeWindow","W","windows","wNAF","affinePoint","BASE","_WINDOW_SIZE","precomputes","pointPrecomputes","f","windowSize","mask","maxNumber","shiftBy","wbits","offset1","offset2","cond1","cond2","constTimeNegate","multiply","scalar","normalizeScalar","multiplyUnsafe","P0","isSmallOrder","isTorsionFree","invZ","is0","ax","ay","zz","fromRistrettoBytes","legacyRist","toRistrettoBytes","fromRistrettoHash","assertRstPoint","RistrettoPoint","ep","calcElligatorRistrettoMap","r0","Ns","Ns_D_is_sq","uvRatio","s_","edIsNegative","Nt","s2","W0","W1","W2","W3","hashToCurve","r1","bytes255ToNumberLE","ensureBytes","R1","r2","R2","emsg","b1","b2","equalBytes","numberTo32BytesLE","u1","u2","u1_2","u2_2","invertSqrt","Dx","Dy","toRawBytes","u2sq","invsqrt","D1","D2","zInv","_x","_y","toHex","two","_setWindowSize","normed","bytesToNumberLE","y2","u","isXOdd","fromPrivateKey","getExtendedPublicKey","point","toX25519","Signature","assertValidity","u8","concatBytes","arrays","pad","hexes","uint8a","array","hexByte","numberTo32BytesBE","MAX_255B","number","modulo","m","pow2","power","pow_2_252_3","_5n","_10n","_20n","_40n","_80n","b4","b5","b10","b20","b40","b80","b160","b240","b250","pow_p_5_8","v3","v7","vx2","root1","root2","useRoot1","useRoot2","noRoot","modlLE","expectedLength","isSafeInteger","adjustBytes25519","checkPrivateKey","getKeyFromHash","hashed","head","pointBytes","_sha512Sync","sha512s","utils","sha512","getExtendedPublicKeySync","prepareVerification","sig","SB","pub","finishVerification","kA","sync","R","verify","cswap","x_2","x_3","dummy","curve25519","BASE_POINT_U","scalarMult","pu","pointU","a24","x_1","sw","z_2","z_3","k_t","AA","BB","DA","CB","dacb","da_cb","xp2","montgomeryLadder","uEnc","decodeUCoordinate","scalarMultBase","node","web","TORSION_SUBGROUP","hashToPrivateScalar","bytesLength","randomPrivateKey","createHash","precompute","sha512Sync","defineProperties","configurable","defineProperty","factory","readCellOpt","MAX_LOG_LENGTH","logs","errorReplacer","_","AssertionError","addLog","log","arg","time","getLogs","level","ApiHardwareError","poolPart","JettonStakingOpCodes","GET_STATIC_DATA","REPORT_STATIC_DATA","GET_STORAGE_DATA","REPORT_STORAGE_DATA","EXCESSES","TRANSFER_JETTON","INTERNAL_TRANSFER","TRANSFER_NOTIFICATION","PROVIDE_WALLET_ADDRESS","TAKE_WALLET_ADDRESS","BURN_JETTON","ADD_REWARDS","SEND_CLAIMED_REWARDS","SEND_UNSTAKED_JETTONS","APPROVE_STAKE","CANCEL_STAKE","ADD_REWARD_JETTONS","CLAIM_COMMISSIONS","REQUEST_UPDATE_REWARDS","CLAIM_REWARDS","RECEIVE_JETTONS","UNSTAKE_REQUEST","CANCEL_UNSTAKE_REQUEST","UPDATE_REWARDS","CONFIRM_TRANSFER","DEPLOY_NEW_POOL","SEND_COMMISSIONS","SET_CODE","CHANGE_CREATION_FEE","CHANGE_CONTENT","UPDATE_CODES","MIN_RESERVE","DEPLOY_POOL","NOTIFICATION","BURN_JETTONS","CANCEL_UNSTAKE","APPROVE_TRANSFER","SAVE_UPDATED_REWARDS","MIN_EXCESS","SEND_STAKED_JETTONS","Dividers","COMMISSION_DIVIDER","REWARDS_DIVIDER","DISTRIBUTION_SPEED_DIVIDER","DISTRIBUTED_REWARDS_DIVIDER","sendDeploy","via","getJettonBalance","getState","transferMessage","jetton_amount","forward_ton_amount","sendTransfer","burnMessage","sendBurn","withdrawTonsMessage","sendWithdrawTons","toNano","withdrawJettonsMessage","sendWithdrawJettons","getWalletData","readAddress","minter","suffix","getDnsZoneByCollection","ELECTRON_ORIGIN","appOrigin","isElectron","_self","getAppOrigin","isNativeBottomSheet","canBeCached","buildCacheKey","resultPromise","stakingPoolAddress","lockPeriod","stakeWalletConfigToCell","stakeWalletConfig","timeNow","rewardMultiplier","lockPeriods","rewardJettonWallet","poolRewardsInfo","userRewardsInfo","rewardsDict","userDistributedRewards","distributedRewards","poolDistributedRewards","rewardDeposit","tvlWithMultipliers","unstakeRequests","requestsCount","totalRequestedJettons","unstakeCommission","unstakeFee","minDeposit","maxDeposit","whitelist","loadDictDirect","src","buidler","Uint","Values","BigVarUint","Bool","factoryAddress","poolId","stakingPoolConfigToCell","getData","readAddressOpt","inited","adminAddress","creatorAddress","stakeWalletCode","lockWalletAddress","rewardJettonsCount","rewardsDepositsCount","collectedCommissions","rewardsCommission","storeDict","curTvl","tvlLimit","depositCommission","getWalletAddress","byKey","member","groupKey","newByKey","object","stringKeys","stringKey","chunkSize","predicate","cursor","set2","diff","element","shouldKeepFirst","elem","compareFn","deduplicateEqual","toMerge","nextToMerge","merge2","arr1","arr2","index1","index2","compareResult","checkInt","checkInts","arrayish","coerceArray","createArray","copyArray","sourceArray","targetArray","targetStart","sourceStart","sourceEnd","Hex","convertUtf8","toBytes","encodeURI","substr","fromBytes","convertHex","numberOfRounds","rcon","S","Si","T4","T5","T6","T7","T8","U1","U2","U3","U4","convertToInt32","AES","_prepare","rounds","_Ke","_Kd","roundKeyCount","KC","tk","tt","rconpointer","ciphertext","ModeOfOperationECB","_aes","block","ModeOfOperationCBC","_lastCipherblock","ModeOfOperationCFB","segmentSize","_shiftRegister","xorSegment","ModeOfOperationOFB","_lastPrecipher","_lastPrecipherIndex","Counter","initialValue","_counter","setValue","setBytes","MAX_SAFE_INTEGER","increment","ModeOfOperationCTR","counter","_remainingCounter","_remainingCounterIndex","ModeOfOperation","ecb","cfb","ofb","ctr","utf8","padding","pkcs7","padder","strip","_arrayTest","module","Op","static","JettonMinter","admin","wallet_code","jettonMinterConfigToCell","jettonInternalTransfer","response_addr","query_id","internal_transfer","mintMessage","total_ton_amount","mintMsg","mint","sendMint","discoveryMessage","include_address","sendDiscovery","changeAdminMessage","change_admin","sendChangeAdmin","changeContentMessage","change_content","sendChangeContent","getJettonData","totalSupply","mintable","walletCode","getTotalSupply","getAdminAddress","getContent","isFormData","isStandardBrowserEnv","isUndefined","getResponse","stageOne","createError","statusText","Headers","responseType","blob","formData","axios","AxiosError","isAxiosError","fileName","lineNumber","columnNumber","enhanceError","axiosRetry","shouldResetTimeout","retryDelay","retryCount","onRetry","retryNumber","requestConfig","_error$response","defaults","adapter","auth","username","decodeURI","integrity","redirect","withCredentials","credentials","fullPath","buildFullPath","baseURL","buildURL","paramsSerializer","Request","createRequest","promiseChain","timeoutErrorMessage","settle","TonClient","TonCoreClient","initParameters","callRpc","sendRequest","endpoint","jsonrpc","TON_MAX_COMMENT_BYTES","WalletContractV1R1","WalletContractV1R2","WalletContractV1R3","WalletContractV2R1","WalletContractV2R2","WalletContractV3R1","WalletContractV3R2","WalletContractV4","tokenWallet","runMethodWithError","urlSafe","bounceable","testOnly","address1","address2","startBuffer","maxBytes","bytesPerCell","headCell","cellOffset","cellLength","cellBuffer","nextHeadCell","EMPTY","buildLiquidStakingWithdrawCustomPayload","isRaw","parseRaw","isFriendly","parseFriendly","getNftData","getTelemintDomain","getDomain","jettonsToUnstake","forceUnstake","rewardsToClaim","empty","poolWallet","isSimpleObject","getPrototypeOf","loadStateInit","__awaiter","thisArg","_arguments","generator","fulfilled","step","rejected","done","apply","__importDefault","__esModule","DEFAULT_OPTIONS","exponentialDelay","isNetworkOrIdempotentRequestError","isIdempotentRequestError","isSafeRequestError","isRetryableError","isNetworkError","namespace","is_retry_allowed_1","require","SAFE_HTTP_METHODS","IDEMPOTENT_HTTP_METHODS","_a","delayFactor","delay","setCurrentState","defaultOptions","currentState","getRequestOptions","lastRequestTime","retryCondition","axiosInstance","requestInterceptorId","interceptors","use","responseInterceptorId","shouldRetryOrPromise","_err","agent","httpAgent","httpsAgent","fixConfig","lastRequestDuration","transformRequest","readString","getLastFillUpTime","buildDeleteDnsRecordMessage","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","__webpack_exports__","O","chunkIds","priority","notFulfilled","Infinity","getter","definition","o","enumerable","chunkId","miniCssF","g","globalThis","Function","prop","toStringTag","scriptUrl","importScripts","document","currentScript","tagName","scripts","getElementsByTagName","installedChunks","chunkLoadingGlobal","parentChunkLoadingFunction","moreModules","runtime"],"sourceRoot":""}